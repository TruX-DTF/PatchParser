<!doctype html>
<html lang="en">
 <head> 
  <meta charset="utf-8"> 
  <meta http-equiv="X-UA-Compatible" content="IE=Edge"> 
  <meta name="application-name" content="JIRA" data-name="jira" data-version="7.6.3">
  <meta name="ajs-viewissue-use-history-api" content="false"> 
  <meta name="ajs-jira-base-url" content="https://issues.apache.org/jira"> 
  <meta name="ajs-serverRenderedViewIssue" content="true"> 
  <meta name="ajs-dev-mode" content="false"> 
  <meta name="ajs-context-path" content="/jira"> 
  <meta name="ajs-version-number" content="7.6.3"> 
  <meta name="ajs-build-number" content="76005"> 
  <meta name="ajs-is-beta" content="false"> 
  <meta name="ajs-is-rc" content="false"> 
  <meta name="ajs-is-snapshot" content="false"> 
  <meta name="ajs-is-milestone" content="false"> 
  <meta name="ajs-remote-user" content=""> 
  <meta name="ajs-remote-user-fullname" content=""> 
  <meta name="ajs-user-locale" content="en_UK"> 
  <meta name="ajs-user-locale-group-separator" content=","> 
  <meta name="ajs-app-title" content="ASF JIRA"> 
  <meta name="ajs-keyboard-shortcuts-enabled" content="true"> 
  <meta name="ajs-keyboard-accesskey-modifier" content="Ctrl+Alt"> 
  <meta name="ajs-enabled-dark-features" content="[&quot;com.atlassian.jira.agile.darkfeature.editable.detailsview&quot;,&quot;nps.survey.inline.dialog&quot;,&quot;com.atlassian.jira.agile.darkfeature.edit.closed.sprint.enabled&quot;,&quot;jira.plugin.devstatus.phasetwo&quot;,&quot;jira.frother.reporter.field&quot;,&quot;atlassian.rest.xsrf.legacy.enabled&quot;,&quot;jira.issue.status.lozenge&quot;,&quot;com.atlassian.jira.config.BIG_PIPE&quot;,&quot;com.atlassian.jira.projects.issuenavigator&quot;,&quot;com.atlassian.jira.config.PDL&quot;,&quot;jira.plugin.devstatus.phasetwo.enabled&quot;,&quot;atlassian.aui.raphael.disabled&quot;,&quot;app-switcher.new&quot;,&quot;frother.assignee.field&quot;,&quot;com.atlassian.jira.projects.ProjectCentricNavigation.Switch&quot;,&quot;sd.internal.base.off.thread.on.completion.events.enabled&quot;,&quot;jira.onboarding.cyoa&quot;,&quot;com.atlassian.jira.agile.darkfeature.kanplan.enabled&quot;,&quot;sd.slavalue.record.updated.date.enabled&quot;,&quot;com.atlassian.jira.config.ProjectConfig.MENU&quot;,&quot;com.atlassian.jira.projects.sidebar.DEFER_RESOURCES&quot;,&quot;com.atlassian.jira.agile.darkfeature.kanplan.epics.and.versions.enabled&quot;,&quot;com.atlassian.jira.agile.darkfeature.sprint.goal.enabled&quot;,&quot;jira.zdu.admin-updates-ui&quot;,&quot;jira.zdu.jmx-monitoring&quot;,&quot;sd.sla.improved.rendering.enabled&quot;,&quot;sd.canned.responses.enabled&quot;,&quot;sd.new.settings.sidebar.location.disabled&quot;,&quot;jira.zdu.cluster-upgrade-state&quot;,&quot;com.atlassian.jira.agile.darkfeature.splitissue&quot;,&quot;com.atlassian.jira.config.CoreFeatures.LICENSE_ROLES_ENABLED&quot;,&quot;com.atlassian.feedback.feedback-button-move-to-header-enable&quot;,&quot;jira.export.csv.enabled&quot;]"> 
  <meta name="ajs-in-admin-mode" content="false"> 
  <meta name="ajs-is-sysadmin" content="false"> 
  <meta name="ajs-is-admin" content="false"> 
  <meta name="ajs-outgoing-mail-enabled" content="true"> 
  <meta name="ajs-date-relativize" content="true"> 
  <meta name="ajs-date-time" content="HH:mm"> 
  <meta name="ajs-date-day" content="EEEE HH:mm"> 
  <meta name="ajs-date-dmy" content="dd/MMM/yy"> 
  <meta name="ajs-date-complete" content="dd/MMM/yy HH:mm"> 
  <script type="text/javascript">var AJS=AJS||{};AJS.debug=true;</script> 
  <meta id="atlassian-token" name="atlassian-token" content="A5KQ-2QAV-T4JA-FDED|f2b3cee374f2d07926766cf662ec687cdc671636|lout"> 
  <link rel="shortcut icon" href="/jira/s/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/_/favicon.ico"> 
  <!--[if IE]><![endif]--> 
  <script type="text/javascript">
    (function() {
        var contextPath = '/jira';
        var eventBuffer = [];

        function printDeprecatedMsg() {
            if (console && console.warn) {
                console.warn('DEPRECATED JS - contextPath global variable has been deprecated since 7.4.0. Use `wrm/context-path` module instead.');
            }
        }

        function sendEvent(analytics, postfix) {
            analytics.send({
                name: 'js.globals.contextPath.' + postfix
            });
        }

        function sendDeprecatedEvent(postfix) {
            try {
                var analytics = require('jira/analytics');
                if (eventBuffer.length) {
                    eventBuffer.forEach(function(value) {
                        sendEvent(analytics, value);
                    });
                    eventBuffer = [];
                }

                if (postfix) {
                    sendEvent(analytics, postfix);
                }
            } catch(ex) {
                eventBuffer.push(postfix);
                setTimeout(sendDeprecatedEvent, 1000);
            }
        }

        Object.defineProperty(window, 'contextPath', {
            get: function() {
                printDeprecatedMsg();
                sendDeprecatedEvent('get');
                return contextPath;
            },
            set: function(value) {
                printDeprecatedMsg();
                sendDeprecatedEvent('set');
                contextPath = value;
            }
        });
    })();

</script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-plugin:context-path.context-path"]="\"/jira\"";
WRM._unparsedData["jira.webresources:feature-flags.feature-flag-data"]="{\"enabled-feature-keys\":[\"com.atlassian.jira.agile.darkfeature.editable.detailsview\",\"nps.survey.inline.dialog\",\"com.atlassian.jira.agile.darkfeature.edit.closed.sprint.enabled\",\"jira.plugin.devstatus.phasetwo\",\"jira.frother.reporter.field\",\"atlassian.rest.xsrf.legacy.enabled\",\"jira.issue.status.lozenge\",\"com.atlassian.jira.config.BIG_PIPE\",\"com.atlassian.jira.projects.issuenavigator\",\"com.atlassian.jira.config.PDL\",\"jira.plugin.devstatus.phasetwo.enabled\",\"atlassian.aui.raphael.disabled\",\"app-switcher.new\",\"frother.assignee.field\",\"com.atlassian.jira.projects.ProjectCentricNavigation.Switch\",\"sd.internal.base.off.thread.on.completion.events.enabled\",\"jira.onboarding.cyoa\",\"com.atlassian.jira.agile.darkfeature.kanplan.enabled\",\"sd.slavalue.record.updated.date.enabled\",\"com.atlassian.jira.config.ProjectConfig.MENU\",\"com.atlassian.jira.projects.sidebar.DEFER_RESOURCES\",\"com.atlassian.jira.agile.darkfeature.kanplan.epics.and.versions.enabled\",\"com.atlassian.jira.agile.darkfeature.sprint.goal.enabled\",\"jira.zdu.admin-updates-ui\",\"jira.zdu.jmx-monitoring\",\"sd.sla.improved.rendering.enabled\",\"sd.canned.responses.enabled\",\"sd.new.settings.sidebar.location.disabled\",\"jira.zdu.cluster-upgrade-state\",\"com.atlassian.jira.agile.darkfeature.splitissue\",\"com.atlassian.jira.config.CoreFeatures.LICENSE_ROLES_ENABLED\",\"com.atlassian.feedback.feedback-button-move-to-header-enable\",\"jira.export.csv.enabled\"],\"feature-flag-states\":{\"com.atlassian.jira.agile.darkfeature.kanplan\":false,\"sd.internal.base.off.thread.on.completion.events\":false,\"jira.instrumentation.laas\":false,\"com.atlassian.jira.agile.darkfeature.edit.closed.sprint\":false,\"com.atlassian.jira.issuetable.draggable\":true,\"jira.create.linked.issue\":true,\"com.atlassian.jira.agile.darkfeature.sprint.goal\":false,\"jira.sal.host.connect.accessor.existing.transaction.will.create.transactions\":true,\"jira.jql.suggestrecentfields\":false,\"com.atlassian.jira.agile.darkfeature.kanplan.epics.and.versions\":false,\"jira.jql.smartautoselectfirst\":false,\"com.atlassian.jira.agile.darkfeature.optimistic.transitions\":true,\"com.atlassian.jira.issuetable.move.links.hidden\":true,\"jira.priorities.per.project\":true,\"com.atlassian.jira.upgrade.startup.fix.index\":true,\"jira.renderer.consider.variable.format\":true}}";
WRM._unparsedData["jira.webresources:default-comment-security-level.DefaultCommentSecurityLevelHelpLink"]="{\"extraClasses\":\"default-comment-level-help\",\"title\":\"Commenting on an Issue\",\"url\":\"https://docs.atlassian.com/jira/jcore-docs-076/Editing+and+collaborating+on+issues#Editingandcollaboratingonissues-restrictacomment\",\"isLocal\":false}";
WRM._unparsedData["jira.webresources:dateFormatProvider.allFormats"]="{\"dateFormats\":{\"meridiem\":[\"AM\",\"PM\"],\"eras\":[\"BC\",\"AD\"],\"months\":[\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],\"monthsShort\":[\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"],\"weekdaysShort\":[\"Sun\",\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\",\"Sat\"],\"weekdays\":[\"Sunday\",\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\",\"Saturday\"]},\"lookAndFeelFormats\":{\"relativize\":\"true\",\"time\":\"HH:mm\",\"day\":\"EEEE HH:mm\",\"dmy\":\"dd/MMM/yy\",\"complete\":\"dd/MMM/yy HH:mm\"}}";
WRM._unparsedData["com.atlassian.jira.jira-issue-nav-components:issueviewer.features"]="{\"rteEnabled\":true}";
WRM._unparsedData["com.atlassian.jira.plugins.jira-dnd-attachment-plugin:dnd-issue-drop-zone.thumbnail-mime-types"]="\"image/vnd.wap.wbmp,image/png,image/x-png,image/jpeg,image/bmp,image/gif\"";
WRM._unparsedData["com.atlassian.jira.plugins.jira-dnd-attachment-plugin:dnd-issue-drop-zone.upload-limit"]="\"62914560\"";
WRM._unparsedData["com.atlassian.plugins.helptips.jira-help-tips:help-tip-manager.JiraHelpTipData"]="{\"anonymous\":true}";
WRM._unparsedData["com.atlassian.jira.jira-view-issue-plugin:controller-subtasks.controller.subtasks.parameters"]="{\"url\":\"/rest/api/2/issue/{issueId}/subtask/move\"}";
WRM._unparsedData["com.atlassian.analytics.analytics-client:policy-update-init.policy-update-data-provider"]="false";
WRM._unparsedData["com.atlassian.analytics.analytics-client:programmatic-analytics-init.programmatic-analytics-data-provider"]="false";
WRM._unparsedData["jira.webresources:avatar-picker.data"]="{}";
WRM._unparsedData["com.atlassian.feedback.jira-feedback-plugin:button-resources-init.data"]="{\"jira.feedback.plugin.issue.collector.core\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-UK&collectorId=abbf546d\",\"jira.feedback.plugin.issue.collector.default\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-UK&collectorId=abbf546d\",\"jira.feedback.plugin.issue.collector.service.desk\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?locale=en-UK&collectorId=a698db21\",\"jira.feedback.plugin.issue.collector.software\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-UK&collectorId=abbf546d\",\"isHeaderFeedbackButtonEnabled\":true}";
WRM._unparsedData["com.atlassian.jira.jira-header-plugin:dismissedFlags.flags"]="{\"dismissed\":[]}";
WRM._unparsedData["com.atlassian.jira.jira-header-plugin:newsletter-signup-tip-init.newsletterSignup"]="{\"signupDescription\":\"Get updates, inspiration and best practices from the team behind JIRA.\",\"formUrl\":\"https://www.atlassian.com/apis/exact-target/{0}/subscribe?mailingListId=1401671\",\"signupTitle\":\"Sign up!\",\"signupId\":\"newsletter-signup-tip\",\"showNewsletterTip\":false}";
WRM._unparsedData["com.atlassian.jira.project-templates-plugin:project-templates-plugin-resources.ptAnalyticsData"]="{\"instanceCreatedDate\":\"2011-01-31\"}";
WRM._unparsedData["com.atlassian.jira.plugins.jira-wiki-editor:wiki-editor-resources.help-data"]="{\"showHelp\":true,\"editorDocumentationUrl\":[\"https://docs.atlassian.com/jira/jcore-docs-076/Visual+editing\"],\"editorDocumentationTitle\":[\"Show me documentation for the visual editor\"]}";
WRM._unparsedData["com.atlassian.jira.plugins.jira-wiki-editor:wiki-editor-resources.thumbnails-allowed"]="false";
WRM._unparsedData["jira.webresources:user-message-flags.adminLockout"]="{}";
WRM._unparsedData["jira.request.correlation-id"]="\"9d5d4bf05d51df\"";
WRM._unparsedData["project-id"]="10594";
WRM._unparsedData["project-key"]="\"DERBY\"";
WRM._unparsedData["project-name"]="\"Derby\"";
WRM._unparsedData["project-type"]="\"software\"";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:generic-filters"]="[{\"id\":\"allissues\",\"jql\":\"project = \\\"{0}\\\" ORDER BY {1}\",\"defaultOrderby\":\"created DESC\",\"label\":\"All issues\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[]},{\"id\":\"allopenissues\",\"jql\":\"project = \\\"{0}\\\" AND resolution = Unresolved ORDER BY {1}\",\"defaultOrderby\":\"priority DESC, updated DESC\",\"label\":\"Open issues\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"resolution\"]},{\"id\":\"doneissues\",\"jql\":\"project = \\\"{0}\\\" AND statusCategory = Done ORDER BY {1}\",\"defaultOrderby\":\"updated DESC\",\"label\":\"Done issues\",\"requiresUser\":false,\"supportsInlineIssueCreate\":false,\"fields\":[\"status\"]},{\"id\":\"recentlyviewed\",\"jql\":\"project = \\\"{0}\\\" AND issuekey in issueHistory() ORDER BY {1}\",\"defaultOrderby\":\"lastViewed DESC\",\"label\":\"Viewed recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"issuekey\"]},{\"id\":\"addedrecently\",\"jql\":\"project = \\\"{0}\\\" AND created \u003e= -1w ORDER BY {1}\",\"defaultOrderby\":\"created DESC\",\"label\":\"Created recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"created\"]},{\"id\":\"resolvedrecently\",\"jql\":\"project = \\\"{0}\\\" AND resolutiondate \u003e= -1w ORDER BY {1}\",\"defaultOrderby\":\"updated DESC\",\"label\":\"Resolved recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":false,\"fields\":[\"resolutiondate\"]},{\"id\":\"updatedrecently\",\"jql\":\"project = \\\"{0}\\\" AND updated \u003e= -1w ORDER BY {1}\",\"defaultOrderby\":\"updated DESC\",\"label\":\"Updated recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"updated\"]}]";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:default-filter-priority"]="[\"allopenissues\",\"allissues\"]";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:can-manage-filters"]="false";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:project-filters"]="[]";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:can-create-issues"]="false";
WRM._unparsedData["projectId"]="10594";
WRM._unparsedData["projectKey"]="\"DERBY\"";
WRM._unparsedData["projectType"]="\"software\"";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:server-rendered"]="true";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <link type="text/css" rel="stylesheet" href="/jira/s/a8a4711bc3f2eb261d8c8fd9fbcbba8b-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/1fca1750044f2777c977e8d8cc023344/_/download/contextbatch/css/_super/batch.css" data-wrm-key="_super" data-wrm-batch-type="context" media="all"> 
  <link type="text/css" rel="stylesheet" href="/jira/s/74ac580603ca910fff0cfdf319e54add-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/fbf45109b31165e5b7740a9d72318cea/_/download/contextbatch/css/project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super/batch.css?agile_global_admin_condition=true&amp;hc-enabled=true&amp;is-server-instance=true&amp;jag=true&amp;jira.create.linked.issue=true&amp;nps-acknowledged=true&amp;richediton=true" data-wrm-key="project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super" data-wrm-batch-type="context" media="all"> 
  <link type="text/css" rel="stylesheet" href="/jira/s/611672383f6cab00ab202241ba6f9d68-T/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/7.6.3/_/download/batch/com.atlassian.feedback.jira-feedback-plugin:button-resources-init/com.atlassian.feedback.jira-feedback-plugin:button-resources-init.css" data-wrm-key="com.atlassian.feedback.jira-feedback-plugin:button-resources-init" data-wrm-batch-type="resource" media="all"> 
  <script type="text/javascript" src="/jira/s/98ceb006e504d7924d5ffc411626c6bc-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/1fca1750044f2777c977e8d8cc023344/_/download/contextbatch/js/_super/batch.js?locale=en-UK" data-wrm-key="_super" data-wrm-batch-type="context" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/c1e4d26ea276469807c3dc0918df482c-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/fbf45109b31165e5b7740a9d72318cea/_/download/contextbatch/js/project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super/batch.js?agile_global_admin_condition=true&amp;hc-enabled=true&amp;is-server-instance=true&amp;jag=true&amp;jira.create.linked.issue=true&amp;locale=en-UK&amp;nps-acknowledged=true&amp;richediton=true" data-wrm-key="project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super" data-wrm-batch-type="context" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/6bf9253c8d533109c3b02e26794be24e-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/871d45c9f322a22cb3aa9b7948a69803/_/download/contextbatch/js/atl.global,-_super/batch.js?locale=en-UK" data-wrm-key="atl.global,-_super" data-wrm-batch-type="context" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:calendar-en/jira.webresources:calendar-en.js" data-wrm-key="jira.webresources:calendar-en" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:calendar-localisation-moment/jira.webresources:calendar-localisation-moment.js" data-wrm-key="jira.webresources:calendar-localisation-moment" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/7.6.3/_/download/batch/com.atlassian.feedback.jira-feedback-plugin:button-resources/com.atlassian.feedback.jira-feedback-plugin:button-resources.js" data-wrm-key="com.atlassian.feedback.jira-feedback-plugin:button-resources" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <link type="text/css" rel="stylesheet" href="/jira/s/ccd2e67b523185973473e8bd5735c8f9-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/e0de73613a1027de08f3da6a45e1d1a2/_/download/contextbatch/css/jira.global.look-and-feel,-_super/batch.css" data-wrm-key="jira.global.look-and-feel,-_super" data-wrm-batch-type="context" media="all"> 
  <script type="text/javascript" src="/jira/rest/api/1.0/shortcuts/76005/33e5e0166867c8c9228d44506f60b2e8/shortcuts.js?context=issuenavigation&amp;context=issueaction"></script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["com.atlassian.jira.jira-issue-nav-components:inline-edit-enabled"]="true";
WRM._unparsedData["should-display-chaperone"]="false";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <link type="text/css" rel="stylesheet" href="/jira/s/15712b600e9aecf72ffd9fd3704a0c78-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/6b22a15c7b83f87a47b1757076f43542/_/download/contextbatch/css/com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue/batch.css?jira.create.linked.issue=true&amp;richediton=true" data-wrm-key="com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue" data-wrm-batch-type="context" media="all"> 
  <script type="text/javascript" src="/jira/s/6579b6b8ba67abaa496e39b9242a18a4-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/6b22a15c7b83f87a47b1757076f43542/_/download/contextbatch/js/com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue/batch.js?jira.create.linked.issue=true&amp;locale=en-UK&amp;richediton=true" data-wrm-key="com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue" data-wrm-batch-type="context" data-initially-rendered></script> 
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
  <meta name="ajs-can-search-users" content="false"> 
  <meta name="ajs-can-edit-watchers" content="false"> 
  <meta name="ajs-default-avatar-url" content="https://issues.apache.org/jira/secure/useravatar?size=xsmall&amp;avatarId=10453"> 
  <meta name="ajs-issue-project-type" content="software"> 
  <meta name="ajs-issue-key" content="DERBY-2991"> 
  <meta name="ajs-server-view-issue-is-editable" content="false"> 
  <title>[DERBY-2991] Index split deadlock - ASF JIRA</title> 
  <link rel="search" type="application/opensearchdescription+xml" href="/jira/osd.jsp" title="[DERBY-2991] Index split deadlock - ASF JIRA"> 
 </head> 
 <body id="jira" class="aui-layout aui-theme-default " data-version="7.6.3"> 
  <div id="page"> 
   <header id="header" role="banner"> 
    <script>
require(["jquery", "jira/license-banner"], function ($, licenseBanner) {
    $(function () {
        licenseBanner.showLicenseBanner("");
        licenseBanner.showLicenseFlag("");
    });
});
</script> 
    <nav class="aui-header aui-dropdown2-trigger-group" role="navigation">
     <div class="aui-header-inner">
      <div class="aui-header-before">
       <a class=" aui-dropdown2-trigger app-switcher-trigger" aria-controls="app-switcher" aria-haspopup="true" role="button" tabindex="0" data-aui-trigger href="#app-switcher"><span class="aui-icon aui-icon-small aui-iconfont-appswitcher">Linked Applications</span></a>
       <div id="app-switcher" class="aui-dropdown2 aui-style-default" role="menu" aria-hidden="true" data-is-switcher="true" data-environment="{&quot;isUserAdmin&quot;:false,&quot;isAppSuggestionAvailable&quot;:false,&quot;isSiteAdminUser&quot;:false}">
        <div role="application">
         <div class="app-switcher-loading">
          Loadingâ€¦
         </div>
        </div>
       </div>
      </div>
      <div class="aui-header-primary">
       <h1 id="logo" class="aui-header-logo aui-header-logo-custom"><a href="https://issues.apache.org/jira/secure/MyJiraHome.jspa"><img src="/jira/s/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/_/jira-logo-scaled.png" alt="ASF JIRA"></a></h1>
       <ul class="aui-nav">
        <li><a href="/jira/secure/Dashboard.jspa" class=" aui-nav-link aui-dropdown2-trigger aui-dropdown2-ajax" id="home_link" aria-haspopup="true" aria-controls="home_link-content" title="View and manage your dashboards" accesskey="d">Dashboards</a>
         <div class="aui-dropdown2 aui-style-default" id="home_link-content" data-aui-dropdown2-ajax-key="home_link"></div></li>
        <li><a href="/jira/browse/DERBY" class=" aui-nav-link aui-dropdown2-trigger aui-dropdown2-ajax" id="browse_link" aria-haspopup="true" aria-controls="browse_link-content" title="View recent projects and browse a list of projects" accesskey="p">Projects</a>
         <div class="aui-dropdown2 aui-style-default" id="browse_link-content" data-aui-dropdown2-ajax-key="browse_link"></div></li>
        <li><a href="/jira/issues/" class=" aui-nav-link aui-dropdown2-trigger aui-dropdown2-ajax" id="find_link" aria-haspopup="true" aria-controls="find_link-content" title="Search for issues and view recent issues" accesskey="i">Issues</a>
         <div class="aui-dropdown2 aui-style-default" id="find_link-content" data-aui-dropdown2-ajax-key="find_link"></div></li> 
       </ul>
      </div>
      <div class="aui-header-secondary">
       <ul class="aui-nav">
        <li id="quicksearch-menu"> 
         <form action="/jira/secure/QuickSearch.jspa" method="get" id="quicksearch" class="aui-quicksearch dont-default-focus ajs-dirty-warning-exempt"> 
          <input id="quickSearchInput" class="search" type="text" title="Search" placeholder="Search" name="searchString" accessKey="q"> 
          <input type="submit" class="hidden" value="Search"> 
         </form> </li> 
        <li><a class="jira-feedback-plugin" role="button" aria-haspopup="true" id="jira-header-feedback-link" href="#"><span class="aui-icon aui-icon-small jira-feedback-plugin-icon">Give feedback to Atlassian</span></a></li> 
        <li id="system-help-menu"> <a class="aui-nav-link aui-dropdown2-trigger" id="help_menu" aria-haspopup="true" aria-owns="system-help-menu-content" href="https://docs.atlassian.com/jira/jcore-docs-076/" target="$textUtils.htmlEncode($rootHelpMenuItem.params.target)" title="Help"><span class="aui-icon aui-icon-small aui-iconfont-help">Help</span></a> 
         <div id="system-help-menu-content" class="aui-dropdown2 aui-style-default"> 
          <div class="aui-dropdown2-section"> 
           <ul id="jira-help" class="aui-list-truncate"> 
            <li> <a id="view_core_help" class="aui-nav-link " title="Go to the online documentation for JIRA Core" href="https://docs.atlassian.com/jira/jcore-docs-076/" target="_blank">JIRA Core help</a> </li> 
            <li> <a id="keyshortscuthelp" class="aui-nav-link " title="Get more information about JIRA's Keyboard Shortcuts" href="/jira/secure/ViewKeyboardShortcuts!default.jspa" target="_blank">Keyboard Shortcuts</a> </li> 
            <li> <a id="view_about" class="aui-nav-link " title="Get more information about JIRA" href="/jira/secure/AboutPage.jspa">About JIRA</a> </li> 
            <li> <a id="view_credits" class="aui-nav-link " title="See who did what" href="/jira/secure/JiraCreditsPage!default.jspa" target="_blank">JIRA Credits</a> </li> 
           </ul> 
          </div> 
         </div> </li> 
        <li id="user-options"> <a class="aui-nav-link login-link" href="/jira/login.jsp?os_destination=%2Fbrowse%2FDERBY-2991">Log In</a> 
         <div id="user-options-content" class="aui-dropdown2 aui-style-default"> 
          <div class="aui-dropdown2-section"> 
          </div> 
         </div> </li> 
       </ul>
      </div>
     </div>
     <!-- .aui-header-inner-->
    </nav>
    <!-- .aui-header --> 
   </header> 
   <section id="content" role="main"> 
    <big-pipe data-id="sidebar-id" unresolved></big-pipe>
    <div class="aui-sidebar  sidebar-placeholder">
     <div class="aui-sidebar-wrapper">
      <div class="aui-sidebar-body"></div>
      <div class="aui-sidebar-footer">
       <a class="aui-button aui-button-subtle aui-sidebar-toggle aui-sidebar-footer-tipsy" data-tooltip="Expand sidebar ( [ )" href="#"><span class="aui-icon aui-icon-small"></span></a>
      </div>
     </div>
    </div>
    <script id="projects-sidebar-init">
    require(['jira/projects/sidebar/expansion-manager'], function(expansionManager) {
        var scriptTag = document.getElementById('projects-sidebar-init');
        var sidebar = AJS.sidebar('.aui-sidebar');
        expansionManager(sidebar);
        scriptTag.parentElement.removeChild(scriptTag);
    });
    </script>
    <div class="aui-page-panel">
     <div class="aui-page-panel-inner">
      <div class="issue-navigator">
       <div class="content">
        <div class="issue-view">
         <div class="navigation-tools">
          <div class="pager-container"></div>
         </div>
         <div class="issue-container">
          <div id="issue-content" class="issue-edit-form">
           <header id="stalker" class="issue-header js-stalker">
            <div class="issue-header-content">
             <header class="aui-page-header">
              <div class="aui-page-header-inner">
               <div class="aui-page-header-image">
                <span id="10594" class="aui-avatar aui-avatar-large aui-avatar-project"><span class="aui-avatar-inner"><img id="project-avatar" alt="Uploaded image for project: 'Derby'" src="https://issues.apache.org/jira/secure/projectavatar?pid=10594&amp;avatarId=10122"></span></span>
               </div>
               <!-- .aui-page-header-image -->
               <div class="aui-page-header-main">
                <ol class="aui-nav aui-nav-breadcrumbs">
                 <li><a id="project-name-val" href="/jira/browse/DERBY">Derby</a></li>
                 <li><a class="issue-link" data-issue-key="DERBY-2991" href="/jira/browse/DERBY-2991" id="key-val" rel="12375269">DERBY-2991</a></li>
                </ol>
                <h1 id="summary-val">Index split deadlock</h1>
               </div>
               <!-- .aui-page-header-main -->
               <div class="aui-page-header-actions">
                <div id="issue-header-pager"></div>
               </div>
               <!-- .aui-page-header-actions -->
              </div>
              <!-- .aui-page-header-inner -->
             </header>
             <!-- .aui-page-header -->
             <div class="command-bar">
              <div class="ops-cont">
               <div class="ops-menus aui-toolbar">
                <div class="toolbar-split toolbar-split-left">
                 <ul id="opsbar-ops-login-lnk_container" class="toolbar-group pluggable-ops">
                  <li class="toolbar-item"><a id="ops-login-lnk" title="Log In" class="toolbar-trigger" href="/jira/login.jsp?os_destination=%2Fbrowse%2FDERBY-2991"><span class="trigger-label">Log In</span></a></li>
                 </ul>
                 <ul id="opsbar-opsbar-operations" class="toolbar-group pluggable-ops"></ul>
                 <ul id="opsbar-opsbar-transitions" class="toolbar-group pluggable-ops"></ul>
                 <ul id="opsbar-opsbar-admin" class="toolbar-group pluggable-ops"></ul>
                </div>
                <div class="toolbar-split toolbar-split-right">
                 <ul id="opsbar-jira.issue.tools" class="toolbar-group pluggable-ops">
                  <li class="toolbar-item">
                   <div>
                    <a href="#" id="viewissue-export" aria-owns="viewissue-export_drop" aria-haspopup="true" title="Export this issue in another format" class="toolbar-trigger aui-button aui-style-default aui-dropdown2-trigger"><span class="icon icon-default aui-icon aui-icon-small aui-iconfont-export"></span> <span class="dropdown-text">Export</span></a>
                    <div id="viewissue-export_drop" class="aui-style-default aui-dropdown2">
                     <ul>
                      <li class="aui-list-item"><a href="/jira/si/jira.issueviews:issue-xml/DERBY-2991/DERBY-2991.xml" id="jira.issueviews:issue-xml"><span class="trigger-label">XML</span></a></li>
                      <li class="aui-list-item"><a href="/jira/si/jira.issueviews:issue-word/DERBY-2991/DERBY-2991.doc" id="jira.issueviews:issue-word"><span class="trigger-label">Word</span></a></li>
                      <li class="aui-list-item"><a href="/jira/si/jira.issueviews:issue-html/DERBY-2991/DERBY-2991.html" id="jira.issueviews:issue-html"><span class="trigger-label">Printable</span></a></li>
                      <li class="aui-list-item"><a href="/jira/si/com.atlassian.jira.plugins.jira-importers-plugin:issue-json/DERBY-2991/DERBY-2991.json" id="com.atlassian.jira.plugins.jira-importers-plugin:issue-json"><span class="trigger-label">JSON</span></a></li>
                     </ul>
                    </div>
                   </div></li>
                 </ul>
                </div>
               </div>
              </div>
             </div>
            </div>
           </header>
           <div class="issue-body-content">
            <div class="aui-group issue-body">
             <div class="aui-item issue-main-column">
              <div id="details-module" class="module toggle-wrap">
               <div id="details-module_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Details</h2>
               </div>
               <div class="mod-content"> 
                <ul id="issuedetails" class="property-list two-cols"> 
                 <li class="item"> 
                  <div class="wrap"> 
                   <strong class="name">Type:</strong> 
                   <span id="type-val" class="value"> <img alt="" height="16" src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype" title="Bug - A problem which impairs or prevents the functions of the product." width="16"> Bug </span> 
                  </div> </li> 
                 <li class="item item-right"> 
                  <div class="wrap"> 
                   <strong class="name">Status:</strong> 
                   <span id="status-val" class="value"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done jira-issue-status-lozenge-max-width-medium" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Closed</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.</span>">Closed</span> </span> 
                  </div> </li> 
                 <li class="item new"> 
                  <div class="wrap"> 
                   <strong class="name">Priority:</strong> 
                   <span id="priority-val" class="value"> <img alt="" height="16" src="/jira/images/icons/priorities/major.svg" title="Major - Major loss of function." width="16"> Major </span> 
                  </div> </li> 
                 <li class="item item-right"> 
                  <div class="wrap"> 
                   <strong class="name">Resolution:</strong> 
                   <span id="resolution-val" class="value resolved"> Fixed </span> 
                  </div> </li> 
                 <li class="item"> 
                  <div class="wrap"> 
                   <strong class="name">Affects Version/s:</strong> 
                   <span id="versions-val" class="value"> <span class="shorten" id="versions-field"> <span title="10.2.2.0 ">10.2.2.0</span>, <span title="10.3.1.4 ">10.3.1.4</span>, <span title="10.4.2.0 ">10.4.2.0</span> </span> </span> 
                  </div> </li> 
                 <li class="item item-right"> 
                  <div class="wrap"> 
                   <strong class="name">Fix Version/s:</strong> 
                   <span id="fixfor-val" class="value"> <span class="shorten" id="fixVersions-field"> <a href="/jira/issues/?jql=project+%3D+DERBY+AND+fixVersion+%3D+10.5.1.1" title="10.5.1.1 build: 764942, 14/Apr/09. Voted release: 28/Apr/09. Announced: 1/May/09">10.5.1.1</a> </span> </span> 
                  </div> </li> 
                 <li class="item"> 
                  <div class="wrap"> 
                   <strong class="name">Component/s:</strong> 
                   <span id="components-val" class="value"> <span class="shorten" id="components-field"> <a href="/jira/issues/?jql=project+%3D+DERBY+AND+component+%3D+Store" title="Store ">Store</a> </span> </span> 
                  </div> </li> 
                 <li class="item full-width"> 
                  <div class="wrap" id="wrap-labels"> 
                   <strong class="name">Labels:</strong> 
                   <div class="labels-wrap value"> 
                    <span class="labels" id="labels-12375269-value">None</span> 
                   </div> 
                  </div> </li> 
                 <li class="item full-width"> 
                  <div class="wrap"> 
                   <strong class="name">Environment:</strong> 
                   <div id="environment-val" class="value">
                     Windows XP, Java 6 
                   </div> 
                  </div> </li> 
                </ul> 
                <div id="customfieldmodule"> 
                 <div class="aui-tabs horizontal-tabs" id="customfield-tabs"> 
                  <div id="customfield-panel-1" class="tabs-pane active-pane"> 
                   <ul class="property-list"> 
                    <li id="rowForcustomfield_12310090" class="item"> 
                     <div class="wrap"> 
                      <strong title="Issue &amp; fix info" class="name">Issue &amp; fix info:</strong> 
                      <div id="customfield_12310090-val" class="value type-multicheckboxes" data-fieldtype="multicheckboxes" data-fieldtypecompletekey="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes"> 
                       <div class="shorten" id="customfield_12310090-field"> 
                        <span>High Value Fix</span> 
                       </div> 
                      </div> 
                     </div> </li> 
                   </ul> 
                  </div> 
                 </div>
                </div> 
               </div>
              </div>
              <div id="descriptionmodule" class="module toggle-wrap">
               <div id="descriptionmodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Description</h2>
               </div>
               <div class="mod-content">
                <div id="description-val" class="field-ignore-highlight"> 
                 <div class="user-content-block"> 
                  <p>After doing dome research on the mailing list, it appears that the index split deadlock is a known behaviour, so I will start by describing the theoretical problem first and then follow with the details of my test case.</p> 
                  <p>If you have concurrent select and insert transactions on the same table, the observed locking behaviour is as follows:</p> 
                  <ul class="alternate" type="square"> 
                   <li>the select transaction acquires an S lock on the root block of the index and then waits for an S lock on some uncommitted row of the insert transaction</li> 
                   <li>the insert transaction acquires X locks on the inserted records and if it needs to do an index split creates a sub-transaction that tries to acquire an X lock on the root block of the index</li> 
                  </ul> 
                  <p>In summary: INDEX LOCK followed by ROW LOCK + ROW LOCK followed by INDEX LOCK = deadlock</p> 
                  <p>In the case of my project this is an important issue (lack of concurrency after being forced to use table level locking) and I would like to contribute to the project and fix this issue (if possible). I was wondering if someone that knows the code can give me a few pointers on the implications of this issue:</p> 
                  <ul class="alternate" type="square"> 
                   <li>Is this a limitation of the top-down algorithm used?</li> 
                   <li>Would fixing it require to use a bottom up algorithm for better concurrency (which is certainly non trivial)?</li> 
                   <li>Trying to break the circular locking above, I would first question why does the select transaction need to acquire (and hold) a lock on the root block of the index. Would it be possible to ensure the consistency of the select without locking the index?</li> 
                  </ul> 
                  <hr> 
                  <p>The attached test (InsertSelectDeadlock.java) tries to simulate a typical data collection application, it consists of: </p> 
                  <ul class="alternate" type="square"> 
                   <li>an insert thread that inserts records in batch</li> 
                   <li>a select thread that 'processes' the records inserted by the other thread: 'select * from table where id &gt; ?'</li> 
                  </ul> 
                  <p>The derby log provides detail about the deadlock trace and stacktraces_during_deadlock.txt shows that the inser thread is doing an index split.</p> 
                  <p>The test was run on 10.2.2.0 and 10.3.1.4 with identical behaviour.</p> 
                  <p>Thanks,</p> 
                  <p>Bogdan Calmac.</p> 
                 </div> 
                </div> 
               </div>
              </div>
              <div id="dnd-metadata" class="module toggle-wrap">
               <div id="dnd-metadata_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Attachments</h2>
               </div>
               <div class="mod-content">
                <div id="dnd-metadata-webpanel" data-can-attach="false" data-project-type="software" data-upload-limit="62914560" data-thumbnails-allowed="false"></div>
               </div>
              </div>
              <div id="attachmentmodule" class="module toggle-wrap">
               <div id="attachmentmodule_heading" class="mod-header">
                <ul class="ops">
                 <li class="drop">
                  <div class="aui-dd-parent">
                   <a href="#" class="icon drop-menu js-default-dropdown" title="Options"><span>Options</span></a>
                   <div class="aui-dropdown-content aui-list">
                    <ul id="attachment-sorting-options" class="aui-list-section aui-first">
                     <li class="aui-list-item"><a id="attachment-sort-key-name" href="/jira/browse/DERBY-2991?attachmentSortBy=fileName#attachmentmodule" class="aui-list-checked aui-checked aui-list-item-link" title="viewissue.subtasks.tab.show.all.name"><span>Sort By Name</span></a></li>
                     <li class="aui-list-item"><a id="attachment-sort-key-date" href="/jira/browse/DERBY-2991?attachmentSortBy=dateTime#attachmentmodule" class="aui-list-checked aui-list-item-link" title="Sort By Date"><span>Sort By Date</span></a></li>
                    </ul>
                    <ul id="attachment-sorting-order-options" class="aui-list-section aui-last">
                     <li class="aui-list-item"><a id="attachment-sort-direction-asc" href="/jira/browse/DERBY-2991?attachmentOrder=asc#attachmentmodule" class="aui-list-checked aui-checked aui-list-item-link" title="Ascending"><span>Ascending</span></a></li>
                     <li class="aui-list-item"><a id="attachment-sort-direction-desc" href="/jira/browse/DERBY-2991?attachmentOrder=desc#attachmentmodule" class="aui-list-checked aui-list-item-link" title="Descending"><span>Descending</span></a></li>
                    </ul>
                   </div>
                  </div></li>
                </ul>
                <h2 class="toggle-title">Attachments</h2>
               </div>
               <div class="mod-content">
                <ol id="file_attachments" class="item-attachments" data-sort-key="fileName" data-sort-order="asc">
                 <li class="attachment-content js-file-attachment" data-attachment-id="12401040" data-issue-id="12375269" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12401040/d2991-2a.diff" draggable="true" data-downloadurl="text/x-diff:d2991-2a.diff:https://issues.apache.org/jira/secure/attachment/12401040/d2991-2a.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12401040/d2991-2a.diff" title="Latest  26/Feb/09 13:22 - Knut Anders Hatlen" draggable="true" data-downloadurl="text/x-diff:d2991-2a.diff:https://issues.apache.org/jira/secure/attachment/12401040/d2991-2a.diff">d2991-2a.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2009-02-26T13:22:31.984Z">26/Feb/09 13:22</time>
                   </dd>
                   <dd class="attachment-size">
                    436 kB
                   </dd>
                   <dd class="attachment-author">
                    Knut Anders Hatlen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12401041" data-issue-id="12375269" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12401041/d2991-2a.stat" draggable="true" data-downloadurl="application/x-subversion-stat:d2991-2a.stat:https://issues.apache.org/jira/secure/attachment/12401041/d2991-2a.stat"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12401041/d2991-2a.stat" title="Latest  26/Feb/09 13:22 - Knut Anders Hatlen" draggable="true" data-downloadurl="application/x-subversion-stat:d2991-2a.stat:https://issues.apache.org/jira/secure/attachment/12401041/d2991-2a.stat">d2991-2a.stat</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2009-02-26T13:22:32.046Z">26/Feb/09 13:22</time>
                   </dd>
                   <dd class="attachment-size">
                    2 kB
                   </dd>
                   <dd class="attachment-author">
                    Knut Anders Hatlen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12401754" data-issue-id="12375269" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12401754/d2991-2b.diff" draggable="true" data-downloadurl="text/x-patch:d2991-2b.diff:https://issues.apache.org/jira/secure/attachment/12401754/d2991-2b.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12401754/d2991-2b.diff" title="Latest  09/Mar/09 15:01 - Knut Anders Hatlen" draggable="true" data-downloadurl="text/x-patch:d2991-2b.diff:https://issues.apache.org/jira/secure/attachment/12401754/d2991-2b.diff">d2991-2b.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2009-03-09T15:01:14.140Z">09/Mar/09 15:01</time>
                   </dd>
                   <dd class="attachment-size">
                    444 kB
                   </dd>
                   <dd class="attachment-author">
                    Knut Anders Hatlen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12401755" data-issue-id="12375269" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12401755/d2991-2b.stat" draggable="true" data-downloadurl="text/plain:d2991-2b.stat:https://issues.apache.org/jira/secure/attachment/12401755/d2991-2b.stat"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-file-txt" title="Text File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12401755/d2991-2b.stat" title="Latest  09/Mar/09 15:01 - Knut Anders Hatlen" draggable="true" data-downloadurl="text/plain:d2991-2b.stat:https://issues.apache.org/jira/secure/attachment/12401755/d2991-2b.stat">d2991-2b.stat</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2009-03-09T15:01:14.245Z">09/Mar/09 15:01</time>
                   </dd>
                   <dd class="attachment-size">
                    2 kB
                   </dd>
                   <dd class="attachment-author">
                    Knut Anders Hatlen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12394546" data-issue-id="12375269" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12394546/d2991-preview-1a.diff" draggable="true" data-downloadurl="text/x-diff:d2991-preview-1a.diff:https://issues.apache.org/jira/secure/attachment/12394546/d2991-preview-1a.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12394546/d2991-preview-1a.diff" title="Latest  24/Nov/08 10:56 - Knut Anders Hatlen" draggable="true" data-downloadurl="text/x-diff:d2991-preview-1a.diff:https://issues.apache.org/jira/secure/attachment/12394546/d2991-preview-1a.diff">d2991-preview-1a.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2008-11-24T10:56:51.675Z">24/Nov/08 10:56</time>
                   </dd>
                   <dd class="attachment-size">
                    17 kB
                   </dd>
                   <dd class="attachment-author">
                    Knut Anders Hatlen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12394547" data-issue-id="12375269" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12394547/d2991-preview-1a.stat" draggable="true" data-downloadurl="application/x-subversion-stat:d2991-preview-1a.stat:https://issues.apache.org/jira/secure/attachment/12394547/d2991-preview-1a.stat"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12394547/d2991-preview-1a.stat" title="Latest  24/Nov/08 10:56 - Knut Anders Hatlen" draggable="true" data-downloadurl="application/x-subversion-stat:d2991-preview-1a.stat:https://issues.apache.org/jira/secure/attachment/12394547/d2991-preview-1a.stat">d2991-preview-1a.stat</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2008-11-24T10:56:51.727Z">24/Nov/08 10:56</time>
                   </dd>
                   <dd class="attachment-size">
                    0.4 kB
                   </dd>
                   <dd class="attachment-author">
                    Knut Anders Hatlen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12394768" data-issue-id="12375269" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12394768/d2991-preview-1b.diff" draggable="true" data-downloadurl="application/octet-stream:d2991-preview-1b.diff:https://issues.apache.org/jira/secure/attachment/12394768/d2991-preview-1b.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12394768/d2991-preview-1b.diff" title="Latest  26/Nov/08 19:03 - Knut Anders Hatlen" draggable="true" data-downloadurl="application/octet-stream:d2991-preview-1b.diff:https://issues.apache.org/jira/secure/attachment/12394768/d2991-preview-1b.diff">d2991-preview-1b.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2008-11-26T19:03:20.152Z">26/Nov/08 19:03</time>
                   </dd>
                   <dd class="attachment-size">
                    225 kB
                   </dd>
                   <dd class="attachment-author">
                    Knut Anders Hatlen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12394769" data-issue-id="12375269" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12394769/d2991-preview-1b.stat" draggable="true" data-downloadurl="application/octet-stream:d2991-preview-1b.stat:https://issues.apache.org/jira/secure/attachment/12394769/d2991-preview-1b.stat"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12394769/d2991-preview-1b.stat" title="Latest  26/Nov/08 19:03 - Knut Anders Hatlen" draggable="true" data-downloadurl="application/octet-stream:d2991-preview-1b.stat:https://issues.apache.org/jira/secure/attachment/12394769/d2991-preview-1b.stat">d2991-preview-1b.stat</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2008-11-26T19:03:20.209Z">26/Nov/08 19:03</time>
                   </dd>
                   <dd class="attachment-size">
                    1 kB
                   </dd>
                   <dd class="attachment-author">
                    Knut Anders Hatlen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12394894" data-issue-id="12375269" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12394894/d2991-preview-1c.diff" draggable="true" data-downloadurl="application/x-subversion-stat:d2991-preview-1c.diff:https://issues.apache.org/jira/secure/attachment/12394894/d2991-preview-1c.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12394894/d2991-preview-1c.diff" title="Latest  28/Nov/08 10:44 - Knut Anders Hatlen" draggable="true" data-downloadurl="application/x-subversion-stat:d2991-preview-1c.diff:https://issues.apache.org/jira/secure/attachment/12394894/d2991-preview-1c.diff">d2991-preview-1c.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2008-11-28T10:44:58.747Z">28/Nov/08 10:44</time>
                   </dd>
                   <dd class="attachment-size">
                    261 kB
                   </dd>
                   <dd class="attachment-author">
                    Knut Anders Hatlen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12394895" data-issue-id="12375269" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12394895/d2991-preview-1c.stat" draggable="true" data-downloadurl="application/x-subversion-stat:d2991-preview-1c.stat:https://issues.apache.org/jira/secure/attachment/12394895/d2991-preview-1c.stat"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12394895/d2991-preview-1c.stat" title="Latest  28/Nov/08 10:44 - Knut Anders Hatlen" draggable="true" data-downloadurl="application/x-subversion-stat:d2991-preview-1c.stat:https://issues.apache.org/jira/secure/attachment/12394895/d2991-preview-1c.stat">d2991-preview-1c.stat</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2008-11-28T10:44:58.783Z">28/Nov/08 10:44</time>
                   </dd>
                   <dd class="attachment-size">
                    2 kB
                   </dd>
                   <dd class="attachment-author">
                    Knut Anders Hatlen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12396194" data-issue-id="12375269" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12396194/d2991-preview-1d.diff" draggable="true" data-downloadurl="application/x-subversion-stat:d2991-preview-1d.diff:https://issues.apache.org/jira/secure/attachment/12396194/d2991-preview-1d.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12396194/d2991-preview-1d.diff" title="Latest  16/Dec/08 14:57 - Knut Anders Hatlen" draggable="true" data-downloadurl="application/x-subversion-stat:d2991-preview-1d.diff:https://issues.apache.org/jira/secure/attachment/12396194/d2991-preview-1d.diff">d2991-preview-1d.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2008-12-16T14:57:00.968Z">16/Dec/08 14:57</time>
                   </dd>
                   <dd class="attachment-size">
                    265 kB
                   </dd>
                   <dd class="attachment-author">
                    Knut Anders Hatlen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12396195" data-issue-id="12375269" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12396195/d2991-preview-1d.stat" draggable="true" data-downloadurl="application/x-subversion-stat:d2991-preview-1d.stat:https://issues.apache.org/jira/secure/attachment/12396195/d2991-preview-1d.stat"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12396195/d2991-preview-1d.stat" title="Latest  16/Dec/08 14:57 - Knut Anders Hatlen" draggable="true" data-downloadurl="application/x-subversion-stat:d2991-preview-1d.stat:https://issues.apache.org/jira/secure/attachment/12396195/d2991-preview-1d.stat">d2991-preview-1d.stat</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2008-12-16T14:57:01.052Z">16/Dec/08 14:57</time>
                   </dd>
                   <dd class="attachment-size">
                    2 kB
                   </dd>
                   <dd class="attachment-author">
                    Knut Anders Hatlen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12398468" data-issue-id="12375269" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12398468/d2991-preview-1e.diff" draggable="true" data-downloadurl="text/x-diff:d2991-preview-1e.diff:https://issues.apache.org/jira/secure/attachment/12398468/d2991-preview-1e.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12398468/d2991-preview-1e.diff" title="Latest  22/Jan/09 14:09 - Knut Anders Hatlen" draggable="true" data-downloadurl="text/x-diff:d2991-preview-1e.diff:https://issues.apache.org/jira/secure/attachment/12398468/d2991-preview-1e.diff">d2991-preview-1e.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2009-01-22T14:09:25.112Z">22/Jan/09 14:09</time>
                   </dd>
                   <dd class="attachment-size">
                    269 kB
                   </dd>
                   <dd class="attachment-author">
                    Knut Anders Hatlen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12363099" data-issue-id="12375269" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12363099/derby.log" draggable="true" data-downloadurl="text/plain:derby.log:https://issues.apache.org/jira/secure/attachment/12363099/derby.log"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-file-txt" title="Text File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12363099/derby.log" title="Latest  03/Aug/07 04:11 - Bogdan Calmac" draggable="true" data-downloadurl="text/plain:derby.log:https://issues.apache.org/jira/secure/attachment/12363099/derby.log">derby.log</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-08-03T04:11:56.576Z">03/Aug/07 04:11</time>
                   </dd>
                   <dd class="attachment-size">
                    45 kB
                   </dd>
                   <dd class="attachment-author">
                    Bogdan Calmac
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12363098" data-issue-id="12375269" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12363098/InsertSelectDeadlock.java" draggable="true" data-downloadurl="text/plain:InsertSelectDeadlock.java:https://issues.apache.org/jira/secure/attachment/12363098/InsertSelectDeadlock.java"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-file-txt" title="Text File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12363098/InsertSelectDeadlock.java" title="Latest  03/Aug/07 04:11 - Bogdan Calmac" draggable="true" data-downloadurl="text/plain:InsertSelectDeadlock.java:https://issues.apache.org/jira/secure/attachment/12363098/InsertSelectDeadlock.java">InsertSelectDeadlock.java</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-08-03T04:11:07.603Z">03/Aug/07 04:11</time>
                   </dd>
                   <dd class="attachment-size">
                    6 kB
                   </dd>
                   <dd class="attachment-author">
                    Bogdan Calmac
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12396408" data-issue-id="12375269" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12396408/perftest.diff" draggable="true" data-downloadurl="application/x-subversion-stat:perftest.diff:https://issues.apache.org/jira/secure/attachment/12396408/perftest.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12396408/perftest.diff" title="Latest  18/Dec/08 18:16 - Knut Anders Hatlen" draggable="true" data-downloadurl="application/x-subversion-stat:perftest.diff:https://issues.apache.org/jira/secure/attachment/12396408/perftest.diff">perftest.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2008-12-18T18:16:05.811Z">18/Dec/08 18:16</time>
                   </dd>
                   <dd class="attachment-size">
                    10 kB
                   </dd>
                   <dd class="attachment-author">
                    Knut Anders Hatlen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12364090" data-issue-id="12375269" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12364090/Repro2991.java" draggable="true" data-downloadurl="java/*:Repro2991.java:https://issues.apache.org/jira/secure/attachment/12364090/Repro2991.java"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12364090/Repro2991.java" title="Latest  18/Aug/07 20:23 - Kurt Huwig" draggable="true" data-downloadurl="java/*:Repro2991.java:https://issues.apache.org/jira/secure/attachment/12364090/Repro2991.java">Repro2991.java</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-08-18T20:23:46.750Z">18/Aug/07 20:23</time>
                   </dd>
                   <dd class="attachment-size">
                    4 kB
                   </dd>
                   <dd class="attachment-author">
                    Kurt Huwig
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12363100" data-issue-id="12375269" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12363100/stacktraces_during_deadlock.txt" draggable="true" data-downloadurl="text/plain:stacktraces_during_deadlock.txt:https://issues.apache.org/jira/secure/attachment/12363100/stacktraces_during_deadlock.txt"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-file-txt" title="Text File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12363100/stacktraces_during_deadlock.txt" title="Latest  03/Aug/07 04:12 - Bogdan Calmac" draggable="true" data-downloadurl="text/plain:stacktraces_during_deadlock.txt:https://issues.apache.org/jira/secure/attachment/12363100/stacktraces_during_deadlock.txt">stacktraces_during_deadlock.txt</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-08-03T04:12:52.683Z">03/Aug/07 04:12</time>
                   </dd>
                   <dd class="attachment-size">
                    5 kB
                   </dd>
                   <dd class="attachment-author">
                    Bogdan Calmac
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12400515" data-issue-id="12375269" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12400515/test-1.diff" draggable="true" data-downloadurl="text/x-diff:test-1.diff:https://issues.apache.org/jira/secure/attachment/12400515/test-1.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12400515/test-1.diff" title="Latest  19/Feb/09 13:51 - Knut Anders Hatlen" draggable="true" data-downloadurl="text/x-diff:test-1.diff:https://issues.apache.org/jira/secure/attachment/12400515/test-1.diff">test-1.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2009-02-19T13:51:25.703Z">19/Feb/09 13:51</time>
                   </dd>
                   <dd class="attachment-size">
                    12 kB
                   </dd>
                   <dd class="attachment-author">
                    Knut Anders Hatlen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12400613" data-issue-id="12375269" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12400613/test-2.diff" draggable="true" data-downloadurl="text/x-diff:test-2.diff:https://issues.apache.org/jira/secure/attachment/12400613/test-2.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12400613/test-2.diff" title="Latest  20/Feb/09 15:26 - Knut Anders Hatlen" draggable="true" data-downloadurl="text/x-diff:test-2.diff:https://issues.apache.org/jira/secure/attachment/12400613/test-2.diff">test-2.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2009-02-20T15:26:38.756Z">20/Feb/09 15:26</time>
                   </dd>
                   <dd class="attachment-size">
                    9 kB
                   </dd>
                   <dd class="attachment-author">
                    Knut Anders Hatlen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12400744" data-issue-id="12375269" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12400744/test-3.diff" draggable="true" data-downloadurl="text/x-diff:test-3.diff:https://issues.apache.org/jira/secure/attachment/12400744/test-3.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12400744/test-3.diff" title="Latest  23/Feb/09 10:48 - Knut Anders Hatlen" draggable="true" data-downloadurl="text/x-diff:test-3.diff:https://issues.apache.org/jira/secure/attachment/12400744/test-3.diff">test-3.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2009-02-23T10:48:36.628Z">23/Feb/09 10:48</time>
                   </dd>
                   <dd class="attachment-size">
                    12 kB
                   </dd>
                   <dd class="attachment-author">
                    Knut Anders Hatlen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12402282" data-issue-id="12375269" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12402282/test-4.diff" draggable="true" data-downloadurl="text/x-patch:test-4.diff:https://issues.apache.org/jira/secure/attachment/12402282/test-4.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12402282/test-4.diff" title="Latest  16/Mar/09 14:16 - Knut Anders Hatlen" draggable="true" data-downloadurl="text/x-patch:test-4.diff:https://issues.apache.org/jira/secure/attachment/12402282/test-4.diff">test-4.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2009-03-16T14:16:51.082Z">16/Mar/09 14:16</time>
                   </dd>
                   <dd class="attachment-size">
                    0.8 kB
                   </dd>
                   <dd class="attachment-author">
                    Knut Anders Hatlen
                   </dd>
                  </dl></li>
                </ol>
               </div>
              </div>
              <div id="linkingmodule" class="module toggle-wrap">
               <div id="linkingmodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Issue Links</h2>
               </div>
               <div class="mod-content"> 
                <div class="links-container" data-default-link-icon="/jira/images/icons/generic_link_16.png"> 
                 <dl class="links-list "> 
                  <dt title="is depended upon by">
                   is depended upon by
                  </dt> 
                  <dd id="internal-12413476_10001"> 
                   <div class="link-content"> 
                    <p> <img src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype" width="16" height="16" title="Bug - A problem which impairs or prevents the functions of the product." alt="Bug - A problem which impairs or prevents the functions of the product."> <span title="DERBY-4033: 50 transactions timing out with no CPU usage and no deadlocks"> <a href="/jira/browse/DERBY-4033" data-issue-key="DERBY-4033" class="issue-link link-title resolution">DERBY-4033</a> <span class="link-summary">50 transactions timing out with no CPU usage and no deadlocks</span> </span> </p> 
                    <ul class="link-snapshot"> 
                     <li class="priority"> <img src="/jira/images/icons/priorities/major.svg" width="16" height="16" title="Major - Major loss of function." alt="Major - Major loss of function."> </li> 
                     <li class="status"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done aui-lozenge-subtle jira-issue-status-lozenge-max-width-short" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Closed</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.</span>">Closed</span> </li> 
                    </ul> 
                   </div> 
                  </dd> 
                 </dl> 
                 <dl class="links-list "> 
                  <dt title="is duplicated by">
                   is duplicated by
                  </dt> 
                  <dd id="internal-12376342_12310000"> 
                   <div class="link-content"> 
                    <p> <img src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype" width="16" height="16" title="Bug - A problem which impairs or prevents the functions of the product." alt="Bug - A problem which impairs or prevents the functions of the product."> <span title="DERBY-3015: Concurrent select and insert deadlock on index"> <a href="/jira/browse/DERBY-3015" data-issue-key="DERBY-3015" class="issue-link link-title resolution">DERBY-3015</a> <span class="link-summary">Concurrent select and insert deadlock on index</span> </span> </p> 
                    <ul class="link-snapshot"> 
                     <li class="priority"> <img src="/jira/images/icons/priorities/major.svg" width="16" height="16" title="Major - Major loss of function." alt="Major - Major loss of function."> </li> 
                     <li class="status"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done aui-lozenge-subtle jira-issue-status-lozenge-max-width-short" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Closed</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.</span>">Closed</span> </li> 
                    </ul> 
                   </div> 
                  </dd> 
                  <dd id="internal-12409105_12310000"> 
                   <div class="link-content"> 
                    <p> <img src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype" width="16" height="16" title="Bug - A problem which impairs or prevents the functions of the product." alt="Bug - A problem which impairs or prevents the functions of the product."> <span title="DERBY-3961: Deadlock detection fails for InternalTransaction"> <a href="/jira/browse/DERBY-3961" data-issue-key="DERBY-3961" class="issue-link link-title resolution">DERBY-3961</a> <span class="link-summary">Deadlock detection fails for InternalTransaction</span> </span> </p> 
                    <ul class="link-snapshot"> 
                     <li class="priority"> <img src="/jira/images/icons/priorities/major.svg" width="16" height="16" title="Major - Major loss of function." alt="Major - Major loss of function."> </li> 
                     <li class="status"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done aui-lozenge-subtle jira-issue-status-lozenge-max-width-short" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Closed</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.</span>">Closed</span> </li> 
                    </ul> 
                   </div> 
                  </dd> 
                 </dl> 
                 <dl class="links-list "> 
                  <dt title="is related to">
                   is related to
                  </dt> 
                  <dd id="internal-12409105_10030"> 
                   <div class="link-content"> 
                    <p> <img src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype" width="16" height="16" title="Bug - A problem which impairs or prevents the functions of the product." alt="Bug - A problem which impairs or prevents the functions of the product."> <span title="DERBY-3961: Deadlock detection fails for InternalTransaction"> <a href="/jira/browse/DERBY-3961" data-issue-key="DERBY-3961" class="issue-link link-title resolution">DERBY-3961</a> <span class="link-summary">Deadlock detection fails for InternalTransaction</span> </span> </p> 
                    <ul class="link-snapshot"> 
                     <li class="priority"> <img src="/jira/images/icons/priorities/major.svg" width="16" height="16" title="Major - Major loss of function." alt="Major - Major loss of function."> </li> 
                     <li class="status"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done aui-lozenge-subtle jira-issue-status-lozenge-max-width-short" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Closed</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.</span>">Closed</span> </li> 
                    </ul> 
                   </div> 
                  </dd> 
                  <dd id="internal-12427949_10030"> 
                   <div class="link-content"> 
                    <p> <img src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype" width="16" height="16" title="Bug - A problem which impairs or prevents the functions of the product." alt="Bug - A problem which impairs or prevents the functions of the product."> <span title="DERBY-4273: A lock could not be obtained within the time requested error in testBTreeForwardScan_fetchRows_resumeAfterWait_nonUnique_split"> <a href="/jira/browse/DERBY-4273" data-issue-key="DERBY-4273" class="issue-link link-title resolution">DERBY-4273</a> <span class="link-summary">A lock could not be obtained within the time requested error in testBTreeForwardScan_fetchRows_resumeAfterWait_nonUnique_split</span> </span> </p> 
                    <ul class="link-snapshot"> 
                     <li class="priority"> <img src="/jira/images/icons/priorities/major.svg" width="16" height="16" title="Major - Major loss of function." alt="Major - Major loss of function."> </li> 
                     <li class="status"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done aui-lozenge-subtle jira-issue-status-lozenge-max-width-short" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Closed</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.</span>">Closed</span> </li> 
                    </ul> 
                   </div> 
                  </dd> 
                 </dl> 
                </div> 
               </div>
              </div>
              <div id="activitymodule" class="module toggle-wrap">
               <div id="activitymodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Activity</h2>
               </div>
               <div class="mod-content"> 
                <big-pipe data-id="activity-panel-pipe-id" style="height: 70px"> 
                 <div></div> 
                </big-pipe> 
               </div>
              </div>
             </div>
             <div id="viewissuesidebar" class="aui-item issue-side-column">
              <div id="peoplemodule" class="module toggle-wrap">
               <div id="peoplemodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">People</h2>
               </div>
               <div class="mod-content"> 
                <ul class="item-details" id="peopledetails"> 
                 <li class="people-details"> 
                  <dl> 
                   <dt>
                    Assignee:
                   </dt> 
                   <dd> 
                    <span id="assignee-val" class="view-issue-field"> <span class="user-hover" id="issue_summary_assignee_knutanders" rel="knutanders" data-user="{&quot;avatarUrl&quot;:&quot;https://issues.apache.org/jira/secure/useravatar?size=xsmall&amp;avatarId=10452&quot;,&quot;displayName&quot;:&quot;Knut Anders Hatlen&quot;,&quot;emailAddress&quot;:&quot;knut.hatlen@oracle.com&quot;,&quot;username&quot;:&quot;knutanders&quot;}"> <span class="aui-avatar aui-avatar-small"><span class="aui-avatar-inner"><img src="https://issues.apache.org/jira/secure/useravatar?size=small&amp;avatarId=10452" alt="knutanders"></span></span> Knut Anders Hatlen </span> </span> 
                   </dd> 
                  </dl> 
                  <dl> 
                   <dt>
                    Reporter:
                   </dt> 
                   <dd> 
                    <span id="reporter-val" class="view-issue-field"> <span class="user-hover" id="issue_summary_reporter_bcalmac" rel="bcalmac" data-user="{&quot;avatarUrl&quot;:&quot;https://issues.apache.org/jira/secure/useravatar?size=xsmall&amp;avatarId=10452&quot;,&quot;displayName&quot;:&quot;Bogdan Calmac&quot;,&quot;emailAddress&quot;:&quot;bcalmac@gmail.com&quot;,&quot;username&quot;:&quot;bcalmac&quot;}"> <span class="aui-avatar aui-avatar-small"><span class="aui-avatar-inner"><img src="https://issues.apache.org/jira/secure/useravatar?size=small&amp;avatarId=10452" alt="bcalmac"></span></span> Bogdan Calmac </span> </span> 
                   </dd> 
                  </dl> </li> 
                </ul> 
                <ul class="item-details"> 
                 <li> 
                  <dl> 
                   <dt>
                    Votes:
                   </dt> 
                   <dd> 
                    <span id="vote-data" class="aui-badge vote-state-off">13</span> 
                    <span id="vote-label" title="You have to be logged in to vote for an issue.">Vote for this issue</span> 
                   </dd> 
                  </dl> 
                  <dl> 
                   <dt>
                    Watchers:
                   </dt> 
                   <dd> 
                    <span id="watcher-data" class="aui-badge watch-state-off">9</span> 
                    <span id="watch-label" title="You have to be logged in to watch an issue.">Start watching this issue</span> 
                   </dd> 
                  </dl> </li> 
                </ul> 
               </div>
              </div>
              <div id="datesmodule" class="module toggle-wrap">
               <div id="datesmodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Dates</h2>
               </div>
               <div class="mod-content"> 
                <ul class="item-details"> 
                 <li> 
                  <dl class="dates"> 
                   <dt>
                    Created:
                   </dt> 
                   <dd class="date user-tz" title="03/Aug/07 04:09"> 
                    <span data-name="Created" id="created-val" data-fieldtype="datetime"> <time class="livestamp" datetime="2007-08-03T04:09:28+0000">03/Aug/07 04:09</time> </span> 
                   </dd> 
                  </dl> 
                  <dl class="dates"> 
                   <dt>
                    Updated:
                   </dt> 
                   <dd class="date user-tz" title="02/May/13 02:29"> 
                    <span data-name="Updated" id="updated-val" data-fieldtype="datetime"> <time class="livestamp" datetime="2013-05-02T02:29:19+0000">02/May/13 02:29</time> </span> 
                   </dd> 
                  </dl> 
                  <dl class="dates"> 
                   <dt>
                    Resolved:
                   </dt> 
                   <dd class="date user-tz" title="18/Mar/09 16:32"> 
                    <span data-name="Resolved" id="resolutiondate-val" data-fieldtype="datetime"> <time class="livestamp" datetime="2009-03-18T16:32:00+0000">18/Mar/09 16:32</time> </span> 
                   </dd> 
                  </dl> </li> 
                </ul> 
               </div>
              </div>
             </div>
            </div>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div>
     <!-- .aui-page-panel-inner -->
    </div>
    <!-- .aui-page-panel -->
    <div class="issue-navigator-init"></div> 
   </section> 
   <footer id="footer" role="contentinfo"> 
    <section class="footer-body"> 
     <ul class="atlassian-footer"> 
      <li> Atlassian JIRA <a class="seo-link" rel="nofollow" href="https://www.atlassian.com/software/jira">Project Management Software</a> <span id="footer-build-information">(v7.6.3#76005-<span title="8a4e38d34af948780dbf52044e7aafb13a7cae58" data-commit-id="8a4e38d34af948780dbf52044e7aafb13a7cae58}">sha1:8a4e38d</span>)</span> </li> 
      <li> <a id="about-link" rel="nofollow" href="/jira/secure/AboutPage.jspa/secure/AboutPage.jspa">About JIRA</a> </li> 
      <li> <a id="footer-report-problem-link" rel="nofollow" href="/jira/secure/CreateIssue!default.jspa">Report a problem</a> </li> 
     </ul> 
     <ul class="atlassian-footer"> 
      <li class="licensemessage"> Powered by a free Atlassian <a rel="nofollow" href="http://www.atlassian.com/software/jira">JIRA</a> open source license for Apache Software Foundation. Try JIRA - <a rel="nofollow" href="http://www.atlassian.com/software/jira">bug tracking software</a> for <i>your</i> team. </li> 
     </ul> 
     <div id="footer-logo">
      <a rel="nofollow" href="http://www.atlassian.com/">Atlassian</a>
     </div> 
    </section> 
    <fieldset class="hidden parameters"> 
     <input type="hidden" title="loggedInUser" value=""> 
     <input type="hidden" title="ajaxTimeout" value="The call to the JIRA server did not complete within the timeout period.  We are unsure of the result of this operation."> 
     <input type="hidden" title="JiraVersion" value="7.6.3"> 
     <input type="hidden" title="ajaxUnauthorised" value="You are not authorised to perform this operation. Please log in."> 
     <input type="hidden" title="baseURL" value="https://issues.apache.org/jira"> 
     <input type="hidden" title="ajaxCommsError" value="The JIRA server could not be contacted. This may be a temporary glitch or the server may be down. "> 
     <input type="hidden" title="ajaxServerError" value="The JIRA server was contacted but has returned an error response. We are unsure of the result of this operation."> 
     <input type="hidden" title="ajaxErrorCloseDialog" value="Close this dialog and press refresh in your browser"> 
     <input type="hidden" title="ajaxErrorDialogHeading" value="Communications Breakdown"> 
     <input type="hidden" title="dirtyMessage" value="You have entered new data on this page. If you navigate away from this page without first saving your data, the changes will be lost."> 
     <input type="hidden" title="dirtyDialogMessage" value="You have entered new data in this dialog. If you navigate away from this dialog without first saving your data, the changes will be lost. Click cancel to return to the dialog."> 
     <input type="hidden" title="keyType" value="Type"> 
     <input type="hidden" title="keyThen" value="then"> 
     <input type="hidden" title="dblClickToExpand" value="Double click to expand"> 
     <input type="hidden" title="actions" value="Actions"> 
     <input type="hidden" title="removeItem" value="Remove"> 
     <input type="hidden" title="workflow" value="Workflow"> 
     <input type="hidden" title="labelNew" value="New Label"> 
     <input type="hidden" title="issueActionsHint" value="Begin typing for available operations or press down to see all"> 
     <input type="hidden" title="closelink" value="Close"> 
     <input type="hidden" title="dotOperations" value="Operations"> 
     <input type="hidden" title="dotLoading" value="Loading..."> 
     <input type="hidden" title="frotherSuggestions" value="Suggestions"> 
     <input type="hidden" title="frotherNomatches" value="No Matches"> 
     <input type="hidden" title="multiselectVersionsError" value="{0} is not a valid version."> 
     <input type="hidden" title="multiselectComponentsError" value="{0} is not a valid component."> 
     <input type="hidden" title="multiselectGenericError" value="The value {0} is invalid."> 
    </fieldset> 
   </footer> 
  </div> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:bigpipe-js/jira.webresources:bigpipe-js.js" data-wrm-key="jira.webresources:bigpipe-js" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["activity-panel-pipe-id"]="\"\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n    \u003cdiv class=\\\"tabwrap tabs2\\\"\u003e\\n\\n        \u003cul id=\\\"issue-tabs\\\" class=\\\"tabs horizontal\\\"\u003e\\n                                \\n            \u003cli  data-id=\\\"all-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel\\\" data-label=\\\"All\\\" data-href=\\\"\\/jira\\/browse\\/DERBY-2991?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"all-tabpanel\\\" href=\\\"\\/jira\\/browse\\/DERBY-2991?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel\\\"\u003e\u003cstrong\u003eAll\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  class=\\\"active\\\" id=\\\"comment-tabpanel\\\"  data-id=\\\"comment-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel\\\" data-label=\\\"Comments\\\" data-href=\\\"\\/jira\\/browse\\/DERBY-2991?page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel\\\"\u003e\\n                            \u003cstrong tabindex=\\\"0\\\"\u003eComments\u003c\\/strong\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"worklog-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:worklog-tabpanel\\\" data-label=\\\"Work Log\\\" data-href=\\\"\\/jira\\/browse\\/DERBY-2991?page=com.atlassian.jira.plugin.system.issuetabpanels:worklog-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"worklog-tabpanel\\\" href=\\\"\\/jira\\/browse\\/DERBY-2991?page=com.atlassian.jira.plugin.system.issuetabpanels:worklog-tabpanel\\\"\u003e\u003cstrong\u003eWork Log\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"changehistory-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:changehistory-tabpanel\\\" data-label=\\\"History\\\" data-href=\\\"\\/jira\\/browse\\/DERBY-2991?page=com.atlassian.jira.plugin.system.issuetabpanels:changehistory-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"changehistory-tabpanel\\\" href=\\\"\\/jira\\/browse\\/DERBY-2991?page=com.atlassian.jira.plugin.system.issuetabpanels:changehistory-tabpanel\\\"\u003e\u003cstrong\u003eHistory\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"activity-stream-issue-tab\\\" data-key=\\\"com.atlassian.streams.streams-jira-plugin:activity-stream-issue-tab\\\" data-label=\\\"Activity\\\" data-href=\\\"\\/jira\\/browse\\/DERBY-2991?page=com.atlassian.streams.streams-jira-plugin:activity-stream-issue-tab\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"activity-stream-issue-tab\\\" href=\\\"\\/jira\\/browse\\/DERBY-2991?page=com.atlassian.streams.streams-jira-plugin:activity-stream-issue-tab\\\"\u003e\u003cstrong\u003eActivity\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"transitions-summary-tabpanel\\\" data-key=\\\"com.googlecode.jira-suite-utilities:transitions-summary-tabpanel\\\" data-label=\\\"Transitions\\\" data-href=\\\"\\/jira\\/browse\\/DERBY-2991?page=com.googlecode.jira-suite-utilities:transitions-summary-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"transitions-summary-tabpanel\\\" href=\\\"\\/jira\\/browse\\/DERBY-2991?page=com.googlecode.jira-suite-utilities:transitions-summary-tabpanel\\\"\u003e\u003cstrong\u003eTransitions\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                \u003c\\/ul\u003e\\n\\n                    \u003cdiv class=\\\"sortwrap\\\"\u003e\\n                                    \u003ca class=\\\"issue-activity-sort-link ajax-activity-content\\\" rel=\\\"nofollow\\\" data-tab-sort data-order=\\\"desc\\\" href=\\\"\\/jira\\/browse\\/DERBY-2991?actionOrder=desc\\\" title=\\\"Ascending order - Click to sort in descending order\\\"\u003e\\n                        \u003cspan class=\\\"aui-icon aui-icon-small aui-iconfont-up\\\"\u003eAscending order - Click to sort in descending order\u003c\\/span\u003e\\n                    \u003c\\/a\u003e\\n                            \u003c\\/div\u003e\\n            \u003c\\/div\u003e\\n    \u003cdiv class=\\\"issuePanelWrapper\\\"\u003e\\n        \u003cdiv class=\\\"issuePanelProgress\\\"\u003e\u003c\\/div\u003e\\n        \u003cdiv class=\\\"issuePanelContainer\\\" id=\\\"issue_actions_container\\\"\u003e\\n                                    \\n\\n\\n\u003cdiv id=\\\"comment-12517433\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12517433&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12517433\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bcalmac\\\" id=\\\"commentauthor_12517433_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bcalmac\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bcalmac\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bogdan Calmac\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12517433_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Aug\\/07 04:11\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-03T04:11:07+0000\'\u003e03\\/Aug\\/07 04:11\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThe test demonstrationg the deadlock\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bcalmac\\\" id=\\\"commentauthor_12517433_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bcalmac\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bcalmac\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bogdan Calmac\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12517433_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Aug\\/07 04:11\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-03T04:11:07+0000\'\u003e03\\/Aug\\/07 04:11\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    The test demonstrationg the deadlock              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12517434\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12517434&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12517434\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bcalmac\\\" id=\\\"commentauthor_12517434_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bcalmac\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bcalmac\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bogdan Calmac\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12517434_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Aug\\/07 04:11\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-03T04:11:56+0000\'\u003e03\\/Aug\\/07 04:11\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThe deadlock trace\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bcalmac\\\" id=\\\"commentauthor_12517434_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bcalmac\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bcalmac\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bogdan Calmac\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12517434_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Aug\\/07 04:11\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-03T04:11:56+0000\'\u003e03\\/Aug\\/07 04:11\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    The deadlock trace              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12517435\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12517435&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12517435\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bcalmac\\\" id=\\\"commentauthor_12517435_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bcalmac\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bcalmac\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bogdan Calmac\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12517435_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Aug\\/07 04:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-03T04:12:52+0000\'\u003e03\\/Aug\\/07 04:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThe stacktrace before deadlock indicating an index split\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bcalmac\\\" id=\\\"commentauthor_12517435_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bcalmac\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bcalmac\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bogdan Calmac\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12517435_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Aug\\/07 04:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-03T04:12:52+0000\'\u003e03\\/Aug\\/07 04:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    The stacktrace before deadlock indicating an index split              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12517516\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12517516&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12517516\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"johnemb\\\" id=\\\"commentauthor_12517516_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=johnemb\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"johnemb\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e John H. Embretsen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12517516_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Aug\\/07 12:34\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-03T12:34:53+0000\'\u003e03\\/Aug\\/07 12:34\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThis is an interesting case which reminds me (but is different from) a deadlock issue I encountered in a long-running test not so long ago. I was not able to reproduce the deadlock, but we suspect that there may be a bug in the code that creates the deadlock message about the lock cycles, see \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-2877\\\" title=\\\"Print the entire lock list when a deadlock occurs and deadlock tracing is on\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-2877\\\"\u003e\u003cdel\u003eDERBY-2877\u003c\\/del\u003e\u003c\\/a\u003e for details.\u003c\\/p\u003e\\n\\n\u003cp\u003eThis test (InsertSelectDeadlock.java) is interesting because you get a lock timeout message rather than a deadlock message (even if you add a deadlockTimeout property with a lower value than the waitTimeout property - I\'ve tried), although in practice this is a deadlock. \u003c\\/p\u003e\\n\\n\u003cp\u003eAlso, even if derby.language.logStatementText is set to true (I edited the test class to do that), you don\'t get any more information about the offending statement which (presumably) holds an exclusive lock on the index root (1,1).\u003c\\/p\u003e\\n\\n\u003cp\u003eHere\'s the relevant information extracted from the derby.log Bogdan attached:\u003c\\/p\u003e\\n\\n\u003cp\u003eXID       |TYPE         |MODE|LOCKCOUNT|LOCKNAME|STATE|INDEXNAME          |\u003cbr\\/\u003e\\n---------------------------------------------------------------------------\u003c\\/p\u003e\\n\u003cul\u003e\\n\\t\u003cli\u003e\\n\\t\u003cul\u003e\\n\\t\\t\u003cli\u003e\\n\\t\\t\u003cul\u003e\\n\\t\\t\\t\u003cli\u003eThe following row is the victim ***\u003cbr\\/\u003e\\n279       |ROW          |S   |0        |(1,7)   |WAIT |NULL               |\u003c\\/li\u003e\\n\\t\\t\\t\u003cli\u003eThe above row is the victim ***\u003cbr\\/\u003e\\n269       |ROW          |X   |1        |(1,7)   |GRANT|NULL               |\u003cbr\\/\u003e\\n282       |ROW          |X   |0        |(1,1)   |WAIT |SQL070802115706620 |\u003cbr\\/\u003e\\n279       |ROW          |S   |1        |(1,1)   |GRANT|SQL070802115706620 |\u003c\\/li\u003e\\n\\t\\t\u003c\\/ul\u003e\\n\\t\\t\u003c\\/li\u003e\\n\\t\u003c\\/ul\u003e\\n\\t\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003e(I excluded things like tabletype (always T) and tablename (always TRACK_EVENT)).\u003c\\/p\u003e\\n\\n\u003cp\u003eThe transactions above are probably:\u003c\\/p\u003e\\n\\n\u003cp\u003eXID 279: select * from TRACK_EVENT where ID &gt; ?\u003cbr\\/\u003e\\nXID 269: insert into TRACK_EVENT values (?,?,?,?,?,?,?,?,?,?,?,?,?,?)\u003cbr\\/\u003e\\nXID 282: \u003cspan class=\\\"error\\\"\u003e&#91;index btree split?&#93;\u003c\\/span\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eWe are assuming (based on the stack traces) that XID 269 has spawned another transaction, XID 282, which is trying to modify the index, but is not allowed to because XID 279 is already holding an S (Shared) lock on it. I guess derby does not recognize this as a deadlock because the index-modifying transaction has a completely different transaction number. So, in systems that don\'t have deadlockTrace enabled, deadlocks may be camouflaged as lock wait timeouts.\u003c\\/p\u003e\\n\\n\u003cp\u003eI was kind of hoping that this comment would help so that more people could understand these issues, hence increasing the chances of getting them fixed (or, at the least, improving related documentation). I\'m sorry for not being able to work out a solution or provide answers to Bogdan\'s questions at this point, but I\'m hoping someone else will be assisting soon.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"johnemb\\\" id=\\\"commentauthor_12517516_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=johnemb\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"johnemb\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e John H. Embretsen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12517516_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Aug\\/07 12:34\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-03T12:34:53+0000\'\u003e03\\/Aug\\/07 12:34\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    This is an interesting case which reminds me (but is different from) a deadlock issue I encountered in a long-running test not so long ago. I was not able to reproduce the deadlock, but we suspect that there may be a bug in the code that creates the deadlock message about the lock cycles, see   DERBY-2877   for details. \\n\\n This test (InsertSelectDeadlock.java) is interesting because you get a lock timeout message rather than a deadlock message (even if you add a deadlockTimeout property with a lower value than the waitTimeout property - I\'ve tried), although in practice this is a deadlock.  \\n\\n Also, even if derby.language.logStatementText is set to true (I edited the test class to do that), you don\'t get any more information about the offending statement which (presumably) holds an exclusive lock on the index root (1,1). \\n\\n Here\'s the relevant information extracted from the derby.log Bogdan attached: \\n\\n XID       |TYPE         |MODE|LOCKCOUNT|LOCKNAME|STATE|INDEXNAME          | \\n--------------------------------------------------------------------------- \\n \\n\\t \\n\\t \\n\\t\\t \\n\\t\\t \\n\\t\\t\\t The following row is the victim *** \\n279       |ROW          |S   |0        |(1,7)   |WAIT |NULL               | \\n\\t\\t\\t The above row is the victim *** \\n269       |ROW          |X   |1        |(1,7)   |GRANT|NULL               | \\n282       |ROW          |X   |0        |(1,1)   |WAIT |SQL070802115706620 | \\n279       |ROW          |S   |1        |(1,1)   |GRANT|SQL070802115706620 | \\n\\t\\t \\n\\t\\t \\n\\t \\n\\t \\n \\n\\n\\n (I excluded things like tabletype (always T) and tablename (always TRACK_EVENT)). \\n\\n The transactions above are probably: \\n\\n XID 279: select * from TRACK_EVENT where ID &gt; ? \\nXID 269: insert into TRACK_EVENT values (?,?,?,?,?,?,?,?,?,?,?,?,?,?) \\nXID 282:  &#91;index btree split?&#93;  \\n\\n We are assuming (based on the stack traces) that XID 269 has spawned another transaction, XID 282, which is trying to modify the index, but is not allowed to because XID 279 is already holding an S (Shared) lock on it. I guess derby does not recognize this as a deadlock because the index-modifying transaction has a completely different transaction number. So, in systems that don\'t have deadlockTrace enabled, deadlocks may be camouflaged as lock wait timeouts. \\n\\n I was kind of hoping that this comment would help so that more people could understand these issues, hence increasing the chances of getting them fixed (or, at the least, improving related documentation). I\'m sorry for not being able to work out a solution or provide answers to Bogdan\'s questions at this point, but I\'m hoping someone else will be assisting soon.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12520535\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12520535&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12520535\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12520535_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12520535_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Aug\\/07 12:39\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-17T12:39:07+0000\'\u003e17\\/Aug\\/07 12:39\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e&gt; - Trying to break the circular locking above, I would first question\u003cbr\\/\u003e\\n&gt;   why does the select transaction need to acquire (and hold) a lock\u003cbr\\/\u003e\\n&gt;   on the root block of the index.\u003c\\/p\u003e\\n\\n\u003cp\u003eB-tree scans lock the leaf node on which they are currently positioned\u003cbr\\/\u003e\\n(in your case the root node is probably also a leaf node) so that they\u003cbr\\/\u003e\\ndon\'t have to reposition if they lose the latch on the page. The scan\u003cbr\\/\u003e\\nalways releases the latch on the B-tree leaf if it has to wait for a\u003cbr\\/\u003e\\nrow lock. The latch is released in order to prevent deadlocks. Since\u003cbr\\/\u003e\\nthe page is not latched while the scan waits for the row lock, the row\u003cbr\\/\u003e\\nmight have moved to another page in the index and therefore the scan\u003cbr\\/\u003e\\nwould have to start a new search to reposition on the row. The shared\u003cbr\\/\u003e\\nlock on the B-tree leaf ensures that the row is not moved off the\u003cbr\\/\u003e\\ncurrent page so that the repositioning isn\'t needed. Since the lock on\u003cbr\\/\u003e\\nthe leaf node is shared, it allows more concurrency than if the\u003cbr\\/\u003e\\n(exclusive) latch were kept. But since the lock on the leaf is more or\u003cbr\\/\u003e\\nless like a shared latch, there\'s still a possibility for deadlocks if\u003cbr\\/\u003e\\nthe B-tree needs to be restructured (like the split deadlock you\'re\u003cbr\\/\u003e\\nseeing).\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; Would it be possible to ensure the consistency of the select without\u003cbr\\/\u003e\\n&gt; locking the index?\u003c\\/p\u003e\\n\\n\u003cp\u003eI think so, if the select transaction had a way to reposition the scan\u003cbr\\/\u003e\\nafter it got the row lock it was waiting for. The current code just\u003cbr\\/\u003e\\nchecks the leaf page again to find the row, since it knows it can\'t\u003cbr\\/\u003e\\nhave moved to another page. If there weren\'t a lock on the index page,\u003cbr\\/\u003e\\nthe scan would need to detect that the row had moved and start a new\u003cbr\\/\u003e\\nsearch from the root node.\u003c\\/p\u003e\\n\\n\u003cp\u003eI don\'t know enough about this area of the code to say whether or not\u003cbr\\/\u003e\\nit is doable, or how much work it is. Hopefully, someone more\u003cbr\\/\u003e\\nknowledgeable will chime in with more details.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12520535_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12520535_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Aug\\/07 12:39\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-17T12:39:07+0000\'\u003e17\\/Aug\\/07 12:39\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    &gt; - Trying to break the circular locking above, I would first question \\n&gt;   why does the select transaction need to acquire (and hold) a lock \\n&gt;   on the root block of the index. \\n\\n B-tree scans lock the leaf node on which they are currently positioned \\n(in your case the root node is probably also a leaf node) so that they \\ndon\'t have to reposition if they lose the latch on the page. The scan \\nalways releases the latch on the B-tree leaf if it has to wait for a \\nrow lock. The latch is released in order to prevent deadlocks. Since \\nthe page is not latched while the scan waits for the row lock, the row \\nmight have moved to another page in the index and therefore the scan \\nwould have to start a new search to reposition on the row. The shared \\nlock on the B-tree leaf ensures that the row is not moved off the \\ncurrent page so that the repositioning isn\'t needed. Since the lock on \\nthe leaf node is shared, it allows more concurrency than if the \\n(exclusive) latch were kept. But since the lock on the leaf is more or \\nless like a shared latch, there\'s still a possibility for deadlocks if \\nthe B-tree needs to be restructured (like the split deadlock you\'re \\nseeing). \\n\\n &gt; Would it be possible to ensure the consistency of the select without \\n&gt; locking the index? \\n\\n I think so, if the select transaction had a way to reposition the scan \\nafter it got the row lock it was waiting for. The current code just \\nchecks the leaf page again to find the row, since it knows it can\'t \\nhave moved to another page. If there weren\'t a lock on the index page, \\nthe scan would need to detect that the row had moved and start a new \\nsearch from the root node. \\n\\n I don\'t know enough about this area of the code to say whether or not \\nit is doable, or how much work it is. Hopefully, someone more \\nknowledgeable will chime in with more details.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12520891\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12520891&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12520891\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"kurti\\\" id=\\\"commentauthor_12520891_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=kurti\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"kurti\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Kurt Huwig\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12520891_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Aug\\/07 20:21\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-18T20:21:35+0000\'\u003e18\\/Aug\\/07 20:21\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHappens with 10.3.1.4 as well\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"kurti\\\" id=\\\"commentauthor_12520891_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=kurti\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"kurti\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Kurt Huwig\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12520891_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Aug\\/07 20:21\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-18T20:21:35+0000\'\u003e18\\/Aug\\/07 20:21\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Happens with 10.3.1.4 as well              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12520892\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12520892&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12520892\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"kurti\\\" id=\\\"commentauthor_12520892_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=kurti\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"kurti\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Kurt Huwig\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12520892_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Aug\\/07 20:23\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-18T20:23:46+0000\'\u003e18\\/Aug\\/07 20:23\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eSimplified testcase with only one column.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"kurti\\\" id=\\\"commentauthor_12520892_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=kurti\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"kurti\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Kurt Huwig\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12520892_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Aug\\/07 20:23\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-18T20:23:46+0000\'\u003e18\\/Aug\\/07 20:23\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Simplified testcase with only one column.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12520894\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12520894&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12520894\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"kurti\\\" id=\\\"commentauthor_12520894_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=kurti\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"kurti\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Kurt Huwig\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12520894_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Aug\\/07 20:24\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-18T20:24:45+0000\'\u003e18\\/Aug\\/07 20:24\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI\'ve got the same problem nearly every day in my application, therefore I simplified the example file from the mailinglist. I did also try it with MySQL without a deadlock.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"kurti\\\" id=\\\"commentauthor_12520894_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=kurti\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"kurti\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Kurt Huwig\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12520894_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Aug\\/07 20:24\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-18T20:24:45+0000\'\u003e18\\/Aug\\/07 20:24\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I\'ve got the same problem nearly every day in my application, therefore I simplified the example file from the mailinglist. I did also try it with MySQL without a deadlock.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12523844\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12523844&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12523844\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"johnemb\\\" id=\\\"commentauthor_12523844_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=johnemb\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"johnemb\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e John H. Embretsen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12523844_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Aug\\/07 12:38\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-30T12:38:53+0000\'\u003e30\\/Aug\\/07 12:38\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eRelated mailing list threads on derby-user, primo August 2007:\u003c\\/p\u003e\\n\\n\u003cp\u003e\u003ca href=\\\"http:\\/\\/www.nabble.com\\/lock-escalation-and-deadlocks-t4197785.html\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttp:\\/\\/www.nabble.com\\/lock-escalation-and-deadlocks-t4197785.html\u003c\\/a\u003e\u003cbr\\/\u003e\\n\u003ca href=\\\"http:\\/\\/www.nabble.com\\/Concurrent-select-and-insert-deadlock-on-index-t4204088.html\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttp:\\/\\/www.nabble.com\\/Concurrent-select-and-insert-deadlock-on-index-t4204088.html\u003c\\/a\u003e\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"johnemb\\\" id=\\\"commentauthor_12523844_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=johnemb\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"johnemb\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e John H. Embretsen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12523844_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Aug\\/07 12:38\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-30T12:38:53+0000\'\u003e30\\/Aug\\/07 12:38\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Related mailing list threads on derby-user, primo August 2007: \\n\\n  http:\\/\\/www.nabble.com\\/lock-escalation-and-deadlocks-t4197785.html  \\n http:\\/\\/www.nabble.com\\/Concurrent-select-and-insert-deadlock-on-index-t4204088.html               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12523850\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12523850&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12523850\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bcalmac\\\" id=\\\"commentauthor_12523850_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bcalmac\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bcalmac\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bogdan Calmac\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12523850_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Aug\\/07 13:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-30T13:49:42+0000\'\u003e30\\/Aug\\/07 13:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThe first thread (\u003ca href=\\\"http:\\/\\/www.nabble.com\\/lock-escalation-and-deadlocks-t4197785.html\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttp:\\/\\/www.nabble.com\\/lock-escalation-and-deadlocks-t4197785.html\u003c\\/a\u003e ) is just my wrong interpretation of the cause, so can be discarded.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bcalmac\\\" id=\\\"commentauthor_12523850_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bcalmac\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bcalmac\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bogdan Calmac\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12523850_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Aug\\/07 13:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-30T13:49:42+0000\'\u003e30\\/Aug\\/07 13:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    The first thread ( http:\\/\\/www.nabble.com\\/lock-escalation-and-deadlocks-t4197785.html  ) is just my wrong interpretation of the cause, so can be discarded.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12542746\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12542746&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12542746\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"naka\\\" id=\\\"commentauthor_12542746_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=naka\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"naka\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tomohito Nakayama\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542746_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Nov\\/07 12:05\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-15T12:05:11+0000\'\u003e15\\/Nov\\/07 12:05\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Tomohito Nakayama - 15\\/Nov\\/07 12:07\\\"\u003eedited\u003c\\/span\u003e \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHello.\u003c\\/p\u003e\\n\\n\u003cp\u003eReading the code of Repro program, \u003cbr\\/\u003e\\nI found the situation that insert thread inserts \u003cb\u003emultiple rows\u003c\\/b\u003e in a transaction for times \u003cbr\\/\u003e\\nwhile select thread selects \u003cb\u003erows in a range condition\u003c\\/b\u003e results in scanning index for same table.\u003c\\/p\u003e\\n\\n\u003cp\u003eI think the problem is that\u003cbr\\/\u003e\\ninserting multiple row in a transaction make multiple locks for data rows and index rows ,\u003cbr\\/\u003e\\nand then, \u003cbr\\/\u003e\\nthose locks causes deadlock between selecting same table,\u003cbr\\/\u003e\\nbecause operation of selecting rows for range condition also needs locks for data rows and index rows in scanned range.\u003c\\/p\u003e\\n\\n\\n\u003cp\u003eI think there exists two ways to walk around for this situation.\u003c\\/p\u003e\\n\\n\u003cp\u003e1:\u003cbr\\/\u003e\\nDo not insert multiple rows in a transaction, \u003cbr\\/\u003e\\nwhen selecting rows of same table in a range condition simultaneously, \u003cbr\\/\u003e\\nas the Repro program.\u003cbr\\/\u003e\\nI tried changing tracksPerBatch as 1 and \u003cbr\\/\u003e\\nthe deadlock problem of Repro program was resolved.\u003c\\/p\u003e\\n\\n\u003cp\u003e2:\u003cbr\\/\u003e\\nLoosen transaction isolation level.\u003cbr\\/\u003e\\nI tried conn.setTransactionIsolation( Connection.TRANSACTION_READ_UNCOMMITTED ) and \u003cbr\\/\u003e\\nthe deadlock problem of Repro program was resolved.\u003c\\/p\u003e\\n\\n\\n\u003cp\u003eI\'m not sure those walk around is suitable for your case, \u003cbr\\/\u003e\\nbut I hope it helps you.\u003c\\/p\u003e\\n\\n\\n\u003cp\u003eI also think feature like hint for sql may be helpful in those case.\u003cbr\\/\u003e\\nIf we can suppress the use of index for select operation with hint, \u003cbr\\/\u003e\\nwe could also escape the problem using that feature.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"naka\\\" id=\\\"commentauthor_12542746_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=naka\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"naka\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tomohito Nakayama\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542746_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Nov\\/07 12:05\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-15T12:05:11+0000\'\u003e15\\/Nov\\/07 12:05\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Tomohito Nakayama - 15\\/Nov\\/07 12:07\\\"\u003eedited\u003c\\/span\u003e                   Hello. \\n\\n Reading the code of Repro program,  \\nI found the situation that insert thread inserts  multiple rows  in a transaction for times  \\nwhile select thread selects  rows in a range condition  results in scanning index for same table. \\n\\n I think the problem is that \\ninserting multiple row in a transaction make multiple locks for data rows and index rows , \\nand then,  \\nthose locks causes deadlock between selecting same table, \\nbecause operation of selecting rows for range condition also needs locks for data rows and index rows in scanned range. \\n\\n\\n I think there exists two ways to walk around for this situation. \\n\\n 1: \\nDo not insert multiple rows in a transaction,  \\nwhen selecting rows of same table in a range condition simultaneously,  \\nas the Repro program. \\nI tried changing tracksPerBatch as 1 and  \\nthe deadlock problem of Repro program was resolved. \\n\\n 2: \\nLoosen transaction isolation level. \\nI tried conn.setTransactionIsolation( Connection.TRANSACTION_READ_UNCOMMITTED ) and  \\nthe deadlock problem of Repro program was resolved. \\n\\n\\n I\'m not sure those walk around is suitable for your case,  \\nbut I hope it helps you. \\n\\n\\n I also think feature like hint for sql may be helpful in those case. \\nIf we can suppress the use of index for select operation with hint,  \\nwe could also escape the problem using that feature.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12542750\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12542750&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12542750\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"kurti\\\" id=\\\"commentauthor_12542750_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=kurti\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"kurti\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Kurt Huwig\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542750_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Nov\\/07 12:24\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-15T12:24:12+0000\'\u003e15\\/Nov\\/07 12:24\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI Tomohito,\u003c\\/p\u003e\\n\\n\u003cp\u003ein my application, every insert is done on its own and the isolation is set to READ_UNCOMMITTED. Still the very same deadlock happens, although it needs several days and thousands of inserts and selects to manifest.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe main difference of my application is, that the database is embedded, but accessed embedded and via the network. Do you think it would solve the problems if I\'d only use the network access? Or does there is no difference?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"kurti\\\" id=\\\"commentauthor_12542750_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=kurti\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"kurti\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Kurt Huwig\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542750_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Nov\\/07 12:24\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-15T12:24:12+0000\'\u003e15\\/Nov\\/07 12:24\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I Tomohito, \\n\\n in my application, every insert is done on its own and the isolation is set to READ_UNCOMMITTED. Still the very same deadlock happens, although it needs several days and thousands of inserts and selects to manifest. \\n\\n The main difference of my application is, that the database is embedded, but accessed embedded and via the network. Do you think it would solve the problems if I\'d only use the network access? Or does there is no difference?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12542757\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12542757&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12542757\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"naka\\\" id=\\\"commentauthor_12542757_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=naka\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"naka\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tomohito Nakayama\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542757_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Nov\\/07 12:37\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-15T12:37:53+0000\'\u003e15\\/Nov\\/07 12:37\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eWell ....\u003cbr\\/\u003e\\nI set transaction isolation level of both select and insert operations to TRANSACTION_READ_UNCOMMITTED.\u003cbr\\/\u003e\\nIn that situation, I didn\'t see dead lock problem.\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'m not sure your situation exactly other than uploaded program...\u003c\\/p\u003e\\n\\n\u003cp\u003eI don\'t think your problem have something to do with embedded or network server\\/client,\u003cbr\\/\u003e\\nthough I don\'t think using embedded mode via network file sharing system is good practice ....\u003c\\/p\u003e\\n\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"naka\\\" id=\\\"commentauthor_12542757_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=naka\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"naka\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tomohito Nakayama\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542757_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Nov\\/07 12:37\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-15T12:37:53+0000\'\u003e15\\/Nov\\/07 12:37\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Well .... \\nI set transaction isolation level of both select and insert operations to TRANSACTION_READ_UNCOMMITTED. \\nIn that situation, I didn\'t see dead lock problem. \\n\\n I\'m not sure your situation exactly other than uploaded program... \\n\\n I don\'t think your problem have something to do with embedded or network server\\/client, \\nthough I don\'t think using embedded mode via network file sharing system is good practice .... \\n\\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12542769\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12542769&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12542769\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"kristwaa\\\" id=\\\"commentauthor_12542769_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=kristwaa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"kristwaa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Kristian Waagan\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542769_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Nov\\/07 13:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-15T13:16:30+0000\'\u003e15\\/Nov\\/07 13:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAs a data point for Kurts last comment\\/question, I don\'t think accessing the database using only the client driver matters either.\u003cbr\\/\u003e\\nI do sometimes see the deadlock in an application where all clients are using the client driver.\u003cbr\\/\u003e\\nIn this application only one row is inserted per transaction as well, but in addition there is a multi-row select and a single-row delete.\u003c\\/p\u003e\\n\\n\u003cp\u003eIn my case I was able to tune other parts of the application to work around the problem, but I am unable to tell exactly what caused the problem.\u003cbr\\/\u003e\\nFor your information, it is running with READ_COMMITTED (or REPEATABLE_READ), the load could be said to be medium+ and the table itself is normally pretty small (less than 1000 rows, can be down to a few hundreds).\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"kristwaa\\\" id=\\\"commentauthor_12542769_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=kristwaa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"kristwaa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Kristian Waagan\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542769_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Nov\\/07 13:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-15T13:16:30+0000\'\u003e15\\/Nov\\/07 13:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    As a data point for Kurts last comment\\/question, I don\'t think accessing the database using only the client driver matters either. \\nI do sometimes see the deadlock in an application where all clients are using the client driver. \\nIn this application only one row is inserted per transaction as well, but in addition there is a multi-row select and a single-row delete. \\n\\n In my case I was able to tune other parts of the application to work around the problem, but I am unable to tell exactly what caused the problem. \\nFor your information, it is running with READ_COMMITTED (or REPEATABLE_READ), the load could be said to be medium+ and the table itself is normally pretty small (less than 1000 rows, can be down to a few hundreds).              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12542781\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12542781&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12542781\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"naka\\\" id=\\\"commentauthor_12542781_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=naka\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"naka\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tomohito Nakayama\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542781_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Nov\\/07 13:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-15T13:50:54+0000\'\u003e15\\/Nov\\/07 13:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eMy recognition for this issue is that \u003cbr\\/\u003e\\nDerby uses locks for table and index as a way to realize isolation of transaction and\u003cbr\\/\u003e\\ncares needs to be taken for those locks.\u003c\\/p\u003e\\n\\n\u003cp\u003eI found information around lock for index at next url.\u003cbr\\/\u003e\\n\u003ca href=\\\"http:\\/\\/db.apache.org\\/derby\\/papers\\/btree_package.html\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttp:\\/\\/db.apache.org\\/derby\\/papers\\/btree_package.html\u003c\\/a\u003e\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"naka\\\" id=\\\"commentauthor_12542781_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=naka\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"naka\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tomohito Nakayama\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542781_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Nov\\/07 13:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-15T13:50:54+0000\'\u003e15\\/Nov\\/07 13:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    My recognition for this issue is that  \\nDerby uses locks for table and index as a way to realize isolation of transaction and \\ncares needs to be taken for those locks. \\n\\n I found information around lock for index at next url. \\n http:\\/\\/db.apache.org\\/derby\\/papers\\/btree_package.html               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12542953\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12542953&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12542953\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"oysteing\\\" id=\\\"commentauthor_12542953_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=oysteing\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"oysteing\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e \\u00D8ystein Gr\\u00F8vlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542953_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Nov\\/07 04:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-16T04:53:03+0000\'\u003e16\\/Nov\\/07 04:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eSee the analysis made by Knut Anders above (17\\/Aug\\/07).  This is a deadlock between an index scan that has shared locked a special row of the page to avoid that the row it is waiting for is moved to another page.  When another transaction needs to split the page, it creates a deadlock since the splitter needs this special lock in order to perform the split.  Hence, I think all isolation levels except READ UNCOMMITTED will have this problem.   (Since for all other isolation levels the scanner will have to wait for the exclusive lock of the inserter).\u003c\\/p\u003e\\n\\n\u003cp\u003eAs Knut Anders say, this deadlock could be avoided if the scanner did not lock this special row, but instead had some way to detect that the row has moved, and then renavigate from the root in such cases.  I would think something similar happens during rollback where an index  row may have moved due to page splits between do and undo.  Maybe something similar could be done here.  I think there are parts to this:\u003c\\/p\u003e\\n\\n\u003cp\u003e  1. When a scan needs to wait for a lock, instead of locking this special row, it copies the key of the row so that when it has acquired the lock it is waiting for, it can restart the scan using this key.  \u003c\\/p\u003e\\n\\n\u003cp\u003e  2. In order to detect when a renavigation is needed, the page needs to have some kind of state id that indicates whether a renavigation may be needed.  That is, should some row move off the page or in other ways have their address change, the state id will be incremented.  This way the scanner, by copying the current state id before it is suspended, can detect whether the page has changed.  (One need to consider whether this state id is something that needs to be persisted on the page or whether it can just reside in memory.  It depends on whether it may occur that the page is no longer in the page cache when the scan resumes.)\u003c\\/p\u003e\\n\\n\\n\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"oysteing\\\" id=\\\"commentauthor_12542953_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=oysteing\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"oysteing\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e \\u00D8ystein Gr\\u00F8vlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542953_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Nov\\/07 04:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-16T04:53:03+0000\'\u003e16\\/Nov\\/07 04:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    See the analysis made by Knut Anders above (17\\/Aug\\/07).  This is a deadlock between an index scan that has shared locked a special row of the page to avoid that the row it is waiting for is moved to another page.  When another transaction needs to split the page, it creates a deadlock since the splitter needs this special lock in order to perform the split.  Hence, I think all isolation levels except READ UNCOMMITTED will have this problem.   (Since for all other isolation levels the scanner will have to wait for the exclusive lock of the inserter). \\n\\n As Knut Anders say, this deadlock could be avoided if the scanner did not lock this special row, but instead had some way to detect that the row has moved, and then renavigate from the root in such cases.  I would think something similar happens during rollback where an index  row may have moved due to page splits between do and undo.  Maybe something similar could be done here.  I think there are parts to this: \\n\\n   1. When a scan needs to wait for a lock, instead of locking this special row, it copies the key of the row so that when it has acquired the lock it is waiting for, it can restart the scan using this key.   \\n\\n   2. In order to detect when a renavigation is needed, the page needs to have some kind of state id that indicates whether a renavigation may be needed.  That is, should some row move off the page or in other ways have their address change, the state id will be incremented.  This way the scanner, by copying the current state id before it is suspended, can detect whether the page has changed.  (One need to consider whether this state id is something that needs to be persisted on the page or whether it can just reside in memory.  It depends on whether it may occur that the page is no longer in the page cache when the scan resumes.) \\n\\n\\n\\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12542990\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12542990&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12542990\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"kurti\\\" id=\\\"commentauthor_12542990_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=kurti\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"kurti\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Kurt Huwig\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542990_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Nov\\/07 08:10\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-16T08:10:42+0000\'\u003e16\\/Nov\\/07 08:10\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eSorry for the noise, but my application even gets the deadlock with\u003c\\/p\u003e\\n\\n\u003cp\u003eConnection.TRANSACTION_READ_UNCOMMITTED\u003c\\/p\u003e\\n\\n\u003cp\u003eUnfortunately it is a mail cluster and it only gets this with 200+ simultaneous mail connections after several hours\\/days, so it is somehow hard to create a reproducing example. But I get it every second day, so I can easily verify any fix.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"kurti\\\" id=\\\"commentauthor_12542990_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=kurti\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"kurti\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Kurt Huwig\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542990_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Nov\\/07 08:10\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-16T08:10:42+0000\'\u003e16\\/Nov\\/07 08:10\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Sorry for the noise, but my application even gets the deadlock with \\n\\n Connection.TRANSACTION_READ_UNCOMMITTED \\n\\n Unfortunately it is a mail cluster and it only gets this with 200+ simultaneous mail connections after several hours\\/days, so it is somehow hard to create a reproducing example. But I get it every second day, so I can easily verify any fix.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12543058\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12543058&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12543058\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"naka\\\" id=\\\"commentauthor_12543058_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=naka\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"naka\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tomohito Nakayama\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543058_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Nov\\/07 12:38\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-16T12:38:27+0000\'\u003e16\\/Nov\\/07 12:38\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI might be bound by idea of lock for scanning index ...\u003cbr\\/\u003e\\nMy concern is about situation when the range of index, where are already scanned, are restructured.\u003c\\/p\u003e\\n\\n\u003cp\u003eThat situation would result \u003cbr\\/\u003e\\nthat rows fetched before the restructuring operation done are not based on restructured index \u003cbr\\/\u003e\\nthough rows fetched after restructuring operation done are based on.\u003c\\/p\u003e\\n\\n\\n\u003cp\u003eThinking that, I think lock is needed for index to be scanned, at least if transaction isolation level is Serializable.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"naka\\\" id=\\\"commentauthor_12543058_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=naka\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"naka\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tomohito Nakayama\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543058_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Nov\\/07 12:38\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-16T12:38:27+0000\'\u003e16\\/Nov\\/07 12:38\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I might be bound by idea of lock for scanning index ... \\nMy concern is about situation when the range of index, where are already scanned, are restructured. \\n\\n That situation would result  \\nthat rows fetched before the restructuring operation done are not based on restructured index  \\nthough rows fetched after restructuring operation done are based on. \\n\\n\\n Thinking that, I think lock is needed for index to be scanned, at least if transaction isolation level is Serializable.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12543077\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12543077&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12543077\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"naka\\\" id=\\\"commentauthor_12543077_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=naka\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"naka\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tomohito Nakayama\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543077_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Nov\\/07 14:05\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-16T14:05:44+0000\'\u003e16\\/Nov\\/07 14:05\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI found what I was confused ...\u003c\\/p\u003e\\n\\n\u003cp\u003eLock for scanning index is held only for \u003cb\u003ecurrent position\u003c\\/b\u003e.\u003cbr\\/\u003e\\nI confused as locks are held for not only current position but also scanned range.\u003c\\/p\u003e\\n\\n\u003cp\u003eReading code of BTreeScan#posotionAtNextPage,\u003cbr\\/\u003e\\nlock for current page are unlocked when proceeding to next page. \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"naka\\\" id=\\\"commentauthor_12543077_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=naka\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"naka\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tomohito Nakayama\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543077_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Nov\\/07 14:05\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-16T14:05:44+0000\'\u003e16\\/Nov\\/07 14:05\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I found what I was confused ... \\n\\n Lock for scanning index is held only for  current position . \\nI confused as locks are held for not only current position but also scanned range. \\n\\n Reading code of BTreeScan#posotionAtNextPage, \\nlock for current page are unlocked when proceeding to next page.               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12543340\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12543340&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12543340\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"naka\\\" id=\\\"commentauthor_12543340_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=naka\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"naka\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tomohito Nakayama\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543340_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Nov\\/07 04:18\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-18T04:18:02+0000\'\u003e18\\/Nov\\/07 04:18\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e&gt; One need to consider whether this state id is something that needs to be persisted on the page or whether it can just reside in memory. It depends on whether it may occur that the page is no longer in the page cache when the scan resumes.\u003c\\/p\u003e\\n\\n\u003cp\u003eIt would be needed for thestate id discussed here to be persisted.\u003cbr\\/\u003e\\nAccording to the code of StoredPage#releaseExclusive() method, page cache are removed from CacheManager when the page is unlatched.\u003c\\/p\u003e\\n\\n\u003cp\u003eorg.apache.derby.impl.store.raw.data.StoredPage#releaseExclusive() :\u003cbr\\/\u003e\\n    \\/**\u003c\\/p\u003e\\n\u003cul\u003e\\n\\t\u003cli\u003eEnsure that the page is released from the cache when it is unlatched.\u003cbr\\/\u003e\\n     *\u003c\\/li\u003e\\n\\t\u003cli\u003e@see org.apache.derby.impl.store.raw.data.BasePage#releaseExclusive\u003cbr\\/\u003e\\n     *\u003cbr\\/\u003e\\n     **\\/\u003cbr\\/\u003e\\n\\tprotected void releaseExclusive()\\n\\t{\\n\\t\\tsuper.releaseExclusive();\\n\\n\\t\\tpageCache.release(this);\\n\\t}\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"naka\\\" id=\\\"commentauthor_12543340_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=naka\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"naka\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tomohito Nakayama\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543340_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Nov\\/07 04:18\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-18T04:18:02+0000\'\u003e18\\/Nov\\/07 04:18\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    &gt; One need to consider whether this state id is something that needs to be persisted on the page or whether it can just reside in memory. It depends on whether it may occur that the page is no longer in the page cache when the scan resumes. \\n\\n It would be needed for thestate id discussed here to be persisted. \\nAccording to the code of StoredPage#releaseExclusive() method, page cache are removed from CacheManager when the page is unlatched. \\n\\n org.apache.derby.impl.store.raw.data.StoredPage#releaseExclusive() : \\n    \\/** \\n \\n\\t Ensure that the page is released from the cache when it is unlatched. \\n     * \\n\\t @see org.apache.derby.impl.store.raw.data.BasePage#releaseExclusive \\n     * \\n     **\\/ \\n\\tprotected void releaseExclusive()\\n\\t{\\n\\t\\tsuper.releaseExclusive();\\n\\n\\t\\tpageCache.release(this);\\n\\t} \\n \\n\\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12543363\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12543363&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12543363\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12543363_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543363_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Nov\\/07 10:04\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-18T10:04:44+0000\'\u003e18\\/Nov\\/07 10:04\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThe page is not removed from the page cache when it is unlatched, but its keep count is decremented, so it is possible that someone else has removed it when the scan is resumed.\u003c\\/p\u003e\\n\\n\u003cp\u003eBasePage already has a pageVersion field, but it\'s only incremented when a logged action is performed on the page. I assume there also are unlogged actions that may move the row off the page?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12543363_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543363_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Nov\\/07 10:04\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-18T10:04:44+0000\'\u003e18\\/Nov\\/07 10:04\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    The page is not removed from the page cache when it is unlatched, but its keep count is decremented, so it is possible that someone else has removed it when the scan is resumed. \\n\\n BasePage already has a pageVersion field, but it\'s only incremented when a logged action is performed on the page. I assume there also are unlogged actions that may move the row off the page?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12543575\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12543575&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12543575\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"naka\\\" id=\\\"commentauthor_12543575_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=naka\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"naka\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tomohito Nakayama\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543575_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Nov\\/07 14:34\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-19T14:34:34+0000\'\u003e19\\/Nov\\/07 14:34\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI found methods of StoredPage, which update contents of page, call logAction method which also bump pageVersion value.\u003cbr\\/\u003e\\nBecause index is in stored page,  I think any actions which move the row off the page are handled using those methods in StoredPage and are logged.\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"naka\\\" id=\\\"commentauthor_12543575_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=naka\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"naka\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tomohito Nakayama\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543575_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Nov\\/07 14:34\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-19T14:34:34+0000\'\u003e19\\/Nov\\/07 14:34\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I found methods of StoredPage, which update contents of page, call logAction method which also bump pageVersion value. \\nBecause index is in stored page,  I think any actions which move the row off the page are handled using those methods in StoredPage and are logged. \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12543576\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12543576&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12543576\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"oysteing\\\" id=\\\"commentauthor_12543576_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=oysteing\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"oysteing\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e \\u00D8ystein Gr\\u00F8vlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543576_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Nov\\/07 14:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-19T14:41:55+0000\'\u003e19\\/Nov\\/07 14:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI think pageVersion is bumped on all (logged) changes to the page.  The ideal here would be a version number that is only bumped when a row is moved.  Otherwise, most re-navigations would happen when not necessary.   Given that an exclusive lock normally leads to the an update, one might as well do an unconditional re-navigation after having waited instead of basing it on pageVersion.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"oysteing\\\" id=\\\"commentauthor_12543576_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=oysteing\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"oysteing\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e \\u00D8ystein Gr\\u00F8vlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543576_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Nov\\/07 14:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-19T14:41:55+0000\'\u003e19\\/Nov\\/07 14:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I think pageVersion is bumped on all (logged) changes to the page.  The ideal here would be a version number that is only bumped when a row is moved.  Otherwise, most re-navigations would happen when not necessary.   Given that an exclusive lock normally leads to the an update, one might as well do an unconditional re-navigation after having waited instead of basing it on pageVersion.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12543589\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12543589&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12543589\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12543589_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543589_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Nov\\/07 15:11\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-19T15:11:28+0000\'\u003e19\\/Nov\\/07 15:11\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eCould we then have a variable which contains the last page version on which a row was moved, but not store the value to disk? Then the waiter could do something like\u003c\\/p\u003e\\n\\n\u003cp\u003e    long savedVersion = pageVersion;\u003cbr\\/\u003e\\n    waitForLock();\u003cbr\\/\u003e\\n    if (lastRowMove == UNINITIALIZED) \u003c\\/p\u003e\\n{\\n        \\/\\/ page was evicted from the page cache while we were waiting,\\n        \\/\\/ row might have moved\\n        renavigate();\\n    }\\n\u003cp\u003e else if (lastRowMove &gt; savedVersion) \u003c\\/p\u003e\\n{\\n        \\/\\/ a row has been moved while we were waiting\\n        renavigate();\\n    }\\n\u003cp\u003e else \u003c\\/p\u003e\\n{\\n        \\/\\/ row has not moved\\n    }\\n\\n\u003cp\u003eThen we only renavigate when a row has moved or the page has been removed from the cache.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12543589_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543589_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Nov\\/07 15:11\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-19T15:11:28+0000\'\u003e19\\/Nov\\/07 15:11\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Could we then have a variable which contains the last page version on which a row was moved, but not store the value to disk? Then the waiter could do something like \\n\\n     long savedVersion = pageVersion; \\n    waitForLock(); \\n    if (lastRowMove == UNINITIALIZED)  \\n{\\n        \\/\\/ page was evicted from the page cache while we were waiting,\\n        \\/\\/ row might have moved\\n        renavigate();\\n    }\\n  else if (lastRowMove &gt; savedVersion)  \\n{\\n        \\/\\/ a row has been moved while we were waiting\\n        renavigate();\\n    }\\n  else  \\n{\\n        \\/\\/ row has not moved\\n    }\\n\\n Then we only renavigate when a row has moved or the page has been removed from the cache.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12543590\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12543590&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12543590\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"oysteing\\\" id=\\\"commentauthor_12543590_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=oysteing\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"oysteing\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e \\u00D8ystein Gr\\u00F8vlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543590_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Nov\\/07 15:19\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-19T15:19:57+0000\'\u003e19\\/Nov\\/07 15:19\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eKnut Anders Hatlen (JIRA) wrote:\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; Then we only renavigate when a row has moved or the page has been removed from the cache.\u003c\\/p\u003e\\n\\n\u003cp\u003eI think that is a good idea.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"oysteing\\\" id=\\\"commentauthor_12543590_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=oysteing\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"oysteing\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e \\u00D8ystein Gr\\u00F8vlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543590_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Nov\\/07 15:19\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-19T15:19:57+0000\'\u003e19\\/Nov\\/07 15:19\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Knut Anders Hatlen (JIRA) wrote: \\n\\n &gt; Then we only renavigate when a row has moved or the page has been removed from the cache. \\n\\n I think that is a good idea.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12543596\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12543596&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12543596\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"naka\\\" id=\\\"commentauthor_12543596_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=naka\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"naka\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tomohito Nakayama\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543596_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Nov\\/07 15:30\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-19T15:30:54+0000\'\u003e19\\/Nov\\/07 15:30\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI think lastRowMove is needed to be instance variable of page cache object ...\u003cbr\\/\u003e\\nHere we encounter removed cache problem again ....\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"naka\\\" id=\\\"commentauthor_12543596_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=naka\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"naka\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tomohito Nakayama\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543596_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Nov\\/07 15:30\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-19T15:30:54+0000\'\u003e19\\/Nov\\/07 15:30\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I think lastRowMove is needed to be instance variable of page cache object ... \\nHere we encounter removed cache problem again .... \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12543603\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12543603&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12543603\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"naka\\\" id=\\\"commentauthor_12543603_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=naka\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"naka\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tomohito Nakayama\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543603_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Nov\\/07 16:03\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-19T16:03:57+0000\'\u003e19\\/Nov\\/07 16:03\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eOh I understand.\u003cbr\\/\u003e\\nTaking removal of page cache as need for renavigate.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"naka\\\" id=\\\"commentauthor_12543603_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=naka\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"naka\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tomohito Nakayama\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543603_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Nov\\/07 16:03\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-19T16:03:57+0000\'\u003e19\\/Nov\\/07 16:03\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Oh I understand. \\nTaking removal of page cache as need for renavigate.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12543867\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12543867&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12543867\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"naka\\\" id=\\\"commentauthor_12543867_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=naka\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"naka\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tomohito Nakayama\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543867_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Nov\\/07 11:26\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-20T11:26:01+0000\'\u003e20\\/Nov\\/07 11:26\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI found there exists confusion yet...\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt;    long savedVersion = pageVersion; \u003cbr\\/\u003e\\n&gt;    waitForLock(); \u003cbr\\/\u003e\\n&gt;    if (lastRowMove == UNINITIALIZED) \u003c\\/p\u003e\\n{ \\n&gt;        \\/\\/ page was evicted from the page cache while we were waiting, \\n&gt;        \\/\\/ row might have moved \\n&gt;        renavigate(); \\n&gt;    }\\n\u003cp\u003e else if (lastRowMove &gt; savedVersion) \u003c\\/p\u003e\\n{ \\n&gt;        \\/\\/ a row has been moved while we were waiting \\n&gt;        renavigate(); \\n&gt;    }\\n\u003cp\u003e else \u003c\\/p\u003e\\n{ \\n&gt;        \\/\\/ row has not moved \\n&gt;    }\\n\u003cp\u003e \u003c\\/p\u003e\\n\\n\u003cp\u003e&gt;    waitForLock(); \u003c\\/p\u003e\\n\\n\u003cp\u003eWe were thinking about not locking the row.\u003cbr\\/\u003e\\nThen I think this plan is impossible.\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"naka\\\" id=\\\"commentauthor_12543867_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=naka\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"naka\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tomohito Nakayama\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543867_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Nov\\/07 11:26\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-20T11:26:01+0000\'\u003e20\\/Nov\\/07 11:26\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I found there exists confusion yet... \\n\\n &gt;    long savedVersion = pageVersion;  \\n&gt;    waitForLock();  \\n&gt;    if (lastRowMove == UNINITIALIZED)  \\n{ \\n&gt;        \\/\\/ page was evicted from the page cache while we were waiting, \\n&gt;        \\/\\/ row might have moved \\n&gt;        renavigate(); \\n&gt;    }\\n  else if (lastRowMove &gt; savedVersion)  \\n{ \\n&gt;        \\/\\/ a row has been moved while we were waiting \\n&gt;        renavigate(); \\n&gt;    }\\n  else  \\n{ \\n&gt;        \\/\\/ row has not moved \\n&gt;    }\\n   \\n\\n &gt;    waitForLock();  \\n\\n We were thinking about not locking the row. \\nThen I think this plan is impossible. \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12543873\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12543873&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12543873\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"naka\\\" id=\\\"commentauthor_12543873_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=naka\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"naka\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tomohito Nakayama\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543873_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Nov\\/07 11:48\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-20T11:48:32+0000\'\u003e20\\/Nov\\/07 11:48\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI read current code (and Knuts comment) that shared lock is gotten instead of latch of page and \u003cbr\\/\u003e\\nthe chance to release the latch are given to escape deadlock through trial for lock\u003cbr\\/\u003e\\nin order to escape deadlock.\u003c\\/p\u003e\\n\\n\u003cp\u003eIf we don\'t get shared lock any more in program, we can do for escaping deadlock is just release the latch.\u003c\\/p\u003e\\n\\n\u003cp\u003eReleasing the latch may results the StoredPage, which also means latch for Page, to be removed.\u003c\\/p\u003e\\n\\n\u003cp\u003eIf the PageCache is not removed, we can use lastRowMove of StoredPage as above.\u003cbr\\/\u003e\\nIf the PageCache is removed, there are three cases.\u003cbr\\/\u003e\\n1: Only scanning index operation held latch and PageCache was removed. The row is not moved.\u003cbr\\/\u003e\\n2: Other operation also held latch and move the row and release the latch and PageCache was removed.\u003cbr\\/\u003e\\n3: Other operation also held latch and does not move the row but store something and release the latch and PageCache was removed.\u003c\\/p\u003e\\n\\n\u003cp\u003eSeeing page version of loaded PageCache, we can distinguish 1 from others.\u003cbr\\/\u003e\\nI think it would be not so awful to check rows in page to know 2 or 3.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"naka\\\" id=\\\"commentauthor_12543873_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=naka\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"naka\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tomohito Nakayama\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543873_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Nov\\/07 11:48\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-20T11:48:32+0000\'\u003e20\\/Nov\\/07 11:48\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I read current code (and Knuts comment) that shared lock is gotten instead of latch of page and  \\nthe chance to release the latch are given to escape deadlock through trial for lock \\nin order to escape deadlock. \\n\\n If we don\'t get shared lock any more in program, we can do for escaping deadlock is just release the latch. \\n\\n Releasing the latch may results the StoredPage, which also means latch for Page, to be removed. \\n\\n If the PageCache is not removed, we can use lastRowMove of StoredPage as above. \\nIf the PageCache is removed, there are three cases. \\n1: Only scanning index operation held latch and PageCache was removed. The row is not moved. \\n2: Other operation also held latch and move the row and release the latch and PageCache was removed. \\n3: Other operation also held latch and does not move the row but store something and release the latch and PageCache was removed. \\n\\n Seeing page version of loaded PageCache, we can distinguish 1 from others. \\nI think it would be not so awful to check rows in page to know 2 or 3.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12543877\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12543877&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12543877\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"naka\\\" id=\\\"commentauthor_12543877_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=naka\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"naka\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tomohito Nakayama\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543877_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Nov\\/07 12:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-20T12:16:59+0000\'\u003e20\\/Nov\\/07 12:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI think code would be like this.\u003cbr\\/\u003e\\nI think we also need to see contents of page if cache was removed once.\u003c\\/p\u003e\\n\\n\u003cp\u003e    long savedVersion = pageVersion; \u003cbr\\/\u003e\\n    page.unlatch()    \u003cbr\\/\u003e\\n    page = null;\u003cbr\\/\u003e\\n               &lt;snip&gt;\u003c\\/p\u003e\\n\\n\u003cp\u003e     \\/\\/Where need to see the row\u003cbr\\/\u003e\\n     page = getFromCache()\u003c\\/p\u003e\\n\\n\u003cp\u003e     if (page == null) { \u003cbr\\/\u003e\\n         page = getFromStorage()\u003c\\/p\u003e\\n\\n\u003cp\u003e         if( page.pageVersion == savedVersion )\u003c\\/p\u003e\\n{\\n            \\/\\/ row has not moved \\n         }else if( checkRowMoved(page) )\u003cbr\\/\u003e\\n            renavigate(); \u003cbr\\/\u003e\\n         }else{            \\/\\/ row has not moved          }\\n\\n\u003cp\u003e     } else if(page.lastRowMove == UNINITIALIZED ){  \\/\\/ This can be true if cache of page was removed once and loaded again.\u003cbr\\/\u003e\\n         if( checkRowMoved(page))\u003c\\/p\u003e\\n{ \\/\\/ The cache was removed after row moved.\\n            renavigate(); \\n         }\\n\u003cp\u003eelse\u003c\\/p\u003e\\n{\\n            \\/\\/ row has not moved \\n         }\\n\\n\u003cp\u003e     } else if (page.lastRowMove &gt; savedVersion) \u003c\\/p\u003e\\n{ \\n         \\/\\/ a row has been moved while we were waiting \\n         renavigate(); \\n     }\\n\u003cp\u003e else \u003c\\/p\u003e\\n{ \\n         \\/\\/ row has not moved \\n     }\\n\u003cp\u003e \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"naka\\\" id=\\\"commentauthor_12543877_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=naka\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"naka\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tomohito Nakayama\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543877_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Nov\\/07 12:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-20T12:16:59+0000\'\u003e20\\/Nov\\/07 12:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I think code would be like this. \\nI think we also need to see contents of page if cache was removed once. \\n\\n     long savedVersion = pageVersion;  \\n    page.unlatch()     \\n    page = null; \\n               &lt;snip&gt; \\n\\n      \\/\\/Where need to see the row \\n     page = getFromCache() \\n\\n      if (page == null) {  \\n         page = getFromStorage() \\n\\n          if( page.pageVersion == savedVersion ) \\n{\\n            \\/\\/ row has not moved \\n         }else if( checkRowMoved(page) ) \\n            renavigate();  \\n         }else{            \\/\\/ row has not moved          }\\n\\n      } else if(page.lastRowMove == UNINITIALIZED ){  \\/\\/ This can be true if cache of page was removed once and loaded again. \\n         if( checkRowMoved(page)) \\n{ \\/\\/ The cache was removed after row moved.\\n            renavigate(); \\n         }\\n else \\n{\\n            \\/\\/ row has not moved \\n         }\\n\\n      } else if (page.lastRowMove &gt; savedVersion)  \\n{ \\n         \\/\\/ a row has been moved while we were waiting \\n         renavigate(); \\n     }\\n  else  \\n{ \\n         \\/\\/ row has not moved \\n     }\\n                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12641834\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12641834&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12641834\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12641834_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12641834_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Oct\\/08 14:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-10-22T14:00:00+0000\'\u003e22\\/Oct\\/08 14:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI\'m hoping to find some time to investigate this issue.\u003c\\/p\u003e\\n\\n\u003cp\u003eSo far, only one suggestion for how we can fix this has come up. The\u003cbr\\/\u003e\\nbasic idea is that we don\'t set the scan lock to protect the scan\u003cbr\\/\u003e\\nposition, and instead we reposition the scan if we need to wait for a\u003cbr\\/\u003e\\nlock and therefore have released the latch on the index leaf.\u003c\\/p\u003e\\n\\n\u003cp\u003eMost of the discussion has been about how we can avoid the\u003cbr\\/\u003e\\nrepositioning when it\'s not needed, and I think we have a reasonably\u003cbr\\/\u003e\\ngood understanding of how we can do that by having a (non-persistent)\u003cbr\\/\u003e\\nfield in the page objects that give us a version number after which it\u003cbr\\/\u003e\\nis guaranteed that no row has moved off the page.\u003c\\/p\u003e\\n\\n\u003cp\u003eEarlier in the discussion we have said that this field should have a\u003cbr\\/\u003e\\nspecial value to tell that it\'s uninitialized when the page is faulted\u003cbr\\/\u003e\\nin to the page cache. After some more thinking, I now believe it would\u003cbr\\/\u003e\\nbe more reasonable to initialize it to the current version of the\u003cbr\\/\u003e\\npage. Otherwise, the field would be uninitialized for most of the\u003cbr\\/\u003e\\ncached pages, and it wouldn\'t help us avoiding repositioning most of\u003cbr\\/\u003e\\nthe time.\u003c\\/p\u003e\\n\\n\u003cp\u003eWhat hasn\'t been discussed yet, is how we can do the repositioning\u003cbr\\/\u003e\\nwhen we don\'t have the scan lock. \\u00D8ystein mentioned that the scan\u003cbr\\/\u003e\\ncould copy the key when it needs to wait for a lock, and use the key\u003cbr\\/\u003e\\nto reposition itself in the B-tree. I think that sounds like a good\u003cbr\\/\u003e\\napproach, but there are some things that are not quite clear to me:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) Would copying the key work for non-unique indexes as well? I guess\u003cbr\\/\u003e\\nso since the non-unique indexes seem to append the RecordId to the\u003cbr\\/\u003e\\nkey.\u003c\\/p\u003e\\n\\n\u003cp\u003e2) How stable are the RecordIds? Can they be changed by other\u003cbr\\/\u003e\\noperations than compress table?\u003c\\/p\u003e\\n\\n\u003cp\u003e3) If the isolation level is READ_COMMITTED or higher, the open scans\u003cbr\\/\u003e\\nwould have an intentional read lock on the table, so even without the\u003cbr\\/\u003e\\nscan locks compress table shouldn\'t be able to change the RecordIds\u003cbr\\/\u003e\\nwhile a scan is waiting for a lock (the intentional read lock should\u003cbr\\/\u003e\\nblock compress table when it attempts to write lock the table). But\u003cbr\\/\u003e\\nwould this work in READ_UNCOMMITTED? Or rather, does it work correctly\u003cbr\\/\u003e\\nin READ_UNCOMMITTED today? READ_UNCOMMITTED doesn\'t set shared locks,\u003cbr\\/\u003e\\nso I would assume that it doesn\'t set any shared scan locks either.\u003c\\/p\u003e\\n\\n\u003cp\u003eComments and suggestions would be appreciated. I\'ll do some more\u003cbr\\/\u003e\\ndigging and report back with my findings.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12641834_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12641834_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Oct\\/08 14:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-10-22T14:00:00+0000\'\u003e22\\/Oct\\/08 14:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I\'m hoping to find some time to investigate this issue. \\n\\n So far, only one suggestion for how we can fix this has come up. The \\nbasic idea is that we don\'t set the scan lock to protect the scan \\nposition, and instead we reposition the scan if we need to wait for a \\nlock and therefore have released the latch on the index leaf. \\n\\n Most of the discussion has been about how we can avoid the \\nrepositioning when it\'s not needed, and I think we have a reasonably \\ngood understanding of how we can do that by having a (non-persistent) \\nfield in the page objects that give us a version number after which it \\nis guaranteed that no row has moved off the page. \\n\\n Earlier in the discussion we have said that this field should have a \\nspecial value to tell that it\'s uninitialized when the page is faulted \\nin to the page cache. After some more thinking, I now believe it would \\nbe more reasonable to initialize it to the current version of the \\npage. Otherwise, the field would be uninitialized for most of the \\ncached pages, and it wouldn\'t help us avoiding repositioning most of \\nthe time. \\n\\n What hasn\'t been discussed yet, is how we can do the repositioning \\nwhen we don\'t have the scan lock. \\u00D8ystein mentioned that the scan \\ncould copy the key when it needs to wait for a lock, and use the key \\nto reposition itself in the B-tree. I think that sounds like a good \\napproach, but there are some things that are not quite clear to me: \\n\\n 1) Would copying the key work for non-unique indexes as well? I guess \\nso since the non-unique indexes seem to append the RecordId to the \\nkey. \\n\\n 2) How stable are the RecordIds? Can they be changed by other \\noperations than compress table? \\n\\n 3) If the isolation level is READ_COMMITTED or higher, the open scans \\nwould have an intentional read lock on the table, so even without the \\nscan locks compress table shouldn\'t be able to change the RecordIds \\nwhile a scan is waiting for a lock (the intentional read lock should \\nblock compress table when it attempts to write lock the table). But \\nwould this work in READ_UNCOMMITTED? Or rather, does it work correctly \\nin READ_UNCOMMITTED today? READ_UNCOMMITTED doesn\'t set shared locks, \\nso I would assume that it doesn\'t set any shared scan locks either. \\n\\n Comments and suggestions would be appreciated. I\'ll do some more \\ndigging and report back with my findings.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12642440\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12642440&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12642440\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12642440_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12642440_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'24\\/Oct\\/08 11:07\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-10-24T11:07:14+0000\'\u003e24\\/Oct\\/08 11:07\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eIt looks like READ_UNCOMMITTED transactions also obtain an IS lock on the tables they are scanning, and if they\'re performing an index scan an S lock on the scan control row. I think this means that the RecordId will not change because of compress table performed in another transaction while there\'s an open scan. I\'m not sure if that\'s always true if inplace compress table is performed in the same transaction, but it seems like at least the purging is performed in a nested transaction and will time out on getting an exclusive lock if the parent transaction has an open scan on that table.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12642440_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12642440_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'24\\/Oct\\/08 11:07\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-10-24T11:07:14+0000\'\u003e24\\/Oct\\/08 11:07\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    It looks like READ_UNCOMMITTED transactions also obtain an IS lock on the tables they are scanning, and if they\'re performing an index scan an S lock on the scan control row. I think this means that the RecordId will not change because of compress table performed in another transaction while there\'s an open scan. I\'m not sure if that\'s always true if inplace compress table is performed in the same transaction, but it seems like at least the purging is performed in a nested transaction and will time out on getting an exclusive lock if the parent transaction has an open scan on that table.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12646901\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12646901&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12646901\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12646901_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12646901_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Nov\\/08 14:05\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-11-12T14:05:33+0000\'\u003e12\\/Nov\\/08 14:05\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eWe already have code to save the position by key and reposition using\u003cbr\\/\u003e\\nthe saved key (methods savePosition() and reposition() in\u003cbr\\/\u003e\\nBTreeScan). Currently, we only save the key on transaction borders so\u003cbr\\/\u003e\\nthat we can reposition a holdable cursor after a commit. This is\u003cbr\\/\u003e\\nneeded because transactions release all their locks on commit, scan\u003cbr\\/\u003e\\nlocks included.\u003c\\/p\u003e\\n\\n\u003cp\u003eI think it should be possible to use the same logic to save the\u003cbr\\/\u003e\\nposition within a transaction. The current position of an index scan\u003cbr\\/\u003e\\nis stored in a BTreeRowPosition object, either as a Page\\/RecordId pair\u003cbr\\/\u003e\\nwhich requires a scan protection lock, or as a key value. Every time\u003cbr\\/\u003e\\nthe access layer is reentered, reposition() is called which either\u003cbr\\/\u003e\\njust reacquires the latch on the page (if there\'s a scan lock) or\u003cbr\\/\u003e\\nrepositions from the root of the B-tree (if there\'s no scan lock).\u003c\\/p\u003e\\n\\n\u003cp\u003eSo I think that if we find a way to ensure that we always save the\u003cbr\\/\u003e\\nposition by key when we\'re about to release the latch on a leaf page\u003cbr\\/\u003e\\n(either because we cannot obtain a lock immediately, or because we\'re\u003cbr\\/\u003e\\nleaving the access layer), the repositioning code should work more or\u003cbr\\/\u003e\\nless as it is.\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'m hoping that saving the key each time we release the latch doesn\'t\u003cbr\\/\u003e\\nhave a too heavy impact on single-threaded performance. For short\u003cbr\\/\u003e\\nkeys, it should be relatively cheap, and the cost of saving the key\u003cbr\\/\u003e\\nmay be outweighed by what we save by not having to maintain the scan\u003cbr\\/\u003e\\nprotection lock.\u003c\\/p\u003e\\n\\n\u003cp\u003eWith the optimizations suggested for the repositioning in earlier\u003cbr\\/\u003e\\ncomments, I believe that the repositioning will not be more expensive\u003cbr\\/\u003e\\nthan today in the common case where the page hasn\'t been split.\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'d welcome any comments and suggestions on how to implement this.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12646901_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12646901_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Nov\\/08 14:05\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-11-12T14:05:33+0000\'\u003e12\\/Nov\\/08 14:05\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    We already have code to save the position by key and reposition using \\nthe saved key (methods savePosition() and reposition() in \\nBTreeScan). Currently, we only save the key on transaction borders so \\nthat we can reposition a holdable cursor after a commit. This is \\nneeded because transactions release all their locks on commit, scan \\nlocks included. \\n\\n I think it should be possible to use the same logic to save the \\nposition within a transaction. The current position of an index scan \\nis stored in a BTreeRowPosition object, either as a Page\\/RecordId pair \\nwhich requires a scan protection lock, or as a key value. Every time \\nthe access layer is reentered, reposition() is called which either \\njust reacquires the latch on the page (if there\'s a scan lock) or \\nrepositions from the root of the B-tree (if there\'s no scan lock). \\n\\n So I think that if we find a way to ensure that we always save the \\nposition by key when we\'re about to release the latch on a leaf page \\n(either because we cannot obtain a lock immediately, or because we\'re \\nleaving the access layer), the repositioning code should work more or \\nless as it is. \\n\\n I\'m hoping that saving the key each time we release the latch doesn\'t \\nhave a too heavy impact on single-threaded performance. For short \\nkeys, it should be relatively cheap, and the cost of saving the key \\nmay be outweighed by what we save by not having to maintain the scan \\nprotection lock. \\n\\n With the optimizations suggested for the repositioning in earlier \\ncomments, I believe that the repositioning will not be more expensive \\nthan today in the common case where the page hasn\'t been split. \\n\\n I\'d welcome any comments and suggestions on how to implement this.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12650107\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12650107&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12650107\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"stuckman\\\" id=\\\"commentauthor_12650107_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=stuckman\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"stuckman\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jeff Stuckman\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12650107_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'24\\/Nov\\/08 04:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-11-24T04:50:53+0000\'\u003e24\\/Nov\\/08 04:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI\'m also affected by this issue, and I\'d like to note that a concurrent select and update can cause the undesired behavior, not just a concurrent select and insert.\u003c\\/p\u003e\\n\\n\u003cp\u003eSummary:\u003cbr\\/\u003e\\nEven using READ_COMMITTED, a single non-updatable SELECT and a single UPDATE statement can deadlock against each other when an index includes the updated column.\u003c\\/p\u003e\\n\\n\u003cp\u003eMy test case uses the following table and index:\u003cbr\\/\u003e\\nCREATE TABLE urls (urlid INTEGER NOT NULL PRIMARY KEY, url VARCHAR(2048) NOT NULL UNIQUE, site INTEGER, expectation INTEGER, jobflag CHAR DEFAULT \'N\'); CREATE INDEX findurlbysiteandjob ON urls(site,jobflag);\u003c\\/p\u003e\\n\\n\u003cp\u003eMy test case creates two threads and executes the following statements until they deadlock against each other:\u003cbr\\/\u003e\\nUPDATE urls SET jobflag=? WHERE urlid=?\\t\u003cbr\\/\u003e\\nSELECT urlid,url,expectation FROM urls WHERE site=?\u003c\\/p\u003e\\n\\n\u003cp\u003eThe test eventually deadlocks with the following transaction and lock table\u003cbr\\/\u003e\\ncontents:\u003cbr\\/\u003e\\nXID     TYPE  MODE TABLENAME LOCKNAME  STATE TABLETYPE  LOCKCOUNT  INDEXNAME\u003cbr\\/\u003e\\n2217109 ROW   S    URLS      (13,1)    GRANT T          1 FINDURLBYSITEANDJOB\u003cbr\\/\u003e\\n2217114 ROW   X    URLS      (13,1)    WAIT  T          0 FINDURLBYSITEANDJOB\u003cbr\\/\u003e\\n2217113 ROW   S    URLS      (15,1)    GRANT T          1 FINDURLBYSITEANDJOB\u003cbr\\/\u003e\\n2217113 ROW   X    URLS      (3,132)   GRANT T          3          null\u003cbr\\/\u003e\\n2217109 ROW   S    URLS      (3,132)   WAIT  T          0          null\u003cbr\\/\u003e\\n2217109 TABLE IS   URLS      Tablelock GRANT T          2          null\u003cbr\\/\u003e\\n2217113 TABLE IX   URLS      Tablelock GRANT T          4          null\u003cbr\\/\u003e\\n2217114 TABLE IX   URLS      Tablelock GRANT T          1          null\u003cbr\\/\u003e\\n2217113 ROW   S    URLS      (6,1)     GRANT T          1 SQL081111021116970\u003c\\/p\u003e\\n\\n\u003cp\u003eXID     GLOBAL_XID  USERNAME TYPE                 STATUS  FIRST_INSTANT SQL_TEXT\u003cbr\\/\u003e\\n2217115 null        APP      UserTransaction      IDLE    null select * from SYSCS_DIAG.TRANSACTION_TABLE\u003cbr\\/\u003e\\n2217114 null        APP      InternalTransaction  ACTIVE  null UPDATE urls SET jobflag=? WHERE urlid=?\u003cbr\\/\u003e\\n2217113 null        APP      UserTransaction      ACTIVE  (526,52925) UPDATE urls SET jobflag=? WHERE urlid=?\u003cbr\\/\u003e\\n2069160 null        null     SystemTransaction    IDLE    null          null\u003cbr\\/\u003e\\n2217109 null        APP      UserTransaction      ACTIVE  null\u003c\\/p\u003e\\n\\n\\n\u003cp\u003e1. The SELECT statement begins to execute and the cursor is stepping through the result set. The results are derived from index FINDURLBYSITEANDJOB as expected.\u003cbr\\/\u003e\\n2. The UPDATE statement begins to execute. The row to be updated is the row immediately after the SELECT statement\'s cursor. The row is locked and updated.\u003cbr\\/\u003e\\n3. The UPDATE statement must modify the index structure (tree rebalancing or similar?). It must lock the row that the SELECT statement\'s cursor is currently occupying. It cannot do this, so the transaction waits.\u003cbr\\/\u003e\\n4. The SELECT statement is ready to advance the cursor. However, it cannot advance the cursor because the UPDATE statement has locked the next row. The transaction waits and we have a deadlock.\u003c\\/p\u003e\\n\\n\u003cp\u003eApparently, the only way to avoid this deadlock is to LOCK TABLE before updating.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"stuckman\\\" id=\\\"commentauthor_12650107_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=stuckman\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"stuckman\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jeff Stuckman\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12650107_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'24\\/Nov\\/08 04:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-11-24T04:50:53+0000\'\u003e24\\/Nov\\/08 04:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I\'m also affected by this issue, and I\'d like to note that a concurrent select and update can cause the undesired behavior, not just a concurrent select and insert. \\n\\n Summary: \\nEven using READ_COMMITTED, a single non-updatable SELECT and a single UPDATE statement can deadlock against each other when an index includes the updated column. \\n\\n My test case uses the following table and index: \\nCREATE TABLE urls (urlid INTEGER NOT NULL PRIMARY KEY, url VARCHAR(2048) NOT NULL UNIQUE, site INTEGER, expectation INTEGER, jobflag CHAR DEFAULT \'N\'); CREATE INDEX findurlbysiteandjob ON urls(site,jobflag); \\n\\n My test case creates two threads and executes the following statements until they deadlock against each other: \\nUPDATE urls SET jobflag=? WHERE urlid=?\\t \\nSELECT urlid,url,expectation FROM urls WHERE site=? \\n\\n The test eventually deadlocks with the following transaction and lock table \\ncontents: \\nXID     TYPE  MODE TABLENAME LOCKNAME  STATE TABLETYPE  LOCKCOUNT  INDEXNAME \\n2217109 ROW   S    URLS      (13,1)    GRANT T          1 FINDURLBYSITEANDJOB \\n2217114 ROW   X    URLS      (13,1)    WAIT  T          0 FINDURLBYSITEANDJOB \\n2217113 ROW   S    URLS      (15,1)    GRANT T          1 FINDURLBYSITEANDJOB \\n2217113 ROW   X    URLS      (3,132)   GRANT T          3          null \\n2217109 ROW   S    URLS      (3,132)   WAIT  T          0          null \\n2217109 TABLE IS   URLS      Tablelock GRANT T          2          null \\n2217113 TABLE IX   URLS      Tablelock GRANT T          4          null \\n2217114 TABLE IX   URLS      Tablelock GRANT T          1          null \\n2217113 ROW   S    URLS      (6,1)     GRANT T          1 SQL081111021116970 \\n\\n XID     GLOBAL_XID  USERNAME TYPE                 STATUS  FIRST_INSTANT SQL_TEXT \\n2217115 null        APP      UserTransaction      IDLE    null select * from SYSCS_DIAG.TRANSACTION_TABLE \\n2217114 null        APP      InternalTransaction  ACTIVE  null UPDATE urls SET jobflag=? WHERE urlid=? \\n2217113 null        APP      UserTransaction      ACTIVE  (526,52925) UPDATE urls SET jobflag=? WHERE urlid=? \\n2069160 null        null     SystemTransaction    IDLE    null          null \\n2217109 null        APP      UserTransaction      ACTIVE  null \\n\\n\\n 1. The SELECT statement begins to execute and the cursor is stepping through the result set. The results are derived from index FINDURLBYSITEANDJOB as expected. \\n2. The UPDATE statement begins to execute. The row to be updated is the row immediately after the SELECT statement\'s cursor. The row is locked and updated. \\n3. The UPDATE statement must modify the index structure (tree rebalancing or similar?). It must lock the row that the SELECT statement\'s cursor is currently occupying. It cannot do this, so the transaction waits. \\n4. The SELECT statement is ready to advance the cursor. However, it cannot advance the cursor because the UPDATE statement has locked the next row. The transaction waits and we have a deadlock. \\n\\n Apparently, the only way to avoid this deadlock is to LOCK TABLE before updating.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12650164\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12650164&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12650164\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12650164_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12650164_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'24\\/Nov\\/08 10:56\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-11-24T10:56:51+0000\'\u003e24\\/Nov\\/08 10:56\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAttaching an experimental patch (d2991-preview-1a.diff) to show how\u003cbr\\/\u003e\\nI\'m planning to fix the deadlock.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe patch makes the B-tree scans save the scan position and release\u003cbr\\/\u003e\\nthe scan lock if they release the latch in the middle of the\u003cbr\\/\u003e\\nscan. Although the patch doesn\'t remove the use of scan locks, it does\u003cbr\\/\u003e\\nmake sure that no transaction holds the scan lock on a page without\u003cbr\\/\u003e\\nholding the latch on the same page, so the scan locks don\'t have any\u003cbr\\/\u003e\\neffect anymore.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe code to save the position and reposition could be used more or\u003cbr\\/\u003e\\nless in its current state. Some small adjustments needed to be made:\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eThe existing savePosition methods couldn\'t be used directly since\u003cbr\\/\u003e\\n    one of them assumed that the page was not latched when called, and\u003cbr\\/\u003e\\n    the other one was meant to be called from other transactions that\u003cbr\\/\u003e\\n    needed to tell the scan to save its position if it happened to be\u003cbr\\/\u003e\\n    positioned on a given page. A new variant of savePosition was\u003cbr\\/\u003e\\n    added. I believe that both of the old ones can be removed now,\u003cbr\\/\u003e\\n    since the position will already have been saved and they won\'t\u003cbr\\/\u003e\\n    have any work to do, but I need to check that.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003esavePosition\\/reposition needed to save\\/restore information about\u003cbr\\/\u003e\\n    whether or not the row at the current position was locked (which\u003cbr\\/\u003e\\n    is available from scan_position.current_rh when the scan is\u003cbr\\/\u003e\\n    positioned). This information wasn\'t need earlier since the scan\u003cbr\\/\u003e\\n    position would only be saved on transactions boundaries, in which\u003cbr\\/\u003e\\n    case the locks would be released.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eThe final solution should of course also remove the scan locks and\u003cbr\\/\u003e\\ninclude the earlier discussed optimization to prevent unnecessary\u003cbr\\/\u003e\\nrepositioning when no rows have been moved off the page.\u003c\\/p\u003e\\n\\n\u003cp\u003eI ran the attached repro (InsertSelectDeadlock.java) and didn\'t see\u003cbr\\/\u003e\\nany timeouts when the patch was applied.\u003c\\/p\u003e\\n\\n\u003cp\u003eI have also run the full regression test suite. suites.All ran\u003cbr\\/\u003e\\ncleanly. Derbyall had five failures in the store tests:\u003c\\/p\u003e\\n\\n\u003cp\u003estore\\/RowLockIso.sql\u003cbr\\/\u003e\\nstore\\/rlliso2multi.sql\u003cbr\\/\u003e\\nstore\\/rlliso3multi.sql\u003cbr\\/\u003e\\nstore\\/readlocks.sql\u003cbr\\/\u003e\\nunit\\/T_b2i.unit\u003c\\/p\u003e\\n\\n\u003cp\u003eThe first four of them failed because (a) lock table dumps didn\'t\u003cbr\\/\u003e\\ncontain scan locks any longer, and (b) some inserts didn\'t fail with a\u003cbr\\/\u003e\\ntimeout trying to obtain the scan lock. These sound like expected\u003cbr\\/\u003e\\nchanges in behaviour and should probably be fixed by updating the\u003cbr\\/\u003e\\ncanons.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe last failure (unit\\/T_b2i.unit) was caused by some debug code that\u003cbr\\/\u003e\\nis only enabled when running that test. The debug code simulates that\u003cbr\\/\u003e\\nthe latch is lost, but it has not been updated to save the position\u003cbr\\/\u003e\\nbefore it releases the latch, so an assert is triggered when we later\u003cbr\\/\u003e\\ntry to reposition. This should be fixed by changing the method\u003cbr\\/\u003e\\nOpenBTree.test_errors so that it saves the position if needed.\u003c\\/p\u003e\\n\\n\u003cp\u003eIt would be great if someone could take a look at the patch and verify\u003cbr\\/\u003e\\nthat I\'m on the right track and that I\'m not missing something\u003cbr\\/\u003e\\nessential.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12650164_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12650164_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'24\\/Nov\\/08 10:56\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-11-24T10:56:51+0000\'\u003e24\\/Nov\\/08 10:56\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Attaching an experimental patch (d2991-preview-1a.diff) to show how \\nI\'m planning to fix the deadlock. \\n\\n The patch makes the B-tree scans save the scan position and release \\nthe scan lock if they release the latch in the middle of the \\nscan. Although the patch doesn\'t remove the use of scan locks, it does \\nmake sure that no transaction holds the scan lock on a page without \\nholding the latch on the same page, so the scan locks don\'t have any \\neffect anymore. \\n\\n The code to save the position and reposition could be used more or \\nless in its current state. Some small adjustments needed to be made: \\n\\n \\n\\t The existing savePosition methods couldn\'t be used directly since \\n    one of them assumed that the page was not latched when called, and \\n    the other one was meant to be called from other transactions that \\n    needed to tell the scan to save its position if it happened to be \\n    positioned on a given page. A new variant of savePosition was \\n    added. I believe that both of the old ones can be removed now, \\n    since the position will already have been saved and they won\'t \\n    have any work to do, but I need to check that. \\n \\n\\n\\n \\n\\t savePosition\\/reposition needed to save\\/restore information about \\n    whether or not the row at the current position was locked (which \\n    is available from scan_position.current_rh when the scan is \\n    positioned). This information wasn\'t need earlier since the scan \\n    position would only be saved on transactions boundaries, in which \\n    case the locks would be released. \\n \\n\\n\\n The final solution should of course also remove the scan locks and \\ninclude the earlier discussed optimization to prevent unnecessary \\nrepositioning when no rows have been moved off the page. \\n\\n I ran the attached repro (InsertSelectDeadlock.java) and didn\'t see \\nany timeouts when the patch was applied. \\n\\n I have also run the full regression test suite. suites.All ran \\ncleanly. Derbyall had five failures in the store tests: \\n\\n store\\/RowLockIso.sql \\nstore\\/rlliso2multi.sql \\nstore\\/rlliso3multi.sql \\nstore\\/readlocks.sql \\nunit\\/T_b2i.unit \\n\\n The first four of them failed because (a) lock table dumps didn\'t \\ncontain scan locks any longer, and (b) some inserts didn\'t fail with a \\ntimeout trying to obtain the scan lock. These sound like expected \\nchanges in behaviour and should probably be fixed by updating the \\ncanons. \\n\\n The last failure (unit\\/T_b2i.unit) was caused by some debug code that \\nis only enabled when running that test. The debug code simulates that \\nthe latch is lost, but it has not been updated to save the position \\nbefore it releases the latch, so an assert is triggered when we later \\ntry to reposition. This should be fixed by changing the method \\nOpenBTree.test_errors so that it saves the position if needed. \\n\\n It would be great if someone could take a look at the patch and verify \\nthat I\'m on the right track and that I\'m not missing something \\nessential.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12651108\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12651108&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12651108\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12651108_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12651108_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Nov\\/08 19:03\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-11-26T19:03:20+0000\'\u003e26\\/Nov\\/08 19:03\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAttaching an updated preview patch (d2991-preview-1b.diff). Now all\u003cbr\\/\u003e\\nthe regression tests run cleanly. Differences from the previous patch:\u003c\\/p\u003e\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eupdated store tests so that they didn\'t expect scan locks in the\u003cbr\\/\u003e\\n    lock table dumps or conflicts on the scan lock\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eensured that OpenBTree.test_errors() would save the position if\u003cbr\\/\u003e\\n    the condition that is simulated would have resulted in the\u003cbr\\/\u003e\\n    position being saved\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003everified that the existing savePosition methods could be removed,\u003cbr\\/\u003e\\n    as I indicated in the previous comment, and removed the\u003cbr\\/\u003e\\n    methods. This also made it possible to remove the methods from\u003cbr\\/\u003e\\n    interfaces and no-op implementations of these methods in other\u003cbr\\/\u003e\\n    scan types.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12651108_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12651108_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Nov\\/08 19:03\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-11-26T19:03:20+0000\'\u003e26\\/Nov\\/08 19:03\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Attaching an updated preview patch (d2991-preview-1b.diff). Now all \\nthe regression tests run cleanly. Differences from the previous patch: \\n\\n \\n\\t updated store tests so that they didn\'t expect scan locks in the \\n    lock table dumps or conflicts on the scan lock \\n \\n\\n\\n \\n\\t ensured that OpenBTree.test_errors() would save the position if \\n    the condition that is simulated would have resulted in the \\n    position being saved \\n \\n\\n\\n \\n\\t verified that the existing savePosition methods could be removed, \\n    as I indicated in the previous comment, and removed the \\n    methods. This also made it possible to remove the methods from \\n    interfaces and no-op implementations of these methods in other \\n    scan types. \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12651519\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12651519&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12651519\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12651519_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12651519_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Nov\\/08 10:44\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-11-28T10:44:58+0000\'\u003e28\\/Nov\\/08 10:44\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHere\'s a new update (preview-1c).\u003c\\/p\u003e\\n\\n\u003cp\u003eIn this patch, I have removed the locking of the scan protection\u003cbr\\/\u003e\\nhandle completely. This also led to the removal of some debug code\u003cbr\\/\u003e\\nused to simulate wait and\\/or deadlock when locking the scan, and\u003cbr\\/\u003e\\ntherefore the test cases in T_b2i that expected this debug code to\u003cbr\\/\u003e\\nrun also had to be removed.\u003c\\/p\u003e\\n\\n\u003cp\u003eI ran some simple performance tests to get an impression of how the\u003cbr\\/\u003e\\nperformance is affected (used o.a.derbyTesting.perf.clients.Runner).\u003c\\/p\u003e\\n\\n\u003cp\u003eFor single-record selects on primary key (-load sr_select) the\u003cbr\\/\u003e\\nthroughput was increased by 5-10%. I suppose this improvement is seen\u003cbr\\/\u003e\\nbecause we no longer spend any time on obtaining and releasing the\u003cbr\\/\u003e\\nscan locks. And since there\'s no saving of position or repositioning\u003cbr\\/\u003e\\nhappening with this load, no extra overhead is introduced.\u003c\\/p\u003e\\n\\n\u003cp\u003eFor 1000x10000 index joins (-load index_join) the throughput was down\u003cbr\\/\u003e\\n15% (single-threaded) to 45% (multi-threaded). These operations\u003cbr\\/\u003e\\nrelease the latch on the leaf frequently (once every 16 rows in the\u003cbr\\/\u003e\\nindex scans), which would mean that a costly renavigation in the\u003cbr\\/\u003e\\nB-tree would happen very often. Additionally, the renavigation would\u003cbr\\/\u003e\\nincrease the contention on the root node of the B-tree, which is\u003cbr\\/\u003e\\nprobably why the performance drop is greater in the multi-threaded\u003cbr\\/\u003e\\nscenario.\u003c\\/p\u003e\\n\\n\u003cp\u003eSince some operations may see a significant performance drop, I think\u003cbr\\/\u003e\\nthe previously discussed optimization to prevent unnecessary\u003cbr\\/\u003e\\nrenavigation needs to be implemented before we can consider the patch\u003cbr\\/\u003e\\nready for commit.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe patch is starting to get big, but I\'m not sure how to split it up\u003cbr\\/\u003e\\nin smaller increments without temporarily degrading the performance of\u003cbr\\/\u003e\\nthe trunk. The patch currently removes a lot more code than it adds,\u003cbr\\/\u003e\\nthough, so the size of the patch doesn\'t tell the whole truth. The\u003cbr\\/\u003e\\ninserted\\/deleted ratio is about 1\\/7, as seen by\u003c\\/p\u003e\\n\\n\u003cp\u003e$ svn diff | diffstat | tail -1\u003cbr\\/\u003e\\n 27 files changed, 196 insertions\u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/add.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e, 1410 deletions\u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/forbidden.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'ll be away next week and will probably not have much time to work on\u003cbr\\/\u003e\\nthis issue, but I will read my mail and try to answer questions.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12651519_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12651519_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Nov\\/08 10:44\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-11-28T10:44:58+0000\'\u003e28\\/Nov\\/08 10:44\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Here\'s a new update (preview-1c). \\n\\n In this patch, I have removed the locking of the scan protection \\nhandle completely. This also led to the removal of some debug code \\nused to simulate wait and\\/or deadlock when locking the scan, and \\ntherefore the test cases in T_b2i that expected this debug code to \\nrun also had to be removed. \\n\\n I ran some simple performance tests to get an impression of how the \\nperformance is affected (used o.a.derbyTesting.perf.clients.Runner). \\n\\n For single-record selects on primary key (-load sr_select) the \\nthroughput was increased by 5-10%. I suppose this improvement is seen \\nbecause we no longer spend any time on obtaining and releasing the \\nscan locks. And since there\'s no saving of position or repositioning \\nhappening with this load, no extra overhead is introduced. \\n\\n For 1000x10000 index joins (-load index_join) the throughput was down \\n15% (single-threaded) to 45% (multi-threaded). These operations \\nrelease the latch on the leaf frequently (once every 16 rows in the \\nindex scans), which would mean that a costly renavigation in the \\nB-tree would happen very often. Additionally, the renavigation would \\nincrease the contention on the root node of the B-tree, which is \\nprobably why the performance drop is greater in the multi-threaded \\nscenario. \\n\\n Since some operations may see a significant performance drop, I think \\nthe previously discussed optimization to prevent unnecessary \\nrenavigation needs to be implemented before we can consider the patch \\nready for commit. \\n\\n The patch is starting to get big, but I\'m not sure how to split it up \\nin smaller increments without temporarily degrading the performance of \\nthe trunk. The patch currently removes a lot more code than it adds, \\nthough, so the size of the patch doesn\'t tell the whole truth. The \\ninserted\\/deleted ratio is about 1\\/7, as seen by \\n\\n $ svn diff | diffstat | tail -1 \\n 27 files changed, 196 insertions , 1410 deletions  \\n\\n I\'ll be away next week and will probably not have much time to work on \\nthis issue, but I will read my mail and try to answer questions.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12651592\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12651592&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12651592\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12651592_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12651592_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Nov\\/08 16:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-11-28T16:12:32+0000\'\u003e28\\/Nov\\/08 16:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks for running the performance tests. It seems like the cases\u003cbr\\/\u003e\\nwhere you are seeing some performance problems are mostly those\u003cbr\\/\u003e\\ncases where the deadlocks were occurring. Since a small\u003cbr\\/\u003e\\nperformance penalty is vastly superior to a deadlock, I think it would\u003cbr\\/\u003e\\nbe reasonable to accept that penalty if the deadlocks are greatly\u003cbr\\/\u003e\\nreduced or (hopefully) eliminated.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12651592_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12651592_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Nov\\/08 16:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-11-28T16:12:32+0000\'\u003e28\\/Nov\\/08 16:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks for running the performance tests. It seems like the cases \\nwhere you are seeing some performance problems are mostly those \\ncases where the deadlocks were occurring. Since a small \\nperformance penalty is vastly superior to a deadlock, I think it would \\nbe reasonable to accept that penalty if the deadlocks are greatly \\nreduced or (hopefully) eliminated.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12652417\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12652417&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12652417\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12652417_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12652417_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Dec\\/08 16:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-02T16:12:01+0000\'\u003e02\\/Dec\\/08 16:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI agree that the overhead would be acceptable if it had (almost) only\u003cbr\\/\u003e\\naffected those situations where a deadlock could occur, but now\u003cbr\\/\u003e\\nthere\'s an overhead in other situations as well.\u003c\\/p\u003e\\n\\n\u003cp\u003eA B-tree scan may release the latch on the current leaf page in the\u003cbr\\/\u003e\\nfollowing situations:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) When a lock cannot be obtained without waiting\u003c\\/p\u003e\\n\\n\u003cp\u003e2) When no more rows should be returned by the scan (current key &gt;\u003cbr\\/\u003e\\nstop key)\u003c\\/p\u003e\\n\\n\u003cp\u003e3) After a bulk fetch (where a bulk contains from 1 row to 16 rows)\u003c\\/p\u003e\\n\\n\u003cp\u003e4) When the end of the current leaf has been reached and the next leaf\u003cbr\\/\u003e\\nhas been latched\u003c\\/p\u003e\\n\\n\u003cp\u003eWith the latest patch, we save the current position by key in (1) and\u003cbr\\/\u003e\\n(3). In (2) it\'s not needed because the scan is complete and no\u003cbr\\/\u003e\\nrepositioning will ever be attempted. In (4) it\'s not needed since\u003cbr\\/\u003e\\nwe\'re now successfully positioned on the first row on the next page.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe only situation in which a deadlock can occur, is (1), but we\u003cbr\\/\u003e\\ncurrently always reposition by renavigating the B-tree after having\u003cbr\\/\u003e\\nsaved the position by key, so the overhead is also seen in\u003cbr\\/\u003e\\n(3). Unfortunately, almost any query that reads more than 16 rows from\u003cbr\\/\u003e\\nan index will be hit by this.\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'m planning to update the experimental patch with the discussed\u003cbr\\/\u003e\\noptimization so that we don\'t need to renavigate the B-tree when\u003cbr\\/\u003e\\nrepositioning in the common case. If that\'s successful, we can revisit\u003cbr\\/\u003e\\nwhether the patch should be split and reviewed\\/committed in smaller\u003cbr\\/\u003e\\npieces. If we have a proof of concept in place that shows that the\u003cbr\\/\u003e\\nperformance issues are solvable, it might be acceptable to commit a\u003cbr\\/\u003e\\npartial solution that causes performance regressions for some\u003cbr\\/\u003e\\noperations for a shorter period of time (a week or so) before we\u003cbr\\/\u003e\\ncommit the final patch.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12652417_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12652417_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Dec\\/08 16:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-02T16:12:01+0000\'\u003e02\\/Dec\\/08 16:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I agree that the overhead would be acceptable if it had (almost) only \\naffected those situations where a deadlock could occur, but now \\nthere\'s an overhead in other situations as well. \\n\\n A B-tree scan may release the latch on the current leaf page in the \\nfollowing situations: \\n\\n 1) When a lock cannot be obtained without waiting \\n\\n 2) When no more rows should be returned by the scan (current key &gt; \\nstop key) \\n\\n 3) After a bulk fetch (where a bulk contains from 1 row to 16 rows) \\n\\n 4) When the end of the current leaf has been reached and the next leaf \\nhas been latched \\n\\n With the latest patch, we save the current position by key in (1) and \\n(3). In (2) it\'s not needed because the scan is complete and no \\nrepositioning will ever be attempted. In (4) it\'s not needed since \\nwe\'re now successfully positioned on the first row on the next page. \\n\\n The only situation in which a deadlock can occur, is (1), but we \\ncurrently always reposition by renavigating the B-tree after having \\nsaved the position by key, so the overhead is also seen in \\n(3). Unfortunately, almost any query that reads more than 16 rows from \\nan index will be hit by this. \\n\\n I\'m planning to update the experimental patch with the discussed \\noptimization so that we don\'t need to renavigate the B-tree when \\nrepositioning in the common case. If that\'s successful, we can revisit \\nwhether the patch should be split and reviewed\\/committed in smaller \\npieces. If we have a proof of concept in place that shows that the \\nperformance issues are solvable, it might be acceptable to commit a \\npartial solution that causes performance regressions for some \\noperations for a shorter period of time (a week or so) before we \\ncommit the final patch.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12652969\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12652969&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12652969\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"kmarsden\\\" id=\\\"commentauthor_12652969_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=kmarsden\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"kmarsden\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Kathey Marsden\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12652969_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Dec\\/08 20:56\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-03T20:56:23+0000\'\u003e03\\/Dec\\/08 20:56\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks Knut for working on this issue.  I know it is important to several users.    For one of those users, Myrna backported the 1c patch  along with the fix for \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-2878\\\" title=\\\"Scan protection handle could be cached in BasePage\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-2878\\\"\u003e\u003cdel\u003eDERBY-2878\u003c\\/del\u003e\u003c\\/a\u003e to 10.3  to try out (Thanks Myrna).  The user reported that it resolved all of their lock timeouts due to this issue and passed their regression tests.  So great work Knut!    We also have a request to backport this once done all the way to 10.1 for a user locked into that version.  So my questions are:\u003c\\/p\u003e\\n\\n\u003cp\u003e1)  Do you have any kind of general estimate when the final patch might be ready for trunk?\u003cbr\\/\u003e\\n2)  Do you have any reservations or concerns about my trying to backport the fix once complete to older codelines? Do you know if that is even feasible for 10.1?\u003cbr\\/\u003e\\n3) Is there anything that I can do to help with this issue?\u003c\\/p\u003e\\n\\n\u003cp\u003eThanks\u003c\\/p\u003e\\n\\n\u003cp\u003eKathey\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"kmarsden\\\" id=\\\"commentauthor_12652969_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=kmarsden\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"kmarsden\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Kathey Marsden\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12652969_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Dec\\/08 20:56\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-03T20:56:23+0000\'\u003e03\\/Dec\\/08 20:56\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks Knut for working on this issue.  I know it is important to several users.    For one of those users, Myrna backported the 1c patch  along with the fix for   DERBY-2878   to 10.3  to try out (Thanks Myrna).  The user reported that it resolved all of their lock timeouts due to this issue and passed their regression tests.  So great work Knut!    We also have a request to backport this once done all the way to 10.1 for a user locked into that version.  So my questions are: \\n\\n 1)  Do you have any kind of general estimate when the final patch might be ready for trunk? \\n2)  Do you have any reservations or concerns about my trying to backport the fix once complete to older codelines? Do you know if that is even feasible for 10.1? \\n3) Is there anything that I can do to help with this issue? \\n\\n Thanks \\n\\n Kathey \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12652990\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12652990&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12652990\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_12652990_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12652990_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Dec\\/08 21:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-03T21:49:24+0000\'\u003e03\\/Dec\\/08 21:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI am concerned about performance of always saving full key.  This is going to cause both cpu and memory problems(garbage collection).  As originally designed it was expected that this path would be rare so no optimization was ever done.  The save by id path was the one optimized.\u003c\\/p\u003e\\n\\n\u003cp\u003eDid you ever consider fixing by only changing the deadlock case, ie always giving up the scan position lock when one has to wait on a lock?  This case should be rare, compared with the very normal case of group scan which happens by default for any scan of btree returning more than 16 rows for one query.\u003c\\/p\u003e\\n\\n\u003cp\u003esorry for late comment, was out on vacation when you started on this.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_12652990_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12652990_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Dec\\/08 21:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-03T21:49:24+0000\'\u003e03\\/Dec\\/08 21:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I am concerned about performance of always saving full key.  This is going to cause both cpu and memory problems(garbage collection).  As originally designed it was expected that this path would be rare so no optimization was ever done.  The save by id path was the one optimized. \\n\\n Did you ever consider fixing by only changing the deadlock case, ie always giving up the scan position lock when one has to wait on a lock?  This case should be rare, compared with the very normal case of group scan which happens by default for any scan of btree returning more than 16 rows for one query. \\n\\n sorry for late comment, was out on vacation when you started on this.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12653039\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12653039&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12653039\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_12653039_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12653039_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Dec\\/08 23:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-03T23:12:34+0000\'\u003e03\\/Dec\\/08 23:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAfter reviewing the current patch, this does not look like a change appropriate for a backport.  It is already 5000 lines of diffs and changes a basic concurrency building block of the btree code.  Getting rid of the scan lock if it can be done with little or no performance penality does look like a good feature for a major release.  It will simplify a lot of code, but would like to see a lot of testing before it gets into an official derby release.  \u003c\\/p\u003e\\n\\n\u003cp\u003eI do agree this is a good direction.  Some of the code that originally depended on the scan protection lock no longer needs to as part of work that was later done to support the read uncommitted isolation level.  Off the top of my head my areas of concern would be that the following operations work correctly in all combinations without the concurrency protection provided by the scan protection lock (I think they are ok as they should be protected by latches, but just get worried removing locking from these operations):\u003cbr\\/\u003e\\nsplit\u003cbr\\/\u003e\\nmerge\u003cbr\\/\u003e\\nreclaim deleted rows\u003c\\/p\u003e\\n\\n\u003cp\u003eAnother area that might be worth thinking about is to make sure the code that get\'s previous key locks for serializable is still right without the scan protection lock.  Need to make sure an intervening split which previously was not possible does not break this code.\u003c\\/p\u003e\\n\\n\u003cp\u003eThis stuff is hard to test for, I will think about these operations and see if there is any hidden dependency or if they only got the scan protection lock to enable the scan optimization. \u003c\\/p\u003e\\n\\n\u003cp\u003eI definitely do worry about having to copy around the full key every time one gives up the latch.  Given the current store interface we can\'t keep references so we have to allocate \u003cbr\\/\u003e\\nobjects.  This in the worst case can lead to allocation\\/copies for every index reference in a query and can quickly add up which was why the additional complicaiton of the scan lock was added in the first place.  It would be interesting to understand the performance overhead of the copy vs. the extra search.  As I understand it the proposed optimization would in the \\\"usual\\\" case as long as the page remained in memory eliminate the scan but would not eliminate the copy.   Probably the worst case is long keys (maybe multi-part) and maybe datatypes that require object allocations every time they are copied (like decimal).\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_12653039_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12653039_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Dec\\/08 23:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-03T23:12:34+0000\'\u003e03\\/Dec\\/08 23:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    After reviewing the current patch, this does not look like a change appropriate for a backport.  It is already 5000 lines of diffs and changes a basic concurrency building block of the btree code.  Getting rid of the scan lock if it can be done with little or no performance penality does look like a good feature for a major release.  It will simplify a lot of code, but would like to see a lot of testing before it gets into an official derby release.   \\n\\n I do agree this is a good direction.  Some of the code that originally depended on the scan protection lock no longer needs to as part of work that was later done to support the read uncommitted isolation level.  Off the top of my head my areas of concern would be that the following operations work correctly in all combinations without the concurrency protection provided by the scan protection lock (I think they are ok as they should be protected by latches, but just get worried removing locking from these operations): \\nsplit \\nmerge \\nreclaim deleted rows \\n\\n Another area that might be worth thinking about is to make sure the code that get\'s previous key locks for serializable is still right without the scan protection lock.  Need to make sure an intervening split which previously was not possible does not break this code. \\n\\n This stuff is hard to test for, I will think about these operations and see if there is any hidden dependency or if they only got the scan protection lock to enable the scan optimization.  \\n\\n I definitely do worry about having to copy around the full key every time one gives up the latch.  Given the current store interface we can\'t keep references so we have to allocate  \\nobjects.  This in the worst case can lead to allocation\\/copies for every index reference in a query and can quickly add up which was why the additional complicaiton of the scan lock was added in the first place.  It would be interesting to understand the performance overhead of the copy vs. the extra search.  As I understand it the proposed optimization would in the \\\"usual\\\" case as long as the page remained in memory eliminate the scan but would not eliminate the copy.   Probably the worst case is long keys (maybe multi-part) and maybe datatypes that require object allocations every time they are copied (like decimal).              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12653364\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12653364&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12653364\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12653364_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12653364_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Dec\\/08 17:07\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-04T17:07:31+0000\'\u003e04\\/Dec\\/08 17:07\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks to all of you for looking at this.\u003c\\/p\u003e\\n\\n\u003cp\u003eTo Kathey\'s questions, I will get back to working on this issue next\u003cbr\\/\u003e\\nweek and hope to have optimized the patch further and tested it some\u003cbr\\/\u003e\\nmore by the end of that week. It\'s difficult to say when a fix can be\u003cbr\\/\u003e\\ncommitted to trunk, as it depends on whether we find the suggested\u003cbr\\/\u003e\\napproach acceptable or if we need to find another way to fix it. And\u003cbr\\/\u003e\\nas Mike mentioned more testing is needed in any case. I do hope we can\u003cbr\\/\u003e\\ncome up with an approach everyone feels comfortable with in the next\u003cbr\\/\u003e\\ncouple of weeks before the holiday season, and then get it implemented\u003cbr\\/\u003e\\nand properly tested in January. I agree with Mike though, that it\'s\u003cbr\\/\u003e\\nprobably too risky to backport the fix, unless we end up with\u003cbr\\/\u003e\\nsomething simpler than the current proposal. Not that I\'m planning to\u003cbr\\/\u003e\\nintroduce any bugs, but since it changes some fundamental assumptions\u003cbr\\/\u003e\\nin a critical part of the system, I wouldn\'t feel all that comfortable\u003cbr\\/\u003e\\nwith backporting it.\u003c\\/p\u003e\\n\\n\u003cp\u003eTo Mike\'s questions:\u003c\\/p\u003e\\n\\n\u003cp\u003eYes, I think it is possible to only save the position in situations\u003cbr\\/\u003e\\nthat could cause deadlocks. That would mean that we only save the\u003cbr\\/\u003e\\nposition if we need to wait for a lock. One possible complication is\u003cbr\\/\u003e\\nthat it\'s not necessarily the scan that\'s waiting for a lock that\'s\u003cbr\\/\u003e\\nholding the scan lock that causes the deadlock. Therefore we would\u003cbr\\/\u003e\\nneed to save the position in all the open B-tree scans in the\u003cbr\\/\u003e\\ntransaction when a lock cannot be granted immediately. And this must\u003cbr\\/\u003e\\nbe done for all locks that we wait on, not only locks in B-tree scans,\u003cbr\\/\u003e\\nso it will add complexity to code outside the B-tree code as\u003cbr\\/\u003e\\nwell. Given that this increases the complexity and removing the scan\u003cbr\\/\u003e\\nlocks reduces the complexity, I\'d prefer a solution where the scan\u003cbr\\/\u003e\\nlocks are removed completely if it can be done with acceptable\u003cbr\\/\u003e\\nperformance.\u003c\\/p\u003e\\n\\n\u003cp\u003eAs to the performance, I hope that it will be possible to measure the\u003cbr\\/\u003e\\nactual cost of copying the key once I have removed the expensive and\u003cbr\\/\u003e\\nunnecessary renavigation. You are right that the suggested\u003cbr\\/\u003e\\noptimization will only save the renavigation, not the copying. Some\u003cbr\\/\u003e\\nthoughts\\/guesses:\u003c\\/p\u003e\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eThe current code that saves the key always allocates a new\u003cbr\\/\u003e\\n    DataValueDescriptor array and populates it with empty\u003cbr\\/\u003e\\n    DataValueDescriptors of the correct type. It shouldn\'t be\u003cbr\\/\u003e\\n    necessary to do this more than once per scan. That could save much\u003cbr\\/\u003e\\n    allocation\\/gc work.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eWhen we save the key, we retrieve it by calling fetchFromSlot(),\u003cbr\\/\u003e\\n    which will deserialize the value of the key from the page. I think\u003cbr\\/\u003e\\n    that this is causing the same work to be performed twice when we\u003cbr\\/\u003e\\n    save the position in methods like BTreeForwardScan.fetchRows(), at\u003cbr\\/\u003e\\n    least when the scan is returning the full key, and we could\u003cbr\\/\u003e\\n    probably make this more efficient.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eWhat we save by not obtaining\\/releasing the scan lock includes 2-3\u003cbr\\/\u003e\\n    lookups in a global hashtable per leaf page, which could give an\u003cbr\\/\u003e\\n    extra benefit in a multi-threaded scenario.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eIt\'s not clear to me that the size of the key is significant. The\u003cbr\\/\u003e\\n    cost of the scan lock is constant per page. Since a bigger key\u003cbr\\/\u003e\\n    means fewer keys per page, the cost of copying keys should also be\u003cbr\\/\u003e\\n    more or less constant per page. So the ratio between the cost\u003cbr\\/\u003e\\n    saved and the cost added may not be that much affected by the size\u003cbr\\/\u003e\\n    of the key.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eOne of the worst cases is probably where extra qualification of\u003cbr\\/\u003e\\n    the row is needed. Like \\\"SELECT index_column FROM t WHERE\u003cbr\\/\u003e\\n    length(index_column) = 10\\\", in which case I think we\'ll release\u003cbr\\/\u003e\\n    the latch, and therefore also save the key, for every row in the\u003cbr\\/\u003e\\n    index.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eThe suggestions for new tests look reasonable to me. The current\u003cbr\\/\u003e\\nregression tests probably don\'t test that the current position has\u003cbr\\/\u003e\\nbeen moved to another page while we didn\'t hold the latch, since those\u003cbr\\/\u003e\\nsituations would have resulted in a lock timeout before. So we\u003cbr\\/\u003e\\nbasically need to have tests for split\\/merge\\/reclaim for every call to\u003cbr\\/\u003e\\nreposition() in the code. Will need to think more about how to do\u003cbr\\/\u003e\\nthat. Thanks for raising the concern for the previous key locking as\u003cbr\\/\u003e\\nwell.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12653364_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12653364_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Dec\\/08 17:07\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-04T17:07:31+0000\'\u003e04\\/Dec\\/08 17:07\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks to all of you for looking at this. \\n\\n To Kathey\'s questions, I will get back to working on this issue next \\nweek and hope to have optimized the patch further and tested it some \\nmore by the end of that week. It\'s difficult to say when a fix can be \\ncommitted to trunk, as it depends on whether we find the suggested \\napproach acceptable or if we need to find another way to fix it. And \\nas Mike mentioned more testing is needed in any case. I do hope we can \\ncome up with an approach everyone feels comfortable with in the next \\ncouple of weeks before the holiday season, and then get it implemented \\nand properly tested in January. I agree with Mike though, that it\'s \\nprobably too risky to backport the fix, unless we end up with \\nsomething simpler than the current proposal. Not that I\'m planning to \\nintroduce any bugs, but since it changes some fundamental assumptions \\nin a critical part of the system, I wouldn\'t feel all that comfortable \\nwith backporting it. \\n\\n To Mike\'s questions: \\n\\n Yes, I think it is possible to only save the position in situations \\nthat could cause deadlocks. That would mean that we only save the \\nposition if we need to wait for a lock. One possible complication is \\nthat it\'s not necessarily the scan that\'s waiting for a lock that\'s \\nholding the scan lock that causes the deadlock. Therefore we would \\nneed to save the position in all the open B-tree scans in the \\ntransaction when a lock cannot be granted immediately. And this must \\nbe done for all locks that we wait on, not only locks in B-tree scans, \\nso it will add complexity to code outside the B-tree code as \\nwell. Given that this increases the complexity and removing the scan \\nlocks reduces the complexity, I\'d prefer a solution where the scan \\nlocks are removed completely if it can be done with acceptable \\nperformance. \\n\\n As to the performance, I hope that it will be possible to measure the \\nactual cost of copying the key once I have removed the expensive and \\nunnecessary renavigation. You are right that the suggested \\noptimization will only save the renavigation, not the copying. Some \\nthoughts\\/guesses: \\n\\n \\n\\t The current code that saves the key always allocates a new \\n    DataValueDescriptor array and populates it with empty \\n    DataValueDescriptors of the correct type. It shouldn\'t be \\n    necessary to do this more than once per scan. That could save much \\n    allocation\\/gc work. \\n \\n\\n\\n \\n\\t When we save the key, we retrieve it by calling fetchFromSlot(), \\n    which will deserialize the value of the key from the page. I think \\n    that this is causing the same work to be performed twice when we \\n    save the position in methods like BTreeForwardScan.fetchRows(), at \\n    least when the scan is returning the full key, and we could \\n    probably make this more efficient. \\n \\n\\n\\n \\n\\t What we save by not obtaining\\/releasing the scan lock includes 2-3 \\n    lookups in a global hashtable per leaf page, which could give an \\n    extra benefit in a multi-threaded scenario. \\n \\n\\n\\n \\n\\t It\'s not clear to me that the size of the key is significant. The \\n    cost of the scan lock is constant per page. Since a bigger key \\n    means fewer keys per page, the cost of copying keys should also be \\n    more or less constant per page. So the ratio between the cost \\n    saved and the cost added may not be that much affected by the size \\n    of the key. \\n \\n\\n\\n \\n\\t One of the worst cases is probably where extra qualification of \\n    the row is needed. Like \\\"SELECT index_column FROM t WHERE \\n    length(index_column) = 10\\\", in which case I think we\'ll release \\n    the latch, and therefore also save the key, for every row in the \\n    index. \\n \\n\\n\\n The suggestions for new tests look reasonable to me. The current \\nregression tests probably don\'t test that the current position has \\nbeen moved to another page while we didn\'t hold the latch, since those \\nsituations would have resulted in a lock timeout before. So we \\nbasically need to have tests for split\\/merge\\/reclaim for every call to \\nreposition() in the code. Will need to think more about how to do \\nthat. Thanks for raising the concern for the previous key locking as \\nwell.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12657001\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12657001&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12657001\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12657001_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12657001_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Dec\\/08 14:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-16T14:57:01+0000\'\u003e16\\/Dec\\/08 14:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAttaching a new preview patch (1d) that implements the optimization\u003cbr\\/\u003e\\nwhich prevents the expensive repositioning when no rows have been\u003cbr\\/\u003e\\nmoved off the page. I haven\'t done any serious testing of the\u003cbr\\/\u003e\\ncorrectness in all scenarios, I\'m just posting it so that we can get\u003cbr\\/\u003e\\nmore information about the performance impact of saving the position.\u003c\\/p\u003e\\n\\n\u003cp\u003eAs an initial test, I reran the index-join test that I mentioned\u003cbr\\/\u003e\\nearlier and that showed a significant decrease in performance with the\u003cbr\\/\u003e\\npreview-1c patch. With the preview-1d patch, I\'m not able to see any\u003cbr\\/\u003e\\ndecrease (the numbers are actually slightly better with the 1d patch\u003cbr\\/\u003e\\nthan with trunk, though I\'m not sure whether it\'s significant). Below\u003cbr\\/\u003e\\nare the results for 1, 2, 4, 8 and 16 concurrent threads for the 1d\u003cbr\\/\u003e\\npatch (rows prefixed with \'d2991\') and trunk (rows prefixed with\u003cbr\\/\u003e\\n\'trunk\'). The AVG_TPS column shows the number of transactions per\u003cbr\\/\u003e\\nsecond, all configurations were run 30 times (each test run had 30 sec\u003cbr\\/\u003e\\nwarmup and 45 sec steady state) and the AVG_TPS column shows the\u003cbr\\/\u003e\\naverage from the 30 runs.\u003c\\/p\u003e\\n\\n\u003cp\u003eJAR       |THREADS    |AVG_TPS               \u003cbr\\/\u003e\\n---------------------------------------------\u003cbr\\/\u003e\\nd2991     |1          |136.3599695946353     \u003cbr\\/\u003e\\ntrunk     |1          |136.0475449900022     \u003cbr\\/\u003e\\nd2991     |2          |265.9779264453826     \u003cbr\\/\u003e\\ntrunk     |2          |262.8875064800415     \u003cbr\\/\u003e\\nd2991     |4          |262.95638006368955    \u003cbr\\/\u003e\\ntrunk     |4          |255.46471154558247    \u003cbr\\/\u003e\\nd2991     |8          |256.97232845038025    \u003cbr\\/\u003e\\ntrunk     |8          |252.92527586462265    \u003cbr\\/\u003e\\nd2991     |16         |256.84847624018147    \u003cbr\\/\u003e\\ntrunk     |16         |254.06894019626188    \u003c\\/p\u003e\\n\\n\u003cp\u003eI will see if I can write some more specific tests that test the other\u003cbr\\/\u003e\\npossible worst-case scenarios suggested in earlier comments.\u003c\\/p\u003e\\n\\n\u003cp\u003eWhat the patch does, is that it saves the version of the page in the\u003cbr\\/\u003e\\nBTreeRowPosition object before it saves the page, and each time rows\u003cbr\\/\u003e\\ncan be moved off the page (in operations that previously acquired an\u003cbr\\/\u003e\\nexclusive scan lock) this is flagged in the in-memory representation\u003cbr\\/\u003e\\nof the page. BTreeScan.reposition() will first match the version in\u003cbr\\/\u003e\\nBTreeRowPosition with the flagged version number on the page, and will\u003cbr\\/\u003e\\nonly reposition by key if the page has been flagged after the position\u003cbr\\/\u003e\\nwas saved. Pages are automatically flagged with the current version\u003cbr\\/\u003e\\nwhen they are fetched into the cache, so we\'ll always reposition by\u003cbr\\/\u003e\\nkey if the page has been evicted from the cache after we saved the\u003cbr\\/\u003e\\nposition.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe patch also makes savePosition() reuse the DataValueDescriptor\u003cbr\\/\u003e\\nobject in which the key is stored, so that it\'s only allocated once\u003cbr\\/\u003e\\nper scan.\u003c\\/p\u003e\\n\\n\u003cp\u003eCurrently, the patch does not handle the case where the page has\u003cbr\\/\u003e\\ndisappeared when we reposition (only happens with holdable cursors\u003cbr\\/\u003e\\nafter a commit followed by truncate table, I think) or the case where\u003cbr\\/\u003e\\nthe leaf page has turned into a branch page while we waited. These\u003cbr\\/\u003e\\nproblems led to four failures in derbyall and four failures in\u003cbr\\/\u003e\\nsuites.All.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12657001_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12657001_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Dec\\/08 14:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-16T14:57:01+0000\'\u003e16\\/Dec\\/08 14:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Attaching a new preview patch (1d) that implements the optimization \\nwhich prevents the expensive repositioning when no rows have been \\nmoved off the page. I haven\'t done any serious testing of the \\ncorrectness in all scenarios, I\'m just posting it so that we can get \\nmore information about the performance impact of saving the position. \\n\\n As an initial test, I reran the index-join test that I mentioned \\nearlier and that showed a significant decrease in performance with the \\npreview-1c patch. With the preview-1d patch, I\'m not able to see any \\ndecrease (the numbers are actually slightly better with the 1d patch \\nthan with trunk, though I\'m not sure whether it\'s significant). Below \\nare the results for 1, 2, 4, 8 and 16 concurrent threads for the 1d \\npatch (rows prefixed with \'d2991\') and trunk (rows prefixed with \\n\'trunk\'). The AVG_TPS column shows the number of transactions per \\nsecond, all configurations were run 30 times (each test run had 30 sec \\nwarmup and 45 sec steady state) and the AVG_TPS column shows the \\naverage from the 30 runs. \\n\\n JAR       |THREADS    |AVG_TPS                \\n--------------------------------------------- \\nd2991     |1          |136.3599695946353      \\ntrunk     |1          |136.0475449900022      \\nd2991     |2          |265.9779264453826      \\ntrunk     |2          |262.8875064800415      \\nd2991     |4          |262.95638006368955     \\ntrunk     |4          |255.46471154558247     \\nd2991     |8          |256.97232845038025     \\ntrunk     |8          |252.92527586462265     \\nd2991     |16         |256.84847624018147     \\ntrunk     |16         |254.06894019626188     \\n\\n I will see if I can write some more specific tests that test the other \\npossible worst-case scenarios suggested in earlier comments. \\n\\n What the patch does, is that it saves the version of the page in the \\nBTreeRowPosition object before it saves the page, and each time rows \\ncan be moved off the page (in operations that previously acquired an \\nexclusive scan lock) this is flagged in the in-memory representation \\nof the page. BTreeScan.reposition() will first match the version in \\nBTreeRowPosition with the flagged version number on the page, and will \\nonly reposition by key if the page has been flagged after the position \\nwas saved. Pages are automatically flagged with the current version \\nwhen they are fetched into the cache, so we\'ll always reposition by \\nkey if the page has been evicted from the cache after we saved the \\nposition. \\n\\n The patch also makes savePosition() reuse the DataValueDescriptor \\nobject in which the key is stored, so that it\'s only allocated once \\nper scan. \\n\\n Currently, the patch does not handle the case where the page has \\ndisappeared when we reposition (only happens with holdable cursors \\nafter a commit followed by truncate table, I think) or the case where \\nthe leaf page has turned into a branch page while we waited. These \\nproblems led to four failures in derbyall and four failures in \\nsuites.All.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12657838\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12657838&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12657838\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12657838_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12657838_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Dec\\/08 18:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-18T18:16:05+0000\'\u003e18\\/Dec\\/08 18:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHere\'s a small performance test that I wrote. It extends the JDBCPerfTestCase class in the JUnit framework. All the tests use a table with 1000 rows. The table has 13 columns: one VARCHAR(10), one VARCHAR(100), one VARCHAR(1000) and ten DECIMAL(10,10). Each single VARCHAR column has an index, one compound index is covering all the VARCHAR columns, there\'s an index on one of the DECIMAL columns, and there\'s one covering all the DECIMAL columns. For each index, there\'s a test case that simply runs through the entire index.\u003c\\/p\u003e\\n\\n\u003cp\u003eAfter a couple of repeated runs I can\'t say that saving the position looks more expensive than locking the scan. Actually, the tests appear to perform slightly better when the position is saved, at least that\'s what it looks like in my environment (OpenSolaris 2008.11, Java 1.6.0_10). (Except that in some cases it fails because the JUnit framework compresses all the tables before starting the test, and the problem with pages changing from leaf to branch mentioned in my previous comment surfaces.) I\'ll need to run the tests more in order to say anything for sure. I will do that and report back.\u003c\\/p\u003e\\n\\n\u003cp\u003eDoes anyone have suggestions for any other performance tests we should run to check if this is an appropriate path to follow?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12657838_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12657838_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Dec\\/08 18:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-18T18:16:05+0000\'\u003e18\\/Dec\\/08 18:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Here\'s a small performance test that I wrote. It extends the JDBCPerfTestCase class in the JUnit framework. All the tests use a table with 1000 rows. The table has 13 columns: one VARCHAR(10), one VARCHAR(100), one VARCHAR(1000) and ten DECIMAL(10,10). Each single VARCHAR column has an index, one compound index is covering all the VARCHAR columns, there\'s an index on one of the DECIMAL columns, and there\'s one covering all the DECIMAL columns. For each index, there\'s a test case that simply runs through the entire index. \\n\\n After a couple of repeated runs I can\'t say that saving the position looks more expensive than locking the scan. Actually, the tests appear to perform slightly better when the position is saved, at least that\'s what it looks like in my environment (OpenSolaris 2008.11, Java 1.6.0_10). (Except that in some cases it fails because the JUnit framework compresses all the tables before starting the test, and the problem with pages changing from leaf to branch mentioned in my previous comment surfaces.) I\'ll need to run the tests more in order to say anything for sure. I will do that and report back. \\n\\n Does anyone have suggestions for any other performance tests we should run to check if this is an appropriate path to follow?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12658152\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12658152&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12658152\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_12658152_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12658152_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Dec\\/08 18:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-19T18:55:18+0000\'\u003e19\\/Dec\\/08 18:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003ethat\'s great news on initial performance comparisons.  \u003c\\/p\u003e\\n\\n\u003cp\u003eI am not sure if the following will do better, but it is what I thought of.  It seems like the worst case would be cases where we move the scan a lot without having latch on page.  ie. case where we get one row at a time from the page.  So I would suggest using the bulk fetch property to only get 1 row at a time:\u003cbr\\/\u003e\\nCALL SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(\'derby.language.bulkFetchDefault\',\'1\');\u003c\\/p\u003e\\n\\n\u003cp\u003e1000 rows does not seem like enough data to do a test.  One of the problems with the new approach, especially with something like decimal is that there is going to be extra object allocation per row.  So you want enough rows to see what effect it might have on GC.  I usually tried to make sure performance test took at least a second, and maybe 60 seconds\u003cbr\\/\u003e\\nfor at least a one time run.  \u003c\\/p\u003e\\n\\n\u003cp\u003eIs a read only test  affected by pages going out of cache?  From your description I don\'t think so unless you get very strange cache behavior in that the scan current page goes out of cache during the scan of that page.  But might be worth showing that a both approaches perform same on a scan of a\u003cbr\\/\u003e\\ntable that is bigger than the cache when the scan is executed multiple times in a row.\u003c\\/p\u003e\\n\\n\\n\u003cp\u003eShould there be something that exercises the worst case where  the page is updated?  Again for this having a bigger dataset wil cause more overhead for the \u003cbr\\/\u003e\\nsearch.   For this maybe something like a 2 part key with first part being as the current test\u003cbr\\/\u003e\\nand the second part being an int and the test runs a cursor through the table and after reading each index row then updates the second part of the key by minus one, likely leaving the key on the same page - but not putting the scan into an infinite loop.   Make sure the cursor choice is one which goes to the table every time, not one that caches the\u003cbr\\/\u003e\\nvalues in the client somehow.   \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_12658152_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12658152_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Dec\\/08 18:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-19T18:55:18+0000\'\u003e19\\/Dec\\/08 18:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    that\'s great news on initial performance comparisons.   \\n\\n I am not sure if the following will do better, but it is what I thought of.  It seems like the worst case would be cases where we move the scan a lot without having latch on page.  ie. case where we get one row at a time from the page.  So I would suggest using the bulk fetch property to only get 1 row at a time: \\nCALL SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(\'derby.language.bulkFetchDefault\',\'1\'); \\n\\n 1000 rows does not seem like enough data to do a test.  One of the problems with the new approach, especially with something like decimal is that there is going to be extra object allocation per row.  So you want enough rows to see what effect it might have on GC.  I usually tried to make sure performance test took at least a second, and maybe 60 seconds \\nfor at least a one time run.   \\n\\n Is a read only test  affected by pages going out of cache?  From your description I don\'t think so unless you get very strange cache behavior in that the scan current page goes out of cache during the scan of that page.  But might be worth showing that a both approaches perform same on a scan of a \\ntable that is bigger than the cache when the scan is executed multiple times in a row. \\n\\n\\n Should there be something that exercises the worst case where  the page is updated?  Again for this having a bigger dataset wil cause more overhead for the  \\nsearch.   For this maybe something like a 2 part key with first part being as the current test \\nand the second part being an int and the test runs a cursor through the table and after reading each index row then updates the second part of the key by minus one, likely leaving the key on the same page - but not putting the scan into an infinite loop.   Make sure the cursor choice is one which goes to the table every time, not one that caches the \\nvalues in the client somehow.                 \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12658493\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12658493&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12658493\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12658493_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12658493_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Dec\\/08 10:21\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-22T10:21:11+0000\'\u003e22\\/Dec\\/08 10:21\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI had the JUnit test running repeatedly over the weekend, 300 times\u003cbr\\/\u003e\\nfor each configuration to get a more reliable average. I\'ve summarized\u003cbr\\/\u003e\\nthe results in the table below. Positive values in the increase column\u003cbr\\/\u003e\\nmeans that trunk is faster, negative values means that the patched\u003cbr\\/\u003e\\nversion is faster.\u003c\\/p\u003e\\n\\n\u003cp\u003eTEST                |TRUNK_TIME |PATCHED_TI&amp;|INCREASE   |INCREASE_PERCENT      \u003cbr\\/\u003e\\n-------------------------------------------------------------------------------\u003cbr\\/\u003e\\ndecimal10columns    |17752      |17761      |9          |0.0506985128436277    \u003cbr\\/\u003e\\ndecimal1column      |4875       |4842       |-33        |-0.676923076923075    \u003cbr\\/\u003e\\nvarchar10           |4586       |4517       |-69        |-1.5045791539467945   \u003cbr\\/\u003e\\nvarchar100          |7288       |7185       |-103       |-1.4132821075740987   \u003cbr\\/\u003e\\nvarchar1000         |35977      |37008      |1031       |2.865719765405683     \u003cbr\\/\u003e\\nvarcharAll          |41502      |42701      |1199       |2.8890173967519583    \u003c\\/p\u003e\\n\\n\u003cp\u003eNot much difference between them. For smaller keys, it seems like\u003cbr\\/\u003e\\nsaving the position is slightly cheaper, whereas for larger keys it\u003cbr\\/\u003e\\nappears to be slightly more expensive.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12658493_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12658493_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Dec\\/08 10:21\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-22T10:21:11+0000\'\u003e22\\/Dec\\/08 10:21\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I had the JUnit test running repeatedly over the weekend, 300 times \\nfor each configuration to get a more reliable average. I\'ve summarized \\nthe results in the table below. Positive values in the increase column \\nmeans that trunk is faster, negative values means that the patched \\nversion is faster. \\n\\n TEST                |TRUNK_TIME |PATCHED_TI&amp;|INCREASE   |INCREASE_PERCENT       \\n------------------------------------------------------------------------------- \\ndecimal10columns    |17752      |17761      |9          |0.0506985128436277     \\ndecimal1column      |4875       |4842       |-33        |-0.676923076923075     \\nvarchar10           |4586       |4517       |-69        |-1.5045791539467945    \\nvarchar100          |7288       |7185       |-103       |-1.4132821075740987    \\nvarchar1000         |35977      |37008      |1031       |2.865719765405683      \\nvarcharAll          |41502      |42701      |1199       |2.8890173967519583     \\n\\n Not much difference between them. For smaller keys, it seems like \\nsaving the position is slightly cheaper, whereas for larger keys it \\nappears to be slightly more expensive.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12658514\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12658514&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12658514\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12658514_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12658514_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Dec\\/08 11:43\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-22T11:43:19+0000\'\u003e22\\/Dec\\/08 11:43\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks for your comments, Mike.\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; I am not sure if the following will do better, but it is what I\u003cbr\\/\u003e\\n&gt; thought of. It seems like the worst case would be cases where we\u003cbr\\/\u003e\\n&gt; move the scan a lot without having latch on page. ie. case where we\u003cbr\\/\u003e\\n&gt; get one row at a time from the page. So I would suggest using the\u003cbr\\/\u003e\\n&gt; bulk fetch property to only get 1 row at a time: CALL\u003cbr\\/\u003e\\n&gt; SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(\'derby.language.bulkFetchDefault\',\'1\');\u003c\\/p\u003e\\n\\n\u003cp\u003eThanks, I wasn\'t aware of that property. I\'ll do some experiments with\u003cbr\\/\u003e\\nit.\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; 1000 rows does not seem like enough data to do a test. One of the\u003cbr\\/\u003e\\n&gt; problems with the new approach, especially with something like\u003cbr\\/\u003e\\n&gt; decimal is that there is going to be extra object allocation per\u003cbr\\/\u003e\\n&gt; row. So you want enough rows to see what effect it might have on\u003cbr\\/\u003e\\n&gt; GC.\u003c\\/p\u003e\\n\\n\u003cp\u003eI picked 1000 rows to make sure that we had at least a couple of full\u003cbr\\/\u003e\\nindex pages in each of the test cases. I assumed that having multiple\u003cbr\\/\u003e\\niterations on a smaller number of rows would have about the same\u003cbr\\/\u003e\\neffect on GC as fewer iterations on a larger data set.\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; I usually tried to make sure performance test took at least a\u003cbr\\/\u003e\\n&gt; second, and maybe 60 seconds for at least a one time run.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe tests mentioned in my previous comment had a fixed number of\u003cbr\\/\u003e\\niterations, so the total time for each test case varied between 20 and\u003cbr\\/\u003e\\n150 seconds depending on key size. (The times in milliseconds in the\u003cbr\\/\u003e\\ntable must be multiplied by four to get the actual time spent because\u003cbr\\/\u003e\\nof the way the framework runs the tests.) I can also try some longer\u003cbr\\/\u003e\\nruns.\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; Is a read only test affected by pages going out of cache? From your\u003cbr\\/\u003e\\n&gt; description I don\'t think so unless you get very strange cache\u003cbr\\/\u003e\\n&gt; behavior in that the scan current page goes out of cache during the\u003cbr\\/\u003e\\n&gt; scan of that page.\u003c\\/p\u003e\\n\\n\u003cp\u003eThat\'s correct. Read only tests should not be affected by pages going\u003cbr\\/\u003e\\nout of the cache. Even if the current page goes out while we don\'t\u003cbr\\/\u003e\\nhold the latch, they shouldn\'t be affected unless there has been a\u003cbr\\/\u003e\\nmodification on the page after the latch was released. In that case\u003cbr\\/\u003e\\nthe page will have the dirty flag in addition to the recently-used\u003cbr\\/\u003e\\nflag, so it\'s highly unlikely that it will be chosen for eviction.\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; But might be worth showing that a both approaches\u003cbr\\/\u003e\\n&gt; perform same on a scan of a table that is bigger than the cache when\u003cbr\\/\u003e\\n&gt; the scan is executed multiple times in a row.\u003c\\/p\u003e\\n\\n\u003cp\u003eGood point. I\'ll run such a test.\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; Should there be something that exercises the worst case where the\u003cbr\\/\u003e\\n&gt; page is updated? Again for this having a bigger dataset wil cause\u003cbr\\/\u003e\\n&gt; more overhead for the search. For this maybe something like a 2 part\u003cbr\\/\u003e\\n&gt; key with first part being as the current test and the second part\u003cbr\\/\u003e\\n&gt; being an int and the test runs a cursor through the table and after\u003cbr\\/\u003e\\n&gt; reading each index row then updates the second part of the key by\u003cbr\\/\u003e\\n&gt; minus one, likely leaving the key on the same page - but not putting\u003cbr\\/\u003e\\n&gt; the scan into an infinite loop. Make sure the cursor choice is one\u003cbr\\/\u003e\\n&gt; which goes to the table every time, not one that caches the values\u003cbr\\/\u003e\\n&gt; in the client somehow.\u003c\\/p\u003e\\n\\n\u003cp\u003eI think I understand what you\'re suggesting, but a couple of questions\u003cbr\\/\u003e\\njust to make sure that I\'m not missing the point:\u003c\\/p\u003e\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003ethe purpose of this test is to check that we don\'t perform any\u003cbr\\/\u003e\\n    repositioning by key just because there has been an update on the\u003cbr\\/\u003e\\n    page?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eby making sure that the client doesn\'t cache the values, you\u003cbr\\/\u003e\\n    basically mean that bulk fetch should be disabled? So setting\u003cbr\\/\u003e\\n    derby.language.bulkFetchDefault or perhaps using an updatable\u003cbr\\/\u003e\\n    cursor and positioned updates should do the trick?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12658514_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12658514_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Dec\\/08 11:43\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-22T11:43:19+0000\'\u003e22\\/Dec\\/08 11:43\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks for your comments, Mike. \\n\\n &gt; I am not sure if the following will do better, but it is what I \\n&gt; thought of. It seems like the worst case would be cases where we \\n&gt; move the scan a lot without having latch on page. ie. case where we \\n&gt; get one row at a time from the page. So I would suggest using the \\n&gt; bulk fetch property to only get 1 row at a time: CALL \\n&gt; SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(\'derby.language.bulkFetchDefault\',\'1\'); \\n\\n Thanks, I wasn\'t aware of that property. I\'ll do some experiments with \\nit. \\n\\n &gt; 1000 rows does not seem like enough data to do a test. One of the \\n&gt; problems with the new approach, especially with something like \\n&gt; decimal is that there is going to be extra object allocation per \\n&gt; row. So you want enough rows to see what effect it might have on \\n&gt; GC. \\n\\n I picked 1000 rows to make sure that we had at least a couple of full \\nindex pages in each of the test cases. I assumed that having multiple \\niterations on a smaller number of rows would have about the same \\neffect on GC as fewer iterations on a larger data set. \\n\\n &gt; I usually tried to make sure performance test took at least a \\n&gt; second, and maybe 60 seconds for at least a one time run. \\n\\n The tests mentioned in my previous comment had a fixed number of \\niterations, so the total time for each test case varied between 20 and \\n150 seconds depending on key size. (The times in milliseconds in the \\ntable must be multiplied by four to get the actual time spent because \\nof the way the framework runs the tests.) I can also try some longer \\nruns. \\n\\n &gt; Is a read only test affected by pages going out of cache? From your \\n&gt; description I don\'t think so unless you get very strange cache \\n&gt; behavior in that the scan current page goes out of cache during the \\n&gt; scan of that page. \\n\\n That\'s correct. Read only tests should not be affected by pages going \\nout of the cache. Even if the current page goes out while we don\'t \\nhold the latch, they shouldn\'t be affected unless there has been a \\nmodification on the page after the latch was released. In that case \\nthe page will have the dirty flag in addition to the recently-used \\nflag, so it\'s highly unlikely that it will be chosen for eviction. \\n\\n &gt; But might be worth showing that a both approaches \\n&gt; perform same on a scan of a table that is bigger than the cache when \\n&gt; the scan is executed multiple times in a row. \\n\\n Good point. I\'ll run such a test. \\n\\n &gt; Should there be something that exercises the worst case where the \\n&gt; page is updated? Again for this having a bigger dataset wil cause \\n&gt; more overhead for the search. For this maybe something like a 2 part \\n&gt; key with first part being as the current test and the second part \\n&gt; being an int and the test runs a cursor through the table and after \\n&gt; reading each index row then updates the second part of the key by \\n&gt; minus one, likely leaving the key on the same page - but not putting \\n&gt; the scan into an infinite loop. Make sure the cursor choice is one \\n&gt; which goes to the table every time, not one that caches the values \\n&gt; in the client somehow. \\n\\n I think I understand what you\'re suggesting, but a couple of questions \\njust to make sure that I\'m not missing the point: \\n\\n \\n\\t the purpose of this test is to check that we don\'t perform any \\n    repositioning by key just because there has been an update on the \\n    page? \\n \\n\\n\\n \\n\\t by making sure that the client doesn\'t cache the values, you \\n    basically mean that bulk fetch should be disabled? So setting \\n    derby.language.bulkFetchDefault or perhaps using an updatable \\n    cursor and positioned updates should do the trick? \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12658895\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12658895&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12658895\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12658895_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12658895_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'23\\/Dec\\/08 17:06\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-23T17:06:13+0000\'\u003e23\\/Dec\\/08 17:06\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI checked in the performance test with revision 729039.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12658895_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12658895_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'23\\/Dec\\/08 17:06\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-23T17:06:13+0000\'\u003e23\\/Dec\\/08 17:06\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I checked in the performance test with revision 729039.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12659168\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12659168&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12659168\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12659168_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12659168_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'24\\/Dec\\/08 23:06\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-24T23:06:15+0000\'\u003e24\\/Dec\\/08 23:06\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHere are the results from running the same tests with derby.language.bulkFetchDefault=1 (20 runs with each configuration):\u003c\\/p\u003e\\n\\n\u003cp\u003eTEST                |TRUNK_TIME |PATCHED_TI&amp;|INCREASE   |INC_PERCENT           \u003cbr\\/\u003e\\n-------------------------------------------------------------------------------\u003cbr\\/\u003e\\ndecimal10columns    |28390      |33116      |4726       |16.646706586826348    \u003cbr\\/\u003e\\ndecimal1column      |16638      |17997      |1359       |8.168049044356293     \u003cbr\\/\u003e\\nvarchar10           |15062      |16426      |1364       |9.055902270614792     \u003cbr\\/\u003e\\nvarchar100          |18655      |21829      |3174       |17.014205306888233    \u003cbr\\/\u003e\\nvarchar1000         |47123      |70214      |23091      |49.001549137363924    \u003cbr\\/\u003e\\nvarcharAll          |52362      |78693      |26331      |50.286467285436       \u003c\\/p\u003e\\n\\n\u003cp\u003eWhen bulk fetch is disabled, saving the position by key is clearly more expensive for these scans. With small keys, the extra cost appears to be moderate, but with large keys it is quite high.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12659168_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12659168_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'24\\/Dec\\/08 23:06\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-24T23:06:15+0000\'\u003e24\\/Dec\\/08 23:06\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Here are the results from running the same tests with derby.language.bulkFetchDefault=1 (20 runs with each configuration): \\n\\n TEST                |TRUNK_TIME |PATCHED_TI&amp;|INCREASE   |INC_PERCENT            \\n------------------------------------------------------------------------------- \\ndecimal10columns    |28390      |33116      |4726       |16.646706586826348     \\ndecimal1column      |16638      |17997      |1359       |8.168049044356293      \\nvarchar10           |15062      |16426      |1364       |9.055902270614792      \\nvarchar100          |18655      |21829      |3174       |17.014205306888233     \\nvarchar1000         |47123      |70214      |23091      |49.001549137363924     \\nvarcharAll          |52362      |78693      |26331      |50.286467285436        \\n\\n When bulk fetch is disabled, saving the position by key is clearly more expensive for these scans. With small keys, the extra cost appears to be moderate, but with large keys it is quite high.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12659315\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12659315&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12659315\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12659315_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12659315_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'27\\/Dec\\/08 09:07\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-27T09:07:51+0000\'\u003e27\\/Dec\\/08 09:07\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eIn BTreeForwardScan.fetchRows() we have already fetched the key (or\u003cbr\\/\u003e\\nparts of the key) before we save the position. So I experimented with\u003cbr\\/\u003e\\ncopying the key instead of re-reading the entire record. The copying\u003cbr\\/\u003e\\nwas performed by iterating over fetch_row and calling setValue() on\u003cbr\\/\u003e\\neach element of scan_position.current_positionKey. This eliminated\u003cbr\\/\u003e\\nmuch of the overhead. A rerun of the JUnit test with\u003cbr\\/\u003e\\nderby.language.bulkFetchDefault=1 gave these results (average of 20\u003cbr\\/\u003e\\nruns for each configuration):\u003c\\/p\u003e\\n\\n\\n\u003cp\u003eTEST                |TRUNK_TIME |PATCHED_TI&amp;|INCREASE   |INC_PERCENT  \u003cbr\\/\u003e\\n----------------------------------------------------------------------\u003cbr\\/\u003e\\ndecimal10columns    |28427      |29727      |1300       |4.5731173    \u003cbr\\/\u003e\\ndecimal1column      |16572      |16890      |318        |1.9188993    \u003cbr\\/\u003e\\nvarchar10           |14715      |15673      |958        |6.5103636    \u003cbr\\/\u003e\\nvarchar100          |18378      |19472      |1094       |5.9527693    \u003cbr\\/\u003e\\nvarchar1000         |47092      |51618      |4526       |9.610974     \u003cbr\\/\u003e\\nvarcharAll          |52457      |57628      |5171       |9.857598     \u003c\\/p\u003e\\n\\n\u003cp\u003eThis will of course only work if the entire key is fetched by the\u003cbr\\/\u003e\\nscan. A proper solution would have to read the missing parts of the\u003cbr\\/\u003e\\nkey if only parts of it are used by the scan.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12659315_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12659315_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'27\\/Dec\\/08 09:07\'\u003e\u003ctime class=\'livestamp\' datetime=\'2008-12-27T09:07:51+0000\'\u003e27\\/Dec\\/08 09:07\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    In BTreeForwardScan.fetchRows() we have already fetched the key (or \\nparts of the key) before we save the position. So I experimented with \\ncopying the key instead of re-reading the entire record. The copying \\nwas performed by iterating over fetch_row and calling setValue() on \\neach element of scan_position.current_positionKey. This eliminated \\nmuch of the overhead. A rerun of the JUnit test with \\nderby.language.bulkFetchDefault=1 gave these results (average of 20 \\nruns for each configuration): \\n\\n\\n TEST                |TRUNK_TIME |PATCHED_TI&amp;|INCREASE   |INC_PERCENT   \\n---------------------------------------------------------------------- \\ndecimal10columns    |28427      |29727      |1300       |4.5731173     \\ndecimal1column      |16572      |16890      |318        |1.9188993     \\nvarchar10           |14715      |15673      |958        |6.5103636     \\nvarchar100          |18378      |19472      |1094       |5.9527693     \\nvarchar1000         |47092      |51618      |4526       |9.610974      \\nvarcharAll          |52457      |57628      |5171       |9.857598      \\n\\n This will of course only work if the entire key is fetched by the \\nscan. A proper solution would have to read the missing parts of the \\nkey if only parts of it are used by the scan.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12660782\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12660782&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12660782\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12660782_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12660782_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Jan\\/09 15:13\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-01-05T15:13:32+0000\'\u003e05\\/Jan\\/09 15:13\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI have taken another look at the previous key locking. If the latches\u003cbr\\/\u003e\\nare released when we\'re searching backward for the previous key, it\u003cbr\\/\u003e\\nseems like we\'ll rescan the tree, so it doesn\'t seem like we\'re\u003cbr\\/\u003e\\ndepending on the scan lock. Some relevant code fragments and comments:\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eBTreeController.doIns():\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003e    while (true)\u003cbr\\/\u003e\\n    {\u003cbr\\/\u003e\\n    .\u003cbr\\/\u003e\\n    .\u003cbr\\/\u003e\\n    .\u003cbr\\/\u003e\\n        \\/\\/ Row locking - first lock row previous to row being inserted:\u003cbr\\/\u003e\\n    .\u003cbr\\/\u003e\\n    .\u003cbr\\/\u003e\\n    .\u003cbr\\/\u003e\\n        if (latch_released)\u003c\\/p\u003e\\n        {\\n            \\/\\/ Had to release latch in order to get the lock, probably \\n            \\/\\/ because of a forward scanner, research tree, and try again.\\n            targetleaf = null;\\n            continue;\\n        }\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eB2IRowLocking3._lockScanRow():\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003e    if (pos.current_slot == 0)\u003cbr\\/\u003e\\n    {\u003cbr\\/\u003e\\n        \\/\\/ this call will take care of searching left in the btree\u003cbr\\/\u003e\\n        \\/\\/ to find the previous row to lock, 0 is the control row and\u003cbr\\/\u003e\\n        \\/\\/ not a valid thing to lock as a previous key.\u003c\\/p\u003e\\n\\n\u003cp\u003e        \\/\\/ it is ok to call the non-scan as this is just a special\u003cbr\\/\u003e\\n        \\/\\/ case of a previous key lock call.  The only scan code that\u003cbr\\/\u003e\\n        \\/\\/ will call this routine with slot == 0 will retry if this\u003cbr\\/\u003e\\n        \\/\\/ routine returns that a latch was released.\u003c\\/p\u003e\\n\\n\u003cp\u003e        latch_released = \u003cbr\\/\u003e\\n            !lockNonScanPreviousRow(\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eB2IRowLocking3.lockNonScanPreviousRow():\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003e    \\/\\/ RESOLVE RLL (mikem) - NO RECORD_ID PROTECTION IN EFFECT.\u003cbr\\/\u003e\\n    \\/\\/ caller must research, get new locks if this routine \u003cbr\\/\u003e\\n    \\/\\/ releases latches.\u003cbr\\/\u003e\\n    ret_status = this.searchLeftAndLockPreviousKey(\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eB2IRowLocking3.searchLeftAndLockPreviousKey():\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eIf along the search a latch has to be waited on then latches are\u003c\\/li\u003e\\n\\t\u003cli\u003ereleased and a wait is performed, and \\\"false\\\" status is returned to\u003c\\/li\u003e\\n\\t\u003cli\u003ecaller.  In this case the routine can no longer be sure of it\'s current\u003c\\/li\u003e\\n\\t\u003cli\u003eposition and may have to retry the whole operation.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12660782_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12660782_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Jan\\/09 15:13\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-01-05T15:13:32+0000\'\u003e05\\/Jan\\/09 15:13\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I have taken another look at the previous key locking. If the latches \\nare released when we\'re searching backward for the previous key, it \\nseems like we\'ll rescan the tree, so it doesn\'t seem like we\'re \\ndepending on the scan lock. Some relevant code fragments and comments: \\n\\n \\n\\t BTreeController.doIns(): \\n \\n\\n\\n     while (true) \\n    { \\n    . \\n    . \\n    . \\n        \\/\\/ Row locking - first lock row previous to row being inserted: \\n    . \\n    . \\n    . \\n        if (latch_released) \\n        {\\n            \\/\\/ Had to release latch in order to get the lock, probably \\n            \\/\\/ because of a forward scanner, research tree, and try again.\\n            targetleaf = null;\\n            continue;\\n        }\\n\\n \\n\\t B2IRowLocking3._lockScanRow(): \\n \\n\\n\\n     if (pos.current_slot == 0) \\n    { \\n        \\/\\/ this call will take care of searching left in the btree \\n        \\/\\/ to find the previous row to lock, 0 is the control row and \\n        \\/\\/ not a valid thing to lock as a previous key. \\n\\n         \\/\\/ it is ok to call the non-scan as this is just a special \\n        \\/\\/ case of a previous key lock call.  The only scan code that \\n        \\/\\/ will call this routine with slot == 0 will retry if this \\n        \\/\\/ routine returns that a latch was released. \\n\\n         latch_released =  \\n            !lockNonScanPreviousRow( \\n\\n \\n\\t B2IRowLocking3.lockNonScanPreviousRow(): \\n \\n\\n\\n     \\/\\/ RESOLVE RLL (mikem) - NO RECORD_ID PROTECTION IN EFFECT. \\n    \\/\\/ caller must research, get new locks if this routine  \\n    \\/\\/ releases latches. \\n    ret_status = this.searchLeftAndLockPreviousKey( \\n\\n \\n\\t B2IRowLocking3.searchLeftAndLockPreviousKey(): \\n \\n\\n\\n \\n\\t If along the search a latch has to be waited on then latches are \\n\\t released and a wait is performed, and \\\"false\\\" status is returned to \\n\\t caller.  In this case the routine can no longer be sure of it\'s current \\n\\t position and may have to retry the whole operation. \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12661220\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12661220&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12661220\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_12661220_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12661220_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/09 17:44\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-01-06T17:44:22+0000\'\u003e06\\/Jan\\/09 17:44\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003esorry for late reply, was out and away from computer end of the year.\u003cbr\\/\u003e\\n&gt; I think I understand what you\'re suggesting, but a couple of questions\u003cbr\\/\u003e\\n&gt; just to make sure that I\'m not missing the point:\u003cbr\\/\u003e\\n&gt;\u003cbr\\/\u003e\\n&gt; - the purpose of this test is to check that we don\'t perform any\u003cbr\\/\u003e\\n&gt; repositioning by key just because there has been an update on the\u003cbr\\/\u003e\\n&gt; page?\u003cbr\\/\u003e\\nyes.  I must be misunderstanding the current patch, I thought it would\u003cbr\\/\u003e\\nresearch on an update of the page.  probably worth measuring but not a lot\u003cbr\\/\u003e\\nof different cases if the design does not expect a research.  I was trying\u003cbr\\/\u003e\\nto force a measurement of worst case where a search would happen after every\u003cbr\\/\u003e\\nrow.\u003cbr\\/\u003e\\n&gt;\u003cbr\\/\u003e\\n&gt; - by making sure that the client doesn\'t cache the values, you\u003cbr\\/\u003e\\n&gt; basically mean that bulk fetch should be disabled? So setting\u003cbr\\/\u003e\\n&gt; derby.language.bulkFetchDefault or perhaps using an updatable\u003cbr\\/\u003e\\n&gt; cursor and positioned updates should do the trick?\u003cbr\\/\u003e\\nMy comment was about making the tree bigger.  Not necessarily to not cache\u003cbr\\/\u003e\\nthe tree, but by making there be more levels in the tree then it will cost\u003cbr\\/\u003e\\nmore to research the tree from the top.  Again was just wanting to know the\u003cbr\\/\u003e\\nworst case penalty.  Maybe you could add a short comment about in which\u003cbr\\/\u003e\\ncases we will research the tree with the new scheme vs. the old scheme.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe test I was suggesting I think could be done with updatable cursor and\u003cbr\\/\u003e\\npositioned updates, as long as the properties of the cursor are such that\u003cbr\\/\u003e\\neach next goes to the database.   There are some cursor settings where\u003cbr\\/\u003e\\ncaching will happen in the client and nothing you do to the database after\u003cbr\\/\u003e\\neach row fetch will get you into the btree research code that we are trying\u003cbr\\/\u003e\\nto exercise.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_12661220_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12661220_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/09 17:44\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-01-06T17:44:22+0000\'\u003e06\\/Jan\\/09 17:44\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    sorry for late reply, was out and away from computer end of the year. \\n&gt; I think I understand what you\'re suggesting, but a couple of questions \\n&gt; just to make sure that I\'m not missing the point: \\n&gt; \\n&gt; - the purpose of this test is to check that we don\'t perform any \\n&gt; repositioning by key just because there has been an update on the \\n&gt; page? \\nyes.  I must be misunderstanding the current patch, I thought it would \\nresearch on an update of the page.  probably worth measuring but not a lot \\nof different cases if the design does not expect a research.  I was trying \\nto force a measurement of worst case where a search would happen after every \\nrow. \\n&gt; \\n&gt; - by making sure that the client doesn\'t cache the values, you \\n&gt; basically mean that bulk fetch should be disabled? So setting \\n&gt; derby.language.bulkFetchDefault or perhaps using an updatable \\n&gt; cursor and positioned updates should do the trick? \\nMy comment was about making the tree bigger.  Not necessarily to not cache \\nthe tree, but by making there be more levels in the tree then it will cost \\nmore to research the tree from the top.  Again was just wanting to know the \\nworst case penalty.  Maybe you could add a short comment about in which \\ncases we will research the tree with the new scheme vs. the old scheme. \\n\\n The test I was suggesting I think could be done with updatable cursor and \\npositioned updates, as long as the properties of the cursor are such that \\neach next goes to the database.   There are some cursor settings where \\ncaching will happen in the client and nothing you do to the database after \\neach row fetch will get you into the btree research code that we are trying \\nto exercise.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12661235\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12661235&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12661235\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_12661235_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12661235_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/09 18:13\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-01-06T18:13:02+0000\'\u003e06\\/Jan\\/09 18:13\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003econcerning the latest performance results, I am still concerned as I believe the bulkfetch=1 case simulates the path that nested loop joins take, so may affect a lot of normal query behavior.  But your latest optimization looks promising, I would not be surprised if \u003cbr\\/\u003e\\nthere was some optimization that could be made in the copying of one DataValueDescriptor to another.  \u003c\\/p\u003e\\n\\n\u003cp\u003eDo you know if in the char\\/varchar case if the source DVD is already in String form (vs raw character array).\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_12661235_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12661235_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/09 18:13\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-01-06T18:13:02+0000\'\u003e06\\/Jan\\/09 18:13\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    concerning the latest performance results, I am still concerned as I believe the bulkfetch=1 case simulates the path that nested loop joins take, so may affect a lot of normal query behavior.  But your latest optimization looks promising, I would not be surprised if  \\nthere was some optimization that could be made in the copying of one DataValueDescriptor to another.   \\n\\n Do you know if in the char\\/varchar case if the source DVD is already in String form (vs raw character array).              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12661580\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12661580&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12661580\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12661580_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12661580_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/Jan\\/09 14:05\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-01-07T14:05:51+0000\'\u003e07\\/Jan\\/09 14:05\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks for clarifying the comments about the tests, Mike. I\'ll make\u003cbr\\/\u003e\\nthe modifications and come back with the results.\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; Maybe you could add a short comment about in which cases we will\u003cbr\\/\u003e\\n&gt; research the tree with the new scheme vs. the old scheme.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe old scheme (current Derby) will research the tree in these\u003cbr\\/\u003e\\nsituations:\u003c\\/p\u003e\\n\\n\u003cp\u003e  a) Locks (scan lock, row lock or prev key lock) could not be obtained\u003cbr\\/\u003e\\n     immediately when positioning at the start of the scan\u003c\\/p\u003e\\n\\n\u003cp\u003e  b) Transaction was committed after we released the latch (then\u003cbr\\/\u003e\\n     there\'s no scan lock protecting the position anymore)\u003c\\/p\u003e\\n\\n\u003cp\u003e  c) Some other operation within the same transaction caused a split\u003cbr\\/\u003e\\n     on the page we were positioned on after we released the latch\u003cbr\\/\u003e\\n     (scan lock doesn\'t protect us against changes in the same\u003cbr\\/\u003e\\n     transaction)\u003c\\/p\u003e\\n\\n\u003cp\u003eThe new scheme will research the tree in situation (a) above, and\u003cbr\\/\u003e\\nadditionally:\u003c\\/p\u003e\\n\\n\u003cp\u003e  d) A row was moved off the page after we released the latch (caused\u003cbr\\/\u003e\\n     by split or purge)\u003c\\/p\u003e\\n\\n\u003cp\u003e  e) The current page was updated (any update, as long as the page\u003cbr\\/\u003e\\n     version was changed) \u003cb\u003eand\u003c\\/b\u003e evicted from the page cache after we\u003cbr\\/\u003e\\n     released the latch\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; Do you know if in the char\\/varchar case if the source DVD is already\u003cbr\\/\u003e\\n&gt; in String form (vs raw character array).\u003c\\/p\u003e\\n\\n\u003cp\u003eIt is still in raw form when the value is copied, but it will be\u003cbr\\/\u003e\\nconverted to string form SQLChar.setFrom(DVD) calls getString() on the\u003cbr\\/\u003e\\nDVD. In the tests I\'ve run till now, it shouldn\'t matter since we\'ll\u003cbr\\/\u003e\\nend up calling DVD.getString() from EmbedRS.getString() on all the\u003cbr\\/\u003e\\nstrings anyway, and the two SQLChar instances share the same immutable\u003cbr\\/\u003e\\nString instance. In other cases it could matter, so it would be better\u003cbr\\/\u003e\\nif we could share the char array between the two SQLChar objects and\u003cbr\\/\u003e\\navoid the allocation of the String. Not sure if this is safe,\u003cbr\\/\u003e\\nthough. SQLChar treats the raw char array as an immutable data type in\u003cbr\\/\u003e\\nmost cases, but not in normalize().\u003c\\/p\u003e\\n\\n\u003cp\u003eIt\'s the same with the DECIMAL tests. The source DVD is in raw form\u003cbr\\/\u003e\\n(byte[] + int) and is converted to a BigDecimal that\'s shared between\u003cbr\\/\u003e\\nthe two SQLDecimal instances.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe cheapest way to copy the key would probably be to have a method in\u003cbr\\/\u003e\\nthe Page interface that could copy the raw row to a byte array. We\u003cbr\\/\u003e\\nwould only have to deserialize the key if repositioning was needed,\u003cbr\\/\u003e\\nand we would only need one extra object allocation per scan in the\u003cbr\\/\u003e\\nnormal case (unless the byte buffer we allocated the first time was\u003cbr\\/\u003e\\ntoo small). Is that an option? The methods to serialize and\u003cbr\\/\u003e\\ndeserialize DVDs are public methods of all DVDs (writeExternal() and\u003cbr\\/\u003e\\nwriteExternal()), so it\'s not really like it would be exposing\u003cbr\\/\u003e\\nimplementation details in interface methods.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12661580_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12661580_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/Jan\\/09 14:05\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-01-07T14:05:51+0000\'\u003e07\\/Jan\\/09 14:05\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks for clarifying the comments about the tests, Mike. I\'ll make \\nthe modifications and come back with the results. \\n\\n &gt; Maybe you could add a short comment about in which cases we will \\n&gt; research the tree with the new scheme vs. the old scheme. \\n\\n The old scheme (current Derby) will research the tree in these \\nsituations: \\n\\n   a) Locks (scan lock, row lock or prev key lock) could not be obtained \\n     immediately when positioning at the start of the scan \\n\\n   b) Transaction was committed after we released the latch (then \\n     there\'s no scan lock protecting the position anymore) \\n\\n   c) Some other operation within the same transaction caused a split \\n     on the page we were positioned on after we released the latch \\n     (scan lock doesn\'t protect us against changes in the same \\n     transaction) \\n\\n The new scheme will research the tree in situation (a) above, and \\nadditionally: \\n\\n   d) A row was moved off the page after we released the latch (caused \\n     by split or purge) \\n\\n   e) The current page was updated (any update, as long as the page \\n     version was changed)  and  evicted from the page cache after we \\n     released the latch \\n\\n &gt; Do you know if in the char\\/varchar case if the source DVD is already \\n&gt; in String form (vs raw character array). \\n\\n It is still in raw form when the value is copied, but it will be \\nconverted to string form SQLChar.setFrom(DVD) calls getString() on the \\nDVD. In the tests I\'ve run till now, it shouldn\'t matter since we\'ll \\nend up calling DVD.getString() from EmbedRS.getString() on all the \\nstrings anyway, and the two SQLChar instances share the same immutable \\nString instance. In other cases it could matter, so it would be better \\nif we could share the char array between the two SQLChar objects and \\navoid the allocation of the String. Not sure if this is safe, \\nthough. SQLChar treats the raw char array as an immutable data type in \\nmost cases, but not in normalize(). \\n\\n It\'s the same with the DECIMAL tests. The source DVD is in raw form \\n(byte[] + int) and is converted to a BigDecimal that\'s shared between \\nthe two SQLDecimal instances. \\n\\n The cheapest way to copy the key would probably be to have a method in \\nthe Page interface that could copy the raw row to a byte array. We \\nwould only have to deserialize the key if repositioning was needed, \\nand we would only need one extra object allocation per scan in the \\nnormal case (unless the byte buffer we allocated the first time was \\ntoo small). Is that an option? The methods to serialize and \\ndeserialize DVDs are public methods of all DVDs (writeExternal() and \\nwriteExternal()), so it\'s not really like it would be exposing \\nimplementation details in interface methods.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12661938\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12661938&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12661938\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12661938_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12661938_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Jan\\/09 11:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-01-08T11:02:42+0000\'\u003e08\\/Jan\\/09 11:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThinking more about it, copying the raw bytes from the page array would probably only be cheaper if the materialized values created by copying the keys were not going to be used later. So in the tests that I have run till now it shouldn\'t be any cheaper at all, since the objects we allocate when we copy the key would have been allocated later anyway. Might be worth a try if everything else fails, though.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12661938_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12661938_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Jan\\/09 11:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-01-08T11:02:42+0000\'\u003e08\\/Jan\\/09 11:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thinking more about it, copying the raw bytes from the page array would probably only be cheaper if the materialized values created by copying the keys were not going to be used later. So in the tests that I have run till now it shouldn\'t be any cheaper at all, since the objects we allocate when we copy the key would have been allocated later anyway. Might be worth a try if everything else fails, though.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12662370\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12662370&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12662370\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12662370_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12662370_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Jan\\/09 13:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-01-09T13:55:43+0000\'\u003e09\\/Jan\\/09 13:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThere must be something wrong with the test results I posted on\u003cbr\\/\u003e\\n27\\/Dec\\/08.\u003c\\/p\u003e\\n\\n\u003cp\u003eFirst of all, they don\'t really make any sense. Why should the\u003cbr\\/\u003e\\noverhead of saving the position be greater for VARCHAR(1000) than for\u003cbr\\/\u003e\\nVARCHAR(10)? Since the String object that we generate when we copy the\u003cbr\\/\u003e\\nkey is shared between the source DVD and the target DVD, and the\u003cbr\\/\u003e\\nsource DVD saves the same amount of work when it later needs to return\u003cbr\\/\u003e\\nthe String to the user, the overhead per row should be proportional to\u003cbr\\/\u003e\\nthe number of columns in the key, not to the size of the columns in\u003cbr\\/\u003e\\nthe key. And since reading longer values is more expensive than\u003cbr\\/\u003e\\nreading shorter values, the relative overhead should be smaller rather\u003cbr\\/\u003e\\nthan greater for VARCHAR(1000).\u003c\\/p\u003e\\n\\n\u003cp\u003eSecondly, I see the exact same results when I compare a clean trunk\u003cbr\\/\u003e\\nwith another clean trunk. For some reason, the runs (1, 3, 5, ...)\u003cbr\\/\u003e\\nconsistently show significantly better performance than the runs (2,\u003cbr\\/\u003e\\n4, 6, ...). But it turns out that if I remove the database directory\u003cbr\\/\u003e\\nbetween each run, I get much more stable results. I\'ve got no idea why\u003cbr\\/\u003e\\nthis happens. Perhaps something CleanDatabaseTestSetup or some other\u003cbr\\/\u003e\\npart of the test framework does?\u003c\\/p\u003e\\n\\n\u003cp\u003eAnyway, no matter what\'s causing it, I\'ll need to rerun the tests and\u003cbr\\/\u003e\\nlet each test run create its own database. It\'s probably also a good\u003cbr\\/\u003e\\nidea to randomize the order of the test to eliminate interference from\u003cbr\\/\u003e\\nperiodic\\/alternating factors. In the previous test runs, I ran clean,\u003cbr\\/\u003e\\npatched, clean, patched, and so on, so that all the bad runs were with\u003cbr\\/\u003e\\npatched jars and all the good runs were with clean jars. Perhaps I\'ll\u003cbr\\/\u003e\\nalso write a simple standalone test, so that we don\'t need to worry\u003cbr\\/\u003e\\nabout what happens in the test framework.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12662370_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12662370_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Jan\\/09 13:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-01-09T13:55:43+0000\'\u003e09\\/Jan\\/09 13:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    There must be something wrong with the test results I posted on \\n27\\/Dec\\/08. \\n\\n First of all, they don\'t really make any sense. Why should the \\noverhead of saving the position be greater for VARCHAR(1000) than for \\nVARCHAR(10)? Since the String object that we generate when we copy the \\nkey is shared between the source DVD and the target DVD, and the \\nsource DVD saves the same amount of work when it later needs to return \\nthe String to the user, the overhead per row should be proportional to \\nthe number of columns in the key, not to the size of the columns in \\nthe key. And since reading longer values is more expensive than \\nreading shorter values, the relative overhead should be smaller rather \\nthan greater for VARCHAR(1000). \\n\\n Secondly, I see the exact same results when I compare a clean trunk \\nwith another clean trunk. For some reason, the runs (1, 3, 5, ...) \\nconsistently show significantly better performance than the runs (2, \\n4, 6, ...). But it turns out that if I remove the database directory \\nbetween each run, I get much more stable results. I\'ve got no idea why \\nthis happens. Perhaps something CleanDatabaseTestSetup or some other \\npart of the test framework does? \\n\\n Anyway, no matter what\'s causing it, I\'ll need to rerun the tests and \\nlet each test run create its own database. It\'s probably also a good \\nidea to randomize the order of the test to eliminate interference from \\nperiodic\\/alternating factors. In the previous test runs, I ran clean, \\npatched, clean, patched, and so on, so that all the bad runs were with \\npatched jars and all the good runs were with clean jars. Perhaps I\'ll \\nalso write a simple standalone test, so that we don\'t need to worry \\nabout what happens in the test framework.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12662951\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12662951&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12662951\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12662951_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12662951_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Jan\\/09 13:26\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-01-12T13:26:59+0000\'\u003e12\\/Jan\\/09 13:26\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHad the tests with bulk-fetch disabled running over the weekend (200\u003cbr\\/\u003e\\ntimes with a clean trunk, 200 times patched). Now I used a standalone\u003cbr\\/\u003e\\ntest which did the same as the JUnit test (except from some adjusting\u003cbr\\/\u003e\\nof the number of iterations to get the time more evenly distributed\u003cbr\\/\u003e\\nbetween the test cases, and the size of the test table was increased\u003cbr\\/\u003e\\nfrom 1000 rows to 10000 rows), and I randomized the order of the\u003cbr\\/\u003e\\ntests. Now the test results look much more reasonable.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe test case with a key consisting of ten DECIMAL columns shows the\u003cbr\\/\u003e\\nworst performance, with a 1.9% increase in the time spent. The test\u003cbr\\/\u003e\\ncases with VARCHAR(10) and VARCHAR(100) showed 1.6% and 0.9% increase\u003cbr\\/\u003e\\nin time spent, respectively. The other test cases basically showed the\u003cbr\\/\u003e\\nsame performance for clean jars and patched jars. The table below\u003cbr\\/\u003e\\nshows the average numbers (times in milliseconds) for the test runs.\u003c\\/p\u003e\\n\\n\u003cp\u003eNAME                    |TRUNK_TIME |PATCHED_TI&amp;|INCREASE   |INC_PERCENT  \u003cbr\\/\u003e\\n--------------------------------------------------------------------------\u003cbr\\/\u003e\\nDecimal10Columns        |81495      |83025      |1530       |1.8774158    \u003cbr\\/\u003e\\nDecimalSingleColumn     |63722      |63769      |47         |0.07375789   \u003cbr\\/\u003e\\nVarchar0010             |54268      |55145      |877        |1.6160537    \u003cbr\\/\u003e\\nVarchar0100             |70907      |71576      |669        |0.9434894    \u003cbr\\/\u003e\\nVarchar1000             |87431      |87457      |26         |0.029737735  \u003cbr\\/\u003e\\nVarcharAll              |97197      |96845      |-352       |-0.3621511   \u003c\\/p\u003e\\n\\n\u003cp\u003eNow that I\'ve got test results that I understand, I\'ll go on and add\u003cbr\\/\u003e\\nthe test cases Mike suggested. If we don\'t find any common code path\u003cbr\\/\u003e\\nthat\'s slowed down more than what the latest test run showed, I would\u003cbr\\/\u003e\\nbe inclined to say the overhead is acceptable, given that it fixes a\u003cbr\\/\u003e\\nserious issue and that other common code paths are actually getting\u003cbr\\/\u003e\\nbetter performance, and investigation on how to reduce the overhead\u003cbr\\/\u003e\\nfurther could be postponed until later. But let me first see how the\u003cbr\\/\u003e\\nother suggested test cases are affected.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12662951_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12662951_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Jan\\/09 13:26\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-01-12T13:26:59+0000\'\u003e12\\/Jan\\/09 13:26\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Had the tests with bulk-fetch disabled running over the weekend (200 \\ntimes with a clean trunk, 200 times patched). Now I used a standalone \\ntest which did the same as the JUnit test (except from some adjusting \\nof the number of iterations to get the time more evenly distributed \\nbetween the test cases, and the size of the test table was increased \\nfrom 1000 rows to 10000 rows), and I randomized the order of the \\ntests. Now the test results look much more reasonable. \\n\\n The test case with a key consisting of ten DECIMAL columns shows the \\nworst performance, with a 1.9% increase in the time spent. The test \\ncases with VARCHAR(10) and VARCHAR(100) showed 1.6% and 0.9% increase \\nin time spent, respectively. The other test cases basically showed the \\nsame performance for clean jars and patched jars. The table below \\nshows the average numbers (times in milliseconds) for the test runs. \\n\\n NAME                    |TRUNK_TIME |PATCHED_TI&amp;|INCREASE   |INC_PERCENT   \\n-------------------------------------------------------------------------- \\nDecimal10Columns        |81495      |83025      |1530       |1.8774158     \\nDecimalSingleColumn     |63722      |63769      |47         |0.07375789    \\nVarchar0010             |54268      |55145      |877        |1.6160537     \\nVarchar0100             |70907      |71576      |669        |0.9434894     \\nVarchar1000             |87431      |87457      |26         |0.029737735   \\nVarcharAll              |97197      |96845      |-352       |-0.3621511    \\n\\n Now that I\'ve got test results that I understand, I\'ll go on and add \\nthe test cases Mike suggested. If we don\'t find any common code path \\nthat\'s slowed down more than what the latest test run showed, I would \\nbe inclined to say the overhead is acceptable, given that it fixes a \\nserious issue and that other common code paths are actually getting \\nbetter performance, and investigation on how to reduce the overhead \\nfurther could be postponed until later. But let me first see how the \\nother suggested test cases are affected.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12666147\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12666147&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12666147\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12666147_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12666147_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Jan\\/09 14:09\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-01-22T14:09:25+0000\'\u003e22\\/Jan\\/09 14:09\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eUpdating the preview patch (1e). There are two changes from the previous preview:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) If the leaf page on which we\'re positioned is transformed into a branch page while we don\'t hold the latch, we reposition by key. This fixes eight regression test failures (ClassCastExceptions) seen with 1d. FWIW, derbyall and suites.All now run without failures.\u003c\\/p\u003e\\n\\n\u003cp\u003e2) Copy the (possibly partial) key fetched in BTreeForwardScan when saving the position, instead of re-reading the full key from the page. If the scan just fetches a partial key, we fetch the missing parts only from the page.\u003c\\/p\u003e\\n\\n\u003cp\u003eThis is not the same patch as I used in the latest performance test runs. That patch copied the key as if the full key had been fetched by the scan. However, since the tests only scan the index and don\'t go to the base table, the scans don\'t fetch the RowLocation which is the last column in the index. So when we save the position we still need to call Page.fetchFromSlot() to get the RowLocation. So now the overhead with bulk fetch disabled is back at 1% (for large key columns) to 10% (small\\/many key columns). I\'m posting the patch for reference anyway.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12666147_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12666147_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Jan\\/09 14:09\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-01-22T14:09:25+0000\'\u003e22\\/Jan\\/09 14:09\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Updating the preview patch (1e). There are two changes from the previous preview: \\n\\n 1) If the leaf page on which we\'re positioned is transformed into a branch page while we don\'t hold the latch, we reposition by key. This fixes eight regression test failures (ClassCastExceptions) seen with 1d. FWIW, derbyall and suites.All now run without failures. \\n\\n 2) Copy the (possibly partial) key fetched in BTreeForwardScan when saving the position, instead of re-reading the full key from the page. If the scan just fetches a partial key, we fetch the missing parts only from the page. \\n\\n This is not the same patch as I used in the latest performance test runs. That patch copied the key as if the full key had been fetched by the scan. However, since the tests only scan the index and don\'t go to the base table, the scans don\'t fetch the RowLocation which is the last column in the index. So when we save the position we still need to call Page.fetchFromSlot() to get the RowLocation. So now the overhead with bulk fetch disabled is back at 1% (for large key columns) to 10% (small\\/many key columns). I\'m posting the patch for reference anyway.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12668514\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12668514&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12668514\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12668514_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12668514_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Jan\\/09 16:48\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-01-29T16:48:10+0000\'\u003e29\\/Jan\\/09 16:48\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI\'ve tried to find out which effect the proposed solution has on\u003cbr\\/\u003e\\nnested loop joins. The assumption was earlier that nested loop joins\u003cbr\\/\u003e\\nwould turn off bulk fetching and therefore the index scans with\u003cbr\\/\u003e\\nderby.language.bulkFetchDefault=1 would give a good impression of the\u003cbr\\/\u003e\\noverhead imposed by the patch.\u003c\\/p\u003e\\n\\n\u003cp\u003eThis turns out not to be the case. Nested loop joins do in fact use\u003cbr\\/\u003e\\nthe default bulk fetch size (16) both for accesses to the outer table\u003cbr\\/\u003e\\nand to the inner table. The inner table\\/index is accessed through many\u003cbr\\/\u003e\\nshorter scans that frequently return fewer rows than the bulk fetch\u003cbr\\/\u003e\\nsize. But even if that causes frequent release of latches, it doesn\'t\u003cbr\\/\u003e\\ncause copying of the current key, since the scan is done when the\u003cbr\\/\u003e\\nlatch is released, and therefore we don\'t need the position\u003cbr\\/\u003e\\nanymore. So the nested loop joins will actually get much of the\u003cbr\\/\u003e\\nperformance benefit observed in single-record primary key selects\u003cbr\\/\u003e\\nmentioned when the preview-1c patch was uploaded.\u003c\\/p\u003e\\n\\n\u003cp\u003eI inserted some optimizer overrides in the index_join test in\u003cbr\\/\u003e\\norg.apache.derbyTesting.perf.clients.Runner to make the optimizer pick\u003cbr\\/\u003e\\na nested loop join. With the modified test, the throughput appeared to\u003cbr\\/\u003e\\nincrease by about 6% when the patch was applied (average of 30 runs\u003cbr\\/\u003e\\nwith each configuration).\u003c\\/p\u003e\\n\\n\u003cp\u003eSo here\'s what it looks to me as if the performance impact is:\u003c\\/p\u003e\\n\\n\u003cp\u003ea) Short index scans get increased performance because they don\'t need\u003cbr\\/\u003e\\nto obtain the scan lock, and because saving the position is not needed\u003cbr\\/\u003e\\nsince they complete before they release the latch.\u003c\\/p\u003e\\n\\n\u003cp\u003eb) Long index scans don\'t get very much affected by the patch (there\'s\u003cbr\\/\u003e\\nextra cost in saving keys, but that only happens for every 16th row,\u003cbr\\/\u003e\\nand there\'s a per page reduction in cost by obtaining the scan lock)\u003c\\/p\u003e\\n\\n\u003cp\u003ec) Nested loop joins use (b) to scan the outer table and (a) to scan\u003cbr\\/\u003e\\nthe inner table, so they should not see any negative impact\u003c\\/p\u003e\\n\\n\u003cp\u003ed) Long index scans without bulk fetching get lower performance\u003cbr\\/\u003e\\nbecause they save the position for every qualified row in the index\u003c\\/p\u003e\\n\\n\u003cp\u003eSo the only case identified so far which will get lower performance,\u003cbr\\/\u003e\\nis (d) long index scans without bulk fetching. This kind of scan may\u003cbr\\/\u003e\\nbe used by updatable cursors, but I\'m not aware of any other kind of\u003cbr\\/\u003e\\nqueries that would disable bulk fetching (except when users set\u003cbr\\/\u003e\\nderby.language.bulkFetchDefault, but I don\'t think that\'s a very\u003cbr\\/\u003e\\nimportant case). The overhead appears to be in the range 1%-10%,\u003cbr\\/\u003e\\ndepending on the key.\u003c\\/p\u003e\\n\\n\u003cp\u003eUnless there are other common cases that I haven\'t thought of, it\u003cbr\\/\u003e\\nsounds like an acceptable overhead to me, given that\u003c\\/p\u003e\\n\\n\u003cp\u003ea) updatable cursors aren\'t all that common, and if they are actually\u003cbr\\/\u003e\\nused to update the database, the extra CPU spent by the scan will be\u003cbr\\/\u003e\\nnegligible\u003c\\/p\u003e\\n\\n\u003cp\u003eb) shorter scans see a performance increase in the same order as the\u003cbr\\/\u003e\\ndecrease seen by longer no-bulk scans\u003c\\/p\u003e\\n\\n\u003cp\u003ec) concurrent reads and writes don\'t deadlock anymore unless there\'s a\u003cbr\\/\u003e\\nreal lock conflict\u003c\\/p\u003e\\n\\n\u003cp\u003eComments?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12668514_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12668514_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Jan\\/09 16:48\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-01-29T16:48:10+0000\'\u003e29\\/Jan\\/09 16:48\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I\'ve tried to find out which effect the proposed solution has on \\nnested loop joins. The assumption was earlier that nested loop joins \\nwould turn off bulk fetching and therefore the index scans with \\nderby.language.bulkFetchDefault=1 would give a good impression of the \\noverhead imposed by the patch. \\n\\n This turns out not to be the case. Nested loop joins do in fact use \\nthe default bulk fetch size (16) both for accesses to the outer table \\nand to the inner table. The inner table\\/index is accessed through many \\nshorter scans that frequently return fewer rows than the bulk fetch \\nsize. But even if that causes frequent release of latches, it doesn\'t \\ncause copying of the current key, since the scan is done when the \\nlatch is released, and therefore we don\'t need the position \\nanymore. So the nested loop joins will actually get much of the \\nperformance benefit observed in single-record primary key selects \\nmentioned when the preview-1c patch was uploaded. \\n\\n I inserted some optimizer overrides in the index_join test in \\norg.apache.derbyTesting.perf.clients.Runner to make the optimizer pick \\na nested loop join. With the modified test, the throughput appeared to \\nincrease by about 6% when the patch was applied (average of 30 runs \\nwith each configuration). \\n\\n So here\'s what it looks to me as if the performance impact is: \\n\\n a) Short index scans get increased performance because they don\'t need \\nto obtain the scan lock, and because saving the position is not needed \\nsince they complete before they release the latch. \\n\\n b) Long index scans don\'t get very much affected by the patch (there\'s \\nextra cost in saving keys, but that only happens for every 16th row, \\nand there\'s a per page reduction in cost by obtaining the scan lock) \\n\\n c) Nested loop joins use (b) to scan the outer table and (a) to scan \\nthe inner table, so they should not see any negative impact \\n\\n d) Long index scans without bulk fetching get lower performance \\nbecause they save the position for every qualified row in the index \\n\\n So the only case identified so far which will get lower performance, \\nis (d) long index scans without bulk fetching. This kind of scan may \\nbe used by updatable cursors, but I\'m not aware of any other kind of \\nqueries that would disable bulk fetching (except when users set \\nderby.language.bulkFetchDefault, but I don\'t think that\'s a very \\nimportant case). The overhead appears to be in the range 1%-10%, \\ndepending on the key. \\n\\n Unless there are other common cases that I haven\'t thought of, it \\nsounds like an acceptable overhead to me, given that \\n\\n a) updatable cursors aren\'t all that common, and if they are actually \\nused to update the database, the extra CPU spent by the scan will be \\nnegligible \\n\\n b) shorter scans see a performance increase in the same order as the \\ndecrease seen by longer no-bulk scans \\n\\n c) concurrent reads and writes don\'t deadlock anymore unless there\'s a \\nreal lock conflict \\n\\n Comments?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12669401\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12669401&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12669401\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12669401_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12669401_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Feb\\/09 16:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-02-01T16:50:01+0000\'\u003e01\\/Feb\\/09 16:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI think your performance testing has been superb: detailed and thorough.\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'m comfortable with the performance impact of this change.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe deadlock is a serious problem, experienced by many users, and I think\u003cbr\\/\u003e\\nthis proposed fix is great. +1 from me to proceed with committing your patch.\u003cbr\\/\u003e\\nLet\'s get it into the codeline and start getting some wider experience with it.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12669401_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12669401_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Feb\\/09 16:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-02-01T16:50:01+0000\'\u003e01\\/Feb\\/09 16:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I think your performance testing has been superb: detailed and thorough. \\n\\n I\'m comfortable with the performance impact of this change. \\n\\n The deadlock is a serious problem, experienced by many users, and I think \\nthis proposed fix is great. +1 from me to proceed with committing your patch. \\nLet\'s get it into the codeline and start getting some wider experience with it.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12669461\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12669461&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12669461\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12669461_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12669461_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Feb\\/09 22:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-02-01T22:02:15+0000\'\u003e01\\/Feb\\/09 22:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks for your comments, Bryan. I agree that if we go for this approach, it is better to get the code in early to get as much testing as possible before the next release. But I think the preview patches need to be cleaned up and have some more comments before they\'re ready to be committed. I\'m also about to start writing more functional tests, as I don\'t trust that the existing tests exercise all the new code paths. At the very least, I would like to have tests for all calls to reposition() in situations where the calls actually lead to a full repositioning from the root of the B-tree. Most of those cases are not tested by the existing tests because they would likely have led to timeouts.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12669461_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12669461_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Feb\\/09 22:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-02-01T22:02:15+0000\'\u003e01\\/Feb\\/09 22:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks for your comments, Bryan. I agree that if we go for this approach, it is better to get the code in early to get as much testing as possible before the next release. But I think the preview patches need to be cleaned up and have some more comments before they\'re ready to be committed. I\'m also about to start writing more functional tests, as I don\'t trust that the existing tests exercise all the new code paths. At the very least, I would like to have tests for all calls to reposition() in situations where the calls actually lead to a full repositioning from the root of the B-tree. Most of those cases are not tested by the existing tests because they would likely have led to timeouts.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12670426\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12670426&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12670426\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_12670426_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12670426_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Feb\\/09 19:28\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-02-04T19:28:16+0000\'\u003e04\\/Feb\\/09 19:28\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI believe we should go forward with this change in the trunk.  I also am ok with the tested \u003cbr\\/\u003e\\nperformance trade off\'s.  I don\'t think we should backport a change of this magnitude, I think\u003cbr\\/\u003e\\nit is appropriate for a new feature release, hopefully 10.5.  I especially like that after this change\u003cbr\\/\u003e\\nthe code is simpler, the scan locking stuff was complicated and it is great that it can be removed\u003cbr\\/\u003e\\nwith performance sometimes increased and mostly not too affected.\u003c\\/p\u003e\\n\\n\u003cp\u003eOnce the change goes in there may be more work possible to improve performance, but I think\u003cbr\\/\u003e\\nit is fine to get the basic stuff in now.  One thing that comes to mind is to change the default group\u003cbr\\/\u003e\\nfetch size from a fixed size to a page worth.  That had always been a future direction and I think the\u003cbr\\/\u003e\\ninterfaces are there (ie. allow store to set the size of the fetch, and passing variable size groups back\u003cbr\\/\u003e\\nto caller).  This seems even more important as once the latch is given up repositioning costs may\u003cbr\\/\u003e\\nbe higher than before.  \u003c\\/p\u003e\\n\\n\u003cp\u003eKnut, I would be happy to review the entire package one more time, but would rather wait until you do\u003cbr\\/\u003e\\nthe cleanup you mention.  Just post a comment when you are ready.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_12670426_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12670426_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Feb\\/09 19:28\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-02-04T19:28:16+0000\'\u003e04\\/Feb\\/09 19:28\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I believe we should go forward with this change in the trunk.  I also am ok with the tested  \\nperformance trade off\'s.  I don\'t think we should backport a change of this magnitude, I think \\nit is appropriate for a new feature release, hopefully 10.5.  I especially like that after this change \\nthe code is simpler, the scan locking stuff was complicated and it is great that it can be removed \\nwith performance sometimes increased and mostly not too affected. \\n\\n Once the change goes in there may be more work possible to improve performance, but I think \\nit is fine to get the basic stuff in now.  One thing that comes to mind is to change the default group \\nfetch size from a fixed size to a page worth.  That had always been a future direction and I think the \\ninterfaces are there (ie. allow store to set the size of the fetch, and passing variable size groups back \\nto caller).  This seems even more important as once the latch is given up repositioning costs may \\nbe higher than before.   \\n\\n Knut, I would be happy to review the entire package one more time, but would rather wait until you do \\nthe cleanup you mention.  Just post a comment when you are ready.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12670798\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12670798&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12670798\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12670798_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12670798_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Feb\\/09 15:44\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-02-05T15:44:26+0000\'\u003e05\\/Feb\\/09 15:44\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks Mike. I agree that this change should not be back-ported. Increasing the\u003cbr\\/\u003e\\nfetch size sounds like a good idea to me. I guess we should collect this and\u003cbr\\/\u003e\\nother ideas in JIRA issues before we close this issue. I\'ll post a comment when\u003cbr\\/\u003e\\nI have a cleaned up patch ready.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12670798_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12670798_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Feb\\/09 15:44\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-02-05T15:44:26+0000\'\u003e05\\/Feb\\/09 15:44\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks Mike. I agree that this change should not be back-ported. Increasing the \\nfetch size sounds like a good idea to me. I guess we should collect this and \\nother ideas in JIRA issues before we close this issue. I\'ll post a comment when \\nI have a cleaned up patch ready.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12674994\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12674994&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12674994\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12674994_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12674994_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Feb\\/09 13:51\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-02-19T13:51:25+0000\'\u003e19\\/Feb\\/09 13:51\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHere\'s the first attempt to create a test that exercises the new code. It\'s only got two test cases for now, but I\'m posting it anyway. More test cases will come.\u003c\\/p\u003e\\n\\n\u003cp\u003eTest case 1 tests the call to BTreeScan.reposition() in BTreeMaxScan.fetchMaxFromBeginning().\u003cbr\\/\u003e\\n(BTreeMaxScan has another call to reposition() in fetchMax(), but as far as I can see it\'s impossible to reach that call, so I haven\'t added any test case for it.)\u003c\\/p\u003e\\n\\n\u003cp\u003eTest case 2 tests the first call to reposition() in BTreeForwardScan.fetchRows() (there are four more in that method) when the leaf page on which the scan is positioned has been split after the position was saved. (Full repositioning from the root of the B-tree is required in this case.)\u003c\\/p\u003e\\n\\n\u003cp\u003e#1 fails with the patch (assert in sane builds, NPE in insane builds), so there\'s more to investigate. It runs cleanly without the patch.\u003c\\/p\u003e\\n\\n\u003cp\u003e#2 times out without the patch, and runs successfully with the patch.\u003c\\/p\u003e\\n\\n\u003cp\u003eCommitted revision 745866.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12674994_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12674994_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Feb\\/09 13:51\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-02-19T13:51:25+0000\'\u003e19\\/Feb\\/09 13:51\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Here\'s the first attempt to create a test that exercises the new code. It\'s only got two test cases for now, but I\'m posting it anyway. More test cases will come. \\n\\n Test case 1 tests the call to BTreeScan.reposition() in BTreeMaxScan.fetchMaxFromBeginning(). \\n(BTreeMaxScan has another call to reposition() in fetchMax(), but as far as I can see it\'s impossible to reach that call, so I haven\'t added any test case for it.) \\n\\n Test case 2 tests the first call to reposition() in BTreeForwardScan.fetchRows() (there are four more in that method) when the leaf page on which the scan is positioned has been split after the position was saved. (Full repositioning from the root of the B-tree is required in this case.) \\n\\n #1 fails with the patch (assert in sane builds, NPE in insane builds), so there\'s more to investigate. It runs cleanly without the patch. \\n\\n #2 times out without the patch, and runs successfully with the patch. \\n\\n Committed revision 745866.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12675382\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12675382&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12675382\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12675382_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12675382_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Feb\\/09 15:26\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-02-20T15:26:38+0000\'\u003e20\\/Feb\\/09 15:26\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAttaching a patch with more test cases for the calls to reposition() in BTreeForwardScan.fetchRows(). None of the added test cases fail on a clean trunk. One of them fails with the preview-1e patch. This is an expected failure (there\'s a TODO mentioning it in reposition()) where the page has disappeared because of an in-place compress before resuming the scan with a holdable cursor. It fails with an assert in sane builds when calling ControlRow.get(). I had expected it to work in insane builds, but then get() throws a NullPointerException. I guess this should either be resolved by allowing ControlRow.get() to return null when the page has disappeared, or to create a variant of ControlRow.get() which is allowed to return null.\u003c\\/p\u003e\\n\\n\u003cp\u003eCommitted the new test cases to trunk with revision 746273.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12675382_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12675382_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Feb\\/09 15:26\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-02-20T15:26:38+0000\'\u003e20\\/Feb\\/09 15:26\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Attaching a patch with more test cases for the calls to reposition() in BTreeForwardScan.fetchRows(). None of the added test cases fail on a clean trunk. One of them fails with the preview-1e patch. This is an expected failure (there\'s a TODO mentioning it in reposition()) where the page has disappeared because of an in-place compress before resuming the scan with a holdable cursor. It fails with an assert in sane builds when calling ControlRow.get(). I had expected it to work in insane builds, but then get() throws a NullPointerException. I guess this should either be resolved by allowing ControlRow.get() to return null when the page has disappeared, or to create a variant of ControlRow.get() which is allowed to return null. \\n\\n Committed the new test cases to trunk with revision 746273.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12675848\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12675848&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12675848\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12675848_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12675848_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'23\\/Feb\\/09 10:48\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-02-23T10:48:36+0000\'\u003e23\\/Feb\\/09 10:48\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAttaching a patch with two more test cases for BTreeForwardScan.fetchRows(). The test cases exercise the code path taken when an index scan waits for a lock and the current leaf page has been split before it wakes up. One of the test cases is for unique indexes, and the other one is for non-unique indexes (two test cases were needed since the different indexes call reposition() from different places). Both of the test cases fail (lock timeout) on a clean trunk and pass with patch 1e.\u003c\\/p\u003e\\n\\n\u003cp\u003eCommitted revision 746954.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12675848_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12675848_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'23\\/Feb\\/09 10:48\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-02-23T10:48:36+0000\'\u003e23\\/Feb\\/09 10:48\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Attaching a patch with two more test cases for BTreeForwardScan.fetchRows(). The test cases exercise the code path taken when an index scan waits for a lock and the current leaf page has been split before it wakes up. One of the test cases is for unique indexes, and the other one is for non-unique indexes (two test cases were needed since the different indexes call reposition() from different places). Both of the test cases fail (lock timeout) on a clean trunk and pass with patch 1e. \\n\\n Committed revision 746954.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12676266\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12676266&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12676266\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12676266_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12676266_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'24\\/Feb\\/09 13:26\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-02-24T13:26:25+0000\'\u003e24\\/Feb\\/09 13:26\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI\'ve been trying to write test cases for the rest of the calls to BTreeScan.reposition(), but I haven\'t managed to come up with any sensible test cases for IndexSplitDeadlockTest. Some of the calls appear to be unreachable unless we use the internal API. Others are reachable, but in order to test them better than they\'re already tested by other tests (for instance testing that they work if there\'s been a split right before the repositioning) I think we\'ll need to write tests against the internal API for those calls as well. I\'ll defer writing tests against the internal API for now (of course, suggestions of how to test them via the public API are welcome) and instead add more test cases for the places we are saving the position. I added a comment to IndexSplitDeadlockTest describing which calls to reposition() that are not explicitly tested (revision 747371).\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12676266_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12676266_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'24\\/Feb\\/09 13:26\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-02-24T13:26:25+0000\'\u003e24\\/Feb\\/09 13:26\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I\'ve been trying to write test cases for the rest of the calls to BTreeScan.reposition(), but I haven\'t managed to come up with any sensible test cases for IndexSplitDeadlockTest. Some of the calls appear to be unreachable unless we use the internal API. Others are reachable, but in order to test them better than they\'re already tested by other tests (for instance testing that they work if there\'s been a split right before the repositioning) I think we\'ll need to write tests against the internal API for those calls as well. I\'ll defer writing tests against the internal API for now (of course, suggestions of how to test them via the public API are welcome) and instead add more test cases for the places we are saving the position. I added a comment to IndexSplitDeadlockTest describing which calls to reposition() that are not explicitly tested (revision 747371).              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12676991\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12676991&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12676991\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12676991_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12676991_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Feb\\/09 13:22\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-02-26T13:22:32+0000\'\u003e26\\/Feb\\/09 13:22\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI\'m attaching a new patch (d2991-2a.diff) which has these changes\u003cbr\\/\u003e\\ncompared to the preview-1e patch:\u003c\\/p\u003e\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eadded more comments and removed mentioning of scan lock in (some of\u003cbr\\/\u003e\\n  the) existing comments\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eremoved the savedLockedPos flag from BTreeRowPosition and moved back\u003cbr\\/\u003e\\n  to the original approach of just using current_rh != null to\u003cbr\\/\u003e\\n  indicate that the row on the current position was locked. This also\u003cbr\\/\u003e\\n  allows cheap repositioning by record id in more cases than before\u003cbr\\/\u003e\\n  because current_rh is not null as often as it was with the\u003cbr\\/\u003e\\n  preview-1e patch\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003efixed the bug exposed by testBTreeMaxScan_fetchMaxRowFromBeginning\u003cbr\\/\u003e\\n  in IndexSplitDeadlockTest. The problem was that one of the methods\u003cbr\\/\u003e\\n  was passed the scan_position instance variable as an argument. When\u003cbr\\/\u003e\\n  that method called reopenScan(), the instance variable would be\u003cbr\\/\u003e\\n  replaced, but the local variable would remain the same, and this\u003cbr\\/\u003e\\n  inconsistency triggered an assert in the added code. Solved by\u003cbr\\/\u003e\\n  removing the position from the argument list and instead using the\u003cbr\\/\u003e\\n  instance variable directly\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003efixed the bug exposed by\u003cbr\\/\u003e\\n  testBTreeForwardScan_fetchRows_resumeScanAfterCompress. Solved by\u003cbr\\/\u003e\\n  fetching the page with another method that didn\'t fail if the page\u003cbr\\/\u003e\\n  had disappeared, and reposition from the root of the B-tree if the\u003cbr\\/\u003e\\n  page was removed by SYSCS_COMPRESS_TABLE.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eupdated canon for store\\/updatelocksJDBC30.sql which has been added\u003cbr\\/\u003e\\n  to derbyall recently\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eI have just realized that there are some more problems that need to be\u003cbr\\/\u003e\\nresolved, but I think they will have just minor effect on the patch,\u003cbr\\/\u003e\\nso I\'m posting it anyway to allow others to take a look at it and see\u003cbr\\/\u003e\\nif there are more serious problems with it.\u003c\\/p\u003e\\n\\n\u003cp\u003eHere\'s a description of the changes in each file touched by the patch\u003cbr\\/\u003e\\n(excluding the test files which were just updated so that they didn\'t\u003cbr\\/\u003e\\nexpect scan locks in the lock tables, and so that they didn\'t expect\u003cbr\\/\u003e\\nindex split deadlocks):\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eimpl\\/store\\/access\\/sort\\/Scan.java\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eRemoved savePosition() method from the interface because the position\u003cbr\\/\u003e\\nis now always saved by key when the scan doesn\'t hold a latch on the\u003cbr\\/\u003e\\nleaf.\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eimpl\\/store\\/access\\/btree\\/LeafControlRow.java\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eRemoved calls to Scan.saveScanPositions() and\u003cbr\\/\u003e\\nBTreeLockingPolicy.lockScan() before splitting the page, because\u003cbr\\/\u003e\\npositions are always saved by the scan itself now, and because we\u003cbr\\/\u003e\\ndon\'t use scan locks anymore.\u003c\\/p\u003e\\n\\n\u003cp\u003eSet a hint in the page object after splitting to notify the scans that\u003cbr\\/\u003e\\nthey must reposition from the root of the B-tree after a split.\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eimpl\\/store\\/access\\/btree\\/BTreeController.java\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eDon\'t lock scan before purging committed deletes. Set a hint in the\u003cbr\\/\u003e\\npage object to tell the scans that they must reposition from the root\u003cbr\\/\u003e\\nof the B-tree since the row may not be there anymore.\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eimpl\\/store\\/access\\/btree\\/BTreeScan.java\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eRemove locking\\/unlocking of scan.\u003c\\/p\u003e\\n\\n\u003cp\u003eUpdate savePosition() to allow the position to be saved by record id\u003cbr\\/\u003e\\nand by key at the same time, and make it possible to pass in a partial\u003cbr\\/\u003e\\nor a full key to reduce the number of slots that must be fetched from\u003cbr\\/\u003e\\nthe page.\u003c\\/p\u003e\\n\\n\u003cp\u003eUpdate reposition() to reposition by record id if possible and by key\u003cbr\\/\u003e\\nif needed. Repositioning by record id (which is cheaper) is possible\u003cbr\\/\u003e\\nif the row is guaranteed to be on the same page as when the position\u003cbr\\/\u003e\\nwas saved (that is, no split or purge operation has been performed on\u003cbr\\/\u003e\\nthe page after saving the position).\u003c\\/p\u003e\\n\\n\u003cp\u003eUse savePositionAndReleasePage() when returning from the scan in\u003cbr\\/\u003e\\ndelete(), fetch(), doesCurrentPositionQualify() and\u003cbr\\/\u003e\\nisCurrentPositionDeleted().\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eimpl\\/store\\/access\\/btree\\/BTreeMaxScan.java\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eRemove the BTreeRowPosition argument from fetchMaxRowFromBeginning()\u003cbr\\/\u003e\\nto prevent that it goes out of sync with the instance variable\u003cbr\\/\u003e\\nscan_position when reopenScan() is called. Use the fresh instance\u003cbr\\/\u003e\\nvariable instead.\u003c\\/p\u003e\\n\\n\u003cp\u003eRemove references to the scan protection handle.\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eimpl\\/store\\/access\\/btree\\/BTreeRowPosition.java\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eAdd more state (and methods to access the state):\u003c\\/p\u003e\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eparent of the position. That is, which scan owns this\u003cbr\\/\u003e\\n    position. This was needed to allow the position to be saved from\u003cbr\\/\u003e\\n    some methods that didn\'t know which scan it belonged to. Could\u003cbr\\/\u003e\\n    alternatively be solved by passing the scan as an argument to\u003cbr\\/\u003e\\n    those methods (or actually to those methods and their callers)\u003cbr\\/\u003e\\n    which is probably cleaner, but could be performed in a later\u003cbr\\/\u003e\\n    clean-up\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eversion number of the current leaf page when the position was\u003cbr\\/\u003e\\n    saved (used to determine whether full repositioning is needed\u003cbr\\/\u003e\\n    because of split, etc.)\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003etemplate for the key to save (to prevent allocation each time the\u003cbr\\/\u003e\\n    key is saved). When the position is saved by key, this is\u003cbr\\/\u003e\\n    identical to current_positionKey. A separate field was added so\u003cbr\\/\u003e\\n    that we keep the object even when current_positionKey is nulled\u003cbr\\/\u003e\\n    out, but a possibly cleaner solution would be to have just a flag\u003cbr\\/\u003e\\n    telling whether the value in current_positionKey is valid, and\u003cbr\\/\u003e\\n    never reset current_positionKey to null. Could be done in a later\u003cbr\\/\u003e\\n    clean-up\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003efetch descriptor used to fetch the rest of the key in the cases\u003cbr\\/\u003e\\n    where the scan has already fetched parts of the key before saving\u003cbr\\/\u003e\\n    the position\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eimpl\\/store\\/access\\/btree\\/BTreePostCommit.java\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003epurgeRowLevelCommittedDeletes() sets a hint in the page object to\u003cbr\\/\u003e\\nforce scans to reposition from the root of the B-tree when at least\u003cbr\\/\u003e\\none row has been purged from the page.\u003c\\/p\u003e\\n\\n\u003cp\u003eI think the same change should have been made in\u003cbr\\/\u003e\\npurgeCommittedDeletes(). I missed it because the method assumed an\u003cbr\\/\u003e\\nexclusive table lock and therefore didn\'t need a scan lock. Will\u003cbr\\/\u003e\\nupdate the patch later.\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eimpl\\/store\\/access\\/btree\\/OpenBTree.java\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eRemove references to the removed saveScanPositions() method and to the\u003cbr\\/\u003e\\nprotection record handle.\u003c\\/p\u003e\\n\\n\u003cp\u003eMake the debug code that simulates release of latches save the\u003cbr\\/\u003e\\nposition since that\'s what happens if the latches really are released\u003cbr\\/\u003e\\nby the production code now.\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eimpl\\/store\\/access\\/btree\\/index\\/B2IRowLockingRR.java\u003c\\/li\u003e\\n\\t\u003cli\u003eimpl\\/store\\/access\\/btree\\/index\\/B2INoLocking.java\u003c\\/li\u003e\\n\\t\u003cli\u003eimpl\\/store\\/access\\/btree\\/index\\/B2IRowLocking1.java\u003c\\/li\u003e\\n\\t\u003cli\u003eimpl\\/store\\/access\\/btree\\/index\\/B2IRowLocking3.java\u003c\\/li\u003e\\n\\t\u003cli\u003eimpl\\/store\\/access\\/btree\\/BTreeLockingPolicy.java\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eRemove request_scan_lock parameter.\u003c\\/p\u003e\\n\\n\u003cp\u003eRemove code to lock\\/unlock scan.\u003c\\/p\u003e\\n\\n\u003cp\u003eSave position of scan if lock cannot be granted immediately.\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eimpl\\/store\\/access\\/btree\\/BTreeForwardScan.java\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eSave position by key each time the scan returns a group of rows. Use\u003cbr\\/\u003e\\nthe partial (possibly full) key fetched by the scan to make the save\u003cbr\\/\u003e\\nposition operation cheaper.\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eimpl\\/store\\/access\\/RAMTransaction.java\u003c\\/li\u003e\\n\\t\u003cli\u003eimpl\\/store\\/access\\/heap\\/HeapScan.java\u003c\\/li\u003e\\n\\t\u003cli\u003eiapi\\/store\\/access\\/conglomerate\\/ScanManager.java\u003c\\/li\u003e\\n\\t\u003cli\u003eiapi\\/store\\/access\\/conglomerate\\/TransactionManager.java\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eRemove saveScanPositions()\\/savePosition() because the position will\u003cbr\\/\u003e\\nalready have been saved now since we always save the position when we\u003cbr\\/\u003e\\nrelease the latch.\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eimpl\\/store\\/access\\/heap\\/HeapRowLocation.java\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eRemove THROWASSERT from and complete implementation of\u003cbr\\/\u003e\\nsetFrom(DataValueDescriptor) to allow the RowLocation in the index row\u003cbr\\/\u003e\\nto be copied when we save the position.\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eimpl\\/store\\/raw\\/data\\/BasePage.java\u003c\\/li\u003e\\n\\t\u003cli\u003eiapi\\/store\\/raw\\/Page.java\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eRemove reference to protection record handle.\u003c\\/p\u003e\\n\\n\u003cp\u003eAdd code to set the hint that repositioning from the root of the\u003cbr\\/\u003e\\nB-tree is needed.\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eiapi\\/store\\/raw\\/RecordHandle.java\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eRemove constant identifying the record protection handle that we no\u003cbr\\/\u003e\\nlonger use.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12676991_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12676991_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Feb\\/09 13:22\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-02-26T13:22:32+0000\'\u003e26\\/Feb\\/09 13:22\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I\'m attaching a new patch (d2991-2a.diff) which has these changes \\ncompared to the preview-1e patch: \\n\\n \\n\\t added more comments and removed mentioning of scan lock in (some of \\n  the) existing comments \\n \\n\\n\\n \\n\\t removed the savedLockedPos flag from BTreeRowPosition and moved back \\n  to the original approach of just using current_rh != null to \\n  indicate that the row on the current position was locked. This also \\n  allows cheap repositioning by record id in more cases than before \\n  because current_rh is not null as often as it was with the \\n  preview-1e patch \\n \\n\\n\\n \\n\\t fixed the bug exposed by testBTreeMaxScan_fetchMaxRowFromBeginning \\n  in IndexSplitDeadlockTest. The problem was that one of the methods \\n  was passed the scan_position instance variable as an argument. When \\n  that method called reopenScan(), the instance variable would be \\n  replaced, but the local variable would remain the same, and this \\n  inconsistency triggered an assert in the added code. Solved by \\n  removing the position from the argument list and instead using the \\n  instance variable directly \\n \\n\\n\\n \\n\\t fixed the bug exposed by \\n  testBTreeForwardScan_fetchRows_resumeScanAfterCompress. Solved by \\n  fetching the page with another method that didn\'t fail if the page \\n  had disappeared, and reposition from the root of the B-tree if the \\n  page was removed by SYSCS_COMPRESS_TABLE. \\n \\n\\n\\n \\n\\t updated canon for store\\/updatelocksJDBC30.sql which has been added \\n  to derbyall recently \\n \\n\\n\\n I have just realized that there are some more problems that need to be \\nresolved, but I think they will have just minor effect on the patch, \\nso I\'m posting it anyway to allow others to take a look at it and see \\nif there are more serious problems with it. \\n\\n Here\'s a description of the changes in each file touched by the patch \\n(excluding the test files which were just updated so that they didn\'t \\nexpect scan locks in the lock tables, and so that they didn\'t expect \\nindex split deadlocks): \\n\\n \\n\\t impl\\/store\\/access\\/sort\\/Scan.java \\n \\n\\n\\n Removed savePosition() method from the interface because the position \\nis now always saved by key when the scan doesn\'t hold a latch on the \\nleaf. \\n\\n \\n\\t impl\\/store\\/access\\/btree\\/LeafControlRow.java \\n \\n\\n\\n Removed calls to Scan.saveScanPositions() and \\nBTreeLockingPolicy.lockScan() before splitting the page, because \\npositions are always saved by the scan itself now, and because we \\ndon\'t use scan locks anymore. \\n\\n Set a hint in the page object after splitting to notify the scans that \\nthey must reposition from the root of the B-tree after a split. \\n\\n \\n\\t impl\\/store\\/access\\/btree\\/BTreeController.java \\n \\n\\n\\n Don\'t lock scan before purging committed deletes. Set a hint in the \\npage object to tell the scans that they must reposition from the root \\nof the B-tree since the row may not be there anymore. \\n\\n \\n\\t impl\\/store\\/access\\/btree\\/BTreeScan.java \\n \\n\\n\\n Remove locking\\/unlocking of scan. \\n\\n Update savePosition() to allow the position to be saved by record id \\nand by key at the same time, and make it possible to pass in a partial \\nor a full key to reduce the number of slots that must be fetched from \\nthe page. \\n\\n Update reposition() to reposition by record id if possible and by key \\nif needed. Repositioning by record id (which is cheaper) is possible \\nif the row is guaranteed to be on the same page as when the position \\nwas saved (that is, no split or purge operation has been performed on \\nthe page after saving the position). \\n\\n Use savePositionAndReleasePage() when returning from the scan in \\ndelete(), fetch(), doesCurrentPositionQualify() and \\nisCurrentPositionDeleted(). \\n\\n \\n\\t impl\\/store\\/access\\/btree\\/BTreeMaxScan.java \\n \\n\\n\\n Remove the BTreeRowPosition argument from fetchMaxRowFromBeginning() \\nto prevent that it goes out of sync with the instance variable \\nscan_position when reopenScan() is called. Use the fresh instance \\nvariable instead. \\n\\n Remove references to the scan protection handle. \\n\\n \\n\\t impl\\/store\\/access\\/btree\\/BTreeRowPosition.java \\n \\n\\n\\n Add more state (and methods to access the state): \\n\\n \\n\\t parent of the position. That is, which scan owns this \\n    position. This was needed to allow the position to be saved from \\n    some methods that didn\'t know which scan it belonged to. Could \\n    alternatively be solved by passing the scan as an argument to \\n    those methods (or actually to those methods and their callers) \\n    which is probably cleaner, but could be performed in a later \\n    clean-up \\n \\n\\n\\n \\n\\t version number of the current leaf page when the position was \\n    saved (used to determine whether full repositioning is needed \\n    because of split, etc.) \\n \\n\\n\\n \\n\\t template for the key to save (to prevent allocation each time the \\n    key is saved). When the position is saved by key, this is \\n    identical to current_positionKey. A separate field was added so \\n    that we keep the object even when current_positionKey is nulled \\n    out, but a possibly cleaner solution would be to have just a flag \\n    telling whether the value in current_positionKey is valid, and \\n    never reset current_positionKey to null. Could be done in a later \\n    clean-up \\n \\n\\n\\n \\n\\t fetch descriptor used to fetch the rest of the key in the cases \\n    where the scan has already fetched parts of the key before saving \\n    the position \\n \\n\\n\\n \\n\\t impl\\/store\\/access\\/btree\\/BTreePostCommit.java \\n \\n\\n\\n purgeRowLevelCommittedDeletes() sets a hint in the page object to \\nforce scans to reposition from the root of the B-tree when at least \\none row has been purged from the page. \\n\\n I think the same change should have been made in \\npurgeCommittedDeletes(). I missed it because the method assumed an \\nexclusive table lock and therefore didn\'t need a scan lock. Will \\nupdate the patch later. \\n\\n \\n\\t impl\\/store\\/access\\/btree\\/OpenBTree.java \\n \\n\\n\\n Remove references to the removed saveScanPositions() method and to the \\nprotection record handle. \\n\\n Make the debug code that simulates release of latches save the \\nposition since that\'s what happens if the latches really are released \\nby the production code now. \\n\\n \\n\\t impl\\/store\\/access\\/btree\\/index\\/B2IRowLockingRR.java \\n\\t impl\\/store\\/access\\/btree\\/index\\/B2INoLocking.java \\n\\t impl\\/store\\/access\\/btree\\/index\\/B2IRowLocking1.java \\n\\t impl\\/store\\/access\\/btree\\/index\\/B2IRowLocking3.java \\n\\t impl\\/store\\/access\\/btree\\/BTreeLockingPolicy.java \\n \\n\\n\\n Remove request_scan_lock parameter. \\n\\n Remove code to lock\\/unlock scan. \\n\\n Save position of scan if lock cannot be granted immediately. \\n\\n \\n\\t impl\\/store\\/access\\/btree\\/BTreeForwardScan.java \\n \\n\\n\\n Save position by key each time the scan returns a group of rows. Use \\nthe partial (possibly full) key fetched by the scan to make the save \\nposition operation cheaper. \\n\\n \\n\\t impl\\/store\\/access\\/RAMTransaction.java \\n\\t impl\\/store\\/access\\/heap\\/HeapScan.java \\n\\t iapi\\/store\\/access\\/conglomerate\\/ScanManager.java \\n\\t iapi\\/store\\/access\\/conglomerate\\/TransactionManager.java \\n \\n\\n\\n Remove saveScanPositions()\\/savePosition() because the position will \\nalready have been saved now since we always save the position when we \\nrelease the latch. \\n\\n \\n\\t impl\\/store\\/access\\/heap\\/HeapRowLocation.java \\n \\n\\n\\n Remove THROWASSERT from and complete implementation of \\nsetFrom(DataValueDescriptor) to allow the RowLocation in the index row \\nto be copied when we save the position. \\n\\n \\n\\t impl\\/store\\/raw\\/data\\/BasePage.java \\n\\t iapi\\/store\\/raw\\/Page.java \\n \\n\\n\\n Remove reference to protection record handle. \\n\\n Add code to set the hint that repositioning from the root of the \\nB-tree is needed. \\n\\n \\n\\t iapi\\/store\\/raw\\/RecordHandle.java \\n \\n\\n\\n Remove constant identifying the record protection handle that we no \\nlonger use.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12676998\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12676998&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12676998\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12676998_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12676998_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Feb\\/09 13:51\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-02-26T13:51:57+0000\'\u003e26\\/Feb\\/09 13:51\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI know there are at least a couple of issues with the 2a patch, but\u003cbr\\/\u003e\\nI\'m setting the patch available flag anyway because I believe those\u003cbr\\/\u003e\\nissues won\'t cause big changes to the patch, so the patch is in such a\u003cbr\\/\u003e\\nstate that it should be ready for review.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe issues I\'m aware of that need to be resolved, are these:\u003c\\/p\u003e\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eBTreePostCommit.purgeCommittedDeletes() needs to call\u003cbr\\/\u003e\\n  Page.setRepositionNeeded() to tell index scans that they need to\u003cbr\\/\u003e\\n  reposition by key. Since purgeCommittedDeletes() is only called in a\u003cbr\\/\u003e\\n  separate transaction that has an exclusive table lock, I believe\u003cbr\\/\u003e\\n  that this issue could only affect holdable index scans that\u003cbr\\/\u003e\\n  reposition after a commit.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eSome callers of BTreeScan.reposition(pos,false) have\u003cbr\\/\u003e\\n  comments\\/asserts stating that it is impossible that the current row\u003cbr\\/\u003e\\n  has been purged because they hold the scan lock. I think that it is\u003cbr\\/\u003e\\n  now possible that rows are purged from the page if we released the\u003cbr\\/\u003e\\n  latch, so we might need to change how they handle that situation. In\u003cbr\\/\u003e\\n  most cases (except read-uncommitted scans) the scans hold a lock on\u003cbr\\/\u003e\\n  the current row so that it is true that the row cannot have been\u003cbr\\/\u003e\\n  purged.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eFeedback on the patch as it is would be appreciated. I\'ll probably be\u003cbr\\/\u003e\\noffline for a couple of days, so I may not respond immediately to\u003cbr\\/\u003e\\nquestions\\/comments.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12676998_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12676998_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Feb\\/09 13:51\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-02-26T13:51:57+0000\'\u003e26\\/Feb\\/09 13:51\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I know there are at least a couple of issues with the 2a patch, but \\nI\'m setting the patch available flag anyway because I believe those \\nissues won\'t cause big changes to the patch, so the patch is in such a \\nstate that it should be ready for review. \\n\\n The issues I\'m aware of that need to be resolved, are these: \\n\\n \\n\\t BTreePostCommit.purgeCommittedDeletes() needs to call \\n  Page.setRepositionNeeded() to tell index scans that they need to \\n  reposition by key. Since purgeCommittedDeletes() is only called in a \\n  separate transaction that has an exclusive table lock, I believe \\n  that this issue could only affect holdable index scans that \\n  reposition after a commit. \\n \\n\\n\\n \\n\\t Some callers of BTreeScan.reposition(pos,false) have \\n  comments\\/asserts stating that it is impossible that the current row \\n  has been purged because they hold the scan lock. I think that it is \\n  now possible that rows are purged from the page if we released the \\n  latch, so we might need to change how they handle that situation. In \\n  most cases (except read-uncommitted scans) the scans hold a lock on \\n  the current row so that it is true that the row cannot have been \\n  purged. \\n \\n\\n\\n Feedback on the patch as it is would be appreciated. I\'ll probably be \\noffline for a couple of days, so I may not respond immediately to \\nquestions\\/comments.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12680169\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12680169&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12680169\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12680169_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12680169_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Mar\\/09 15:01\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-03-09T15:01:14+0000\'\u003e09\\/Mar\\/09 15:01\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHere\'s an updated patch (d2991-2b.diff) which addresses the two issues I\u003cbr\\/\u003e\\nmentioned that I was aware of in the 2a patch:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) Call Page.setRepositionNeeded() in BTreePostCommit.purgeCommittedDeletes()\u003cbr\\/\u003e\\nwhen a row has been purged.\u003c\\/p\u003e\\n\\n\u003cp\u003e2) Handle the cases where reposition() can return false (that is, second\u003cbr\\/\u003e\\nargument to reposition() is false and the row on the current position has been\u003cbr\\/\u003e\\npurged). This led to the following changes:\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eBTreeScan.positionAtDoneScanFromClose()\u003c\\/li\u003e\\n\\t\u003cli\u003eBTreeScan.reopenScan()\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003e  Removed the calls to reposition(). The only reason I could see for these\u003cbr\\/\u003e\\n  methods to call reposition() was that some implementations of\u003cbr\\/\u003e\\n  BTreeLockingPolicy.unlockScanRecordAfterRead() had asserts that checked that\u003cbr\\/\u003e\\n  the page of the current position was latched. Removing the calls (and the\u003cbr\\/\u003e\\n  asserts) made the code simpler and removed the need for special handling if\u003cbr\\/\u003e\\n  reposition() was unsuccessful.\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eB2IRowLockingRR.unlockScanRecordAfterRead()\u003c\\/li\u003e\\n\\t\u003cli\u003eB2IRowLocking2.unlockScanRecordAfterRead()\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003e  Don\'t assert that the current leaf is latched, as there is no need for that\u003cbr\\/\u003e\\n  latch in order to unlock the record. (See above.)\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eBTreeScan.delete()\u003c\\/li\u003e\\n\\t\u003cli\u003eBTreeScan.doesCurrentPositionQualify()\u003c\\/li\u003e\\n\\t\u003cli\u003eBTreeScan.fetch()\u003c\\/li\u003e\\n\\t\u003cli\u003eBTreeScan.isCurrentPositionDeleted()\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003e  Make sure that we don\'t try to release the latch on the current leaf unless\u003cbr\\/\u003e\\n  we have actually latched it, since the leaf won\'t be latched if reposition()\u003cbr\\/\u003e\\n  returns false. No other special handling of purged rows is needed in those\u003cbr\\/\u003e\\n  methods, I think. delete() and fetch() throw an exception\u003cbr\\/\u003e\\n  (AM_RECORD_NOT_FOUND) if the row has been purged, which sounds reasonable to\u003cbr\\/\u003e\\n  me. doesCurrentPositionQualify() and isCurrentPositionDeleted() use the\u003cbr\\/\u003e\\n  return value from reposition() to decide what they should return themselves,\u003cbr\\/\u003e\\n  which also sounds fine to me (except that I would expect that\u003cbr\\/\u003e\\n  isCurrentPositionDeleted() returned true if the row was purged, but currently\u003cbr\\/\u003e\\n  it returns false &#8211; will file a separate bug for that).\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eBTreeMaxScan.fetchMaxRowFromBeginning()\u003c\\/li\u003e\\n\\t\u003cli\u003eBTreeForwardScan.fetchRows()\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003e  If the row on the current position of the scan has been purged while we were\u003cbr\\/\u003e\\n  waiting for a lock so that reposition(pos,false) returns false, we call\u003cbr\\/\u003e\\n  reposition() again with second argument true to reposition on the row\u003cbr\\/\u003e\\n  immediately to the left of where the purged row was supposed to be. This\u003cbr\\/\u003e\\n  effectively takes one step back in the scan, so therefore we need to jump to\u003cbr\\/\u003e\\n  the top of the loop\'s body to move one step forward past the purged row.\u003c\\/p\u003e\\n\\n\u003cp\u003eI tested that reposition(pos,false) followed by reposition(pos,true) worked by\u003cbr\\/\u003e\\nsetting a breakpoint in the debugger and manually changing values in the page\u003cbr\\/\u003e\\nobject and in the position to make the scan code believe that the row had been\u003cbr\\/\u003e\\npurged. As far as I could tell, it worked just as if the scan had found a\u003cbr\\/\u003e\\ndeleted row. (There are currently no tests that exercise code paths where\u003cbr\\/\u003e\\nreposition() returns false, and I don\'t see any easy way to write a test for it\u003cbr\\/\u003e\\nsince it would be highly dependent on timing between user threads and service\u003cbr\\/\u003e\\nthreads.)\u003c\\/p\u003e\\n\\n\u003cp\u003eThis patch fixes all the issues I\'m aware of in the previous patch. Derbyall\u003cbr\\/\u003e\\nand suites.All ran cleanly. Reviews, comments and questions would be\u003cbr\\/\u003e\\nappreciated. Thanks.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12680169_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12680169_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Mar\\/09 15:01\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-03-09T15:01:14+0000\'\u003e09\\/Mar\\/09 15:01\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Here\'s an updated patch (d2991-2b.diff) which addresses the two issues I \\nmentioned that I was aware of in the 2a patch: \\n\\n 1) Call Page.setRepositionNeeded() in BTreePostCommit.purgeCommittedDeletes() \\nwhen a row has been purged. \\n\\n 2) Handle the cases where reposition() can return false (that is, second \\nargument to reposition() is false and the row on the current position has been \\npurged). This led to the following changes: \\n\\n \\n\\t BTreeScan.positionAtDoneScanFromClose() \\n\\t BTreeScan.reopenScan() \\n \\n\\n\\n   Removed the calls to reposition(). The only reason I could see for these \\n  methods to call reposition() was that some implementations of \\n  BTreeLockingPolicy.unlockScanRecordAfterRead() had asserts that checked that \\n  the page of the current position was latched. Removing the calls (and the \\n  asserts) made the code simpler and removed the need for special handling if \\n  reposition() was unsuccessful. \\n\\n \\n\\t B2IRowLockingRR.unlockScanRecordAfterRead() \\n\\t B2IRowLocking2.unlockScanRecordAfterRead() \\n \\n\\n\\n   Don\'t assert that the current leaf is latched, as there is no need for that \\n  latch in order to unlock the record. (See above.) \\n\\n \\n\\t BTreeScan.delete() \\n\\t BTreeScan.doesCurrentPositionQualify() \\n\\t BTreeScan.fetch() \\n\\t BTreeScan.isCurrentPositionDeleted() \\n \\n\\n\\n   Make sure that we don\'t try to release the latch on the current leaf unless \\n  we have actually latched it, since the leaf won\'t be latched if reposition() \\n  returns false. No other special handling of purged rows is needed in those \\n  methods, I think. delete() and fetch() throw an exception \\n  (AM_RECORD_NOT_FOUND) if the row has been purged, which sounds reasonable to \\n  me. doesCurrentPositionQualify() and isCurrentPositionDeleted() use the \\n  return value from reposition() to decide what they should return themselves, \\n  which also sounds fine to me (except that I would expect that \\n  isCurrentPositionDeleted() returned true if the row was purged, but currently \\n  it returns false &#8211; will file a separate bug for that). \\n\\n \\n\\t BTreeMaxScan.fetchMaxRowFromBeginning() \\n\\t BTreeForwardScan.fetchRows() \\n \\n\\n\\n   If the row on the current position of the scan has been purged while we were \\n  waiting for a lock so that reposition(pos,false) returns false, we call \\n  reposition() again with second argument true to reposition on the row \\n  immediately to the left of where the purged row was supposed to be. This \\n  effectively takes one step back in the scan, so therefore we need to jump to \\n  the top of the loop\'s body to move one step forward past the purged row. \\n\\n I tested that reposition(pos,false) followed by reposition(pos,true) worked by \\nsetting a breakpoint in the debugger and manually changing values in the page \\nobject and in the position to make the scan code believe that the row had been \\npurged. As far as I could tell, it worked just as if the scan had found a \\ndeleted row. (There are currently no tests that exercise code paths where \\nreposition() returns false, and I don\'t see any easy way to write a test for it \\nsince it would be highly dependent on timing between user threads and service \\nthreads.) \\n\\n This patch fixes all the issues I\'m aware of in the previous patch. Derbyall \\nand suites.All ran cleanly. Reviews, comments and questions would be \\nappreciated. Thanks.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12681374\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12681374&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12681374\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12681374_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12681374_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Mar\\/09 16:13\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-03-12T16:13:53+0000\'\u003e12\\/Mar\\/09 16:13\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI would feel more comfortable with committing this patch if another pair of eyes had looked at it first, but since it was suggested earlier that it would be good to get the fix into the codeline as soon as possible to get more experience with it, I plan to commit the patch on Monday before the 10.5 branch is created unless I hear anything. Please let me know if you have objections to this approach. Of course, reviews and comments are welcome even after the patch has been committed.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12681374_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12681374_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Mar\\/09 16:13\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-03-12T16:13:53+0000\'\u003e12\\/Mar\\/09 16:13\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I would feel more comfortable with committing this patch if another pair of eyes had looked at it first, but since it was suggested earlier that it would be good to get the fix into the codeline as soon as possible to get more experience with it, I plan to commit the patch on Monday before the 10.5 branch is created unless I hear anything. Please let me know if you have objections to this approach. Of course, reviews and comments are welcome even after the patch has been committed.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12682319\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12682319&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12682319\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12682319_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12682319_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Mar\\/09 14:03\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-03-16T14:03:47+0000\'\u003e16\\/Mar\\/09 14:03\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eCommitted the 2b patch with revision 754894.\u003c\\/p\u003e\\n\\n\u003cp\u003eThere still are references to the scan locks in some comments I think. I will try to track them down and update them in a follow-up.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12682319_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12682319_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Mar\\/09 14:03\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-03-16T14:03:47+0000\'\u003e16\\/Mar\\/09 14:03\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Committed the 2b patch with revision 754894. \\n\\n There still are references to the scan locks in some comments I think. I will try to track them down and update them in a follow-up.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12682321\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12682321&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12682321\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12682321_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12682321_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Mar\\/09 14:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-03-16T14:16:51+0000\'\u003e16\\/Mar\\/09 14:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eIndexSplitDeadlockTest has now been enabled as part of suites.All (patch test-4.diff) since the main fix has gone in. Committed revision 754900.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12682321_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12682321_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Mar\\/09 14:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-03-16T14:16:51+0000\'\u003e16\\/Mar\\/09 14:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    IndexSplitDeadlockTest has now been enabled as part of suites.All (patch test-4.diff) since the main fix has gone in. Committed revision 754900.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12682898\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12682898&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12682898\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"myrna\\\" id=\\\"commentauthor_12682898_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=myrna\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"myrna\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Myrna van Lunteren\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12682898_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Mar\\/09 03:37\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-03-18T03:37:56+0000\'\u003e18\\/Mar\\/09 03:37\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eCan this isssue be closed as fixed in 10.5 and subsequent\\/remaining issues be pursued in a new JIRA?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"myrna\\\" id=\\\"commentauthor_12682898_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=myrna\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"myrna\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Myrna van Lunteren\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12682898_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Mar\\/09 03:37\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-03-18T03:37:56+0000\'\u003e18\\/Mar\\/09 03:37\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Can this isssue be closed as fixed in 10.5 and subsequent\\/remaining issues be pursued in a new JIRA?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12683061\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12683061&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12683061\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12683061_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12683061_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Mar\\/09 16:32\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-03-18T16:32:00+0000\'\u003e18\\/Mar\\/09 16:32\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eYes, I think we can mark this issue as resolved now and address remaining cleanup, and bugs if they turn up, in separate issues.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12683061_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12683061_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Mar\\/09 16:32\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-03-18T16:32:00+0000\'\u003e18\\/Mar\\/09 16:32\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Yes, I think we can mark this issue as resolved now and address remaining cleanup, and bugs if they turn up, in separate issues.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12719690\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12719690&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12719690\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mamtas\\\" id=\\\"commentauthor_12719690_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mamtas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mamtas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mamta A. Satoor\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12719690_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Jun\\/09 18:31\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-06-15T18:31:39+0000\'\u003e15\\/Jun\\/09 18:31\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI recently merged changes for \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-3926\\\" title=\\\"Incorrect ORDER BY caused by index\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-3926\\\"\u003e\u003cdel\u003eDERBY-3926\u003c\\/del\u003e\u003c\\/a\u003e into 10.5.1.2 codeline (revision 784809) and I ran the junit tests on the merged code. The tests finished with one \\\"A lock could not be obtained within the time requested\\\". Kathey recommended that I post that failure here since it may be related to this jira entry. Following is the stack track from text junit runner (junit.textui.TestRunner)\u003cbr\\/\u003e\\nThere was 1 error:\u003cbr\\/\u003e\\n1) testBTreeForwardScan_fetchRows_resumeAfterWait_nonUnique_split(org.apache.derbyTesting.functionTests.tests.store.IndexSplitDeadlockTest)java.sql.SQLException: A lock could not be obtained within the time requested\u003cbr\\/\u003e\\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:45)\u003cbr\\/\u003e\\n        at org.apache.derby.impl.jdbc.Util.generateCsSQLException(Util.java:201)\u003cbr\\/\u003e\\n        at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:391)\u003cbr\\/\u003e\\n        at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(TransactionResourceImpl.java:346)\u003cbr\\/\u003e\\n        at org.apache.derby.impl.jdbc.EmbedConnection.handleException(EmbedConnection.java:2201)\u003cbr\\/\u003e\\n        at org.apache.derby.impl.jdbc.ConnectionChild.handleException(ConnectionChild.java:81)\u003cbr\\/\u003e\\n        at org.apache.derby.impl.jdbc.EmbedResultSet.closeOnTransactionError(EmbedResultSet.java:4338)\u003cbr\\/\u003e\\n        at org.apache.derby.impl.jdbc.EmbedResultSet.movePosition(EmbedResultSet.java:467)\u003cbr\\/\u003e\\n        at org.apache.derby.impl.jdbc.EmbedResultSet.next(EmbedResultSet.java:371)\u003cbr\\/\u003e\\n        at org.apache.derbyTesting.functionTests.tests.store.IndexSplitDeadlockTest.testBTreeForwardScan_fetchRows_resumeAfterWait_nonUnique_split(IndexSplitDeadlockTest.java:489)\u003cbr\\/\u003e\\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\u003cbr\\/\u003e\\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:79)\u003cbr\\/\u003e\\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\u003cbr\\/\u003e\\n        at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:106)\u003cbr\\/\u003e\\n        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)\u003cbr\\/\u003e\\n        at junit.extensions.TestSetup$1.protect(TestSetup.java:19)\u003cbr\\/\u003e\\n        at junit.extensions.TestSetup.run(TestSetup.java:23)\u003cbr\\/\u003e\\n        at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)\u003cbr\\/\u003e\\n        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22)\u003cbr\\/\u003e\\n        at junit.extensions.TestSetup$1.protect(TestSetup.java:19)\u003cbr\\/\u003e\\n        at junit.extensions.TestSetup.run(TestSetup.java:23)\u003cbr\\/\u003e\\n        at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57)\u003cbr\\/\u003e\\nCaused by: ERROR 40XL1: A lock could not be obtained within the time requested at org.apache.derby.iapi.error.StandardException.newException(StandardException.java:276)\u003cbr\\/\u003e\\n        at org.apache.derby.impl.services.locks.ConcurrentLockSet.lockObject(ConcurrentLockSet.java:602)\u003cbr\\/\u003e\\n        at org.apache.derby.impl.services.locks.ConcurrentLockSet.zeroDurationLockObject(ConcurrentLockSet.java:855)\u003cbr\\/\u003e\\n        at org.apache.derby.impl.services.locks.AbstractPool.zeroDurationlockObject(AbstractPool.java:297)\u003cbr\\/\u003e\\n        at org.apache.derby.impl.store.raw.xact.RowLocking2nohold.lockRecordForRead(RowLocking2nohold.java:89)\u003cbr\\/\u003e\\n        at org.apache.derby.impl.store.access.heap.HeapController.lockRow(HeapController.java:520)\u003cbr\\/\u003e\\n        at org.apache.derby.impl.store.access.heap.HeapController.lockRow(HeapController.java:638)\u003cbr\\/\u003e\\n        at org.apache.derby.impl.store.access.btree.index.B2IRowLocking3.lockRowOnPage(B2IRowLocking3.java:309)\u003cbr\\/\u003e\\n        at org.apache.derby.impl.store.access.btree.index.B2IRowLocking3._lockScanRow(B2IRowLocking3.java:599)\u003cbr\\/\u003e\\n        at org.apache.derby.impl.store.access.btree.index.B2IRowLockingRR.lockScanRow(B2IRowLockingRR.java:105)\u003cbr\\/\u003e\\n        at org.apache.derby.impl.store.access.btree.BTreeForwardScan.fetchRows(BTreeForwardScan.java:305)\u003cbr\\/\u003e\\n        at org.apache.derby.impl.store.access.btree.BTreeScan.fetchNextGroup(BTreeScan.java:1585)\u003cbr\\/\u003e\\n        at org.apache.derby.impl.sql.execute.BulkTableScanResultSet.reloadArray(BulkTableScanResultSet.java:327)\u003cbr\\/\u003e\\n        at org.apache.derby.impl.sql.execute.BulkTableScanResultSet.getNextRowCore(BulkTableScanResultSet.java:282)\u003cbr\\/\u003e\\n        at org.apache.derby.impl.sql.execute.BasicNoPutResultSetImpl.getNextRow(BasicNoPutResultSetImpl.java:460)\u003cbr\\/\u003e\\n        at org.apache.derby.impl.jdbc.EmbedResultSet.movePosition(EmbedResultSet.java:427)\u003cbr\\/\u003e\\n        ... 34 more\u003c\\/p\u003e\\n\\n\u003cp\u003eFAILURES!!!\u003cbr\\/\u003e\\nTests run: 9258,  Failures: 0,  Errors: 1\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mamtas\\\" id=\\\"commentauthor_12719690_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mamtas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mamtas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mamta A. Satoor\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12719690_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Jun\\/09 18:31\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-06-15T18:31:39+0000\'\u003e15\\/Jun\\/09 18:31\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I recently merged changes for   DERBY-3926   into 10.5.1.2 codeline (revision 784809) and I ran the junit tests on the merged code. The tests finished with one \\\"A lock could not be obtained within the time requested\\\". Kathey recommended that I post that failure here since it may be related to this jira entry. Following is the stack track from text junit runner (junit.textui.TestRunner) \\nThere was 1 error: \\n1) testBTreeForwardScan_fetchRows_resumeAfterWait_nonUnique_split(org.apache.derbyTesting.functionTests.tests.store.IndexSplitDeadlockTest)java.sql.SQLException: A lock could not be obtained within the time requested \\n        at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:45) \\n        at org.apache.derby.impl.jdbc.Util.generateCsSQLException(Util.java:201) \\n        at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:391) \\n        at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(TransactionResourceImpl.java:346) \\n        at org.apache.derby.impl.jdbc.EmbedConnection.handleException(EmbedConnection.java:2201) \\n        at org.apache.derby.impl.jdbc.ConnectionChild.handleException(ConnectionChild.java:81) \\n        at org.apache.derby.impl.jdbc.EmbedResultSet.closeOnTransactionError(EmbedResultSet.java:4338) \\n        at org.apache.derby.impl.jdbc.EmbedResultSet.movePosition(EmbedResultSet.java:467) \\n        at org.apache.derby.impl.jdbc.EmbedResultSet.next(EmbedResultSet.java:371) \\n        at org.apache.derbyTesting.functionTests.tests.store.IndexSplitDeadlockTest.testBTreeForwardScan_fetchRows_resumeAfterWait_nonUnique_split(IndexSplitDeadlockTest.java:489) \\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) \\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:79) \\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) \\n        at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:106) \\n        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22) \\n        at junit.extensions.TestSetup$1.protect(TestSetup.java:19) \\n        at junit.extensions.TestSetup.run(TestSetup.java:23) \\n        at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57) \\n        at junit.extensions.TestDecorator.basicRun(TestDecorator.java:22) \\n        at junit.extensions.TestSetup$1.protect(TestSetup.java:19) \\n        at junit.extensions.TestSetup.run(TestSetup.java:23) \\n        at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:57) \\nCaused by: ERROR 40XL1: A lock could not be obtained within the time requested at org.apache.derby.iapi.error.StandardException.newException(StandardException.java:276) \\n        at org.apache.derby.impl.services.locks.ConcurrentLockSet.lockObject(ConcurrentLockSet.java:602) \\n        at org.apache.derby.impl.services.locks.ConcurrentLockSet.zeroDurationLockObject(ConcurrentLockSet.java:855) \\n        at org.apache.derby.impl.services.locks.AbstractPool.zeroDurationlockObject(AbstractPool.java:297) \\n        at org.apache.derby.impl.store.raw.xact.RowLocking2nohold.lockRecordForRead(RowLocking2nohold.java:89) \\n        at org.apache.derby.impl.store.access.heap.HeapController.lockRow(HeapController.java:520) \\n        at org.apache.derby.impl.store.access.heap.HeapController.lockRow(HeapController.java:638) \\n        at org.apache.derby.impl.store.access.btree.index.B2IRowLocking3.lockRowOnPage(B2IRowLocking3.java:309) \\n        at org.apache.derby.impl.store.access.btree.index.B2IRowLocking3._lockScanRow(B2IRowLocking3.java:599) \\n        at org.apache.derby.impl.store.access.btree.index.B2IRowLockingRR.lockScanRow(B2IRowLockingRR.java:105) \\n        at org.apache.derby.impl.store.access.btree.BTreeForwardScan.fetchRows(BTreeForwardScan.java:305) \\n        at org.apache.derby.impl.store.access.btree.BTreeScan.fetchNextGroup(BTreeScan.java:1585) \\n        at org.apache.derby.impl.sql.execute.BulkTableScanResultSet.reloadArray(BulkTableScanResultSet.java:327) \\n        at org.apache.derby.impl.sql.execute.BulkTableScanResultSet.getNextRowCore(BulkTableScanResultSet.java:282) \\n        at org.apache.derby.impl.sql.execute.BasicNoPutResultSetImpl.getNextRow(BasicNoPutResultSetImpl.java:460) \\n        at org.apache.derby.impl.jdbc.EmbedResultSet.movePosition(EmbedResultSet.java:427) \\n        ... 34 more \\n\\n FAILURES!!! \\nTests run: 9258,  Failures: 0,  Errors: 1              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12719838\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12719838&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12719838\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12719838_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12719838_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Jun\\/09 22:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-06-15T22:53:04+0000\'\u003e15\\/Jun\\/09 22:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eYes, that test was added here. It requires some coordination between two threads, so my first guess would be that there is a timing issue in the test. Please file a separate JIRA issue for this failure. Thanks.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12719838_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12719838_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Jun\\/09 22:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-06-15T22:53:04+0000\'\u003e15\\/Jun\\/09 22:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Yes, that test was added here. It requires some coordination between two threads, so my first guess would be that there is a timing issue in the test. Please file a separate JIRA issue for this failure. Thanks.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12719859\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-2991?focusedCommentId=12719859&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12719859\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mamtas\\\" id=\\\"commentauthor_12719859_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mamtas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mamtas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mamta A. Satoor\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12719859_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Jun\\/09 23:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-06-15T23:53:02+0000\'\u003e15\\/Jun\\/09 23:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eKnut, thanks for looking at the stack trace. I added jira \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-4273\\\" title=\\\"A lock could not be obtained within the time requested error in testBTreeForwardScan_fetchRows_resumeAfterWait_nonUnique_split\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-4273\\\"\u003e\u003cdel\u003eDERBY-4273\u003c\\/del\u003e\u003c\\/a\u003e for the test failure. \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mamtas\\\" id=\\\"commentauthor_12719859_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mamtas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mamtas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mamta A. Satoor\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12719859_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Jun\\/09 23:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2009-06-15T23:53:02+0000\'\u003e15\\/Jun\\/09 23:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Knut, thanks for looking at the stack trace. I added jira   DERBY-4273   for the test failure.               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\"";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["scope-filter-data"]="{\"createScopeActions\":[],\"scopes\":[]}";
WRM._unparsedData["sidebar-collapsed-by-default"]="true";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:can-manage"]="false";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:with-icons"]="false";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:shortcuts"]="[]";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:project-id"]="10594";
WRM._unparsedData["sidebar-id"]="\"\u003cdiv class=\\\"aui-sidebar  projects-sidebar sidebar-pending\\\" \u003e\u003cdiv class=\\\"aui-sidebar-wrapper\\\"\u003e\u003cdiv class=\\\"aui-sidebar-body\\\"\u003e\u003cheader class=\\\"aui-page-header\\\"\u003e\u003cdiv class=\\\"aui-page-header-inner\\\"\u003e\u003cdiv class=\\\"aui-page-header-image\\\"\u003e\u003ca href=\\\"\\/jira\\/projects\\/DERBY\\/summary\\\" title=\\\"Derby\\\" class=\\\"jira-project-avatar\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-large aui-avatar-project\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"\\/jira\\/secure\\/projectavatar?pid=10594&amp;avatarId=10122\\\" alt=\\\"Derby\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e\u003cimg src=\\\"data:image\\/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI\\/Pg0KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDE4LjEuMSwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPg0KPHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCINCgkgdmlld0JveD0iMCAwIDMwMCAzMDAiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDMwMCAzMDA7IiB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxnIGlkPSJMYXllcl8yIj4NCgk8cGF0aCBzdHlsZT0iZmlsbDojRjc5MjMyOyIgZD0iTTE1MCwwQzY2LjY2NywwLDAsNjYuNjY3LDAsMTUwczY2LjY2NywxNTAsMTUwLDE1MHMxNTAtNjYuNjY3LDE1MC0xNTBTMjMzLjMzMywwLDE1MCwweg0KCQkgTTEzNi42NjcsMTc4LjMzM0wxMjUsMTkwbC00MS42NjctNDBMOTUsMTM4LjMzM2wzMC0zMEwxMzYuNjY3LDEyMGwtMzAsMzBMMTM2LjY2NywxNzguMzMzeiBNMjA1LDE2MS42NjdsLTMwLDMwTDE2My4zMzMsMTgwDQoJCWwzMC0zMGwtMzAtMzBMMTc1LDEwOC4zMzNMMjE2LjY2NywxNTBMMjA1LDE2MS42Njd6Ii8+DQo8L2c+DQo8Zz4NCgk8cG9seWdvbiBzdHlsZT0iZmlsbDojRkZGRkZGOyIgcG9pbnRzPSIxNzUsMTkxLjY2NyAyMDUsMTYxLjY2NyAyMTYuNjY3LDE1MCAxNzUsMTA4LjMzMyAxNjMuMzMzLDEyMCAxOTMuMzMzLDE1MCAxNjMuMzMzLDE4MCAJIi8+DQoJPHBvbHlnb24gc3R5bGU9ImZpbGw6I0ZGRkZGRjsiIHBvaW50cz0iMTI1LDEwOC4zMzMgOTUsMTM4LjMzMyA4My4zMzMsMTUwIDEyNSwxOTAgMTM2LjY2NywxNzguMzMzIDEwNi42NjcsMTUwIDEzNi42NjcsMTIwIAkiLz4NCjwvZz4NCjwvc3ZnPg0K\\\" alt=\\\"Icon indicating the project type\\\" class=\\\"jira-project-avatar-icon\\\" \\/\u003e\u003c\\/a\u003e\u003c\\/div\u003e\u003c!-- .aui-page-header-image --\u003e\u003cdiv class=\\\"aui-page-header-main\\\"\u003e\u003ch1\u003e\u003cdiv class=\\\"aui-group aui-group-split\\\"\u003e\u003cdiv class=\\\"aui-item project-title\\\"\u003e\u003ca href=\\\"\\/jira\\/projects\\/DERBY\\/summary\\\" title=\\\"Derby\\\"\u003eDerby\u003c\\/a\u003e\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/h1\u003e\u003c\\/div\u003e\u003c!-- .aui-page-header-main --\u003e\u003c\\/div\u003e\u003c!-- .aui-page-header-inner --\u003e\u003c\\/header\u003e\u003c!-- .aui-page-header --\u003e\u003cnav class=\\\"aui-navgroup aui-navgroup-vertical\\\"\u003e\u003cdiv class=\\\"aui-navgroup-inner sidebar-content-container\\\"\u003e\u003cdiv class=\\\"aui-sidebar-group aui-sidebar-group-tier-one\\\" data-id=\\\"sidebar-navigation-panel\\\"\u003e\u003cul class=\\\"aui-nav\\\"\u003e\u003cli class=\\\"aui-nav-selected\\\" \u003e\u003ca class=\\\"aui-nav-item \\\" href=\\\"\\/jira\\/projects\\/DERBY\\/issues\\\" data-link-id=\\\"com.atlassian.jira.jira-projects-issue-navigator:sidebar-issue-navigator\\\" \u003e\u003cspan class=\\\"aui-icon aui-icon-large icon-sidebar-issues\\\"\u003e\u003c\\/span\u003e\u003cspan class=\\\"aui-nav-item-label\\\" title=\\\"Issues\\\"\u003eIssues\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/li\u003e\u003cli  \u003e\u003ca class=\\\"aui-nav-item \\\" href=\\\"\\/jira\\/projects\\/DERBY?selectedItem=com.atlassian.jira.jira-projects-plugin:report-page\\\" data-link-id=\\\"com.atlassian.jira.jira-projects-plugin:report-page\\\" \u003e\u003cspan class=\\\"aui-icon aui-icon-large agile-icon-report\\\"\u003e\u003c\\/span\u003e\u003cspan class=\\\"aui-nav-item-label\\\" title=\\\"Reports\\\"\u003eReports\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/li\u003e\u003cli  \u003e\u003ca class=\\\"aui-nav-item \\\" href=\\\"\\/jira\\/projects\\/DERBY?selectedItem=com.atlassian.jira.jira-projects-plugin:components-page\\\" data-link-id=\\\"com.atlassian.jira.jira-projects-plugin:components-page\\\" \u003e\u003cspan class=\\\"aui-icon aui-icon-large icon-sidebar-components\\\"\u003e\u003c\\/span\u003e\u003cspan class=\\\"aui-nav-item-label\\\" title=\\\"Components\\\"\u003eComponents\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/li\u003e\u003c\\/ul\u003e\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/nav\u003e\u003c\\/div\u003e\u003cdiv class=\\\"aui-sidebar-footer\\\"\u003e\u003ca class=\\\"aui-button aui-button-subtle aui-sidebar-toggle aui-sidebar-footer-tipsy\\\" data-tooltip=\\\"Expand sidebar ( [ )\\\" href=\\\"#\\\"\u003e\u003cspan class=\\\"aui-icon aui-icon-small\\\"\u003e\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/div\u003e\"";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:bigpipe-init/jira.webresources:bigpipe-init.js" data-wrm-key="jira.webresources:bigpipe-init" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <form id="jira_request_timing_info" class="dont-default-focus"> 
   <fieldset class="parameters hidden"> 
    <input type="hidden" title="jira.request.start.millis" value="1520239109478"> 
    <input type="hidden" title="jira.request.server.time" value="526"> 
    <input type="hidden" title="jira.request.id" value="518x94379335x2"> 
    <input type="hidden" title="jira.session.expiry.time" value="-"> 
    <input type="hidden" title="jira.session.expiry.in.mins" value="-"> 
    <input id="jiraConcurrentRequests" type="hidden" name="jira.request.concurrent.requests" value="3"> 
    <input type="hidden" title="db.reads.time.in.ms" value="76"> 
    <input type="hidden" title="db.conns.time.in.ms" value="92"> 
   </fieldset> 
  </form> 
  <!--
	                 REQUEST ID : 518x94379335x2
	          REQUEST TIMESTAMP : [05/Mar/2018:08:38:29 +0000]
	               REQUEST TIME : 0.5260
	                 ASESSIONID : -
	        CONCURRENT REQUESTS : 3

	                      db.reads : OpSnapshot{name='db.reads', invocationCount=31, elapsedTotal=76172782, elapsedMin=617824, elapsedMax=16747244, resultSetSize=0, cpuTotal=0, cpuMin=0, cpuMax=0}
	                      db.conns : OpSnapshot{name='db.conns', invocationCount=36, elapsedTotal=92099394, elapsedMin=645670, elapsedMax=17011315, resultSetSize=0, cpuTotal=0, cpuMin=0, cpuMax=0}
-->   
 </body>
</html>