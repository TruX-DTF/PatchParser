<!doctype html>
<html lang="en">
 <head> 
  <meta charset="utf-8"> 
  <meta http-equiv="X-UA-Compatible" content="IE=Edge"> 
  <meta name="application-name" content="JIRA" data-name="jira" data-version="7.6.3">
  <meta name="ajs-viewissue-use-history-api" content="false"> 
  <meta name="ajs-jira-base-url" content="https://issues.apache.org/jira"> 
  <meta name="ajs-serverRenderedViewIssue" content="true"> 
  <meta name="ajs-dev-mode" content="false"> 
  <meta name="ajs-context-path" content="/jira"> 
  <meta name="ajs-version-number" content="7.6.3"> 
  <meta name="ajs-build-number" content="76005"> 
  <meta name="ajs-is-beta" content="false"> 
  <meta name="ajs-is-rc" content="false"> 
  <meta name="ajs-is-snapshot" content="false"> 
  <meta name="ajs-is-milestone" content="false"> 
  <meta name="ajs-remote-user" content=""> 
  <meta name="ajs-remote-user-fullname" content=""> 
  <meta name="ajs-user-locale" content="en_UK"> 
  <meta name="ajs-user-locale-group-separator" content=","> 
  <meta name="ajs-app-title" content="ASF JIRA"> 
  <meta name="ajs-keyboard-shortcuts-enabled" content="true"> 
  <meta name="ajs-keyboard-accesskey-modifier" content="Ctrl+Alt"> 
  <meta name="ajs-enabled-dark-features" content="[&quot;com.atlassian.jira.agile.darkfeature.editable.detailsview&quot;,&quot;nps.survey.inline.dialog&quot;,&quot;com.atlassian.jira.agile.darkfeature.edit.closed.sprint.enabled&quot;,&quot;jira.plugin.devstatus.phasetwo&quot;,&quot;jira.frother.reporter.field&quot;,&quot;atlassian.rest.xsrf.legacy.enabled&quot;,&quot;jira.issue.status.lozenge&quot;,&quot;com.atlassian.jira.config.BIG_PIPE&quot;,&quot;com.atlassian.jira.projects.issuenavigator&quot;,&quot;com.atlassian.jira.config.PDL&quot;,&quot;jira.plugin.devstatus.phasetwo.enabled&quot;,&quot;atlassian.aui.raphael.disabled&quot;,&quot;app-switcher.new&quot;,&quot;frother.assignee.field&quot;,&quot;com.atlassian.jira.projects.ProjectCentricNavigation.Switch&quot;,&quot;sd.internal.base.off.thread.on.completion.events.enabled&quot;,&quot;jira.onboarding.cyoa&quot;,&quot;com.atlassian.jira.agile.darkfeature.kanplan.enabled&quot;,&quot;sd.slavalue.record.updated.date.enabled&quot;,&quot;com.atlassian.jira.config.ProjectConfig.MENU&quot;,&quot;com.atlassian.jira.projects.sidebar.DEFER_RESOURCES&quot;,&quot;com.atlassian.jira.agile.darkfeature.kanplan.epics.and.versions.enabled&quot;,&quot;com.atlassian.jira.agile.darkfeature.sprint.goal.enabled&quot;,&quot;jira.zdu.admin-updates-ui&quot;,&quot;jira.zdu.jmx-monitoring&quot;,&quot;sd.sla.improved.rendering.enabled&quot;,&quot;sd.canned.responses.enabled&quot;,&quot;sd.new.settings.sidebar.location.disabled&quot;,&quot;jira.zdu.cluster-upgrade-state&quot;,&quot;com.atlassian.jira.agile.darkfeature.splitissue&quot;,&quot;com.atlassian.jira.config.CoreFeatures.LICENSE_ROLES_ENABLED&quot;,&quot;com.atlassian.feedback.feedback-button-move-to-header-enable&quot;,&quot;jira.export.csv.enabled&quot;]"> 
  <meta name="ajs-in-admin-mode" content="false"> 
  <meta name="ajs-is-sysadmin" content="false"> 
  <meta name="ajs-is-admin" content="false"> 
  <meta name="ajs-outgoing-mail-enabled" content="true"> 
  <meta name="ajs-date-relativize" content="true"> 
  <meta name="ajs-date-time" content="HH:mm"> 
  <meta name="ajs-date-day" content="EEEE HH:mm"> 
  <meta name="ajs-date-dmy" content="dd/MMM/yy"> 
  <meta name="ajs-date-complete" content="dd/MMM/yy HH:mm"> 
  <script type="text/javascript">var AJS=AJS||{};AJS.debug=true;</script> 
  <meta id="atlassian-token" name="atlassian-token" content="A5KQ-2QAV-T4JA-FDED|a630177f2e84842bd8373c03cf95b5f40b530273|lout"> 
  <link rel="shortcut icon" href="/jira/s/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/_/favicon.ico"> 
  <!--[if IE]><![endif]--> 
  <script type="text/javascript">
    (function() {
        var contextPath = '/jira';
        var eventBuffer = [];

        function printDeprecatedMsg() {
            if (console && console.warn) {
                console.warn('DEPRECATED JS - contextPath global variable has been deprecated since 7.4.0. Use `wrm/context-path` module instead.');
            }
        }

        function sendEvent(analytics, postfix) {
            analytics.send({
                name: 'js.globals.contextPath.' + postfix
            });
        }

        function sendDeprecatedEvent(postfix) {
            try {
                var analytics = require('jira/analytics');
                if (eventBuffer.length) {
                    eventBuffer.forEach(function(value) {
                        sendEvent(analytics, value);
                    });
                    eventBuffer = [];
                }

                if (postfix) {
                    sendEvent(analytics, postfix);
                }
            } catch(ex) {
                eventBuffer.push(postfix);
                setTimeout(sendDeprecatedEvent, 1000);
            }
        }

        Object.defineProperty(window, 'contextPath', {
            get: function() {
                printDeprecatedMsg();
                sendDeprecatedEvent('get');
                return contextPath;
            },
            set: function(value) {
                printDeprecatedMsg();
                sendDeprecatedEvent('set');
                contextPath = value;
            }
        });
    })();

</script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-plugin:context-path.context-path"]="\"/jira\"";
WRM._unparsedData["jira.webresources:feature-flags.feature-flag-data"]="{\"enabled-feature-keys\":[\"com.atlassian.jira.agile.darkfeature.editable.detailsview\",\"nps.survey.inline.dialog\",\"com.atlassian.jira.agile.darkfeature.edit.closed.sprint.enabled\",\"jira.plugin.devstatus.phasetwo\",\"jira.frother.reporter.field\",\"atlassian.rest.xsrf.legacy.enabled\",\"jira.issue.status.lozenge\",\"com.atlassian.jira.config.BIG_PIPE\",\"com.atlassian.jira.projects.issuenavigator\",\"com.atlassian.jira.config.PDL\",\"jira.plugin.devstatus.phasetwo.enabled\",\"atlassian.aui.raphael.disabled\",\"app-switcher.new\",\"frother.assignee.field\",\"com.atlassian.jira.projects.ProjectCentricNavigation.Switch\",\"sd.internal.base.off.thread.on.completion.events.enabled\",\"jira.onboarding.cyoa\",\"com.atlassian.jira.agile.darkfeature.kanplan.enabled\",\"sd.slavalue.record.updated.date.enabled\",\"com.atlassian.jira.config.ProjectConfig.MENU\",\"com.atlassian.jira.projects.sidebar.DEFER_RESOURCES\",\"com.atlassian.jira.agile.darkfeature.kanplan.epics.and.versions.enabled\",\"com.atlassian.jira.agile.darkfeature.sprint.goal.enabled\",\"jira.zdu.admin-updates-ui\",\"jira.zdu.jmx-monitoring\",\"sd.sla.improved.rendering.enabled\",\"sd.canned.responses.enabled\",\"sd.new.settings.sidebar.location.disabled\",\"jira.zdu.cluster-upgrade-state\",\"com.atlassian.jira.agile.darkfeature.splitissue\",\"com.atlassian.jira.config.CoreFeatures.LICENSE_ROLES_ENABLED\",\"com.atlassian.feedback.feedback-button-move-to-header-enable\",\"jira.export.csv.enabled\"],\"feature-flag-states\":{\"sd.customer.profile.multi.languages\":true,\"sd.customer.portal.transitions\":true,\"sd.customer.portal.transitions.config\":true,\"sd.custom.email.stripping.rules\":false,\"sd.sla.lucene.issue.id.callback.performance\":true,\"sd.new.settings.sidebar.location\":true,\"sd.workload.report.paginator\":true,\"sd.experimental.portal.search.algorithm.default.1\":false,\"sd.customer.portal.help.center.agent.announcement\":true,\"sd.sla.improved.rendering\":false,\"sd.experimental.portal.search.algorithm.default.2\":false,\"sd.customer.feedback.validate.reporter.on.token\":true,\"sd.custom.email.notifications.utf8.csat.star\":true,\"sd.who.create.customers.by.email.setting\":true,\"com.atlassian.jira.issuetable.move.links.hidden\":true,\"jira.renderer.consider.variable.format\":true,\"sd.stats.event.tracking\":true,\"sd.password.helper.dialog\":true,\"sd.canned.responses\":false,\"sd.portal.help.center.customer.signup.secondary.email\":true,\"sd.custom.email.notifications.manage.language\":true,\"sd.use.search.by.permissions\":true,\"sd.slavalue.record.updated.date\":false,\"sd.report.custom.date.range\":false,\"sd.kb.article.helpfulness.report\":false,\"com.atlassian.jira.agile.darkfeature.sprint.goal\":false,\"sd.custom.email.notifications.styling\":true,\"sd.workinghours.new.page.bulldog.1\":false,\"sd.customer.portal.two.step.login\":false,\"sd.automation.psmq.async.executor\":true,\"sd.customer.org.list.page.lazy.search\":true,\"sd.approval.requested.when.handler\":true,\"sd.request.type.field.rest.api.filtering.bugfix\":true,\"sd.automation.then.action.auto.answer.approval\":true,\"com.atlassian.jira.agile.darkfeature.kanplan.epics.and.versions\":false,\"sla.will.only.be.paused.if.they.are.already.started\":true,\"sd.kb.comment.share.stats.collection\":true,\"com.atlassian.jira.upgrade.startup.fix.index\":true,\"sd.customer.orgs.group.participants\":true,\"sd.portal.help.center.customer.signup\":true,\"sd.sla.agent.jql.security.restricted\":true,\"sd.test.feature.flag.x\":true,\"sd.test.feature.flag.y\":false,\"sd.cluster.safe.mail.channel.shutdown\":true,\"sd.email.channel.folders\":false,\"sd.email.analytics.open\":false,\"sd.kb.project.creation.create.link.space\":true,\"sd.workinghours.new.page\":false,\"sd.confluence.anonymous.permission.fix\":true,\"com.atlassian.jira.issuetable.draggable\":true,\"sd.customer.portal.project.agent.announcement\":true,\"sd.automation.audit.log\":true,\"jira.jql.suggestrecentfields\":false,\"sd.canned.responses.check.index.startup\":false,\"sd.new.project.templates\":true,\"sd.custom.email.notifications.custom.rules.simple.ui\":false,\"sd.custom.email.notifications.cut.over\":true,\"sd.dismiss.all.misconfiguration.warnings.setting\":true,\"com.atlassian.jira.agile.darkfeature.optimistic.transitions\":true,\"sd.sla.configurations.export\":true,\"sd.canned.responses.variable.substitution\":true,\"com.atlassian.jira.agile.darkfeature.kanplan\":false,\"sd.internal.base.off.thread.on.completion.events\":false,\"sd.customer.portal.prioties.per.project.fix\":true,\"jira.instrumentation.laas\":false,\"sd.kb.self.service.report\":false,\"sla.improved.request.handling\":true,\"sd.no.schedule.async.upgrade.tasks\":true,\"sd.kb.primary.nav\":true,\"com.atlassian.jira.agile.darkfeature.edit.closed.sprint\":false,\"sd.kb.issueview.panel.phase2\":true,\"sd.email.outsider.comments\":true,\"jira.create.linked.issue\":true,\"sd.kb.issueview.panel\":true,\"jira.sal.host.connect.accessor.existing.transaction.will.create.transactions\":true,\"sd.approvals.light.weight\":false,\"sd.automation.then.webhook\":true,\"sd.respect.inline.edit.issue.off\":true,\"jira.jql.smartautoselectfirst\":false,\"sd.global.portal.search.atlassian.only.tracking\":false,\"sd.automation.if.condition.comment.primary.action\":true,\"jira.priorities.per.project\":true,\"sd.inline.noformat.renderer\":true,\"sd.customer.request.type.create.edit.screens\":true}}";
WRM._unparsedData["jira.webresources:default-comment-security-level.DefaultCommentSecurityLevelHelpLink"]="{\"extraClasses\":\"default-comment-level-help\",\"title\":\"Commenting on an Issue\",\"url\":\"https://docs.atlassian.com/jira/jcore-docs-076/Editing+and+collaborating+on+issues#Editingandcollaboratingonissues-restrictacomment\",\"isLocal\":false}";
WRM._unparsedData["jira.webresources:dateFormatProvider.allFormats"]="{\"dateFormats\":{\"meridiem\":[\"AM\",\"PM\"],\"eras\":[\"BC\",\"AD\"],\"months\":[\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],\"monthsShort\":[\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"],\"weekdaysShort\":[\"Sun\",\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\",\"Sat\"],\"weekdays\":[\"Sunday\",\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\",\"Saturday\"]},\"lookAndFeelFormats\":{\"relativize\":\"true\",\"time\":\"HH:mm\",\"day\":\"EEEE HH:mm\",\"dmy\":\"dd/MMM/yy\",\"complete\":\"dd/MMM/yy HH:mm\"}}";
WRM._unparsedData["com.atlassian.jira.jira-issue-nav-components:issueviewer.features"]="{\"rteEnabled\":true}";
WRM._unparsedData["com.atlassian.jira.plugins.jira-dnd-attachment-plugin:dnd-issue-drop-zone.thumbnail-mime-types"]="\"image/png,image/vnd.wap.wbmp,image/x-png,image/jpeg,image/bmp,image/gif\"";
WRM._unparsedData["com.atlassian.jira.plugins.jira-dnd-attachment-plugin:dnd-issue-drop-zone.upload-limit"]="\"62914560\"";
WRM._unparsedData["com.atlassian.plugins.helptips.jira-help-tips:help-tip-manager.JiraHelpTipData"]="{\"anonymous\":true}";
WRM._unparsedData["com.atlassian.jira.jira-view-issue-plugin:controller-subtasks.controller.subtasks.parameters"]="{\"url\":\"/rest/api/2/issue/{issueId}/subtask/move\"}";
WRM._unparsedData["com.atlassian.analytics.analytics-client:policy-update-init.policy-update-data-provider"]="false";
WRM._unparsedData["com.atlassian.analytics.analytics-client:programmatic-analytics-init.programmatic-analytics-data-provider"]="false";
WRM._unparsedData["com.atlassian.servicedesk.servicedesk-canned-responses-plugin:canned-responses-data-provider.data"]="{\"substitutionVariables\":{\"issue.summary\":\"Issue summary\",\"issue.description\":\"Issue description\",\"issue.key\":\"Issue key\",\"issue.reporter.name\":\"Issue reporter\",\"issue.resolution\":\"Issue resolution\",\"request.url\":\"Request URL\",\"request.status\":\"Request status\"}}";
WRM._unparsedData["jira.webresources:avatar-picker.data"]="{}";
WRM._unparsedData["com.atlassian.feedback.jira-feedback-plugin:button-resources-init.data"]="{\"jira.feedback.plugin.issue.collector.core\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-UK&collectorId=abbf546d\",\"jira.feedback.plugin.issue.collector.default\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-UK&collectorId=abbf546d\",\"jira.feedback.plugin.issue.collector.service.desk\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?locale=en-UK&collectorId=a698db21\",\"jira.feedback.plugin.issue.collector.software\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-UK&collectorId=abbf546d\",\"isHeaderFeedbackButtonEnabled\":true}";
WRM._unparsedData["com.atlassian.jira.jira-header-plugin:dismissedFlags.flags"]="{\"dismissed\":[]}";
WRM._unparsedData["com.atlassian.jira.jira-header-plugin:newsletter-signup-tip-init.newsletterSignup"]="{\"signupDescription\":\"Get updates, inspiration and best practices from the team behind JIRA.\",\"formUrl\":\"https://www.atlassian.com/apis/exact-target/{0}/subscribe?mailingListId=1401671\",\"signupTitle\":\"Sign up!\",\"signupId\":\"newsletter-signup-tip\",\"showNewsletterTip\":false}";
WRM._unparsedData["com.atlassian.jira.project-templates-plugin:project-templates-plugin-resources.ptAnalyticsData"]="{\"instanceCreatedDate\":\"2011-01-31\"}";
WRM._unparsedData["com.atlassian.servicedesk.core-ui:util-help-links.help-links"]="{\"help\":{\"email.settings\":\"https://docs.atlassian.com/jira/jsd-docs-039/Receiving+requests+by+email\",\"managing.queues\":\"https://docs.atlassian.com/jira/jsd-docs-039/Setting+up+queues+for+your+team\",\"email.setup\":\"https://docs.atlassian.com/jira/jsd-docs-039/Receiving+requests+by+email\",\"request.settings.help.bubble\":\"https://docs.atlassian.com/jira/jsd-docs-039/Managing+access+to+your+service+desk\",\"email.settings.suitablerequest\":\"https://docs.atlassian.com/jira/jsd-docs-039/Receiving+requests+by+email#Receivingrequestsbyemail-suitablerequest\",\"sla.import.help\":\"https://docs.atlassian.com/jira/jsd-docs-039/Importing+SLAs\",\"documentation.home\":\"https://docs.atlassian.com/jira/jsd-docs-039/JIRA+Service+Desk+Documentation\",\"default\":\"https://docs.atlassian.com/jira/jsd-docs-039/\",\"create.space.help\":\"https://docs.atlassian.com/jira/jsd-docs-039/Serving+customers+with+a+knowledge+base#serving-customers-with-a-knowledge-base-createpermission\",\"email.settings.troubleshooting\":\"https://docs.atlassian.com/jira/jsd-docs-039/Troubleshooting+issues+with+the+email+channel\",\"admin.notifications.config\":\"https://docs.atlassian.com/jira/jsd-docs-039/Managing+service+desk+notifications\",\"troubleshoot.requesttype\":\"https://docs.atlassian.com/jira/jsd-docs-039/Troubleshooting+issues+with+request+types\",\"approvals.configuration\":\"https://docs.atlassian.com/jira/jsd-docs-039/Configuring+JIRA+Service+Desk+approvals\",\"setting.up.reports\":\"https://docs.atlassian.com/jira/jsd-docs-039/Setting+up+service+desk+reports\",\"public.signup\":\"https://docs.atlassian.com/jira/jsd-docs-039/Configuring+public+signup\",\"knowledge.base\":\"https://docs.atlassian.com/jira/jsd-docs-039/Serving+customers+with+a+knowledge+base\",\"resolve.permission.scheme.errors\":\"https://docs.atlassian.com/jira/jsd-docs-039/Resolving+permission+scheme+errors\",\"getting.started\":\"https://docs.atlassian.com/jira/jsd-docs-039/Getting+started+with+JIRA+Service+Desk\",\"getting.started.agent\":\"https://docs.atlassian.com/jira/jsd-docs-039/Getting+started+for+service+desk+agents\",\"invite.customers\":\"https://docs.atlassian.com/jira/jsd-docs-039/Managing+access+to+your+service+desk\"},\"kb\":{\"default\":\"https://confluence.atlassian.com/display/SDKB/\",\"troubleshooting.user.management.issues\":\"https://confluence.atlassian.com/display/SDKB/Troubleshooting+issues+with+service+desk+user+management\",\"legacytransition\":\"https://confluence.atlassian.com/display/SDKB/Replacing+legacy+automatic+transitions+with+automation+rules\",\"umtroubleshoot\":\"https://confluence.atlassian.com/display/SDKB/Troubleshooting+issues+with+service+desk+user+management\"}}";
WRM._unparsedData["com.atlassian.servicedesk.core-ui:util-base-url.base-url"]="\"https://issues.apache.org/jira\"";
WRM._unparsedData["com.atlassian.jira.plugins.jira-wiki-editor:wiki-editor-resources.help-data"]="{\"showHelp\":true,\"editorDocumentationUrl\":[\"https://docs.atlassian.com/jira/jcore-docs-076/Visual+editing\"],\"editorDocumentationTitle\":[\"Show me documentation for the visual editor\"]}";
WRM._unparsedData["com.atlassian.jira.plugins.jira-wiki-editor:wiki-editor-resources.thumbnails-allowed"]="false";
WRM._unparsedData["jira.webresources:user-message-flags.adminLockout"]="{}";
WRM._unparsedData["jira.request.correlation-id"]="\"890eac7baddba8\"";
WRM._unparsedData["project-id"]="12310110";
WRM._unparsedData["project-key"]="\"LUCENE\"";
WRM._unparsedData["project-name"]="\"Lucene - Core\"";
WRM._unparsedData["project-type"]="\"software\"";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:generic-filters"]="[{\"id\":\"allissues\",\"jql\":\"project = \\\"{0}\\\" ORDER BY {1}\",\"defaultOrderby\":\"created DESC\",\"label\":\"All issues\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[]},{\"id\":\"allopenissues\",\"jql\":\"project = \\\"{0}\\\" AND resolution = Unresolved ORDER BY {1}\",\"defaultOrderby\":\"priority DESC, updated DESC\",\"label\":\"Open issues\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"resolution\"]},{\"id\":\"doneissues\",\"jql\":\"project = \\\"{0}\\\" AND statusCategory = Done ORDER BY {1}\",\"defaultOrderby\":\"updated DESC\",\"label\":\"Done issues\",\"requiresUser\":false,\"supportsInlineIssueCreate\":false,\"fields\":[\"status\"]},{\"id\":\"recentlyviewed\",\"jql\":\"project = \\\"{0}\\\" AND issuekey in issueHistory() ORDER BY {1}\",\"defaultOrderby\":\"lastViewed DESC\",\"label\":\"Viewed recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"issuekey\"]},{\"id\":\"addedrecently\",\"jql\":\"project = \\\"{0}\\\" AND created \u003e= -1w ORDER BY {1}\",\"defaultOrderby\":\"created DESC\",\"label\":\"Created recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"created\"]},{\"id\":\"resolvedrecently\",\"jql\":\"project = \\\"{0}\\\" AND resolutiondate \u003e= -1w ORDER BY {1}\",\"defaultOrderby\":\"updated DESC\",\"label\":\"Resolved recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":false,\"fields\":[\"resolutiondate\"]},{\"id\":\"updatedrecently\",\"jql\":\"project = \\\"{0}\\\" AND updated \u003e= -1w ORDER BY {1}\",\"defaultOrderby\":\"updated DESC\",\"label\":\"Updated recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"updated\"]}]";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:default-filter-priority"]="[\"allopenissues\",\"allissues\"]";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:can-manage-filters"]="false";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:project-filters"]="[]";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:can-create-issues"]="false";
WRM._unparsedData["projectId"]="12310110";
WRM._unparsedData["projectKey"]="\"LUCENE\"";
WRM._unparsedData["projectType"]="\"software\"";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:server-rendered"]="true";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <link type="text/css" rel="stylesheet" href="/jira/s/a8a4711bc3f2eb261d8c8fd9fbcbba8b-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/1fca1750044f2777c977e8d8cc023344/_/download/contextbatch/css/_super/batch.css" data-wrm-key="_super" data-wrm-batch-type="context" media="all"> 
  <link type="text/css" rel="stylesheet" href="/jira/s/1a6b21131945f6f49ff48336b49ca3fe-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/37a6e594cbbfd462a8a54d5aa11475c1/_/download/contextbatch/css/project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super/batch.css?agile_global_admin_condition=true&amp;hc-enabled=true&amp;is-server-instance=true&amp;jag=true&amp;jira.create.linked.issue=true&amp;nps-acknowledged=true&amp;richediton=true&amp;sd_operational=true" data-wrm-key="project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super" data-wrm-batch-type="context" media="all"> 
  <link type="text/css" rel="stylesheet" href="/jira/s/611672383f6cab00ab202241ba6f9d68-T/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/7.6.3/_/download/batch/com.atlassian.feedback.jira-feedback-plugin:button-resources-init/com.atlassian.feedback.jira-feedback-plugin:button-resources-init.css" data-wrm-key="com.atlassian.feedback.jira-feedback-plugin:button-resources-init" data-wrm-batch-type="resource" media="all"> 
  <script type="text/javascript" src="/jira/s/d8484c9183f546511a8e336a8779bcd9-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/1fca1750044f2777c977e8d8cc023344/_/download/contextbatch/js/_super/batch.js?locale=en-UK" data-wrm-key="_super" data-wrm-batch-type="context" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d3b35d835f8f46fc3b53bb4db7f85158-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/37a6e594cbbfd462a8a54d5aa11475c1/_/download/contextbatch/js/project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super/batch.js?agile_global_admin_condition=true&amp;hc-enabled=true&amp;is-server-instance=true&amp;jag=true&amp;jira.create.linked.issue=true&amp;locale=en-UK&amp;nps-acknowledged=true&amp;richediton=true&amp;sd_operational=true" data-wrm-key="project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super" data-wrm-batch-type="context" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/71d42e74136d842a3ef4d5d136484843-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/871d45c9f322a22cb3aa9b7948a69803/_/download/contextbatch/js/atl.global,-_super/batch.js?locale=en-UK" data-wrm-key="atl.global,-_super" data-wrm-batch-type="context" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:calendar-en/jira.webresources:calendar-en.js" data-wrm-key="jira.webresources:calendar-en" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:calendar-localisation-moment/jira.webresources:calendar-localisation-moment.js" data-wrm-key="jira.webresources:calendar-localisation-moment" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/7.6.3/_/download/batch/com.atlassian.feedback.jira-feedback-plugin:button-resources/com.atlassian.feedback.jira-feedback-plugin:button-resources.js" data-wrm-key="com.atlassian.feedback.jira-feedback-plugin:button-resources" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <link type="text/css" rel="stylesheet" href="/jira/s/95a4826c265852f4904f1e0e7300df68-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/e0de73613a1027de08f3da6a45e1d1a2/_/download/contextbatch/css/jira.global.look-and-feel,-_super/batch.css" data-wrm-key="jira.global.look-and-feel,-_super" data-wrm-batch-type="context" media="all"> 
  <script type="text/javascript" src="/jira/rest/api/1.0/shortcuts/76005/944bb39eced1b35cfc7194aa02eb5a5a/shortcuts.js?context=issuenavigation&amp;context=issueaction"></script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["com.atlassian.jira.jira-issue-nav-components:inline-edit-enabled"]="true";
WRM._unparsedData["should-display-chaperone"]="false";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <link type="text/css" rel="stylesheet" href="/jira/s/15712b600e9aecf72ffd9fd3704a0c78-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/6b22a15c7b83f87a47b1757076f43542/_/download/contextbatch/css/com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue/batch.css?jira.create.linked.issue=true&amp;richediton=true&amp;sd_operational=true" data-wrm-key="com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue" data-wrm-batch-type="context" media="all"> 
  <script type="text/javascript" src="/jira/s/5a8f0f8b8aa8f96a4f0f7e9e248d62f3-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/6b22a15c7b83f87a47b1757076f43542/_/download/contextbatch/js/com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue/batch.js?jira.create.linked.issue=true&amp;locale=en-UK&amp;richediton=true&amp;sd_operational=true" data-wrm-key="com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue" data-wrm-batch-type="context" data-initially-rendered></script> 
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
  <meta name="ajs-can-search-users" content="false"> 
  <meta name="ajs-can-edit-watchers" content="false"> 
  <meta name="ajs-default-avatar-url" content="https://issues.apache.org/jira/secure/useravatar?size=xsmall&amp;avatarId=10453"> 
  <meta name="ajs-issue-project-type" content="software"> 
  <meta name="ajs-issue-key" content="LUCENE-2680"> 
  <meta name="ajs-server-view-issue-is-editable" content="false"> 
  <title>[LUCENE-2680] Improve how IndexWriter flushes deletes against existing segments - ASF JIRA</title> 
  <link rel="search" type="application/opensearchdescription+xml" href="/jira/osd.jsp" title="[LUCENE-2680] Improve how IndexWriter flushes deletes against existing segments - ASF JIRA"> 
 </head> 
 <body id="jira" class="aui-layout aui-theme-default " data-version="7.6.3"> 
  <div id="page"> 
   <header id="header" role="banner"> 
    <script>
require(["jquery", "jira/license-banner"], function ($, licenseBanner) {
    $(function () {
        licenseBanner.showLicenseBanner("");
        licenseBanner.showLicenseFlag("");
    });
});
</script> 
    <nav class="aui-header aui-dropdown2-trigger-group" role="navigation">
     <div class="aui-header-inner">
      <div class="aui-header-before">
       <a class=" aui-dropdown2-trigger app-switcher-trigger" aria-controls="app-switcher" aria-haspopup="true" role="button" tabindex="0" data-aui-trigger href="#app-switcher"><span class="aui-icon aui-icon-small aui-iconfont-appswitcher">Linked Applications</span></a>
       <div id="app-switcher" class="aui-dropdown2 aui-style-default" role="menu" aria-hidden="true" data-is-switcher="true" data-environment="{&quot;isUserAdmin&quot;:false,&quot;isAppSuggestionAvailable&quot;:false,&quot;isSiteAdminUser&quot;:false}">
        <div role="application">
         <div class="app-switcher-loading">
          Loadingâ€¦
         </div>
        </div>
       </div>
      </div>
      <div class="aui-header-primary">
       <h1 id="logo" class="aui-header-logo aui-header-logo-custom"><a href="https://issues.apache.org/jira/secure/MyJiraHome.jspa"><img src="/jira/s/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/_/jira-logo-scaled.png" alt="ASF JIRA"></a></h1>
       <ul class="aui-nav">
        <li><a href="/jira/secure/Dashboard.jspa" class=" aui-nav-link aui-dropdown2-trigger aui-dropdown2-ajax" id="home_link" aria-haspopup="true" aria-controls="home_link-content" title="View and manage your dashboards" accesskey="d">Dashboards</a>
         <div class="aui-dropdown2 aui-style-default" id="home_link-content" data-aui-dropdown2-ajax-key="home_link"></div></li>
        <li><a href="/jira/browse/LUCENE" class=" aui-nav-link aui-dropdown2-trigger aui-dropdown2-ajax" id="browse_link" aria-haspopup="true" aria-controls="browse_link-content" title="View recent projects and browse a list of projects" accesskey="p">Projects</a>
         <div class="aui-dropdown2 aui-style-default" id="browse_link-content" data-aui-dropdown2-ajax-key="browse_link"></div></li>
        <li><a href="/jira/issues/" class=" aui-nav-link aui-dropdown2-trigger aui-dropdown2-ajax" id="find_link" aria-haspopup="true" aria-controls="find_link-content" title="Search for issues and view recent issues" accesskey="i">Issues</a>
         <div class="aui-dropdown2 aui-style-default" id="find_link-content" data-aui-dropdown2-ajax-key="find_link"></div></li> 
       </ul>
      </div>
      <div class="aui-header-secondary">
       <ul class="aui-nav">
        <li id="quicksearch-menu"> 
         <form action="/jira/secure/QuickSearch.jspa" method="get" id="quicksearch" class="aui-quicksearch dont-default-focus ajs-dirty-warning-exempt"> 
          <input id="quickSearchInput" class="search" type="text" title="Search" placeholder="Search" name="searchString" accessKey="q"> 
          <input type="submit" class="hidden" value="Search"> 
         </form> </li> 
        <li><a class="jira-feedback-plugin" role="button" aria-haspopup="true" id="jira-header-feedback-link" href="#"><span class="aui-icon aui-icon-small jira-feedback-plugin-icon">Give feedback to Atlassian</span></a></li> 
        <li id="system-help-menu"> <a class="aui-nav-link aui-dropdown2-trigger" id="help_menu" aria-haspopup="true" aria-owns="system-help-menu-content" href="https://docs.atlassian.com/jira/jcore-docs-076/" target="$textUtils.htmlEncode($rootHelpMenuItem.params.target)" title="Help"><span class="aui-icon aui-icon-small aui-iconfont-help">Help</span></a> 
         <div id="system-help-menu-content" class="aui-dropdown2 aui-style-default"> 
          <div class="aui-dropdown2-section"> 
           <ul id="jira-help" class="aui-list-truncate"> 
            <li> <a id="view_core_help" class="aui-nav-link " title="Go to the online documentation for JIRA Core" href="https://docs.atlassian.com/jira/jcore-docs-076/" target="_blank">JIRA Core help</a> </li> 
            <li> <a id="keyshortscuthelp" class="aui-nav-link " title="Get more information about JIRA's Keyboard Shortcuts" href="/jira/secure/ViewKeyboardShortcuts!default.jspa" target="_blank">Keyboard Shortcuts</a> </li> 
            <li> <a id="view_about" class="aui-nav-link " title="Get more information about JIRA" href="/jira/secure/AboutPage.jspa">About JIRA</a> </li> 
            <li> <a id="view_credits" class="aui-nav-link " title="See who did what" href="/jira/secure/JiraCreditsPage!default.jspa" target="_blank">JIRA Credits</a> </li> 
           </ul> 
          </div> 
         </div> </li> 
        <li id="user-options"> <a class="aui-nav-link login-link" href="/jira/login.jsp?os_destination=%2Fbrowse%2FLUCENE-2680">Log In</a> 
         <div id="user-options-content" class="aui-dropdown2 aui-style-default"> 
          <div class="aui-dropdown2-section"> 
          </div> 
         </div> </li> 
       </ul>
      </div>
     </div>
     <!-- .aui-header-inner-->
    </nav>
    <!-- .aui-header --> 
   </header> 
   <section id="content" role="main"> 
    <big-pipe data-id="sidebar-id" unresolved></big-pipe>
    <div class="aui-sidebar  sidebar-placeholder">
     <div class="aui-sidebar-wrapper">
      <div class="aui-sidebar-body"></div>
      <div class="aui-sidebar-footer">
       <a class="aui-button aui-button-subtle aui-sidebar-toggle aui-sidebar-footer-tipsy" data-tooltip="Expand sidebar ( [ )" href="#"><span class="aui-icon aui-icon-small"></span></a>
      </div>
     </div>
    </div>
    <script id="projects-sidebar-init">
    require(['jira/projects/sidebar/expansion-manager'], function(expansionManager) {
        var scriptTag = document.getElementById('projects-sidebar-init');
        var sidebar = AJS.sidebar('.aui-sidebar');
        expansionManager(sidebar);
        scriptTag.parentElement.removeChild(scriptTag);
    });
    </script>
    <div class="aui-page-panel">
     <div class="aui-page-panel-inner">
      <div class="issue-navigator">
       <div class="content">
        <div class="issue-view">
         <div class="navigation-tools">
          <div class="pager-container"></div>
         </div>
         <div class="issue-container">
          <div id="issue-content" class="issue-edit-form">
           <header id="stalker" class="issue-header js-stalker">
            <div class="issue-header-content">
             <header class="aui-page-header">
              <div class="aui-page-header-inner">
               <div class="aui-page-header-image">
                <span id="12310110" class="aui-avatar aui-avatar-large aui-avatar-project"><span class="aui-avatar-inner"><img id="project-avatar" alt="Uploaded image for project: 'Lucene - Core'" src="https://issues.apache.org/jira/secure/projectavatar?pid=12310110&amp;avatarId=10061"></span></span>
               </div>
               <!-- .aui-page-header-image -->
               <div class="aui-page-header-main">
                <ol class="aui-nav aui-nav-breadcrumbs">
                 <li><a id="project-name-val" href="/jira/browse/LUCENE">Lucene - Core</a></li>
                 <li><a class="issue-link" data-issue-key="LUCENE-2680" href="/jira/browse/LUCENE-2680" id="key-val" rel="12475670">LUCENE-2680</a></li>
                </ol>
                <h1 id="summary-val">Improve how IndexWriter flushes deletes against existing segments</h1>
               </div>
               <!-- .aui-page-header-main -->
               <div class="aui-page-header-actions">
                <div id="issue-header-pager"></div>
               </div>
               <!-- .aui-page-header-actions -->
              </div>
              <!-- .aui-page-header-inner -->
             </header>
             <!-- .aui-page-header -->
             <div class="command-bar">
              <div class="ops-cont">
               <div class="ops-menus aui-toolbar">
                <div class="toolbar-split toolbar-split-left">
                 <ul id="opsbar-ops-login-lnk_container" class="toolbar-group pluggable-ops">
                  <li class="toolbar-item"><a id="ops-login-lnk" title="Log In" class="toolbar-trigger" href="/jira/login.jsp?os_destination=%2Fbrowse%2FLUCENE-2680"><span class="trigger-label">Log In</span></a></li>
                 </ul>
                 <ul id="opsbar-opsbar-operations" class="toolbar-group pluggable-ops"></ul>
                 <ul id="opsbar-opsbar-transitions" class="toolbar-group pluggable-ops"></ul>
                 <ul id="opsbar-opsbar-admin" class="toolbar-group pluggable-ops"></ul>
                </div>
                <div class="toolbar-split toolbar-split-right">
                 <ul id="opsbar-jira.issue.tools" class="toolbar-group pluggable-ops">
                  <li class="toolbar-item">
                   <div>
                    <a href="#" id="viewissue-export" aria-owns="viewissue-export_drop" aria-haspopup="true" title="Export this issue in another format" class="toolbar-trigger aui-button aui-style-default aui-dropdown2-trigger"><span class="icon icon-default aui-icon aui-icon-small aui-iconfont-export"></span> <span class="dropdown-text">Export</span></a>
                    <div id="viewissue-export_drop" class="aui-style-default aui-dropdown2">
                     <ul>
                      <li class="aui-list-item"><a href="/jira/si/jira.issueviews:issue-xml/LUCENE-2680/LUCENE-2680.xml" id="jira.issueviews:issue-xml"><span class="trigger-label">XML</span></a></li>
                      <li class="aui-list-item"><a href="/jira/si/jira.issueviews:issue-word/LUCENE-2680/LUCENE-2680.doc" id="jira.issueviews:issue-word"><span class="trigger-label">Word</span></a></li>
                      <li class="aui-list-item"><a href="/jira/si/jira.issueviews:issue-html/LUCENE-2680/LUCENE-2680.html" id="jira.issueviews:issue-html"><span class="trigger-label">Printable</span></a></li>
                      <li class="aui-list-item"><a href="/jira/si/com.atlassian.jira.plugins.jira-importers-plugin:issue-json/LUCENE-2680/LUCENE-2680.json" id="com.atlassian.jira.plugins.jira-importers-plugin:issue-json"><span class="trigger-label">JSON</span></a></li>
                     </ul>
                    </div>
                   </div></li>
                 </ul>
                </div>
               </div>
              </div>
             </div>
            </div>
           </header>
           <div class="issue-body-content">
            <div class="aui-group issue-body">
             <div class="aui-item issue-main-column">
              <div id="details-module" class="module toggle-wrap">
               <div id="details-module_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Details</h2>
               </div>
               <div class="mod-content"> 
                <ul id="issuedetails" class="property-list two-cols"> 
                 <li class="item"> 
                  <div class="wrap"> 
                   <strong class="name">Type:</strong> 
                   <span id="type-val" class="value"> <img alt="" height="16" src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21140&amp;avatarType=issuetype" title="Improvement - An improvement or enhancement to an existing feature or task." width="16"> Improvement </span> 
                  </div> </li> 
                 <li class="item item-right"> 
                  <div class="wrap"> 
                   <strong class="name">Status:</strong> 
                   <span id="status-val" class="value"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done jira-issue-status-lozenge-max-width-medium" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Closed</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.</span>">Closed</span> </span> 
                  </div> </li> 
                 <li class="item new"> 
                  <div class="wrap"> 
                   <strong class="name">Priority:</strong> 
                   <span id="priority-val" class="value"> <img alt="" height="16" src="/jira/images/icons/priorities/major.svg" title="Major - Major loss of function." width="16"> Major </span> 
                  </div> </li> 
                 <li class="item item-right"> 
                  <div class="wrap"> 
                   <strong class="name">Resolution:</strong> 
                   <span id="resolution-val" class="value resolved"> Fixed </span> 
                  </div> </li> 
                 <li class="item"> 
                  <div class="wrap"> 
                   <strong class="name">Affects Version/s:</strong> 
                   <span id="versions-val" class="value"> None </span> 
                  </div> </li> 
                 <li class="item item-right"> 
                  <div class="wrap"> 
                   <strong class="name">Fix Version/s:</strong> 
                   <span id="fixfor-val" class="value"> <span class="shorten" id="fixVersions-field"> <a href="/jira/issues/?jql=project+%3D+LUCENE+AND+fixVersion+%3D+3.1" title="3.1 Major release after 3.x">3.1</a>, <a href="/jira/issues/?jql=project+%3D+LUCENE+AND+fixVersion+%3D+4.0-ALPHA" title="4.0-ALPHA Alpha release of the 4.x series">4.0-ALPHA</a> </span> </span> 
                  </div> </li> 
                 <li class="item"> 
                  <div class="wrap"> 
                   <strong class="name">Component/s:</strong> 
                   <span id="components-val" class="value"> None </span> 
                  </div> </li> 
                 <li class="item full-width"> 
                  <div class="wrap" id="wrap-labels"> 
                   <strong class="name">Labels:</strong> 
                   <div class="labels-wrap value"> 
                    <span class="labels" id="labels-12475670-value">None</span> 
                   </div> 
                  </div> </li> 
                </ul> 
                <div id="customfieldmodule"> 
                 <div class="aui-tabs horizontal-tabs" id="customfield-tabs"> 
                  <div id="customfield-panel-1" class="tabs-pane active-pane"> 
                   <ul class="property-list"> 
                    <li id="rowForcustomfield_12310120" class="item"> 
                     <div class="wrap"> 
                      <strong title="Lucene Fields" class="name">Lucene Fields:</strong> 
                      <div id="customfield_12310120-val" class="value type-multicheckboxes" data-fieldtype="multicheckboxes" data-fieldtypecompletekey="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes"> 
                       <div class="shorten" id="customfield_12310120-field"> 
                        <span>New</span> 
                       </div> 
                      </div> 
                     </div> </li> 
                   </ul> 
                  </div> 
                 </div>
                </div> 
               </div>
              </div>
              <div id="descriptionmodule" class="module toggle-wrap">
               <div id="descriptionmodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Description</h2>
               </div>
               <div class="mod-content">
                <div id="description-val" class="field-ignore-highlight"> 
                 <div class="user-content-block"> 
                  <p>IndexWriter buffers up all deletes (by Term and Query) and only<br> applies them if 1) commit or NRT getReader() is called, or 2) a merge<br> is about to kickoff.</p> 
                  <p>We do this because, for a large index, it's very costly to open a<br> SegmentReader for every segment in the index. So we defer as long as<br> we can. We do it just before merge so that the merge can eliminate<br> the deleted docs.</p> 
                  <p>But, most merges are small, yet in a big index we apply deletes to all<br> of the segments, which is really very wasteful.</p> 
                  <p>Instead, we should only apply the buffered deletes to the segments<br> that are about to be merged, and keep the buffer around for the<br> remaining segments.</p> 
                  <p>I think it's not so hard to do; we'd have to have generations of<br> pending deletions, because the newly merged segment doesn't need the<br> same buffered deletions applied again. So every time a merge kicks<br> off, we pinch off the current set of buffered deletions, open a new<br> set (the next generation), and record which segment was created as of<br> which generation.</p> 
                  <p>This should be a very sizable gain for large indices that mix<br> deletes, though, less so in flex since opening the terms index is much<br> faster.</p> 
                 </div> 
                </div> 
               </div>
              </div>
              <div id="dnd-metadata" class="module toggle-wrap">
               <div id="dnd-metadata_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Attachments</h2>
               </div>
               <div class="mod-content">
                <div id="dnd-metadata-webpanel" data-can-attach="false" data-project-type="software" data-upload-limit="62914560" data-thumbnails-allowed="false"></div>
               </div>
              </div>
              <div id="attachmentmodule" class="module toggle-wrap">
               <div id="attachmentmodule_heading" class="mod-header">
                <ul class="ops">
                 <li class="drop">
                  <div class="aui-dd-parent">
                   <a href="#" class="icon drop-menu js-default-dropdown" title="Options"><span>Options</span></a>
                   <div class="aui-dropdown-content aui-list">
                    <ul id="attachment-sorting-options" class="aui-list-section aui-first">
                     <li class="aui-list-item"><a id="attachment-sort-key-name" href="/jira/browse/LUCENE-2680?attachmentSortBy=fileName#attachmentmodule" class="aui-list-checked aui-checked aui-list-item-link" title="viewissue.subtasks.tab.show.all.name"><span>Sort By Name</span></a></li>
                     <li class="aui-list-item"><a id="attachment-sort-key-date" href="/jira/browse/LUCENE-2680?attachmentSortBy=dateTime#attachmentmodule" class="aui-list-checked aui-list-item-link" title="Sort By Date"><span>Sort By Date</span></a></li>
                    </ul>
                    <ul id="attachment-sorting-order-options" class="aui-list-section aui-last">
                     <li class="aui-list-item"><a id="attachment-sort-direction-asc" href="/jira/browse/LUCENE-2680?attachmentOrder=asc#attachmentmodule" class="aui-list-checked aui-checked aui-list-item-link" title="Ascending"><span>Ascending</span></a></li>
                     <li class="aui-list-item"><a id="attachment-sort-direction-desc" href="/jira/browse/LUCENE-2680?attachmentOrder=desc#attachmentmodule" class="aui-list-checked aui-list-item-link" title="Descending"><span>Descending</span></a></li>
                    </ul>
                   </div>
                  </div></li>
                </ul>
                <h2 class="toggle-title">Attachments</h2>
               </div>
               <div class="mod-content">
                <ol id="file_attachments" class="item-attachments" data-sort-key="fileName" data-sort-order="asc">
                 <li class="attachment-content js-file-attachment" data-attachment-id="12465908" data-issue-id="12475670" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12465908/LUCENE-2680.patch" draggable="true" data-downloadurl="text/plain:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12465908/LUCENE-2680.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-file-txt" title="Text File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12465908/LUCENE-2680.patch" title="Latest  09/Dec/10 15:14 - Michael McCandless" draggable="true" data-downloadurl="text/plain:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12465908/LUCENE-2680.patch">LUCENE-2680.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2010-12-09T15:14:40.095Z">09/Dec/10 15:14</time>
                   </dd>
                   <dd class="attachment-size">
                    141 kB
                   </dd>
                   <dd class="attachment-author">
                    Michael McCandless
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12465894" data-issue-id="12475670" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12465894/LUCENE-2680.patch" draggable="true" data-downloadurl="text/plain:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12465894/LUCENE-2680.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-file-txt" title="Text File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12465894/LUCENE-2680.patch" title=" 09/Dec/10 10:58 - Michael McCandless" draggable="true" data-downloadurl="text/plain:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12465894/LUCENE-2680.patch">LUCENE-2680.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2010-12-09T10:58:42.495Z">09/Dec/10 10:58</time>
                   </dd>
                   <dd class="attachment-size">
                    124 kB
                   </dd>
                   <dd class="attachment-author">
                    Michael McCandless
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12465826" data-issue-id="12475670" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12465826/LUCENE-2680.patch" draggable="true" data-downloadurl="text/plain:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12465826/LUCENE-2680.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-file-txt" title="Text File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12465826/LUCENE-2680.patch" title=" 08/Dec/10 19:44 - Michael McCandless" draggable="true" data-downloadurl="text/plain:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12465826/LUCENE-2680.patch">LUCENE-2680.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2010-12-08T19:44:32.244Z">08/Dec/10 19:44</time>
                   </dd>
                   <dd class="attachment-size">
                    124 kB
                   </dd>
                   <dd class="attachment-author">
                    Michael McCandless
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12464980" data-issue-id="12475670" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12464980/LUCENE-2680.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12464980/LUCENE-2680.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12464980/LUCENE-2680.patch" title=" 30/Nov/10 19:24 - Jason Rutherglen" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12464980/LUCENE-2680.patch">LUCENE-2680.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2010-11-30T19:24:19.022Z">30/Nov/10 19:24</time>
                   </dd>
                   <dd class="attachment-size">
                    57 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12464979" data-issue-id="12475670" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12464979/LUCENE-2680.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12464979/LUCENE-2680.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12464979/LUCENE-2680.patch" title=" 30/Nov/10 19:12 - Jason Rutherglen" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12464979/LUCENE-2680.patch">LUCENE-2680.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2010-11-30T19:12:33.029Z">30/Nov/10 19:12</time>
                   </dd>
                   <dd class="attachment-size">
                    56 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12464787" data-issue-id="12475670" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12464787/LUCENE-2680.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12464787/LUCENE-2680.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12464787/LUCENE-2680.patch" title=" 27/Nov/10 20:08 - Jason Rutherglen" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12464787/LUCENE-2680.patch">LUCENE-2680.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2010-11-27T20:08:01.070Z">27/Nov/10 20:08</time>
                   </dd>
                   <dd class="attachment-size">
                    19 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12464786" data-issue-id="12475670" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12464786/LUCENE-2680.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12464786/LUCENE-2680.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12464786/LUCENE-2680.patch" title=" 27/Nov/10 19:44 - Jason Rutherglen" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12464786/LUCENE-2680.patch">LUCENE-2680.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2010-11-27T19:44:21.215Z">27/Nov/10 19:44</time>
                   </dd>
                   <dd class="attachment-size">
                    19 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12460150" data-issue-id="12475670" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12460150/LUCENE-2680.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12460150/LUCENE-2680.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12460150/LUCENE-2680.patch" title=" 22/Nov/10 00:19 - Jason Rutherglen" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12460150/LUCENE-2680.patch">LUCENE-2680.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2010-11-22T00:19:53.769Z">22/Nov/10 00:19</time>
                   </dd>
                   <dd class="attachment-size">
                    9 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12459087" data-issue-id="12475670" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12459087/LUCENE-2680.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12459087/LUCENE-2680.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12459087/LUCENE-2680.patch" title=" 08/Nov/10 21:29 - Jason Rutherglen" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12459087/LUCENE-2680.patch">LUCENE-2680.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2010-11-08T21:29:50.900Z">08/Nov/10 21:29</time>
                   </dd>
                   <dd class="attachment-size">
                    42 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12459030" data-issue-id="12475670" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12459030/LUCENE-2680.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12459030/LUCENE-2680.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12459030/LUCENE-2680.patch" title=" 08/Nov/10 01:55 - Jason Rutherglen" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12459030/LUCENE-2680.patch">LUCENE-2680.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2010-11-08T01:55:25.233Z">08/Nov/10 01:55</time>
                   </dd>
                   <dd class="attachment-size">
                    44 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12459028" data-issue-id="12475670" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12459028/LUCENE-2680.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12459028/LUCENE-2680.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12459028/LUCENE-2680.patch" title=" 08/Nov/10 01:02 - Jason Rutherglen" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12459028/LUCENE-2680.patch">LUCENE-2680.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2010-11-08T01:02:56.877Z">08/Nov/10 01:02</time>
                   </dd>
                   <dd class="attachment-size">
                    43 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12459025" data-issue-id="12475670" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12459025/LUCENE-2680.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12459025/LUCENE-2680.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12459025/LUCENE-2680.patch" title=" 07/Nov/10 22:34 - Jason Rutherglen" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12459025/LUCENE-2680.patch">LUCENE-2680.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2010-11-07T22:34:51.850Z">07/Nov/10 22:34</time>
                   </dd>
                   <dd class="attachment-size">
                    41 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12459011" data-issue-id="12475670" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12459011/LUCENE-2680.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12459011/LUCENE-2680.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12459011/LUCENE-2680.patch" title=" 06/Nov/10 23:10 - Jason Rutherglen" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12459011/LUCENE-2680.patch">LUCENE-2680.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2010-11-06T23:10:45.722Z">06/Nov/10 23:10</time>
                   </dd>
                   <dd class="attachment-size">
                    42 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12458859" data-issue-id="12475670" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12458859/LUCENE-2680.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12458859/LUCENE-2680.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12458859/LUCENE-2680.patch" title=" 04/Nov/10 22:52 - Jason Rutherglen" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12458859/LUCENE-2680.patch">LUCENE-2680.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2010-11-04T22:52:42.475Z">04/Nov/10 22:52</time>
                   </dd>
                   <dd class="attachment-size">
                    45 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12458770" data-issue-id="12475670" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12458770/LUCENE-2680.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12458770/LUCENE-2680.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12458770/LUCENE-2680.patch" title=" 03/Nov/10 22:48 - Jason Rutherglen" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12458770/LUCENE-2680.patch">LUCENE-2680.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2010-11-03T22:48:51.203Z">03/Nov/10 22:48</time>
                   </dd>
                   <dd class="attachment-size">
                    37 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12458700" data-issue-id="12475670" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12458700/LUCENE-2680.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12458700/LUCENE-2680.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12458700/LUCENE-2680.patch" title=" 03/Nov/10 01:22 - Jason Rutherglen" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12458700/LUCENE-2680.patch">LUCENE-2680.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2010-11-03T01:22:17.514Z">03/Nov/10 01:22</time>
                   </dd>
                   <dd class="attachment-size">
                    30 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12458565" data-issue-id="12475670" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12458565/LUCENE-2680.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12458565/LUCENE-2680.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12458565/LUCENE-2680.patch" title=" 01/Nov/10 17:58 - Jason Rutherglen" draggable="true" data-downloadurl="text/x-patch:LUCENE-2680.patch:https://issues.apache.org/jira/secure/attachment/12458565/LUCENE-2680.patch">LUCENE-2680.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2010-11-01T17:58:06.506Z">01/Nov/10 17:58</time>
                   </dd>
                   <dd class="attachment-size">
                    33 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                </ol>
               </div>
              </div>
              <div id="linkingmodule" class="module toggle-wrap">
               <div id="linkingmodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Issue Links</h2>
               </div>
               <div class="mod-content"> 
                <div class="links-container" data-default-link-icon="/jira/images/icons/generic_link_16.png"> 
                 <dl class="links-list "> 
                  <dt title="is depended upon by">
                   is depended upon by
                  </dt> 
                  <dd id="internal-12474550_10001"> 
                   <div class="link-content"> 
                    <p> <img src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21140&amp;avatarType=issuetype" width="16" height="16" title="Improvement - An improvement or enhancement to an existing feature or task." alt="Improvement - An improvement or enhancement to an existing feature or task."> <span title="LUCENE-2655: Get deletes working in the realtime branch"> <a href="/jira/browse/LUCENE-2655" data-issue-key="LUCENE-2655" class="issue-link link-title resolution">LUCENE-2655</a> <span class="link-summary">Get deletes working in the realtime branch</span> </span> </p> 
                    <ul class="link-snapshot"> 
                     <li class="priority"> <img src="/jira/images/icons/priorities/major.svg" width="16" height="16" title="Major - Major loss of function." alt="Major - Major loss of function."> </li> 
                     <li class="status"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done aui-lozenge-subtle jira-issue-status-lozenge-max-width-short" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Resolved</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.</span>">Resolved</span> </li> 
                    </ul> 
                   </div> 
                  </dd> 
                 </dl> 
                </div> 
               </div>
              </div>
              <div id="activitymodule" class="module toggle-wrap">
               <div id="activitymodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Activity</h2>
               </div>
               <div class="mod-content"> 
                <big-pipe data-id="activity-panel-pipe-id" style="height: 70px"> 
                 <div></div> 
                </big-pipe> 
               </div>
              </div>
             </div>
             <div id="viewissuesidebar" class="aui-item issue-side-column">
              <div id="peoplemodule" class="module toggle-wrap">
               <div id="peoplemodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">People</h2>
               </div>
               <div class="mod-content"> 
                <ul class="item-details" id="peopledetails"> 
                 <li class="people-details"> 
                  <dl> 
                   <dt>
                    Assignee:
                   </dt> 
                   <dd> 
                    <span id="assignee-val" class="view-issue-field"> <span class="user-hover" id="issue_summary_assignee_mikemccand" rel="mikemccand" data-user="{&quot;avatarUrl&quot;:&quot;https://issues.apache.org/jira/secure/useravatar?size=xsmall&amp;avatarId=10452&quot;,&quot;displayName&quot;:&quot;Michael McCandless&quot;,&quot;emailAddress&quot;:&quot;lucene@mikemccandless.com&quot;,&quot;username&quot;:&quot;mikemccand&quot;}"> <span class="aui-avatar aui-avatar-small"><span class="aui-avatar-inner"><img src="https://issues.apache.org/jira/secure/useravatar?size=small&amp;avatarId=10452" alt="mikemccand"></span></span> Michael McCandless </span> </span> 
                   </dd> 
                  </dl> 
                  <dl> 
                   <dt>
                    Reporter:
                   </dt> 
                   <dd> 
                    <span id="reporter-val" class="view-issue-field"> <span class="user-hover" id="issue_summary_reporter_mikemccand" rel="mikemccand" data-user="{&quot;avatarUrl&quot;:&quot;https://issues.apache.org/jira/secure/useravatar?size=xsmall&amp;avatarId=10452&quot;,&quot;displayName&quot;:&quot;Michael McCandless&quot;,&quot;emailAddress&quot;:&quot;lucene@mikemccandless.com&quot;,&quot;username&quot;:&quot;mikemccand&quot;}"> <span class="aui-avatar aui-avatar-small"><span class="aui-avatar-inner"><img src="https://issues.apache.org/jira/secure/useravatar?size=small&amp;avatarId=10452" alt="mikemccand"></span></span> Michael McCandless </span> </span> 
                   </dd> 
                  </dl> </li> 
                </ul> 
                <ul class="item-details"> 
                 <li> 
                  <dl> 
                   <dt>
                    Votes:
                   </dt> 
                   <dd> 
                    <span id="vote-data" class="aui-badge vote-state-off">0</span> 
                    <span id="vote-label" title="You have to be logged in to vote for an issue.">Vote for this issue</span> 
                   </dd> 
                  </dl> 
                  <dl> 
                   <dt>
                    Watchers:
                   </dt> 
                   <dd> 
                    <span id="watcher-data" class="aui-badge watch-state-off">2</span> 
                    <span id="watch-label" title="You have to be logged in to watch an issue.">Start watching this issue</span> 
                   </dd> 
                  </dl> </li> 
                </ul> 
               </div>
              </div>
              <div id="datesmodule" class="module toggle-wrap">
               <div id="datesmodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Dates</h2>
               </div>
               <div class="mod-content"> 
                <ul class="item-details"> 
                 <li> 
                  <dl class="dates"> 
                   <dt>
                    Created:
                   </dt> 
                   <dd class="date user-tz" title="01/Oct/10 22:22"> 
                    <span data-name="Created" id="created-val" data-fieldtype="datetime"> <time class="livestamp" datetime="2010-10-01T22:22:24+0000">01/Oct/10 22:22</time> </span> 
                   </dd> 
                  </dl> 
                  <dl class="dates"> 
                   <dt>
                    Updated:
                   </dt> 
                   <dd class="date user-tz" title="02/May/13 02:29"> 
                    <span data-name="Updated" id="updated-val" data-fieldtype="datetime"> <time class="livestamp" datetime="2013-05-02T02:29:33+0000">02/May/13 02:29</time> </span> 
                   </dd> 
                  </dl> 
                  <dl class="dates"> 
                   <dt>
                    Resolved:
                   </dt> 
                   <dd class="date user-tz" title="17/Dec/10 10:11"> 
                    <span data-name="Resolved" id="resolutiondate-val" data-fieldtype="datetime"> <time class="livestamp" datetime="2010-12-17T10:11:07+0000">17/Dec/10 10:11</time> </span> 
                   </dd> 
                  </dl> </li> 
                </ul> 
               </div>
              </div>
             </div>
            </div>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div>
     <!-- .aui-page-panel-inner -->
    </div>
    <!-- .aui-page-panel -->
    <div class="issue-navigator-init"></div> 
   </section> 
   <footer id="footer" role="contentinfo"> 
    <section class="footer-body"> 
     <ul class="atlassian-footer"> 
      <li> Atlassian JIRA <a class="seo-link" rel="nofollow" href="https://www.atlassian.com/software/jira">Project Management Software</a> <span id="footer-build-information">(v7.6.3#76005-<span title="8a4e38d34af948780dbf52044e7aafb13a7cae58" data-commit-id="8a4e38d34af948780dbf52044e7aafb13a7cae58}">sha1:8a4e38d</span>)</span> </li> 
      <li> <a id="about-link" rel="nofollow" href="/jira/secure/AboutPage.jspa/secure/AboutPage.jspa">About JIRA</a> </li> 
      <li> <a id="footer-report-problem-link" rel="nofollow" href="/jira/secure/CreateIssue!default.jspa">Report a problem</a> </li> 
     </ul> 
     <ul class="atlassian-footer"> 
      <li class="licensemessage"> Powered by a free Atlassian <a rel="nofollow" href="http://www.atlassian.com/software/jira">JIRA</a> open source license for n/a, Apache Software Foundation. Try JIRA - <a rel="nofollow" href="http://www.atlassian.com/software/jira">bug tracking software</a> for <i>your</i> team. </li> 
     </ul> 
     <div id="footer-logo">
      <a rel="nofollow" href="http://www.atlassian.com/">Atlassian</a>
     </div> 
    </section> 
    <fieldset class="hidden parameters"> 
     <input type="hidden" title="loggedInUser" value=""> 
     <input type="hidden" title="ajaxTimeout" value="The call to the JIRA server did not complete within the timeout period.  We are unsure of the result of this operation."> 
     <input type="hidden" title="JiraVersion" value="7.6.3"> 
     <input type="hidden" title="ajaxUnauthorised" value="You are not authorised to perform this operation. Please log in."> 
     <input type="hidden" title="baseURL" value="https://issues.apache.org/jira"> 
     <input type="hidden" title="ajaxCommsError" value="The JIRA server could not be contacted. This may be a temporary glitch or the server may be down. "> 
     <input type="hidden" title="ajaxServerError" value="The JIRA server was contacted but has returned an error response. We are unsure of the result of this operation."> 
     <input type="hidden" title="ajaxErrorCloseDialog" value="Close this dialog and press refresh in your browser"> 
     <input type="hidden" title="ajaxErrorDialogHeading" value="Communications Breakdown"> 
     <input type="hidden" title="dirtyMessage" value="You have entered new data on this page. If you navigate away from this page without first saving your data, the changes will be lost."> 
     <input type="hidden" title="dirtyDialogMessage" value="You have entered new data in this dialog. If you navigate away from this dialog without first saving your data, the changes will be lost. Click cancel to return to the dialog."> 
     <input type="hidden" title="keyType" value="Type"> 
     <input type="hidden" title="keyThen" value="then"> 
     <input type="hidden" title="dblClickToExpand" value="Double click to expand"> 
     <input type="hidden" title="actions" value="Actions"> 
     <input type="hidden" title="removeItem" value="Remove"> 
     <input type="hidden" title="workflow" value="Workflow"> 
     <input type="hidden" title="labelNew" value="New Label"> 
     <input type="hidden" title="issueActionsHint" value="Begin typing for available operations or press down to see all"> 
     <input type="hidden" title="closelink" value="Close"> 
     <input type="hidden" title="dotOperations" value="Operations"> 
     <input type="hidden" title="dotLoading" value="Loading..."> 
     <input type="hidden" title="frotherSuggestions" value="Suggestions"> 
     <input type="hidden" title="frotherNomatches" value="No Matches"> 
     <input type="hidden" title="multiselectVersionsError" value="{0} is not a valid version."> 
     <input type="hidden" title="multiselectComponentsError" value="{0} is not a valid component."> 
     <input type="hidden" title="multiselectGenericError" value="The value {0} is invalid."> 
    </fieldset> 
   </footer> 
  </div> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:bigpipe-js/jira.webresources:bigpipe-js.js" data-wrm-key="jira.webresources:bigpipe-js" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["activity-panel-pipe-id"]="\"\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n    \u003cdiv class=\\\"tabwrap tabs2\\\"\u003e\\n\\n        \u003cul id=\\\"issue-tabs\\\" class=\\\"tabs horizontal\\\"\u003e\\n                                \\n            \u003cli  data-id=\\\"all-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel\\\" data-label=\\\"All\\\" data-href=\\\"\\/jira\\/browse\\/LUCENE-2680?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"all-tabpanel\\\" href=\\\"\\/jira\\/browse\\/LUCENE-2680?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel\\\"\u003e\u003cstrong\u003eAll\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  class=\\\"active\\\" id=\\\"comment-tabpanel\\\"  data-id=\\\"comment-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel\\\" data-label=\\\"Comments\\\" data-href=\\\"\\/jira\\/browse\\/LUCENE-2680?page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel\\\"\u003e\\n                            \u003cstrong tabindex=\\\"0\\\"\u003eComments\u003c\\/strong\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"worklog-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:worklog-tabpanel\\\" data-label=\\\"Work Log\\\" data-href=\\\"\\/jira\\/browse\\/LUCENE-2680?page=com.atlassian.jira.plugin.system.issuetabpanels:worklog-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"worklog-tabpanel\\\" href=\\\"\\/jira\\/browse\\/LUCENE-2680?page=com.atlassian.jira.plugin.system.issuetabpanels:worklog-tabpanel\\\"\u003e\u003cstrong\u003eWork Log\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"changehistory-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:changehistory-tabpanel\\\" data-label=\\\"History\\\" data-href=\\\"\\/jira\\/browse\\/LUCENE-2680?page=com.atlassian.jira.plugin.system.issuetabpanels:changehistory-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"changehistory-tabpanel\\\" href=\\\"\\/jira\\/browse\\/LUCENE-2680?page=com.atlassian.jira.plugin.system.issuetabpanels:changehistory-tabpanel\\\"\u003e\u003cstrong\u003eHistory\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"activity-stream-issue-tab\\\" data-key=\\\"com.atlassian.streams.streams-jira-plugin:activity-stream-issue-tab\\\" data-label=\\\"Activity\\\" data-href=\\\"\\/jira\\/browse\\/LUCENE-2680?page=com.atlassian.streams.streams-jira-plugin:activity-stream-issue-tab\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"activity-stream-issue-tab\\\" href=\\\"\\/jira\\/browse\\/LUCENE-2680?page=com.atlassian.streams.streams-jira-plugin:activity-stream-issue-tab\\\"\u003e\u003cstrong\u003eActivity\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"transitions-summary-tabpanel\\\" data-key=\\\"com.googlecode.jira-suite-utilities:transitions-summary-tabpanel\\\" data-label=\\\"Transitions\\\" data-href=\\\"\\/jira\\/browse\\/LUCENE-2680?page=com.googlecode.jira-suite-utilities:transitions-summary-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"transitions-summary-tabpanel\\\" href=\\\"\\/jira\\/browse\\/LUCENE-2680?page=com.googlecode.jira-suite-utilities:transitions-summary-tabpanel\\\"\u003e\u003cstrong\u003eTransitions\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                \u003c\\/ul\u003e\\n\\n                    \u003cdiv class=\\\"sortwrap\\\"\u003e\\n                                    \u003ca class=\\\"issue-activity-sort-link ajax-activity-content\\\" rel=\\\"nofollow\\\" data-tab-sort data-order=\\\"desc\\\" href=\\\"\\/jira\\/browse\\/LUCENE-2680?actionOrder=desc\\\" title=\\\"Ascending order - Click to sort in descending order\\\"\u003e\\n                        \u003cspan class=\\\"aui-icon aui-icon-small aui-iconfont-up\\\"\u003eAscending order - Click to sort in descending order\u003c\\/span\u003e\\n                    \u003c\\/a\u003e\\n                            \u003c\\/div\u003e\\n            \u003c\\/div\u003e\\n    \u003cdiv class=\\\"issuePanelWrapper\\\"\u003e\\n        \u003cdiv class=\\\"issuePanelProgress\\\"\u003e\u003c\\/div\u003e\\n        \u003cdiv class=\\\"issuePanelContainer\\\" id=\\\"issue_actions_container\\\"\u003e\\n                                    \\n\\n\\n\u003cdiv id=\\\"comment-12917174\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12917174&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12917174\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12917174_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12917174_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Oct\\/10 09:47\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-10-02T09:47:21+0000\'\u003e02\\/Oct\\/10 09:47\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHmm... I think there\'s another silliness going on inside IW: when applying deletes, we one-by-one open the SR, apply deletes, close it.\u003c\\/p\u003e\\n\\n\u003cp\u003eBut then immediately thereafter we open the N segments to be merged.\u003c\\/p\u003e\\n\\n\u003cp\u003eWe should somehow not do this double open, eg, use the pool temporarily, so that the reader is opened to apply deletes, and then kept open in order to do the merging.  Using the pool should be fine because the merge forcefully evicts the sub readers from the pool after completion.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12917174_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12917174_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Oct\\/10 09:47\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-10-02T09:47:21+0000\'\u003e02\\/Oct\\/10 09:47\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Hmm... I think there\'s another silliness going on inside IW: when applying deletes, we one-by-one open the SR, apply deletes, close it. \\n\\n But then immediately thereafter we open the N segments to be merged. \\n\\n We should somehow not do this double open, eg, use the pool temporarily, so that the reader is opened to apply deletes, and then kept open in order to do the merging.  Using the pool should be fine because the merge forcefully evicts the sub readers from the pool after completion.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12919549\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12919549&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12919549\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12919549_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12919549_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Oct\\/10 00:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-10-10T00:57:48+0000\'\u003e10\\/Oct\\/10 00:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eMaybe we should implement this as pending deletes per segment rather than using a generational system because with \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2655\\\" title=\\\"Get deletes working in the realtime branch\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2655\\\"\u003e\u003cdel\u003eLUCENE-2655\u003c\\/del\u003e\u003c\\/a\u003e, we may need to maintain the per query\\/term docidupto per segment.  The downside is the extraneous memory consumed by the hash map, however, if we use BytesRefHash this\'ll be reduced, or would it?  Because we\'d be writing the term bytes to a unique byte pool per segment?  Hmm... Maybe there\'s a more efficient way.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12919549_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12919549_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Oct\\/10 00:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-10-10T00:57:48+0000\'\u003e10\\/Oct\\/10 00:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Maybe we should implement this as pending deletes per segment rather than using a generational system because with   LUCENE-2655  , we may need to maintain the per query\\/term docidupto per segment.  The downside is the extraneous memory consumed by the hash map, however, if we use BytesRefHash this\'ll be reduced, or would it?  Because we\'d be writing the term bytes to a unique byte pool per segment?  Hmm... Maybe there\'s a more efficient way.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12919780\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12919780&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12919780\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12919780_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12919780_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Oct\\/10 10:05\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-10-11T10:05:15+0000\'\u003e11\\/Oct\\/10 10:05\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eTracking per-segment would be easier but I worry about indices that have large numbers of segments... eg w\\/ a large mergeFactor and frequent flushing you can get very many segments.\u003c\\/p\u003e\\n\\n\u003cp\u003eSo if we track per-segment, suddenly the RAM required (as well as CPU cost of copying these deletions to the N segments) is multiplied by the number of segments.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12919780_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12919780_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Oct\\/10 10:05\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-10-11T10:05:15+0000\'\u003e11\\/Oct\\/10 10:05\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Tracking per-segment would be easier but I worry about indices that have large numbers of segments... eg w\\/ a large mergeFactor and frequent flushing you can get very many segments. \\n\\n So if we track per-segment, suddenly the RAM required (as well as CPU cost of copying these deletions to the N segments) is multiplied by the number of segments.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12927063\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12927063&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12927063\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12927063_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12927063_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Nov\\/10 17:58\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-01T17:58:06+0000\'\u003e01\\/Nov\\/10 17:58\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThe general approach is to reuse BufferedDeletes though place them into a segment info keyed map for those segments generated post lastSegmentIndex as per what has been discussed here \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2655?focusedCommentId=12922894&amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12922894\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttps:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2655?focusedCommentId=12922894&amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12922894\u003c\\/a\u003e and below.\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003elastSegmentIndex is added to IW\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eDW segmentDeletes is a map of segment info -&gt; buffered deletes.  In the apply deletes method buffered deletes are pulled for a given segment info if they exist, otherwise they\'re taken from deletesFlushedLastSeg.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eI\'m not entirely sure what pushDeletes should do now, probably the same thing as currently, only the name should change slightly in that it\'s pushing deletes only for the RAM buffer docs.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eThere needs to be tests to ensure the docid-upto logic is working correctly\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eI\'m not sure what to do with DW hasDeletes (it\'s usage is commented out)\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eDoes there need to be separate deletes for the ram buffer vis-\\u00E0-vis the (0 - lastSegmentIndex) deletes?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eThe memory accounting\'ll now get interesting as we\'ll need to track the RAM usage of terms\\/queries across multiple maps.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eIn commitMerge, DW verifySegmentDeletes removes the unused info -&gt; deletes\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003etestDeletes deletes a doc in segment 1, then merges segments 1 and 2.  We then test to insure the deletes were in fact applied only to segment 1 and 2.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003etestInitLastSegmentIndex insures that on IW init, the lastSegmentIndex is in fact set\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12927063_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12927063_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Nov\\/10 17:58\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-01T17:58:06+0000\'\u003e01\\/Nov\\/10 17:58\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    The general approach is to reuse BufferedDeletes though place them into a segment info keyed map for those segments generated post lastSegmentIndex as per what has been discussed here  https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2655?focusedCommentId=12922894&amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12922894  and below. \\n\\n \\n\\t lastSegmentIndex is added to IW \\n \\n\\n\\n \\n\\t DW segmentDeletes is a map of segment info -&gt; buffered deletes.  In the apply deletes method buffered deletes are pulled for a given segment info if they exist, otherwise they\'re taken from deletesFlushedLastSeg. \\n \\n\\n\\n \\n\\t I\'m not entirely sure what pushDeletes should do now, probably the same thing as currently, only the name should change slightly in that it\'s pushing deletes only for the RAM buffer docs. \\n \\n\\n\\n \\n\\t There needs to be tests to ensure the docid-upto logic is working correctly \\n \\n\\n\\n \\n\\t I\'m not sure what to do with DW hasDeletes (it\'s usage is commented out) \\n \\n\\n\\n \\n\\t Does there need to be separate deletes for the ram buffer vis-\\u00E0-vis the (0 - lastSegmentIndex) deletes? \\n \\n\\n\\n \\n\\t The memory accounting\'ll now get interesting as we\'ll need to track the RAM usage of terms\\/queries across multiple maps. \\n \\n\\n\\n \\n\\t In commitMerge, DW verifySegmentDeletes removes the unused info -&gt; deletes \\n \\n\\n\\n \\n\\t testDeletes deletes a doc in segment 1, then merges segments 1 and 2.  We then test to insure the deletes were in fact applied only to segment 1 and 2. \\n \\n\\n\\n \\n\\t testInitLastSegmentIndex insures that on IW init, the lastSegmentIndex is in fact set \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12927488\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12927488&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12927488\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12927488_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12927488_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Nov\\/10 16:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-02T16:41:13+0000\'\u003e02\\/Nov\\/10 16:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eThe most recent one \\\"wins\\\", and we should do only one delete (per segment) for that term.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eHow should we define this recency and why does it matter?  Should it be per term\\/query or for the entire BD?\u003c\\/p\u003e\\n\\n\u003cp\u003eI think there\'s an issue with keeping lastSegmentIndex in DW, while it\'s easy to maintain, Mike had mentioned keeping the lastSegmentIndex per BufferedDeletes object.  Coalescing the BDs should be easier to maintain after successful merge than maintaining a separate BD for them.  We\'ll see.\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'ll put together another patch with these changes.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12927488_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12927488_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Nov\\/10 16:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-02T16:41:13+0000\'\u003e02\\/Nov\\/10 16:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     The most recent one \\\"wins\\\", and we should do only one delete (per segment) for that term.  \\n\\n How should we define this recency and why does it matter?  Should it be per term\\/query or for the entire BD? \\n\\n I think there\'s an issue with keeping lastSegmentIndex in DW, while it\'s easy to maintain, Mike had mentioned keeping the lastSegmentIndex per BufferedDeletes object.  Coalescing the BDs should be easier to maintain after successful merge than maintaining a separate BD for them.  We\'ll see. \\n\\n I\'ll put together another patch with these changes.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12927714\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12927714&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12927714\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12927714_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12927714_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Nov\\/10 01:22\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-03T01:22:17+0000\'\u003e03\\/Nov\\/10 01:22\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHere\'s a new patch with properly working last segment index.  \u003c\\/p\u003e\\n\\n\u003cp\u003eThe trunk version of apply deletes has become applyDeletesAll and is functionally unchanged.\u003c\\/p\u003e\\n\\n\u003cp\u003eThere\'s a new method, DW applyDeletesToSegments called by _mergeInit for segments that are about to be merged.  The deleted terms and queries for these segments are kept in hash sets because docid-uptos are not needed.  \u003c\\/p\u003e\\n\\n\u003cp\u003eLike the last patch DW maintains the last segment index.  There\'s no need to maintain the last-segindex per BD, instead I think it\'s only useful per DW, and for trunk we only have one DW being used at a time.  \u003c\\/p\u003e\\n\\n\u003cp\u003eOn successful merge, the last segment index is set to the segment index previous to the start segment of the merge.  The merged segments deletes are coalesced into the startIndex-1\'s segment deletes.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12927714_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12927714_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Nov\\/10 01:22\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-03T01:22:17+0000\'\u003e03\\/Nov\\/10 01:22\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Here\'s a new patch with properly working last segment index.   \\n\\n The trunk version of apply deletes has become applyDeletesAll and is functionally unchanged. \\n\\n There\'s a new method, DW applyDeletesToSegments called by _mergeInit for segments that are about to be merged.  The deleted terms and queries for these segments are kept in hash sets because docid-uptos are not needed.   \\n\\n Like the last patch DW maintains the last segment index.  There\'s no need to maintain the last-segindex per BD, instead I think it\'s only useful per DW, and for trunk we only have one DW being used at a time.   \\n\\n On successful merge, the last segment index is set to the segment index previous to the start segment of the merge.  The merged segments deletes are coalesced into the startIndex-1\'s segment deletes.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12927943\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12927943&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12927943\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12927943_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12927943_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Nov\\/10 18:38\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-03T18:38:58+0000\'\u003e03\\/Nov\\/10 18:38\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI\'m redoing things a bit to take into account the concurrency of merges.  For example, if a merge fails, we need to not have removed those segments\' deletes to be applied.  Also probably the most tricky part is that lastSegmentIndex could have changed since a merge started, which means we need to be careful about how and which deletes we coalesce.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12927943_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12927943_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Nov\\/10 18:38\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-03T18:38:58+0000\'\u003e03\\/Nov\\/10 18:38\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I\'m redoing things a bit to take into account the concurrency of merges.  For example, if a merge fails, we need to not have removed those segments\' deletes to be applied.  Also probably the most tricky part is that lastSegmentIndex could have changed since a merge started, which means we need to be careful about how and which deletes we coalesce.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12927979\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12927979&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12927979\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12927979_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12927979_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Nov\\/10 20:07\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-03T20:07:31+0000\'\u003e03\\/Nov\\/10 20:07\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAnother use case that can be wacky is if commit is called and a merge is finishing before or after, in that case all (point-in-time) deletes will have been applied by commit, however do we want to clear all per-segment deletes at the end of commit?  This would blank out deletes being applied by the merge, most of which should be cleared out, however if new deletes arrived during the commit (is this possible?), then we want these to be attached to segments and not lost.  I guess we want to DW sync\'d clear out deletes in the applyDeletesAll method.  ADA will apply those deletes, any incoming will queue up and be shuffled around.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12927979_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12927979_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Nov\\/10 20:07\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-03T20:07:31+0000\'\u003e03\\/Nov\\/10 20:07\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Another use case that can be wacky is if commit is called and a merge is finishing before or after, in that case all (point-in-time) deletes will have been applied by commit, however do we want to clear all per-segment deletes at the end of commit?  This would blank out deletes being applied by the merge, most of which should be cleared out, however if new deletes arrived during the commit (is this possible?), then we want these to be attached to segments and not lost.  I guess we want to DW sync\'d clear out deletes in the applyDeletesAll method.  ADA will apply those deletes, any incoming will queue up and be shuffled around.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12928052\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12928052&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12928052\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12928052_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12928052_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Nov\\/10 22:48\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-03T22:48:53+0000\'\u003e03\\/Nov\\/10 22:48\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eIn my head at least I think the concurrency issues are worked\u003cbr\\/\u003e\\nout in this patch. We\'re not taking into account recency of\u003cbr\\/\u003e\\ndeletes as I\'m not sure it matters. DW applyDeletesToSegments\u003cbr\\/\u003e\\ntakes care of the coalescing of segment deletes as this is a\u003cbr\\/\u003e\\nsynced DW method called by a synced IW method, meaning\u003cbr\\/\u003e\\nnothing\'ll be changing anywhere, so we\'re good with the possible\u003cbr\\/\u003e\\nconcurrency issues. I\'m still a little worried about concurrent\u003cbr\\/\u003e\\nincoming deleted terms\\/queries, however those can\'t be added\u003cbr\\/\u003e\\nuntil after a successful ADTS call due to the DW sync. \u003c\\/p\u003e\\n\\n\u003cp\u003eGuess it\'s time for the complete tests to run.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12928052_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12928052_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Nov\\/10 22:48\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-03T22:48:53+0000\'\u003e03\\/Nov\\/10 22:48\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    In my head at least I think the concurrency issues are worked \\nout in this patch. We\'re not taking into account recency of \\ndeletes as I\'m not sure it matters. DW applyDeletesToSegments \\ntakes care of the coalescing of segment deletes as this is a \\nsynced DW method called by a synced IW method, meaning \\nnothing\'ll be changing anywhere, so we\'re good with the possible \\nconcurrency issues. I\'m still a little worried about concurrent \\nincoming deleted terms\\/queries, however those can\'t be added \\nuntil after a successful ADTS call due to the DW sync.  \\n\\n Guess it\'s time for the complete tests to run.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12928075\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12928075&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12928075\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12928075_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12928075_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Nov\\/10 01:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-04T01:00:29+0000\'\u003e04\\/Nov\\/10 01:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThere\'s an issue in that we\'re redundantly applying deletes in the applyDeletesAll case because the deletes may have already been applied to a segment when a merge happened, ie, by applyDeletesToSegments.  In the ADA case we need to use applyDeletesToSegments up to the segment point when the buffered deletes can be used.  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12928075_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12928075_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Nov\\/10 01:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-04T01:00:29+0000\'\u003e04\\/Nov\\/10 01:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    There\'s an issue in that we\'re redundantly applying deletes in the applyDeletesAll case because the deletes may have already been applied to a segment when a merge happened, ie, by applyDeletesToSegments.  In the ADA case we need to use applyDeletesToSegments up to the segment point when the buffered deletes can be used.                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12928078\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12928078&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12928078\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12928078_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12928078_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Nov\\/10 01:09\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-04T01:09:26+0000\'\u003e04\\/Nov\\/10 01:09\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThis brings up another issue which is we\'re blindly iterating over docs in a segment reader to delete, even if we can know ahead of time that the reader\'s docs are going to exceed the term\\/query\'s docid-upto (from the max doc of the reader).  In applyDeletes we\'re opening a term docs iterator, though I think we\'re breaking at the first doc and moving on if the docid-upto is exceeded.  This term docs iterator opening can be skipped.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12928078_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12928078_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Nov\\/10 01:09\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-04T01:09:26+0000\'\u003e04\\/Nov\\/10 01:09\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    This brings up another issue which is we\'re blindly iterating over docs in a segment reader to delete, even if we can know ahead of time that the reader\'s docs are going to exceed the term\\/query\'s docid-upto (from the max doc of the reader).  In applyDeletes we\'re opening a term docs iterator, though I think we\'re breaking at the first doc and moving on if the docid-upto is exceeded.  This term docs iterator opening can be skipped.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12928417\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12928417&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12928417\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12928417_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12928417_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Nov\\/10 22:52\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-04T22:52:42+0000\'\u003e04\\/Nov\\/10 22:52\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHere\'s a nice little checkpoint with more tests passing.  \u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eA last known segment is recorded, which is the last segment seen when\u003cbr\\/\u003e\\nadding a delete term\\/query per segment. This is for a applyDeletesAll\u003cbr\\/\u003e\\ncheck to ensure a given query\\/term has not already been applied to a\u003cbr\\/\u003e\\nsegment. If a term\\/query exists in the per-segment deletes and is in\u003cbr\\/\u003e\\ndeletesFlushed, we delete, unless we\'re beyond the last known segment, at\u003cbr\\/\u003e\\nwhich point we simply delete (adhering of course to the docid-upto).\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eIn the interest of accuracy I nixed lastSegmentIndex in favor of\u003cbr\\/\u003e\\nlastSegmentInfo which is easier for debugging and implementation when\u003cbr\\/\u003e\\nsegments are shuffled around and\\/or removed\\/added. There\'s not too much of\u003cbr\\/\u003e\\na penalty in terms of performance. \u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eorg.apache.lucene.index tests pass\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eI need to address the applying deletes only on readers within the\u003cbr\\/\u003e\\ndocid-upto per term\\/query, perhaps that\'s best left to a different Jira\u003cbr\\/\u003e\\nissue.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eStill not committable as it needs cleaning up, complete unit tests, who\u003cbr\\/\u003e\\nknows what else.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12928417_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12928417_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Nov\\/10 22:52\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-04T22:52:42+0000\'\u003e04\\/Nov\\/10 22:52\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Here\'s a nice little checkpoint with more tests passing.   \\n\\n \\n\\t A last known segment is recorded, which is the last segment seen when \\nadding a delete term\\/query per segment. This is for a applyDeletesAll \\ncheck to ensure a given query\\/term has not already been applied to a \\nsegment. If a term\\/query exists in the per-segment deletes and is in \\ndeletesFlushed, we delete, unless we\'re beyond the last known segment, at \\nwhich point we simply delete (adhering of course to the docid-upto). \\n \\n\\n\\n \\n\\t In the interest of accuracy I nixed lastSegmentIndex in favor of \\nlastSegmentInfo which is easier for debugging and implementation when \\nsegments are shuffled around and\\/or removed\\/added. There\'s not too much of \\na penalty in terms of performance.  \\n \\n\\n\\n \\n\\t org.apache.lucene.index tests pass \\n \\n\\n\\n \\n\\t I need to address the applying deletes only on readers within the \\ndocid-upto per term\\/query, perhaps that\'s best left to a different Jira \\nissue. \\n \\n\\n\\n \\n\\t Still not committable as it needs cleaning up, complete unit tests, who \\nknows what else. \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12928923\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12928923&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12928923\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12928923_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12928923_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Nov\\/10 03:21\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-06T03:21:00+0000\'\u003e06\\/Nov\\/10 03:21\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAll tests pass except org.apache.lucene.index.TestIndexWriterMergePolicy testMaxBufferedDocsChange.  Odd.  I\'m looking into this.\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003e[junit] junit.framework.AssertionFailedError: maxMergeDocs=2147483647; numSegments=11; upperBound=10; mergeFactor=10; \\nsegs=_65:c5950 _5t:c10-&gt;_32 _5u:c10-&gt;_32 _5v:c10-&gt;_32 _5w:c10-&gt;_32 _5x:c10-&gt;_32 _5y:c10-&gt;_32 _5z:c10-&gt;_32 _60:c10-&gt;_32 _61:c10-&gt;_32 _62:c3-&gt;_32 _64:c7-&gt;_62\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\\n\u003cp\u003eAlso, in IW deleteDocument\u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/star_yellow.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e we\'re calling a new method, getSegmentInfos which is sync\'ed on IW.  Maybe we should use an atomic reference to a read only segment infos instead?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12928923_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12928923_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Nov\\/10 03:21\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-06T03:21:00+0000\'\u003e06\\/Nov\\/10 03:21\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    All tests pass except org.apache.lucene.index.TestIndexWriterMergePolicy testMaxBufferedDocsChange.  Odd.  I\'m looking into this. \\n\\n  \\n [junit] junit.framework.AssertionFailedError: maxMergeDocs=2147483647; numSegments=11; upperBound=10; mergeFactor=10; \\nsegs=_65:c5950 _5t:c10-&gt;_32 _5u:c10-&gt;_32 _5v:c10-&gt;_32 _5w:c10-&gt;_32 _5x:c10-&gt;_32 _5y:c10-&gt;_32 _5z:c10-&gt;_32 _60:c10-&gt;_32 _61:c10-&gt;_32 _62:c3-&gt;_32 _64:c7-&gt;_62\\n \\n  \\n\\n Also, in IW deleteDocument  we\'re calling a new method, getSegmentInfos which is sync\'ed on IW.  Maybe we should use an atomic reference to a read only segment infos instead?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12928933\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12928933&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12928933\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12928933_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12928933_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Nov\\/10 05:05\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-06T05:05:31+0000\'\u003e06\\/Nov\\/10 05:05\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eSorry, spoke too soon, I made a small change to not redundantly delete, in apply deletes all and TestStressIndexing2 is breaking.  I think we need to \\\"push\\\" segment infos changes to DW as they happen.  I\'m guessing that segment infos are being shuffled around and so the infos passed into DW in IW deleteDoc methods may be out of date by the time deletes are attached to segments.  Hopefully there aren\'t any lurking deadlock issues with this.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12928933_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12928933_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Nov\\/10 05:05\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-06T05:05:31+0000\'\u003e06\\/Nov\\/10 05:05\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Sorry, spoke too soon, I made a small change to not redundantly delete, in apply deletes all and TestStressIndexing2 is breaking.  I think we need to \\\"push\\\" segment infos changes to DW as they happen.  I\'m guessing that segment infos are being shuffled around and so the infos passed into DW in IW deleteDoc methods may be out of date by the time deletes are attached to segments.  Hopefully there aren\'t any lurking deadlock issues with this.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12929229\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12929229&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12929229\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12929229_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12929229_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Nov\\/10 21:59\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-06T21:59:20+0000\'\u003e06\\/Nov\\/10 21:59\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003ePushing the segment infos seems to have cleared up some of the tests failing, however intermittently (1\\/4 of the time) there\'s the one below.\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'m going to re-add lastSegmentInfo\\/Index, and assert that if we\'re not using it, that the deletes obtained from the segmentinfo -&gt; deletes map is the same.  \u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003e[junit] Testsuite: org.apache.lucene.index.TestStressIndexing2\\n    [junit] Testcase: testRandom(org.apache.lucene.index.TestStressIndexing2):\\tFAILED\\n    [junit] expected:&lt;12&gt; but was:&lt;11&gt;\\n    [junit] junit.framework.AssertionFailedError: expected:&lt;12&gt; but was:&lt;11&gt;\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:878)\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:844)\\n    [junit] \\tat org.apache.lucene.index.TestStressIndexing2.verifyEquals(TestStressIndexing2.java:278)\\n    [junit] \\tat org.apache.lucene.index.TestStressIndexing2.verifyEquals(TestStressIndexing2.java:271)\\n    [junit] \\tat org.apache.lucene.index.TestStressIndexing2.testRandom(TestStressIndexing2.java:89)\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12929229_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12929229_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Nov\\/10 21:59\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-06T21:59:20+0000\'\u003e06\\/Nov\\/10 21:59\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Pushing the segment infos seems to have cleared up some of the tests failing, however intermittently (1\\/4 of the time) there\'s the one below. \\n\\n I\'m going to re-add lastSegmentInfo\\/Index, and assert that if we\'re not using it, that the deletes obtained from the segmentinfo -&gt; deletes map is the same.   \\n\\n  \\n [junit] Testsuite: org.apache.lucene.index.TestStressIndexing2\\n    [junit] Testcase: testRandom(org.apache.lucene.index.TestStressIndexing2):\\tFAILED\\n    [junit] expected:&lt;12&gt; but was:&lt;11&gt;\\n    [junit] junit.framework.AssertionFailedError: expected:&lt;12&gt; but was:&lt;11&gt;\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:878)\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:844)\\n    [junit] \\tat org.apache.lucene.index.TestStressIndexing2.verifyEquals(TestStressIndexing2.java:278)\\n    [junit] \\tat org.apache.lucene.index.TestStressIndexing2.verifyEquals(TestStressIndexing2.java:271)\\n    [junit] \\tat org.apache.lucene.index.TestStressIndexing2.testRandom(TestStressIndexing2.java:89)\\n \\n               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12929247\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12929247&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12929247\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12929247_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12929247_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Nov\\/10 22:25\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-06T22:25:51+0000\'\u003e06\\/Nov\\/10 22:25\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI wasn\'t coalescing the merged segment\'s deletes, with that implemented, TestStressIndexing2 ran successfully 49 of 50 times.  Below is the error:\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003e[junit] Testsuite: org.apache.lucene.index.TestStressIndexing2\\n    [junit] Testcase: testMultiConfig(org.apache.lucene.index.TestStressIndexing2):\\tFAILED\\n    [junit] expected:&lt;5&gt; but was:&lt;4&gt;\\n    [junit] junit.framework.AssertionFailedError: expected:&lt;5&gt; but was:&lt;4&gt;\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:878)\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:844)\\n    [junit] \\tat org.apache.lucene.index.TestStressIndexing2.verifyEquals(TestStressIndexing2.java:278)\\n    [junit] \\tat org.apache.lucene.index.TestStressIndexing2.verifyEquals(TestStressIndexing2.java:271)\\n    [junit] \\tat org.apache.lucene.index.TestStressIndexing2.testMultiConfig(TestStressIndexing2.java:115)\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12929247_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12929247_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Nov\\/10 22:25\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-06T22:25:51+0000\'\u003e06\\/Nov\\/10 22:25\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I wasn\'t coalescing the merged segment\'s deletes, with that implemented, TestStressIndexing2 ran successfully 49 of 50 times.  Below is the error: \\n\\n  \\n [junit] Testsuite: org.apache.lucene.index.TestStressIndexing2\\n    [junit] Testcase: testMultiConfig(org.apache.lucene.index.TestStressIndexing2):\\tFAILED\\n    [junit] expected:&lt;5&gt; but was:&lt;4&gt;\\n    [junit] junit.framework.AssertionFailedError: expected:&lt;5&gt; but was:&lt;4&gt;\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:878)\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:844)\\n    [junit] \\tat org.apache.lucene.index.TestStressIndexing2.verifyEquals(TestStressIndexing2.java:278)\\n    [junit] \\tat org.apache.lucene.index.TestStressIndexing2.verifyEquals(TestStressIndexing2.java:271)\\n    [junit] \\tat org.apache.lucene.index.TestStressIndexing2.testMultiConfig(TestStressIndexing2.java:115)\\n \\n               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12929254\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12929254&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12929254\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12929254_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12929254_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Nov\\/10 22:37\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-06T22:37:26+0000\'\u003e06\\/Nov\\/10 22:37\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003ePutting a sync on DW block around the bulk of the segment alterations in IW commitMerge seems to have quelled the TestStressIndexing2 test failures.  Nice.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12929254_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12929254_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Nov\\/10 22:37\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-06T22:37:26+0000\'\u003e06\\/Nov\\/10 22:37\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Putting a sync on DW block around the bulk of the segment alterations in IW commitMerge seems to have quelled the TestStressIndexing2 test failures.  Nice.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12929272\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12929272&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12929272\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12929272_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12929272_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Nov\\/10 23:10\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-06T23:10:45+0000\'\u003e06\\/Nov\\/10 23:10\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHere\'s a check point patch before I re-add lastSegmentInfo\\/Index.  All tests pass except for what\'s below.  I\'m guessing segments with all docs deleted, are deleted before the test expects.\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003e[junit] Testcase: testCommitThreadSafety(org.apache.lucene.index.TestIndexWriter):\\tFAILED\\n    [junit] \\n    [junit] junit.framework.AssertionFailedError: \\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:878)\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:844)\\n    [junit] \\tat org.apache.lucene.index.TestIndexWriter.testCommitThreadSafety(TestIndexWriter.java:4699)\\n    [junit] \\n    [junit] \\n    [junit] Testcase: testCommitThreadSafety(org.apache.lucene.index.TestIndexWriter):\\tFAILED\\n    [junit] Some threads threw uncaught exceptions!\\n    [junit] junit.framework.AssertionFailedError: Some threads threw uncaught exceptions!\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:878)\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:844)\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase.tearDown(LuceneTestCase.java:437)\\n    [junit] \\n    [junit] \\n    [junit] Tests run: 116, Failures: 2, Errors: 0, Time elapsed: 159.577 sec\\n    [junit] \\n    [junit] ------------- Standard Output ---------------\\n    [junit] NOTE: reproduce with: ant test -Dtestcase=TestIndexWriter -Dtestmethod=testCommitThreadSafety -Dtests.seed=1826133140332330367:8102643307925777745\\n    [junit] NOTE: test params are: codec=MockFixedIntBlock(blockSize=564), locale=es_CR, timezone=Asia\\/Urumqi\\n    [junit] ------------- ---------------- ---------------\\n    [junit] ------------- Standard Error -----------------\\n    [junit] The following exceptions were thrown by threads:\\n    [junit] *** \u003cspan class=\\\"code-object\\\"\u003eThread\u003c\\/span\u003e: \u003cspan class=\\\"code-object\\\"\u003eThread\u003c\\/span\u003e-1106 ***\\n    [junit] java.lang.RuntimeException: java.lang.AssertionError: term=f:0_8; r=DirectoryReader(_0:c1  _1:c1  _2:c1  _3:c1  _4:c1  _5:c1  _6:c1  _7:c2  _8:c4 ) expected:&lt;1&gt; but was:&lt;0&gt;\\n    [junit] \\tat org.apache.lucene.index.TestIndexWriter$9.run(TestIndexWriter.java:4690)\\n    [junit] Caused by: java.lang.AssertionError: term=f:0_8; r=DirectoryReader(_0:c1  _1:c1  _2:c1  _3:c1  _4:c1  _5:c1  _6:c1  _7:c2  _8:c4 ) expected:&lt;1&gt; but was:&lt;0&gt;\\n    [junit] \\tat org.junit.Assert.fail(Assert.java:91)\\n    [junit] \\tat org.junit.Assert.failNotEquals(Assert.java:645)\\n    [junit] \\tat org.junit.Assert.assertEquals(Assert.java:126)\\n    [junit] \\tat org.junit.Assert.assertEquals(Assert.java:470)\\n    [junit] \\tat org.apache.lucene.index.TestIndexWriter$9.run(TestIndexWriter.java:4684)\\n    [junit] NOTE: all tests run in \u003cspan class=\\\"code-keyword\\\"\u003ethis\u003c\\/span\u003e JVM:\\n    [junit] [TestMockAnalyzer, TestByteSlices, TestFilterIndexReader, TestIndexFileDeleter, TestIndexReaderClone, TestIndexReaderReopen, TestIndexWriter]\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12929272_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12929272_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Nov\\/10 23:10\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-06T23:10:45+0000\'\u003e06\\/Nov\\/10 23:10\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Here\'s a check point patch before I re-add lastSegmentInfo\\/Index.  All tests pass except for what\'s below.  I\'m guessing segments with all docs deleted, are deleted before the test expects. \\n\\n  \\n [junit] Testcase: testCommitThreadSafety(org.apache.lucene.index.TestIndexWriter):\\tFAILED\\n    [junit] \\n    [junit] junit.framework.AssertionFailedError: \\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:878)\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:844)\\n    [junit] \\tat org.apache.lucene.index.TestIndexWriter.testCommitThreadSafety(TestIndexWriter.java:4699)\\n    [junit] \\n    [junit] \\n    [junit] Testcase: testCommitThreadSafety(org.apache.lucene.index.TestIndexWriter):\\tFAILED\\n    [junit] Some threads threw uncaught exceptions!\\n    [junit] junit.framework.AssertionFailedError: Some threads threw uncaught exceptions!\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:878)\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:844)\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase.tearDown(LuceneTestCase.java:437)\\n    [junit] \\n    [junit] \\n    [junit] Tests run: 116, Failures: 2, Errors: 0, Time elapsed: 159.577 sec\\n    [junit] \\n    [junit] ------------- Standard Output ---------------\\n    [junit] NOTE: reproduce with: ant test -Dtestcase=TestIndexWriter -Dtestmethod=testCommitThreadSafety -Dtests.seed=1826133140332330367:8102643307925777745\\n    [junit] NOTE: test params are: codec=MockFixedIntBlock(blockSize=564), locale=es_CR, timezone=Asia\\/Urumqi\\n    [junit] ------------- ---------------- ---------------\\n    [junit] ------------- Standard Error -----------------\\n    [junit] The following exceptions were thrown by threads:\\n    [junit] ***  Thread :  Thread -1106 ***\\n    [junit] java.lang.RuntimeException: java.lang.AssertionError: term=f:0_8; r=DirectoryReader(_0:c1  _1:c1  _2:c1  _3:c1  _4:c1  _5:c1  _6:c1  _7:c2  _8:c4 ) expected:&lt;1&gt; but was:&lt;0&gt;\\n    [junit] \\tat org.apache.lucene.index.TestIndexWriter$9.run(TestIndexWriter.java:4690)\\n    [junit] Caused by: java.lang.AssertionError: term=f:0_8; r=DirectoryReader(_0:c1  _1:c1  _2:c1  _3:c1  _4:c1  _5:c1  _6:c1  _7:c2  _8:c4 ) expected:&lt;1&gt; but was:&lt;0&gt;\\n    [junit] \\tat org.junit.Assert.fail(Assert.java:91)\\n    [junit] \\tat org.junit.Assert.failNotEquals(Assert.java:645)\\n    [junit] \\tat org.junit.Assert.assertEquals(Assert.java:126)\\n    [junit] \\tat org.junit.Assert.assertEquals(Assert.java:470)\\n    [junit] \\tat org.apache.lucene.index.TestIndexWriter$9.run(TestIndexWriter.java:4684)\\n    [junit] NOTE: all tests run in  this  JVM:\\n    [junit] [TestMockAnalyzer, TestByteSlices, TestFilterIndexReader, TestIndexFileDeleter, TestIndexReaderClone, TestIndexReaderReopen, TestIndexWriter]\\n \\n               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12929404\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12929404&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12929404\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12929404_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12929404_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/Nov\\/10 22:34\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-07T22:34:52+0000\'\u003e07\\/Nov\\/10 22:34\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI placed (for now) the segment deletes directly into the segment info object.  There\'s applied term\\/queries sets which are checked against when apply deletes all is called.  All tests pass except for TestTransactions and TestPersistentSnapshotDeletionPolicy only because of an assertion check I added, that the last segment info is in fact in the newly pushed segment infos.  I think in both cases segment infos is being altered in IW in a place where the segment infos isn\'t being pushed, yet.  I wanted to checkpoint this though as it\'s a fairly well working at this point, including the last segment info\\/index, which is can be turned on or off via a static variable.  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12929404_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12929404_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/Nov\\/10 22:34\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-07T22:34:52+0000\'\u003e07\\/Nov\\/10 22:34\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I placed (for now) the segment deletes directly into the segment info object.  There\'s applied term\\/queries sets which are checked against when apply deletes all is called.  All tests pass except for TestTransactions and TestPersistentSnapshotDeletionPolicy only because of an assertion check I added, that the last segment info is in fact in the newly pushed segment infos.  I think in both cases segment infos is being altered in IW in a place where the segment infos isn\'t being pushed, yet.  I wanted to checkpoint this though as it\'s a fairly well working at this point, including the last segment info\\/index, which is can be turned on or off via a static variable.                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12929422\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12929422&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12929422\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12929422_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12929422_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Nov\\/10 01:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-08T01:02:56+0000\'\u003e08\\/Nov\\/10 01:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eEverything passes, except for tests that involve IW rollback.  We need to be able to rollback the last segment info\\/index in DW, however I\'m not sure how we want to do that quite yet.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12929422_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12929422_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Nov\\/10 01:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-08T01:02:56+0000\'\u003e08\\/Nov\\/10 01:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Everything passes, except for tests that involve IW rollback.  We need to be able to rollback the last segment info\\/index in DW, however I\'m not sure how we want to do that quite yet.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12929424\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12929424&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12929424\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12929424_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12929424_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Nov\\/10 01:31\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-08T01:31:08+0000\'\u003e08\\/Nov\\/10 01:31\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eIn DW abort (called by IW rollbackInternal) we should be able to simply clear all per segment pending deletes, however, I\'m not sure we can do that, in fact, if we have applied deletes for a merge, then we rollback, we can\'t undo those deletes thereby breaking our current rollback model?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12929424_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12929424_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Nov\\/10 01:31\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-08T01:31:08+0000\'\u003e08\\/Nov\\/10 01:31\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    In DW abort (called by IW rollbackInternal) we should be able to simply clear all per segment pending deletes, however, I\'m not sure we can do that, in fact, if we have applied deletes for a merge, then we rollback, we can\'t undo those deletes thereby breaking our current rollback model?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12929432\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12929432&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12929432\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12929432_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12929432_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Nov\\/10 01:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-08T01:55:25+0000\'\u003e08\\/Nov\\/10 01:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHere\'s an uncleaned up cut with all tests passing. I nulled out\u003cbr\\/\u003e\\nthe lastSegmentInfo on abort which fixes the my own assertion\u003cbr\\/\u003e\\nthat was causing the rollback tests to not pass. I don\'t know if\u003cbr\\/\u003e\\nthis is cheating or not yet just to get the tests to pass.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12929432_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12929432_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Nov\\/10 01:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-08T01:55:25+0000\'\u003e08\\/Nov\\/10 01:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Here\'s an uncleaned up cut with all tests passing. I nulled out \\nthe lastSegmentInfo on abort which fixes the my own assertion \\nthat was causing the rollback tests to not pass. I don\'t know if \\nthis is cheating or not yet just to get the tests to pass.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12929629\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12929629&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12929629\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12929629_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12929629_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Nov\\/10 16:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-08T16:46:17+0000\'\u003e08\\/Nov\\/10 16:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI\'m running test-core multiple times and am seeing some lurking test\u003cbr\\/\u003e\\nfailures (thanks to the randomized tests that have been recently added).\u003cbr\\/\u003e\\nI\'m guessing they\'re related to the syncs on IW and DW not being in \\\"sync\\\"\u003cbr\\/\u003e\\nsome of the time. \u003c\\/p\u003e\\n\\n\u003cp\u003eI will clean up the patch so that others may properly review it and\u003cbr\\/\u003e\\nhopefully we can figure out what\'s going on. \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12929629_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12929629_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Nov\\/10 16:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-08T16:46:17+0000\'\u003e08\\/Nov\\/10 16:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I\'m running test-core multiple times and am seeing some lurking test \\nfailures (thanks to the randomized tests that have been recently added). \\nI\'m guessing they\'re related to the syncs on IW and DW not being in \\\"sync\\\" \\nsome of the time.  \\n\\n I will clean up the patch so that others may properly review it and \\nhopefully we can figure out what\'s going on.               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12929743\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12929743&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12929743\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12929743_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12929743_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Nov\\/10 21:29\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-08T21:29:50+0000\'\u003e08\\/Nov\\/10 21:29\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHere\'s a cleaned up patch, please take a look.  I ran \'ant test-core\' 5 times with no failures, however running the below several times does eventually produce a failure.\u003c\\/p\u003e\\n\\n\u003cp\u003eant test-core -Dtestcase=TestThreadedOptimize -Dtestmethod=testThreadedOptimize -Dtests.seed=1547315783637080859:5267275843141383546\u003c\\/p\u003e\\n\\n\u003cp\u003eant test-core -Dtestcase=TestIndexWriterMergePolicy -Dtestmethod=testMaxBufferedDocsChange -Dtests.seed=7382971652679988823:-6672235304390823521\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12929743_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12929743_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Nov\\/10 21:29\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-08T21:29:50+0000\'\u003e08\\/Nov\\/10 21:29\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Here\'s a cleaned up patch, please take a look.  I ran \'ant test-core\' 5 times with no failures, however running the below several times does eventually produce a failure. \\n\\n ant test-core -Dtestcase=TestThreadedOptimize -Dtestmethod=testThreadedOptimize -Dtests.seed=1547315783637080859:5267275843141383546 \\n\\n ant test-core -Dtestcase=TestIndexWriterMergePolicy -Dtestmethod=testMaxBufferedDocsChange -Dtests.seed=7382971652679988823:-6672235304390823521              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12929810\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12929810&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12929810\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12929810_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12929810_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Nov\\/10 23:25\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-08T23:25:22+0000\'\u003e08\\/Nov\\/10 23:25\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThe problem could be that IW deleteDocument is not synced on IW,\u003cbr\\/\u003e\\nwhen I tried adding the sync, there was deadlock perhaps from DW\u003cbr\\/\u003e\\nwaitReady. We could be adding pending deletes to segments that\u003cbr\\/\u003e\\nare not quite current because we\'re not adding them in an IW\u003cbr\\/\u003e\\nsync block.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12929810_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12929810_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Nov\\/10 23:25\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-08T23:25:22+0000\'\u003e08\\/Nov\\/10 23:25\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    The problem could be that IW deleteDocument is not synced on IW, \\nwhen I tried adding the sync, there was deadlock perhaps from DW \\nwaitReady. We could be adding pending deletes to segments that \\nare not quite current because we\'re not adding them in an IW \\nsync block.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12929927\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12929927&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12929927\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12929927_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12929927_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Nov\\/10 04:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-09T04:02:05+0000\'\u003e09\\/Nov\\/10 04:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eOk, TestThreadedOptimize works when the DW sync\'ed pushSegmentInfos method\u003cbr\\/\u003e\\nisn\'t called anymore (no extra per-segment deleting is going on), and stops\u003cbr\\/\u003e\\nworking when pushSegmentInfos is turned back on. Something about the sync\u003cbr\\/\u003e\\non DW is causing a problem.  Hmm... We need another way to pass segment\u003cbr\\/\u003e\\ninfos around consistently. \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12929927_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12929927_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Nov\\/10 04:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-09T04:02:05+0000\'\u003e09\\/Nov\\/10 04:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Ok, TestThreadedOptimize works when the DW sync\'ed pushSegmentInfos method \\nisn\'t called anymore (no extra per-segment deleting is going on), and stops \\nworking when pushSegmentInfos is turned back on. Something about the sync \\non DW is causing a problem.  Hmm... We need another way to pass segment \\ninfos around consistently.               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12930658\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12930658&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12930658\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12930658_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12930658_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Nov\\/10 17:23\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-10T17:23:23+0000\'\u003e10\\/Nov\\/10 17:23\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI think I\'ve taken \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2680\\\" title=\\\"Improve how IndexWriter flushes deletes against existing segments\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2680\\\"\u003e\u003cdel\u003eLUCENE-2680\u003c\\/del\u003e\u003c\\/a\u003e as far as I can, though I\'ll\u003cbr\\/\u003e\\nprobably add some more assertions in there for good measure,\u003cbr\\/\u003e\\nsuch as whether or not a delete has in fact been applied etc. It\u003cbr\\/\u003e\\nseems to be working though again I should add more assertions to\u003cbr\\/\u003e\\nthat effect. I think there\'s a niggling sync issue in there as\u003cbr\\/\u003e\\nTestThreadedOptimize only fails when I try to run it 100s of\u003cbr\\/\u003e\\ntimes. I think the sync on DW is causing a wait notify to be\u003cbr\\/\u003e\\nmissed or skipped or something like that, as occasionally the\u003cbr\\/\u003e\\nisOptimized call fails as well. This is likely related to the\u003cbr\\/\u003e\\nappearance of deletes not being applied to segment(s) as\u003cbr\\/\u003e\\nevidenced by the difference in the actual doc count and the\u003cbr\\/\u003e\\nexpected doc count.\u003c\\/p\u003e\\n\\n\u003cp\u003eBelow is the most common assertion failure. Maybe I should\u003cbr\\/\u003e\\nupload my patch that includes a method that iterates 200 times\u003cbr\\/\u003e\\non testThreadedOptimize?\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003e[junit] ------------- ---------------- ---------------\\n    [junit] Testsuite: org.apache.lucene.index.TestThreadedOptimize\\n    [junit] Testcase: testThreadedOptimize(org.apache.lucene.index.TestThreadedOptimize):\\tFAILED\\n    [junit] expected:&lt;248&gt; but was:&lt;266&gt;\\n    [junit] junit.framework.AssertionFailedError: expected:&lt;248&gt; but was:&lt;266&gt;\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:878)\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:844)\\n    [junit] \\tat org.apache.lucene.index.TestThreadedOptimize.runTest(TestThreadedOptimize.java:119)\\n    [junit] \\tat org.apache.lucene.index.TestThreadedOptimize.testThreadedOptimize(TestThreadedOptimize.java:141)\\n    [junit] \\n    [junit] \\n    [junit] Tests run: 1, Failures: 1, Errors: 0, Time elapsed: 1.748 sec\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12930658_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12930658_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Nov\\/10 17:23\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-10T17:23:23+0000\'\u003e10\\/Nov\\/10 17:23\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I think I\'ve taken   LUCENE-2680   as far as I can, though I\'ll \\nprobably add some more assertions in there for good measure, \\nsuch as whether or not a delete has in fact been applied etc. It \\nseems to be working though again I should add more assertions to \\nthat effect. I think there\'s a niggling sync issue in there as \\nTestThreadedOptimize only fails when I try to run it 100s of \\ntimes. I think the sync on DW is causing a wait notify to be \\nmissed or skipped or something like that, as occasionally the \\nisOptimized call fails as well. This is likely related to the \\nappearance of deletes not being applied to segment(s) as \\nevidenced by the difference in the actual doc count and the \\nexpected doc count. \\n\\n Below is the most common assertion failure. Maybe I should \\nupload my patch that includes a method that iterates 200 times \\non testThreadedOptimize? \\n\\n  \\n [junit] ------------- ---------------- ---------------\\n    [junit] Testsuite: org.apache.lucene.index.TestThreadedOptimize\\n    [junit] Testcase: testThreadedOptimize(org.apache.lucene.index.TestThreadedOptimize):\\tFAILED\\n    [junit] expected:&lt;248&gt; but was:&lt;266&gt;\\n    [junit] junit.framework.AssertionFailedError: expected:&lt;248&gt; but was:&lt;266&gt;\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:878)\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:844)\\n    [junit] \\tat org.apache.lucene.index.TestThreadedOptimize.runTest(TestThreadedOptimize.java:119)\\n    [junit] \\tat org.apache.lucene.index.TestThreadedOptimize.testThreadedOptimize(TestThreadedOptimize.java:141)\\n    [junit] \\n    [junit] \\n    [junit] Tests run: 1, Failures: 1, Errors: 0, Time elapsed: 1.748 sec\\n \\n               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12930845\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12930845&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12930845\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12930845_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12930845_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Nov\\/10 23:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-10T23:53:05+0000\'\u003e10\\/Nov\\/10 23:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI think I\'ve isolated this test failure to recording the applied deletes.\u003cbr\\/\u003e\\nBecause we\'re using last segment index\\/info, I was adding deletes that may\u003cbr\\/\u003e\\nor may not have been applied to a particular segment to the last segment\u003cbr\\/\u003e\\ninfo. I\'m not sure what to do in this case as if we record the applied\u003cbr\\/\u003e\\nterms per segment, but keep the pending terms in last segment info, we\'re\u003cbr\\/\u003e\\neffectively not gaining anything from using last segment info because\u003cbr\\/\u003e\\nwe\'re then recording all of the terms per-segment anyways. In fact, this\u003cbr\\/\u003e\\nis how I\'ve isolated that this is the issue, I simply removed the usage of\u003cbr\\/\u003e\\nlast segment info, and instead went to maintaining pending deletes\u003cbr\\/\u003e\\nper-segment. I\'ll give it some thought.\u003c\\/p\u003e\\n\\n\u003cp\u003eIn conclusion, when deletes are recorded per-segment with no last segment\u003cbr\\/\u003e\\ninfo, the test passes after 200 times. \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12930845_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12930845_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Nov\\/10 23:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-10T23:53:05+0000\'\u003e10\\/Nov\\/10 23:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I think I\'ve isolated this test failure to recording the applied deletes. \\nBecause we\'re using last segment index\\/info, I was adding deletes that may \\nor may not have been applied to a particular segment to the last segment \\ninfo. I\'m not sure what to do in this case as if we record the applied \\nterms per segment, but keep the pending terms in last segment info, we\'re \\neffectively not gaining anything from using last segment info because \\nwe\'re then recording all of the terms per-segment anyways. In fact, this \\nis how I\'ve isolated that this is the issue, I simply removed the usage of \\nlast segment info, and instead went to maintaining pending deletes \\nper-segment. I\'ll give it some thought. \\n\\n In conclusion, when deletes are recorded per-segment with no last segment \\ninfo, the test passes after 200 times.               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12930949\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12930949&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12930949\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12930949_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12930949_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Nov\\/10 07:42\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-11T07:42:32+0000\'\u003e11\\/Nov\\/10 07:42\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAlright, we needed to clone the per-segment pending deletes in the\u003cbr\\/\u003e\\n_mergeInit prior to the merge, like cloning the SRs. There were other\u003cbr\\/\u003e\\nterms arriving after they were applied to a merge, then the coalescing of\u003cbr\\/\u003e\\napplied deletes was incorrect. I believe that this was the remaining\u003cbr\\/\u003e\\nlingering issue. The previous failures seem to have gone away, I ran the\u003cbr\\/\u003e\\ntest 400 times. I\'ll upload a new patch shortly.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12930949_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12930949_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Nov\\/10 07:42\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-11T07:42:32+0000\'\u003e11\\/Nov\\/10 07:42\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Alright, we needed to clone the per-segment pending deletes in the \\n_mergeInit prior to the merge, like cloning the SRs. There were other \\nterms arriving after they were applied to a merge, then the coalescing of \\napplied deletes was incorrect. I believe that this was the remaining \\nlingering issue. The previous failures seem to have gone away, I ran the \\ntest 400 times. I\'ll upload a new patch shortly.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12931131\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12931131&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12931131\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12931131_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12931131_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Nov\\/10 18:54\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-11T18:54:00+0000\'\u003e11\\/Nov\\/10 18:54\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI\'m still seeing the error no matter what I do. Sometimes the index is not\u003cbr\\/\u003e\\noptimized, and sometimes there are too many docs. It requires thousands of\u003cbr\\/\u003e\\niterations to provoke either test error. Perhaps it\'s simply related to\u003cbr\\/\u003e\\nmerges that are scheduled but IW close isn\'t waiting on properly.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12931131_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12931131_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Nov\\/10 18:54\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-11T18:54:00+0000\'\u003e11\\/Nov\\/10 18:54\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I\'m still seeing the error no matter what I do. Sometimes the index is not \\noptimized, and sometimes there are too many docs. It requires thousands of \\niterations to provoke either test error. Perhaps it\'s simply related to \\nmerges that are scheduled but IW close isn\'t waiting on properly.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12931133\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12931133&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12931133\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12931133_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12931133_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Nov\\/10 18:58\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-11T18:58:38+0000\'\u003e11\\/Nov\\/10 18:58\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eTestThreadedOptimize is a known intermittent failure &#8211; I\'m trying to track it down!!  (\u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2618\\\" title=\\\"Intermittent failure in TestThreadedOptimize\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2618\\\"\u003e\u003cdel\u003eLUCENE-2618\u003c\\/del\u003e\u003c\\/a\u003e)\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12931133_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12931133_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Nov\\/10 18:58\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-11T18:58:38+0000\'\u003e11\\/Nov\\/10 18:58\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    TestThreadedOptimize is a known intermittent failure &#8211; I\'m trying to track it down!!  (  LUCENE-2618  )              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12931143\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12931143&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12931143\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12931143_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12931143_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Nov\\/10 19:07\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-11T19:07:59+0000\'\u003e11\\/Nov\\/10 19:07\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAh, nice, I should have looked for previous intermittent failures via Jira.  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12931143_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12931143_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Nov\\/10 19:07\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-11T19:07:59+0000\'\u003e11\\/Nov\\/10 19:07\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Ah, nice, I should have looked for previous intermittent failures via Jira.                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12932222\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12932222&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12932222\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12932222_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12932222_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Nov\\/10 22:09\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-15T22:09:05+0000\'\u003e15\\/Nov\\/10 22:09\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eNow that the intermittent failures have been successfully dealt with, ie,\u003cbr\\/\u003e\\n\u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2618\\\" title=\\\"Intermittent failure in TestThreadedOptimize\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2618\\\"\u003e\u003cdel\u003eLUCENE-2618\u003c\\/del\u003e\u003c\\/a\u003e, \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2576\\\" title=\\\"Intermittent failure in TestIndexWriter.testCommitThreadSafety\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2576\\\"\u003e\u003cdel\u003eLUCENE-2576\u003c\\/del\u003e\u003c\\/a\u003e, and \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2118\\\" title=\\\"Intermittent failure in TestIndexWriterMergePolicy.testMaxBufferedDocsChange\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2118\\\"\u003e\u003cdel\u003eLUCENE-2118\u003c\\/del\u003e\u003c\\/a\u003e, I\'ll merge this patch to trunk,\u003cbr\\/\u003e\\nthen it\'s probably time for benchmarking. That\'ll probably include\u003cbr\\/\u003e\\nsomething like indexing, then updating many documents and comparing the\u003cbr\\/\u003e\\nindex time vs. trunk? \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12932222_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12932222_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Nov\\/10 22:09\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-15T22:09:05+0000\'\u003e15\\/Nov\\/10 22:09\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Now that the intermittent failures have been successfully dealt with, ie, \\n  LUCENE-2618  ,   LUCENE-2576  , and   LUCENE-2118  , I\'ll merge this patch to trunk, \\nthen it\'s probably time for benchmarking. That\'ll probably include \\nsomething like indexing, then updating many documents and comparing the \\nindex time vs. trunk?               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12932508\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12932508&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12932508\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12932508_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12932508_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Nov\\/10 15:51\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-16T15:51:27+0000\'\u003e16\\/Nov\\/10 15:51\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eStraight indexing and deleting will probably not show much of an\u003cbr\\/\u003e\\nimprovement from this patch. In trunk, apply deletes (all) is called on\u003cbr\\/\u003e\\nall segments prior to a merge, so we need a synthetic way to measure the\u003cbr\\/\u003e\\nimprovement. One way is to monitor the merge time of small segments (of an\u003cbr\\/\u003e\\nindex with many deletes, and many existing large segments) with this patch\u003cbr\\/\u003e\\nvs. trunk. This\'ll show that this patch in that case is faster (because\u003cbr\\/\u003e\\nwe\'re only applying deletes to the smaller segments). \u003c\\/p\u003e\\n\\n\u003cp\u003eI think I\'ll add a merge start time variable to OneMerge that\'ll be set in\u003cbr\\/\u003e\\nmergeinit. The var could also be useful for the info stream debug log. The\u003cbr\\/\u003e\\nbenchmark will simply print out the merge times (which\'ll be manufactured\u003cbr\\/\u003e\\nsynthetically). \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12932508_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12932508_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Nov\\/10 15:51\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-16T15:51:27+0000\'\u003e16\\/Nov\\/10 15:51\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Straight indexing and deleting will probably not show much of an \\nimprovement from this patch. In trunk, apply deletes (all) is called on \\nall segments prior to a merge, so we need a synthetic way to measure the \\nimprovement. One way is to monitor the merge time of small segments (of an \\nindex with many deletes, and many existing large segments) with this patch \\nvs. trunk. This\'ll show that this patch in that case is faster (because \\nwe\'re only applying deletes to the smaller segments).  \\n\\n I think I\'ll add a merge start time variable to OneMerge that\'ll be set in \\nmergeinit. The var could also be useful for the info stream debug log. The \\nbenchmark will simply print out the merge times (which\'ll be manufactured \\nsynthetically).               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12932915\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12932915&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12932915\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12932915_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12932915_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Nov\\/10 11:47\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-17T11:47:15+0000\'\u003e17\\/Nov\\/10 11:47\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eWhy do we still have deletesFlushed?  And why do we still need to\u003cbr\\/\u003e\\nremap docIDs on merge?  I thought with this new approach the docIDUpto\u003cbr\\/\u003e\\nfor each buffered delete Term\\/Query would be a local docID to that\u003cbr\\/\u003e\\nsegment?\u003c\\/p\u003e\\n\\n\u003cp\u003eOn flush the deletesInRAM should be carried directly over to the\u003cbr\\/\u003e\\nsegmentDeletes, and there shouldn\'t be a deletesFlushed?\u003c\\/p\u003e\\n\\n\u003cp\u003eA few other small things:\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eYou can use SegmentInfos.clone to copy the segment infos? (it\u003cbr\\/\u003e\\n    makes a deep copy)\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eSegmentDeletes.clearAll() need not iterate through the\u003cbr\\/\u003e\\n    terms\\/queries to subtract the RAM used?  Ie just multiply by\u003cbr\\/\u003e\\n    .size() instead and make one call to deduct RAM used?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eThe SegmentDeletes use less than BYTES_PER_DEL_TERM because it\'s a\u003cbr\\/\u003e\\n    simple HashSet not a HashMap?  Ie we are over-counting RAM used\u003cbr\\/\u003e\\n    now?  (Same for by query)\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eCan we store segment\'s deletes elsewhere?  The SegmentInfo should\u003cbr\\/\u003e\\n    be a lightweight class... eg it\'s used by DirectoryReader to read\u003cbr\\/\u003e\\n    the index, and if it\'s read only DirectoryReader there\'s no need\u003cbr\\/\u003e\\n    for it to allocate the SegmentDeletes?  These data structures\u003cbr\\/\u003e\\n    should only be held by IndexWriter\\/DocumentsWriter.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eDo we really need to track appliedTerms\\/appliedQueries?  Ie is\u003cbr\\/\u003e\\n    this just an optimization so that if the caller deletes by the\u003cbr\\/\u003e\\n    Term\\/Query again we know to skip it?  Seems unnecessary if that\'s\u003cbr\\/\u003e\\n    all...\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12932915_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12932915_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Nov\\/10 11:47\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-17T11:47:15+0000\'\u003e17\\/Nov\\/10 11:47\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Why do we still have deletesFlushed?  And why do we still need to \\nremap docIDs on merge?  I thought with this new approach the docIDUpto \\nfor each buffered delete Term\\/Query would be a local docID to that \\nsegment? \\n\\n On flush the deletesInRAM should be carried directly over to the \\nsegmentDeletes, and there shouldn\'t be a deletesFlushed? \\n\\n A few other small things: \\n\\n \\n\\t You can use SegmentInfos.clone to copy the segment infos? (it \\n    makes a deep copy) \\n \\n\\n\\n \\n\\t SegmentDeletes.clearAll() need not iterate through the \\n    terms\\/queries to subtract the RAM used?  Ie just multiply by \\n    .size() instead and make one call to deduct RAM used? \\n \\n\\n\\n \\n\\t The SegmentDeletes use less than BYTES_PER_DEL_TERM because it\'s a \\n    simple HashSet not a HashMap?  Ie we are over-counting RAM used \\n    now?  (Same for by query) \\n \\n\\n\\n \\n\\t Can we store segment\'s deletes elsewhere?  The SegmentInfo should \\n    be a lightweight class... eg it\'s used by DirectoryReader to read \\n    the index, and if it\'s read only DirectoryReader there\'s no need \\n    for it to allocate the SegmentDeletes?  These data structures \\n    should only be held by IndexWriter\\/DocumentsWriter. \\n \\n\\n\\n \\n\\t Do we really need to track appliedTerms\\/appliedQueries?  Ie is \\n    this just an optimization so that if the caller deletes by the \\n    Term\\/Query again we know to skip it?  Seems unnecessary if that\'s \\n    all... \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12932945\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12932945&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12932945\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12932945_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12932945_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Nov\\/10 13:32\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-17T13:32:55+0000\'\u003e17\\/Nov\\/10 13:32\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAlso: why are we tracking the last segment info\\/index?  Ie, this should only be necessary on cutover to DWPT right?  Because effectively today we have only a single \\\"DWPT\\\"?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12932945_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12932945_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Nov\\/10 13:32\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-17T13:32:55+0000\'\u003e17\\/Nov\\/10 13:32\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Also: why are we tracking the last segment info\\/index?  Ie, this should only be necessary on cutover to DWPT right?  Because effectively today we have only a single \\\"DWPT\\\"?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12932988\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12932988&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12932988\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12932988_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12932988_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Nov\\/10 15:39\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-17T15:39:53+0000\'\u003e17\\/Nov\\/10 15:39\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eWhy do we still have deletesFlushed? And why do we still need to\u003cbr\\/\u003e\\nremap docIDs on merge? I thought with this new approach the docIDUpto for\u003cbr\\/\u003e\\neach buffered delete Term\\/Query would be a local docID to that\u003cbr\\/\u003e\\nsegment?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eDeletes flushed can be removed if we store the docid-upto per segment.\u003cbr\\/\u003e\\nThen we\'ll go back to having a hash map of deletes. \u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eThe SegmentDeletes use less than BYTES_PER_DEL_TERM because it\'s a\u003cbr\\/\u003e\\nsimple HashSet not a HashMap? Ie we are over-counting RAM used now? (Same\u003cbr\\/\u003e\\nfor by query)\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eIntuitively, yes, however here\'s the constructor of hash set:\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003e \u003cspan class=\\\"code-keyword\\\"\u003epublic\u003c\\/span\u003e HashSet() { map = \u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e HashMap&lt;E,\u003cspan class=\\\"code-object\\\"\u003eObject\u003c\\/span\u003e&gt;(); } \u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003ewhy are we tracking the last segment info\\/index?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI thought last segment was supposed to be used to mark the last segment of\u003cbr\\/\u003e\\na commit\\/flush. This way we save on the hash(set,map) space on the\u003cbr\\/\u003e\\nsegments upto the last segment when the commit occurred.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eCan we store segment\'s deletes elsewhere?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eWe can, however I had to minimize places in the code that were potentially\u003cbr\\/\u003e\\ncausing errors (trying to reduce the problem set, which helped locate the\u003cbr\\/\u003e\\nintermittent exceptions), syncing segment infos with the per-segment\u003cbr\\/\u003e\\ndeletes was one was one of those places. That and I thought it\'d be worth\u003cbr\\/\u003e\\na try simplify (at the expense of breaking the unstated intention of the\u003cbr\\/\u003e\\nSI class).\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eDo we really need to track appliedTerms\\/appliedQueries? Ie is this\u003cbr\\/\u003e\\njust an optimization so that if the caller deletes by the Term\\/Query again\u003cbr\\/\u003e\\nwe know to skip it? \u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYes to the 2nd question. Why would we want to try deleting multiple times?\u003cbr\\/\u003e\\nThe cost is the terms dictionary lookup which you\'re saying is in the\u003cbr\\/\u003e\\nnoise? I think potentially cracking open a query again could be costly in\u003cbr\\/\u003e\\ncases where the query is indeed expensive.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003enot iterate through the terms\\/queries to subtract the RAM\u003cbr\\/\u003e\\nused?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eWell, the RAM usage tracking can\'t be completely defined until we finish\u003cbr\\/\u003e\\nhow we\'re storing the terms\\/queries. \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12932988_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12932988_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Nov\\/10 15:39\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-17T15:39:53+0000\'\u003e17\\/Nov\\/10 15:39\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     Why do we still have deletesFlushed? And why do we still need to \\nremap docIDs on merge? I thought with this new approach the docIDUpto for \\neach buffered delete Term\\/Query would be a local docID to that \\nsegment?  \\n\\n Deletes flushed can be removed if we store the docid-upto per segment. \\nThen we\'ll go back to having a hash map of deletes.  \\n\\n  The SegmentDeletes use less than BYTES_PER_DEL_TERM because it\'s a \\nsimple HashSet not a HashMap? Ie we are over-counting RAM used now? (Same \\nfor by query)  \\n\\n Intuitively, yes, however here\'s the constructor of hash set: \\n\\n  \\n   public  HashSet() { map =  new  HashMap&lt;E, Object &gt;(); }  \\n  \\n\\n  why are we tracking the last segment info\\/index?  \\n\\n I thought last segment was supposed to be used to mark the last segment of \\na commit\\/flush. This way we save on the hash(set,map) space on the \\nsegments upto the last segment when the commit occurred. \\n\\n  Can we store segment\'s deletes elsewhere?  \\n\\n We can, however I had to minimize places in the code that were potentially \\ncausing errors (trying to reduce the problem set, which helped locate the \\nintermittent exceptions), syncing segment infos with the per-segment \\ndeletes was one was one of those places. That and I thought it\'d be worth \\na try simplify (at the expense of breaking the unstated intention of the \\nSI class). \\n\\n  Do we really need to track appliedTerms\\/appliedQueries? Ie is this \\njust an optimization so that if the caller deletes by the Term\\/Query again \\nwe know to skip it?   \\n\\n Yes to the 2nd question. Why would we want to try deleting multiple times? \\nThe cost is the terms dictionary lookup which you\'re saying is in the \\nnoise? I think potentially cracking open a query again could be costly in \\ncases where the query is indeed expensive. \\n\\n  not iterate through the terms\\/queries to subtract the RAM \\nused?  \\n\\n Well, the RAM usage tracking can\'t be completely defined until we finish \\nhow we\'re storing the terms\\/queries.               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12933067\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12933067&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12933067\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12933067_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12933067_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Nov\\/10 18:25\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-17T18:25:38+0000\'\u003e17\\/Nov\\/10 18:25\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\\n\u003cblockquote\u003e\\n\u003cp\u003eDeletes flushed can be removed if we store the docid-upto per segment.\u003cbr\\/\u003e\\nThen we\'ll go back to having a hash map of deletes.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI think we should do this?\u003c\\/p\u003e\\n\\n\u003cp\u003eIe, each flushed segment stores the map of del Term\\/Query to\u003cbr\\/\u003e\\ndocid-upto, where that docid-upto is private to the segment (no\u003cbr\\/\u003e\\nremapping on merges needed).\u003c\\/p\u003e\\n\\n\u003cp\u003eWhen it\'s time to apply deletes to about-to-be-merged segments, we\u003cbr\\/\u003e\\nmust apply all \\\"future\\\" segments deletions unconditionally to each\u003cbr\\/\u003e\\nsegment, and then conditionally (respecting the local docid-upto)\u003cbr\\/\u003e\\napply that segment\'s deletions.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eIntuitively, yes, however here\'s the constructor of hash set:\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"preformatted panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"preformattedContent panelContent\\\"\u003e\\n\u003cpre\u003epublic HashSet() { map = new HashMap&lt;E,Object&gt;(); }\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eUgh I forgot about that.  Is that still true?  That\'s awful.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cblockquote\u003e\u003cp\u003ewhy are we tracking the last segment info\\/index?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI thought last segment was supposed to be used to mark the last segment of\u003cbr\\/\u003e\\na commit\\/flush. This way we save on the hash(set,map) space on the\u003cbr\\/\u003e\\nsegments upto the last segment when the commit occurred.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eHmm... I think lastSegment was needed only for the multiple DWPT\u003cbr\\/\u003e\\ncase, to record the last segment already flushed in the index as of\u003cbr\\/\u003e\\nwhen that DWPT was created.  This is so we know \\\"going back\\\" when we\u003cbr\\/\u003e\\ncan start unconditionally apply the buffered delete term.\u003c\\/p\u003e\\n\\n\u003cp\u003eWith the single DWPT we effectively have today isn\'t last segment\u003cbr\\/\u003e\\nalways going to be what we just flushed?  (Or null if we haven\'t yet\u003cbr\\/\u003e\\ndone a flush in the current session).\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cblockquote\u003e\u003cp\u003eDo we really need to track appliedTerms\\/appliedQueries? Ie is this just an optimization so that if the caller deletes by the Term\\/Query again we know to skip it?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYes to the 2nd question. Why would we want to try deleting multiple times?\u003cbr\\/\u003e\\nThe cost is the terms dictionary lookup which you\'re saying is in the\u003cbr\\/\u003e\\nnoise? I think potentially cracking open a query again could be costly in\u003cbr\\/\u003e\\ncases where the query is indeed expensive.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI\'m saying this is unlikely to be worthwhile way to spend RAM.\u003c\\/p\u003e\\n\\n\u003cp\u003eEG most apps wouldn\'t delete by same term again, like they\'d\u003cbr\\/\u003e\\n\\\"typically\\\" go and process a big batch of docs, deleting by an id\u003cbr\\/\u003e\\nfield and adding the new version of the doc, where a given id is seen\u003cbr\\/\u003e\\nonly once in this session, and then IW is committed\\/closed?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12933067_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12933067_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Nov\\/10 18:25\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-17T18:25:38+0000\'\u003e17\\/Nov\\/10 18:25\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                   \\n \\n Deletes flushed can be removed if we store the docid-upto per segment. \\nThen we\'ll go back to having a hash map of deletes.  \\n\\n I think we should do this? \\n\\n Ie, each flushed segment stores the map of del Term\\/Query to \\ndocid-upto, where that docid-upto is private to the segment (no \\nremapping on merges needed). \\n\\n When it\'s time to apply deletes to about-to-be-merged segments, we \\nmust apply all \\\"future\\\" segments deletions unconditionally to each \\nsegment, and then conditionally (respecting the local docid-upto) \\napply that segment\'s deletions. \\n\\n \\n Intuitively, yes, however here\'s the constructor of hash set: \\n\\n  \\n public HashSet() { map = new HashMap&lt;E,Object&gt;(); }\\n \\n   \\n\\n Ugh I forgot about that.  Is that still true?  That\'s awful. \\n\\n \\n  why are we tracking the last segment info\\/index?  \\n\\n I thought last segment was supposed to be used to mark the last segment of \\na commit\\/flush. This way we save on the hash(set,map) space on the \\nsegments upto the last segment when the commit occurred.  \\n\\n Hmm... I think lastSegment was needed only for the multiple DWPT \\ncase, to record the last segment already flushed in the index as of \\nwhen that DWPT was created.  This is so we know \\\"going back\\\" when we \\ncan start unconditionally apply the buffered delete term. \\n\\n With the single DWPT we effectively have today isn\'t last segment \\nalways going to be what we just flushed?  (Or null if we haven\'t yet \\ndone a flush in the current session). \\n\\n \\n  Do we really need to track appliedTerms\\/appliedQueries? Ie is this just an optimization so that if the caller deletes by the Term\\/Query again we know to skip it?  \\n\\n Yes to the 2nd question. Why would we want to try deleting multiple times? \\nThe cost is the terms dictionary lookup which you\'re saying is in the \\nnoise? I think potentially cracking open a query again could be costly in \\ncases where the query is indeed expensive.  \\n\\n I\'m saying this is unlikely to be worthwhile way to spend RAM. \\n\\n EG most apps wouldn\'t delete by same term again, like they\'d \\n\\\"typically\\\" go and process a big batch of docs, deleting by an id \\nfield and adding the new version of the doc, where a given id is seen \\nonly once in this session, and then IW is committed\\/closed?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12933082\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12933082&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12933082\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12933082_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12933082_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Nov\\/10 19:01\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-17T19:01:34+0000\'\u003e17\\/Nov\\/10 19:01\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eDWPT deletes has perhaps confused this issue a little bit. \u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eTracking per-segment would be easier but I worry about indices that\u003cbr\\/\u003e\\nhave large numbers of segments... eg w\\/ a large mergeFactor and frequent\u003cbr\\/\u003e\\nflushing you can get very many segments.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI think we may be back tracking here as I had earlier proposed we simply\u003cbr\\/\u003e\\nstore each term\\/query in a map per segment, however I think that was nixed\u003cbr\\/\u003e\\nin favor of last segment + deletes per segment afterwards. We\'re not\u003cbr\\/\u003e\\nworried about the cost of storing pending deletes in a map per segment\u003cbr\\/\u003e\\nanymore?\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eWith the single DWPT we effectively have today isn\'t last segment\u003cbr\\/\u003e\\nalways going to be what we just flushed? (Or null if we haven\'t yet done a\u003cbr\\/\u003e\\nflush in the current session).\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003ePretty much. \u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eEG most apps wouldn\'t delete by same term again, like they\'d\u003cbr\\/\u003e\\n\\\"typically\\\" go and process a big batch of docs, deleting by an id field\u003cbr\\/\u003e\\nand adding the new version of the doc, where a given id is seen only once\u003cbr\\/\u003e\\nin this session, and then IW is committed\\/closed?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eIn an extreme RT app that uses Lucene like a database, it could in fact\u003cbr\\/\u003e\\nupdate a doc many times, then we\'d start accumulating and deleting the\u003cbr\\/\u003e\\nsame ID over and over again. However in the straight batch indexing model\u003cbr\\/\u003e\\noutlined, that is unlikely to happen. \u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eWhen it\'s time to apply deletes to about-to-be-merged segments, we\u003cbr\\/\u003e\\nmust apply all \\\"future\\\" segments deletions unconditionally to each\u003cbr\\/\u003e\\nsegment, and then conditionally (respecting the local docid-upto) apply\u003cbr\\/\u003e\\nthat segment\'s deletions.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI\'ll use this as the go-ahead design then.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eIs that still true?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThat\'s from Java 1.6.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12933082_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12933082_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Nov\\/10 19:01\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-17T19:01:34+0000\'\u003e17\\/Nov\\/10 19:01\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    DWPT deletes has perhaps confused this issue a little bit.  \\n\\n  Tracking per-segment would be easier but I worry about indices that \\nhave large numbers of segments... eg w\\/ a large mergeFactor and frequent \\nflushing you can get very many segments.  \\n\\n I think we may be back tracking here as I had earlier proposed we simply \\nstore each term\\/query in a map per segment, however I think that was nixed \\nin favor of last segment + deletes per segment afterwards. We\'re not \\nworried about the cost of storing pending deletes in a map per segment \\nanymore? \\n\\n  With the single DWPT we effectively have today isn\'t last segment \\nalways going to be what we just flushed? (Or null if we haven\'t yet done a \\nflush in the current session).  \\n\\n Pretty much.  \\n\\n  EG most apps wouldn\'t delete by same term again, like they\'d \\n\\\"typically\\\" go and process a big batch of docs, deleting by an id field \\nand adding the new version of the doc, where a given id is seen only once \\nin this session, and then IW is committed\\/closed?  \\n\\n In an extreme RT app that uses Lucene like a database, it could in fact \\nupdate a doc many times, then we\'d start accumulating and deleting the \\nsame ID over and over again. However in the straight batch indexing model \\noutlined, that is unlikely to happen.  \\n\\n  When it\'s time to apply deletes to about-to-be-merged segments, we \\nmust apply all \\\"future\\\" segments deletions unconditionally to each \\nsegment, and then conditionally (respecting the local docid-upto) apply \\nthat segment\'s deletions.  \\n\\n I\'ll use this as the go-ahead design then. \\n\\n  Is that still true?  \\n\\n That\'s from Java 1.6.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12933182\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12933182&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12933182\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12933182_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12933182_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Nov\\/10 21:54\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-17T21:54:30+0000\'\u003e17\\/Nov\\/10 21:54\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAdditionally we need to decide how accounting\'ll work for\u003cbr\\/\u003e\\nmaxBufferedDeleteTerms. We won\'t have a centralized place to keep track of\u003cbr\\/\u003e\\nthe number of terms, and the unique term count in aggregate over many\u003cbr\\/\u003e\\nsegments could be a little too time consuming calculate in a method like\u003cbr\\/\u003e\\ndoApplyDeletes. An alternative is to maintain a global unique term count,\u003cbr\\/\u003e\\nsuch that when a term is added, every other per-segment deletes is checked\u003cbr\\/\u003e\\nfor that term, and if it\'s not already been tallied, we increment the number\u003cbr\\/\u003e\\nof buffered terms.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12933182_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12933182_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Nov\\/10 21:54\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-17T21:54:30+0000\'\u003e17\\/Nov\\/10 21:54\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Additionally we need to decide how accounting\'ll work for \\nmaxBufferedDeleteTerms. We won\'t have a centralized place to keep track of \\nthe number of terms, and the unique term count in aggregate over many \\nsegments could be a little too time consuming calculate in a method like \\ndoApplyDeletes. An alternative is to maintain a global unique term count, \\nsuch that when a term is added, every other per-segment deletes is checked \\nfor that term, and if it\'s not already been tallied, we increment the number \\nof buffered terms.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12933227\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12933227&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12933227\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12933227_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12933227_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Nov\\/10 23:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-17T23:12:04+0000\'\u003e17\\/Nov\\/10 23:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eI think we may be back tracking here as I had earlier proposed we simply\u003cbr\\/\u003e\\nstore each term\\/query in a map per segment, however I think that was nixed\u003cbr\\/\u003e\\nin favor of last segment + deletes per segment afterwards. We\'re not\u003cbr\\/\u003e\\nworried about the cost of storing pending deletes in a map per segment\u003cbr\\/\u003e\\nanymore?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eOK sorry now I remember.\u003c\\/p\u003e\\n\\n\u003cp\u003eHmm but, my objection then was to carrying all deletes backward to all\u003cbr\\/\u003e\\nsegments?\u003c\\/p\u003e\\n\\n\u003cp\u003eWhereas now I think what we can do is only record the deletions that\u003cbr\\/\u003e\\nwere added when that segment was a RAM buffer, in its pending deletes\u003cbr\\/\u003e\\nmap?  This should be fine, since we aren\'t storing a single deletion\u003cbr\\/\u003e\\nin multiple places (well, until DWPTs anyway).  It\'s just that on\u003cbr\\/\u003e\\napplying deletes to a segment because it\'s about to be merged we have\u003cbr\\/\u003e\\nto do a merge sort of the buffered deletes all \\\"future\\\" segments.\u003c\\/p\u003e\\n\\n\u003cp\u003eBTW it could also be possible to not necessarily apply deletes when a\u003cbr\\/\u003e\\nsegment is merged; eg if there are few enough deletes it may not be\u003cbr\\/\u003e\\nworthwhile.  But we can leave that to another issue.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eAdditionally we need to decide how accounting\'ll work for\u003cbr\\/\u003e\\nmaxBufferedDeleteTerms. We won\'t have a centralized place to keep track of\u003cbr\\/\u003e\\nthe number of terms, and the unique term count in aggregate over many\u003cbr\\/\u003e\\nsegments could be a little too time consuming calculate in a method like\u003cbr\\/\u003e\\ndoApplyDeletes. An alternative is to maintain a global unique term count,\u003cbr\\/\u003e\\nsuch that when a term is added, every other per-segment deletes is checked\u003cbr\\/\u003e\\nfor that term, and if it\'s not already been tallied, we increment the number\u003cbr\\/\u003e\\nof buffered terms.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eMaybe we should change the definition to be total number of pending\u003cbr\\/\u003e\\ndelete term\\/queries?  (Ie, not dedup\'d across segments).  This seems\u003cbr\\/\u003e\\nreasonable since w\\/ this new approach the RAM consumed is in\u003cbr\\/\u003e\\nproportion to that total number and not to dedup\'d count?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12933227_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12933227_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Nov\\/10 23:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-17T23:12:04+0000\'\u003e17\\/Nov\\/10 23:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n I think we may be back tracking here as I had earlier proposed we simply \\nstore each term\\/query in a map per segment, however I think that was nixed \\nin favor of last segment + deletes per segment afterwards. We\'re not \\nworried about the cost of storing pending deletes in a map per segment \\nanymore?  \\n\\n OK sorry now I remember. \\n\\n Hmm but, my objection then was to carrying all deletes backward to all \\nsegments? \\n\\n Whereas now I think what we can do is only record the deletions that \\nwere added when that segment was a RAM buffer, in its pending deletes \\nmap?  This should be fine, since we aren\'t storing a single deletion \\nin multiple places (well, until DWPTs anyway).  It\'s just that on \\napplying deletes to a segment because it\'s about to be merged we have \\nto do a merge sort of the buffered deletes all \\\"future\\\" segments. \\n\\n BTW it could also be possible to not necessarily apply deletes when a \\nsegment is merged; eg if there are few enough deletes it may not be \\nworthwhile.  But we can leave that to another issue. \\n\\n \\n Additionally we need to decide how accounting\'ll work for \\nmaxBufferedDeleteTerms. We won\'t have a centralized place to keep track of \\nthe number of terms, and the unique term count in aggregate over many \\nsegments could be a little too time consuming calculate in a method like \\ndoApplyDeletes. An alternative is to maintain a global unique term count, \\nsuch that when a term is added, every other per-segment deletes is checked \\nfor that term, and if it\'s not already been tallied, we increment the number \\nof buffered terms.  \\n\\n Maybe we should change the definition to be total number of pending \\ndelete term\\/queries?  (Ie, not dedup\'d across segments).  This seems \\nreasonable since w\\/ this new approach the RAM consumed is in \\nproportion to that total number and not to dedup\'d count?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12933299\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12933299&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12933299\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12933299_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12933299_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Nov\\/10 02:45\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-18T02:45:23+0000\'\u003e18\\/Nov\\/10 02:45\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eMaybe we should change the definition to be total number of pending\u003cbr\\/\u003e\\ndelete term\\/queries? \u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eLets go with this, as even though we could record the total unique term\u003cbr\\/\u003e\\ncount, the approach outlined is more conservative.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eI think what we can do is only record the deletions that were added\u003cbr\\/\u003e\\nwhen that segment was a RAM buffer, in its pending deletes map\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eOk, sounds like a design that\'ll work well.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12933299_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12933299_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Nov\\/10 02:45\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-18T02:45:23+0000\'\u003e18\\/Nov\\/10 02:45\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     Maybe we should change the definition to be total number of pending \\ndelete term\\/queries?   \\n\\n Lets go with this, as even though we could record the total unique term \\ncount, the approach outlined is more conservative. \\n\\n  I think what we can do is only record the deletions that were added \\nwhen that segment was a RAM buffer, in its pending deletes map  \\n\\n Ok, sounds like a design that\'ll work well.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12933305\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12933305&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12933305\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12933305_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12933305_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Nov\\/10 03:29\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-18T03:29:04+0000\'\u003e18\\/Nov\\/10 03:29\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eFlush deletes equals true means that all deletes are applied, however when it\'s false, that means we\'re moving the pending deletes into the newly flushed segment, as is, with no docId-upto remapping.  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12933305_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12933305_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Nov\\/10 03:29\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-18T03:29:04+0000\'\u003e18\\/Nov\\/10 03:29\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Flush deletes equals true means that all deletes are applied, however when it\'s false, that means we\'re moving the pending deletes into the newly flushed segment, as is, with no docId-upto remapping.                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12933306\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12933306&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12933306\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12933306_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12933306_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Nov\\/10 03:42\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-18T03:42:21+0000\'\u003e18\\/Nov\\/10 03:42\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eWe can \\\"upgrade\\\" to an int[] from an ArrayList&lt;Integer&gt; for the aborted docs.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12933306_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12933306_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Nov\\/10 03:42\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-18T03:42:21+0000\'\u003e18\\/Nov\\/10 03:42\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    We can \\\"upgrade\\\" to an int[] from an ArrayList&lt;Integer&gt; for the aborted docs.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12934058\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12934058&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12934058\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12934058_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12934058_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Nov\\/10 23:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-19T23:57:34+0000\'\u003e19\\/Nov\\/10 23:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI\'m seeing the following error which is probably triggered by the new per-segment deletes code, however also could be related to the recent CFS format changes?\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003eMockDirectoryWrapper: cannot close: there are still open files: {_0.cfs=1, _1.cfs=1}\\n    [junit] java.lang.RuntimeException: MockDirectoryWrapper: cannot close: there are still open files: {_0.cfs=1, _1.cfs=1}\\n    [junit] \\tat org.apache.lucene.store.MockDirectoryWrapper.close(MockDirectoryWrapper.java:395)\\n    [junit] \\tat org.apache.lucene.index.TestIndexReader.testReopenChangeReadonly(TestIndexReader.java:1717)\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:921)\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:859)\\n    [junit] Caused by: java.lang.RuntimeException: unclosed IndexInput\\n    [junit] \\tat org.apache.lucene.store.MockDirectoryWrapper.openInput(MockDirectoryWrapper.java:350)\\n    [junit] \\tat org.apache.lucene.store.Directory.openInput(Directory.java:138)\\n    [junit] \\tat org.apache.lucene.index.CompoundFileReader.&lt;init&gt;(CompoundFileReader.java:67)\\n    [junit] \\tat org.apache.lucene.index.SegmentReader$CoreReaders.&lt;init&gt;(SegmentReader.java:121)\\n    [junit] \\tat org.apache.lucene.index.SegmentReader.get(SegmentReader.java:527)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter$ReaderPool.get(IndexWriter.java:628)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter$ReaderPool.get(IndexWriter.java:603)\\n    [junit] \\tat org.apache.lucene.index.DocumentsWriter.applyDeletes(DocumentsWriter.java:1081)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.applyDeletesAll(IndexWriter.java:4300)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.doFlushInternal(IndexWriter.java:3440)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.doFlush(IndexWriter.java:3276)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.flush(IndexWriter.java:3266)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.prepareCommit(IndexWriter.java:3131)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.commit(IndexWriter.java:3206)\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12934058_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12934058_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Nov\\/10 23:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-19T23:57:34+0000\'\u003e19\\/Nov\\/10 23:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I\'m seeing the following error which is probably triggered by the new per-segment deletes code, however also could be related to the recent CFS format changes? \\n\\n  \\n MockDirectoryWrapper: cannot close: there are still open files: {_0.cfs=1, _1.cfs=1}\\n    [junit] java.lang.RuntimeException: MockDirectoryWrapper: cannot close: there are still open files: {_0.cfs=1, _1.cfs=1}\\n    [junit] \\tat org.apache.lucene.store.MockDirectoryWrapper.close(MockDirectoryWrapper.java:395)\\n    [junit] \\tat org.apache.lucene.index.TestIndexReader.testReopenChangeReadonly(TestIndexReader.java:1717)\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:921)\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:859)\\n    [junit] Caused by: java.lang.RuntimeException: unclosed IndexInput\\n    [junit] \\tat org.apache.lucene.store.MockDirectoryWrapper.openInput(MockDirectoryWrapper.java:350)\\n    [junit] \\tat org.apache.lucene.store.Directory.openInput(Directory.java:138)\\n    [junit] \\tat org.apache.lucene.index.CompoundFileReader.&lt;init&gt;(CompoundFileReader.java:67)\\n    [junit] \\tat org.apache.lucene.index.SegmentReader$CoreReaders.&lt;init&gt;(SegmentReader.java:121)\\n    [junit] \\tat org.apache.lucene.index.SegmentReader.get(SegmentReader.java:527)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter$ReaderPool.get(IndexWriter.java:628)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter$ReaderPool.get(IndexWriter.java:603)\\n    [junit] \\tat org.apache.lucene.index.DocumentsWriter.applyDeletes(DocumentsWriter.java:1081)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.applyDeletesAll(IndexWriter.java:4300)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.doFlushInternal(IndexWriter.java:3440)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.doFlush(IndexWriter.java:3276)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.flush(IndexWriter.java:3266)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.prepareCommit(IndexWriter.java:3131)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.commit(IndexWriter.java:3206)\\n \\n               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12934372\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12934372&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12934372\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12934372_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12934372_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Nov\\/10 00:19\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-22T00:19:53+0000\'\u003e22\\/Nov\\/10 00:19\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eIn trying to implement the per-segment deletes I encountered this error\u003cbr\\/\u003e\\nfrom TestStressIndexing2. So I started over with a new checkout of trunk,\u003cbr\\/\u003e\\nand started slowly adding in the per-segment code, running\u003cbr\\/\u003e\\nTestStressIndexing2 as each part was added. The attached patch breaks,\u003cbr\\/\u003e\\nthough the deletes are still using the old code. There\'s clearly some kind\u003cbr\\/\u003e\\nof synchronization issue, though nothing esoteric has been added, yikes.\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003e[junit] Testcase: testMultiConfigMany(org.apache.lucene.index.TestStressIndexing2):\\tFAILED\\n    [junit] expected:&lt;20&gt; but was:&lt;19&gt;\\n    [junit] junit.framework.AssertionFailedError: expected:&lt;20&gt; but was:&lt;19&gt;\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12934372_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12934372_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Nov\\/10 00:19\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-22T00:19:53+0000\'\u003e22\\/Nov\\/10 00:19\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    In trying to implement the per-segment deletes I encountered this error \\nfrom TestStressIndexing2. So I started over with a new checkout of trunk, \\nand started slowly adding in the per-segment code, running \\nTestStressIndexing2 as each part was added. The attached patch breaks, \\nthough the deletes are still using the old code. There\'s clearly some kind \\nof synchronization issue, though nothing esoteric has been added, yikes. \\n\\n  \\n [junit] Testcase: testMultiConfigMany(org.apache.lucene.index.TestStressIndexing2):\\tFAILED\\n    [junit] expected:&lt;20&gt; but was:&lt;19&gt;\\n    [junit] junit.framework.AssertionFailedError: expected:&lt;20&gt; but was:&lt;19&gt;\\n \\n               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12934381\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12934381&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12934381\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12934381_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12934381_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Nov\\/10 01:58\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-22T01:58:28+0000\'\u003e22\\/Nov\\/10 01:58\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eRunning TestStressIndexing2 500 times on trunk causes this error which is probably intermittent:\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003e[junit] Testsuite: org.apache.lucene.index.TestStressIndexing2\\n    [junit] Testcase: testMultiConfigMany(org.apache.lucene.index.TestStressIndexing2):\\tCaused an ERROR\\n    [junit] Array index out of range: 0\\n    [junit] java.lang.ArrayIndexOutOfBoundsException: Array index out of range: 0\\n    [junit] \\tat java.util.Vector.get(Vector.java:721)\\n    [junit] \\tat org.apache.lucene.index.DocumentsWriter.applyDeletes(DocumentsWriter.java:1049)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.applyDeletes(IndexWriter.java:4291)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.doFlushInternal(IndexWriter.java:3444)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.doFlush(IndexWriter.java:3279)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.flush(IndexWriter.java:3269)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.closeInternal(IndexWriter.java:1760)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.close(IndexWriter.java:1723)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.close(IndexWriter.java:1687)\\n    [junit] \\tat org.apache.lucene.index.TestStressIndexing2.indexRandom(TestStressIndexing2.java:233)\\n    [junit] \\tat org.apache.lucene.index.TestStressIndexing2.testMultiConfig(TestStressIndexing2.java:123)\\n    [junit] \\tat org.apache.lucene.index.TestStressIndexing2.testMultiConfigMany(TestStressIndexing2.java:97)\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:950)\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:888)\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12934381_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12934381_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Nov\\/10 01:58\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-22T01:58:28+0000\'\u003e22\\/Nov\\/10 01:58\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Running TestStressIndexing2 500 times on trunk causes this error which is probably intermittent: \\n\\n  \\n [junit] Testsuite: org.apache.lucene.index.TestStressIndexing2\\n    [junit] Testcase: testMultiConfigMany(org.apache.lucene.index.TestStressIndexing2):\\tCaused an ERROR\\n    [junit] Array index out of range: 0\\n    [junit] java.lang.ArrayIndexOutOfBoundsException: Array index out of range: 0\\n    [junit] \\tat java.util.Vector.get(Vector.java:721)\\n    [junit] \\tat org.apache.lucene.index.DocumentsWriter.applyDeletes(DocumentsWriter.java:1049)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.applyDeletes(IndexWriter.java:4291)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.doFlushInternal(IndexWriter.java:3444)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.doFlush(IndexWriter.java:3279)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.flush(IndexWriter.java:3269)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.closeInternal(IndexWriter.java:1760)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.close(IndexWriter.java:1723)\\n    [junit] \\tat org.apache.lucene.index.IndexWriter.close(IndexWriter.java:1687)\\n    [junit] \\tat org.apache.lucene.index.TestStressIndexing2.indexRandom(TestStressIndexing2.java:233)\\n    [junit] \\tat org.apache.lucene.index.TestStressIndexing2.testMultiConfig(TestStressIndexing2.java:123)\\n    [junit] \\tat org.apache.lucene.index.TestStressIndexing2.testMultiConfigMany(TestStressIndexing2.java:97)\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:950)\\n    [junit] \\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:888)\\n \\n               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12934384\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12934384&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12934384\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12934384_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12934384_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Nov\\/10 02:10\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-22T02:10:33+0000\'\u003e22\\/Nov\\/10 02:10\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThe above isn\'t on trunk, I misread the screen.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12934384_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12934384_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Nov\\/10 02:10\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-22T02:10:33+0000\'\u003e22\\/Nov\\/10 02:10\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    The above isn\'t on trunk, I misread the screen.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12934388\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12934388&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12934388\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12934388_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12934388_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Nov\\/10 02:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-22T02:50:55+0000\'\u003e22\\/Nov\\/10 02:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI\'ve isolated the mismatch in num docs between the CMS vs. SMS generated\u003cbr\\/\u003e\\nindexes to applying the deletes to the merging segments (whereas currently\u003cbr\\/\u003e\\nwe were\\/are not applying deletes to merging segments and\u003cbr\\/\u003e\\nTestStressIndexing2 passes). Assuming the deletes are being applied\u003cbr\\/\u003e\\ncorrectly to the merging segments, perhaps the logic of gathering up\u003cbr\\/\u003e\\nforward segment deletes is incorrect somehow in the concurrent merge case.\u003cbr\\/\u003e\\nWhen deletes were held in a map per segment, this test was passing. \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12934388_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12934388_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Nov\\/10 02:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-22T02:50:55+0000\'\u003e22\\/Nov\\/10 02:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I\'ve isolated the mismatch in num docs between the CMS vs. SMS generated \\nindexes to applying the deletes to the merging segments (whereas currently \\nwe were\\/are not applying deletes to merging segments and \\nTestStressIndexing2 passes). Assuming the deletes are being applied \\ncorrectly to the merging segments, perhaps the logic of gathering up \\nforward segment deletes is incorrect somehow in the concurrent merge case. \\nWhen deletes were held in a map per segment, this test was passing.               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12934390\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12934390&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12934390\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12934390_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12934390_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Nov\\/10 03:25\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-22T03:25:55+0000\'\u003e22\\/Nov\\/10 03:25\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eA test to see if the problem is the deletes per-segment go forward logic is to iterate over the deletes flushed map using the docid-upto to stay within the boundaries of the segment(s) being merged.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12934390_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12934390_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Nov\\/10 03:25\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-22T03:25:55+0000\'\u003e22\\/Nov\\/10 03:25\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    A test to see if the problem is the deletes per-segment go forward logic is to iterate over the deletes flushed map using the docid-upto to stay within the boundaries of the segment(s) being merged.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12935441\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12935441&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12935441\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12935441_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12935441_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'24\\/Nov\\/10 18:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-24T18:53:20+0000\'\u003e24\\/Nov\\/10 18:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eWhat a nice small patch \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eI think the getDeletesSegmentsForward shouldn\'t be folding in the\u003cbr\\/\u003e\\ndeletesInRAM?  Ie, that newly flushed info will have carried over the\u003cbr\\/\u003e\\nprevious deletes in RAM?\u003c\\/p\u003e\\n\\n\u003cp\u003eI think pushDeletes\\/pushSegmentDeletes should be merged, and we should\u003cbr\\/\u003e\\nnuke DocumentsWriter.deletesFlushed?  Ie, we should push directly from\u003cbr\\/\u003e\\ndeletesInRAM to the new SegmentInfo?  EG you are now pushing all\u003cbr\\/\u003e\\ndeletesFlushed into the new SegmentInfo when actually you should only\u003cbr\\/\u003e\\npush the deletes for that one segment.\u003c\\/p\u003e\\n\\n\u003cp\u003eWe shouldn\'t do the remap deletes anymore.  We can remove\u003cbr\\/\u003e\\nDocumentsWriter.get\\/set\\/updateFlushedDocCount too.\u003c\\/p\u003e\\n\\n\u003cp\u003eHmm... so what are we supposed to do if someone opens IW, does a bunch\u003cbr\\/\u003e\\nof deletes, then commits?  Ie flushDocs is false, so there\'s no new\u003cbr\\/\u003e\\nSegmentInfo.  I think in this case we can stick the deletes against\u003cbr\\/\u003e\\nthe last segment in the index, with the docidUpto set to the maxDoc()\u003cbr\\/\u003e\\nof that segment?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12935441_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12935441_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'24\\/Nov\\/10 18:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-24T18:53:20+0000\'\u003e24\\/Nov\\/10 18:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    What a nice small patch   \\n\\n I think the getDeletesSegmentsForward shouldn\'t be folding in the \\ndeletesInRAM?  Ie, that newly flushed info will have carried over the \\nprevious deletes in RAM? \\n\\n I think pushDeletes\\/pushSegmentDeletes should be merged, and we should \\nnuke DocumentsWriter.deletesFlushed?  Ie, we should push directly from \\ndeletesInRAM to the new SegmentInfo?  EG you are now pushing all \\ndeletesFlushed into the new SegmentInfo when actually you should only \\npush the deletes for that one segment. \\n\\n We shouldn\'t do the remap deletes anymore.  We can remove \\nDocumentsWriter.get\\/set\\/updateFlushedDocCount too. \\n\\n Hmm... so what are we supposed to do if someone opens IW, does a bunch \\nof deletes, then commits?  Ie flushDocs is false, so there\'s no new \\nSegmentInfo.  I think in this case we can stick the deletes against \\nthe last segment in the index, with the docidUpto set to the maxDoc() \\nof that segment?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12964432\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12964432&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12964432\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12964432_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12964432_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'27\\/Nov\\/10 19:44\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-27T19:44:21+0000\'\u003e27\\/Nov\\/10 19:44\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cul\u003e\\n\\t\u003cli\u003eI added pushDeletesLastSegment to doc writer\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eDeletes flushed is gone, only deletesInRAM exists\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eIn the apply merge deletes case, won\'t we want to add deletesInRAM in\u003cbr\\/\u003e\\nthe getForwardDeletes method?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eThe TestStressIndexing2 test still fails so there is still something\u003cbr\\/\u003e\\nincorrect.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eThough for the failing unit test it does not matter, we need to figure\u003cbr\\/\u003e\\nout a solution for the pending doc ids deletions, eg, they can\'t simply\u003cbr\\/\u003e\\ntransferred around, they probably need to be applied as soon as possible.\u003cbr\\/\u003e\\nOtherwise they require remapping. \u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12964432_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12964432_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'27\\/Nov\\/10 19:44\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-27T19:44:21+0000\'\u003e27\\/Nov\\/10 19:44\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n\\t I added pushDeletesLastSegment to doc writer \\n \\n\\n\\n \\n\\t Deletes flushed is gone, only deletesInRAM exists \\n \\n\\n\\n \\n\\t In the apply merge deletes case, won\'t we want to add deletesInRAM in \\nthe getForwardDeletes method? \\n \\n\\n\\n \\n\\t The TestStressIndexing2 test still fails so there is still something \\nincorrect. \\n \\n\\n\\n \\n\\t Though for the failing unit test it does not matter, we need to figure \\nout a solution for the pending doc ids deletions, eg, they can\'t simply \\ntransferred around, they probably need to be applied as soon as possible. \\nOtherwise they require remapping.  \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12964441\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12964441&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12964441\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12964441_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12964441_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'27\\/Nov\\/10 19:54\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-27T19:54:25+0000\'\u003e27\\/Nov\\/10 19:54\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eIn the apply merge deletes case, won\'t we want to add deletesInRAM in the getForwardDeletes method?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eNo, we can\'t add those deletes until the current buffered segment is successfully flushed.\u003c\\/p\u003e\\n\\n\u003cp\u003eEg, say the segment hits a disk full on flush, and DocsWriter aborts (discards all buffered docs\\/deletions from that segment).  If we included these deletesInRAM when applying deletes then suddenly the app will see that some deletes were applied yet the added documents were not.  So on disk full during flush, calls to .updateDocument may wind up deleting the old doc but not adding the new one.\u003c\\/p\u003e\\n\\n\u003cp\u003eSo we need to keep them segregated for proper error case semantics.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eThough for the failing unit test it does not matter, we need to figure\u003cbr\\/\u003e\\nout a solution for the pending doc ids deletions, eg, they can\'t simply\u003cbr\\/\u003e\\ntransferred around, they probably need to be applied as soon as possible.\u003cbr\\/\u003e\\nOtherwise they require remapping.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eHmm why must we remap?  Can\'t we carry these buffered deleteByDocIDs along with the segment?  The docIDs would be the segment\'s docIDs (ie no base added) so no shifting is needed?\u003c\\/p\u003e\\n\\n\u003cp\u003eThese deleted docIDs would only apply to the current segment, ie would not be included in getForwardDeletes?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12964441_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12964441_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'27\\/Nov\\/10 19:54\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-27T19:54:25+0000\'\u003e27\\/Nov\\/10 19:54\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     In the apply merge deletes case, won\'t we want to add deletesInRAM in the getForwardDeletes method?  \\n\\n No, we can\'t add those deletes until the current buffered segment is successfully flushed. \\n\\n Eg, say the segment hits a disk full on flush, and DocsWriter aborts (discards all buffered docs\\/deletions from that segment).  If we included these deletesInRAM when applying deletes then suddenly the app will see that some deletes were applied yet the added documents were not.  So on disk full during flush, calls to .updateDocument may wind up deleting the old doc but not adding the new one. \\n\\n So we need to keep them segregated for proper error case semantics. \\n\\n \\n Though for the failing unit test it does not matter, we need to figure \\nout a solution for the pending doc ids deletions, eg, they can\'t simply \\ntransferred around, they probably need to be applied as soon as possible. \\nOtherwise they require remapping.  \\n\\n Hmm why must we remap?  Can\'t we carry these buffered deleteByDocIDs along with the segment?  The docIDs would be the segment\'s docIDs (ie no base added) so no shifting is needed? \\n\\n These deleted docIDs would only apply to the current segment, ie would not be included in getForwardDeletes?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12964447\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12964447&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12964447\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12964447_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12964447_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'27\\/Nov\\/10 20:08\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-27T20:08:01+0000\'\u003e27\\/Nov\\/10 20:08\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI made the changes listed above, ie, docids and deletesInRAM aren\'t included in getForwardDeletes.  However TestStressIndexing2 still fails, and the numbers are still off significantly which probably indicates it\'s not a synchronization issue.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12964447_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12964447_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'27\\/Nov\\/10 20:08\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-27T20:08:01+0000\'\u003e27\\/Nov\\/10 20:08\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I made the changes listed above, ie, docids and deletesInRAM aren\'t included in getForwardDeletes.  However TestStressIndexing2 still fails, and the numbers are still off significantly which probably indicates it\'s not a synchronization issue.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12964450\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12964450&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12964450\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12964450_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12964450_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'27\\/Nov\\/10 20:33\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-27T20:33:55+0000\'\u003e27\\/Nov\\/10 20:33\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eSo nice to see remapDeletes deleted!\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eDon\'t forget to remove DocumentsWriter.get\\/set\\/updateFlushedDocCount too.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eCan you move the deletes out of SegmentInfo?  We can just use a\u003cbr\\/\u003e\\n    Map&lt;SegmentInfo,BufferedDeletes&gt;?  But remember to delete segments\u003cbr\\/\u003e\\n    from the map once we commit the merge...\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eI think DocsWriter shouldn\'t hold onto the SegmentInfos; we should\u003cbr\\/\u003e\\n    pass it in to only those methods that need it.  That SegmentInfos\u003cbr\\/\u003e\\n    is protected under IW\'s monitor so it makes me nervous if it\'s\u003cbr\\/\u003e\\n    also a member on DW.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eHmm we\'re no longer accounting for RAM usage of per-segment\u003cbr\\/\u003e\\n    deletes?  I think we need an AtomicInt, which we incr w\\/ RAM used\u003cbr\\/\u003e\\n    on pushing deletes into a segment, and decr on clearing?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eThe change to the message(...) in DW.applyDeletes is wrong (ie\u003cbr\\/\u003e\\n    switching to deletesInRAM); I think we should just remove the\u003cbr\\/\u003e\\n    details, ie so it says \\\"applying deletes on N segments\\\"?  But then\u003cbr\\/\u003e\\n    add a more detailed message per-segment with the aggregated\u003cbr\\/\u003e\\n    (forward) deletes details?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eI think we should move this delete handling out of DW as much as\u003cbr\\/\u003e\\n    possible... that\'s really IW\'s role (DW is \\\"about\\\" flushing the\u003cbr\\/\u003e\\n    next segment, not tracking details associated with all other\u003cbr\\/\u003e\\n    segments in the index)\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eInstead of adding pushDeletesLastSegment, can we just have IW call\u003cbr\\/\u003e\\n    pushDeletes(lastSegmentInfo)?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eCalling .getForwardDeletes inside the for loop iterating over the\u003cbr\\/\u003e\\n    infos is actually O(N^2) cost, and it could matter for\u003cbr\\/\u003e\\n    delete-intensive many-segment indices.  Can you change this,\u003cbr\\/\u003e\\n    instead, to walk the infos backwards, incrementally building up\u003cbr\\/\u003e\\n    the forward deletes to apply to each segment by adding in that\u003cbr\\/\u003e\\n    infos deletions?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12964450_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12964450_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'27\\/Nov\\/10 20:33\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-27T20:33:55+0000\'\u003e27\\/Nov\\/10 20:33\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    So nice to see remapDeletes deleted! \\n\\n \\n\\t Don\'t forget to remove DocumentsWriter.get\\/set\\/updateFlushedDocCount too. \\n \\n\\n\\n \\n\\t Can you move the deletes out of SegmentInfo?  We can just use a \\n    Map&lt;SegmentInfo,BufferedDeletes&gt;?  But remember to delete segments \\n    from the map once we commit the merge... \\n \\n\\n\\n \\n\\t I think DocsWriter shouldn\'t hold onto the SegmentInfos; we should \\n    pass it in to only those methods that need it.  That SegmentInfos \\n    is protected under IW\'s monitor so it makes me nervous if it\'s \\n    also a member on DW. \\n \\n\\n\\n \\n\\t Hmm we\'re no longer accounting for RAM usage of per-segment \\n    deletes?  I think we need an AtomicInt, which we incr w\\/ RAM used \\n    on pushing deletes into a segment, and decr on clearing? \\n \\n\\n\\n \\n\\t The change to the message(...) in DW.applyDeletes is wrong (ie \\n    switching to deletesInRAM); I think we should just remove the \\n    details, ie so it says \\\"applying deletes on N segments\\\"?  But then \\n    add a more detailed message per-segment with the aggregated \\n    (forward) deletes details? \\n \\n\\n\\n \\n\\t I think we should move this delete handling out of DW as much as \\n    possible... that\'s really IW\'s role (DW is \\\"about\\\" flushing the \\n    next segment, not tracking details associated with all other \\n    segments in the index) \\n \\n\\n\\n \\n\\t Instead of adding pushDeletesLastSegment, can we just have IW call \\n    pushDeletes(lastSegmentInfo)? \\n \\n\\n\\n \\n\\t Calling .getForwardDeletes inside the for loop iterating over the \\n    infos is actually O(N^2) cost, and it could matter for \\n    delete-intensive many-segment indices.  Can you change this, \\n    instead, to walk the infos backwards, incrementally building up \\n    the forward deletes to apply to each segment by adding in that \\n    infos deletions? \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12964606\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12964606&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12964606\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12964606_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12964606_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Nov\\/10 22:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-28T22:49:22+0000\'\u003e28\\/Nov\\/10 22:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI guess you think the sync on doc writer is the cause of the\u003cbr\\/\u003e\\nTestStressIndexing2 unit test failure?\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eI think we should move this delete handling out of DW\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI agree, I originally took this approach however unit tests were failing\u003cbr\\/\u003e\\nwhen segment infos was passed directly into the apply deletes method(s).\u003cbr\\/\u003e\\nThis\'ll be the 2nd time however apparently the 3rd time\'s the charm.\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'ll make the changes and cross my fingers.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12964606_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12964606_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Nov\\/10 22:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-28T22:49:22+0000\'\u003e28\\/Nov\\/10 22:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I guess you think the sync on doc writer is the cause of the \\nTestStressIndexing2 unit test failure? \\n\\n  I think we should move this delete handling out of DW  \\n\\n I agree, I originally took this approach however unit tests were failing \\nwhen segment infos was passed directly into the apply deletes method(s). \\nThis\'ll be the 2nd time however apparently the 3rd time\'s the charm. \\n\\n I\'ll make the changes and cross my fingers.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12964610\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12964610&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12964610\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12964610_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12964610_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Nov\\/10 00:15\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-29T00:15:26+0000\'\u003e29\\/Nov\\/10 00:15\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI started on taking the approach of moving deletes to a SegmentDeletes class\u003cbr\\/\u003e\\nthat\'s a member of IW. Removing DW\'s addDeleteTerm is\\/was fairly trivial. \u003c\\/p\u003e\\n\\n\u003cp\u003eIn moving deletes out of DW, how should we handle the bufferDeleteTerms sync on\u003cbr\\/\u003e\\nDW and the containing waitReady? The purpose of BDT is to check if RAM\u003cbr\\/\u003e\\nconsumption has reached it\'s peak, and if so, balance out the ram usage and\\/or\u003cbr\\/\u003e\\nflush pending deletes that are ram consuming. This is probably why deletes are\u003cbr\\/\u003e\\nintertwined with DW. We could change DW\'s BDT method though I\'m loathe to\u003cbr\\/\u003e\\nchange the wait logic of DW for fear of causing a ripple effect of inexplicable\u003cbr\\/\u003e\\nunit test failures elsewhere.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12964610_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12964610_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Nov\\/10 00:15\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-29T00:15:26+0000\'\u003e29\\/Nov\\/10 00:15\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I started on taking the approach of moving deletes to a SegmentDeletes class \\nthat\'s a member of IW. Removing DW\'s addDeleteTerm is\\/was fairly trivial.  \\n\\n In moving deletes out of DW, how should we handle the bufferDeleteTerms sync on \\nDW and the containing waitReady? The purpose of BDT is to check if RAM \\nconsumption has reached it\'s peak, and if so, balance out the ram usage and\\/or \\nflush pending deletes that are ram consuming. This is probably why deletes are \\nintertwined with DW. We could change DW\'s BDT method though I\'m loathe to \\nchange the wait logic of DW for fear of causing a ripple effect of inexplicable \\nunit test failures elsewhere.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12964680\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12964680&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12964680\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12964680_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12964680_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Nov\\/10 10:30\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-29T10:30:28+0000\'\u003e29\\/Nov\\/10 10:30\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eI guess you think the sync on doc writer is the cause of the\u003cbr\\/\u003e\\nTestStressIndexing2 unit test failure?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI\'m not sure what\'s causing the failure, but, I think getting the net approach roughly right is the first goal, and then we see what\'s failing.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cblockquote\u003e\u003cp\u003eI think we should move this delete handling out of DW\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI agree, I originally took this approach however unit tests were failing\u003cbr\\/\u003e\\nwhen segment infos was passed directly into the apply deletes method(s).\u003cbr\\/\u003e\\nThis\'ll be the 2nd time however apparently the 3rd time\'s the charm.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eNot only moving the SegmentInfos out of DW as a member, but also move all the applyDeletes logic out.  Ie it should be IW that pulls readers from the pool, walks the merged del term\\/queries\\/per-seg docIDs and actually does the deletion.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eIn moving deletes out of DW, how should we handle the bufferDeleteTerms sync on DW and the containing waitReady?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI think all the bufferDeleteX would move into IW, and timeToFlushDeletes. The RAM accounting can be done fully inside IW.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe waitReady(null) is there so that DW.pauseAllThreads also pauses any threads doing deletions.  But, in moving these methods to IW, we\'d make them sync on IW (they are now sync\'d on DW), which takes care of pausing these threads.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12964680_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12964680_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Nov\\/10 10:30\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-29T10:30:28+0000\'\u003e29\\/Nov\\/10 10:30\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n I guess you think the sync on doc writer is the cause of the \\nTestStressIndexing2 unit test failure?  \\n\\n I\'m not sure what\'s causing the failure, but, I think getting the net approach roughly right is the first goal, and then we see what\'s failing. \\n\\n \\n  I think we should move this delete handling out of DW  \\n\\n I agree, I originally took this approach however unit tests were failing \\nwhen segment infos was passed directly into the apply deletes method(s). \\nThis\'ll be the 2nd time however apparently the 3rd time\'s the charm.  \\n\\n Not only moving the SegmentInfos out of DW as a member, but also move all the applyDeletes logic out.  Ie it should be IW that pulls readers from the pool, walks the merged del term\\/queries\\/per-seg docIDs and actually does the deletion. \\n\\n  In moving deletes out of DW, how should we handle the bufferDeleteTerms sync on DW and the containing waitReady?  \\n\\n I think all the bufferDeleteX would move into IW, and timeToFlushDeletes. The RAM accounting can be done fully inside IW. \\n\\n The waitReady(null) is there so that DW.pauseAllThreads also pauses any threads doing deletions.  But, in moving these methods to IW, we\'d make them sync on IW (they are now sync\'d on DW), which takes care of pausing these threads.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12964938\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12964938&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12964938\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12964938_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12964938_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Nov\\/10 20:58\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-29T20:58:35+0000\'\u003e29\\/Nov\\/10 20:58\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eThe waitReady(null) is there so that DW.pauseAllThreads also pauses any threads doing deletions\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003ewaitReady is used in getThreadState as well as bufferDeleteX, we may need to redundantly add it to SegmentDeletes?  Maybe not.  We\'ll be sync\'ing on IW when adding deletions, that seems like it\'ll be OK.  \u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003ein moving these methods to IW, we\'d make them sync on IW (they are now sync\'d on DW), which takes care of pausing these threads\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eBecause we\'re sync\'ing on IW we don\'t need to pause the indexing threads?  Ok this is because doFlushX is sync\'d on IW.  \u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eThe RAM accounting can be done fully inside IW.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eWell, inside of SegmentDeletes.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12964938_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12964938_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Nov\\/10 20:58\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-29T20:58:35+0000\'\u003e29\\/Nov\\/10 20:58\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     The waitReady(null) is there so that DW.pauseAllThreads also pauses any threads doing deletions  \\n\\n waitReady is used in getThreadState as well as bufferDeleteX, we may need to redundantly add it to SegmentDeletes?  Maybe not.  We\'ll be sync\'ing on IW when adding deletions, that seems like it\'ll be OK.   \\n\\n  in moving these methods to IW, we\'d make them sync on IW (they are now sync\'d on DW), which takes care of pausing these threads  \\n\\n Because we\'re sync\'ing on IW we don\'t need to pause the indexing threads?  Ok this is because doFlushX is sync\'d on IW.   \\n\\n  The RAM accounting can be done fully inside IW.  \\n\\n Well, inside of SegmentDeletes.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12965352\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12965352&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12965352\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12965352_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12965352_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Nov\\/10 19:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-30T19:12:33+0000\'\u003e30\\/Nov\\/10 19:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThis patch separates out most of the deletes storage and processing into a\u003cbr\\/\u003e\\nSegmentDeletes class. The segments are walked backwards to coalesce the pending\u003cbr\\/\u003e\\ndeletions. I think\\/hope this logic is correct. \u003c\\/p\u003e\\n\\n\u003cp\u003eUpdate document is a bit tricky as we cannot sync on IW to insure correctness\u003cbr\\/\u003e\\nof del term addition, nor can we really sync inside of DW without probably\u003cbr\\/\u003e\\ncausing deadlock. When I simply delete the doc after adding it in IW,\u003cbr\\/\u003e\\nTestStressIndexing2 fails miserably with 0 num docs.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12965352_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12965352_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Nov\\/10 19:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-30T19:12:33+0000\'\u003e30\\/Nov\\/10 19:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    This patch separates out most of the deletes storage and processing into a \\nSegmentDeletes class. The segments are walked backwards to coalesce the pending \\ndeletions. I think\\/hope this logic is correct.  \\n\\n Update document is a bit tricky as we cannot sync on IW to insure correctness \\nof del term addition, nor can we really sync inside of DW without probably \\ncausing deadlock. When I simply delete the doc after adding it in IW, \\nTestStressIndexing2 fails miserably with 0 num docs.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12965360\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12965360&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12965360\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12965360_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12965360_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Nov\\/10 19:24\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-30T19:24:19+0000\'\u003e30\\/Nov\\/10 19:24\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eNow we\'re returning the DocumentsWriterThreadState to IW to record the exact doc id as the del term limit.  TestStressIndexing2 fails but far less from the mark, eg, 1 when it does and actually passes some of the time.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12965360_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12965360_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Nov\\/10 19:24\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-30T19:24:19+0000\'\u003e30\\/Nov\\/10 19:24\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Now we\'re returning the DocumentsWriterThreadState to IW to record the exact doc id as the del term limit.  TestStressIndexing2 fails but far less from the mark, eg, 1 when it does and actually passes some of the time.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12965468\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12965468&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12965468\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12965468_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12965468_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Nov\\/10 22:48\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-30T22:48:19+0000\'\u003e30\\/Nov\\/10 22:48\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHere\'s a random guess, I think because with this patch we\'re applying deletes\u003cbr\\/\u003e\\nsometimes multiple times, whereas before we were applying all of them and\u003cbr\\/\u003e\\nclearing them out at once, there\'s a mismatch in terms of over\\/under-applying\u003cbr\\/\u003e\\ndeletes. Oddly when deletes are performed in _mergeInit on all segments vs.\u003cbr\\/\u003e\\nonly on the segments being merged, the former has a much higher success rate.\u003cbr\\/\u003e\\nThis is strange because all deletes will have been applied by the time\u003cbr\\/\u003e\\ncommit\\/getreader is called anyways. \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12965468_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12965468_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Nov\\/10 22:48\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-11-30T22:48:19+0000\'\u003e30\\/Nov\\/10 22:48\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Here\'s a random guess, I think because with this patch we\'re applying deletes \\nsometimes multiple times, whereas before we were applying all of them and \\nclearing them out at once, there\'s a mismatch in terms of over\\/under-applying \\ndeletes. Oddly when deletes are performed in _mergeInit on all segments vs. \\nonly on the segments being merged, the former has a much higher success rate. \\nThis is strange because all deletes will have been applied by the time \\ncommit\\/getreader is called anyways.               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12969448\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12969448&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12969448\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12969448_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12969448_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Dec\\/10 19:44\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-08T19:44:32+0000\'\u003e08\\/Dec\\/10 19:44\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\\n\u003cp\u003eOK I started from the last patch and iterated quite a bit.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe per-segment deletes are now working!  All tests pass.  It turned\u003cbr\\/\u003e\\nout to be a little more hairy than we thought because you also must\u003cbr\\/\u003e\\naccount for deletes that are pushed backwards onto a segment being\u003cbr\\/\u003e\\nmerged (eg due to a flush, or a merge just ahead) while that merge is\u003cbr\\/\u003e\\nstill running.\u003c\\/p\u003e\\n\\n\u003cp\u003eI swapped the two classes &#8211; SegmentDeletes tracks deletes for one\u003cbr\\/\u003e\\nsegment, while BufferedDeletes tracks deletes for all segments.\u003c\\/p\u003e\\n\\n\u003cp\u003eI also wound up doing a fair amount of cleanup\\/refactoring on how\u003cbr\\/\u003e\\nDW\\/IW interact, I think a good step towards DWPT.  EG IW\'s flush is\u003cbr\\/\u003e\\nnow much smaller (could \u003cb\u003ealmost\u003c\\/b\u003e become unsync\'d) since I moved\u003cbr\\/\u003e\\nflushing doc stores, building CFS, etc. down into DW.\u003c\\/p\u003e\\n\\n\u003cp\u003eI added a new FlushControl class to manage (external to DW) triggering\u003cbr\\/\u003e\\nof flushing due to RAM, add doc count, buffered del count.  This way\u003cbr\\/\u003e\\nDWPT can share the single FlushControl instance in IW.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12969448_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12969448_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Dec\\/10 19:44\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-08T19:44:32+0000\'\u003e08\\/Dec\\/10 19:44\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                   \\n OK I started from the last patch and iterated quite a bit. \\n\\n The per-segment deletes are now working!  All tests pass.  It turned \\nout to be a little more hairy than we thought because you also must \\naccount for deletes that are pushed backwards onto a segment being \\nmerged (eg due to a flush, or a merge just ahead) while that merge is \\nstill running. \\n\\n I swapped the two classes &#8211; SegmentDeletes tracks deletes for one \\nsegment, while BufferedDeletes tracks deletes for all segments. \\n\\n I also wound up doing a fair amount of cleanup\\/refactoring on how \\nDW\\/IW interact, I think a good step towards DWPT.  EG IW\'s flush is \\nnow much smaller (could  almost  become unsync\'d) since I moved \\nflushing doc stores, building CFS, etc. down into DW. \\n\\n I added a new FlushControl class to manage (external to DW) triggering \\nof flushing due to RAM, add doc count, buffered del count.  This way \\nDWPT can share the single FlushControl instance in IW.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12969504\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12969504&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12969504\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12969504_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12969504_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Dec\\/10 21:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-08T21:41:53+0000\'\u003e08\\/Dec\\/10 21:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eWhen patching there are errors on IndexWriter.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12969504_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12969504_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Dec\\/10 21:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-08T21:41:53+0000\'\u003e08\\/Dec\\/10 21:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    When patching there are errors on IndexWriter.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12969693\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12969693&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12969693\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12969693_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12969693_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Dec\\/10 10:58\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-09T10:58:42+0000\'\u003e09\\/Dec\\/10 10:58\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eWoops, sorry about that Jason &#8211; I wasn\'t fully updated.  Try this one?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12969693_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12969693_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Dec\\/10 10:58\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-09T10:58:42+0000\'\u003e09\\/Dec\\/10 10:58\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Woops, sorry about that Jason &#8211; I wasn\'t fully updated.  Try this one?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12969754\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12969754&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12969754\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12969754_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12969754_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Dec\\/10 15:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-09T15:02:58+0000\'\u003e09\\/Dec\\/10 15:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eWe\'re close, I think SegmentDeletes is missing?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12969754_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12969754_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Dec\\/10 15:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-09T15:02:58+0000\'\u003e09\\/Dec\\/10 15:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    We\'re close, I think SegmentDeletes is missing?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12969763\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12969763&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12969763\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12969763_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12969763_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Dec\\/10 15:14\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-09T15:14:40+0000\'\u003e09\\/Dec\\/10 15:14\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eUgh, OK new patch.  3rd time\'s a charm?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12969763_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12969763_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Dec\\/10 15:14\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-09T15:14:40+0000\'\u003e09\\/Dec\\/10 15:14\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Ugh, OK new patch.  3rd time\'s a charm?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12969799\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12969799&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12969799\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12969799_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12969799_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Dec\\/10 16:38\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-09T16:38:25+0000\'\u003e09\\/Dec\\/10 16:38\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThe patch applied.\u003c\\/p\u003e\\n\\n\u003cp\u003eOk, a likely cause of the TestStressIndexing2 failures was that when we\'re\u003cbr\\/\u003e\\nflushing deletes to the last segment (because a segment isn\'t being flushed),\u003cbr\\/\u003e\\nwe needed to move deletes also to the newly merged segment?\u003c\\/p\u003e\\n\\n\u003cp\u003eIn the patch we\'ve gone away from sync\'ing on IW when deleting, which was a\u003cbr\\/\u003e\\nchallenge because we needed the sync on DW to properly wait on flushing threads\u003cbr\\/\u003e\\netc.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12969799_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12969799_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Dec\\/10 16:38\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-09T16:38:25+0000\'\u003e09\\/Dec\\/10 16:38\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    The patch applied. \\n\\n Ok, a likely cause of the TestStressIndexing2 failures was that when we\'re \\nflushing deletes to the last segment (because a segment isn\'t being flushed), \\nwe needed to move deletes also to the newly merged segment? \\n\\n In the patch we\'ve gone away from sync\'ing on IW when deleting, which was a \\nchallenge because we needed the sync on DW to properly wait on flushing threads \\netc.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12969822\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12969822&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12969822\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12969822_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12969822_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Dec\\/10 17:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-09T17:20:41+0000\'\u003e09\\/Dec\\/10 17:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAll tests pass.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12969822_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12969822_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Dec\\/10 17:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-09T17:20:41+0000\'\u003e09\\/Dec\\/10 17:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    All tests pass.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12969914\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12969914&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12969914\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12969914_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12969914_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Dec\\/10 20:08\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-09T20:08:00+0000\'\u003e09\\/Dec\\/10 20:08\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eOk, a likely cause of the TestStressIndexing2 failures was that when we\'re\u003cbr\\/\u003e\\nflushing deletes to the last segment (because a segment isn\'t being flushed),\u003cbr\\/\u003e\\nwe needed to move deletes also to the newly merged segment?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eRight, and also the case where a merge just-ahead of you kicks off and dumps its merged deletes onto you.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12969914_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12969914_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Dec\\/10 20:08\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-09T20:08:00+0000\'\u003e09\\/Dec\\/10 20:08\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n Ok, a likely cause of the TestStressIndexing2 failures was that when we\'re \\nflushing deletes to the last segment (because a segment isn\'t being flushed), \\nwe needed to move deletes also to the newly merged segment?  \\n\\n Right, and also the case where a merge just-ahead of you kicks off and dumps its merged deletes onto you.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12970446\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=12970446&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12970446\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12970446_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12970446_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Dec\\/10 11:09\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-11T11:09:42+0000\'\u003e11\\/Dec\\/10 11:09\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eOK I committed this to trunk.\u003c\\/p\u003e\\n\\n\u003cp\u003eSince it\'s a biggish change I\'ll hold off on back-porting to 3.x for now... let\'s let hudson chew on it some first.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12970446_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12970446_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Dec\\/10 11:09\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-11T11:09:42+0000\'\u003e11\\/Dec\\/10 11:09\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    OK I committed this to trunk. \\n\\n Since it\'s a biggish change I\'ll hold off on back-porting to 3.x for now... let\'s let hudson chew on it some first.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13013326\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=13013326&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13013326\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"gsingers\\\" id=\\\"commentauthor_13013326_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=gsingers\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"gsingers\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Grant Ingersoll\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13013326_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Mar\\/11 15:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-03-30T15:49:59+0000\'\u003e30\\/Mar\\/11 15:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eBulk close for 3.1\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"gsingers\\\" id=\\\"commentauthor_13013326_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=gsingers\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"gsingers\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Grant Ingersoll\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13013326_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Mar\\/11 15:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-03-30T15:49:59+0000\'\u003e30\\/Mar\\/11 15:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Bulk close for 3.1              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13138649\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=13138649&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13138649\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"ralekseenkov\\\" id=\\\"commentauthor_13138649_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=ralekseenkov\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"ralekseenkov\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Roman Alekseenkov\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13138649_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Oct\\/11 19:03\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-10-28T19:03:42+0000\'\u003e28\\/Oct\\/11 19:03\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHey, is it something that was ported to 3.x, or not really?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"ralekseenkov\\\" id=\\\"commentauthor_13138649_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=ralekseenkov\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"ralekseenkov\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Roman Alekseenkov\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13138649_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Oct\\/11 19:03\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-10-28T19:03:42+0000\'\u003e28\\/Oct\\/11 19:03\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Hey, is it something that was ported to 3.x, or not really?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13138661\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=13138661&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13138661\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rcmuir\\\" id=\\\"commentauthor_13138661_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rcmuir\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rcmuir\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Robert Muir\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13138661_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Oct\\/11 19:14\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-10-28T19:14:51+0000\'\u003e28\\/Oct\\/11 19:14\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHi, this was backported since lucene 3.1\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rcmuir\\\" id=\\\"commentauthor_13138661_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rcmuir\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rcmuir\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Robert Muir\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13138661_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Oct\\/11 19:14\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-10-28T19:14:51+0000\'\u003e28\\/Oct\\/11 19:14\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Hi, this was backported since lucene 3.1              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13138695\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=13138695&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13138695\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"ralekseenkov\\\" id=\\\"commentauthor_13138695_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=ralekseenkov\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"ralekseenkov\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Roman Alekseenkov\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13138695_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Oct\\/11 19:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-10-28T19:55:22+0000\'\u003e28\\/Oct\\/11 19:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003ethank you, Robert\u003c\\/p\u003e\\n\\n\u003cp\u003eI was asking because we are having issues with 3.4.0 where applyDeletes() takes an large amount of time on commit for 150GB index, and this is stopping all indexing threads. it looks like applyDeletes() is re-scanning an entire index, even though it\'s unnecessary as we are only adding documents to the index but not deleting them\u003c\\/p\u003e\\n\\n\u003cp\u003eif this optimization was backported, then I will probably have to find a solution for my problem elsewhere...\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"ralekseenkov\\\" id=\\\"commentauthor_13138695_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=ralekseenkov\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"ralekseenkov\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Roman Alekseenkov\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13138695_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Oct\\/11 19:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-10-28T19:55:22+0000\'\u003e28\\/Oct\\/11 19:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    thank you, Robert \\n\\n I was asking because we are having issues with 3.4.0 where applyDeletes() takes an large amount of time on commit for 150GB index, and this is stopping all indexing threads. it looks like applyDeletes() is re-scanning an entire index, even though it\'s unnecessary as we are only adding documents to the index but not deleting them \\n\\n if this optimization was backported, then I will probably have to find a solution for my problem elsewhere...              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13138700\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2680?focusedCommentId=13138700&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13138700\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rcmuir\\\" id=\\\"commentauthor_13138700_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rcmuir\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rcmuir\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Robert Muir\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13138700_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Oct\\/11 19:59\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-10-28T19:59:29+0000\'\u003e28\\/Oct\\/11 19:59\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eeven though it\'s unnecessary as we are only adding documents to the index but not deleting them\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eHi Roman, i saw your post.\u003c\\/p\u003e\\n\\n\u003cp\u003eI think by default when you add a document with unique id X, Solr deletes-by-term of X.\u003c\\/p\u003e\\n\\n\u003cp\u003eBut I\'m pretty sure it has an option (sorry i dont know what it is), where you can tell it \u003cbr\\/\u003e\\nthat you are sure that the documents you are adding are new and it won\'t do this.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rcmuir\\\" id=\\\"commentauthor_13138700_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rcmuir\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rcmuir\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Robert Muir\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13138700_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Oct\\/11 19:59\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-10-28T19:59:29+0000\'\u003e28\\/Oct\\/11 19:59\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n even though it\'s unnecessary as we are only adding documents to the index but not deleting them  \\n\\n Hi Roman, i saw your post. \\n\\n I think by default when you add a document with unique id X, Solr deletes-by-term of X. \\n\\n But I\'m pretty sure it has an option (sorry i dont know what it is), where you can tell it  \\nthat you are sure that the documents you are adding are new and it won\'t do this.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\"";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["scope-filter-data"]="{\"createScopeActions\":[],\"scopes\":[]}";
WRM._unparsedData["sidebar-collapsed-by-default"]="true";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:can-manage"]="false";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:with-icons"]="false";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:shortcuts"]="[]";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:project-id"]="12310110";
WRM._unparsedData["sidebar-id"]="\"\u003cdiv class=\\\"aui-sidebar  projects-sidebar sidebar-pending\\\" \u003e\u003cdiv class=\\\"aui-sidebar-wrapper\\\"\u003e\u003cdiv class=\\\"aui-sidebar-body\\\"\u003e\u003cheader class=\\\"aui-page-header\\\"\u003e\u003cdiv class=\\\"aui-page-header-inner\\\"\u003e\u003cdiv class=\\\"aui-page-header-image\\\"\u003e\u003ca href=\\\"\\/jira\\/projects\\/LUCENE\\/summary\\\" title=\\\"Lucene - Core\\\" class=\\\"jira-project-avatar\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-large aui-avatar-project\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"\\/jira\\/secure\\/projectavatar?pid=12310110&amp;avatarId=10061\\\" alt=\\\"Lucene - Core\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e\u003cimg src=\\\"data:image\\/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI\\/Pg0KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDE4LjEuMSwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPg0KPHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCINCgkgdmlld0JveD0iMCAwIDMwMCAzMDAiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDMwMCAzMDA7IiB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxnIGlkPSJMYXllcl8yIj4NCgk8cGF0aCBzdHlsZT0iZmlsbDojRjc5MjMyOyIgZD0iTTE1MCwwQzY2LjY2NywwLDAsNjYuNjY3LDAsMTUwczY2LjY2NywxNTAsMTUwLDE1MHMxNTAtNjYuNjY3LDE1MC0xNTBTMjMzLjMzMywwLDE1MCwweg0KCQkgTTEzNi42NjcsMTc4LjMzM0wxMjUsMTkwbC00MS42NjctNDBMOTUsMTM4LjMzM2wzMC0zMEwxMzYuNjY3LDEyMGwtMzAsMzBMMTM2LjY2NywxNzguMzMzeiBNMjA1LDE2MS42NjdsLTMwLDMwTDE2My4zMzMsMTgwDQoJCWwzMC0zMGwtMzAtMzBMMTc1LDEwOC4zMzNMMjE2LjY2NywxNTBMMjA1LDE2MS42Njd6Ii8+DQo8L2c+DQo8Zz4NCgk8cG9seWdvbiBzdHlsZT0iZmlsbDojRkZGRkZGOyIgcG9pbnRzPSIxNzUsMTkxLjY2NyAyMDUsMTYxLjY2NyAyMTYuNjY3LDE1MCAxNzUsMTA4LjMzMyAxNjMuMzMzLDEyMCAxOTMuMzMzLDE1MCAxNjMuMzMzLDE4MCAJIi8+DQoJPHBvbHlnb24gc3R5bGU9ImZpbGw6I0ZGRkZGRjsiIHBvaW50cz0iMTI1LDEwOC4zMzMgOTUsMTM4LjMzMyA4My4zMzMsMTUwIDEyNSwxOTAgMTM2LjY2NywxNzguMzMzIDEwNi42NjcsMTUwIDEzNi42NjcsMTIwIAkiLz4NCjwvZz4NCjwvc3ZnPg0K\\\" alt=\\\"Icon indicating the project type\\\" class=\\\"jira-project-avatar-icon\\\" \\/\u003e\u003c\\/a\u003e\u003c\\/div\u003e\u003c!-- .aui-page-header-image --\u003e\u003cdiv class=\\\"aui-page-header-main\\\"\u003e\u003ch1\u003e\u003cdiv class=\\\"aui-group aui-group-split\\\"\u003e\u003cdiv class=\\\"aui-item project-title\\\"\u003e\u003ca href=\\\"\\/jira\\/projects\\/LUCENE\\/summary\\\" title=\\\"Lucene - Core\\\"\u003eLucene - Core\u003c\\/a\u003e\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/h1\u003e\u003c\\/div\u003e\u003c!-- .aui-page-header-main --\u003e\u003c\\/div\u003e\u003c!-- .aui-page-header-inner --\u003e\u003c\\/header\u003e\u003c!-- .aui-page-header --\u003e\u003cnav class=\\\"aui-navgroup aui-navgroup-vertical\\\"\u003e\u003cdiv class=\\\"aui-navgroup-inner sidebar-content-container\\\"\u003e\u003cdiv class=\\\"aui-sidebar-group aui-sidebar-group-tier-one\\\" data-id=\\\"sidebar-navigation-panel\\\"\u003e\u003cul class=\\\"aui-nav\\\"\u003e\u003cli class=\\\"aui-nav-selected\\\" \u003e\u003ca class=\\\"aui-nav-item \\\" href=\\\"\\/jira\\/projects\\/LUCENE\\/issues\\\" data-link-id=\\\"com.atlassian.jira.jira-projects-issue-navigator:sidebar-issue-navigator\\\" \u003e\u003cspan class=\\\"aui-icon aui-icon-large icon-sidebar-issues\\\"\u003e\u003c\\/span\u003e\u003cspan class=\\\"aui-nav-item-label\\\" title=\\\"Issues\\\"\u003eIssues\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/li\u003e\u003cli  \u003e\u003ca class=\\\"aui-nav-item \\\" href=\\\"\\/jira\\/projects\\/LUCENE?selectedItem=com.atlassian.jira.jira-projects-plugin:report-page\\\" data-link-id=\\\"com.atlassian.jira.jira-projects-plugin:report-page\\\" \u003e\u003cspan class=\\\"aui-icon aui-icon-large agile-icon-report\\\"\u003e\u003c\\/span\u003e\u003cspan class=\\\"aui-nav-item-label\\\" title=\\\"Reports\\\"\u003eReports\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/li\u003e\u003cli  \u003e\u003ca class=\\\"aui-nav-item \\\" href=\\\"\\/jira\\/projects\\/LUCENE?selectedItem=com.atlassian.jira.jira-projects-plugin:components-page\\\" data-link-id=\\\"com.atlassian.jira.jira-projects-plugin:components-page\\\" \u003e\u003cspan class=\\\"aui-icon aui-icon-large icon-sidebar-components\\\"\u003e\u003c\\/span\u003e\u003cspan class=\\\"aui-nav-item-label\\\" title=\\\"Components\\\"\u003eComponents\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/li\u003e\u003c\\/ul\u003e\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/nav\u003e\u003c\\/div\u003e\u003cdiv class=\\\"aui-sidebar-footer\\\"\u003e\u003ca class=\\\"aui-button aui-button-subtle aui-sidebar-toggle aui-sidebar-footer-tipsy\\\" data-tooltip=\\\"Expand sidebar ( [ )\\\" href=\\\"#\\\"\u003e\u003cspan class=\\\"aui-icon aui-icon-small\\\"\u003e\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/div\u003e\"";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:bigpipe-init/jira.webresources:bigpipe-init.js" data-wrm-key="jira.webresources:bigpipe-init" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <form id="jira_request_timing_info" class="dont-default-focus"> 
   <fieldset class="parameters hidden"> 
    <input type="hidden" title="jira.request.start.millis" value="1516203186943"> 
    <input type="hidden" title="jira.request.server.time" value="621"> 
    <input type="hidden" title="jira.request.id" value="933x7706920x9"> 
    <input type="hidden" title="jira.session.expiry.time" value="-"> 
    <input type="hidden" title="jira.session.expiry.in.mins" value="-"> 
    <input id="jiraConcurrentRequests" type="hidden" name="jira.request.concurrent.requests" value="11"> 
    <input type="hidden" title="db.reads.time.in.ms" value="42"> 
    <input type="hidden" title="db.conns.time.in.ms" value="49"> 
   </fieldset> 
  </form> 
  <!--
	                 REQUEST ID : 933x7706920x9
	          REQUEST TIMESTAMP : [17/Jan/2018:15:33:06 +0000]
	               REQUEST TIME : 0.6210
	                 ASESSIONID : -
	        CONCURRENT REQUESTS : 11

	                      db.reads : OpSnapshot{name='db.reads', invocationCount=24, elapsedTotal=42557355, elapsedMin=535601, elapsedMax=12838515, resultSetSize=0, cpuTotal=0, cpuMin=0, cpuMax=0}
	                      db.conns : OpSnapshot{name='db.conns', invocationCount=28, elapsedTotal=49714282, elapsedMin=571078, elapsedMax=12914109, resultSetSize=0, cpuTotal=0, cpuMin=0, cpuMax=0}
-->   
 </body>
</html>