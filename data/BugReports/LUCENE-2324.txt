<!doctype html>
<html lang="en">
 <head> 
  <meta charset="utf-8"> 
  <meta http-equiv="X-UA-Compatible" content="IE=Edge"> 
  <meta name="application-name" content="JIRA" data-name="jira" data-version="7.6.3">
  <meta name="ajs-viewissue-use-history-api" content="false"> 
  <meta name="ajs-jira-base-url" content="https://issues.apache.org/jira"> 
  <meta name="ajs-serverRenderedViewIssue" content="true"> 
  <meta name="ajs-dev-mode" content="false"> 
  <meta name="ajs-context-path" content="/jira"> 
  <meta name="ajs-version-number" content="7.6.3"> 
  <meta name="ajs-build-number" content="76005"> 
  <meta name="ajs-is-beta" content="false"> 
  <meta name="ajs-is-rc" content="false"> 
  <meta name="ajs-is-snapshot" content="false"> 
  <meta name="ajs-is-milestone" content="false"> 
  <meta name="ajs-remote-user" content=""> 
  <meta name="ajs-remote-user-fullname" content=""> 
  <meta name="ajs-user-locale" content="en_UK"> 
  <meta name="ajs-user-locale-group-separator" content=","> 
  <meta name="ajs-app-title" content="ASF JIRA"> 
  <meta name="ajs-keyboard-shortcuts-enabled" content="true"> 
  <meta name="ajs-keyboard-accesskey-modifier" content="Ctrl+Alt"> 
  <meta name="ajs-enabled-dark-features" content="[&quot;com.atlassian.jira.agile.darkfeature.editable.detailsview&quot;,&quot;nps.survey.inline.dialog&quot;,&quot;com.atlassian.jira.agile.darkfeature.edit.closed.sprint.enabled&quot;,&quot;jira.plugin.devstatus.phasetwo&quot;,&quot;jira.frother.reporter.field&quot;,&quot;atlassian.rest.xsrf.legacy.enabled&quot;,&quot;jira.issue.status.lozenge&quot;,&quot;com.atlassian.jira.config.BIG_PIPE&quot;,&quot;com.atlassian.jira.projects.issuenavigator&quot;,&quot;com.atlassian.jira.config.PDL&quot;,&quot;jira.plugin.devstatus.phasetwo.enabled&quot;,&quot;atlassian.aui.raphael.disabled&quot;,&quot;app-switcher.new&quot;,&quot;frother.assignee.field&quot;,&quot;com.atlassian.jira.projects.ProjectCentricNavigation.Switch&quot;,&quot;sd.internal.base.off.thread.on.completion.events.enabled&quot;,&quot;jira.onboarding.cyoa&quot;,&quot;com.atlassian.jira.agile.darkfeature.kanplan.enabled&quot;,&quot;sd.slavalue.record.updated.date.enabled&quot;,&quot;com.atlassian.jira.config.ProjectConfig.MENU&quot;,&quot;com.atlassian.jira.projects.sidebar.DEFER_RESOURCES&quot;,&quot;com.atlassian.jira.agile.darkfeature.kanplan.epics.and.versions.enabled&quot;,&quot;com.atlassian.jira.agile.darkfeature.sprint.goal.enabled&quot;,&quot;jira.zdu.admin-updates-ui&quot;,&quot;jira.zdu.jmx-monitoring&quot;,&quot;sd.sla.improved.rendering.enabled&quot;,&quot;sd.canned.responses.enabled&quot;,&quot;sd.new.settings.sidebar.location.disabled&quot;,&quot;jira.zdu.cluster-upgrade-state&quot;,&quot;com.atlassian.jira.agile.darkfeature.splitissue&quot;,&quot;com.atlassian.jira.config.CoreFeatures.LICENSE_ROLES_ENABLED&quot;,&quot;com.atlassian.feedback.feedback-button-move-to-header-enable&quot;,&quot;jira.export.csv.enabled&quot;]"> 
  <meta name="ajs-in-admin-mode" content="false"> 
  <meta name="ajs-is-sysadmin" content="false"> 
  <meta name="ajs-is-admin" content="false"> 
  <meta name="ajs-outgoing-mail-enabled" content="true"> 
  <meta name="ajs-date-relativize" content="true"> 
  <meta name="ajs-date-time" content="HH:mm"> 
  <meta name="ajs-date-day" content="EEEE HH:mm"> 
  <meta name="ajs-date-dmy" content="dd/MMM/yy"> 
  <meta name="ajs-date-complete" content="dd/MMM/yy HH:mm"> 
  <script type="text/javascript">var AJS=AJS||{};AJS.debug=true;</script> 
  <meta id="atlassian-token" name="atlassian-token" content="A5KQ-2QAV-T4JA-FDED|dfd541d27ca66d5a0945d4e6663a3e56f1186592|lout"> 
  <link rel="shortcut icon" href="/jira/s/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/_/favicon.ico"> 
  <!--[if IE]><![endif]--> 
  <script type="text/javascript">
    (function() {
        var contextPath = '/jira';
        var eventBuffer = [];

        function printDeprecatedMsg() {
            if (console && console.warn) {
                console.warn('DEPRECATED JS - contextPath global variable has been deprecated since 7.4.0. Use `wrm/context-path` module instead.');
            }
        }

        function sendEvent(analytics, postfix) {
            analytics.send({
                name: 'js.globals.contextPath.' + postfix
            });
        }

        function sendDeprecatedEvent(postfix) {
            try {
                var analytics = require('jira/analytics');
                if (eventBuffer.length) {
                    eventBuffer.forEach(function(value) {
                        sendEvent(analytics, value);
                    });
                    eventBuffer = [];
                }

                if (postfix) {
                    sendEvent(analytics, postfix);
                }
            } catch(ex) {
                eventBuffer.push(postfix);
                setTimeout(sendDeprecatedEvent, 1000);
            }
        }

        Object.defineProperty(window, 'contextPath', {
            get: function() {
                printDeprecatedMsg();
                sendDeprecatedEvent('get');
                return contextPath;
            },
            set: function(value) {
                printDeprecatedMsg();
                sendDeprecatedEvent('set');
                contextPath = value;
            }
        });
    })();

</script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-plugin:context-path.context-path"]="\"/jira\"";
WRM._unparsedData["jira.webresources:feature-flags.feature-flag-data"]="{\"enabled-feature-keys\":[\"com.atlassian.jira.agile.darkfeature.editable.detailsview\",\"nps.survey.inline.dialog\",\"com.atlassian.jira.agile.darkfeature.edit.closed.sprint.enabled\",\"jira.plugin.devstatus.phasetwo\",\"jira.frother.reporter.field\",\"atlassian.rest.xsrf.legacy.enabled\",\"jira.issue.status.lozenge\",\"com.atlassian.jira.config.BIG_PIPE\",\"com.atlassian.jira.projects.issuenavigator\",\"com.atlassian.jira.config.PDL\",\"jira.plugin.devstatus.phasetwo.enabled\",\"atlassian.aui.raphael.disabled\",\"app-switcher.new\",\"frother.assignee.field\",\"com.atlassian.jira.projects.ProjectCentricNavigation.Switch\",\"sd.internal.base.off.thread.on.completion.events.enabled\",\"jira.onboarding.cyoa\",\"com.atlassian.jira.agile.darkfeature.kanplan.enabled\",\"sd.slavalue.record.updated.date.enabled\",\"com.atlassian.jira.config.ProjectConfig.MENU\",\"com.atlassian.jira.projects.sidebar.DEFER_RESOURCES\",\"com.atlassian.jira.agile.darkfeature.kanplan.epics.and.versions.enabled\",\"com.atlassian.jira.agile.darkfeature.sprint.goal.enabled\",\"jira.zdu.admin-updates-ui\",\"jira.zdu.jmx-monitoring\",\"sd.sla.improved.rendering.enabled\",\"sd.canned.responses.enabled\",\"sd.new.settings.sidebar.location.disabled\",\"jira.zdu.cluster-upgrade-state\",\"com.atlassian.jira.agile.darkfeature.splitissue\",\"com.atlassian.jira.config.CoreFeatures.LICENSE_ROLES_ENABLED\",\"com.atlassian.feedback.feedback-button-move-to-header-enable\",\"jira.export.csv.enabled\"],\"feature-flag-states\":{\"sd.customer.profile.multi.languages\":true,\"sd.customer.portal.transitions\":true,\"sd.customer.portal.transitions.config\":true,\"sd.custom.email.stripping.rules\":false,\"sd.sla.lucene.issue.id.callback.performance\":true,\"sd.new.settings.sidebar.location\":true,\"sd.workload.report.paginator\":true,\"sd.experimental.portal.search.algorithm.default.1\":false,\"sd.customer.portal.help.center.agent.announcement\":true,\"sd.sla.improved.rendering\":false,\"sd.experimental.portal.search.algorithm.default.2\":false,\"sd.customer.feedback.validate.reporter.on.token\":true,\"sd.custom.email.notifications.utf8.csat.star\":true,\"sd.who.create.customers.by.email.setting\":true,\"com.atlassian.jira.issuetable.move.links.hidden\":true,\"jira.renderer.consider.variable.format\":true,\"sd.stats.event.tracking\":true,\"sd.password.helper.dialog\":true,\"sd.canned.responses\":false,\"sd.portal.help.center.customer.signup.secondary.email\":true,\"sd.custom.email.notifications.manage.language\":true,\"sd.use.search.by.permissions\":true,\"sd.slavalue.record.updated.date\":false,\"sd.report.custom.date.range\":false,\"sd.kb.article.helpfulness.report\":false,\"com.atlassian.jira.agile.darkfeature.sprint.goal\":false,\"sd.custom.email.notifications.styling\":true,\"sd.workinghours.new.page.bulldog.1\":false,\"sd.customer.portal.two.step.login\":false,\"sd.automation.psmq.async.executor\":true,\"sd.customer.org.list.page.lazy.search\":true,\"sd.approval.requested.when.handler\":true,\"sd.request.type.field.rest.api.filtering.bugfix\":true,\"sd.automation.then.action.auto.answer.approval\":true,\"com.atlassian.jira.agile.darkfeature.kanplan.epics.and.versions\":false,\"sla.will.only.be.paused.if.they.are.already.started\":true,\"sd.kb.comment.share.stats.collection\":true,\"com.atlassian.jira.upgrade.startup.fix.index\":true,\"sd.customer.orgs.group.participants\":true,\"sd.portal.help.center.customer.signup\":true,\"sd.sla.agent.jql.security.restricted\":true,\"sd.test.feature.flag.x\":true,\"sd.test.feature.flag.y\":false,\"sd.cluster.safe.mail.channel.shutdown\":true,\"sd.email.channel.folders\":false,\"sd.email.analytics.open\":false,\"sd.kb.project.creation.create.link.space\":true,\"sd.workinghours.new.page\":false,\"sd.confluence.anonymous.permission.fix\":true,\"com.atlassian.jira.issuetable.draggable\":true,\"sd.customer.portal.project.agent.announcement\":true,\"sd.automation.audit.log\":true,\"jira.jql.suggestrecentfields\":false,\"sd.canned.responses.check.index.startup\":false,\"sd.new.project.templates\":true,\"sd.custom.email.notifications.custom.rules.simple.ui\":false,\"sd.custom.email.notifications.cut.over\":true,\"sd.dismiss.all.misconfiguration.warnings.setting\":true,\"com.atlassian.jira.agile.darkfeature.optimistic.transitions\":true,\"sd.sla.configurations.export\":true,\"sd.canned.responses.variable.substitution\":true,\"com.atlassian.jira.agile.darkfeature.kanplan\":false,\"sd.internal.base.off.thread.on.completion.events\":false,\"sd.customer.portal.prioties.per.project.fix\":true,\"jira.instrumentation.laas\":false,\"sd.kb.self.service.report\":false,\"sla.improved.request.handling\":true,\"sd.no.schedule.async.upgrade.tasks\":true,\"sd.kb.primary.nav\":true,\"com.atlassian.jira.agile.darkfeature.edit.closed.sprint\":false,\"sd.kb.issueview.panel.phase2\":true,\"sd.email.outsider.comments\":true,\"jira.create.linked.issue\":true,\"sd.kb.issueview.panel\":true,\"jira.sal.host.connect.accessor.existing.transaction.will.create.transactions\":true,\"sd.approvals.light.weight\":false,\"sd.automation.then.webhook\":true,\"sd.respect.inline.edit.issue.off\":true,\"jira.jql.smartautoselectfirst\":false,\"sd.global.portal.search.atlassian.only.tracking\":false,\"sd.automation.if.condition.comment.primary.action\":true,\"jira.priorities.per.project\":true,\"sd.inline.noformat.renderer\":true,\"sd.customer.request.type.create.edit.screens\":true}}";
WRM._unparsedData["jira.webresources:default-comment-security-level.DefaultCommentSecurityLevelHelpLink"]="{\"extraClasses\":\"default-comment-level-help\",\"title\":\"Commenting on an Issue\",\"url\":\"https://docs.atlassian.com/jira/jcore-docs-076/Editing+and+collaborating+on+issues#Editingandcollaboratingonissues-restrictacomment\",\"isLocal\":false}";
WRM._unparsedData["jira.webresources:dateFormatProvider.allFormats"]="{\"dateFormats\":{\"meridiem\":[\"AM\",\"PM\"],\"eras\":[\"BC\",\"AD\"],\"months\":[\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],\"monthsShort\":[\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"],\"weekdaysShort\":[\"Sun\",\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\",\"Sat\"],\"weekdays\":[\"Sunday\",\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\",\"Saturday\"]},\"lookAndFeelFormats\":{\"relativize\":\"true\",\"time\":\"HH:mm\",\"day\":\"EEEE HH:mm\",\"dmy\":\"dd/MMM/yy\",\"complete\":\"dd/MMM/yy HH:mm\"}}";
WRM._unparsedData["com.atlassian.jira.jira-issue-nav-components:issueviewer.features"]="{\"rteEnabled\":true}";
WRM._unparsedData["com.atlassian.jira.plugins.jira-dnd-attachment-plugin:dnd-issue-drop-zone.thumbnail-mime-types"]="\"image/png,image/vnd.wap.wbmp,image/x-png,image/jpeg,image/bmp,image/gif\"";
WRM._unparsedData["com.atlassian.jira.plugins.jira-dnd-attachment-plugin:dnd-issue-drop-zone.upload-limit"]="\"62914560\"";
WRM._unparsedData["com.atlassian.plugins.helptips.jira-help-tips:help-tip-manager.JiraHelpTipData"]="{\"anonymous\":true}";
WRM._unparsedData["com.atlassian.jira.jira-view-issue-plugin:controller-subtasks.controller.subtasks.parameters"]="{\"url\":\"/rest/api/2/issue/{issueId}/subtask/move\"}";
WRM._unparsedData["com.atlassian.analytics.analytics-client:policy-update-init.policy-update-data-provider"]="false";
WRM._unparsedData["com.atlassian.analytics.analytics-client:programmatic-analytics-init.programmatic-analytics-data-provider"]="false";
WRM._unparsedData["com.atlassian.servicedesk.servicedesk-canned-responses-plugin:canned-responses-data-provider.data"]="{\"substitutionVariables\":{\"issue.summary\":\"Issue summary\",\"issue.description\":\"Issue description\",\"issue.key\":\"Issue key\",\"issue.reporter.name\":\"Issue reporter\",\"issue.resolution\":\"Issue resolution\",\"request.url\":\"Request URL\",\"request.status\":\"Request status\"}}";
WRM._unparsedData["jira.webresources:avatar-picker.data"]="{}";
WRM._unparsedData["com.atlassian.feedback.jira-feedback-plugin:button-resources-init.data"]="{\"jira.feedback.plugin.issue.collector.core\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-UK&collectorId=abbf546d\",\"jira.feedback.plugin.issue.collector.default\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-UK&collectorId=abbf546d\",\"jira.feedback.plugin.issue.collector.service.desk\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?locale=en-UK&collectorId=a698db21\",\"jira.feedback.plugin.issue.collector.software\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-UK&collectorId=abbf546d\",\"isHeaderFeedbackButtonEnabled\":true}";
WRM._unparsedData["com.atlassian.jira.jira-header-plugin:dismissedFlags.flags"]="{\"dismissed\":[]}";
WRM._unparsedData["com.atlassian.jira.jira-header-plugin:newsletter-signup-tip-init.newsletterSignup"]="{\"signupDescription\":\"Get updates, inspiration and best practices from the team behind JIRA.\",\"formUrl\":\"https://www.atlassian.com/apis/exact-target/{0}/subscribe?mailingListId=1401671\",\"signupTitle\":\"Sign up!\",\"signupId\":\"newsletter-signup-tip\",\"showNewsletterTip\":false}";
WRM._unparsedData["com.atlassian.jira.project-templates-plugin:project-templates-plugin-resources.ptAnalyticsData"]="{\"instanceCreatedDate\":\"2011-01-31\"}";
WRM._unparsedData["com.atlassian.servicedesk.core-ui:util-help-links.help-links"]="{\"help\":{\"email.settings\":\"https://docs.atlassian.com/jira/jsd-docs-039/Receiving+requests+by+email\",\"managing.queues\":\"https://docs.atlassian.com/jira/jsd-docs-039/Setting+up+queues+for+your+team\",\"email.setup\":\"https://docs.atlassian.com/jira/jsd-docs-039/Receiving+requests+by+email\",\"request.settings.help.bubble\":\"https://docs.atlassian.com/jira/jsd-docs-039/Managing+access+to+your+service+desk\",\"email.settings.suitablerequest\":\"https://docs.atlassian.com/jira/jsd-docs-039/Receiving+requests+by+email#Receivingrequestsbyemail-suitablerequest\",\"sla.import.help\":\"https://docs.atlassian.com/jira/jsd-docs-039/Importing+SLAs\",\"documentation.home\":\"https://docs.atlassian.com/jira/jsd-docs-039/JIRA+Service+Desk+Documentation\",\"default\":\"https://docs.atlassian.com/jira/jsd-docs-039/\",\"create.space.help\":\"https://docs.atlassian.com/jira/jsd-docs-039/Serving+customers+with+a+knowledge+base#serving-customers-with-a-knowledge-base-createpermission\",\"email.settings.troubleshooting\":\"https://docs.atlassian.com/jira/jsd-docs-039/Troubleshooting+issues+with+the+email+channel\",\"admin.notifications.config\":\"https://docs.atlassian.com/jira/jsd-docs-039/Managing+service+desk+notifications\",\"troubleshoot.requesttype\":\"https://docs.atlassian.com/jira/jsd-docs-039/Troubleshooting+issues+with+request+types\",\"approvals.configuration\":\"https://docs.atlassian.com/jira/jsd-docs-039/Configuring+JIRA+Service+Desk+approvals\",\"setting.up.reports\":\"https://docs.atlassian.com/jira/jsd-docs-039/Setting+up+service+desk+reports\",\"public.signup\":\"https://docs.atlassian.com/jira/jsd-docs-039/Configuring+public+signup\",\"knowledge.base\":\"https://docs.atlassian.com/jira/jsd-docs-039/Serving+customers+with+a+knowledge+base\",\"resolve.permission.scheme.errors\":\"https://docs.atlassian.com/jira/jsd-docs-039/Resolving+permission+scheme+errors\",\"getting.started\":\"https://docs.atlassian.com/jira/jsd-docs-039/Getting+started+with+JIRA+Service+Desk\",\"getting.started.agent\":\"https://docs.atlassian.com/jira/jsd-docs-039/Getting+started+for+service+desk+agents\",\"invite.customers\":\"https://docs.atlassian.com/jira/jsd-docs-039/Managing+access+to+your+service+desk\"},\"kb\":{\"default\":\"https://confluence.atlassian.com/display/SDKB/\",\"troubleshooting.user.management.issues\":\"https://confluence.atlassian.com/display/SDKB/Troubleshooting+issues+with+service+desk+user+management\",\"legacytransition\":\"https://confluence.atlassian.com/display/SDKB/Replacing+legacy+automatic+transitions+with+automation+rules\",\"umtroubleshoot\":\"https://confluence.atlassian.com/display/SDKB/Troubleshooting+issues+with+service+desk+user+management\"}}";
WRM._unparsedData["com.atlassian.servicedesk.core-ui:util-base-url.base-url"]="\"https://issues.apache.org/jira\"";
WRM._unparsedData["com.atlassian.jira.plugins.jira-wiki-editor:wiki-editor-resources.help-data"]="{\"showHelp\":true,\"editorDocumentationUrl\":[\"https://docs.atlassian.com/jira/jcore-docs-076/Visual+editing\"],\"editorDocumentationTitle\":[\"Show me documentation for the visual editor\"]}";
WRM._unparsedData["com.atlassian.jira.plugins.jira-wiki-editor:wiki-editor-resources.thumbnails-allowed"]="false";
WRM._unparsedData["jira.webresources:user-message-flags.adminLockout"]="{}";
WRM._unparsedData["jira.request.correlation-id"]="\"6b533c86f81c41\"";
WRM._unparsedData["project-id"]="12310110";
WRM._unparsedData["project-key"]="\"LUCENE\"";
WRM._unparsedData["project-name"]="\"Lucene - Core\"";
WRM._unparsedData["project-type"]="\"software\"";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:generic-filters"]="[{\"id\":\"allissues\",\"jql\":\"project = \\\"{0}\\\" ORDER BY {1}\",\"defaultOrderby\":\"created DESC\",\"label\":\"All issues\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[]},{\"id\":\"allopenissues\",\"jql\":\"project = \\\"{0}\\\" AND resolution = Unresolved ORDER BY {1}\",\"defaultOrderby\":\"priority DESC, updated DESC\",\"label\":\"Open issues\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"resolution\"]},{\"id\":\"doneissues\",\"jql\":\"project = \\\"{0}\\\" AND statusCategory = Done ORDER BY {1}\",\"defaultOrderby\":\"updated DESC\",\"label\":\"Done issues\",\"requiresUser\":false,\"supportsInlineIssueCreate\":false,\"fields\":[\"status\"]},{\"id\":\"recentlyviewed\",\"jql\":\"project = \\\"{0}\\\" AND issuekey in issueHistory() ORDER BY {1}\",\"defaultOrderby\":\"lastViewed DESC\",\"label\":\"Viewed recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"issuekey\"]},{\"id\":\"addedrecently\",\"jql\":\"project = \\\"{0}\\\" AND created \u003e= -1w ORDER BY {1}\",\"defaultOrderby\":\"created DESC\",\"label\":\"Created recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"created\"]},{\"id\":\"resolvedrecently\",\"jql\":\"project = \\\"{0}\\\" AND resolutiondate \u003e= -1w ORDER BY {1}\",\"defaultOrderby\":\"updated DESC\",\"label\":\"Resolved recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":false,\"fields\":[\"resolutiondate\"]},{\"id\":\"updatedrecently\",\"jql\":\"project = \\\"{0}\\\" AND updated \u003e= -1w ORDER BY {1}\",\"defaultOrderby\":\"updated DESC\",\"label\":\"Updated recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"updated\"]}]";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:default-filter-priority"]="[\"allopenissues\",\"allissues\"]";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:can-manage-filters"]="false";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:project-filters"]="[]";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:can-create-issues"]="false";
WRM._unparsedData["projectId"]="12310110";
WRM._unparsedData["projectKey"]="\"LUCENE\"";
WRM._unparsedData["projectType"]="\"software\"";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:server-rendered"]="true";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <link type="text/css" rel="stylesheet" href="/jira/s/a8a4711bc3f2eb261d8c8fd9fbcbba8b-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/1fca1750044f2777c977e8d8cc023344/_/download/contextbatch/css/_super/batch.css" data-wrm-key="_super" data-wrm-batch-type="context" media="all"> 
  <link type="text/css" rel="stylesheet" href="/jira/s/1a6b21131945f6f49ff48336b49ca3fe-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/37a6e594cbbfd462a8a54d5aa11475c1/_/download/contextbatch/css/project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super/batch.css?agile_global_admin_condition=true&amp;hc-enabled=true&amp;is-server-instance=true&amp;jag=true&amp;jira.create.linked.issue=true&amp;nps-acknowledged=true&amp;richediton=true&amp;sd_operational=true" data-wrm-key="project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super" data-wrm-batch-type="context" media="all"> 
  <link type="text/css" rel="stylesheet" href="/jira/s/611672383f6cab00ab202241ba6f9d68-T/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/7.6.3/_/download/batch/com.atlassian.feedback.jira-feedback-plugin:button-resources-init/com.atlassian.feedback.jira-feedback-plugin:button-resources-init.css" data-wrm-key="com.atlassian.feedback.jira-feedback-plugin:button-resources-init" data-wrm-batch-type="resource" media="all"> 
  <script type="text/javascript" src="/jira/s/d8484c9183f546511a8e336a8779bcd9-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/1fca1750044f2777c977e8d8cc023344/_/download/contextbatch/js/_super/batch.js?locale=en-UK" data-wrm-key="_super" data-wrm-batch-type="context" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d3b35d835f8f46fc3b53bb4db7f85158-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/37a6e594cbbfd462a8a54d5aa11475c1/_/download/contextbatch/js/project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super/batch.js?agile_global_admin_condition=true&amp;hc-enabled=true&amp;is-server-instance=true&amp;jag=true&amp;jira.create.linked.issue=true&amp;locale=en-UK&amp;nps-acknowledged=true&amp;richediton=true&amp;sd_operational=true" data-wrm-key="project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super" data-wrm-batch-type="context" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/71d42e74136d842a3ef4d5d136484843-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/871d45c9f322a22cb3aa9b7948a69803/_/download/contextbatch/js/atl.global,-_super/batch.js?locale=en-UK" data-wrm-key="atl.global,-_super" data-wrm-batch-type="context" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:calendar-en/jira.webresources:calendar-en.js" data-wrm-key="jira.webresources:calendar-en" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:calendar-localisation-moment/jira.webresources:calendar-localisation-moment.js" data-wrm-key="jira.webresources:calendar-localisation-moment" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/7.6.3/_/download/batch/com.atlassian.feedback.jira-feedback-plugin:button-resources/com.atlassian.feedback.jira-feedback-plugin:button-resources.js" data-wrm-key="com.atlassian.feedback.jira-feedback-plugin:button-resources" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <link type="text/css" rel="stylesheet" href="/jira/s/95a4826c265852f4904f1e0e7300df68-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/e0de73613a1027de08f3da6a45e1d1a2/_/download/contextbatch/css/jira.global.look-and-feel,-_super/batch.css" data-wrm-key="jira.global.look-and-feel,-_super" data-wrm-batch-type="context" media="all"> 
  <script type="text/javascript" src="/jira/rest/api/1.0/shortcuts/76005/944bb39eced1b35cfc7194aa02eb5a5a/shortcuts.js?context=issuenavigation&amp;context=issueaction"></script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["com.atlassian.jira.jira-issue-nav-components:inline-edit-enabled"]="true";
WRM._unparsedData["should-display-chaperone"]="false";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <link type="text/css" rel="stylesheet" href="/jira/s/15712b600e9aecf72ffd9fd3704a0c78-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/6b22a15c7b83f87a47b1757076f43542/_/download/contextbatch/css/com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue/batch.css?jira.create.linked.issue=true&amp;richediton=true&amp;sd_operational=true" data-wrm-key="com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue" data-wrm-batch-type="context" media="all"> 
  <script type="text/javascript" src="/jira/s/5a8f0f8b8aa8f96a4f0f7e9e248d62f3-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/6b22a15c7b83f87a47b1757076f43542/_/download/contextbatch/js/com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue/batch.js?jira.create.linked.issue=true&amp;locale=en-UK&amp;richediton=true&amp;sd_operational=true" data-wrm-key="com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue" data-wrm-batch-type="context" data-initially-rendered></script> 
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
  <meta name="ajs-can-search-users" content="false"> 
  <meta name="ajs-can-edit-watchers" content="false"> 
  <meta name="ajs-default-avatar-url" content="https://issues.apache.org/jira/secure/useravatar?size=xsmall&amp;avatarId=10453"> 
  <meta name="ajs-issue-project-type" content="software"> 
  <meta name="ajs-issue-key" content="LUCENE-2324"> 
  <meta name="ajs-server-view-issue-is-editable" content="false"> 
  <title>[LUCENE-2324] Per thread DocumentsWriters that write their own private segments - ASF JIRA</title> 
  <link rel="search" type="application/opensearchdescription+xml" href="/jira/osd.jsp" title="[LUCENE-2324] Per thread DocumentsWriters that write their own private segments - ASF JIRA"> 
 </head> 
 <body id="jira" class="aui-layout aui-theme-default " data-version="7.6.3"> 
  <div id="page"> 
   <header id="header" role="banner"> 
    <script>
require(["jquery", "jira/license-banner"], function ($, licenseBanner) {
    $(function () {
        licenseBanner.showLicenseBanner("");
        licenseBanner.showLicenseFlag("");
    });
});
</script> 
    <nav class="aui-header aui-dropdown2-trigger-group" role="navigation">
     <div class="aui-header-inner">
      <div class="aui-header-before">
       <a class=" aui-dropdown2-trigger app-switcher-trigger" aria-controls="app-switcher" aria-haspopup="true" role="button" tabindex="0" data-aui-trigger href="#app-switcher"><span class="aui-icon aui-icon-small aui-iconfont-appswitcher">Linked Applications</span></a>
       <div id="app-switcher" class="aui-dropdown2 aui-style-default" role="menu" aria-hidden="true" data-is-switcher="true" data-environment="{&quot;isUserAdmin&quot;:false,&quot;isAppSuggestionAvailable&quot;:false,&quot;isSiteAdminUser&quot;:false}">
        <div role="application">
         <div class="app-switcher-loading">
          Loadingâ€¦
         </div>
        </div>
       </div>
      </div>
      <div class="aui-header-primary">
       <h1 id="logo" class="aui-header-logo aui-header-logo-custom"><a href="https://issues.apache.org/jira/secure/MyJiraHome.jspa"><img src="/jira/s/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/_/jira-logo-scaled.png" alt="ASF JIRA"></a></h1>
       <ul class="aui-nav">
        <li><a href="/jira/secure/Dashboard.jspa" class=" aui-nav-link aui-dropdown2-trigger aui-dropdown2-ajax" id="home_link" aria-haspopup="true" aria-controls="home_link-content" title="View and manage your dashboards" accesskey="d">Dashboards</a>
         <div class="aui-dropdown2 aui-style-default" id="home_link-content" data-aui-dropdown2-ajax-key="home_link"></div></li>
        <li><a href="/jira/browse/LUCENE" class=" aui-nav-link aui-dropdown2-trigger aui-dropdown2-ajax" id="browse_link" aria-haspopup="true" aria-controls="browse_link-content" title="View recent projects and browse a list of projects" accesskey="p">Projects</a>
         <div class="aui-dropdown2 aui-style-default" id="browse_link-content" data-aui-dropdown2-ajax-key="browse_link"></div></li>
        <li><a href="/jira/issues/" class=" aui-nav-link aui-dropdown2-trigger aui-dropdown2-ajax" id="find_link" aria-haspopup="true" aria-controls="find_link-content" title="Search for issues and view recent issues" accesskey="i">Issues</a>
         <div class="aui-dropdown2 aui-style-default" id="find_link-content" data-aui-dropdown2-ajax-key="find_link"></div></li> 
       </ul>
      </div>
      <div class="aui-header-secondary">
       <ul class="aui-nav">
        <li id="quicksearch-menu"> 
         <form action="/jira/secure/QuickSearch.jspa" method="get" id="quicksearch" class="aui-quicksearch dont-default-focus ajs-dirty-warning-exempt"> 
          <input id="quickSearchInput" class="search" type="text" title="Search" placeholder="Search" name="searchString" accessKey="q"> 
          <input type="submit" class="hidden" value="Search"> 
         </form> </li> 
        <li><a class="jira-feedback-plugin" role="button" aria-haspopup="true" id="jira-header-feedback-link" href="#"><span class="aui-icon aui-icon-small jira-feedback-plugin-icon">Give feedback to Atlassian</span></a></li> 
        <li id="system-help-menu"> <a class="aui-nav-link aui-dropdown2-trigger" id="help_menu" aria-haspopup="true" aria-owns="system-help-menu-content" href="https://docs.atlassian.com/jira/jcore-docs-076/" target="$textUtils.htmlEncode($rootHelpMenuItem.params.target)" title="Help"><span class="aui-icon aui-icon-small aui-iconfont-help">Help</span></a> 
         <div id="system-help-menu-content" class="aui-dropdown2 aui-style-default"> 
          <div class="aui-dropdown2-section"> 
           <ul id="jira-help" class="aui-list-truncate"> 
            <li> <a id="view_core_help" class="aui-nav-link " title="Go to the online documentation for JIRA Core" href="https://docs.atlassian.com/jira/jcore-docs-076/" target="_blank">JIRA Core help</a> </li> 
            <li> <a id="keyshortscuthelp" class="aui-nav-link " title="Get more information about JIRA's Keyboard Shortcuts" href="/jira/secure/ViewKeyboardShortcuts!default.jspa" target="_blank">Keyboard Shortcuts</a> </li> 
            <li> <a id="view_about" class="aui-nav-link " title="Get more information about JIRA" href="/jira/secure/AboutPage.jspa">About JIRA</a> </li> 
            <li> <a id="view_credits" class="aui-nav-link " title="See who did what" href="/jira/secure/JiraCreditsPage!default.jspa" target="_blank">JIRA Credits</a> </li> 
           </ul> 
          </div> 
         </div> </li> 
        <li id="user-options"> <a class="aui-nav-link login-link" href="/jira/login.jsp?os_destination=%2Fbrowse%2FLUCENE-2324">Log In</a> 
         <div id="user-options-content" class="aui-dropdown2 aui-style-default"> 
          <div class="aui-dropdown2-section"> 
          </div> 
         </div> </li> 
       </ul>
      </div>
     </div>
     <!-- .aui-header-inner-->
    </nav>
    <!-- .aui-header --> 
   </header> 
   <section id="content" role="main"> 
    <big-pipe data-id="sidebar-id" unresolved></big-pipe>
    <div class="aui-sidebar  sidebar-placeholder">
     <div class="aui-sidebar-wrapper">
      <div class="aui-sidebar-body"></div>
      <div class="aui-sidebar-footer">
       <a class="aui-button aui-button-subtle aui-sidebar-toggle aui-sidebar-footer-tipsy" data-tooltip="Expand sidebar ( [ )" href="#"><span class="aui-icon aui-icon-small"></span></a>
      </div>
     </div>
    </div>
    <script id="projects-sidebar-init">
    require(['jira/projects/sidebar/expansion-manager'], function(expansionManager) {
        var scriptTag = document.getElementById('projects-sidebar-init');
        var sidebar = AJS.sidebar('.aui-sidebar');
        expansionManager(sidebar);
        scriptTag.parentElement.removeChild(scriptTag);
    });
    </script>
    <div class="aui-page-panel">
     <div class="aui-page-panel-inner">
      <div class="issue-navigator">
       <div class="content">
        <div class="issue-view">
         <div class="navigation-tools">
          <div class="pager-container"></div>
         </div>
         <div class="issue-container">
          <div id="issue-content" class="issue-edit-form">
           <header id="stalker" class="issue-header js-stalker">
            <div class="issue-header-content">
             <header class="aui-page-header">
              <div class="aui-page-header-inner">
               <div class="aui-page-header-image">
                <span id="12310110" class="aui-avatar aui-avatar-large aui-avatar-project"><span class="aui-avatar-inner"><img id="project-avatar" alt="Uploaded image for project: 'Lucene - Core'" src="https://issues.apache.org/jira/secure/projectavatar?pid=12310110&amp;avatarId=10061"></span></span>
               </div>
               <!-- .aui-page-header-image -->
               <div class="aui-page-header-main">
                <ol class="aui-nav aui-nav-breadcrumbs">
                 <li><a id="project-name-val" href="/jira/browse/LUCENE">Lucene - Core</a></li>
                 <li><a class="issue-link" data-issue-key="LUCENE-2324" href="/jira/browse/LUCENE-2324" id="key-val" rel="12459100">LUCENE-2324</a></li>
                </ol>
                <h1 id="summary-val">Per thread DocumentsWriters that write their own private segments</h1>
               </div>
               <!-- .aui-page-header-main -->
               <div class="aui-page-header-actions">
                <div id="issue-header-pager"></div>
               </div>
               <!-- .aui-page-header-actions -->
              </div>
              <!-- .aui-page-header-inner -->
             </header>
             <!-- .aui-page-header -->
             <div class="command-bar">
              <div class="ops-cont">
               <div class="ops-menus aui-toolbar">
                <div class="toolbar-split toolbar-split-left">
                 <ul id="opsbar-ops-login-lnk_container" class="toolbar-group pluggable-ops">
                  <li class="toolbar-item"><a id="ops-login-lnk" title="Log In" class="toolbar-trigger" href="/jira/login.jsp?os_destination=%2Fbrowse%2FLUCENE-2324"><span class="trigger-label">Log In</span></a></li>
                 </ul>
                 <ul id="opsbar-opsbar-operations" class="toolbar-group pluggable-ops"></ul>
                 <ul id="opsbar-opsbar-transitions" class="toolbar-group pluggable-ops"></ul>
                 <ul id="opsbar-opsbar-admin" class="toolbar-group pluggable-ops"></ul>
                </div>
                <div class="toolbar-split toolbar-split-right">
                 <ul id="opsbar-jira.issue.tools" class="toolbar-group pluggable-ops">
                  <li class="toolbar-item">
                   <div>
                    <a href="#" id="viewissue-export" aria-owns="viewissue-export_drop" aria-haspopup="true" title="Export this issue in another format" class="toolbar-trigger aui-button aui-style-default aui-dropdown2-trigger"><span class="icon icon-default aui-icon aui-icon-small aui-iconfont-export"></span> <span class="dropdown-text">Export</span></a>
                    <div id="viewissue-export_drop" class="aui-style-default aui-dropdown2">
                     <ul>
                      <li class="aui-list-item"><a href="/jira/si/jira.issueviews:issue-xml/LUCENE-2324/LUCENE-2324.xml" id="jira.issueviews:issue-xml"><span class="trigger-label">XML</span></a></li>
                      <li class="aui-list-item"><a href="/jira/si/jira.issueviews:issue-word/LUCENE-2324/LUCENE-2324.doc" id="jira.issueviews:issue-word"><span class="trigger-label">Word</span></a></li>
                      <li class="aui-list-item"><a href="/jira/si/jira.issueviews:issue-html/LUCENE-2324/LUCENE-2324.html" id="jira.issueviews:issue-html"><span class="trigger-label">Printable</span></a></li>
                      <li class="aui-list-item"><a href="/jira/si/com.atlassian.jira.plugins.jira-importers-plugin:issue-json/LUCENE-2324/LUCENE-2324.json" id="com.atlassian.jira.plugins.jira-importers-plugin:issue-json"><span class="trigger-label">JSON</span></a></li>
                     </ul>
                    </div>
                   </div></li>
                 </ul>
                </div>
               </div>
              </div>
             </div>
            </div>
           </header>
           <div class="issue-body-content">
            <div class="aui-group issue-body">
             <div class="aui-item issue-main-column">
              <div id="details-module" class="module toggle-wrap">
               <div id="details-module_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Details</h2>
               </div>
               <div class="mod-content"> 
                <ul id="issuedetails" class="property-list two-cols"> 
                 <li class="item"> 
                  <div class="wrap"> 
                   <strong class="name">Type:</strong> 
                   <span id="type-val" class="value"> <img alt="" height="16" src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21140&amp;avatarType=issuetype" title="Improvement - An improvement or enhancement to an existing feature or task." width="16"> Improvement </span> 
                  </div> </li> 
                 <li class="item item-right"> 
                  <div class="wrap"> 
                   <strong class="name">Status:</strong> 
                   <span id="status-val" class="value"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done jira-issue-status-lozenge-max-width-medium" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Resolved</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.</span>">Resolved</span> </span> 
                  </div> </li> 
                 <li class="item new"> 
                  <div class="wrap"> 
                   <strong class="name">Priority:</strong> 
                   <span id="priority-val" class="value"> <img alt="" height="16" src="/jira/images/icons/priorities/minor.svg" title="Minor - Minor loss of function, or other problem where easy workaround is present." width="16"> Minor </span> 
                  </div> </li> 
                 <li class="item item-right"> 
                  <div class="wrap"> 
                   <strong class="name">Resolution:</strong> 
                   <span id="resolution-val" class="value resolved"> Fixed </span> 
                  </div> </li> 
                 <li class="item"> 
                  <div class="wrap"> 
                   <strong class="name">Affects Version/s:</strong> 
                   <span id="versions-val" class="value"> None </span> 
                  </div> </li> 
                 <li class="item item-right"> 
                  <div class="wrap"> 
                   <strong class="name">Fix Version/s:</strong> 
                   <span id="fixfor-val" class="value"> <span class="shorten" id="fixVersions-field"> <a href="/jira/issues/?jql=project+%3D+LUCENE+AND+fixVersion+%3D+%22Realtime+Branch%22" title="Realtime Branch Branch for realtime search (searching on RAM buffer)">Realtime Branch</a> </span> </span> 
                  </div> </li> 
                 <li class="item"> 
                  <div class="wrap"> 
                   <strong class="name">Component/s:</strong> 
                   <span id="components-val" class="value"> <span class="shorten" id="components-field"> <a href="/jira/issues/?jql=project+%3D+LUCENE+AND+component+%3D+%22core%2Findex%22" title="core/index issues with indexing code">core/index</a> </span> </span> 
                  </div> </li> 
                 <li class="item full-width"> 
                  <div class="wrap" id="wrap-labels"> 
                   <strong class="name">Labels:</strong> 
                   <div class="labels-wrap value"> 
                    <span class="labels" id="labels-12459100-value">None</span> 
                   </div> 
                  </div> </li> 
                </ul> 
                <div id="customfieldmodule"> 
                 <div class="aui-tabs horizontal-tabs" id="customfield-tabs"> 
                  <div id="customfield-panel-1" class="tabs-pane active-pane"> 
                   <ul class="property-list"> 
                    <li id="rowForcustomfield_12310120" class="item"> 
                     <div class="wrap"> 
                      <strong title="Lucene Fields" class="name">Lucene Fields:</strong> 
                      <div id="customfield_12310120-val" class="value type-multicheckboxes" data-fieldtype="multicheckboxes" data-fieldtypecompletekey="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes"> 
                       <div class="shorten" id="customfield_12310120-field"> 
                        <span>New</span> 
                       </div> 
                      </div> 
                     </div> </li> 
                   </ul> 
                  </div> 
                 </div>
                </div> 
               </div>
              </div>
              <div id="descriptionmodule" class="module toggle-wrap">
               <div id="descriptionmodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Description</h2>
               </div>
               <div class="mod-content">
                <div id="description-val" class="field-ignore-highlight"> 
                 <div class="user-content-block"> 
                  <p>See <a href="https://issues.apache.org/jira/browse/LUCENE-2293" title="IndexWriter has hard limit on max concurrency" class="issue-link" data-issue-key="LUCENE-2293"><del>LUCENE-2293</del></a> for motivation and more details.</p> 
                  <p>I'm copying here Mike's summary he posted on 2293:</p> 
                  <p>Change the approach for how we buffer in RAM to a more isolated<br> approach, whereby IW has N fully independent RAM segments<br> in-process and when a doc needs to be indexed it's added to one of<br> them. Each segment would also write its own doc stores and<br> "normal" segment merging (not the inefficient merge we now do on<br> flush) would merge them. This should be a good simplification in<br> the chain (eg maybe we can remove the *PerThread classes). The<br> segments can flush independently, letting us make much better<br> concurrent use of IO &amp; CPU.</p> 
                 </div> 
                </div> 
               </div>
              </div>
              <div id="dnd-metadata" class="module toggle-wrap">
               <div id="dnd-metadata_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Attachments</h2>
               </div>
               <div class="mod-content">
                <div id="dnd-metadata-webpanel" data-can-attach="false" data-project-type="software" data-upload-limit="62914560" data-thumbnails-allowed="false"></div>
               </div>
              </div>
              <div id="attachmentmodule" class="module toggle-wrap">
               <div id="attachmentmodule_heading" class="mod-header">
                <ul class="ops">
                 <li class="drop">
                  <div class="aui-dd-parent">
                   <a href="#" class="icon drop-menu js-default-dropdown" title="Options"><span>Options</span></a>
                   <div class="aui-dropdown-content aui-list">
                    <ul id="attachment-sorting-options" class="aui-list-section aui-first">
                     <li class="aui-list-item"><a id="attachment-sort-key-name" href="/jira/browse/LUCENE-2324?attachmentSortBy=fileName#attachmentmodule" class="aui-list-checked aui-checked aui-list-item-link" title="viewissue.subtasks.tab.show.all.name"><span>Sort By Name</span></a></li>
                     <li class="aui-list-item"><a id="attachment-sort-key-date" href="/jira/browse/LUCENE-2324?attachmentSortBy=dateTime#attachmentmodule" class="aui-list-checked aui-list-item-link" title="Sort By Date"><span>Sort By Date</span></a></li>
                    </ul>
                    <ul id="attachment-sorting-order-options" class="aui-list-section aui-last">
                     <li class="aui-list-item"><a id="attachment-sort-direction-asc" href="/jira/browse/LUCENE-2324?attachmentOrder=asc#attachmentmodule" class="aui-list-checked aui-checked aui-list-item-link" title="Ascending"><span>Ascending</span></a></li>
                     <li class="aui-list-item"><a id="attachment-sort-direction-desc" href="/jira/browse/LUCENE-2324?attachmentOrder=desc#attachmentmodule" class="aui-list-checked aui-list-item-link" title="Descending"><span>Descending</span></a></li>
                    </ul>
                   </div>
                  </div></li>
                </ul>
                <h2 class="toggle-title">Attachments</h2>
               </div>
               <div class="mod-content">
                <ol id="file_attachments" class="item-attachments" data-sort-key="fileName" data-sort-order="asc">
                 <li class="attachment-content js-file-attachment" data-attachment-id="12441770" data-issue-id="12459100" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12441770/ASF.LICENSE.NOT.GRANTED--lucene-2324.patch" draggable="true" data-downloadurl="text/x-patch:ASF.LICENSE.NOT.GRANTED--lucene-2324.patch:https://issues.apache.org/jira/secure/attachment/12441770/ASF.LICENSE.NOT.GRANTED--lucene-2324.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12441770/ASF.LICENSE.NOT.GRANTED--lucene-2324.patch" title="Latest  14/Apr/10 21:14 - Michael Busch" draggable="true" data-downloadurl="text/x-patch:ASF.LICENSE.NOT.GRANTED--lucene-2324.patch:https://issues.apache.org/jira/secure/attachment/12441770/ASF.LICENSE.NOT.GRANTED--lucene-2324.patch">ASF.LICENSE.NOT.GRANTED--lucene-2324.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2010-04-14T21:14:14.009Z">14/Apr/10 21:14</time>
                   </dd>
                   <dd class="attachment-size">
                    168 kB
                   </dd>
                   <dd class="attachment-author">
                    Michael Busch
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12450048" data-issue-id="12459100" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12450048/lucene-2324.patch" draggable="true" data-downloadurl="text/plain:lucene-2324.patch:https://issues.apache.org/jira/secure/attachment/12450048/lucene-2324.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-file-txt" title="Text File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12450048/lucene-2324.patch" title="Latest  21/Jul/10 10:22 - Michael Busch" draggable="true" data-downloadurl="text/plain:lucene-2324.patch:https://issues.apache.org/jira/secure/attachment/12450048/lucene-2324.patch">lucene-2324.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2010-07-21T10:22:14.794Z">21/Jul/10 10:22</time>
                   </dd>
                   <dd class="attachment-size">
                    310 kB
                   </dd>
                   <dd class="attachment-author">
                    Michael Busch
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12468626" data-issue-id="12459100" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12468626/LUCENE-2324.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-2324.patch:https://issues.apache.org/jira/secure/attachment/12468626/LUCENE-2324.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12468626/LUCENE-2324.patch" title="Latest  18/Jan/11 07:05 - Jason Rutherglen" draggable="true" data-downloadurl="text/x-patch:LUCENE-2324.patch:https://issues.apache.org/jira/secure/attachment/12468626/LUCENE-2324.patch">LUCENE-2324.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2011-01-18T07:05:01.768Z">18/Jan/11 07:05</time>
                   </dd>
                   <dd class="attachment-size">
                    6 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12468605" data-issue-id="12459100" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12468605/LUCENE-2324.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-2324.patch:https://issues.apache.org/jira/secure/attachment/12468605/LUCENE-2324.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12468605/LUCENE-2324.patch" title=" 17/Jan/11 23:33 - Jason Rutherglen" draggable="true" data-downloadurl="text/x-patch:LUCENE-2324.patch:https://issues.apache.org/jira/secure/attachment/12468605/LUCENE-2324.patch">LUCENE-2324.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2011-01-17T23:33:44.082Z">17/Jan/11 23:33</time>
                   </dd>
                   <dd class="attachment-size">
                    2 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12468506" data-issue-id="12459100" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12468506/LUCENE-2324.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-2324.patch:https://issues.apache.org/jira/secure/attachment/12468506/LUCENE-2324.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12468506/LUCENE-2324.patch" title=" 16/Jan/11 18:53 - Jason Rutherglen" draggable="true" data-downloadurl="text/x-patch:LUCENE-2324.patch:https://issues.apache.org/jira/secure/attachment/12468506/LUCENE-2324.patch">LUCENE-2324.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2011-01-16T18:53:17.654Z">16/Jan/11 18:53</time>
                   </dd>
                   <dd class="attachment-size">
                    16 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12439916" data-issue-id="12459100" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12439916/LUCENE-2324.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-2324.patch:https://issues.apache.org/jira/secure/attachment/12439916/LUCENE-2324.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12439916/LUCENE-2324.patch" title=" 26/Mar/10 21:32 - Jason Rutherglen" draggable="true" data-downloadurl="text/x-patch:LUCENE-2324.patch:https://issues.apache.org/jira/secure/attachment/12439916/LUCENE-2324.patch">LUCENE-2324.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2010-03-26T21:32:40.948Z">26/Mar/10 21:32</time>
                   </dd>
                   <dd class="attachment-size">
                    61 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12467686" data-issue-id="12459100" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12467686/LUCENE-2324-SMALL.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-2324-SMALL.patch:https://issues.apache.org/jira/secure/attachment/12467686/LUCENE-2324-SMALL.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12467686/LUCENE-2324-SMALL.patch" title="Latest  06/Jan/11 23:11 - Jason Rutherglen" draggable="true" data-downloadurl="text/x-patch:LUCENE-2324-SMALL.patch:https://issues.apache.org/jira/secure/attachment/12467686/LUCENE-2324-SMALL.patch">LUCENE-2324-SMALL.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2011-01-06T23:11:18.711Z">06/Jan/11 23:11</time>
                   </dd>
                   <dd class="attachment-size">
                    18 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12467645" data-issue-id="12459100" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12467645/LUCENE-2324-SMALL.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-2324-SMALL.patch:https://issues.apache.org/jira/secure/attachment/12467645/LUCENE-2324-SMALL.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12467645/LUCENE-2324-SMALL.patch" title=" 06/Jan/11 16:56 - Jason Rutherglen" draggable="true" data-downloadurl="text/x-patch:LUCENE-2324-SMALL.patch:https://issues.apache.org/jira/secure/attachment/12467645/LUCENE-2324-SMALL.patch">LUCENE-2324-SMALL.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2011-01-06T16:56:35.275Z">06/Jan/11 16:56</time>
                   </dd>
                   <dd class="attachment-size">
                    12 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12467614" data-issue-id="12459100" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12467614/LUCENE-2324-SMALL.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-2324-SMALL.patch:https://issues.apache.org/jira/secure/attachment/12467614/LUCENE-2324-SMALL.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12467614/LUCENE-2324-SMALL.patch" title=" 06/Jan/11 05:04 - Jason Rutherglen" draggable="true" data-downloadurl="text/x-patch:LUCENE-2324-SMALL.patch:https://issues.apache.org/jira/secure/attachment/12467614/LUCENE-2324-SMALL.patch">LUCENE-2324-SMALL.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2011-01-06T05:04:12.949Z">06/Jan/11 05:04</time>
                   </dd>
                   <dd class="attachment-size">
                    7 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12467477" data-issue-id="12459100" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12467477/LUCENE-2324-SMALL.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-2324-SMALL.patch:https://issues.apache.org/jira/secure/attachment/12467477/LUCENE-2324-SMALL.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12467477/LUCENE-2324-SMALL.patch" title=" 04/Jan/11 21:53 - Jason Rutherglen" draggable="true" data-downloadurl="text/x-patch:LUCENE-2324-SMALL.patch:https://issues.apache.org/jira/secure/attachment/12467477/LUCENE-2324-SMALL.patch">LUCENE-2324-SMALL.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2011-01-04T21:53:42.984Z">04/Jan/11 21:53</time>
                   </dd>
                   <dd class="attachment-size">
                    6 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12466859" data-issue-id="12459100" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12466859/LUCENE-2324-SMALL.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-2324-SMALL.patch:https://issues.apache.org/jira/secure/attachment/12466859/LUCENE-2324-SMALL.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12466859/LUCENE-2324-SMALL.patch" title=" 23/Dec/10 05:33 - Jason Rutherglen" draggable="true" data-downloadurl="text/x-patch:LUCENE-2324-SMALL.patch:https://issues.apache.org/jira/secure/attachment/12466859/LUCENE-2324-SMALL.patch">LUCENE-2324-SMALL.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2010-12-23T05:33:29.161Z">23/Dec/10 05:33</time>
                   </dd>
                   <dd class="attachment-size">
                    3 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12468471" data-issue-id="12459100" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12468471/test.out" draggable="true" data-downloadurl="application/octet-stream:test.out:https://issues.apache.org/jira/secure/attachment/12468471/test.out"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12468471/test.out" title="Latest  16/Jan/11 02:55 - Jason Rutherglen" draggable="true" data-downloadurl="application/octet-stream:test.out:https://issues.apache.org/jira/secure/attachment/12468471/test.out">test.out</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2011-01-16T02:55:07.548Z">16/Jan/11 02:55</time>
                   </dd>
                   <dd class="attachment-size">
                    131 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12468325" data-issue-id="12459100" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12468325/test.out" draggable="true" data-downloadurl="application/octet-stream:test.out:https://issues.apache.org/jira/secure/attachment/12468325/test.out"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12468325/test.out" title=" 14/Jan/11 00:40 - Jason Rutherglen" draggable="true" data-downloadurl="application/octet-stream:test.out:https://issues.apache.org/jira/secure/attachment/12468325/test.out">test.out</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2011-01-14T00:40:51.029Z">14/Jan/11 00:40</time>
                   </dd>
                   <dd class="attachment-size">
                    56 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12467618" data-issue-id="12459100" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12467618/test.out" draggable="true" data-downloadurl="application/octet-stream:test.out:https://issues.apache.org/jira/secure/attachment/12467618/test.out"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12467618/test.out" title=" 06/Jan/11 05:20 - Jason Rutherglen" draggable="true" data-downloadurl="application/octet-stream:test.out:https://issues.apache.org/jira/secure/attachment/12467618/test.out">test.out</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2011-01-06T05:20:10.933Z">06/Jan/11 05:20</time>
                   </dd>
                   <dd class="attachment-size">
                    33 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12466857" data-issue-id="12459100" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12466857/test.out" draggable="true" data-downloadurl="application/octet-stream:test.out:https://issues.apache.org/jira/secure/attachment/12466857/test.out"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12466857/test.out" title=" 23/Dec/10 04:54 - Jason Rutherglen" draggable="true" data-downloadurl="application/octet-stream:test.out:https://issues.apache.org/jira/secure/attachment/12466857/test.out">test.out</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2010-12-23T04:54:41.205Z">23/Dec/10 04:54</time>
                   </dd>
                   <dd class="attachment-size">
                    25 kB
                   </dd>
                   <dd class="attachment-author">
                    Jason Rutherglen
                   </dd>
                  </dl></li>
                </ol>
               </div>
              </div>
              <div id="linkingmodule" class="module toggle-wrap">
               <div id="linkingmodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Issue Links</h2>
               </div>
               <div class="mod-content"> 
                <div class="links-container" data-default-link-icon="/jira/images/icons/generic_link_16.png"> 
                 <dl class="links-list "> 
                  <dt title="blocks">
                   blocks
                  </dt> 
                  <dd id="internal-12458987_10032"> 
                   <div class="link-content"> 
                    <p> <img src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21141&amp;avatarType=issuetype" width="16" height="16" title="New Feature - A new feature of the product, which has yet to be developed." alt="New Feature - A new feature of the product, which has yet to be developed."> <span title="LUCENE-2312: Search on IndexWriter's RAM Buffer"> <a href="/jira/browse/LUCENE-2312" data-issue-key="LUCENE-2312" class="issue-link link-title">LUCENE-2312</a> <span class="link-summary">Search on IndexWriter's RAM Buffer</span> </span> </p> 
                    <ul class="link-snapshot"> 
                     <li class="priority"> <img src="/jira/images/icons/priorities/major.svg" width="16" height="16" title="Major - Major loss of function." alt="Major - Major loss of function."> </li> 
                     <li class="status"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-blue-gray jira-issue-status-lozenge-new aui-lozenge-subtle jira-issue-status-lozenge-max-width-short" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Open</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>The issue is open and ready for the assignee to start work on it.</span>">Open</span> </li> 
                    </ul> 
                   </div> 
                  </dd> 
                 </dl> 
                 <dl class="links-list "> 
                  <dt title="is blocked by">
                   is blocked by
                  </dt> 
                  <dd id="internal-12504248_10032"> 
                   <div class="link-content"> 
                    <p> <img src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype" width="16" height="16" title="Bug - A problem which impairs or prevents the functions of the product." alt="Bug - A problem which impairs or prevents the functions of the product."> <span title="LUCENE-3028: IW.getReader() returns inconsistent reader on RT Branch"> <a href="/jira/browse/LUCENE-3028" data-issue-key="LUCENE-3028" class="issue-link link-title resolution">LUCENE-3028</a> <span class="link-summary">IW.getReader() returns inconsistent reader on RT Branch</span> </span> </p> 
                    <ul class="link-snapshot"> 
                     <li class="priority"> <img src="/jira/images/icons/priorities/major.svg" width="16" height="16" title="Major - Major loss of function." alt="Major - Major loss of function."> </li> 
                     <li class="status"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done aui-lozenge-subtle jira-issue-status-lozenge-max-width-short" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Resolved</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.</span>">Resolved</span> </li> 
                    </ul> 
                   </div> 
                  </dd> 
                  <dd id="internal-12500948_10032"> 
                   <div class="link-content"> 
                    <p> <img src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype" width="16" height="16" title="Bug - A problem which impairs or prevents the functions of the product." alt="Bug - A problem which impairs or prevents the functions of the product."> <span title="LUCENE-2956: Support updateDocument() with DWPTs"> <a href="/jira/browse/LUCENE-2956" data-issue-key="LUCENE-2956" class="issue-link link-title resolution">LUCENE-2956</a> <span class="link-summary">Support updateDocument() with DWPTs</span> </span> </p> 
                    <ul class="link-snapshot"> 
                     <li class="priority"> <img src="/jira/images/icons/priorities/minor.svg" width="16" height="16" title="Minor - Minor loss of function, or other problem where easy workaround is present." alt="Minor - Minor loss of function, or other problem where easy workaround is present."> </li> 
                     <li class="status"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done aui-lozenge-subtle jira-issue-status-lozenge-max-width-short" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Resolved</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.</span>">Resolved</span> </li> 
                    </ul> 
                   </div> 
                  </dd> 
                  <dd id="internal-12496483_10032"> 
                   <div class="link-content"> 
                    <p> <img src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21140&amp;avatarType=issuetype" width="16" height="16" title="Improvement - An improvement or enhancement to an existing feature or task." alt="Improvement - An improvement or enhancement to an existing feature or task."> <span title="LUCENE-2881: Track FieldInfo per segment instead of per-IW-session"> <a href="/jira/browse/LUCENE-2881" data-issue-key="LUCENE-2881" class="issue-link link-title resolution">LUCENE-2881</a> <span class="link-summary">Track FieldInfo per segment instead of per-IW-session</span> </span> </p> 
                    <ul class="link-snapshot"> 
                     <li class="priority"> <img src="/jira/images/icons/priorities/major.svg" width="16" height="16" title="Major - Major loss of function." alt="Major - Major loss of function."> </li> 
                     <li class="status"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done aui-lozenge-subtle jira-issue-status-lozenge-max-width-short" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Closed</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.</span>">Closed</span> </li> 
                    </ul> 
                   </div> 
                  </dd> 
                 </dl> 
                 <dl class="links-list "> 
                  <dt title="is related to">
                   is related to
                  </dt> 
                  <dd id="internal-12458038_10030"> 
                   <div class="link-content"> 
                    <p> <img src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype" width="16" height="16" title="Bug - A problem which impairs or prevents the functions of the product." alt="Bug - A problem which impairs or prevents the functions of the product."> <span title="LUCENE-2293: IndexWriter has hard limit on max concurrency"> <a href="/jira/browse/LUCENE-2293" data-issue-key="LUCENE-2293" class="issue-link link-title resolution">LUCENE-2293</a> <span class="link-summary">IndexWriter has hard limit on max concurrency</span> </span> </p> 
                    <ul class="link-snapshot"> 
                     <li class="priority"> <img src="/jira/images/icons/priorities/major.svg" width="16" height="16" title="Major - Major loss of function." alt="Major - Major loss of function."> </li> 
                     <li class="status"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done aui-lozenge-subtle jira-issue-status-lozenge-max-width-short" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Closed</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.</span>">Closed</span> </li> 
                    </ul> 
                   </div> 
                  </dd> 
                 </dl> 
                 <dl class="links-list collapsed-links-list"> 
                  <dt title="relates to">
                   relates to
                  </dt> 
                  <dd id="internal-12470358_10030" class="
                                                collapsed-link                    "> 
                   <div class="link-content"> 
                    <p> <img src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21140&amp;avatarType=issuetype" width="16" height="16" title="Improvement - An improvement or enhancement to an existing feature or task." alt="Improvement - An improvement or enhancement to an existing feature or task."> <span title="LUCENE-2573: Tiered flushing of DWPTs by RAM with low/high water marks"> <a href="/jira/browse/LUCENE-2573" data-issue-key="LUCENE-2573" class="issue-link link-title resolution">LUCENE-2573</a> <span class="link-summary">Tiered flushing of DWPTs by RAM with low/high water marks</span> </span> </p> 
                    <ul class="link-snapshot"> 
                     <li class="priority"> <img src="/jira/images/icons/priorities/minor.svg" width="16" height="16" title="Minor - Minor loss of function, or other problem where easy workaround is present." alt="Minor - Minor loss of function, or other problem where easy workaround is present."> </li> 
                     <li class="status"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done aui-lozenge-subtle jira-issue-status-lozenge-max-width-short" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Resolved</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.</span>">Resolved</span> </li> 
                    </ul> 
                   </div> 
                  </dd> 
                 </dl> 
                 <div id="show-more-links"> 
                  <button class="aui-button aui-button-link" id="show-more-links-link">Show 1 more links</button> 
                  <span>(1 relates to)</span> 
                 </div> 
                </div> 
               </div>
              </div>
              <div id="activitymodule" class="module toggle-wrap">
               <div id="activitymodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Activity</h2>
               </div>
               <div class="mod-content"> 
                <big-pipe data-id="activity-panel-pipe-id" style="height: 70px"> 
                 <div></div> 
                </big-pipe> 
               </div>
              </div>
             </div>
             <div id="viewissuesidebar" class="aui-item issue-side-column">
              <div id="peoplemodule" class="module toggle-wrap">
               <div id="peoplemodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">People</h2>
               </div>
               <div class="mod-content"> 
                <ul class="item-details" id="peopledetails"> 
                 <li class="people-details"> 
                  <dl> 
                   <dt>
                    Assignee:
                   </dt> 
                   <dd> 
                    <span id="assignee-val" class="view-issue-field"> <span class="user-hover" id="issue_summary_assignee_michaelbusch" rel="michaelbusch" data-user="{&quot;avatarUrl&quot;:&quot;https://issues.apache.org/jira/secure/useravatar?size=xsmall&amp;avatarId=10452&quot;,&quot;displayName&quot;:&quot;Michael Busch&quot;,&quot;emailAddress&quot;:&quot;buschmic@gmail.com&quot;,&quot;username&quot;:&quot;michaelbusch&quot;}"> <span class="aui-avatar aui-avatar-small"><span class="aui-avatar-inner"><img src="https://issues.apache.org/jira/secure/useravatar?size=small&amp;avatarId=10452" alt="michaelbusch"></span></span> Michael Busch </span> </span> 
                   </dd> 
                  </dl> 
                  <dl> 
                   <dt>
                    Reporter:
                   </dt> 
                   <dd> 
                    <span id="reporter-val" class="view-issue-field"> <span class="user-hover" id="issue_summary_reporter_michaelbusch" rel="michaelbusch" data-user="{&quot;avatarUrl&quot;:&quot;https://issues.apache.org/jira/secure/useravatar?size=xsmall&amp;avatarId=10452&quot;,&quot;displayName&quot;:&quot;Michael Busch&quot;,&quot;emailAddress&quot;:&quot;buschmic@gmail.com&quot;,&quot;username&quot;:&quot;michaelbusch&quot;}"> <span class="aui-avatar aui-avatar-small"><span class="aui-avatar-inner"><img src="https://issues.apache.org/jira/secure/useravatar?size=small&amp;avatarId=10452" alt="michaelbusch"></span></span> Michael Busch </span> </span> 
                   </dd> 
                  </dl> </li> 
                </ul> 
                <ul class="item-details"> 
                 <li> 
                  <dl> 
                   <dt>
                    Votes:
                   </dt> 
                   <dd> 
                    <span id="vote-data" class="aui-badge vote-state-off">1</span> 
                    <span id="vote-label" title="You have to be logged in to vote for an issue.">Vote for this issue</span> 
                   </dd> 
                  </dl> 
                  <dl> 
                   <dt>
                    Watchers:
                   </dt> 
                   <dd> 
                    <span id="watcher-data" class="aui-badge watch-state-off">7</span> 
                    <span id="watch-label" title="You have to be logged in to watch an issue.">Start watching this issue</span> 
                   </dd> 
                  </dl> </li> 
                </ul> 
               </div>
              </div>
              <div id="datesmodule" class="module toggle-wrap">
               <div id="datesmodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Dates</h2>
               </div>
               <div class="mod-content"> 
                <ul class="item-details"> 
                 <li> 
                  <dl class="dates"> 
                   <dt>
                    Created:
                   </dt> 
                   <dd class="date user-tz" title="15/Mar/10 05:40"> 
                    <span data-name="Created" id="created-val" data-fieldtype="datetime"> <time class="livestamp" datetime="2010-03-15T05:40:56+0000">15/Mar/10 05:40</time> </span> 
                   </dd> 
                  </dl> 
                  <dl class="dates"> 
                   <dt>
                    Updated:
                   </dt> 
                   <dd class="date user-tz" title="28/Apr/11 15:19"> 
                    <span data-name="Updated" id="updated-val" data-fieldtype="datetime"> <time class="livestamp" datetime="2011-04-28T15:19:55+0000">28/Apr/11 15:19</time> </span> 
                   </dd> 
                  </dl> 
                  <dl class="dates"> 
                   <dt>
                    Resolved:
                   </dt> 
                   <dd class="date user-tz" title="28/Apr/11 15:19"> 
                    <span data-name="Resolved" id="resolutiondate-val" data-fieldtype="datetime"> <time class="livestamp" datetime="2011-04-28T15:19:55+0000">28/Apr/11 15:19</time> </span> 
                   </dd> 
                  </dl> </li> 
                </ul> 
               </div>
              </div>
             </div>
            </div>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div>
     <!-- .aui-page-panel-inner -->
    </div>
    <!-- .aui-page-panel -->
    <div class="issue-navigator-init"></div> 
   </section> 
   <footer id="footer" role="contentinfo"> 
    <section class="footer-body"> 
     <ul class="atlassian-footer"> 
      <li> Atlassian JIRA <a class="seo-link" rel="nofollow" href="https://www.atlassian.com/software/jira">Project Management Software</a> <span id="footer-build-information">(v7.6.3#76005-<span title="8a4e38d34af948780dbf52044e7aafb13a7cae58" data-commit-id="8a4e38d34af948780dbf52044e7aafb13a7cae58}">sha1:8a4e38d</span>)</span> </li> 
      <li> <a id="about-link" rel="nofollow" href="/jira/secure/AboutPage.jspa/secure/AboutPage.jspa">About JIRA</a> </li> 
      <li> <a id="footer-report-problem-link" rel="nofollow" href="/jira/secure/CreateIssue!default.jspa">Report a problem</a> </li> 
     </ul> 
     <ul class="atlassian-footer"> 
      <li class="licensemessage"> Powered by a free Atlassian <a rel="nofollow" href="http://www.atlassian.com/software/jira">JIRA</a> open source license for n/a, Apache Software Foundation. Try JIRA - <a rel="nofollow" href="http://www.atlassian.com/software/jira">bug tracking software</a> for <i>your</i> team. </li> 
     </ul> 
     <div id="footer-logo">
      <a rel="nofollow" href="http://www.atlassian.com/">Atlassian</a>
     </div> 
    </section> 
    <fieldset class="hidden parameters"> 
     <input type="hidden" title="loggedInUser" value=""> 
     <input type="hidden" title="ajaxTimeout" value="The call to the JIRA server did not complete within the timeout period.  We are unsure of the result of this operation."> 
     <input type="hidden" title="JiraVersion" value="7.6.3"> 
     <input type="hidden" title="ajaxUnauthorised" value="You are not authorised to perform this operation. Please log in."> 
     <input type="hidden" title="baseURL" value="https://issues.apache.org/jira"> 
     <input type="hidden" title="ajaxCommsError" value="The JIRA server could not be contacted. This may be a temporary glitch or the server may be down. "> 
     <input type="hidden" title="ajaxServerError" value="The JIRA server was contacted but has returned an error response. We are unsure of the result of this operation."> 
     <input type="hidden" title="ajaxErrorCloseDialog" value="Close this dialog and press refresh in your browser"> 
     <input type="hidden" title="ajaxErrorDialogHeading" value="Communications Breakdown"> 
     <input type="hidden" title="dirtyMessage" value="You have entered new data on this page. If you navigate away from this page without first saving your data, the changes will be lost."> 
     <input type="hidden" title="dirtyDialogMessage" value="You have entered new data in this dialog. If you navigate away from this dialog without first saving your data, the changes will be lost. Click cancel to return to the dialog."> 
     <input type="hidden" title="keyType" value="Type"> 
     <input type="hidden" title="keyThen" value="then"> 
     <input type="hidden" title="dblClickToExpand" value="Double click to expand"> 
     <input type="hidden" title="actions" value="Actions"> 
     <input type="hidden" title="removeItem" value="Remove"> 
     <input type="hidden" title="workflow" value="Workflow"> 
     <input type="hidden" title="labelNew" value="New Label"> 
     <input type="hidden" title="issueActionsHint" value="Begin typing for available operations or press down to see all"> 
     <input type="hidden" title="closelink" value="Close"> 
     <input type="hidden" title="dotOperations" value="Operations"> 
     <input type="hidden" title="dotLoading" value="Loading..."> 
     <input type="hidden" title="frotherSuggestions" value="Suggestions"> 
     <input type="hidden" title="frotherNomatches" value="No Matches"> 
     <input type="hidden" title="multiselectVersionsError" value="{0} is not a valid version."> 
     <input type="hidden" title="multiselectComponentsError" value="{0} is not a valid component."> 
     <input type="hidden" title="multiselectGenericError" value="The value {0} is invalid."> 
    </fieldset> 
   </footer> 
  </div> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:bigpipe-js/jira.webresources:bigpipe-js.js" data-wrm-key="jira.webresources:bigpipe-js" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["activity-panel-pipe-id"]="\"\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n    \u003cdiv class=\\\"tabwrap tabs2\\\"\u003e\\n\\n        \u003cul id=\\\"issue-tabs\\\" class=\\\"tabs horizontal\\\"\u003e\\n                                \\n            \u003cli  data-id=\\\"all-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel\\\" data-label=\\\"All\\\" data-href=\\\"\\/jira\\/browse\\/LUCENE-2324?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"all-tabpanel\\\" href=\\\"\\/jira\\/browse\\/LUCENE-2324?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel\\\"\u003e\u003cstrong\u003eAll\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  class=\\\"active\\\" id=\\\"comment-tabpanel\\\"  data-id=\\\"comment-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel\\\" data-label=\\\"Comments\\\" data-href=\\\"\\/jira\\/browse\\/LUCENE-2324?page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel\\\"\u003e\\n                            \u003cstrong tabindex=\\\"0\\\"\u003eComments\u003c\\/strong\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"worklog-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:worklog-tabpanel\\\" data-label=\\\"Work Log\\\" data-href=\\\"\\/jira\\/browse\\/LUCENE-2324?page=com.atlassian.jira.plugin.system.issuetabpanels:worklog-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"worklog-tabpanel\\\" href=\\\"\\/jira\\/browse\\/LUCENE-2324?page=com.atlassian.jira.plugin.system.issuetabpanels:worklog-tabpanel\\\"\u003e\u003cstrong\u003eWork Log\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"changehistory-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:changehistory-tabpanel\\\" data-label=\\\"History\\\" data-href=\\\"\\/jira\\/browse\\/LUCENE-2324?page=com.atlassian.jira.plugin.system.issuetabpanels:changehistory-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"changehistory-tabpanel\\\" href=\\\"\\/jira\\/browse\\/LUCENE-2324?page=com.atlassian.jira.plugin.system.issuetabpanels:changehistory-tabpanel\\\"\u003e\u003cstrong\u003eHistory\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"activity-stream-issue-tab\\\" data-key=\\\"com.atlassian.streams.streams-jira-plugin:activity-stream-issue-tab\\\" data-label=\\\"Activity\\\" data-href=\\\"\\/jira\\/browse\\/LUCENE-2324?page=com.atlassian.streams.streams-jira-plugin:activity-stream-issue-tab\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"activity-stream-issue-tab\\\" href=\\\"\\/jira\\/browse\\/LUCENE-2324?page=com.atlassian.streams.streams-jira-plugin:activity-stream-issue-tab\\\"\u003e\u003cstrong\u003eActivity\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"transitions-summary-tabpanel\\\" data-key=\\\"com.googlecode.jira-suite-utilities:transitions-summary-tabpanel\\\" data-label=\\\"Transitions\\\" data-href=\\\"\\/jira\\/browse\\/LUCENE-2324?page=com.googlecode.jira-suite-utilities:transitions-summary-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"transitions-summary-tabpanel\\\" href=\\\"\\/jira\\/browse\\/LUCENE-2324?page=com.googlecode.jira-suite-utilities:transitions-summary-tabpanel\\\"\u003e\u003cstrong\u003eTransitions\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                \u003c\\/ul\u003e\\n\\n                    \u003cdiv class=\\\"sortwrap\\\"\u003e\\n                                    \u003ca class=\\\"issue-activity-sort-link ajax-activity-content\\\" rel=\\\"nofollow\\\" data-tab-sort data-order=\\\"desc\\\" href=\\\"\\/jira\\/browse\\/LUCENE-2324?actionOrder=desc\\\" title=\\\"Ascending order - Click to sort in descending order\\\"\u003e\\n                        \u003cspan class=\\\"aui-icon aui-icon-small aui-iconfont-up\\\"\u003eAscending order - Click to sort in descending order\u003c\\/span\u003e\\n                    \u003c\\/a\u003e\\n                            \u003c\\/div\u003e\\n            \u003c\\/div\u003e\\n    \u003cdiv class=\\\"issuePanelWrapper\\\"\u003e\\n        \u003cdiv class=\\\"issuePanelProgress\\\"\u003e\u003c\\/div\u003e\\n        \u003cdiv class=\\\"issuePanelContainer\\\" id=\\\"issue_actions_container\\\"\u003e\\n                                    \\n\\n\\n\u003cdiv id=\\\"comment-12845199\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12845199&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12845199\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12845199_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12845199_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Mar\\/10 06:33\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-15T06:33:31+0000\'\u003e15\\/Mar\\/10 06:33\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHere is an interesting article about allocation\\/deallocation on modern JVMs:\u003cbr\\/\u003e\\n\u003ca href=\\\"http:\\/\\/www.ibm.com\\/developerworks\\/java\\/library\\/j-jtp09275.html\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttp:\\/\\/www.ibm.com\\/developerworks\\/java\\/library\\/j-jtp09275.html\u003c\\/a\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eAnd here is a snippet that mentions how pooling is generally not faster anymore:\u003c\\/p\u003e\\n\\n\u003chr \\/\u003e\\n\u003cp\u003eAllocation in JVMs was not always so fast &#8211; early JVMs indeed had poor allocation and garbage collection performance, which is almost certainly where this myth got started. In the very early days, we saw a lot of \\\"allocation is slow\\\" advice &#8211; because it was, along with everything else in early JVMs &#8211; and performance gurus advocated various tricks to avoid allocation, such as object pooling. (Public service announcement: Object pooling is now a serious performance loss for all but the most heavyweight of objects, and even then it is tricky to get right without introducing concurrency bottlenecks.) However, a lot has happened since the JDK 1.0 days; the introduction of generational collectors in JDK 1.2 has enabled a much simpler approach to allocation, greatly improving performance. \u003c\\/p\u003e\\n\u003chr \\/\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12845199_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12845199_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Mar\\/10 06:33\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-15T06:33:31+0000\'\u003e15\\/Mar\\/10 06:33\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Here is an interesting article about allocation\\/deallocation on modern JVMs: \\n http:\\/\\/www.ibm.com\\/developerworks\\/java\\/library\\/j-jtp09275.html  \\n\\n And here is a snippet that mentions how pooling is generally not faster anymore: \\n\\n \\n Allocation in JVMs was not always so fast &#8211; early JVMs indeed had poor allocation and garbage collection performance, which is almost certainly where this myth got started. In the very early days, we saw a lot of \\\"allocation is slow\\\" advice &#8211; because it was, along with everything else in early JVMs &#8211; and performance gurus advocated various tricks to avoid allocation, such as object pooling. (Public service announcement: Object pooling is now a serious performance loss for all but the most heavyweight of objects, and even then it is tricky to get right without introducing concurrency bottlenecks.) However, a lot has happened since the JDK 1.0 days; the introduction of generational collectors in JDK 1.2 has enabled a much simpler approach to allocation, greatly improving performance.  \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12845261\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12845261&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12845261\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12845261_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12845261_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Mar\\/10 09:47\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-15T09:47:41+0000\'\u003e15\\/Mar\\/10 09:47\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eSounds great &#8211; let\'s test it in practice.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12845261_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12845261_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Mar\\/10 09:47\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-15T09:47:41+0000\'\u003e15\\/Mar\\/10 09:47\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Sounds great &#8211; let\'s test it in practice.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12845398\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12845398&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12845398\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12845398_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12845398_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Mar\\/10 16:33\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-15T16:33:50+0000\'\u003e15\\/Mar\\/10 16:33\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Michael Busch - 15\\/Mar\\/10 16:34\\\"\u003eedited\u003c\\/span\u003e \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eReply to Mike\'s comment on \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2293\\\" title=\\\"IndexWriter has hard limit on max concurrency\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2293\\\"\u003e\u003cdel\u003eLUCENE-2293\u003c\\/del\u003e\u003c\\/a\u003e: \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2293?focusedCommentId=12845263&amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12845263\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttps:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2293?focusedCommentId=12845263&amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12845263\u003c\\/a\u003e\u003c\\/p\u003e\\n\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eI think we can do even better, ie, that class wastes RAM for the single posting case (intStart, byteStart, lastDocID, docFreq, lastDocCode, lastDocPosition are not needed).\u003c\\/p\u003e\\n\\n\u003cp\u003eEG we could have a separate class dedicated to the singleton case. When term is first encountered it\'s enrolled there. We\'d probably need a separate hash to store these (though not necessarily?). If it\'s seen again it\'s switched to the full posting.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eHmm I think we\'d need a separate hash.  Otherwise you have to subclass PostingList for the different cases (freq. vs. non-frequent terms) and do instanceof checks? Or with the parallel arrays idea maybe we could encode more information in the dense ID? E.g. use one bit to indicate if that term occurred more than once. \u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eI mean instead of allocating an instance per unique term, we assign an integer ID (dense, ie, 0, 1, 2...).\u003c\\/p\u003e\\n\\n\u003cp\u003eAnd then we have an array for each member now in FreqProxTermsWriter.PostingList, ie int[] docFreqs, int [] lastDocIDs, etc. Then to look up say the lastDocID for a given postingID you just get lastDocIDs\u003cspan class=\\\"error\\\"\u003e&#91;postingID&#93;\u003c\\/span\u003e. If we\'re worried about oversize allocation overhead, we can make these arrays paged... but that\'d slow down each access.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYeah I like that idea. I\'ve done something similar for representing trees - I had a very compact Node class with no data but such a dense ID, and arrays that stored the associated data.  Very easy to add another data type with no RAM overhead (you only use the amount of RAM the data needs).\u003c\\/p\u003e\\n\\n\u003cp\u003eThough, the price you pay is for dereferencing multiple times for each array?  \u003cbr\\/\u003e\\nAnd how much RAM would we safe? The pointer for the PostingList object (4-8 bytes), plus the size of the object header - how much is that in Java? \u003c\\/p\u003e\\n\\n\u003cp\u003eSeems ilke it\'s 8 bytes: \u003ca href=\\\"http:\\/\\/www.codeinstructions.com\\/2008\\/12\\/java-objects-memory-structure.html\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttp:\\/\\/www.codeinstructions.com\\/2008\\/12\\/java-objects-memory-structure.html\u003c\\/a\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eSo in a 32Bit JVM we would safe 4 bytes (pointer) + 8 bytes (header) - 4 bytes (ID) = 8 bytes.  For fields with tons of unique terms that might be worth it?  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12845398_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12845398_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Mar\\/10 16:33\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-15T16:33:50+0000\'\u003e15\\/Mar\\/10 16:33\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Michael Busch - 15\\/Mar\\/10 16:34\\\"\u003eedited\u003c\\/span\u003e                   Reply to Mike\'s comment on   LUCENE-2293  :  https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2293?focusedCommentId=12845263&amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12845263  \\n\\n\\n \\n I think we can do even better, ie, that class wastes RAM for the single posting case (intStart, byteStart, lastDocID, docFreq, lastDocCode, lastDocPosition are not needed). \\n\\n EG we could have a separate class dedicated to the singleton case. When term is first encountered it\'s enrolled there. We\'d probably need a separate hash to store these (though not necessarily?). If it\'s seen again it\'s switched to the full posting.  \\n\\n Hmm I think we\'d need a separate hash.  Otherwise you have to subclass PostingList for the different cases (freq. vs. non-frequent terms) and do instanceof checks? Or with the parallel arrays idea maybe we could encode more information in the dense ID? E.g. use one bit to indicate if that term occurred more than once.  \\n\\n \\n I mean instead of allocating an instance per unique term, we assign an integer ID (dense, ie, 0, 1, 2...). \\n\\n And then we have an array for each member now in FreqProxTermsWriter.PostingList, ie int[] docFreqs, int [] lastDocIDs, etc. Then to look up say the lastDocID for a given postingID you just get lastDocIDs &#91;postingID&#93; . If we\'re worried about oversize allocation overhead, we can make these arrays paged... but that\'d slow down each access.  \\n\\n Yeah I like that idea. I\'ve done something similar for representing trees - I had a very compact Node class with no data but such a dense ID, and arrays that stored the associated data.  Very easy to add another data type with no RAM overhead (you only use the amount of RAM the data needs). \\n\\n Though, the price you pay is for dereferencing multiple times for each array?   \\nAnd how much RAM would we safe? The pointer for the PostingList object (4-8 bytes), plus the size of the object header - how much is that in Java?  \\n\\n Seems ilke it\'s 8 bytes:  http:\\/\\/www.codeinstructions.com\\/2008\\/12\\/java-objects-memory-structure.html  \\n\\n So in a 32Bit JVM we would safe 4 bytes (pointer) + 8 bytes (header) - 4 bytes (ID) = 8 bytes.  For fields with tons of unique terms that might be worth it?                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12845400\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12845400&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12845400\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12845400_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12845400_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Mar\\/10 16:43\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-15T16:43:31+0000\'\u003e15\\/Mar\\/10 16:43\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eSounds great - let\'s test it in practice.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI have to admit that I need to catch up a bit on the flex branch.  I was wondering if it makes sense to make these kinds of experiments (pooling vs. non-pooling) with the flex code? Is it as fast as trunk already, or are there related nocommits left that affect indexing performance?  I would think not much of the flex changes should affect the in-memory indexing performance (in TermsHash*).\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12845400_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12845400_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Mar\\/10 16:43\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-15T16:43:31+0000\'\u003e15\\/Mar\\/10 16:43\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n Sounds great - let\'s test it in practice.  \\n\\n I have to admit that I need to catch up a bit on the flex branch.  I was wondering if it makes sense to make these kinds of experiments (pooling vs. non-pooling) with the flex code? Is it as fast as trunk already, or are there related nocommits left that affect indexing performance?  I would think not much of the flex changes should affect the in-memory indexing performance (in TermsHash*).              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12845408\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12845408&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12845408\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"earwin\\\" id=\\\"commentauthor_12845408_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=earwin\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"earwin\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Earwin Burrfoot\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12845408_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Mar\\/10 17:05\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-15T17:05:05+0000\'\u003e15\\/Mar\\/10 17:05\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e&gt; Seems ilke it\'s 8 bytes\u003cbr\\/\u003e\\nObject header is two words, so that\'s 16bytes for 64bit arch. (probably 12 for 64bit+CompressedOops?)\u003c\\/p\u003e\\n\\n\u003cp\u003eAlso, GC time is (roughly) linear in number of objects on heap, so replacing single huge array of objects with few huge primitive arrays for their fields does miracles to your GC delays.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"earwin\\\" id=\\\"commentauthor_12845408_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=earwin\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"earwin\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Earwin Burrfoot\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12845408_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Mar\\/10 17:05\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-15T17:05:05+0000\'\u003e15\\/Mar\\/10 17:05\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    &gt; Seems ilke it\'s 8 bytes \\nObject header is two words, so that\'s 16bytes for 64bit arch. (probably 12 for 64bit+CompressedOops?) \\n\\n Also, GC time is (roughly) linear in number of objects on heap, so replacing single huge array of objects with few huge primitive arrays for their fields does miracles to your GC delays.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12845426\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12845426&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12845426\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12845426_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12845426_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Mar\\/10 17:52\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-15T17:52:25+0000\'\u003e15\\/Mar\\/10 17:52\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eHmm I think we\'d need a separate hash. Otherwise you have to subclass PostingList for the different cases (freq. vs. non-frequent terms) and do instanceof checks? Or with the parallel arrays idea maybe we could encode more information in the dense ID? E.g. use one bit to indicate if that term occurred more than once.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eOr 2 sets of parallel arrays (one for the singletons).... or, something.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eSo in a 32Bit JVM we would safe 4 bytes (pointer) + 8 bytes (header) - 4 bytes (ID) = 8 bytes. For fields with tons of unique terms that might be worth it?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eAnd also the GC cost.\u003c\\/p\u003e\\n\\n\u003cp\u003eBut it seems like specializing singleton fields will be the bigger win.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eI was wondering if it makes sense to make these kinds of experiments (pooling vs. non-pooling) with the flex code?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eLast I tested (a while back now) indexing perf was the same &#8211; need to\u003cbr\\/\u003e\\ntest again w\\/ recent changes (eg terms index is switching to packed\u003cbr\\/\u003e\\nints).  For pooling vs not I\'d just do the experiment on trunk?\u003c\\/p\u003e\\n\\n\u003cp\u003eAnd most of this change (changing how postings data is buffered in\u003cbr\\/\u003e\\nRAM) is \\\"above\\\" flex I expect.\u003c\\/p\u003e\\n\\n\u003cp\u003eBut if for some reason you need to start changing index postings\u003cbr\\/\u003e\\nformat then you should probably do that on flex.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12845426_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12845426_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Mar\\/10 17:52\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-15T17:52:25+0000\'\u003e15\\/Mar\\/10 17:52\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     Hmm I think we\'d need a separate hash. Otherwise you have to subclass PostingList for the different cases (freq. vs. non-frequent terms) and do instanceof checks? Or with the parallel arrays idea maybe we could encode more information in the dense ID? E.g. use one bit to indicate if that term occurred more than once.  \\n\\n Or 2 sets of parallel arrays (one for the singletons).... or, something. \\n\\n  So in a 32Bit JVM we would safe 4 bytes (pointer) + 8 bytes (header) - 4 bytes (ID) = 8 bytes. For fields with tons of unique terms that might be worth it?  \\n\\n And also the GC cost. \\n\\n But it seems like specializing singleton fields will be the bigger win. \\n\\n  I was wondering if it makes sense to make these kinds of experiments (pooling vs. non-pooling) with the flex code?  \\n\\n Last I tested (a while back now) indexing perf was the same &#8211; need to \\ntest again w\\/ recent changes (eg terms index is switching to packed \\nints).  For pooling vs not I\'d just do the experiment on trunk? \\n\\n And most of this change (changing how postings data is buffered in \\nRAM) is \\\"above\\\" flex I expect. \\n\\n But if for some reason you need to start changing index postings \\nformat then you should probably do that on flex.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12845428\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12845428&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12845428\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12845428_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12845428_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Mar\\/10 17:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-15T17:57:50+0000\'\u003e15\\/Mar\\/10 17:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cblockquote\u003e\u003cp\u003eSeems ilke it\'s 8 bytes\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eObject header is two words, so that\'s 16bytes for 64bit arch. (probably 12 for 64bit+CompressedOops?)\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eRight, and the pointer\'d also be 8 bytes (but compact int stays at 4\u003cbr\\/\u003e\\nbytes) so net\\/net on 64bit JRE savings would be 16-20 bytes per term.\u003c\\/p\u003e\\n\\n\u003cp\u003eAnother thing we could do if we cutover to parallel arrays is to\u003cbr\\/\u003e\\nswitch to packed ints.  Many of these fields are horribly wasteful as\u003cbr\\/\u003e\\nints, eg docFreq or lastPosition.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12845428_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12845428_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Mar\\/10 17:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-15T17:57:50+0000\'\u003e15\\/Mar\\/10 17:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n  Seems ilke it\'s 8 bytes  \\n\\n Object header is two words, so that\'s 16bytes for 64bit arch. (probably 12 for 64bit+CompressedOops?)  \\n\\n Right, and the pointer\'d also be 8 bytes (but compact int stays at 4 \\nbytes) so net\\/net on 64bit JRE savings would be 16-20 bytes per term. \\n\\n Another thing we could do if we cutover to parallel arrays is to \\nswitch to packed ints.  Many of these fields are horribly wasteful as \\nints, eg docFreq or lastPosition.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12846028\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12846028&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12846028\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12846028_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12846028_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Mar\\/10 17:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-16T17:50:16+0000\'\u003e16\\/Mar\\/10 17:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eCarrying over from \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2312\\\" title=\\\"Search on IndexWriter&#39;s RAM Buffer\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2312\\\"\u003eLUCENE-2312\u003c\\/a\u003e.  I\'m proposing we for starters have a byte slice writer, lock, move or copy\u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/help_16.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e the bytes from the writable byte pool\\/writer to a read only byte block pool, unlock.  This sounds like a fairly self-contained thing that can be unit tested at a low level.\u003c\\/p\u003e\\n\\n\u003cp\u003eMike, can you add a bit as to how this could work?  Also, what is the IntBlockPool used for?  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12846028_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12846028_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Mar\\/10 17:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-16T17:50:16+0000\'\u003e16\\/Mar\\/10 17:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Carrying over from  LUCENE-2312 .  I\'m proposing we for starters have a byte slice writer, lock, move or copy  the bytes from the writable byte pool\\/writer to a read only byte block pool, unlock.  This sounds like a fairly self-contained thing that can be unit tested at a low level. \\n\\n Mike, can you add a bit as to how this could work?  Also, what is the IntBlockPool used for?                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12846037\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12846037&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12846037\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12846037_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12846037_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Mar\\/10 17:59\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-16T17:59:51+0000\'\u003e16\\/Mar\\/10 17:59\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAre there going to be issues with the char array buffers as well (ie, will we need to also flush them for concurrency?)\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12846037_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12846037_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Mar\\/10 17:59\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-16T17:59:51+0000\'\u003e16\\/Mar\\/10 17:59\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Are there going to be issues with the char array buffers as well (ie, will we need to also flush them for concurrency?)              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12846084\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12846084&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12846084\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12846084_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12846084_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Mar\\/10 19:29\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-16T19:29:17+0000\'\u003e16\\/Mar\\/10 19:29\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eShall we not first try to remove the downstream *PerThread classes and make the DocumentsWriter single-threaded without locking.  Then we add a PerThreadDocumentsWriter and DocumentsWriterThreadBinder, which talks to the PerThreadDWs and IW talks to DWTB.  We can pick other names \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eWhen that\'s done we can think about what kind of locking\\/synchronization\\/volatile stuff we need for \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2312\\\" title=\\\"Search on IndexWriter&#39;s RAM Buffer\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2312\\\"\u003eLUCENE-2312\u003c\\/a\u003e.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12846084_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12846084_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Mar\\/10 19:29\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-16T19:29:17+0000\'\u003e16\\/Mar\\/10 19:29\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Shall we not first try to remove the downstream *PerThread classes and make the DocumentsWriter single-threaded without locking.  Then we add a PerThreadDocumentsWriter and DocumentsWriterThreadBinder, which talks to the PerThreadDWs and IW talks to DWTB.  We can pick other names   \\n\\n When that\'s done we can think about what kind of locking\\/synchronization\\/volatile stuff we need for  LUCENE-2312 .              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12846102\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12846102&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12846102\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12846102_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12846102_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Mar\\/10 20:18\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-16T20:18:22+0000\'\u003e16\\/Mar\\/10 20:18\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eMichael,\u003c\\/p\u003e\\n\\n\u003cp\u003eFor \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2312\\\" title=\\\"Search on IndexWriter&#39;s RAM Buffer\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2312\\\"\u003eLUCENE-2312\u003c\\/a\u003e, I think the searching isn\'t going to be an\u003cbr\\/\u003e\\nissue, I\'ve got basic per thread doc writers working (though not\u003cbr\\/\u003e\\nthoroughly tested). I didn\'t see a great need to rework all the\u003cbr\\/\u003e\\nclasses, which even if we did, I\'m not sure helps with the byte\u003cbr\\/\u003e\\narray read write issues? I\'d prefer to get a proof of concept\u003cbr\\/\u003e\\nmore or less working, then refine it from there. I think there\'s\u003cbr\\/\u003e\\ntwo main design\\/implementation issues before we can roll\u003cbr\\/\u003e\\nsomething out:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) A new skip list implementation that at specific intervals\u003cbr\\/\u003e\\nwrites a new skip (ie, single level). Right now in trunk we have\u003cbr\\/\u003e\\na multilevel skiplist that requires ahead of time the number of\u003cbr\\/\u003e\\ndocs.\u003c\\/p\u003e\\n\\n\u003cp\u003e2) Figure out the low -&gt; high levels of byte\\/char\\/int array\u003cbr\\/\u003e\\nvisibility to reader threads. The main challenge here is the\u003cbr\\/\u003e\\nfact that the DW related code that utilizes this is really hard\u003cbr\\/\u003e\\nfor me to understand enough to know what can be changed, without\u003cbr\\/\u003e\\nthe side effect being bunches of other broken stuff. If there\u003cbr\\/\u003e\\nwas a Directory like class abstraction we could simply override\u003cbr\\/\u003e\\nand reimplement, we could do that, and maybe there is one, I\'m\u003cbr\\/\u003e\\nnot sure yet. \u003c\\/p\u003e\\n\\n\u003cp\u003eHowever if reworking the PerThread classes somehow makes the tie\u003cbr\\/\u003e\\ninto the IO (eg, the byte array pooling) system abstracted and\u003cbr\\/\u003e\\neasier, then I\'m all for it.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12846102_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12846102_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Mar\\/10 20:18\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-16T20:18:22+0000\'\u003e16\\/Mar\\/10 20:18\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Michael, \\n\\n For  LUCENE-2312 , I think the searching isn\'t going to be an \\nissue, I\'ve got basic per thread doc writers working (though not \\nthoroughly tested). I didn\'t see a great need to rework all the \\nclasses, which even if we did, I\'m not sure helps with the byte \\narray read write issues? I\'d prefer to get a proof of concept \\nmore or less working, then refine it from there. I think there\'s \\ntwo main design\\/implementation issues before we can roll \\nsomething out: \\n\\n 1) A new skip list implementation that at specific intervals \\nwrites a new skip (ie, single level). Right now in trunk we have \\na multilevel skiplist that requires ahead of time the number of \\ndocs. \\n\\n 2) Figure out the low -&gt; high levels of byte\\/char\\/int array \\nvisibility to reader threads. The main challenge here is the \\nfact that the DW related code that utilizes this is really hard \\nfor me to understand enough to know what can be changed, without \\nthe side effect being bunches of other broken stuff. If there \\nwas a Directory like class abstraction we could simply override \\nand reimplement, we could do that, and maybe there is one, I\'m \\nnot sure yet.  \\n\\n However if reworking the PerThread classes somehow makes the tie \\ninto the IO (eg, the byte array pooling) system abstracted and \\neasier, then I\'m all for it.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12846110\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12846110&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12846110\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12846110_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12846110_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Mar\\/10 20:45\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-16T20:45:41+0000\'\u003e16\\/Mar\\/10 20:45\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eNormsWriterPerField has a growing norm byte array, we\'d need a way to read\\/write lock it... \u003c\\/p\u003e\\n\\n\u003cp\u003eI think we have concurrency issues in the TermsHash table?  Maybe it\'d need to be rewritten to use ConcurrentHashMap?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12846110_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12846110_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Mar\\/10 20:45\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-16T20:45:41+0000\'\u003e16\\/Mar\\/10 20:45\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    NormsWriterPerField has a growing norm byte array, we\'d need a way to read\\/write lock it...  \\n\\n I think we have concurrency issues in the TermsHash table?  Maybe it\'d need to be rewritten to use ConcurrentHashMap?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12846112\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12846112&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12846112\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12846112_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12846112_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Mar\\/10 20:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-16T20:50:09+0000\'\u003e16\\/Mar\\/10 20:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eActually TermsHashField doesn\'t need to be concurrent, it\'s only being written to and the terms concurrent skiplist (was a btree) holds the reference to the posting list.  So I think we\'re good there because terms enum never accesses the terms hash.  Nice!\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12846112_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12846112_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Mar\\/10 20:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-16T20:50:09+0000\'\u003e16\\/Mar\\/10 20:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Actually TermsHashField doesn\'t need to be concurrent, it\'s only being written to and the terms concurrent skiplist (was a btree) holds the reference to the posting list.  So I think we\'re good there because terms enum never accesses the terms hash.  Nice! \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12846128\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12846128&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12846128\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12846128_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12846128_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Mar\\/10 21:13\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-16T21:13:17+0000\'\u003e16\\/Mar\\/10 21:13\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI think we all agree that we want to have a single writer thread, multi reader thread model.  Only then the thread-safety problems in \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2312\\\" title=\\\"Search on IndexWriter&#39;s RAM Buffer\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2312\\\"\u003eLUCENE-2312\u003c\\/a\u003e can be reduced to visibility (no write-locking).  So I think making this change first makes most sense.  It involves a bit boring refactoring work unfortunately. \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12846128_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12846128_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Mar\\/10 21:13\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-16T21:13:17+0000\'\u003e16\\/Mar\\/10 21:13\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I think we all agree that we want to have a single writer thread, multi reader thread model.  Only then the thread-safety problems in  LUCENE-2312  can be reduced to visibility (no write-locking).  So I think making this change first makes most sense.  It involves a bit boring refactoring work unfortunately.               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12846220\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12846220&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12846220\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12846220_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12846220_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Mar\\/10 00:04\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-17T00:04:24+0000\'\u003e17\\/Mar\\/10 00:04\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eMichael, Agreed, can you outline how you think we should proceed then?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12846220_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12846220_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Mar\\/10 00:04\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-17T00:04:24+0000\'\u003e17\\/Mar\\/10 00:04\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Michael, Agreed, can you outline how you think we should proceed then?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12846586\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12846586&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12846586\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12846586_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12846586_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Mar\\/10 21:06\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-17T21:06:57+0000\'\u003e17\\/Mar\\/10 21:06\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eMichael, Agreed, can you outline how you think we should proceed then?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eSorry for not responding earlier...\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'m currently working on removing the PostingList object pooling, because it makes TermsHash and TermsHashPerThread much easier.  Have written the patch and all tests pass, though I haven\'t done performance testing yet.  Making TermsHash and TermsHashPerThread smaller will also make the patch here easier which will remove them. I\'ll post the patch soon. \u003c\\/p\u003e\\n\\n\u003cp\u003eNext steps I think here are to make everything downstream of DocumentsWriter single-threaded (removal of *PerThread) classes.  Then we need to write the DocumentsWriterThreadBinder and have to think about how to apply deletes, commits and rollbacks to all DocumentsWriter instances.  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12846586_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12846586_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Mar\\/10 21:06\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-17T21:06:57+0000\'\u003e17\\/Mar\\/10 21:06\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     Michael, Agreed, can you outline how you think we should proceed then?  \\n\\n Sorry for not responding earlier... \\n\\n I\'m currently working on removing the PostingList object pooling, because it makes TermsHash and TermsHashPerThread much easier.  Have written the patch and all tests pass, though I haven\'t done performance testing yet.  Making TermsHash and TermsHashPerThread smaller will also make the patch here easier which will remove them. I\'ll post the patch soon.  \\n\\n Next steps I think here are to make everything downstream of DocumentsWriter single-threaded (removal of *PerThread) classes.  Then we need to write the DocumentsWriterThreadBinder and have to think about how to apply deletes, commits and rollbacks to all DocumentsWriter instances.                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12846591\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12846591&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12846591\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12846591_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12846591_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Mar\\/10 21:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-17T21:12:28+0000\'\u003e17\\/Mar\\/10 21:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAll tests pass but I have to review if with the changes the memory consumption calculation still works correctly. Not sure if the junits test that?\u003c\\/p\u003e\\n\\n\u003cp\u003eAlso haven\'t done any performance testing yet.  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12846591_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12846591_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Mar\\/10 21:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-17T21:12:28+0000\'\u003e17\\/Mar\\/10 21:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    All tests pass but I have to review if with the changes the memory consumption calculation still works correctly. Not sure if the junits test that? \\n\\n Also haven\'t done any performance testing yet.                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12849806\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12849806&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12849806\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12849806_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12849806_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Mar\\/10 17:56\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-25T17:56:22+0000\'\u003e25\\/Mar\\/10 17:56\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eMichael, I\'m guessing this patch needs to be updated as per \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2329\\\" title=\\\"Use parallel arrays instead of PostingList objects\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2329\\\"\u003e\u003cdel\u003eLUCENE-2329\u003c\\/del\u003e\u003c\\/a\u003e?  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12849806_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12849806_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Mar\\/10 17:56\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-25T17:56:22+0000\'\u003e25\\/Mar\\/10 17:56\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Michael, I\'m guessing this patch needs to be updated as per   LUCENE-2329  ?                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12849808\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12849808&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12849808\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12849808_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12849808_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Mar\\/10 18:03\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-25T18:03:30+0000\'\u003e25\\/Mar\\/10 18:03\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eActually, I just browsed the patch again, I don\'t think it implements private doc writers as of yet?  \u003c\\/p\u003e\\n\\n\u003cp\u003eI think you\'re right, we can get this issue completed.  \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2312\\\" title=\\\"Search on IndexWriter&#39;s RAM Buffer\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2312\\\"\u003eLUCENE-2312\u003c\\/a\u003e\'s path looks clear at this point.  Shall I take a whack at it?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12849808_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12849808_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Mar\\/10 18:03\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-25T18:03:30+0000\'\u003e25\\/Mar\\/10 18:03\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Actually, I just browsed the patch again, I don\'t think it implements private doc writers as of yet?   \\n\\n I think you\'re right, we can get this issue completed.   LUCENE-2312 \'s path looks clear at this point.  Shall I take a whack at it?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12849819\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12849819&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12849819\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12849819_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12849819_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Mar\\/10 18:27\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-25T18:27:36+0000\'\u003e25\\/Mar\\/10 18:27\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHey Jason,\u003c\\/p\u003e\\n\\n\u003cp\u003eDisregard my patch here.  I just experimented with removal of pooling, but then did \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2329\\\" title=\\\"Use parallel arrays instead of PostingList objects\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2329\\\"\u003e\u003cdel\u003eLUCENE-2329\u003c\\/del\u003e\u003c\\/a\u003e instead.  TermsHash and TermsHashPerThread are now much simpler, because all the pooling code is gone after 2329 was committed.  Should make it a little easier to get this patch done.\u003c\\/p\u003e\\n\\n\u003cp\u003eSure it\'d be awesome if you could provide a patch here.  I can help you, we should just frequently post patches here so that we don\'t both work on the same areas.\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12849819_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12849819_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Mar\\/10 18:27\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-25T18:27:36+0000\'\u003e25\\/Mar\\/10 18:27\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Hey Jason, \\n\\n Disregard my patch here.  I just experimented with removal of pooling, but then did   LUCENE-2329   instead.  TermsHash and TermsHashPerThread are now much simpler, because all the pooling code is gone after 2329 was committed.  Should make it a little easier to get this patch done. \\n\\n Sure it\'d be awesome if you could provide a patch here.  I can help you, we should just frequently post patches here so that we don\'t both work on the same areas. \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12849844\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12849844&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12849844\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12849844_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12849844_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Mar\\/10 19:01\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-25T19:01:15+0000\'\u003e25\\/Mar\\/10 19:01\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eMichael, I\'m working on a patch and will post one (hopefully) shortly.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12849844_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12849844_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Mar\\/10 19:01\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-25T19:01:15+0000\'\u003e25\\/Mar\\/10 19:01\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Michael, I\'m working on a patch and will post one (hopefully) shortly.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12849899\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12849899&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12849899\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12849899_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12849899_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Mar\\/10 21:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-25T21:00:30+0000\'\u003e25\\/Mar\\/10 21:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAwesome!\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12849899_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12849899_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Mar\\/10 21:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-25T21:00:30+0000\'\u003e25\\/Mar\\/10 21:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Awesome!              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12849965\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12849965&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12849965\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12849965_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12849965_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 00:47\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T00:47:08+0000\'\u003e26\\/Mar\\/10 00:47\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI\'m a little confused in the flushedDocCount, remap deletes conversion portions of DocWriter.  flushedDocCount is used as a global counter, however when we move to per thread doc writers, it won\'t be global anymore.  Is there a different (easier) way to perform remap deletes?  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12849965_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12849965_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 00:47\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T00:47:08+0000\'\u003e26\\/Mar\\/10 00:47\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I\'m a little confused in the flushedDocCount, remap deletes conversion portions of DocWriter.  flushedDocCount is used as a global counter, however when we move to per thread doc writers, it won\'t be global anymore.  Is there a different (easier) way to perform remap deletes?                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850056\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850056&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850056\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12850056_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850056_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 09:47\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T09:47:46+0000\'\u003e26\\/Mar\\/10 09:47\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eGood question...\u003c\\/p\u003e\\n\\n\u003cp\u003eWhen we buffer delete Term\\/Query we record the current docID as of when that delete had arrived (so that interleaved delete\\/adds are resolved properly).  The docID we record is \\\"absolute\\\" (ie, adds in the base flushedDocCount), so that we can decouple when deletes are materialized (moved into the deletedDocs BitVectors) from when new segments are flushed.\u003c\\/p\u003e\\n\\n\u003cp\u003eI think we have a couple options.\u003c\\/p\u003e\\n\\n\u003cp\u003eOption 1 is to use a relative (within the current segment) docID when the deleted Term\\/Query\\/docID is first buffered, but then make it absolute only when the segment is finally flushed.\u003c\\/p\u003e\\n\\n\u003cp\u003eOption 2 is to use a relative docID, but do away with the decoupling, ie force deletions to always flush at the same time the segment is flushed.\u003c\\/p\u003e\\n\\n\u003cp\u003eI think I like option 1 the best &#8211; I suspect the decoupling gains us performance as it allows us to batch up more deletions (doing deletions in batch gets better locality, and also means opening\\/closing readers left often, in the non-pooling case).\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12850056_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850056_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 09:47\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T09:47:46+0000\'\u003e26\\/Mar\\/10 09:47\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Good question... \\n\\n When we buffer delete Term\\/Query we record the current docID as of when that delete had arrived (so that interleaved delete\\/adds are resolved properly).  The docID we record is \\\"absolute\\\" (ie, adds in the base flushedDocCount), so that we can decouple when deletes are materialized (moved into the deletedDocs BitVectors) from when new segments are flushed. \\n\\n I think we have a couple options. \\n\\n Option 1 is to use a relative (within the current segment) docID when the deleted Term\\/Query\\/docID is first buffered, but then make it absolute only when the segment is finally flushed. \\n\\n Option 2 is to use a relative docID, but do away with the decoupling, ie force deletions to always flush at the same time the segment is flushed. \\n\\n I think I like option 1 the best &#8211; I suspect the decoupling gains us performance as it allows us to batch up more deletions (doing deletions in batch gets better locality, and also means opening\\/closing readers left often, in the non-pooling case).              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850211\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850211&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850211\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12850211_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850211_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 16:54\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T16:54:32+0000\'\u003e26\\/Mar\\/10 16:54\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eMike, lets do option 1.  I think the process of making the doc id absolute is simply adding up the previous segments num docs to be the base?  \u003c\\/p\u003e\\n\\n\u003cp\u003eOption 2 would use reader cloning?\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12850211_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850211_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 16:54\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T16:54:32+0000\'\u003e26\\/Mar\\/10 16:54\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Mike, lets do option 1.  I think the process of making the doc id absolute is simply adding up the previous segments num docs to be the base?   \\n\\n Option 2 would use reader cloning? \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850214\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850214&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850214\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12850214_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850214_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 16:59\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T16:59:58+0000\'\u003e26\\/Mar\\/10 16:59\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eI think the process of making the doc id absolute is simply adding up the previous segments num docs to be the base?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eRight.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eOption 2 would use reader cloning?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI don\'t think so &#8211; I think it\'d have to pull a SegmentReader for every segment every time we flush a new segment, to resolve the deletions.  In the non-pooled case that\'d be a newly opened SegmentReader for every segment in the index every time a new segment is flushed.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12850214_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850214_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 16:59\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T16:59:58+0000\'\u003e26\\/Mar\\/10 16:59\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     I think the process of making the doc id absolute is simply adding up the previous segments num docs to be the base?  \\n\\n Right. \\n\\n  Option 2 would use reader cloning?  \\n\\n I don\'t think so &#8211; I think it\'d have to pull a SegmentReader for every segment every time we flush a new segment, to resolve the deletions.  In the non-pooled case that\'d be a newly opened SegmentReader for every segment in the index every time a new segment is flushed.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850223\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850223&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850223\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12850223_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850223_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 17:15\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T17:15:24+0000\'\u003e26\\/Mar\\/10 17:15\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eCurrently the doc writer manages the ram buffer size, however\u003cbr\\/\u003e\\nthis needs to be implemented across doc writers for this issue\u003cbr\\/\u003e\\nto be complete. IW addDoc returns doFlush from DW. I don\'t think\u003cbr\\/\u003e\\ndoFlush will be useful anymore?\u003c\\/p\u003e\\n\\n\u003cp\u003eA slightly different memory management needs to be designed.\u003cbr\\/\u003e\\nRight now we allow the user to set the max ram buffer size and\u003cbr\\/\u003e\\nwhen the doc writer\'s buffers exceed the ram limit, the buffer\u003cbr\\/\u003e\\nis flushed and the process is complete.\u003c\\/p\u003e\\n\\n\u003cp\u003eWith this issue, the flush logic probably needs to be bumped up\u003cbr\\/\u003e\\ninto IW, and flushing becomes a multi-docwriter ram usage\u003cbr\\/\u003e\\nexamination. For starters, if the aggregate ram usage of all doc\u003cbr\\/\u003e\\nwriters exceeds the IWC defined ram buffer size, we need to\u003cbr\\/\u003e\\nschedule flushing the doc writer with the greatest ram usage? I\u003cbr\\/\u003e\\nwonder if there\'s something I\'m missing here in regards to\u003cbr\\/\u003e\\nsynchronization issues with DW?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12850223_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850223_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 17:15\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T17:15:24+0000\'\u003e26\\/Mar\\/10 17:15\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Currently the doc writer manages the ram buffer size, however \\nthis needs to be implemented across doc writers for this issue \\nto be complete. IW addDoc returns doFlush from DW. I don\'t think \\ndoFlush will be useful anymore? \\n\\n A slightly different memory management needs to be designed. \\nRight now we allow the user to set the max ram buffer size and \\nwhen the doc writer\'s buffers exceed the ram limit, the buffer \\nis flushed and the process is complete. \\n\\n With this issue, the flush logic probably needs to be bumped up \\ninto IW, and flushing becomes a multi-docwriter ram usage \\nexamination. For starters, if the aggregate ram usage of all doc \\nwriters exceeds the IWC defined ram buffer size, we need to \\nschedule flushing the doc writer with the greatest ram usage? I \\nwonder if there\'s something I\'m missing here in regards to \\nsynchronization issues with DW?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850227\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850227&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850227\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12850227_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850227_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 17:26\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T17:26:04+0000\'\u003e26\\/Mar\\/10 17:26\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eFollowing up on the previous comment, if the current thread (the one calling add doc) is also the one that needs to do the flushing, then only the thread attached to the doc writer with the greatest ram usage can\\/should do the flushing?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12850227_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850227_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 17:26\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T17:26:04+0000\'\u003e26\\/Mar\\/10 17:26\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Following up on the previous comment, if the current thread (the one calling add doc) is also the one that needs to do the flushing, then only the thread attached to the doc writer with the greatest ram usage can\\/should do the flushing?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850235\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850235&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850235\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12850235_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850235_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 17:34\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T17:34:16+0000\'\u003e26\\/Mar\\/10 17:34\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThe easiest would be if each DocumentsWriterPerThread had a fixed buffer size, then they can flush fully independently and you don\'t need to manage RAM globally across threads.\u003c\\/p\u003e\\n\\n\u003cp\u003eOf course then you\'d need two config parameters: number of concurrent threads and buffer size per thread.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12850235_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850235_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 17:34\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T17:34:16+0000\'\u003e26\\/Mar\\/10 17:34\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    The easiest would be if each DocumentsWriterPerThread had a fixed buffer size, then they can flush fully independently and you don\'t need to manage RAM globally across threads. \\n\\n Of course then you\'d need two config parameters: number of concurrent threads and buffer size per thread.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850244\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850244&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850244\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12850244_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850244_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 17:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T17:41:41+0000\'\u003e26\\/Mar\\/10 17:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eBut if 1 thread tends to index lots of biggish docs... don\'t we want to allow it to use up more than 1\\/nth?\u003c\\/p\u003e\\n\\n\u003cp\u003eIe we don\'t want to flush unless total RAM usage has hit the limit?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12850244_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850244_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 17:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T17:41:41+0000\'\u003e26\\/Mar\\/10 17:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    But if 1 thread tends to index lots of biggish docs... don\'t we want to allow it to use up more than 1\\/nth? \\n\\n Ie we don\'t want to flush unless total RAM usage has hit the limit?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850253\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850253&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850253\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12850253_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850253_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 17:52\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T17:52:22+0000\'\u003e26\\/Mar\\/10 17:52\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eOf course then you\'d need two config parameters: number of\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\u003cp\u003econcurrent threads and buffer size per thread.\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'m not sure how we\'d enforce the number of threads? Or we\'d\u003cbr\\/\u003e\\nhave to re-implement the wait system implemented in DW? In\u003cbr\\/\u003e\\npractice, each thread\'s DW will probably have roughly the same\u003cbr\\/\u003e\\nram buffer size so if they each have the same max size, that\'d\u003cbr\\/\u003e\\nbe ok. I don\'t think we can limit the number of threads though,\u003cbr\\/\u003e\\nbecause we\'d need to then implement interleaving doc ids? \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12850253_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850253_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 17:52\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T17:52:22+0000\'\u003e26\\/Mar\\/10 17:52\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     Of course then you\'d need two config parameters: number of  \\n concurrent threads and buffer size per thread. \\n\\n I\'m not sure how we\'d enforce the number of threads? Or we\'d \\nhave to re-implement the wait system implemented in DW? In \\npractice, each thread\'s DW will probably have roughly the same \\nram buffer size so if they each have the same max size, that\'d \\nbe ok. I don\'t think we can limit the number of threads though, \\nbecause we\'d need to then implement interleaving doc ids?               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850260\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850260&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850260\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12850260_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850260_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 18:01\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T18:01:19+0000\'\u003e26\\/Mar\\/10 18:01\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAlso, I think we can remove the sync on doFlushInternal?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12850260_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850260_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 18:01\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T18:01:19+0000\'\u003e26\\/Mar\\/10 18:01\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Also, I think we can remove the sync on doFlushInternal?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850262\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850262&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850262\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12850262_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850262_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 18:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T18:02:50+0000\'\u003e26\\/Mar\\/10 18:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eBut if 1 thread tends to index lots of biggish docs... don\'t we want to allow it to use up more than 1\\/nth?\u003cbr\\/\u003e\\nIe we don\'t want to flush unless total RAM usage has hit the limit?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eSure that\'d be the disadvantage.  But is that a realistic scenario?  That the \\\"avg. document size per thread\\\" differ significantly in an application?  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12850262_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850262_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 18:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T18:02:50+0000\'\u003e26\\/Mar\\/10 18:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n But if 1 thread tends to index lots of biggish docs... don\'t we want to allow it to use up more than 1\\/nth? \\nIe we don\'t want to flush unless total RAM usage has hit the limit?  \\n\\n Sure that\'d be the disadvantage.  But is that a realistic scenario?  That the \\\"avg. document size per thread\\\" differ significantly in an application?                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850265\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850265&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850265\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12850265_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850265_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 18:06\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T18:06:33+0000\'\u003e26\\/Mar\\/10 18:06\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eI\'m not sure how we\'d enforce the number of threads? Or we\'d\u003cbr\\/\u003e\\nhave to re-implement the wait system implemented in DW? \u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI was thinking we were going to do that... having a fixed number of DocumentsWriterPerThread instances, and a ThreadBinder that let\'s a thread wait if the perthread is not available.  You don\'t need to interleave docIds then?  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12850265_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850265_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 18:06\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T18:06:33+0000\'\u003e26\\/Mar\\/10 18:06\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n I\'m not sure how we\'d enforce the number of threads? Or we\'d \\nhave to re-implement the wait system implemented in DW?   \\n\\n I was thinking we were going to do that... having a fixed number of DocumentsWriterPerThread instances, and a ThreadBinder that let\'s a thread wait if the perthread is not available.  You don\'t need to interleave docIds then?                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850290\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850290&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850290\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12850290_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850290_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 18:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T18:35:43+0000\'\u003e26\\/Mar\\/10 18:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eBut is that a realistic scenario? That the \\\"avg. document size per thread\\\" differ significantly in an application?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI think this could happen, eg if an app uses different threads for indexing different sources of docs.  Not all apps index only 140 character docs from all threads \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/wink.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eI think for this same reason the ThreadBinder should have affinity, ie, try to schedule the same thread to the same DW, assuming it\'s free.  If it\'s not free and another DW is free you should use the other one.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12850290_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850290_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 18:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T18:35:43+0000\'\u003e26\\/Mar\\/10 18:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     But is that a realistic scenario? That the \\\"avg. document size per thread\\\" differ significantly in an application?  \\n\\n I think this could happen, eg if an app uses different threads for indexing different sources of docs.  Not all apps index only 140 character docs from all threads   \\n\\n I think for this same reason the ThreadBinder should have affinity, ie, try to schedule the same thread to the same DW, assuming it\'s free.  If it\'s not free and another DW is free you should use the other one.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850292\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850292&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850292\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12850292_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850292_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 18:38\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T18:38:11+0000\'\u003e26\\/Mar\\/10 18:38\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eI was thinking we were going to do that... having a fixed number of DocumentsWriterPerThread instances, and a ThreadBinder that let\'s a thread wait if the perthread is not available. You don\'t need to interleave docIds then?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI think we\'d have a fixed max?  And then we\'d create a new DW when all existing ones are in-use and we\'re not yet at the max?\u003c\\/p\u003e\\n\\n\u003cp\u003eEg if it\'s a thread pool of size 50 that\'s indexing, but, the rate of docs is very slow such that in practice only one of these 50 threads is indexing at once, we\'d only use one DW.  And we\'d flush when that DW hits the RAM limit.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12850292_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850292_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 18:38\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T18:38:11+0000\'\u003e26\\/Mar\\/10 18:38\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     I was thinking we were going to do that... having a fixed number of DocumentsWriterPerThread instances, and a ThreadBinder that let\'s a thread wait if the perthread is not available. You don\'t need to interleave docIds then?  \\n\\n I think we\'d have a fixed max?  And then we\'d create a new DW when all existing ones are in-use and we\'re not yet at the max? \\n\\n Eg if it\'s a thread pool of size 50 that\'s indexing, but, the rate of docs is very slow such that in practice only one of these 50 threads is indexing at once, we\'d only use one DW.  And we\'d flush when that DW hits the RAM limit.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850295\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850295&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850295\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12850295_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850295_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 18:42\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T18:42:11+0000\'\u003e26\\/Mar\\/10 18:42\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eYes, doFlushInternal should no longer be sync\'d.  It should have a small sync\'d at the end where it 1) inserts the new SegmentInfo into the in-memory segments, and 2) computes the new base for remapping the deletes.  I think it can then release the sync while it does the remapping of buffered deletes?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12850295_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850295_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 18:42\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T18:42:11+0000\'\u003e26\\/Mar\\/10 18:42\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Yes, doFlushInternal should no longer be sync\'d.  It should have a small sync\'d at the end where it 1) inserts the new SegmentInfo into the in-memory segments, and 2) computes the new base for remapping the deletes.  I think it can then release the sync while it does the remapping of buffered deletes?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850312\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850312&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850312\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12850312_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850312_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 19:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T19:20:54+0000\'\u003e26\\/Mar\\/10 19:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eNot all apps index only 140 character docs from all threads \u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eWhat a luxury! \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eI think for this same reason the ThreadBinder should have affinity, ie, try to schedule the same thread to the same DW, assuming it\'s free. If it\'s not free and another DW is free you should use the other one.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eIf you didn\'t have such an affinity but use a random assignment of DWs to threads, would that balance the RAM usage across DWs without a global RAM management?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12850312_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850312_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 19:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T19:20:54+0000\'\u003e26\\/Mar\\/10 19:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     Not all apps index only 140 character docs from all threads   \\n\\n What a luxury!   \\n\\n \\n I think for this same reason the ThreadBinder should have affinity, ie, try to schedule the same thread to the same DW, assuming it\'s free. If it\'s not free and another DW is free you should use the other one.  \\n\\n If you didn\'t have such an affinity but use a random assignment of DWs to threads, would that balance the RAM usage across DWs without a global RAM management?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850362\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850362&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850362\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12850362_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850362_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 21:32\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T21:32:41+0000\'\u003e26\\/Mar\\/10 21:32\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThe patch is not committable.  \u003c\\/p\u003e\\n\\n\u003cp\u003eThe basics are here.  We can worry about max threads later.  For now there\'s a doc writer per thread.  I still don\'t fully understand remap deletes, so it\'s commented out.  There\'s a flushedDocCount per DW, and a global one in IW.  \u003c\\/p\u003e\\n\\n\u003cp\u003eIWC is accessed directly where possible.\u003c\\/p\u003e\\n\\n\u003cp\u003eWhen running TestIndexWriter, the DW resumeAllThreads assertion fails.\u003c\\/p\u003e\\n\\n\u003cp\u003eIf the total ram buffer size is too large, and the current thread\'s DW is the largest, it\'s flushed.  The next test case can be in regards to the memory management.  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12850362_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850362_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Mar\\/10 21:32\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-26T21:32:41+0000\'\u003e26\\/Mar\\/10 21:32\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    The patch is not committable.   \\n\\n The basics are here.  We can worry about max threads later.  For now there\'s a doc writer per thread.  I still don\'t fully understand remap deletes, so it\'s commented out.  There\'s a flushedDocCount per DW, and a global one in IW.   \\n\\n IWC is accessed directly where possible. \\n\\n When running TestIndexWriter, the DW resumeAllThreads assertion fails. \\n\\n If the total ram buffer size is too large, and the current thread\'s DW is the largest, it\'s flushed.  The next test case can be in regards to the memory management.                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850440\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850440&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850440\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12850440_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850440_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'27\\/Mar\\/10 01:09\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-27T01:09:53+0000\'\u003e27\\/Mar\\/10 01:09\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eIn regards to remap deletes. I looked at buffered deletes in\u003cbr\\/\u003e\\ndepth when implementing \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2047\\\" title=\\\"IndexWriter should immediately resolve deleted docs to docID in near-real-time mode\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2047\\\"\u003eLUCENE-2047\u003c\\/a\u003e. I think deletes are fairly\u003cbr\\/\u003e\\nsimple, though there\'s all this logic to manage them because\u003cbr\\/\u003e\\nthey\'re buffered. I\'m liking deleting in the foreground and\u003cbr\\/\u003e\\nqueuing the deleted doc ids per segment as a way to avoid\u003cbr\\/\u003e\\nremapping absolute doc ids in commit merge. Hopefully this\u003cbr\\/\u003e\\nsimplifies things?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12850440_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850440_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'27\\/Mar\\/10 01:09\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-27T01:09:53+0000\'\u003e27\\/Mar\\/10 01:09\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    In regards to remap deletes. I looked at buffered deletes in \\ndepth when implementing  LUCENE-2047 . I think deletes are fairly \\nsimple, though there\'s all this logic to manage them because \\nthey\'re buffered. I\'m liking deleting in the foreground and \\nqueuing the deleted doc ids per segment as a way to avoid \\nremapping absolute doc ids in commit merge. Hopefully this \\nsimplifies things?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850449\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850449&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850449\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12850449_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850449_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'27\\/Mar\\/10 01:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-27T01:41:33+0000\'\u003e27\\/Mar\\/10 01:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eMike, can you describe the difference between DW\'s deletesInRAM and deletesFlushed?  I have some idea, however maybe some clarification will help.  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12850449_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850449_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'27\\/Mar\\/10 01:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-27T01:41:33+0000\'\u003e27\\/Mar\\/10 01:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Mike, can you describe the difference between DW\'s deletesInRAM and deletesFlushed?  I have some idea, however maybe some clarification will help.                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850500\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850500&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850500\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12850500_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850500_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'27\\/Mar\\/10 09:44\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-27T09:44:35+0000\'\u003e27\\/Mar\\/10 09:44\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI don\'t think we should delete in FG &#8211; I suspect this\'ll give net\\/net worse performance, due to loss of locality.  It also means you must always keep readers available, which is an unnecessary cost for non-NRT apps.\u003c\\/p\u003e\\n\\n\u003cp\u003edeletesInRAM are those deletes done during the current segment.  deletesFlushed absorbs deletesInRAM on successful segment flush.  We have to segregate the two for proper recovery if we fail to flush the RAM buffer, eg say you hit a disk full while flushing a new segment, and then you close your IW successfully.  We have to make sure in that case that deletesInRAM are discarded.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12850500_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850500_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'27\\/Mar\\/10 09:44\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-27T09:44:35+0000\'\u003e27\\/Mar\\/10 09:44\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I don\'t think we should delete in FG &#8211; I suspect this\'ll give net\\/net worse performance, due to loss of locality.  It also means you must always keep readers available, which is an unnecessary cost for non-NRT apps. \\n\\n deletesInRAM are those deletes done during the current segment.  deletesFlushed absorbs deletesInRAM on successful segment flush.  We have to segregate the two for proper recovery if we fail to flush the RAM buffer, eg say you hit a disk full while flushing a new segment, and then you close your IW successfully.  We have to make sure in that case that deletesInRAM are discarded.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850754\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850754&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850754\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12850754_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850754_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Mar\\/10 23:31\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-28T23:31:53+0000\'\u003e28\\/Mar\\/10 23:31\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eI don\'t think we should delete in FG - I suspect this\'ll\u003cbr\\/\u003e\\ngive net\\/net worse performance, due to loss of locality. It also\u003cbr\\/\u003e\\nmeans you must always keep readers available, which is an\u003cbr\\/\u003e\\nunnecessary cost for non-NRT apps. \u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eRight, I agree it\'s best to buffer the deleted terms\\/queries...\u003cbr\\/\u003e\\nThe comments below touch on why this came up as a thought.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003edeletesInRAM are those deletes done during the current\u003cbr\\/\u003e\\nsegment. deletesFlushed absorbs deletesInRAM on successful\u003cbr\\/\u003e\\nsegment flush. We have to segregate the two for proper recovery\u003cbr\\/\u003e\\nif we fail to flush the RAM buffer, eg say you hit a disk full\u003cbr\\/\u003e\\nwhile flushing a new segment, and then you close your IW\u003cbr\\/\u003e\\nsuccessfully. We have to make sure in that case that\u003cbr\\/\u003e\\ndeletesInRAM are discarded. \u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eOk, this helps... \u003c\\/p\u003e\\n\\n\u003cp\u003eThe design issue I\'m running into is the buffered deletes \\\"num\u003cbr\\/\u003e\\nlimit\\\" which seems to be the highest doc id of DW at the time\u003cbr\\/\u003e\\nthe delete docs method is called? Then when apply deletes is\u003cbr\\/\u003e\\ncalled, deletes are made only up to \\\"num limit\\\"? This is to\u003cbr\\/\u003e\\ninsure that documents (with for example a del term) that are\u003cbr\\/\u003e\\nadded after the delete docs call, are not deleted when apply\u003cbr\\/\u003e\\ndeletes is called, unless another call to del docs is made again\u003cbr\\/\u003e\\n(at which point the \\\"num limit\\\" is set to the current DW max doc\u003cbr\\/\u003e\\nid).\u003c\\/p\u003e\\n\\n\u003cp\u003eIf the above is true, in order to not remap deletes on each\u003cbr\\/\u003e\\nmerge, would we need to maintain this \\\"num limit\\\" variable per\u003cbr\\/\u003e\\nDW? I don\'t think the global remap is useful with per thread DWs\u003cbr\\/\u003e\\nbecause a DW could fail, and we wouldn\'t know the order in\u003cbr\\/\u003e\\nsegment infos it could\\/would\'ve been placed? Whereas with a\u003cbr\\/\u003e\\nsingle DW, we know the new segment will be placed last in\u003cbr\\/\u003e\\nsegment infos.\u003c\\/p\u003e\\n\\n\u003cp\u003eWe could maintain a global deleted terms\\/queries queue, but then\u003cbr\\/\u003e\\nwe\'d also need to maintain a term -&gt; \\\"num limit\\\" map per DW? It\u003cbr\\/\u003e\\nseems a bit redundant, but maybe it\'s ok?\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12850754_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850754_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Mar\\/10 23:31\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-28T23:31:53+0000\'\u003e28\\/Mar\\/10 23:31\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     I don\'t think we should delete in FG - I suspect this\'ll \\ngive net\\/net worse performance, due to loss of locality. It also \\nmeans you must always keep readers available, which is an \\nunnecessary cost for non-NRT apps.   \\n\\n Right, I agree it\'s best to buffer the deleted terms\\/queries... \\nThe comments below touch on why this came up as a thought. \\n\\n  deletesInRAM are those deletes done during the current \\nsegment. deletesFlushed absorbs deletesInRAM on successful \\nsegment flush. We have to segregate the two for proper recovery \\nif we fail to flush the RAM buffer, eg say you hit a disk full \\nwhile flushing a new segment, and then you close your IW \\nsuccessfully. We have to make sure in that case that \\ndeletesInRAM are discarded.   \\n\\n Ok, this helps...  \\n\\n The design issue I\'m running into is the buffered deletes \\\"num \\nlimit\\\" which seems to be the highest doc id of DW at the time \\nthe delete docs method is called? Then when apply deletes is \\ncalled, deletes are made only up to \\\"num limit\\\"? This is to \\ninsure that documents (with for example a del term) that are \\nadded after the delete docs call, are not deleted when apply \\ndeletes is called, unless another call to del docs is made again \\n(at which point the \\\"num limit\\\" is set to the current DW max doc \\nid). \\n\\n If the above is true, in order to not remap deletes on each \\nmerge, would we need to maintain this \\\"num limit\\\" variable per \\nDW? I don\'t think the global remap is useful with per thread DWs \\nbecause a DW could fail, and we wouldn\'t know the order in \\nsegment infos it could\\/would\'ve been placed? Whereas with a \\nsingle DW, we know the new segment will be placed last in \\nsegment infos. \\n\\n We could maintain a global deleted terms\\/queries queue, but then \\nwe\'d also need to maintain a term -&gt; \\\"num limit\\\" map per DW? It \\nseems a bit redundant, but maybe it\'s ok? \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850760\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850760&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850760\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12850760_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850760_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Mar\\/10 00:34\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-29T00:34:37+0000\'\u003e29\\/Mar\\/10 00:34\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eYes, we would need to buffer terms\\/queries per DW and also per DW the BufferedDeletes.Num.  The docID spaces in two DWs will be completely independent of each other after this change.\u003c\\/p\u003e\\n\\n\\n\u003cp\u003eOne potential problem that we (I think) even today have is the following: If you index with multiple threads, and then call e.g. deleteDocuments(Term) with one of the indexer threads while you keep adding documents with the other threads, it\'s not clear to the caller when exactly the deleteDocuments(Term) will happen.  It depends on the thread scheduling. \u003c\\/p\u003e\\n\\n\u003cp\u003eGoing back to the idea I mentioned here:\u003cbr\\/\u003e\\n\u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2293?focusedCommentId=12841407&amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12841407\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttps:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2293?focusedCommentId=12841407&amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12841407\u003c\\/a\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eI mentioned the idea of having a sequence ID, that gets incremented on add, delete, update.  What if we had even with separate DWs a global sequence ID?  The sequence ID would tell you unambiguously which action happened when.  The add\\/update\\/delete methods could return the sequenceID that was assigned to that particular action.  \u003c\\/p\u003e\\n\\n\u003cp\u003eThen we could e.g. track the delete terms globally together with the sequenceID of the corresponding delete call, while we still apply deletes during flush.  Since sequenceIDs enforce a strict ordering we can figure out to how many docs per DW we need to apply the delete terms.\u003c\\/p\u003e\\n\\n\u003cp\u003eLater when we switch to real-time deletes (when the RAM is searchable) we will simply store the sequenceIDs in the deletes int[] array which I mentioned in my comment on \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2293\\\" title=\\\"IndexWriter has hard limit on max concurrency\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2293\\\"\u003e\u003cdel\u003eLUCENE-2293\u003c\\/del\u003e\u003c\\/a\u003e.\u003c\\/p\u003e\\n\\n\u003cp\u003eDoes this make sense?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12850760_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850760_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Mar\\/10 00:34\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-29T00:34:37+0000\'\u003e29\\/Mar\\/10 00:34\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Yes, we would need to buffer terms\\/queries per DW and also per DW the BufferedDeletes.Num.  The docID spaces in two DWs will be completely independent of each other after this change. \\n\\n\\n One potential problem that we (I think) even today have is the following: If you index with multiple threads, and then call e.g. deleteDocuments(Term) with one of the indexer threads while you keep adding documents with the other threads, it\'s not clear to the caller when exactly the deleteDocuments(Term) will happen.  It depends on the thread scheduling.  \\n\\n Going back to the idea I mentioned here: \\n https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2293?focusedCommentId=12841407&amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12841407  \\n\\n I mentioned the idea of having a sequence ID, that gets incremented on add, delete, update.  What if we had even with separate DWs a global sequence ID?  The sequence ID would tell you unambiguously which action happened when.  The add\\/update\\/delete methods could return the sequenceID that was assigned to that particular action.   \\n\\n Then we could e.g. track the delete terms globally together with the sequenceID of the corresponding delete call, while we still apply deletes during flush.  Since sequenceIDs enforce a strict ordering we can figure out to how many docs per DW we need to apply the delete terms. \\n\\n Later when we switch to real-time deletes (when the RAM is searchable) we will simply store the sequenceIDs in the deletes int[] array which I mentioned in my comment on   LUCENE-2293  . \\n\\n Does this make sense?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850766\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850766&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850766\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12850766_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850766_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Mar\\/10 00:58\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-29T00:58:40+0000\'\u003e29\\/Mar\\/10 00:58\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eI think for this same reason the ThreadBinder should have affinity\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eMike, can you explain what the advantages of this kind of thread affinity are?  I was always wondering why the DocumentsWriter code currently makes efforts to assign a ThreadState always to the same Thread?  Is that being done for performance reasons?  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12850766_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850766_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Mar\\/10 00:58\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-29T00:58:40+0000\'\u003e29\\/Mar\\/10 00:58\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     I think for this same reason the ThreadBinder should have affinity  \\n\\n Mike, can you explain what the advantages of this kind of thread affinity are?  I was always wondering why the DocumentsWriter code currently makes efforts to assign a ThreadState always to the same Thread?  Is that being done for performance reasons?                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850780\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850780&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850780\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12850780_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850780_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Mar\\/10 02:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-29T02:35:20+0000\'\u003e29\\/Mar\\/10 02:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eI mentioned the idea of having a sequence ID, that gets\u003cbr\\/\u003e\\nincremented on add, delete, update. What if we had even with\u003cbr\\/\u003e\\nseparate DWs a global sequence ID? The sequence ID would tell\u003cbr\\/\u003e\\nyou unambiguously which action happened when. The\u003cbr\\/\u003e\\nadd\\/update\\/delete methods could return the sequenceID that was\u003cbr\\/\u003e\\nassigned to that particular action.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI think adding the global sequence id makes sense and would be\u003cbr\\/\u003e\\nsimple to add (eg, AtomicLong). However, in the apply deletes\u003cbr\\/\u003e\\nmethod how would we know which doc to stop deleting at? How\u003cbr\\/\u003e\\nwould the seq id map to a DW\'s doc id?\u003c\\/p\u003e\\n\\n\u003cp\u003eIf we have independent buffered deletes per DW-thread, then how\u003cbr\\/\u003e\\nwill we keep track of the memory usage? eg, we\'ll be flushing\u003cbr\\/\u003e\\nDWs independently, but will not want to double count the same\u003cbr\\/\u003e\\nterm\\/query\'s size for memory tracking? I\'m not sure how we\'d do\u003cbr\\/\u003e\\nthat without having a global deletes manager that individual DWs\u003cbr\\/\u003e\\ninteract with (maybe have a ref count per term\\/query?). The deletes\u003cbr\\/\u003e\\nmanager would have the size\\/ram usage method, not individual\u003cbr\\/\u003e\\nDWs. The DWs would need to keep a hash map of term -&gt;\u003cbr\\/\u003e\\nBufferedDeletes.Num.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12850780_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850780_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Mar\\/10 02:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-29T02:35:20+0000\'\u003e29\\/Mar\\/10 02:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     I mentioned the idea of having a sequence ID, that gets \\nincremented on add, delete, update. What if we had even with \\nseparate DWs a global sequence ID? The sequence ID would tell \\nyou unambiguously which action happened when. The \\nadd\\/update\\/delete methods could return the sequenceID that was \\nassigned to that particular action.  \\n\\n I think adding the global sequence id makes sense and would be \\nsimple to add (eg, AtomicLong). However, in the apply deletes \\nmethod how would we know which doc to stop deleting at? How \\nwould the seq id map to a DW\'s doc id? \\n\\n If we have independent buffered deletes per DW-thread, then how \\nwill we keep track of the memory usage? eg, we\'ll be flushing \\nDWs independently, but will not want to double count the same \\nterm\\/query\'s size for memory tracking? I\'m not sure how we\'d do \\nthat without having a global deletes manager that individual DWs \\ninteract with (maybe have a ref count per term\\/query?). The deletes \\nmanager would have the size\\/ram usage method, not individual \\nDWs. The DWs would need to keep a hash map of term -&gt; \\nBufferedDeletes.Num.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850792\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850792&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850792\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12850792_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850792_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Mar\\/10 04:48\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-29T04:48:48+0000\'\u003e29\\/Mar\\/10 04:48\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eHowever, in the apply deletes\u003cbr\\/\u003e\\nmethod how would we know which doc to stop deleting at? How\u003cbr\\/\u003e\\nwould the seq id map to a DW\'s doc id?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eWe could have a global deletes-map that stores seqID -&gt; DeleteAction.  DeleteAction either contains a Term or a Query, and in addition an int \\\"flushCount\\\" (I\'ll explain in a bit what flushCount is used for.)\u003c\\/p\u003e\\n\\n\u003cp\u003eEach DocumentsWriterPerThread would have a growing array that contains each seqID that \\\"affected\\\" that DWPT, i.e. the seqIDs of \u003cb\u003eall\u003c\\/b\u003e deletes, plus the seqIDs of the adds\\/updates performed by that particular DWPT.  One bit of a seqID in that array can indicate if it\'s a delete or add\\/update.\u003c\\/p\u003e\\n\\n\u003cp\u003eWhen it\'s time to flush we sort the array by increasing seqID and then loop a single time through it to find the seqIDs of all DeleteActions.  During the loop we count the number of adds\\/updates to determine the number of docs the DeleteActions affect.  After applying the deletes the DWPT makes a synchronized call to the global deletes-map and increments the flushCount int for each applied DeleteAction.  If flushCount==numThreadStates (== number of DWPT instances) the corresponding DeleteAction entry can be removed, because it was applied to all DWPT.\u003c\\/p\u003e\\n\\n\u003cp\u003eI think this should work?  Or is there a simpler solution?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12850792_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850792_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Mar\\/10 04:48\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-29T04:48:48+0000\'\u003e29\\/Mar\\/10 04:48\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n However, in the apply deletes \\nmethod how would we know which doc to stop deleting at? How \\nwould the seq id map to a DW\'s doc id?  \\n\\n We could have a global deletes-map that stores seqID -&gt; DeleteAction.  DeleteAction either contains a Term or a Query, and in addition an int \\\"flushCount\\\" (I\'ll explain in a bit what flushCount is used for.) \\n\\n Each DocumentsWriterPerThread would have a growing array that contains each seqID that \\\"affected\\\" that DWPT, i.e. the seqIDs of  all  deletes, plus the seqIDs of the adds\\/updates performed by that particular DWPT.  One bit of a seqID in that array can indicate if it\'s a delete or add\\/update. \\n\\n When it\'s time to flush we sort the array by increasing seqID and then loop a single time through it to find the seqIDs of all DeleteActions.  During the loop we count the number of adds\\/updates to determine the number of docs the DeleteActions affect.  After applying the deletes the DWPT makes a synchronized call to the global deletes-map and increments the flushCount int for each applied DeleteAction.  If flushCount==numThreadStates (== number of DWPT instances) the corresponding DeleteAction entry can be removed, because it was applied to all DWPT. \\n\\n I think this should work?  Or is there a simpler solution?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850857\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850857&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850857\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12850857_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850857_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Mar\\/10 09:40\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-29T09:40:23+0000\'\u003e29\\/Mar\\/10 09:40\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eYeah I think we\'re gonna need the global sequenceID in some form &#8211; my Options 1 or 2 can\'t work because the interleaving issue (as seen\\/required by the app) is a global thing.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12850857_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850857_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Mar\\/10 09:40\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-29T09:40:23+0000\'\u003e29\\/Mar\\/10 09:40\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Yeah I think we\'re gonna need the global sequenceID in some form &#8211; my Options 1 or 2 can\'t work because the interleaving issue (as seen\\/required by the app) is a global thing.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12850864\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12850864&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12850864\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12850864_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850864_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Mar\\/10 09:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-29T09:53:47+0000\'\u003e29\\/Mar\\/10 09:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\\n\u003cblockquote\u003e\u003cp\u003eMike, can you explain what the advantages of this kind of thread affinity are? I was always wondering why the DocumentsWriter code currently makes efforts to assign a ThreadState always to the same Thread? Is that being done for performance reasons?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eIt\'s for performance. I expect there are apps where a given\u003cbr\\/\u003e\\nthread\\/pool indexes certain kind of docs, ie, the app threads\u003cbr\\/\u003e\\nthemselves have \\\"affinity\\\" for docs with similar term distributions.\u003cbr\\/\u003e\\nIn which case, it\'s best (most RAM efficient) if those docs w\\/\u003cbr\\/\u003e\\npresumably similar term stats are sent back to the same DW.  If you\u003cbr\\/\u003e\\nmix in different term stats into one buffer you get worse RAM\u003cbr\\/\u003e\\nefficiency.\u003c\\/p\u003e\\n\\n\u003cp\u003eAlso, for better RAM efficiency you want \u003cb\u003efewer\u003c\\/b\u003e DWs... because we get\u003cbr\\/\u003e\\nmore RAM efficiency the higher the freq of the terms... but of course\u003cbr\\/\u003e\\nyou want more DWs for better CPU efficiency whenever that many threads\u003cbr\\/\u003e\\nare running at once.\u003c\\/p\u003e\\n\\n\u003cp\u003eNet\\/net CPU efficiency should trump RAM efficiency, I think, so if\u003cbr\\/\u003e\\nthere is a conflict we should favor CPU efficiency.\u003c\\/p\u003e\\n\\n\u003cp\u003eThough, thread affinity doesn\'t seem that CPU costly to implement?\u003cbr\\/\u003e\\nLookup the DW your thread first used... if it\'s free, seize it.  If\u003cbr\\/\u003e\\nit\'s not, fallback to any DW that\'s free.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12850864_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12850864_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Mar\\/10 09:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-29T09:53:47+0000\'\u003e29\\/Mar\\/10 09:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                   \\n  Mike, can you explain what the advantages of this kind of thread affinity are? I was always wondering why the DocumentsWriter code currently makes efforts to assign a ThreadState always to the same Thread? Is that being done for performance reasons?  \\n\\n It\'s for performance. I expect there are apps where a given \\nthread\\/pool indexes certain kind of docs, ie, the app threads \\nthemselves have \\\"affinity\\\" for docs with similar term distributions. \\nIn which case, it\'s best (most RAM efficient) if those docs w\\/ \\npresumably similar term stats are sent back to the same DW.  If you \\nmix in different term stats into one buffer you get worse RAM \\nefficiency. \\n\\n Also, for better RAM efficiency you want  fewer  DWs... because we get \\nmore RAM efficiency the higher the freq of the terms... but of course \\nyou want more DWs for better CPU efficiency whenever that many threads \\nare running at once. \\n\\n Net\\/net CPU efficiency should trump RAM efficiency, I think, so if \\nthere is a conflict we should favor CPU efficiency. \\n\\n Though, thread affinity doesn\'t seem that CPU costly to implement? \\nLookup the DW your thread first used... if it\'s free, seize it.  If \\nit\'s not, fallback to any DW that\'s free.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12851017\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12851017&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12851017\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12851017_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12851017_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Mar\\/10 17:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-29T17:41:11+0000\'\u003e29\\/Mar\\/10 17:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eMichael B.: What you\'re talking about here:\u003cbr\\/\u003e\\n\u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2324?focusedCommentI\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttps:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2324?focusedCommentI\u003c\\/a\u003e\u003cbr\\/\u003e\\nd=12850792page=com.atlassian.jira.plugin.system.issuetabpanels%3A\u003cbr\\/\u003e\\ncomment-tabpanel#action_12850792 is a transaction log?\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'m not sure we need that level of complexity just yet? How\u003cbr\\/\u003e\\nwould we make the transaction log memory efficient? Are there\u003cbr\\/\u003e\\nother uses you foresee? Maybe there\'s a simpler solution for the\u003cbr\\/\u003e\\nBufferedDeletes.Num per DW problem that could make use of global\u003cbr\\/\u003e\\nsequence ids? I\'d prefer to continue to use the per term\\/query\u003cbr\\/\u003e\\nmax doc id. There aren\'t performance issues with concurrently\u003cbr\\/\u003e\\naccessing and updating maps, so a global sync lock as the DW map\u003cbr\\/\u003e\\nvalues are updated should be OK?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12851017_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12851017_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Mar\\/10 17:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-29T17:41:11+0000\'\u003e29\\/Mar\\/10 17:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Michael B.: What you\'re talking about here: \\n https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2324?focusedCommentI  \\nd=12850792page=com.atlassian.jira.plugin.system.issuetabpanels%3A \\ncomment-tabpanel#action_12850792 is a transaction log? \\n\\n I\'m not sure we need that level of complexity just yet? How \\nwould we make the transaction log memory efficient? Are there \\nother uses you foresee? Maybe there\'s a simpler solution for the \\nBufferedDeletes.Num per DW problem that could make use of global \\nsequence ids? I\'d prefer to continue to use the per term\\/query \\nmax doc id. There aren\'t performance issues with concurrently \\naccessing and updating maps, so a global sync lock as the DW map \\nvalues are updated should be OK?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12851078\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12851078&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12851078\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12851078_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12851078_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Mar\\/10 20:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-29T20:35:26+0000\'\u003e29\\/Mar\\/10 20:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eI\'m not sure we need that level of complexity just yet? How\u003cbr\\/\u003e\\nwould we make the transaction log memory efficient?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eIs that really so complex?  You only need one additional int per doc in the DWPTs, and the global map for the delete terms.  You don\'t need to buffer the actual terms per DWPT.  I thought that\'s quite efficient?  But I\'m totally open to other ideas.\u003c\\/p\u003e\\n\\n\u003cp\u003eI can try tonight to code a prototype of this - I don\'t think it would be very complex actually.  But of course there might be complications I haven\'t thought of.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eAre there other uses you foresee?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eNot really for the \\\"transaction log\\\" as you called it.  I\'d remove that log once we switch to deletes in the FG (when the RAM buffer is searchable).  But a nice thing would be for add\\/update\\/delete to return the seqID, and also the if RAMReader in the future had an API to check up to which seqID it\'s able to \\\"see\\\".  Then it\'s very clear to user of the API where a given reader is at.  \u003cbr\\/\u003e\\nFor this to work we have to assign the seqID at the \u003cb\u003eend\u003c\\/b\u003e of a call.  E.g. when adding a large document, which takes a long time to process, it should get the seqID assigned after the \\\"work\\\" is done and right before the addDocument() call returns.  \u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12851078_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12851078_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Mar\\/10 20:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-29T20:35:26+0000\'\u003e29\\/Mar\\/10 20:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n I\'m not sure we need that level of complexity just yet? How \\nwould we make the transaction log memory efficient?  \\n\\n Is that really so complex?  You only need one additional int per doc in the DWPTs, and the global map for the delete terms.  You don\'t need to buffer the actual terms per DWPT.  I thought that\'s quite efficient?  But I\'m totally open to other ideas. \\n\\n I can try tonight to code a prototype of this - I don\'t think it would be very complex actually.  But of course there might be complications I haven\'t thought of. \\n\\n  Are there other uses you foresee?  \\n\\n Not really for the \\\"transaction log\\\" as you called it.  I\'d remove that log once we switch to deletes in the FG (when the RAM buffer is searchable).  But a nice thing would be for add\\/update\\/delete to return the seqID, and also the if RAMReader in the future had an API to check up to which seqID it\'s able to \\\"see\\\".  Then it\'s very clear to user of the API where a given reader is at.   \\nFor this to work we have to assign the seqID at the  end  of a call.  E.g. when adding a large document, which takes a long time to process, it should get the seqID assigned after the \\\"work\\\" is done and right before the addDocument() call returns.   \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12851099\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12851099&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12851099\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12851099_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12851099_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Mar\\/10 21:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-29T21:12:17+0000\'\u003e29\\/Mar\\/10 21:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eYou only need one additional int per doc in the DWPTs, and the global map for the delete terms.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eOk, lets give it a try, it\'ll be more clear with the prototype.  \u003c\\/p\u003e\\n\\n\u003cp\u003eThe clarify, the apply deletes doc id up to will be the flushed doc count saved per term\\/query per DW, though it won\'t be saved, it\'ll be derived from the sequence id int array where the action has been encoded into the seq id int?\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12851099_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12851099_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Mar\\/10 21:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-29T21:12:17+0000\'\u003e29\\/Mar\\/10 21:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     You only need one additional int per doc in the DWPTs, and the global map for the delete terms.  \\n\\n Ok, lets give it a try, it\'ll be more clear with the prototype.   \\n\\n The clarify, the apply deletes doc id up to will be the flushed doc count saved per term\\/query per DW, though it won\'t be saved, it\'ll be derived from the sequence id int array where the action has been encoded into the seq id int? \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12851142\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12851142&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12851142\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12851142_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12851142_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Mar\\/10 22:32\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-29T22:32:19+0000\'\u003e29\\/Mar\\/10 22:32\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eThe clarify, the apply deletes doc id up to will be the flushed doc count saved per term\\/query per DW, though it won\'t be saved, it\'ll be derived from the sequence id int array where the action has been encoded into the seq id int?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYeah, that\'s the idea.  Let\'s see if it works \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12851142_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12851142_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Mar\\/10 22:32\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-03-29T22:32:19+0000\'\u003e29\\/Mar\\/10 22:32\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n The clarify, the apply deletes doc id up to will be the flushed doc count saved per term\\/query per DW, though it won\'t be saved, it\'ll be derived from the sequence id int array where the action has been encoded into the seq id int?  \\n\\n Yeah, that\'s the idea.  Let\'s see if it works                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12853594\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12853594&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12853594\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12853594_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12853594_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Apr\\/10 23:23\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-05T23:23:48+0000\'\u003e05\\/Apr\\/10 23:23\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eMichael B, I  was going to wait for your prototype before continuing... \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12853594_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12853594_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Apr\\/10 23:23\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-05T23:23:48+0000\'\u003e05\\/Apr\\/10 23:23\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Michael B, I  was going to wait for your prototype before continuing...                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12853751\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12853751&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12853751\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12853751_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12853751_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Apr\\/10 05:14\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-06T05:14:52+0000\'\u003e06\\/Apr\\/10 05:14\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eSorry, Jason, I got sidetracked with \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2329\\\" title=\\\"Use parallel arrays instead of PostingList objects\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2329\\\"\u003e\u003cdel\u003eLUCENE-2329\u003c\\/del\u003e\u003c\\/a\u003e and other things at work.  I\'ll try to write the sequence ID stuff asap.  However, there\'s more we need to do here that is sort of independent of the deleted docs problem.  E.g. removing all the downstream perThread classes.   \u003c\\/p\u003e\\n\\n\u003cp\u003eWe should work with the flex code from now on, as the flex branch will be merged into trunk soon.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12853751_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12853751_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Apr\\/10 05:14\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-06T05:14:52+0000\'\u003e06\\/Apr\\/10 05:14\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Sorry, Jason, I got sidetracked with   LUCENE-2329   and other things at work.  I\'ll try to write the sequence ID stuff asap.  However, there\'s more we need to do here that is sort of independent of the deleted docs problem.  E.g. removing all the downstream perThread classes.    \\n\\n We should work with the flex code from now on, as the flex branch will be merged into trunk soon.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12857097\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12857097&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12857097\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12857097_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12857097_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Apr\\/10 21:14\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-14T21:14:14+0000\'\u003e14\\/Apr\\/10 21:14\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThe patch removes all *PerThread classes downstream of DocumentsWriter.\u003c\\/p\u003e\\n\\n\u003cp\u003eThis simplifies a lot of the flushing logic in the different consumers.  The patch also removes FreqProxMergeState, because we don\'t have to interleave posting lists from different threads anymore of course.  I really like these simplifications!\u003c\\/p\u003e\\n\\n\u003cp\u003eThere is still a lot to do:  The changes in DocumentsWriter and IndexWriter are currently just experimental to make everything compile.  Next I will introduce DocumentsWriterPerThread and implement the sequenceID logic (which was discussed here in earlier comments) and the new RAM management.  I also want to go through the indexing chain once again - there are probably a few more things to clean up or simplify.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe patch compiles and actually a surprising amount of tests pass.  Only multi-threaded tests seem to fail,\u003cbr\\/\u003e\\nwhich is not very surprising, considering I removed all thread-handling logic from DocumentsWriter. \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e \u003c\\/p\u003e\\n\\n\u003cp\u003eSo this patch isn\'t working yet - just wanted to post my current progress.  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12857097_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12857097_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Apr\\/10 21:14\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-14T21:14:14+0000\'\u003e14\\/Apr\\/10 21:14\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    The patch removes all *PerThread classes downstream of DocumentsWriter. \\n\\n This simplifies a lot of the flushing logic in the different consumers.  The patch also removes FreqProxMergeState, because we don\'t have to interleave posting lists from different threads anymore of course.  I really like these simplifications! \\n\\n There is still a lot to do:  The changes in DocumentsWriter and IndexWriter are currently just experimental to make everything compile.  Next I will introduce DocumentsWriterPerThread and implement the sequenceID logic (which was discussed here in earlier comments) and the new RAM management.  I also want to go through the indexing chain once again - there are probably a few more things to clean up or simplify. \\n\\n The patch compiles and actually a surprising amount of tests pass.  Only multi-threaded tests seem to fail, \\nwhich is not very surprising, considering I removed all thread-handling logic from DocumentsWriter.    \\n\\n So this patch isn\'t working yet - just wanted to post my current progress.                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12857112\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12857112&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12857112\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12857112_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12857112_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Apr\\/10 21:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-14T21:46:57+0000\'\u003e14\\/Apr\\/10 21:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eMichael, nice!  I guess I should\'ve spent more time removing the PerThread classes, but now we\'re pretty much there.  Indeed the simplification should make things a lot better.  I guess I\'ll wait for the next patch to work on something.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12857112_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12857112_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Apr\\/10 21:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-14T21:46:57+0000\'\u003e14\\/Apr\\/10 21:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Michael, nice!  I guess I should\'ve spent more time removing the PerThread classes, but now we\'re pretty much there.  Indeed the simplification should make things a lot better.  I guess I\'ll wait for the next patch to work on something.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12857124\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12857124&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12857124\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12857124_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12857124_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Apr\\/10 22:25\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-14T22:25:58+0000\'\u003e14\\/Apr\\/10 22:25\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThis is awesome Michael!  Much simpler... nor more FreqProxMergeState, nor the logic to interleave\\/synchronize writing to the doc stores.  I like it!\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12857124_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12857124_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Apr\\/10 22:25\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-14T22:25:58+0000\'\u003e14\\/Apr\\/10 22:25\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    This is awesome Michael!  Much simpler... nor more FreqProxMergeState, nor the logic to interleave\\/synchronize writing to the doc stores.  I like it!              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12857164\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12857164&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12857164\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12857164_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12857164_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Apr\\/10 00:52\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-15T00:52:09+0000\'\u003e15\\/Apr\\/10 00:52\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eIt\'s for performance. I expect there are apps where a given\u003cbr\\/\u003e\\nthread\\/pool indexes certain kind of docs, ie, the app threads\u003cbr\\/\u003e\\nthemselves have \\\"affinity\\\" for docs with similar term distributions.\u003cbr\\/\u003e\\nIn which case, it\'s best (most RAM efficient) if those docs w\\/\u003cbr\\/\u003e\\npresumably similar term stats are sent back to the same DW. If you\u003cbr\\/\u003e\\nmix in different term stats into one buffer you get worse RAM\u003cbr\\/\u003e\\nefficiency.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI do see your point, but I feel like we shouldn\'t optimize\\/make compromises for this use case.  Mainly, because I think apps with such an affinity that you describe are very rare?  The usual design is a queued ingestion pipeline, where a pool of indexer threads take docs out of a queue and feed them to an IndexWriter, I think?  In such a world the threads wouldn\'t have an affinity for similar docs.\u003c\\/p\u003e\\n\\n\u003cp\u003eAnd if a user really has so different docs, maybe the right answer would be to have more than one single index?  Even if today an app utilizes the thread affinity, this only results in maybe somewhat faster indexing performance, but the benefits would be lost after flusing\\/merging.  \u003c\\/p\u003e\\n\\n\u003cp\u003eIf we assign docs randomly to available DocumentsWriterPerThreads, then we should on average make good use of the overall memory?  Alternatively we could also select the DWPT from the pool of available DWPTs that has the highest amount of free memory?  \u003c\\/p\u003e\\n\\n\u003cp\u003eHaving a fully decoupled memory management is compelling I think, mainly because it makes everything so much simpler.  A DWPT could decide itself when it\'s time to flush, and the other ones can keep going independently.  \u003c\\/p\u003e\\n\\n\u003cp\u003eIf you do have a global RAM management, how would the flushing work?  E.g. when a global flush is triggered because all RAM is consumed, and we pick the DWPT with the highest amount of allocated memory for flushing, what will the other DWPTs do during that flush?  Wouldn\'t we have to pause the other DWPTs to make sure we don\'t exceed the maxRAMBufferSize?\u003cbr\\/\u003e\\nOf course we could say \\\"always flush when 90% of the overall memory is consumed\\\", but how would we know that the remaining 10% won\'t fill up during the time the flush takes?  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12857164_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12857164_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Apr\\/10 00:52\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-15T00:52:09+0000\'\u003e15\\/Apr\\/10 00:52\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n It\'s for performance. I expect there are apps where a given \\nthread\\/pool indexes certain kind of docs, ie, the app threads \\nthemselves have \\\"affinity\\\" for docs with similar term distributions. \\nIn which case, it\'s best (most RAM efficient) if those docs w\\/ \\npresumably similar term stats are sent back to the same DW. If you \\nmix in different term stats into one buffer you get worse RAM \\nefficiency.  \\n\\n I do see your point, but I feel like we shouldn\'t optimize\\/make compromises for this use case.  Mainly, because I think apps with such an affinity that you describe are very rare?  The usual design is a queued ingestion pipeline, where a pool of indexer threads take docs out of a queue and feed them to an IndexWriter, I think?  In such a world the threads wouldn\'t have an affinity for similar docs. \\n\\n And if a user really has so different docs, maybe the right answer would be to have more than one single index?  Even if today an app utilizes the thread affinity, this only results in maybe somewhat faster indexing performance, but the benefits would be lost after flusing\\/merging.   \\n\\n If we assign docs randomly to available DocumentsWriterPerThreads, then we should on average make good use of the overall memory?  Alternatively we could also select the DWPT from the pool of available DWPTs that has the highest amount of free memory?   \\n\\n Having a fully decoupled memory management is compelling I think, mainly because it makes everything so much simpler.  A DWPT could decide itself when it\'s time to flush, and the other ones can keep going independently.   \\n\\n If you do have a global RAM management, how would the flushing work?  E.g. when a global flush is triggered because all RAM is consumed, and we pick the DWPT with the highest amount of allocated memory for flushing, what will the other DWPTs do during that flush?  Wouldn\'t we have to pause the other DWPTs to make sure we don\'t exceed the maxRAMBufferSize? \\nOf course we could say \\\"always flush when 90% of the overall memory is consumed\\\", but how would we know that the remaining 10% won\'t fill up during the time the flush takes?                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12857373\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12857373&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12857373\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12857373_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12857373_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Apr\\/10 16:08\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-15T16:08:31+0000\'\u003e15\\/Apr\\/10 16:08\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eThe usual design is a queued ingestion pipeline, where a pool of indexer threads take docs out of a queue and feed them to an IndexWriter, I think?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eMainly, because I think apps with such an affinity that you describe are very rare?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eHmm I suspect it\'s not that rare....  yes one design is a single\u003cbr\\/\u003e\\nindexing queue w\\/ dedicated thread pool only for indexing, but a push\u003cbr\\/\u003e\\nmodel is equal valid, where your app already has separate threads (or\u003cbr\\/\u003e\\nthread pools) servicing different content sources, so when a doc\u003cbr\\/\u003e\\narrives to one of those source-specific threads, it\'s that thread that\u003cbr\\/\u003e\\nindexes it, rather than handing off to a separately pool.\u003c\\/p\u003e\\n\\n\u003cp\u003eLucene is used in a very wide variety of apps &#8211; we shouldn\'t optimize\u003cbr\\/\u003e\\nthe indexer on such hard app specific assumptions.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eAnd if a user really has so different docs, maybe the right answer would be to have more than one single index?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eHmm but the app shouldn\'t have to resort to this... (it doesn\'t have\u003cbr\\/\u003e\\nto today).\u003c\\/p\u003e\\n\\n\u003cp\u003eBut... could we allow an add\\/updateDocument call to express this\u003cbr\\/\u003e\\naffinity, explicitly?  If you index homogenous docs you wouldn\'t use\u003cbr\\/\u003e\\nit, but, if you index drastically different docs that fall into clear\u003cbr\\/\u003e\\n\\\"categories\\\", expressing the affinity can get you a good gain in\u003cbr\\/\u003e\\nindexing throughput.\u003c\\/p\u003e\\n\\n\u003cp\u003eThis may be the best solution, since then one could pass the affinity\u003cbr\\/\u003e\\neven through a thread pool, and then we would fallback to thread\u003cbr\\/\u003e\\nbinding if the document class wasn\'t declared?\u003c\\/p\u003e\\n\\n\u003cp\u003eI mean this is virtually identical to \\\"having more than one index\\\",\u003cbr\\/\u003e\\nsince the DW is like its own index.  It just saves some of the\u003cbr\\/\u003e\\ncopy-back\\/merge cost of addIndexes...\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eEven if today an app utilizes the thread affinity, this only results in maybe somewhat faster indexing performance, but the benefits would be lost after flusing\\/merging.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYes this optimization is only about the initial flush, but, it\'s\u003cbr\\/\u003e\\npotentially sizable.  Merging matters less since typically it\'s not\u003cbr\\/\u003e\\nthe bottleneck (happens in the BG, quickly enough).\u003c\\/p\u003e\\n\\n\u003cp\u003eOn the right apps, thread affinity can make a huge difference.  EG if\u003cbr\\/\u003e\\nyou allow up to 8 thread states, and the threads are indexing content\u003cbr\\/\u003e\\nw\\/ highly divergent terms (eg, one language per thread, or, docs w\\/\u003cbr\\/\u003e\\nvery different field names), in the worst case you\'ll be up to 1\\/8 as\u003cbr\\/\u003e\\nefficient since each term must now be copied in up to 8 places\u003cbr\\/\u003e\\ninstead of one.  We have a high per-term RAM cost (reduced thanks to\u003cbr\\/\u003e\\nthe parallel arrays, but, still high).\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eIf we assign docs randomly to available DocumentsWriterPerThreads, then we should on average make good use of the overall memory?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eIt really depends on the app &#8211; if the term space is highly thread\u003cbr\\/\u003e\\ndependent (above examples) you an end up flush much more frequently for\u003cbr\\/\u003e\\na given RAM buffer.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eAlternatively we could also select the DWPT from the pool of available DWPTs that has the highest amount of free memory?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eHmm... this would be kinda costly binder?  You\'d need a pqueue?\u003cbr\\/\u003e\\nThread affinity (or the explicit affinity) is a single\u003cbr\\/\u003e\\nmap\\/array\\/member lookup.  But it\'s an interesting idea...\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eIf you do have a global RAM management, how would the flushing work? E.g. when a global flush is triggered because all RAM is consumed, and we pick the DWPT with the highest amount of allocated memory for flushing, what will the other DWPTs do during that flush? Wouldn\'t we have to pause the other DWPTs to make sure we don\'t exceed the maxRAMBufferSize?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThe other DWs would keep indexing \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e  That\'s the beauty of this\u003cbr\\/\u003e\\napproach... a flush of one DW doesn\'t stop all other DWs from\u003cbr\\/\u003e\\nindexing, unliked today.\u003c\\/p\u003e\\n\\n\u003cp\u003eAnd you want to serialize the flushing right?  Ie, only one DW flushes\u003cbr\\/\u003e\\nat a time (the others keep indexing).\u003c\\/p\u003e\\n\\n\u003cp\u003eHmm I suppose flushing more than one should be allowed (OS\\/IO have\u003cbr\\/\u003e\\nalot of concurrency, esp since IO goes into write cache)... perhaps\u003cbr\\/\u003e\\nthat\'s the best way to balance index vs flush time?  EG we pick one to\u003cbr\\/\u003e\\nflush @ 90%, if we cross 95% we pick another to flush, another at\u003cbr\\/\u003e\\n100%, etc.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eOf course we could say \\\"always flush when 90% of the overall memory is consumed\\\", but how would we know that the remaining 10% won\'t fill up during the time the flush takes?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eRegardless of the approach for document -&gt; DW binding, this is an\u003cbr\\/\u003e\\nissue (ie it\'s non-differentiating here)?  Ie the other DWs continue\u003cbr\\/\u003e\\nto consume RAM while one DW is flushing.  I think the low\\/high water\u003cbr\\/\u003e\\nmark is an OK solution here?  Or the tiered flushing (I think I like\u003cbr\\/\u003e\\nthat better \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e ).\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eHaving a fully decoupled memory management is compelling I think, mainly because it makes everything so much simpler. A DWPT could decide itself when it\'s time to flush, and the other ones can keep going independently.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI\'m all for simplifying things, which you\'ve already nicely done here,\u003cbr\\/\u003e\\nbut not of it\'s at the cost of a non-trivial potential indexing perf\u003cbr\\/\u003e\\nloss.  We\'re already taking a perf hit here, since the doc stores\u003cbr\\/\u003e\\ncan\'t be shared... I think that case is justifiable (good\u003cbr\\/\u003e\\nsimplification).\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12857373_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12857373_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Apr\\/10 16:08\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-15T16:08:31+0000\'\u003e15\\/Apr\\/10 16:08\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     The usual design is a queued ingestion pipeline, where a pool of indexer threads take docs out of a queue and feed them to an IndexWriter, I think?  \\n\\n  Mainly, because I think apps with such an affinity that you describe are very rare?  \\n\\n Hmm I suspect it\'s not that rare....  yes one design is a single \\nindexing queue w\\/ dedicated thread pool only for indexing, but a push \\nmodel is equal valid, where your app already has separate threads (or \\nthread pools) servicing different content sources, so when a doc \\narrives to one of those source-specific threads, it\'s that thread that \\nindexes it, rather than handing off to a separately pool. \\n\\n Lucene is used in a very wide variety of apps &#8211; we shouldn\'t optimize \\nthe indexer on such hard app specific assumptions. \\n\\n  And if a user really has so different docs, maybe the right answer would be to have more than one single index?  \\n\\n Hmm but the app shouldn\'t have to resort to this... (it doesn\'t have \\nto today). \\n\\n But... could we allow an add\\/updateDocument call to express this \\naffinity, explicitly?  If you index homogenous docs you wouldn\'t use \\nit, but, if you index drastically different docs that fall into clear \\n\\\"categories\\\", expressing the affinity can get you a good gain in \\nindexing throughput. \\n\\n This may be the best solution, since then one could pass the affinity \\neven through a thread pool, and then we would fallback to thread \\nbinding if the document class wasn\'t declared? \\n\\n I mean this is virtually identical to \\\"having more than one index\\\", \\nsince the DW is like its own index.  It just saves some of the \\ncopy-back\\/merge cost of addIndexes... \\n\\n  Even if today an app utilizes the thread affinity, this only results in maybe somewhat faster indexing performance, but the benefits would be lost after flusing\\/merging.  \\n\\n Yes this optimization is only about the initial flush, but, it\'s \\npotentially sizable.  Merging matters less since typically it\'s not \\nthe bottleneck (happens in the BG, quickly enough). \\n\\n On the right apps, thread affinity can make a huge difference.  EG if \\nyou allow up to 8 thread states, and the threads are indexing content \\nw\\/ highly divergent terms (eg, one language per thread, or, docs w\\/ \\nvery different field names), in the worst case you\'ll be up to 1\\/8 as \\nefficient since each term must now be copied in up to 8 places \\ninstead of one.  We have a high per-term RAM cost (reduced thanks to \\nthe parallel arrays, but, still high). \\n\\n  If we assign docs randomly to available DocumentsWriterPerThreads, then we should on average make good use of the overall memory?  \\n\\n It really depends on the app &#8211; if the term space is highly thread \\ndependent (above examples) you an end up flush much more frequently for \\na given RAM buffer. \\n\\n  Alternatively we could also select the DWPT from the pool of available DWPTs that has the highest amount of free memory?  \\n\\n Hmm... this would be kinda costly binder?  You\'d need a pqueue? \\nThread affinity (or the explicit affinity) is a single \\nmap\\/array\\/member lookup.  But it\'s an interesting idea... \\n\\n  If you do have a global RAM management, how would the flushing work? E.g. when a global flush is triggered because all RAM is consumed, and we pick the DWPT with the highest amount of allocated memory for flushing, what will the other DWPTs do during that flush? Wouldn\'t we have to pause the other DWPTs to make sure we don\'t exceed the maxRAMBufferSize?  \\n\\n The other DWs would keep indexing    That\'s the beauty of this \\napproach... a flush of one DW doesn\'t stop all other DWs from \\nindexing, unliked today. \\n\\n And you want to serialize the flushing right?  Ie, only one DW flushes \\nat a time (the others keep indexing). \\n\\n Hmm I suppose flushing more than one should be allowed (OS\\/IO have \\nalot of concurrency, esp since IO goes into write cache)... perhaps \\nthat\'s the best way to balance index vs flush time?  EG we pick one to \\nflush @ 90%, if we cross 95% we pick another to flush, another at \\n100%, etc. \\n\\n  Of course we could say \\\"always flush when 90% of the overall memory is consumed\\\", but how would we know that the remaining 10% won\'t fill up during the time the flush takes?  \\n\\n Regardless of the approach for document -&gt; DW binding, this is an \\nissue (ie it\'s non-differentiating here)?  Ie the other DWs continue \\nto consume RAM while one DW is flushing.  I think the low\\/high water \\nmark is an OK solution here?  Or the tiered flushing (I think I like \\nthat better   ). \\n\\n  Having a fully decoupled memory management is compelling I think, mainly because it makes everything so much simpler. A DWPT could decide itself when it\'s time to flush, and the other ones can keep going independently.  \\n\\n I\'m all for simplifying things, which you\'ve already nicely done here, \\nbut not of it\'s at the cost of a non-trivial potential indexing perf \\nloss.  We\'re already taking a perf hit here, since the doc stores \\ncan\'t be shared... I think that case is justifiable (good \\nsimplification).              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12857375\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12857375&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12857375\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"tsmith\\\" id=\\\"commentauthor_12857375_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=tsmith\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"tsmith\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tim Smith\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12857375_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Apr\\/10 16:13\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-15T16:13:03+0000\'\u003e15\\/Apr\\/10 16:13\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eBut... could we allow an add\\/updateDocument call to express this affinity, explicitly?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003ei would love to be able to explicitly define a \\\"segment\\\" affinity for documents i\'m feeding\u003c\\/p\u003e\\n\\n\u003cp\u003ethis would then allow me to say: \u003cbr\\/\u003e\\nall docs from table a has affinity 1\u003cbr\\/\u003e\\nall docs from table b has affinity 2\u003c\\/p\u003e\\n\\n\u003cp\u003ethis would ideally result in indexing documents from each table into a different segment (obviously, i would then need to be able to have segment merging be affinity aware so optimize\\/merging would only merge segments that share an affinity)\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"tsmith\\\" id=\\\"commentauthor_12857375_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=tsmith\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"tsmith\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tim Smith\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12857375_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Apr\\/10 16:13\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-15T16:13:03+0000\'\u003e15\\/Apr\\/10 16:13\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     But... could we allow an add\\/updateDocument call to express this affinity, explicitly?  \\n\\n i would love to be able to explicitly define a \\\"segment\\\" affinity for documents i\'m feeding \\n\\n this would then allow me to say:  \\nall docs from table a has affinity 1 \\nall docs from table b has affinity 2 \\n\\n this would ideally result in indexing documents from each table into a different segment (obviously, i would then need to be able to have segment merging be affinity aware so optimize\\/merging would only merge segments that share an affinity)              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12857380\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12857380&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12857380\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12857380_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12857380_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Apr\\/10 16:17\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-15T16:17:31+0000\'\u003e15\\/Apr\\/10 16:17\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eonly one DW flushes at a time (the others keep indexing).\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI think it\'s best to simply flush at 90% for now. We already\u003cbr\\/\u003e\\nexceed the ram buffer size because of over allocation? Perhaps\u003cbr\\/\u003e\\nwe can view the ram buffer size as a rough guideline not a hard\u003cbr\\/\u003e\\nand fast limit because, lets face it, we\'re using Java which is\u003cbr\\/\u003e\\nabout as inexact when it comes to RAM consumption as it gets?\u003cbr\\/\u003e\\nAlso, hopefully it would move the patch along faster and more\u003cbr\\/\u003e\\ncomplex algorithms could easily be added later. \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12857380_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12857380_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Apr\\/10 16:17\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-15T16:17:31+0000\'\u003e15\\/Apr\\/10 16:17\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     only one DW flushes at a time (the others keep indexing).  \\n\\n I think it\'s best to simply flush at 90% for now. We already \\nexceed the ram buffer size because of over allocation? Perhaps \\nwe can view the ram buffer size as a rough guideline not a hard \\nand fast limit because, lets face it, we\'re using Java which is \\nabout as inexact when it comes to RAM consumption as it gets? \\nAlso, hopefully it would move the patch along faster and more \\ncomplex algorithms could easily be added later.               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12857381\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12857381&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12857381\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12857381_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12857381_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Apr\\/10 16:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-15T16:20:33+0000\'\u003e15\\/Apr\\/10 16:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003ei would love to be able to explicitly define a \\\"segment\\\" affinity for documents i\'m feeding\u003c\\/p\u003e\\n\\n\u003cp\u003ethis would then allow me to say: \u003cbr\\/\u003e\\nall docs from table a has affinity 1\u003cbr\\/\u003e\\nall docs from table b has affinity 2\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eRight, this is exactly what affinity would be good for &#8211; so IW would\u003cbr\\/\u003e\\ntry to send \\\"table a\\\" docs their own DW(s) and \\\"table b\\\" docs to their\u003cbr\\/\u003e\\nown DW(s), which should give faster indexing than randomly binding to\u003cbr\\/\u003e\\nDWs.\u003c\\/p\u003e\\n\\n\u003cp\u003eBut:\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003ethis would ideally result in indexing documents from each table into a different segment (obviously, i would then need to be able to have segment merging be affinity aware so optimize\\/merging would only merge segments that share an affinity)\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThis part I was not proposing \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eThe affinity would just be an optimization hint in creating the\u003cbr\\/\u003e\\ninitial flushed segments, so IW can speed up indexing.\u003c\\/p\u003e\\n\\n\u003cp\u003eProbably if you really want to keep the segments segregated like that,\u003cbr\\/\u003e\\nyou should in fact index to separate indices?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12857381_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12857381_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Apr\\/10 16:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-15T16:20:33+0000\'\u003e15\\/Apr\\/10 16:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n i would love to be able to explicitly define a \\\"segment\\\" affinity for documents i\'m feeding \\n\\n this would then allow me to say:  \\nall docs from table a has affinity 1 \\nall docs from table b has affinity 2  \\n\\n Right, this is exactly what affinity would be good for &#8211; so IW would \\ntry to send \\\"table a\\\" docs their own DW(s) and \\\"table b\\\" docs to their \\nown DW(s), which should give faster indexing than randomly binding to \\nDWs. \\n\\n But: \\n\\n  this would ideally result in indexing documents from each table into a different segment (obviously, i would then need to be able to have segment merging be affinity aware so optimize\\/merging would only merge segments that share an affinity)  \\n\\n This part I was not proposing   \\n\\n The affinity would just be an optimization hint in creating the \\ninitial flushed segments, so IW can speed up indexing. \\n\\n Probably if you really want to keep the segments segregated like that, \\nyou should in fact index to separate indices?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12857385\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12857385&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12857385\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"tsmith\\\" id=\\\"commentauthor_12857385_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=tsmith\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"tsmith\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tim Smith\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12857385_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Apr\\/10 16:27\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-15T16:27:02+0000\'\u003e15\\/Apr\\/10 16:27\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eProbably if you really want to keep the segments segregated like that, you should in fact index to separate indices?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThats what i\'m currently thinking i\'ll have to do\u003c\\/p\u003e\\n\\n\u003cp\u003ehowever it would be ideal if i could either subclass IndexWriter or use IndexWriter directly with this affinity concept (potentially writing my own segment merger that is affinity aware)\u003cbr\\/\u003e\\nthat makes it so i can easily use near real time indexing, as only one IndexWriter will be in the mix, as well as make managing deletes and a whole other host of issues with multiple indexes disappear\u003cbr\\/\u003e\\nAlso makes it so i can configure memory settings across all \\\"affinity groups\\\" instead of having to dynamically create them, each with their own memory bounds\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"tsmith\\\" id=\\\"commentauthor_12857385_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=tsmith\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"tsmith\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Tim Smith\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12857385_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Apr\\/10 16:27\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-15T16:27:02+0000\'\u003e15\\/Apr\\/10 16:27\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     Probably if you really want to keep the segments segregated like that, you should in fact index to separate indices?  \\n\\n Thats what i\'m currently thinking i\'ll have to do \\n\\n however it would be ideal if i could either subclass IndexWriter or use IndexWriter directly with this affinity concept (potentially writing my own segment merger that is affinity aware) \\nthat makes it so i can easily use near real time indexing, as only one IndexWriter will be in the mix, as well as make managing deletes and a whole other host of issues with multiple indexes disappear \\nAlso makes it so i can configure memory settings across all \\\"affinity groups\\\" instead of having to dynamically create them, each with their own memory bounds              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12858591\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12858591&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12858591\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12858591_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12858591_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Apr\\/10 16:48\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-19T16:48:51+0000\'\u003e19\\/Apr\\/10 16:48\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Michael Busch - 19\\/Apr\\/10 17:38\\\"\u003eedited\u003c\\/span\u003e \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eBut... could we allow an add\\/updateDocument call to express this\u003cbr\\/\u003e\\naffinity, explicitly? If you index homogenous docs you wouldn\'t use\u003cbr\\/\u003e\\nit, but, if you index drastically different docs that fall into clear\u003cbr\\/\u003e\\n\\\"categories\\\", expressing the affinity can get you a good gain in\u003cbr\\/\u003e\\nindexing throughput.\u003c\\/p\u003e\\n\\n\u003cp\u003eThis may be the best solution, since then one could pass the affinity\u003cbr\\/\u003e\\neven through a thread pool, and then we would fallback to thread\u003cbr\\/\u003e\\nbinding if the document class wasn\'t declared?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI would like this if we then also added an API that can be used to specify the\u003cbr\\/\u003e\\nper-DWPT RAM size.  E.g. if someone has such an app where different threads\u003cbr\\/\u003e\\nindex docs of different sizes, then the DW that indexes big docs can be given\u003cbr\\/\u003e\\nmore memory?\u003c\\/p\u003e\\n\\n\u003cp\u003eWhat I\'m mainly trying to avoid is synchronization points between the\u003cbr\\/\u003e\\ndifferent DWPTs.  For example, currently the same ByteBlockAllocator is shared\u003cbr\\/\u003e\\nbetween the different threads, so all its methods need to be synchronized.\u003c\\/p\u003e\\n\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eThe other DWs would keep indexing  That\'s the beauty of this\u003cbr\\/\u003e\\napproach... a flush of one DW doesn\'t stop all other DWs from\u003cbr\\/\u003e\\nindexing, unliked today.\u003c\\/p\u003e\\n\\n\u003cp\u003eAnd you want to serialize the flushing right? Ie, only one DW flushes\u003cbr\\/\u003e\\nat a time (the others keep indexing).\u003c\\/p\u003e\\n\\n\u003cp\u003eHmm I suppose flushing more than one should be allowed (OS\\/IO have\u003cbr\\/\u003e\\nalot of concurrency, esp since IO goes into write cache)... perhaps\u003cbr\\/\u003e\\nthat\'s the best way to balance index vs flush time? EG we pick one to\u003cbr\\/\u003e\\nflush @ 90%, if we cross 95% we pick another to flush, another at\u003cbr\\/\u003e\\n100%, etc.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eOh I don\'t want to disallow flushing in parallel!  I think it makes perfect\u003cbr\\/\u003e\\nsense to allow more than one DW to flush at the same time.  If each DWPT has a\u003cbr\\/\u003e\\nprivate max buffer size, then it can decide on its own when it\'s time to\u003cbr\\/\u003e\\nflush.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eHmm I suppose flushing more than one should be allowed (OS\\/IO have\u003cbr\\/\u003e\\nalot of concurrency, esp since IO goes into write cache)... perhaps\u003cbr\\/\u003e\\nthat\'s the best way to balance index vs flush time? EG we pick one to\u003cbr\\/\u003e\\nflush @ 90%, if we cross 95% we pick another to flush, another at\u003cbr\\/\u003e\\n100%, etc.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eIf we allow flushing in parallel and also allow specifying the max RAM per\u003cbr\\/\u003e\\nDWPT, then there doesn\'t even have to be any cross-thread RAM tracking?  Each\u003cbr\\/\u003e\\nDWPT could just flush when its own buffer is full?\u003c\\/p\u003e\\n\\n\u003cp\u003eSo let\'s summarize: \u003c\\/p\u003e\\n\u003col\u003e\\n\\t\u003cli\u003eExpose a ThreadBinder API for controlling number of DWPT instances and\u003cbr\\/\u003e\\nthread affinity of DWPTs explicitly. (We can later decide if we want to also\u003cbr\\/\u003e\\nsupport such an affinity after a segment was flushed, as Tim is asking for.\u003cbr\\/\u003e\\nBut that should IMO not be part of this patch.)\u003c\\/li\u003e\\n\\t\u003cli\u003eAlso expose an API for specifying the RAM buffer size per DWPT.\u003c\\/li\u003e\\n\\t\u003cli\u003eAllow flushing in parallel (multiple DWPTs can flush at the same time). A\u003cbr\\/\u003e\\nDWPT flushes when its buffer is full, independent of what the other DWPTs are\u003cbr\\/\u003e\\ndoing.\u003c\\/li\u003e\\n\\t\u003cli\u003eThe default implementation of the ThreadBinder API assigns threads to DWPT\u003cbr\\/\u003e\\nrandomly and gives each DWPT 1\\/n-th of the overall memory.\u003c\\/li\u003e\\n\\t\u003cli\u003eThe DWPT RAM value must be updateable.  E.g. when you first start indexing\u003cbr\\/\u003e\\nonly one DWPT should be created with the max RAM.  Then when multiple threads\u003cbr\\/\u003e\\nare used for adding documents another DWPT should be added and the RAM\u003cbr\\/\u003e\\nvalue of the already existing one should be reduced, and possibly a flush of that\u003cbr\\/\u003e\\nDWPT needs to be triggered.\u003c\\/li\u003e\\n\u003c\\/ol\u003e\\n\\n\\n\u003cp\u003eHow does this sound?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12858591_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12858591_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Apr\\/10 16:48\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-19T16:48:51+0000\'\u003e19\\/Apr\\/10 16:48\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Michael Busch - 19\\/Apr\\/10 17:38\\\"\u003eedited\u003c\\/span\u003e                   \\n But... could we allow an add\\/updateDocument call to express this \\naffinity, explicitly? If you index homogenous docs you wouldn\'t use \\nit, but, if you index drastically different docs that fall into clear \\n\\\"categories\\\", expressing the affinity can get you a good gain in \\nindexing throughput. \\n\\n This may be the best solution, since then one could pass the affinity \\neven through a thread pool, and then we would fallback to thread \\nbinding if the document class wasn\'t declared?  \\n\\n I would like this if we then also added an API that can be used to specify the \\nper-DWPT RAM size.  E.g. if someone has such an app where different threads \\nindex docs of different sizes, then the DW that indexes big docs can be given \\nmore memory? \\n\\n What I\'m mainly trying to avoid is synchronization points between the \\ndifferent DWPTs.  For example, currently the same ByteBlockAllocator is shared \\nbetween the different threads, so all its methods need to be synchronized. \\n\\n\\n \\n The other DWs would keep indexing  That\'s the beauty of this \\napproach... a flush of one DW doesn\'t stop all other DWs from \\nindexing, unliked today. \\n\\n And you want to serialize the flushing right? Ie, only one DW flushes \\nat a time (the others keep indexing). \\n\\n Hmm I suppose flushing more than one should be allowed (OS\\/IO have \\nalot of concurrency, esp since IO goes into write cache)... perhaps \\nthat\'s the best way to balance index vs flush time? EG we pick one to \\nflush @ 90%, if we cross 95% we pick another to flush, another at \\n100%, etc.  \\n\\n Oh I don\'t want to disallow flushing in parallel!  I think it makes perfect \\nsense to allow more than one DW to flush at the same time.  If each DWPT has a \\nprivate max buffer size, then it can decide on its own when it\'s time to \\nflush. \\n\\n \\n Hmm I suppose flushing more than one should be allowed (OS\\/IO have \\nalot of concurrency, esp since IO goes into write cache)... perhaps \\nthat\'s the best way to balance index vs flush time? EG we pick one to \\nflush @ 90%, if we cross 95% we pick another to flush, another at \\n100%, etc.  \\n\\n If we allow flushing in parallel and also allow specifying the max RAM per \\nDWPT, then there doesn\'t even have to be any cross-thread RAM tracking?  Each \\nDWPT could just flush when its own buffer is full? \\n\\n So let\'s summarize:  \\n \\n\\t Expose a ThreadBinder API for controlling number of DWPT instances and \\nthread affinity of DWPTs explicitly. (We can later decide if we want to also \\nsupport such an affinity after a segment was flushed, as Tim is asking for. \\nBut that should IMO not be part of this patch.) \\n\\t Also expose an API for specifying the RAM buffer size per DWPT. \\n\\t Allow flushing in parallel (multiple DWPTs can flush at the same time). A \\nDWPT flushes when its buffer is full, independent of what the other DWPTs are \\ndoing. \\n\\t The default implementation of the ThreadBinder API assigns threads to DWPT \\nrandomly and gives each DWPT 1\\/n-th of the overall memory. \\n\\t The DWPT RAM value must be updateable.  E.g. when you first start indexing \\nonly one DWPT should be created with the max RAM.  Then when multiple threads \\nare used for adding documents another DWPT should be added and the RAM \\nvalue of the already existing one should be reduced, and possibly a flush of that \\nDWPT needs to be triggered. \\n \\n\\n\\n How does this sound?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12858623\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12858623&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12858623\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12858623_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12858623_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Apr\\/10 18:28\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-19T18:28:31+0000\'\u003e19\\/Apr\\/10 18:28\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eMichael B, sounds good.  The approach outlined is straightforward and covers the edge cases.  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12858623_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12858623_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Apr\\/10 18:28\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-19T18:28:31+0000\'\u003e19\\/Apr\\/10 18:28\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Michael B, sounds good.  The approach outlined is straightforward and covers the edge cases.                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12858819\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12858819&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12858819\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12858819_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12858819_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Apr\\/10 11:14\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-20T11:14:24+0000\'\u003e20\\/Apr\\/10 11:14\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI still think this \\\"zero sync\'d code\\\" at the cost of perf loss \\/\u003cbr\\/\u003e\\nexposing per-DWPT details is taking things too far.  You\'re cutting\u003cbr\\/\u003e\\ninto the bone...\u003c\\/p\u003e\\n\\n\u003cp\u003eI don\'t think we should apps to be setting per-DWPT RAM limits, or,\u003cbr\\/\u003e\\neven expose to apps how IW manages threads (this is an impl. detail).\u003c\\/p\u003e\\n\\n\u003cp\u003eI think we should keep the approach we have today &#8211; you set the\u003cbr\\/\u003e\\noverall RAM limit and IW internally manages flushing when that\u003cbr\\/\u003e\\nallotted RAM is full.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eE.g. if someone has such an app where different threads\u003cbr\\/\u003e\\nindex docs of different sizes, then the DW that indexes big docs can be given\u003cbr\\/\u003e\\nmore memory?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eHmm this isn\'t really fair &#8211; the app in general can\'t predict how\u003cbr\\/\u003e\\nmany docs of each type will come in, how IW allocates RAM for\u003cbr\\/\u003e\\ndifferent kinds of docs (this is an impl detail), etc.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eWhat I\'m mainly trying to avoid is synchronization points between the\u003cbr\\/\u003e\\ndifferent DWPTs. For example, currently the same ByteBlockAllocator is shared\u003cbr\\/\u003e\\nbetween the different threads, so all its methods need to be synchronized.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI understand the motivation, but...\u003c\\/p\u003e\\n\\n\u003cp\u003eIs this sync really so bad?  First, we should move all\u003cbr\\/\u003e\\nallocators\\/pools to per-DWPT, so they don\'t need to be sync\'d.\u003c\\/p\u003e\\n\\n\u003cp\u003eThen, all that needs to be sync\'d is the tracking of net RAM used (a\u003cbr\\/\u003e\\nsingle long), and then the logic to pick the DWPT(s) to flush?  So\u003cbr\\/\u003e\\nthen each DWPT would allocate its own RAM (unsync\'d), track its own\u003cbr\\/\u003e\\nRAM used (unsync\'d), and update the total (in tiny sync block) after\u003cbr\\/\u003e\\nthe update (add\\/del) is serviced?\u003c\\/p\u003e\\n\\n\u003cp\u003eWe\'re still gonna need sync\'d code, anyway (global sequence ID,\u003cbr\\/\u003e\\ngrabbing a DWPT), right?  We can put this \\\"go flush a DWPT\\\" logic in\u003cbr\\/\u003e\\nthe same block if we really have to?  It feels like we\'re going to\u003cbr\\/\u003e\\ngreat lengths (cutting into the bone) to avoid a trivial cost (the\u003cbr\\/\u003e\\nminor complexity of managing flushing based on aggregate RAM used).\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003col\u003e\\n\\t\u003cli\u003eExpose a ThreadBinder API for controlling number of DWPT instances and\u003cbr\\/\u003e\\nthread affinity of DWPTs explicitly. (We can later decide if we want to also\u003cbr\\/\u003e\\nsupport such an affinity after a segment was flushed, as Tim is asking for.\u003cbr\\/\u003e\\nBut that should IMO not be part of this patch.)\u003c\\/li\u003e\\n\\t\u003cli\u003eAlso expose an API for specifying the RAM buffer size per DWPT.\u003c\\/li\u003e\\n\u003c\\/ol\u003e\\n\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI don\'t think we should expose so much.\u003c\\/p\u003e\\n\\n\u003cp\u003eI think, instead, we should add an optional method to Document (eg\u003cbr\\/\u003e\\nset\\/getSourceID or something), that\'d reference which \\\"source\\\" this\u003cbr\\/\u003e\\ndoc comes from.  The app would set it, optionally, as a \\\"hint\\\" to IW.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe source ID should not be publically tied to DWPT &#8211; how IW\u003cbr\\/\u003e\\noptimizes based on this \\\"hint\\\" from the app is really an impl detail.\u003cbr\\/\u003e\\nYes, today we\'ll use it for DWPT affinity; tomorrow, who knows.  EG,\u003cbr\\/\u003e\\nthat source ID need not be less than the max DWPTs.\u003c\\/p\u003e\\n\\n\u003cp\u003eWhen source ID isn\'t provided we\'d fallback to the same \\\"best guess\\\"\u003cbr\\/\u003e\\nwe have today (same thread = same source ID).\u003c\\/p\u003e\\n\\n\u003cp\u003eThe javadoc would be something like \\\"as a hint to IW, to possibly\u003cbr\\/\u003e\\nimprove its indexing performance, if you have docs from difference\u003cbr\\/\u003e\\nsources you should set the source ID on your Document\\\".  And\u003cbr\\/\u003e\\nhow\\/whether IW makes use of this information is \\\"under the hood\\\"...\u003c\\/p\u003e\\n\\n\u003cp\u003eWe can do this as a separate issue... it\'s fairly orthogonal.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eAllow flushing in parallel (multiple DWPTs can flush at the same time). \u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003e+1\u003c\\/p\u003e\\n\\n\u003cp\u003eThis would be a natural way to protect against too much RAM usage\u003cbr\\/\u003e\\nwhile flush(es) are happening.  Start one flush going, but keep\u003cbr\\/\u003e\\nindexing docs into the other DWTPs... if RAM usage grows too much\u003cbr\\/\u003e\\nbeyond your first trigger and before that first flush has finished,\u003cbr\\/\u003e\\nstart a 2nd DWPT flushing, etc.  This is naturally self-regulating,\u003cbr\\/\u003e\\nsince the \\\"mutator\\\" threads are tied up doing the flushing...\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eThe DWPT RAM value must be updateable. E.g. when you first start indexing\u003cbr\\/\u003e\\nonly one DWPT should be created with the max RAM. Then when multiple threads\u003cbr\\/\u003e\\nare used for adding documents another DWPT should be added and the RAM\u003cbr\\/\u003e\\nvalue of the already existing one should be reduced, and possibly a flush of that\u003cbr\\/\u003e\\nDWPT needs to be triggered.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThis isn\'t great... I mean it\'s weird that on adding say a 3rd\u003cbr\\/\u003e\\nindexing thread I suddenly see a flush triggered even though I\'m\u003cbr\\/\u003e\\nnowehere near the RAM limit.  Then, later, if I cut back to using only\u003cbr\\/\u003e\\n2 threads, I still only ever use up to 2\\/3rd of my RAM buffer.  IW\'s\u003cbr\\/\u003e\\nAPI really shouldn\'t have such \\\"surprising\\\" behavior where how many \\/\u003cbr\\/\u003e\\nwhich threads come through it so drastically affect it\'s flushing\u003cbr\\/\u003e\\nbehavior.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12858819_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12858819_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Apr\\/10 11:14\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-20T11:14:24+0000\'\u003e20\\/Apr\\/10 11:14\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I still think this \\\"zero sync\'d code\\\" at the cost of perf loss \\/ \\nexposing per-DWPT details is taking things too far.  You\'re cutting \\ninto the bone... \\n\\n I don\'t think we should apps to be setting per-DWPT RAM limits, or, \\neven expose to apps how IW manages threads (this is an impl. detail). \\n\\n I think we should keep the approach we have today &#8211; you set the \\noverall RAM limit and IW internally manages flushing when that \\nallotted RAM is full. \\n\\n \\n E.g. if someone has such an app where different threads \\nindex docs of different sizes, then the DW that indexes big docs can be given \\nmore memory?  \\n\\n Hmm this isn\'t really fair &#8211; the app in general can\'t predict how \\nmany docs of each type will come in, how IW allocates RAM for \\ndifferent kinds of docs (this is an impl detail), etc. \\n\\n \\n What I\'m mainly trying to avoid is synchronization points between the \\ndifferent DWPTs. For example, currently the same ByteBlockAllocator is shared \\nbetween the different threads, so all its methods need to be synchronized.  \\n\\n I understand the motivation, but... \\n\\n Is this sync really so bad?  First, we should move all \\nallocators\\/pools to per-DWPT, so they don\'t need to be sync\'d. \\n\\n Then, all that needs to be sync\'d is the tracking of net RAM used (a \\nsingle long), and then the logic to pick the DWPT(s) to flush?  So \\nthen each DWPT would allocate its own RAM (unsync\'d), track its own \\nRAM used (unsync\'d), and update the total (in tiny sync block) after \\nthe update (add\\/del) is serviced? \\n\\n We\'re still gonna need sync\'d code, anyway (global sequence ID, \\ngrabbing a DWPT), right?  We can put this \\\"go flush a DWPT\\\" logic in \\nthe same block if we really have to?  It feels like we\'re going to \\ngreat lengths (cutting into the bone) to avoid a trivial cost (the \\nminor complexity of managing flushing based on aggregate RAM used). \\n\\n \\n \\n\\t Expose a ThreadBinder API for controlling number of DWPT instances and \\nthread affinity of DWPTs explicitly. (We can later decide if we want to also \\nsupport such an affinity after a segment was flushed, as Tim is asking for. \\nBut that should IMO not be part of this patch.) \\n\\t Also expose an API for specifying the RAM buffer size per DWPT. \\n \\n \\n\\n I don\'t think we should expose so much. \\n\\n I think, instead, we should add an optional method to Document (eg \\nset\\/getSourceID or something), that\'d reference which \\\"source\\\" this \\ndoc comes from.  The app would set it, optionally, as a \\\"hint\\\" to IW. \\n\\n The source ID should not be publically tied to DWPT &#8211; how IW \\noptimizes based on this \\\"hint\\\" from the app is really an impl detail. \\nYes, today we\'ll use it for DWPT affinity; tomorrow, who knows.  EG, \\nthat source ID need not be less than the max DWPTs. \\n\\n When source ID isn\'t provided we\'d fallback to the same \\\"best guess\\\" \\nwe have today (same thread = same source ID). \\n\\n The javadoc would be something like \\\"as a hint to IW, to possibly \\nimprove its indexing performance, if you have docs from difference \\nsources you should set the source ID on your Document\\\".  And \\nhow\\/whether IW makes use of this information is \\\"under the hood\\\"... \\n\\n We can do this as a separate issue... it\'s fairly orthogonal. \\n\\n  Allow flushing in parallel (multiple DWPTs can flush at the same time).   \\n\\n +1 \\n\\n This would be a natural way to protect against too much RAM usage \\nwhile flush(es) are happening.  Start one flush going, but keep \\nindexing docs into the other DWTPs... if RAM usage grows too much \\nbeyond your first trigger and before that first flush has finished, \\nstart a 2nd DWPT flushing, etc.  This is naturally self-regulating, \\nsince the \\\"mutator\\\" threads are tied up doing the flushing... \\n\\n \\n The DWPT RAM value must be updateable. E.g. when you first start indexing \\nonly one DWPT should be created with the max RAM. Then when multiple threads \\nare used for adding documents another DWPT should be added and the RAM \\nvalue of the already existing one should be reduced, and possibly a flush of that \\nDWPT needs to be triggered.  \\n\\n This isn\'t great... I mean it\'s weird that on adding say a 3rd \\nindexing thread I suddenly see a flush triggered even though I\'m \\nnowehere near the RAM limit.  Then, later, if I cut back to using only \\n2 threads, I still only ever use up to 2\\/3rd of my RAM buffer.  IW\'s \\nAPI really shouldn\'t have such \\\"surprising\\\" behavior where how many \\/ \\nwhich threads come through it so drastically affect it\'s flushing \\nbehavior.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12858948\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12858948&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12858948\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12858948_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12858948_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Apr\\/10 15:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-20T15:50:55+0000\'\u003e20\\/Apr\\/10 15:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI get Michael B\'s motivation however Mike M\'s global ram limit\u003cbr\\/\u003e\\nis probably better from a user perspective and it would be a\u003cbr\\/\u003e\\nsync only on a long RAM used variable, so we should be good? \u003c\\/p\u003e\\n\\n\u003cp\u003eSounds like we use the current thread affinity system (ie, a\u003cbr\\/\u003e\\nhash map), that when the max threads is reached, new threads get\u003cbr\\/\u003e\\nkind of round robined onto existing DWPTs? \u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eif RAM usage grows too much beyond your first trigger and\u003cbr\\/\u003e\\nbefore that first flush has finished, start a 2nd DWPT flushing,\u003cbr\\/\u003e\\netc. \u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eWhat\'s the definition of the \\\"too much\\\" portion of the above\u003cbr\\/\u003e\\nstatement?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12858948_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12858948_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Apr\\/10 15:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-20T15:50:55+0000\'\u003e20\\/Apr\\/10 15:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I get Michael B\'s motivation however Mike M\'s global ram limit \\nis probably better from a user perspective and it would be a \\nsync only on a long RAM used variable, so we should be good?  \\n\\n Sounds like we use the current thread affinity system (ie, a \\nhash map), that when the max threads is reached, new threads get \\nkind of round robined onto existing DWPTs?  \\n\\n  if RAM usage grows too much beyond your first trigger and \\nbefore that first flush has finished, start a 2nd DWPT flushing, \\netc.   \\n\\n What\'s the definition of the \\\"too much\\\" portion of the above \\nstatement?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12858949\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12858949&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12858949\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12858949_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12858949_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Apr\\/10 15:51\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-20T15:51:22+0000\'\u003e20\\/Apr\\/10 15:51\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eI still think this \\\"zero sync\'d code\\\" at the cost of perf loss \\/\u003cbr\\/\u003e\\nexposing per-DWPT details is taking things too far. You\'re cutting\u003cbr\\/\u003e\\ninto the bone... \u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eNo worries - I haven\'t started implementing the RAM management part yet. \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eI don\'t think we should apps to be setting per-DWPT RAM limits, or,\u003cbr\\/\u003e\\neven expose to apps how IW manages threads (this is an impl. detail).\u003c\\/p\u003e\\n\\n\u003cp\u003eI think we should keep the approach we have today - you set the\u003cbr\\/\u003e\\noverall RAM limit and IW internally manages flushing when that\u003cbr\\/\u003e\\nallotted RAM is full.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI think the reason why we have two different APIs in mind (you: sourceID, I:\u003cbr\\/\u003e\\nexpert thread binder API) is that we\'re having different goals with them? You\u003cbr\\/\u003e\\nwant to make the out-of-the-box indexing performance as good as possible, and\u003cbr\\/\u003e\\nusers should have to set a minimum amount of easy-to-understand parameters\u003cbr\\/\u003e\\n(such as buffer size in MB). I think that\'s the right thing to do of course.\u003cbr\\/\u003e\\n(though that doesn\'t prevent us from adding an expert API in addition, as we\u003cbr\\/\u003e\\nalways have)\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'m thinking a lot about real-time indexing and the searchable RAM buffer\u003cbr\\/\u003e\\nthese days, so the thread-binder API could help you to have more control over\u003cbr\\/\u003e\\nwhere your docs will actually end up and which reader will see them. But I\u003cbr\\/\u003e\\nthink too that this API would be very \\\"expert\\\" and not many people would use\u003cbr\\/\u003e\\nit.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eWe can do this as a separate issue... it\'s fairly orthogonal.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYeah I was just thinking the same - I agree.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eIs this sync really so bad? First, we should move all\u003cbr\\/\u003e\\nallocators\\/pools to per-DWPT, so they don\'t need to be sync\'d.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eOK cool that we agree on that. I was worried you wanted to have global pools\u003cbr\\/\u003e\\ntoo, if it\'s only the single long it\'s not very complicated, I agree.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eWe\'re still gonna need sync\'d code, anyway (global sequence ID,\u003cbr\\/\u003e\\ngrabbing a DWPT), right? We can put this \\\"go flush a DWPT\\\" logic in\u003cbr\\/\u003e\\nthe same block if we really have to? It feels like we\'re going to\u003cbr\\/\u003e\\ngreat lengths (cutting into the bone) to avoid a trivial cost (the\u003cbr\\/\u003e\\nminor complexity of managing flushing based on aggregate RAM used).\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eSorry if I\'m being annoying \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e Yeah sure, there will be several sync\'d spots.\u003cbr\\/\u003e\\nIf we don\'t share any data structures between threads that hold indexed (and\u003cbr\\/\u003e\\nin the future searchable) data I\'m happy.\u003c\\/p\u003e\\n\\n\u003cp\u003eI haven\'t spent as much time as you thinking about the current RAM management\u003cbr\\/\u003e\\nyet and the current code that ensures thread safety - still learning some\u003cbr\\/\u003e\\nparts of the code. I do appreciate all your patient feedback!\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eThis isn\'t great... I mean it\'s weird that on adding say a 3rd\u003cbr\\/\u003e\\nindexing thread I suddenly see a flush triggered even though I\'m\u003cbr\\/\u003e\\nnowehere near the RAM limit. Then, later, if I cut back to using only\u003cbr\\/\u003e\\n2 threads, I still only ever use up to 2\\/3rd of my RAM buffer. IW\'s\u003cbr\\/\u003e\\nAPI really shouldn\'t have such \\\"surprising\\\" behavior where how many \\/\u003cbr\\/\u003e\\nwhich threads come through it so drastically affect it\'s flushing\u003cbr\\/\u003e\\nbehavior.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYeah I don\'t really like that either. Let\'s not do that. I had first not\u003cbr\\/\u003e\\nthought about that disadvantage, added this point later to the list, and never\u003cbr\\/\u003e\\nreally liked it. (and knew you would complain about it \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e )\u003c\\/p\u003e\\n\\n\u003cp\u003eMy goal is to have a default indexing chain that isn\'t slower than the one we\u003cbr\\/\u003e\\nhave today, but searchable and that very fast. That\'s not trivial, but I think\u003cbr\\/\u003e\\nwe can do it!\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'ll implement the global flush trigger and make all pools DWPT-local. The\u003cbr\\/\u003e\\nexplicit thread-binder or sourceID APIs we can worry about later, as we agreed\u003cbr\\/\u003e\\nabove.\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12858949_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12858949_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Apr\\/10 15:51\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-20T15:51:22+0000\'\u003e20\\/Apr\\/10 15:51\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n I still think this \\\"zero sync\'d code\\\" at the cost of perf loss \\/ \\nexposing per-DWPT details is taking things too far. You\'re cutting \\ninto the bone...   \\n\\n No worries - I haven\'t started implementing the RAM management part yet.   \\n\\n\\n \\n I don\'t think we should apps to be setting per-DWPT RAM limits, or, \\neven expose to apps how IW manages threads (this is an impl. detail). \\n\\n I think we should keep the approach we have today - you set the \\noverall RAM limit and IW internally manages flushing when that \\nallotted RAM is full.  \\n\\n I think the reason why we have two different APIs in mind (you: sourceID, I: \\nexpert thread binder API) is that we\'re having different goals with them? You \\nwant to make the out-of-the-box indexing performance as good as possible, and \\nusers should have to set a minimum amount of easy-to-understand parameters \\n(such as buffer size in MB). I think that\'s the right thing to do of course. \\n(though that doesn\'t prevent us from adding an expert API in addition, as we \\nalways have) \\n\\n I\'m thinking a lot about real-time indexing and the searchable RAM buffer \\nthese days, so the thread-binder API could help you to have more control over \\nwhere your docs will actually end up and which reader will see them. But I \\nthink too that this API would be very \\\"expert\\\" and not many people would use \\nit. \\n\\n  We can do this as a separate issue... it\'s fairly orthogonal.  \\n\\n Yeah I was just thinking the same - I agree. \\n\\n \\n Is this sync really so bad? First, we should move all \\nallocators\\/pools to per-DWPT, so they don\'t need to be sync\'d.  \\n\\n OK cool that we agree on that. I was worried you wanted to have global pools \\ntoo, if it\'s only the single long it\'s not very complicated, I agree. \\n\\n \\n We\'re still gonna need sync\'d code, anyway (global sequence ID, \\ngrabbing a DWPT), right? We can put this \\\"go flush a DWPT\\\" logic in \\nthe same block if we really have to? It feels like we\'re going to \\ngreat lengths (cutting into the bone) to avoid a trivial cost (the \\nminor complexity of managing flushing based on aggregate RAM used).  \\n\\n Sorry if I\'m being annoying   Yeah sure, there will be several sync\'d spots. \\nIf we don\'t share any data structures between threads that hold indexed (and \\nin the future searchable) data I\'m happy. \\n\\n I haven\'t spent as much time as you thinking about the current RAM management \\nyet and the current code that ensures thread safety - still learning some \\nparts of the code. I do appreciate all your patient feedback! \\n\\n \\n This isn\'t great... I mean it\'s weird that on adding say a 3rd \\nindexing thread I suddenly see a flush triggered even though I\'m \\nnowehere near the RAM limit. Then, later, if I cut back to using only \\n2 threads, I still only ever use up to 2\\/3rd of my RAM buffer. IW\'s \\nAPI really shouldn\'t have such \\\"surprising\\\" behavior where how many \\/ \\nwhich threads come through it so drastically affect it\'s flushing \\nbehavior.  \\n\\n Yeah I don\'t really like that either. Let\'s not do that. I had first not \\nthought about that disadvantage, added this point later to the list, and never \\nreally liked it. (and knew you would complain about it   ) \\n\\n My goal is to have a default indexing chain that isn\'t slower than the one we \\nhave today, but searchable and that very fast. That\'s not trivial, but I think \\nwe can do it! \\n\\n I\'ll implement the global flush trigger and make all pools DWPT-local. The \\nexplicit thread-binder or sourceID APIs we can worry about later, as we agreed \\nabove. \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12859375\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12859375&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12859375\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12859375_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859375_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Apr\\/10 14:42\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-21T14:42:12+0000\'\u003e21\\/Apr\\/10 14:42\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eI think the reason why we have two different APIs in mind (you: sourceID, I:\u003cbr\\/\u003e\\nexpert thread binder API) is that we\'re having different goals with\u003cbr\\/\u003e\\nthem?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYes, I think you\'re right!\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eYou want to make the out-of-the-box indexing performance as good as\u003cbr\\/\u003e\\npossible, and users should have to set a minimum amount of\u003cbr\\/\u003e\\neasy-to-understand parameters (such as buffer size in MB). I think\u003cbr\\/\u003e\\nthat\'s the right thing to do of course.  (though that doesn\'t prevent\u003cbr\\/\u003e\\nus from adding an expert API in addition, as we always have)\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eRight &#8211; simple things should be simple and complex things should be\u003cbr\\/\u003e\\npossible.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eI\'m thinking a lot about real-time indexing and the searchable RAM buffer\u003cbr\\/\u003e\\nthese days, so the thread-binder API could help you to have more control over\u003cbr\\/\u003e\\nwhere your docs will actually end up and which reader will see them. But I\u003cbr\\/\u003e\\nthink too that this API would be very \\\"expert\\\" and not many people would use\u003cbr\\/\u003e\\nit.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eIn fact now I want both \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eIe, make it possible (optional) to declare the sourceID, and IW\u003cbr\\/\u003e\\noptimizes based on this hint.\u003c\\/p\u003e\\n\\n\u003cp\u003eBut, also, letting advanced apps directly control individual DWPTs.\u003cbr\\/\u003e\\n(I think a new experimental Indexer interface can work well here...).\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cblockquote\u003e\u003cp\u003eWe can do this as a separate issue... it\'s fairly orthogonal.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYeah I was just thinking the same - I agree.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eOK I\'ll open this...\u003c\\/p\u003e\\n\\n\\n\u003cblockquote\u003e\\n\u003cblockquote\u003e\u003cp\u003eIs this sync really so bad? First, we should move all allocators\\/pools to per-DWPT, so they don\'t need to be sync\'d.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eOK cool that we agree on that. I was worried you wanted to have global pools\u003cbr\\/\u003e\\ntoo, if it\'s only the single long it\'s not very complicated, I agree.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYeah let\'s not do global pools (anymore!)...\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eSorry if I\'m being annoying \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eNo, you\'re not!  You\'re asking good questions (as usual)!\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eMy goal is to have a default indexing chain that isn\'t slower than the one we\u003cbr\\/\u003e\\nhave today, but searchable and that very fast. That\'s not trivial, but I think\u003cbr\\/\u003e\\nwe can do it!\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThis is an awesome goal, and I agree very reachable.  Though the\u003cbr\\/\u003e\\ndeletes\\/sequence ID\\/merging\\/NRT interaction is going to be fun...\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eI\'ll implement the global flush trigger and make all pools DWPT-local. The\u003cbr\\/\u003e\\nexplicit thread-binder or sourceID APIs we can worry about later, as we agreed\u003cbr\\/\u003e\\nabove.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eOK thanks.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12859375_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859375_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Apr\\/10 14:42\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-21T14:42:12+0000\'\u003e21\\/Apr\\/10 14:42\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n I think the reason why we have two different APIs in mind (you: sourceID, I: \\nexpert thread binder API) is that we\'re having different goals with \\nthem?  \\n\\n Yes, I think you\'re right! \\n\\n \\n You want to make the out-of-the-box indexing performance as good as \\npossible, and users should have to set a minimum amount of \\neasy-to-understand parameters (such as buffer size in MB). I think \\nthat\'s the right thing to do of course.  (though that doesn\'t prevent \\nus from adding an expert API in addition, as we always have)  \\n\\n Right &#8211; simple things should be simple and complex things should be \\npossible. \\n\\n \\n I\'m thinking a lot about real-time indexing and the searchable RAM buffer \\nthese days, so the thread-binder API could help you to have more control over \\nwhere your docs will actually end up and which reader will see them. But I \\nthink too that this API would be very \\\"expert\\\" and not many people would use \\nit.  \\n\\n In fact now I want both   \\n\\n Ie, make it possible (optional) to declare the sourceID, and IW \\noptimizes based on this hint. \\n\\n But, also, letting advanced apps directly control individual DWPTs. \\n(I think a new experimental Indexer interface can work well here...). \\n\\n \\n  We can do this as a separate issue... it\'s fairly orthogonal.  \\n\\n Yeah I was just thinking the same - I agree.  \\n\\n OK I\'ll open this... \\n\\n\\n \\n  Is this sync really so bad? First, we should move all allocators\\/pools to per-DWPT, so they don\'t need to be sync\'d.  \\n\\n OK cool that we agree on that. I was worried you wanted to have global pools \\ntoo, if it\'s only the single long it\'s not very complicated, I agree.  \\n\\n Yeah let\'s not do global pools (anymore!)... \\n\\n  Sorry if I\'m being annoying    \\n\\n No, you\'re not!  You\'re asking good questions (as usual)! \\n\\n \\n My goal is to have a default indexing chain that isn\'t slower than the one we \\nhave today, but searchable and that very fast. That\'s not trivial, but I think \\nwe can do it!  \\n\\n This is an awesome goal, and I agree very reachable.  Though the \\ndeletes\\/sequence ID\\/merging\\/NRT interaction is going to be fun... \\n\\n \\n I\'ll implement the global flush trigger and make all pools DWPT-local. The \\nexplicit thread-binder or sourceID APIs we can worry about later, as we agreed \\nabove.  \\n\\n OK thanks.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12859387\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12859387&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12859387\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12859387_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859387_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Apr\\/10 15:11\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-21T15:11:55+0000\'\u003e21\\/Apr\\/10 15:11\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eSounds like we use the current thread affinity system (ie, a\u003cbr\\/\u003e\\nhash map), that when the max threads is reached, new threads get\u003cbr\\/\u003e\\nkind of round robined onto existing DWPTs?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYeah something along those lines... and clearing out all mappings for\u003cbr\\/\u003e\\na given DWPT when it flushes.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cblockquote\u003e\u003cp\u003eif RAM usage grows too much beyond your first trigger and before that first flush has finished, start a 2nd DWPT flushing, etc.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eWhat\'s the definition of the \\\"too much\\\" portion of the above\u003cbr\\/\u003e\\nstatement?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eWe could do something simple, eg, at 90% RAM used, you flush your\u003cbr\\/\u003e\\nfirst DWPT.  At 110% RAM used, you flush all DWPTs.  And take linear\u003cbr\\/\u003e\\nsteps in between?\u003c\\/p\u003e\\n\\n\u003cp\u003eEG if I have 5 DWPTs, I\'d flush first one at 90%, 2nd at 95%, 3rd at\u003cbr\\/\u003e\\n100%, 4th at 105% and 5th at 110%.\u003c\\/p\u003e\\n\\n\u003cp\u003eOf course, if flushing is fast, then RAM is quickly freed up, then we\u003cbr\\/\u003e\\nonly flush 1 DWPT at a time... we only need these tiers to\u003cbr\\/\u003e\\nself-regulate RAM consumed from ongoing indexing vs time it takes to\u003cbr\\/\u003e\\ndo the flush.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12859387_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859387_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Apr\\/10 15:11\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-21T15:11:55+0000\'\u003e21\\/Apr\\/10 15:11\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n Sounds like we use the current thread affinity system (ie, a \\nhash map), that when the max threads is reached, new threads get \\nkind of round robined onto existing DWPTs?  \\n\\n Yeah something along those lines... and clearing out all mappings for \\na given DWPT when it flushes. \\n\\n \\n  if RAM usage grows too much beyond your first trigger and before that first flush has finished, start a 2nd DWPT flushing, etc.  \\n\\n What\'s the definition of the \\\"too much\\\" portion of the above \\nstatement?  \\n\\n We could do something simple, eg, at 90% RAM used, you flush your \\nfirst DWPT.  At 110% RAM used, you flush all DWPTs.  And take linear \\nsteps in between? \\n\\n EG if I have 5 DWPTs, I\'d flush first one at 90%, 2nd at 95%, 3rd at \\n100%, 4th at 105% and 5th at 110%. \\n\\n Of course, if flushing is fast, then RAM is quickly freed up, then we \\nonly flush 1 DWPT at a time... we only need these tiers to \\nself-regulate RAM consumed from ongoing indexing vs time it takes to \\ndo the flush.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12859489\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12859489&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12859489\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12859489_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859489_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Apr\\/10 19:11\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-21T19:11:44+0000\'\u003e21\\/Apr\\/10 19:11\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHow shall we actually handle flushing by maxBufferedDocs?  It\'d be the easiest to just make this a per-DWPT flush trigger.  Of course that\'d be a change in runtime behavior, but I think that\'s acceptable?\u003c\\/p\u003e\\n\\n\u003cp\u003eAnd flushing by maxBufferedDeleteTerms is also tricky, because that needs to be a flush across all DWPTs?  With searchable RAM buffers and deletes in the foreground this trigger should actually not be necessary anymore?  We would probably apply deletes when the realtime IndexReader is (re)opened?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12859489_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859489_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Apr\\/10 19:11\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-21T19:11:44+0000\'\u003e21\\/Apr\\/10 19:11\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    How shall we actually handle flushing by maxBufferedDocs?  It\'d be the easiest to just make this a per-DWPT flush trigger.  Of course that\'d be a change in runtime behavior, but I think that\'s acceptable? \\n\\n And flushing by maxBufferedDeleteTerms is also tricky, because that needs to be a flush across all DWPTs?  With searchable RAM buffers and deletes in the foreground this trigger should actually not be necessary anymore?  We would probably apply deletes when the realtime IndexReader is (re)opened?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12859511\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12859511&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12859511\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12859511_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859511_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Apr\\/10 20:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-21T20:16:06+0000\'\u003e21\\/Apr\\/10 20:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eflushing by maxBufferedDeleteTerms is also tricky,\u003cbr\\/\u003e\\nbecause that needs to be a flush across all DWPTs\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI think we simply keep track of maxBufferedDocs and\u003cbr\\/\u003e\\nmaxBufferedDeleteTerms globally. We can\'t deprecate because\u003cbr\\/\u003e\\nthat\'d be a pain for users. \u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eWith searchable RAM buffers and deletes in the foreground\u003cbr\\/\u003e\\nthis trigger should actually not be necessary anymore?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThe deletes aren\'t entirely in the foreground, only the RAM\u003cbr\\/\u003e\\nbuffer deletes. Deletes to existing segments would use the\u003cbr\\/\u003e\\nexisting clone and delete mechanism. I asked about foreground\u003cbr\\/\u003e\\ndeletes to existing segments before, and we agreed that it\'s not\u003cbr\\/\u003e\\na good idea due to locality of terms\\/postings.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eWe would probably apply deletes when the realtime\u003cbr\\/\u003e\\nIndexReader is (re)opened?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eRight, that\'s how the existing apply deletes basically works.\u003cbr\\/\u003e\\nThat\'d be the same. Oh ok, I see, perhaps the global deletes\u003cbr\\/\u003e\\nmanager could cache the deletes for the existing segments, the\u003cbr\\/\u003e\\nDWPTs can keep track of their deletes separately. We probably\u003cbr\\/\u003e\\nwon\'t apply segment or DWPT deletes in the foreground? We\'d\u003cbr\\/\u003e\\ncache them separately, and update ram consumption and unique\u003cbr\\/\u003e\\nterm\\/query counts globally. \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12859511_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859511_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Apr\\/10 20:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-21T20:16:06+0000\'\u003e21\\/Apr\\/10 20:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     flushing by maxBufferedDeleteTerms is also tricky, \\nbecause that needs to be a flush across all DWPTs  \\n\\n I think we simply keep track of maxBufferedDocs and \\nmaxBufferedDeleteTerms globally. We can\'t deprecate because \\nthat\'d be a pain for users.  \\n\\n  With searchable RAM buffers and deletes in the foreground \\nthis trigger should actually not be necessary anymore?  \\n\\n The deletes aren\'t entirely in the foreground, only the RAM \\nbuffer deletes. Deletes to existing segments would use the \\nexisting clone and delete mechanism. I asked about foreground \\ndeletes to existing segments before, and we agreed that it\'s not \\na good idea due to locality of terms\\/postings. \\n\\n  We would probably apply deletes when the realtime \\nIndexReader is (re)opened?  \\n\\n Right, that\'s how the existing apply deletes basically works. \\nThat\'d be the same. Oh ok, I see, perhaps the global deletes \\nmanager could cache the deletes for the existing segments, the \\nDWPTs can keep track of their deletes separately. We probably \\nwon\'t apply segment or DWPT deletes in the foreground? We\'d \\ncache them separately, and update ram consumption and unique \\nterm\\/query counts globally.               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12859590\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12859590&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12859590\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12859590_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859590_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Apr\\/10 23:59\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-21T23:59:51+0000\'\u003e21\\/Apr\\/10 23:59\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Michael Busch - 22\\/Apr\\/10 00:06\\\"\u003eedited\u003c\\/span\u003e \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eThe deletes aren\'t entirely in the foreground, only the RAM\u003cbr\\/\u003e\\nbuffer deletes. Deletes to existing segments would use the\u003cbr\\/\u003e\\nexisting clone and delete mechanism.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI think deletes should all be based on the new sequenceIDs. Today the buffered\u003cbr\\/\u003e\\ndeletes depend on a value that can change (numDocs changes when segments are\u003cbr\\/\u003e\\nmerged). But with sequenceIDs they\'re absolute: each delete operation will\u003cbr\\/\u003e\\nhave a sequenceID assigned, and the ordering of all write operations (add,\u003cbr\\/\u003e\\nupdate, delete) is unambiguously defined by the sequenceIDs. Remember that\u003cbr\\/\u003e\\naddDocument\\/updateDocument\\/deleteDocuments will all return the sequenceID.\u003c\\/p\u003e\\n\\n\u003cp\u003eThis means that we don\'t have to remap deletes anymore. Also the pooled\u003cbr\\/\u003e\\nSegmentReaders that read the flushed segments can use arrays of sequenceIDs\u003cbr\\/\u003e\\ninstead of BitSets? Of course that needs more memory, but even if you add 1M\u003cbr\\/\u003e\\ndocs without ever calling IW.commit\\/close you only need 8MB - I think that\'s\u003cbr\\/\u003e\\nacceptable. And this size is independent on how many times you call\u003cbr\\/\u003e\\nreopen\\/clone on the realtime readers, because they can all share the same\u003cbr\\/\u003e\\ndeletes array.\u003c\\/p\u003e\\n\\n\u003cp\u003eWe can also modify IW.commit\\/close to return the latest sequenceID. This would\u003cbr\\/\u003e\\nbe very nice for document tracking. E.g. when you hit an aborting exception\u003cbr\\/\u003e\\nafter you flushed already some segments, then even though you must discard\u003cbr\\/\u003e\\neverything in the DW\'s buffer you can still call commit\\/close to commit\u003cbr\\/\u003e\\neverything that doesn\'t have to be discarded. IW.commit\\/close would in that\u003cbr\\/\u003e\\ncase return the sequenceID of the latest write operation that was successfully\u003cbr\\/\u003e\\ncommitted, i.e. that would be visible to an IndexReader. Though we have to be\u003cbr\\/\u003e\\ncareful here: multiple segments can have interleaving sequenceIDs, so we must\u003cbr\\/\u003e\\ndiscard every segment that has one or more sequenceIDs greater than the lowest\u003cbr\\/\u003e\\none in the DW. So we still need the push-deletes logic, that keeps RAM deletes\u003cbr\\/\u003e\\nseparate from the flushed ones until flushing was successful.\u003c\\/p\u003e\\n\\n\u003cp\u003eDW\\/IW need to keep track of the largest sequenceID that is \u003cb\u003esafe\u003c\\/b\u003e, i.e. that\u003cbr\\/\u003e\\ncould be committed even if DW hits an aborting exception. Some invariants: \u003c\\/p\u003e\\n\u003cul\u003e\\n\\t\u003cli\u003eAll deletes with sequenceID smaller or equal to safeSeqID have already been\u003cbr\\/\u003e\\napplied to the deletes arrays of the flushed segments. \u003c\\/li\u003e\\n\\t\u003cli\u003eAll deletes with sequenceID greater than safeSeqID are in a deletesInRAM\u003cbr\\/\u003e\\nbuffer. \u003c\\/li\u003e\\n\\t\u003cli\u003esafeSeqID is always smaller than any buffered doc or buffered delete in DW\u003cbr\\/\u003e\\nor DWPT.\u003c\\/li\u003e\\n\\t\u003cli\u003esafeSeqID is always equal to the maximum sequenceID of one, and only one,\u003cbr\\/\u003e\\nflushed segment.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eWhen IW.close\\/commit is called then safeSeqID is returned. If no aborting\u003cbr\\/\u003e\\nexception occurred it equals the highest sequenceID ever assigned (during that\u003cbr\\/\u003e\\nIW \\\"session\\\"). In any case it\'s always the sequenceID of the latest write\u003cbr\\/\u003e\\noperation an IndexReader will \\\"see\\\" that you open after IW.close\\/commit\u003cbr\\/\u003e\\nfinished.\u003c\\/p\u003e\\n\\n\u003cp\u003eBut this would be nice for apps to track which docs made it successfully into\u003cbr\\/\u003e\\nthe index. Apps can then externally keep a log to figure out what they have to\u003cbr\\/\u003e\\nreply in case of exceptions.\u003c\\/p\u003e\\n\\n\u003cp\u003eDoes all this make sense? \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e This is very complex stuff, I wouldn\'t be\u003cbr\\/\u003e\\nsurprised if there\'s something I didn\'t think about.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12859590_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859590_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Apr\\/10 23:59\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-21T23:59:51+0000\'\u003e21\\/Apr\\/10 23:59\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Michael Busch - 22\\/Apr\\/10 00:06\\\"\u003eedited\u003c\\/span\u003e                   \\n The deletes aren\'t entirely in the foreground, only the RAM \\nbuffer deletes. Deletes to existing segments would use the \\nexisting clone and delete mechanism.  \\n\\n I think deletes should all be based on the new sequenceIDs. Today the buffered \\ndeletes depend on a value that can change (numDocs changes when segments are \\nmerged). But with sequenceIDs they\'re absolute: each delete operation will \\nhave a sequenceID assigned, and the ordering of all write operations (add, \\nupdate, delete) is unambiguously defined by the sequenceIDs. Remember that \\naddDocument\\/updateDocument\\/deleteDocuments will all return the sequenceID. \\n\\n This means that we don\'t have to remap deletes anymore. Also the pooled \\nSegmentReaders that read the flushed segments can use arrays of sequenceIDs \\ninstead of BitSets? Of course that needs more memory, but even if you add 1M \\ndocs without ever calling IW.commit\\/close you only need 8MB - I think that\'s \\nacceptable. And this size is independent on how many times you call \\nreopen\\/clone on the realtime readers, because they can all share the same \\ndeletes array. \\n\\n We can also modify IW.commit\\/close to return the latest sequenceID. This would \\nbe very nice for document tracking. E.g. when you hit an aborting exception \\nafter you flushed already some segments, then even though you must discard \\neverything in the DW\'s buffer you can still call commit\\/close to commit \\neverything that doesn\'t have to be discarded. IW.commit\\/close would in that \\ncase return the sequenceID of the latest write operation that was successfully \\ncommitted, i.e. that would be visible to an IndexReader. Though we have to be \\ncareful here: multiple segments can have interleaving sequenceIDs, so we must \\ndiscard every segment that has one or more sequenceIDs greater than the lowest \\none in the DW. So we still need the push-deletes logic, that keeps RAM deletes \\nseparate from the flushed ones until flushing was successful. \\n\\n DW\\/IW need to keep track of the largest sequenceID that is  safe , i.e. that \\ncould be committed even if DW hits an aborting exception. Some invariants:  \\n \\n\\t All deletes with sequenceID smaller or equal to safeSeqID have already been \\napplied to the deletes arrays of the flushed segments.  \\n\\t All deletes with sequenceID greater than safeSeqID are in a deletesInRAM \\nbuffer.  \\n\\t safeSeqID is always smaller than any buffered doc or buffered delete in DW \\nor DWPT. \\n\\t safeSeqID is always equal to the maximum sequenceID of one, and only one, \\nflushed segment. \\n \\n\\n\\n When IW.close\\/commit is called then safeSeqID is returned. If no aborting \\nexception occurred it equals the highest sequenceID ever assigned (during that \\nIW \\\"session\\\"). In any case it\'s always the sequenceID of the latest write \\noperation an IndexReader will \\\"see\\\" that you open after IW.close\\/commit \\nfinished. \\n\\n But this would be nice for apps to track which docs made it successfully into \\nthe index. Apps can then externally keep a log to figure out what they have to \\nreply in case of exceptions. \\n\\n Does all this make sense?   This is very complex stuff, I wouldn\'t be \\nsurprised if there\'s something I didn\'t think about.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12859737\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12859737&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12859737\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12859737_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859737_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Apr\\/10 08:17\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-22T08:17:06+0000\'\u003e22\\/Apr\\/10 08:17\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eI think we simply keep track of maxBufferedDocs and\u003cbr\\/\u003e\\nmaxBufferedDeleteTerms globally. We can\'t deprecate because\u003cbr\\/\u003e\\nthat\'d be a pain for users. \u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThe problem with maxBufferedDocs is that you can only enforce it by\u003cbr\\/\u003e\\n\\\"stopping the world\\\", i.e. preventing other DWPTs from adding docs while\u003cbr\\/\u003e\\none DWPT is flushing.  Unless we also introduce the 90%-95% etc flush\u003cbr\\/\u003e\\ntriggers for maxBufferedDocs.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe other option would be to have maxBufferedDocs per DWPT.  Then\u003cbr\\/\u003e\\nthe theoretical total limit of docs in RAM would be \u003cbr\\/\u003e\\nmaxNumberThreadStates * maxBufferedDocs.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12859737_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859737_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Apr\\/10 08:17\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-22T08:17:06+0000\'\u003e22\\/Apr\\/10 08:17\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n I think we simply keep track of maxBufferedDocs and \\nmaxBufferedDeleteTerms globally. We can\'t deprecate because \\nthat\'d be a pain for users.   \\n\\n The problem with maxBufferedDocs is that you can only enforce it by \\n\\\"stopping the world\\\", i.e. preventing other DWPTs from adding docs while \\none DWPT is flushing.  Unless we also introduce the 90%-95% etc flush \\ntriggers for maxBufferedDocs. \\n\\n The other option would be to have maxBufferedDocs per DWPT.  Then \\nthe theoretical total limit of docs in RAM would be  \\nmaxNumberThreadStates * maxBufferedDocs.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12859850\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12859850&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12859850\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12859850_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859850_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Apr\\/10 15:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-22T15:46:43+0000\'\u003e22\\/Apr\\/10 15:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eThe problem with maxBufferedDocs is that you can only enforce it by \\\"stopping the world\\\"\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eWhy not just stop the world for maxBufferedDocs\\/maxBufferedDelDocs?\u003cbr\\/\u003e\\nIt should be pretty simple to implement?\u003c\\/p\u003e\\n\\n\u003cp\u003eObviously you\'ll take a perf hit if you flush by these counts, so, you\u003cbr\\/\u003e\\nreally should flush by RAM instead... But some apps need this (eg\u003cbr\\/\u003e\\nsetting up indices for ParallelReader, until we get SliceWriter\u003cbr\\/\u003e\\nworking...).\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12859850_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859850_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Apr\\/10 15:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-22T15:46:43+0000\'\u003e22\\/Apr\\/10 15:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     The problem with maxBufferedDocs is that you can only enforce it by \\\"stopping the world\\\"  \\n\\n Why not just stop the world for maxBufferedDocs\\/maxBufferedDelDocs? \\nIt should be pretty simple to implement? \\n\\n Obviously you\'ll take a perf hit if you flush by these counts, so, you \\nreally should flush by RAM instead... But some apps need this (eg \\nsetting up indices for ParallelReader, until we get SliceWriter \\nworking...).              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12859900\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12859900&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12859900\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12859900_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859900_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Apr\\/10 17:01\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-22T17:01:00+0000\'\u003e22\\/Apr\\/10 17:01\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cblockquote\u003e\u003cp\u003eThe problem with maxBufferedDocs is that you can only enforce it by \\\"stopping the world\\\"\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eWhy not just stop the world for maxBufferedDocs\\/maxBufferedDelDocs?\u003cbr\\/\u003e\\nIt should be pretty simple to implement?\u003c\\/p\u003e\\n\\n\u003cp\u003eObviously you\'ll take a perf hit if you flush by these counts, so, you\u003cbr\\/\u003e\\nreally should flush by RAM instead... But some apps need this (eg\u003cbr\\/\u003e\\nsetting up indices for ParallelReader, until we get SliceWriter\u003cbr\\/\u003e\\nworking...).\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI\'m not sure I understand how this would help for ParallelReader?\u003cbr\\/\u003e\\nI think you can\'t use multi-threaded indexing even today, because you\u003cbr\\/\u003e\\nhave no control over the order in which the docs will make it into the\u003cbr\\/\u003e\\nindex.  \u003c\\/p\u003e\\n\\n\u003cp\u003eSo having maxBufferedDocs per DWPT seems tempting to me.  Then you know\u003cbr\\/\u003e\\nthat each written segment will have exactly a size of maxBufferedDocs,\u003cbr\\/\u003e\\nso this is much more predictable.  And if you index with a single \u003cbr\\/\u003e\\nthread only the behavior is identical to a \\\"global\\\" maxBufferedDocs\u003cbr\\/\u003e\\nflush trigger.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12859900_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859900_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Apr\\/10 17:01\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-22T17:01:00+0000\'\u003e22\\/Apr\\/10 17:01\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n  The problem with maxBufferedDocs is that you can only enforce it by \\\"stopping the world\\\"  \\n\\n Why not just stop the world for maxBufferedDocs\\/maxBufferedDelDocs? \\nIt should be pretty simple to implement? \\n\\n Obviously you\'ll take a perf hit if you flush by these counts, so, you \\nreally should flush by RAM instead... But some apps need this (eg \\nsetting up indices for ParallelReader, until we get SliceWriter \\nworking...).  \\n\\n I\'m not sure I understand how this would help for ParallelReader? \\nI think you can\'t use multi-threaded indexing even today, because you \\nhave no control over the order in which the docs will make it into the \\nindex.   \\n\\n So having maxBufferedDocs per DWPT seems tempting to me.  Then you know \\nthat each written segment will have exactly a size of maxBufferedDocs, \\nso this is much more predictable.  And if you index with a single  \\nthread only the behavior is identical to a \\\"global\\\" maxBufferedDocs \\nflush trigger.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12859906\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12859906&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12859906\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12859906_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859906_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Apr\\/10 17:08\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-22T17:08:41+0000\'\u003e22\\/Apr\\/10 17:08\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eI\'m not sure I understand how this would help for ParallelReader?\u003cbr\\/\u003e\\nI think you can\'t use multi-threaded indexing even today, because you\u003cbr\\/\u003e\\nhave no control over the order in which the docs will make it into the\u003cbr\\/\u003e\\nindex.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eWell, to set up indexes for PR today, you have to run IndexWriter in a very degraded state &#8211; flush by doc count, use a single thread, turn off concurrent merging (use SMS), use LogDocMergePolicy.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eSo having maxBufferedDocs per DWPT seems tempting to me. Then you know\u003cbr\\/\u003e\\nthat each written segment will have exactly a size of maxBufferedDocs,\u003cbr\\/\u003e\\nso this is much more predictable. And if you index with a single \u003cbr\\/\u003e\\nthread only the behavior is identical to a \\\"global\\\" maxBufferedDocs\u003cbr\\/\u003e\\nflush trigger.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\u003cp\u003eYeah, maybe that\'d be sufficient...?  It\'d sort of \\\"match\\\" the current behaviour, in that you get segments flushed to the index with that many docs.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12859906_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859906_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Apr\\/10 17:08\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-22T17:08:41+0000\'\u003e22\\/Apr\\/10 17:08\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n I\'m not sure I understand how this would help for ParallelReader? \\nI think you can\'t use multi-threaded indexing even today, because you \\nhave no control over the order in which the docs will make it into the \\nindex.  \\n\\n Well, to set up indexes for PR today, you have to run IndexWriter in a very degraded state &#8211; flush by doc count, use a single thread, turn off concurrent merging (use SMS), use LogDocMergePolicy. \\n\\n \\n So having maxBufferedDocs per DWPT seems tempting to me. Then you know \\nthat each written segment will have exactly a size of maxBufferedDocs, \\nso this is much more predictable. And if you index with a single  \\nthread only the behavior is identical to a \\\"global\\\" maxBufferedDocs \\nflush trigger.  \\n Yeah, maybe that\'d be sufficient...?  It\'d sort of \\\"match\\\" the current behaviour, in that you get segments flushed to the index with that many docs.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12859910\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12859910&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12859910\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12859910_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859910_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Apr\\/10 17:18\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-22T17:18:09+0000\'\u003e22\\/Apr\\/10 17:18\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eIt\'d sort of \\\"match\\\" the current behaviour, in that you get segments flushed to the index with that many docs.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eIt seems like the consensus is, most users don\'t use the maxBufferedDocs feature, however for the ones that do, we can stop the world and flush all segments?  That way we can focus on the RAM consumed use case?  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12859910_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859910_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Apr\\/10 17:18\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-22T17:18:09+0000\'\u003e22\\/Apr\\/10 17:18\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     It\'d sort of \\\"match\\\" the current behaviour, in that you get segments flushed to the index with that many docs.  \\n\\n It seems like the consensus is, most users don\'t use the maxBufferedDocs feature, however for the ones that do, we can stop the world and flush all segments?  That way we can focus on the RAM consumed use case?                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12859940\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12859940&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12859940\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12859940_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859940_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Apr\\/10 18:24\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-22T18:24:27+0000\'\u003e22\\/Apr\\/10 18:24\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eNo, I think the consensus is to have a DWPT maxBufferedDocs flush trigger, not a global one.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12859940_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859940_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Apr\\/10 18:24\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-22T18:24:27+0000\'\u003e22\\/Apr\\/10 18:24\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    No, I think the consensus is to have a DWPT maxBufferedDocs flush trigger, not a global one.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12859942\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12859942&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12859942\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12859942_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859942_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Apr\\/10 18:29\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-22T18:29:14+0000\'\u003e22\\/Apr\\/10 18:29\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eI think the consensus is to have a DWPT maxBufferedDocs flush trigger, not a global one. \u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eOk, so we\'ll need to implement dynamic resizing of the maxBufferedDocs per DWPT in the case where the maxNumberThreadStates changes?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12859942_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859942_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Apr\\/10 18:29\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-22T18:29:14+0000\'\u003e22\\/Apr\\/10 18:29\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     I think the consensus is to have a DWPT maxBufferedDocs flush trigger, not a global one.   \\n\\n Ok, so we\'ll need to implement dynamic resizing of the maxBufferedDocs per DWPT in the case where the maxNumberThreadStates changes?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12859953\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12859953&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12859953\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12859953_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859953_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Apr\\/10 18:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-22T18:53:18+0000\'\u003e22\\/Apr\\/10 18:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eNo, I think the consensus is to have a DWPT maxBufferedDocs flush trigger, not a global one. \u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI think we should just keep it simple.  If you set maxBufferedDocs to 1000, then every thread will flush at 1000 docs.\u003cbr\\/\u003e\\nIf you set maxThreadStates to 5, then you could at the same time in theory have 5000 docs in memory.\u003c\\/p\u003e\\n\\n\u003cp\u003eWe just have to explain this in the javadocs.  It\'s a change that we should also mention in the backwards-compatibility section.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12859953_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859953_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Apr\\/10 18:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-22T18:53:18+0000\'\u003e22\\/Apr\\/10 18:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     No, I think the consensus is to have a DWPT maxBufferedDocs flush trigger, not a global one.   \\n\\n I think we should just keep it simple.  If you set maxBufferedDocs to 1000, then every thread will flush at 1000 docs. \\nIf you set maxThreadStates to 5, then you could at the same time in theory have 5000 docs in memory. \\n\\n We just have to explain this in the javadocs.  It\'s a change that we should also mention in the backwards-compatibility section.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12859957\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12859957&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12859957\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12859957_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859957_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Apr\\/10 19:03\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-22T19:03:56+0000\'\u003e22\\/Apr\\/10 19:03\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eThis means that we don\'t have to remap deletes\u003cbr\\/\u003e\\nanymore.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eGood.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003ethe pooled SegmentReaders that read the flushed segments\u003cbr\\/\u003e\\ncan use arrays of sequenceIDs instead of BitSets?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eOk, that\'d be an improvement. In order to understand all the\u003cbr\\/\u003e\\nlogic, I\'d need to see a prototype, I can\'t really regurgitate\u003cbr\\/\u003e\\nwhat I\'ve read thus far. Are there any concurrency issues with\u003cbr\\/\u003e\\nthe seq arrays? Like say if a reader is iterating a posting\u003cbr\\/\u003e\\nlist? I guess not because we\'re always incrementing? \u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003esafeSeqID is always smaller than any buffered doc or\u003cbr\\/\u003e\\nbuffered delete in DW or DWPT.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eCan you elaborate on this? Wouldn\'t safeSeqID be greater than\u003cbr\\/\u003e\\nbuffered doc or deleted doc due to add\u003cbr\\/\u003e\\ndocs and interleaving?\u003c\\/p\u003e\\n\\n\u003cp\u003eAlso can we modify the terminology, perhaps committed seq id is\u003cbr\\/\u003e\\nbetter? To me that\'s a little more clear. Maybe it\'d be good to\u003cbr\\/\u003e\\nstart a wiki on this so we can have a master doc we\'re all\u003cbr\\/\u003e\\nreferring to (kind of a Solr thing that because the projects are\u003cbr\\/\u003e\\nmerged we can try for?) \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/wink.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12859957_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859957_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Apr\\/10 19:03\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-22T19:03:56+0000\'\u003e22\\/Apr\\/10 19:03\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     This means that we don\'t have to remap deletes \\nanymore.  \\n\\n Good. \\n\\n  the pooled SegmentReaders that read the flushed segments \\ncan use arrays of sequenceIDs instead of BitSets?  \\n\\n Ok, that\'d be an improvement. In order to understand all the \\nlogic, I\'d need to see a prototype, I can\'t really regurgitate \\nwhat I\'ve read thus far. Are there any concurrency issues with \\nthe seq arrays? Like say if a reader is iterating a posting \\nlist? I guess not because we\'re always incrementing?  \\n\\n  safeSeqID is always smaller than any buffered doc or \\nbuffered delete in DW or DWPT.  \\n\\n Can you elaborate on this? Wouldn\'t safeSeqID be greater than \\nbuffered doc or deleted doc due to add \\ndocs and interleaving? \\n\\n Also can we modify the terminology, perhaps committed seq id is \\nbetter? To me that\'s a little more clear. Maybe it\'d be good to \\nstart a wiki on this so we can have a master doc we\'re all \\nreferring to (kind of a Solr thing that because the projects are \\nmerged we can try for?)   \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12859966\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12859966&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12859966\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12859966_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859966_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Apr\\/10 19:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-22T19:16:36+0000\'\u003e22\\/Apr\\/10 19:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eWe just have to explain this in the javadocs. It\'s a change that we should also mention in the backwards-compatibility section.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eWe\'re punting eh?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12859966_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12859966_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Apr\\/10 19:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-04-22T19:16:36+0000\'\u003e22\\/Apr\\/10 19:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     We just have to explain this in the javadocs. It\'s a change that we should also mention in the backwards-compatibility section.  \\n\\n We\'re punting eh?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12876714\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12876714&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12876714\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12876714_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12876714_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Jun\\/10 16:25\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-06-08T16:25:00+0000\'\u003e08\\/Jun\\/10 16:25\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eMichael B, what\'s the status?  I\'m thinking of working on it.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12876714_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12876714_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Jun\\/10 16:25\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-06-08T16:25:00+0000\'\u003e08\\/Jun\\/10 16:25\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Michael B, what\'s the status?  I\'m thinking of working on it.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12877597\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12877597&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12877597\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12877597_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12877597_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Jun\\/10 22:15\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-06-10T22:15:22+0000\'\u003e10\\/Jun\\/10 22:15\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI just created a new branch for this (and related RT features) here:\u003cbr\\/\u003e\\n\u003ca href=\\\"https:\\/\\/svn.apache.org\\/repos\\/asf\\/lucene\\/dev\\/branches\\/realtime_search\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttps:\\/\\/svn.apache.org\\/repos\\/asf\\/lucene\\/dev\\/branches\\/realtime_search\u003c\\/a\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'ll commit the latest version of my patch soon (have to update to trunk and make it compile)...\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12877597_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12877597_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Jun\\/10 22:15\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-06-10T22:15:22+0000\'\u003e10\\/Jun\\/10 22:15\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I just created a new branch for this (and related RT features) here: \\n https:\\/\\/svn.apache.org\\/repos\\/asf\\/lucene\\/dev\\/branches\\/realtime_search  \\n\\n I\'ll commit the latest version of my patch soon (have to update to trunk and make it compile)...              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12890641\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12890641&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12890641\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12890641_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12890641_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Jul\\/10 10:22\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-21T10:22:14+0000\'\u003e21\\/Jul\\/10 10:22\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eFinally a new version of the patch! (Sorry for keeping you guys waiting...)\u003c\\/p\u003e\\n\\n\u003cp\u003eIt\'s not done yet, but it compiles (against realtime branch!) and &gt;95% of the core test cases pass.\u003c\\/p\u003e\\n\\n\u003cp\u003eWork done in addition to last patch:\u003c\\/p\u003e\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eAdded DocumentsWriterPerThread\u003c\\/li\u003e\\n\\t\u003cli\u003eReimplemented big parts of DocumentsWriter\u003c\\/li\u003e\\n\\t\u003cli\u003eAdded DocumentsWriterThreadPool which is an extension point for different pool implementation.  The default impl is\u003cbr\\/\u003e\\n  the ThreadAffinityDocumentsWriterThreadPool, which does what the old code did (try to assign a DWPT always to \u003cbr\\/\u003e\\n  the same thread).  It should be easy now to add Document#getSourceID() and another pool that can assign threads\u003cbr\\/\u003e\\n  based on the sourceID.\u003c\\/li\u003e\\n\\t\u003cli\u003eInitial implementation of sequenceIDs.  Currently they\'re only used to keep track of deletes and not for\u003cbr\\/\u003e\\n  e.g. NRT readers yet.\u003c\\/li\u003e\\n\\t\u003cli\u003eLots of other changes here and there.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eTODOs:\u003c\\/p\u003e\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eImplement flush-by-ram logic\u003c\\/li\u003e\\n\\t\u003cli\u003eImplement logic to discard deletes from the deletes buffer\u003c\\/li\u003e\\n\\t\u003cli\u003eFinish sequenceID handling: IW#commit() and IW#close() should return ID of last flushed sequenceID\u003c\\/li\u003e\\n\\t\u003cli\u003eMaybe change delete logic:  currently deletes are applied when a segment is flushed.  Maybe we can keep it this way\u003cbr\\/\u003e\\n  in the realtime-branch though, because that\'s most likely what we want to do once the RAM buffer is searchable and\u003cbr\\/\u003e\\n  deletes are cheaper as they can then be done in-memory before flush\u003c\\/li\u003e\\n\\t\u003cli\u003eFix unit tests (mostly exception handling and thread safety)\u003c\\/li\u003e\\n\\t\u003cli\u003eNew test cases, e.g. for sequenceID testing\u003c\\/li\u003e\\n\\t\u003cli\u003eSimplify code:  In some places I copied code around, which can probably be further simplified\u003c\\/li\u003e\\n\\t\u003cli\u003eI started removing some of the old setters\\/getters in IW which are not in IndexWriterConfig - need to finish that,\u003cbr\\/\u003e\\n  or revert those changes and use a different patch\u003c\\/li\u003e\\n\\t\u003cli\u003eFix nocommits\u003c\\/li\u003e\\n\\t\u003cli\u003ePerformance testing\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eI\'m planning to commit this soon to the realtime branch, even though it\'s obviously not done yet.  But it\'s a big \u003cbr\\/\u003e\\npatch and changes will be easier to track with an svn history.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12890641_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12890641_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Jul\\/10 10:22\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-21T10:22:14+0000\'\u003e21\\/Jul\\/10 10:22\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Finally a new version of the patch! (Sorry for keeping you guys waiting...) \\n\\n It\'s not done yet, but it compiles (against realtime branch!) and &gt;95% of the core test cases pass. \\n\\n Work done in addition to last patch: \\n\\n \\n\\t Added DocumentsWriterPerThread \\n\\t Reimplemented big parts of DocumentsWriter \\n\\t Added DocumentsWriterThreadPool which is an extension point for different pool implementation.  The default impl is \\n  the ThreadAffinityDocumentsWriterThreadPool, which does what the old code did (try to assign a DWPT always to  \\n  the same thread).  It should be easy now to add Document#getSourceID() and another pool that can assign threads \\n  based on the sourceID. \\n\\t Initial implementation of sequenceIDs.  Currently they\'re only used to keep track of deletes and not for \\n  e.g. NRT readers yet. \\n\\t Lots of other changes here and there. \\n \\n\\n\\n TODOs: \\n\\n \\n\\t Implement flush-by-ram logic \\n\\t Implement logic to discard deletes from the deletes buffer \\n\\t Finish sequenceID handling: IW#commit() and IW#close() should return ID of last flushed sequenceID \\n\\t Maybe change delete logic:  currently deletes are applied when a segment is flushed.  Maybe we can keep it this way \\n  in the realtime-branch though, because that\'s most likely what we want to do once the RAM buffer is searchable and \\n  deletes are cheaper as they can then be done in-memory before flush \\n\\t Fix unit tests (mostly exception handling and thread safety) \\n\\t New test cases, e.g. for sequenceID testing \\n\\t Simplify code:  In some places I copied code around, which can probably be further simplified \\n\\t I started removing some of the old setters\\/getters in IW which are not in IndexWriterConfig - need to finish that, \\n  or revert those changes and use a different patch \\n\\t Fix nocommits \\n\\t Performance testing \\n \\n\\n\\n I\'m planning to commit this soon to the realtime branch, even though it\'s obviously not done yet.  But it\'s a big  \\npatch and changes will be easier to track with an svn history.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12890643\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12890643&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12890643\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12890643_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12890643_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Jul\\/10 10:32\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-21T10:32:46+0000\'\u003e21\\/Jul\\/10 10:32\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eOK, I committed to the branch.  I\'ll try tomorrow to merge trunk into the branch.  I was already warned that there will most likely be lots of conflicts - so help is welcome! \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12890643_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12890643_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Jul\\/10 10:32\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-21T10:32:46+0000\'\u003e21\\/Jul\\/10 10:32\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    OK, I committed to the branch.  I\'ll try tomorrow to merge trunk into the branch.  I was already warned that there will most likely be lots of conflicts - so help is welcome!                  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12890789\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12890789&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12890789\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12890789_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12890789_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Jul\\/10 17:34\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-21T17:34:30+0000\'\u003e21\\/Jul\\/10 17:34\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eMichael, thanks for posting and committing the patch.  I\'ll be taking a look.\u003c\\/p\u003e\\n\\n\u003cp\u003eBefore I\\/we forget, maybe we can describe what we discussed about RT features such as the terms dictionary (the AtomicIntArray linked list, possible usage of a btree), the multi-level skip list (static levels), and other such features at: \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2312\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttps:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2312\u003c\\/a\u003e\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12890789_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12890789_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Jul\\/10 17:34\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-21T17:34:30+0000\'\u003e21\\/Jul\\/10 17:34\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Michael, thanks for posting and committing the patch.  I\'ll be taking a look. \\n\\n Before I\\/we forget, maybe we can describe what we discussed about RT features such as the terms dictionary (the AtomicIntArray linked list, possible usage of a btree), the multi-level skip list (static levels), and other such features at:  https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2312               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12890790\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12890790&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12890790\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12890790_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12890790_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Jul\\/10 17:37\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-21T17:37:28+0000\'\u003e21\\/Jul\\/10 17:37\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eWe need to update the indexing chain comment in DocumentsWriterPerThread\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12890790_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12890790_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Jul\\/10 17:37\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-21T17:37:28+0000\'\u003e21\\/Jul\\/10 17:37\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    We need to update the indexing chain comment in DocumentsWriterPerThread              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12890812\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12890812&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12890812\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12890812_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12890812_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Jul\\/10 18:28\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-21T18:28:51+0000\'\u003e21\\/Jul\\/10 18:28\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eWe need to update the indexing chain comment in DocumentsWriterPerThread \u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThere\'s a lot of code cleanup to do.  I just wanted to checkpoint what I have so far.\u003c\\/p\u003e\\n\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eBefore I\\/we forget, maybe we can describe what we discussed about RT features such as the terms dictionary (the AtomicIntArray linked list, possible usage of a btree), the multi-level skip list (static levels), and other such features at: \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2312\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttps:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2312\u003c\\/a\u003e\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYeah, I will.  But first I need to catch up on sleep \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12890812_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12890812_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Jul\\/10 18:28\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-21T18:28:51+0000\'\u003e21\\/Jul\\/10 18:28\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n We need to update the indexing chain comment in DocumentsWriterPerThread   \\n\\n There\'s a lot of code cleanup to do.  I just wanted to checkpoint what I have so far. \\n\\n\\n \\n Before I\\/we forget, maybe we can describe what we discussed about RT features such as the terms dictionary (the AtomicIntArray linked list, possible usage of a btree), the multi-level skip list (static levels), and other such features at:  https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2312   \\n\\n Yeah, I will.  But first I need to catch up on sleep                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12890893\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12890893&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12890893\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12890893_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12890893_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Jul\\/10 21:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-21T21:02:26+0000\'\u003e21\\/Jul\\/10 21:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eLooks like we\'re not using MergeDocIDRemapper anymore?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12890893_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12890893_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Jul\\/10 21:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-21T21:02:26+0000\'\u003e21\\/Jul\\/10 21:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Looks like we\'re not using MergeDocIDRemapper anymore?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12890905\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12890905&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12890905\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12890905_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12890905_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Jul\\/10 21:22\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-21T21:22:26+0000\'\u003e21\\/Jul\\/10 21:22\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eImplement logic to discard deletes from the deletes\u003cbr\\/\u003e\\nbuffer\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eMichael, where in the code is this supposed to occur?\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eImplement flush-by-ram logic\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI\'ll make a go of this.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eMaybe change delete logic: currently deletes are applied\u003cbr\\/\u003e\\nwhen a segment is flushed. Maybe we can keep it this way in the\u003cbr\\/\u003e\\nrealtime-branch though, because that\'s most likely what we want\u003cbr\\/\u003e\\nto do once the RAM buffer is searchable and deletes are cheaper\u003cbr\\/\u003e\\nas they can then be done in-memory before flush\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI think we\'ll keep things this way for this issue (ie, per\u003cbr\\/\u003e\\nthread document writers), however for \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2312\\\" title=\\\"Search on IndexWriter&#39;s RAM Buffer\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2312\\\"\u003eLUCENE-2312\u003c\\/a\u003e I think we\'ll\u003cbr\\/\u003e\\nwant to implement foreground deletes (eg, updating the deleted\u003cbr\\/\u003e\\ndocs sequences int[]).\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12890905_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12890905_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Jul\\/10 21:22\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-21T21:22:26+0000\'\u003e21\\/Jul\\/10 21:22\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     Implement logic to discard deletes from the deletes \\nbuffer  \\n\\n Michael, where in the code is this supposed to occur? \\n\\n  Implement flush-by-ram logic  \\n\\n I\'ll make a go of this. \\n\\n  Maybe change delete logic: currently deletes are applied \\nwhen a segment is flushed. Maybe we can keep it this way in the \\nrealtime-branch though, because that\'s most likely what we want \\nto do once the RAM buffer is searchable and deletes are cheaper \\nas they can then be done in-memory before flush  \\n\\n I think we\'ll keep things this way for this issue (ie, per \\nthread document writers), however for  LUCENE-2312  I think we\'ll \\nwant to implement foreground deletes (eg, updating the deleted \\ndocs sequences int[]).              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12891085\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12891085&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12891085\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12891085_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12891085_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Jul\\/10 10:27\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-22T10:27:35+0000\'\u003e22\\/Jul\\/10 10:27\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThis is looking awesome Michael!  I love the removal of *PerThread &#8211;\u003cbr\\/\u003e\\nthey are all logically absorbed into DWPT, so everything is now per\u003cbr\\/\u003e\\nthread.\u003c\\/p\u003e\\n\\n\u003cp\u003eI still see usage of docStoreOffset, but aren\'t we doing away with\u003cbr\\/\u003e\\nshared doc stores with the cutover to DWPT?\u003c\\/p\u003e\\n\\n\u003cp\u003eI think you can further simplify DocumentsWriterPerThread.DocWriter;\u003cbr\\/\u003e\\nin fact I think you can remove it &amp; all subclasses in consumers!  The\u003cbr\\/\u003e\\nconsumers can simply directly write their files.  The only reason this\u003cbr\\/\u003e\\nclass was created was because we have to interleave docs when writing\u003cbr\\/\u003e\\nthe doc stores; this is no longer needed since doc stores are again\u003cbr\\/\u003e\\nprivate to the segment.  I think we don\'t need PerDocBuffer, either.\u003cbr\\/\u003e\\nAnd this also simplifies RAM usage tracking!\u003c\\/p\u003e\\n\\n\u003cp\u003eAlso, we don\'t need separate closeDocStore; it should just be closed\u003cbr\\/\u003e\\nduring flush.\u003c\\/p\u003e\\n\\n\u003cp\u003eI like the ThreadAffinityDocumentsWriterThreadPool; it\'s the default\u003cbr\\/\u003e\\nright (I see some tests explicitly setting in on IWC; not sure why)?\u003c\\/p\u003e\\n\\n\u003cp\u003eWe should make the in-RAM deletes impl somehow pluggable?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12891085_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12891085_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Jul\\/10 10:27\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-22T10:27:35+0000\'\u003e22\\/Jul\\/10 10:27\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    This is looking awesome Michael!  I love the removal of *PerThread &#8211; \\nthey are all logically absorbed into DWPT, so everything is now per \\nthread. \\n\\n I still see usage of docStoreOffset, but aren\'t we doing away with \\nshared doc stores with the cutover to DWPT? \\n\\n I think you can further simplify DocumentsWriterPerThread.DocWriter; \\nin fact I think you can remove it &amp; all subclasses in consumers!  The \\nconsumers can simply directly write their files.  The only reason this \\nclass was created was because we have to interleave docs when writing \\nthe doc stores; this is no longer needed since doc stores are again \\nprivate to the segment.  I think we don\'t need PerDocBuffer, either. \\nAnd this also simplifies RAM usage tracking! \\n\\n Also, we don\'t need separate closeDocStore; it should just be closed \\nduring flush. \\n\\n I like the ThreadAffinityDocumentsWriterThreadPool; it\'s the default \\nright (I see some tests explicitly setting in on IWC; not sure why)? \\n\\n We should make the in-RAM deletes impl somehow pluggable?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12891228\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12891228&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12891228\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12891228_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12891228_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Jul\\/10 16:19\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-22T16:19:20+0000\'\u003e22\\/Jul\\/10 16:19\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks, Mike - great feedback! (as always)\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eI still see usage of docStoreOffset, but aren\'t we doing away with\u003cbr\\/\u003e\\nshared doc stores with the cutover to DWPT?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eDo we want all segments that one DWPT writes to share the same\u003cbr\\/\u003e\\ndoc store, i.e. one doc store per DWPT, or remove doc stores \u003cbr\\/\u003e\\nentirely?\u003c\\/p\u003e\\n\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eI think you can further simplify DocumentsWriterPerThread.DocWriter;\u003cbr\\/\u003e\\nin fact I think you can remove it &amp; all subclasses in consumers!\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI agree!  Now that a high number of testcases pass it\'s less scary\u003cbr\\/\u003e\\nto modify even more code \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e  - will do this next.\u003c\\/p\u003e\\n\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eAlso, we don\'t need separate closeDocStore; it should just be closed\u003cbr\\/\u003e\\nduring flush.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eOK sounds good.\u003c\\/p\u003e\\n\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eI like the ThreadAffinityDocumentsWriterThreadPool; it\'s the default\u003cbr\\/\u003e\\nright (I see some tests explicitly setting in on IWC; not sure why)?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eIt\'s actually only TestStressIndexing2 and it sets it to use a different \u003cbr\\/\u003e\\nnumber of max thread states than the default.\u003c\\/p\u003e\\n\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eWe should make the in-RAM deletes impl somehow pluggable?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eDo you mean so that it\'s customizable how deletes are handled? \u003cbr\\/\u003e\\nE.g. doing live deletes vs. lazy deletes on flush?\u003cbr\\/\u003e\\nI think that\'s a good idea.  E.g. at Twitter we\'ll do live deletes always\u003cbr\\/\u003e\\nto get the lowest latency (and we don\'t have too many deletes),\u003cbr\\/\u003e\\nbut that\'s probably not the best default for everyone.\u003cbr\\/\u003e\\nSo I agree that making this customizable is a good idea.\u003c\\/p\u003e\\n\\n\u003cp\u003eIt\'d also be nice to have a more efficient data structure to buffer the\u003cbr\\/\u003e\\ndeletes.  With many buffered deletes the java hashmap approach\u003cbr\\/\u003e\\nwill not be very efficient.  Terms could be written into a byte pool,\u003cbr\\/\u003e\\nbut what should we do with queries?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12891228_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12891228_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Jul\\/10 16:19\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-22T16:19:20+0000\'\u003e22\\/Jul\\/10 16:19\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks, Mike - great feedback! (as always) \\n\\n \\n I still see usage of docStoreOffset, but aren\'t we doing away with \\nshared doc stores with the cutover to DWPT?  \\n\\n Do we want all segments that one DWPT writes to share the same \\ndoc store, i.e. one doc store per DWPT, or remove doc stores  \\nentirely? \\n\\n\\n \\n I think you can further simplify DocumentsWriterPerThread.DocWriter; \\nin fact I think you can remove it &amp; all subclasses in consumers!  \\n\\n I agree!  Now that a high number of testcases pass it\'s less scary \\nto modify even more code    - will do this next. \\n\\n\\n \\n Also, we don\'t need separate closeDocStore; it should just be closed \\nduring flush.  \\n\\n OK sounds good. \\n\\n\\n \\n I like the ThreadAffinityDocumentsWriterThreadPool; it\'s the default \\nright (I see some tests explicitly setting in on IWC; not sure why)?  \\n\\n It\'s actually only TestStressIndexing2 and it sets it to use a different  \\nnumber of max thread states than the default. \\n\\n\\n \\n We should make the in-RAM deletes impl somehow pluggable?  \\n\\n Do you mean so that it\'s customizable how deletes are handled?  \\nE.g. doing live deletes vs. lazy deletes on flush? \\nI think that\'s a good idea.  E.g. at Twitter we\'ll do live deletes always \\nto get the lowest latency (and we don\'t have too many deletes), \\nbut that\'s probably not the best default for everyone. \\nSo I agree that making this customizable is a good idea. \\n\\n It\'d also be nice to have a more efficient data structure to buffer the \\ndeletes.  With many buffered deletes the java hashmap approach \\nwill not be very efficient.  Terms could be written into a byte pool, \\nbut what should we do with queries?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12891241\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12891241&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12891241\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12891241_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12891241_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Jul\\/10 16:56\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-22T16:56:05+0000\'\u003e22\\/Jul\\/10 16:56\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eIt\'d also be nice to have a more efficient data structure to buffer the deletes. With many buffered deletes the java hashmap approach will not be very efficient. Terms could be written into a byte pool, but what should we do with queries?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eIMO, terms are an order of magnitude more important than queries.  Most deletes will be by some sort of unique id, and will be in the same field.\u003c\\/p\u003e\\n\\n\u003cp\u003ePerhaps a single byte[] with length prefixes (like the field cache has).  A single int could then represent a term (it would just be an offset into the byte[], which is field-specific, so no need to store the field each time).\u003c\\/p\u003e\\n\\n\u003cp\u003eWe could then build a treemap or hashmap that natively used an int[]... but that may not be necessary (depending on how deletes are applied).  Perhaps a sort could be done right before applying, and duplicate terms could be handled at that time.\u003c\\/p\u003e\\n\\n\u003cp\u003eAnyway, I\'m only casually following this issue, but I\'ts looking like really cool stuff!\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12891241_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12891241_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Jul\\/10 16:56\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-22T16:56:05+0000\'\u003e22\\/Jul\\/10 16:56\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     It\'d also be nice to have a more efficient data structure to buffer the deletes. With many buffered deletes the java hashmap approach will not be very efficient. Terms could be written into a byte pool, but what should we do with queries?  \\n\\n IMO, terms are an order of magnitude more important than queries.  Most deletes will be by some sort of unique id, and will be in the same field. \\n\\n Perhaps a single byte[] with length prefixes (like the field cache has).  A single int could then represent a term (it would just be an offset into the byte[], which is field-specific, so no need to store the field each time). \\n\\n We could then build a treemap or hashmap that natively used an int[]... but that may not be necessary (depending on how deletes are applied).  Perhaps a sort could be done right before applying, and duplicate terms could be handled at that time. \\n\\n Anyway, I\'m only casually following this issue, but I\'ts looking like really cool stuff!              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12891256\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12891256&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12891256\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12891256_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12891256_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Jul\\/10 17:30\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-22T17:30:21+0000\'\u003e22\\/Jul\\/10 17:30\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cblockquote\u003e\u003cp\u003eI still see usage of docStoreOffset, but aren\'t we doing away with shared doc stores with the cutover to DWPT?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eDo we want all segments that one DWPT writes to share the same\u003cbr\\/\u003e\\ndoc store, i.e. one doc store per DWPT, or remove doc stores \u003cbr\\/\u003e\\nentirely?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eOh good question... a single DWPT can in fact continue to share doc\u003cbr\\/\u003e\\nstore across the segments it flushes.\u003c\\/p\u003e\\n\\n\u003cp\u003eHmm, but... this opto only helps in that we don\'t have to merge the\u003cbr\\/\u003e\\ndoc stores if we merge segments that already share their doc stores.\u003cbr\\/\u003e\\nBut if (say) I have 2 threads indexing, and I\'m indexing lots of docs\u003cbr\\/\u003e\\nand each DWPT has written 5 segments, we will then merge these 10\u003cbr\\/\u003e\\nsegments, and must merge the doc stores at that point.  So the sharing\u003cbr\\/\u003e\\nisn\'t really buying us much (just not closing old files &amp; opening new\u003cbr\\/\u003e\\nones, which is presumably negligible)?\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cblockquote\u003e\u003cp\u003eI think you can further simplify DocumentsWriterPerThread.DocWriter; in fact I think you can remove it &amp; all subclasses in consumers!\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI agree! Now that a high number of testcases pass it\'s less scary\u003cbr\\/\u003e\\nto modify even more code  - will do this next.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eAlso, we don\'t need separate closeDocStore; it should just be closed during flush.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eOK sounds good.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eSuper \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cblockquote\u003e\u003cp\u003eI like the ThreadAffinityDocumentsWriterThreadPool; it\'s the default right (I see some tests explicitly setting in on IWC; not sure why)?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eIt\'s actually only TestStressIndexing2 and it sets it to use a different \u003cbr\\/\u003e\\nnumber of max thread states than the default.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eAhh OK great.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cblockquote\u003e\u003cp\u003eWe should make the in-RAM deletes impl somehow pluggable?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eDo you mean so that it\'s customizable how deletes are handled? \u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eActually I was worried about the long[] sequenceIDs (adding 8 bytes\u003cbr\\/\u003e\\nRAM per buffered doc) &#8211; this could be a biggish hit to RAM efficiency\u003cbr\\/\u003e\\nfor small docs.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003e E.g. doing live deletes vs. lazy deletes on flush?\u003cbr\\/\u003e\\nI think that\'s a good idea. E.g. at Twitter we\'ll do live deletes always\u003cbr\\/\u003e\\nto get the lowest latency (and we don\'t have too many deletes),\u003cbr\\/\u003e\\nbut that\'s probably not the best default for everyone.\u003cbr\\/\u003e\\nSo I agree that making this customizable is a good idea.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYeah, this too \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eActually deletions today are not applied on flush &#8211; they continue to\u003cbr\\/\u003e\\nbe buffered beyond flush, and then get applied just before a merge\u003cbr\\/\u003e\\nkicks off.  I think we should keep this (as an option and probably as\u003cbr\\/\u003e\\nthe default) &#8211; it\'s important for apps w\\/ large indices that don\'t use\u003cbr\\/\u003e\\nNRT (and don\'t pool readers) because it\'s costly to open readers.\u003c\\/p\u003e\\n\\n\u003cp\u003eSo it sounds like we should support \\\"lazy\\\" (apply-before-merge like\u003cbr\\/\u003e\\ntoday) and \\\"live\\\" (live means resolve deleted Term\\/Query -&gt; docID(s)\u003cbr\\/\u003e\\nsynchronously inside deleteDocuments, right?).\u003c\\/p\u003e\\n\\n\u003cp\u003eLive should also be less performant because of less temporal locality\u003cbr\\/\u003e\\n(vs lazy).\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eIt\'d also be nice to have a more efficient data structure to buffer the\u003cbr\\/\u003e\\ndeletes. With many buffered deletes the java hashmap approach\u003cbr\\/\u003e\\nwill not be very efficient. Terms could be written into a byte pool,\u003cbr\\/\u003e\\nbut what should we do with queries?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI agree w\\/ Yonik: let\'s worry only about delete by Term (not Query)\u003cbr\\/\u003e\\nfor now.\u003c\\/p\u003e\\n\\n\u003cp\u003eMaybe we could reuse (factor out) TermsHashPerField\'s custom hash\u003cbr\\/\u003e\\nhere, for the buffered Terms?  It efficiently maps a BytesRef --&gt; int.\u003c\\/p\u003e\\n\\n\u003cp\u003eAnother thing: it looks like finishFlushedSegment is sync\'d on the IW\u003cbr\\/\u003e\\ninstance, but, it need not be sync\'d for all of that?  EG\u003cbr\\/\u003e\\nreaderPool.get(), applyDeletes, building the CFS, may not need to be\u003cbr\\/\u003e\\ninside the sync block?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12891256_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12891256_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Jul\\/10 17:30\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-22T17:30:21+0000\'\u003e22\\/Jul\\/10 17:30\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n  I still see usage of docStoreOffset, but aren\'t we doing away with shared doc stores with the cutover to DWPT?  \\n\\n Do we want all segments that one DWPT writes to share the same \\ndoc store, i.e. one doc store per DWPT, or remove doc stores  \\nentirely?  \\n\\n Oh good question... a single DWPT can in fact continue to share doc \\nstore across the segments it flushes. \\n\\n Hmm, but... this opto only helps in that we don\'t have to merge the \\ndoc stores if we merge segments that already share their doc stores. \\nBut if (say) I have 2 threads indexing, and I\'m indexing lots of docs \\nand each DWPT has written 5 segments, we will then merge these 10 \\nsegments, and must merge the doc stores at that point.  So the sharing \\nisn\'t really buying us much (just not closing old files &amp; opening new \\nones, which is presumably negligible)? \\n\\n \\n  I think you can further simplify DocumentsWriterPerThread.DocWriter; in fact I think you can remove it &amp; all subclasses in consumers!  \\n\\n I agree! Now that a high number of testcases pass it\'s less scary \\nto modify even more code  - will do this next. \\n\\n  Also, we don\'t need separate closeDocStore; it should just be closed during flush.  \\n\\n OK sounds good.  \\n\\n Super   \\n\\n \\n  I like the ThreadAffinityDocumentsWriterThreadPool; it\'s the default right (I see some tests explicitly setting in on IWC; not sure why)?  \\n\\n It\'s actually only TestStressIndexing2 and it sets it to use a different  \\nnumber of max thread states than the default.  \\n\\n Ahh OK great. \\n\\n \\n  We should make the in-RAM deletes impl somehow pluggable?  \\n\\n Do you mean so that it\'s customizable how deletes are handled?   \\n\\n Actually I was worried about the long[] sequenceIDs (adding 8 bytes \\nRAM per buffered doc) &#8211; this could be a biggish hit to RAM efficiency \\nfor small docs. \\n\\n   E.g. doing live deletes vs. lazy deletes on flush? \\nI think that\'s a good idea. E.g. at Twitter we\'ll do live deletes always \\nto get the lowest latency (and we don\'t have too many deletes), \\nbut that\'s probably not the best default for everyone. \\nSo I agree that making this customizable is a good idea.  \\n\\n Yeah, this too   \\n\\n Actually deletions today are not applied on flush &#8211; they continue to \\nbe buffered beyond flush, and then get applied just before a merge \\nkicks off.  I think we should keep this (as an option and probably as \\nthe default) &#8211; it\'s important for apps w\\/ large indices that don\'t use \\nNRT (and don\'t pool readers) because it\'s costly to open readers. \\n\\n So it sounds like we should support \\\"lazy\\\" (apply-before-merge like \\ntoday) and \\\"live\\\" (live means resolve deleted Term\\/Query -&gt; docID(s) \\nsynchronously inside deleteDocuments, right?). \\n\\n Live should also be less performant because of less temporal locality \\n(vs lazy). \\n\\n \\n It\'d also be nice to have a more efficient data structure to buffer the \\ndeletes. With many buffered deletes the java hashmap approach \\nwill not be very efficient. Terms could be written into a byte pool, \\nbut what should we do with queries?  \\n\\n I agree w\\/ Yonik: let\'s worry only about delete by Term (not Query) \\nfor now. \\n\\n Maybe we could reuse (factor out) TermsHashPerField\'s custom hash \\nhere, for the buffered Terms?  It efficiently maps a BytesRef --&gt; int. \\n\\n Another thing: it looks like finishFlushedSegment is sync\'d on the IW \\ninstance, but, it need not be sync\'d for all of that?  EG \\nreaderPool.get(), applyDeletes, building the CFS, may not need to be \\ninside the sync block?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12891262\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12891262&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12891262\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12891262_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12891262_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Jul\\/10 17:51\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-22T17:51:15+0000\'\u003e22\\/Jul\\/10 17:51\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003ePerhaps a single byte[] with length prefixes (like the field cache has).  A single int could then represent a term (it would just be an offset into the byte[], which is field-specific, so no need to store the field each time).\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYeah that\'s pretty much how TermsHashPerField works.  I agree with Mike, \u003cbr\\/\u003e\\nlet\'s reuse that code.\u003c\\/p\u003e\\n\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eHmm, but... this opto only helps in that we don\'t have to merge the\u003cbr\\/\u003e\\ndoc stores if we merge segments that already share their doc stores.\u003cbr\\/\u003e\\nBut if (say) I have 2 threads indexing, and I\'m indexing lots of docs\u003cbr\\/\u003e\\nand each DWPT has written 5 segments, we will then merge these 10\u003cbr\\/\u003e\\nsegments, and must merge the doc stores at that point. So the sharing\u003cbr\\/\u003e\\nisn\'t really buying us much (just not closing old files &amp; opening new\u003cbr\\/\u003e\\nones, which is presumably negligible)?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYeah that\'s true.  I agree it won\'t help much. I think we should just \u003cbr\\/\u003e\\nremove the doc stores, great simplification (which should also make \u003cbr\\/\u003e\\nparallel indexing a bit easier \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e ).  \u003c\\/p\u003e\\n\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eAnother thing: it looks like finishFlushedSegment is sync\'d on the IW\u003cbr\\/\u003e\\ninstance, but, it need not be sync\'d for all of that? EG\u003cbr\\/\u003e\\nreaderPool.get(), applyDeletes, building the CFS, may not need to be\u003cbr\\/\u003e\\ninside the sync block?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThanks for the hint.  I need to carefully go over all the synchronization, \u003cbr\\/\u003e\\nthere are likely more problems.  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12891262_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12891262_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Jul\\/10 17:51\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-22T17:51:15+0000\'\u003e22\\/Jul\\/10 17:51\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n Perhaps a single byte[] with length prefixes (like the field cache has).  A single int could then represent a term (it would just be an offset into the byte[], which is field-specific, so no need to store the field each time).  \\n\\n Yeah that\'s pretty much how TermsHashPerField works.  I agree with Mike,  \\nlet\'s reuse that code. \\n\\n\\n \\n Hmm, but... this opto only helps in that we don\'t have to merge the \\ndoc stores if we merge segments that already share their doc stores. \\nBut if (say) I have 2 threads indexing, and I\'m indexing lots of docs \\nand each DWPT has written 5 segments, we will then merge these 10 \\nsegments, and must merge the doc stores at that point. So the sharing \\nisn\'t really buying us much (just not closing old files &amp; opening new \\nones, which is presumably negligible)?  \\n\\n Yeah that\'s true.  I agree it won\'t help much. I think we should just  \\nremove the doc stores, great simplification (which should also make  \\nparallel indexing a bit easier   ).   \\n\\n\\n \\n Another thing: it looks like finishFlushedSegment is sync\'d on the IW \\ninstance, but, it need not be sync\'d for all of that? EG \\nreaderPool.get(), applyDeletes, building the CFS, may not need to be \\ninside the sync block?  \\n\\n Thanks for the hint.  I need to carefully go over all the synchronization,  \\nthere are likely more problems.                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12891264\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12891264&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12891264\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12891264_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12891264_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Jul\\/10 18:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-22T18:00:44+0000\'\u003e22\\/Jul\\/10 18:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eYeah that\'s pretty much how TermsHashPerField works. I agree with Mike, let\'s reuse that code.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eDo we even need to maintain a hash over it though, or can we simply keep a list (and allow dup terms until it\'s time to apply them)?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12891264_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12891264_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Jul\\/10 18:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-22T18:00:44+0000\'\u003e22\\/Jul\\/10 18:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     Yeah that\'s pretty much how TermsHashPerField works. I agree with Mike, let\'s reuse that code.  \\n\\n Do we even need to maintain a hash over it though, or can we simply keep a list (and allow dup terms until it\'s time to apply them)?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12891334\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12891334&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12891334\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12891334_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12891334_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Jul\\/10 21:06\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-22T21:06:14+0000\'\u003e22\\/Jul\\/10 21:06\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eI think we should just remove the doc stores\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eRight, I think we should remove sharing doc stores between\u003cbr\\/\u003e\\nsegments. And in general, RT apps will likely not want to use\u003cbr\\/\u003e\\ndoc stores if they are performing numerous updates and\\/or\u003cbr\\/\u003e\\ndeletes. We can explicitly state this in the javadocs.\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'m thinking we could explore efficient deleted docs as sequence\u003cbr\\/\u003e\\nids in a different issue, specifically storing them in a short[]\u003cbr\\/\u003e\\nand wrapping around.  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12891334_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12891334_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Jul\\/10 21:06\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-22T21:06:14+0000\'\u003e22\\/Jul\\/10 21:06\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     I think we should just remove the doc stores  \\n\\n Right, I think we should remove sharing doc stores between \\nsegments. And in general, RT apps will likely not want to use \\ndoc stores if they are performing numerous updates and\\/or \\ndeletes. We can explicitly state this in the javadocs. \\n\\n I\'m thinking we could explore efficient deleted docs as sequence \\nids in a different issue, specifically storing them in a short[] \\nand wrapping around.                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12891657\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12891657&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12891657\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12891657_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12891657_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'23\\/Jul\\/10 16:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-23T16:20:17+0000\'\u003e23\\/Jul\\/10 16:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eI think we don\'t need PerDocBuffer, either.\u003cbr\\/\u003e\\nAnd this also simplifies RAM usage tracking!\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThe nice thing about that buffer is that on\u003cbr\\/\u003e\\nnon-aborting exceptions we can simply skip\u003cbr\\/\u003e\\nthe whole document, because nothing gets\u003cbr\\/\u003e\\nwritten to the stores until finishDocument \u003cbr\\/\u003e\\nis called.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12891657_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12891657_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'23\\/Jul\\/10 16:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-23T16:20:17+0000\'\u003e23\\/Jul\\/10 16:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n I think we don\'t need PerDocBuffer, either. \\nAnd this also simplifies RAM usage tracking!  \\n\\n The nice thing about that buffer is that on \\nnon-aborting exceptions we can simply skip \\nthe whole document, because nothing gets \\nwritten to the stores until finishDocument  \\nis called.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12891663\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12891663&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12891663\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12891663_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12891663_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'23\\/Jul\\/10 16:28\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-23T16:28:59+0000\'\u003e23\\/Jul\\/10 16:28\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eI think we don\'t need PerDocBuffer, either.  And this also simplifies RAM usage tracking!\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThe nice thing about that buffer is that on\u003cbr\\/\u003e\\nnon-aborting exceptions we can simply skip\u003cbr\\/\u003e\\nthe whole document, because nothing gets\u003cbr\\/\u003e\\nwritten to the stores until finishDocument \u003cbr\\/\u003e\\nis called.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eWell, though, if we did write it \\\"live\\\", since the doc is marked deleted, it would be \\\"harmless\\\" right?\u003c\\/p\u003e\\n\\n\u003cp\u003eOnly difference is it took up some disk space (which should be minor given that it\'s not \\\"normal\\\" to have lots of docs hitting non-aborting exceptions).\u003c\\/p\u003e\\n\\n\u003cp\u003eAlso... when the doc is large, the fact that we double buffer (write first to RAMFile then to the store) can be costly.  Ie we consume 1X the stored-field size in transient RAM, vs writing directly to disk, I think?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12891663_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12891663_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'23\\/Jul\\/10 16:28\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-23T16:28:59+0000\'\u003e23\\/Jul\\/10 16:28\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n\\n  I think we don\'t need PerDocBuffer, either.  And this also simplifies RAM usage tracking!  \\n\\n The nice thing about that buffer is that on \\nnon-aborting exceptions we can simply skip \\nthe whole document, because nothing gets \\nwritten to the stores until finishDocument  \\nis called.  \\n\\n Well, though, if we did write it \\\"live\\\", since the doc is marked deleted, it would be \\\"harmless\\\" right? \\n\\n Only difference is it took up some disk space (which should be minor given that it\'s not \\\"normal\\\" to have lots of docs hitting non-aborting exceptions). \\n\\n Also... when the doc is large, the fact that we double buffer (write first to RAMFile then to the store) can be costly.  Ie we consume 1X the stored-field size in transient RAM, vs writing directly to disk, I think?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12891664\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12891664&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12891664\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12891664_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12891664_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'23\\/Jul\\/10 16:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-23T16:35:26+0000\'\u003e23\\/Jul\\/10 16:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003c\\/blockquote\u003e\\n\u003cp\u003eWell, though, if we did write it \\\"live\\\", since the doc is marked deleted, it would be \\\"harmless\\\" right?\u003c\\/p\u003e\\n\\n\u003cp\u003eOnly difference is it took up some disk space (which should be minor given that it\'s not \\\"normal\\\" to have lots of docs hitting non-aborting exceptions).\u003c\\/p\u003e\\n\\n\u003cp\u003eAlso... when the doc is large, the fact that we double buffer (write first to RAMFile then to the store) can be costly.  Ie we consume 1X the stored-field size in transient RAM, vs writing directly to disk, I think?\u003cbr\\/\u003e\\n{quote]\u003c\\/p\u003e\\n\\n\u003cp\u003eYeah I totally agree that this would be a nice performance win - I got first excited too about removing that extra buffering layer.  But we probably have to handle exceptions a bit differently then?  Because now all exceptions thrown in processDocument() are considered non-aborting, because they nothing is actually written to disk in processDocument().\u003c\\/p\u003e\\n\\n\u003cp\u003eWe only abort when we encounter an exception in finishDocument(), because then the files might be corrupted.\u003c\\/p\u003e\\n\\n\u003cp\u003eSo we probably just have to catch the IOExceptions somewhere else to figure out if it was e.g. a (non-aborting) exception from the TokenStream vs. e.g. a disk full (aborting) exception from StoredFieldsWriter.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12891664_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12891664_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'23\\/Jul\\/10 16:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-23T16:35:26+0000\'\u003e23\\/Jul\\/10 16:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     \\n Well, though, if we did write it \\\"live\\\", since the doc is marked deleted, it would be \\\"harmless\\\" right? \\n\\n Only difference is it took up some disk space (which should be minor given that it\'s not \\\"normal\\\" to have lots of docs hitting non-aborting exceptions). \\n\\n Also... when the doc is large, the fact that we double buffer (write first to RAMFile then to the store) can be costly.  Ie we consume 1X the stored-field size in transient RAM, vs writing directly to disk, I think? \\n{quote] \\n\\n Yeah I totally agree that this would be a nice performance win - I got first excited too about removing that extra buffering layer.  But we probably have to handle exceptions a bit differently then?  Because now all exceptions thrown in processDocument() are considered non-aborting, because they nothing is actually written to disk in processDocument(). \\n\\n We only abort when we encounter an exception in finishDocument(), because then the files might be corrupted. \\n\\n So we probably just have to catch the IOExceptions somewhere else to figure out if it was e.g. a (non-aborting) exception from the TokenStream vs. e.g. a disk full (aborting) exception from StoredFieldsWriter.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12891986\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12891986&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12891986\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12891986_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12891986_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'24\\/Jul\\/10 14:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-24T14:49:34+0000\'\u003e24\\/Jul\\/10 14:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eYes, you\'re right!  So, after this change, an exception while processing stored fields \\/ term vectors must handled as an aborting exception.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12891986_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12891986_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'24\\/Jul\\/10 14:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-24T14:49:34+0000\'\u003e24\\/Jul\\/10 14:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Yes, you\'re right!  So, after this change, an exception while processing stored fields \\/ term vectors must handled as an aborting exception.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12892174\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12892174&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12892174\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_12892174_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12892174_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Jul\\/10 05:13\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-26T05:13:43+0000\'\u003e26\\/Jul\\/10 05:13\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eIs it possible that as part of this issue (or this effort), you\'ll think of opening PTDW for easier extensions (such as Parallel Indexing)? If it can easily be done by marking some methods as protected instead of (package-)private, then I think it\'s worth it. We can mark them as lucene.internal or something ... And perhaps even allow setting the DW on IW, for really expert use?\u003c\\/p\u003e\\n\\n\u003cp\u003eIf you think that should be part of the overhaul refactoring you\'ve once suggested (Michael B.), then I\'m ok with that as well. Just thinking that it\'s better to hit the iron while it\'s still hot \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_12892174_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12892174_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/Jul\\/10 05:13\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-26T05:13:43+0000\'\u003e26\\/Jul\\/10 05:13\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Is it possible that as part of this issue (or this effort), you\'ll think of opening PTDW for easier extensions (such as Parallel Indexing)? If it can easily be done by marking some methods as protected instead of (package-)private, then I think it\'s worth it. We can mark them as lucene.internal or something ... And perhaps even allow setting the DW on IW, for really expert use? \\n\\n If you think that should be part of the overhaul refactoring you\'ve once suggested (Michael B.), then I\'m ok with that as well. Just thinking that it\'s better to hit the iron while it\'s still hot  .              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12892924\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12892924&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12892924\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12892924_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12892924_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'27\\/Jul\\/10 20:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-27T20:55:53+0000\'\u003e27\\/Jul\\/10 20:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eIs it possible that as part of this issue (or this effort), you\'ll think of opening PTDW for easier extensions (such as Parallel Indexing)?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYeah I\'d like to make some progress on parallel indexing too.  I think now that DWPT is roughly working I can start thinking about what further changes are necessary in the indexer.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12892924_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12892924_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'27\\/Jul\\/10 20:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-07-27T20:55:53+0000\'\u003e27\\/Jul\\/10 20:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n Is it possible that as part of this issue (or this effort), you\'ll think of opening PTDW for easier extensions (such as Parallel Indexing)?  \\n\\n Yeah I\'d like to make some progress on parallel indexing too.  I think now that DWPT is roughly working I can start thinking about what further changes are necessary in the indexer.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12896519\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12896519&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12896519\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12896519_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12896519_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Aug\\/10 12:23\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-08-09T12:23:54+0000\'\u003e09\\/Aug\\/10 12:23\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eBTW, randomly, \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2186\\\" title=\\\"First cut at column-stride fields (index values storage)\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2186\\\"\u003e\u003cdel\u003eLUCENE-2186\u003c\\/del\u003e\u003c\\/a\u003e has already roughly factored out the BytesRef hash from TermsHashPerField... so if we want also to reuse that here, we can share.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12896519_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12896519_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Aug\\/10 12:23\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-08-09T12:23:54+0000\'\u003e09\\/Aug\\/10 12:23\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    BTW, randomly,   LUCENE-2186   has already roughly factored out the BytesRef hash from TermsHashPerField... so if we want also to reuse that here, we can share.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12910262\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12910262&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12910262\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12910262_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12910262_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Sep\\/10 18:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-09-16T18:49:40+0000\'\u003e16\\/Sep\\/10 18:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eIs this near-comittable?  Ie \\\"just\\\" the DWPT cutover?  This part seems separable from making each DWPT\'s buffer searchable?\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'m running some tests w\\/ 20 indexing threads and I think the sync\'d flush is a big bottleneck...\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12910262_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12910262_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Sep\\/10 18:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-09-16T18:49:40+0000\'\u003e16\\/Sep\\/10 18:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Is this near-comittable?  Ie \\\"just\\\" the DWPT cutover?  This part seems separable from making each DWPT\'s buffer searchable? \\n\\n I\'m running some tests w\\/ 20 indexing threads and I think the sync\'d flush is a big bottleneck...              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12910268\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12910268&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12910268\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12910268_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12910268_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Sep\\/10 19:01\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-09-16T19:01:45+0000\'\u003e16\\/Sep\\/10 19:01\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eI think the sync\'d flush is a big bottleneck\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eIs this because indexing stops while the DWPT segment is being flushed to disk or are you referring to a different sync?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12910268_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12910268_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Sep\\/10 19:01\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-09-16T19:01:45+0000\'\u003e16\\/Sep\\/10 19:01\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     I think the sync\'d flush is a big bottleneck  \\n\\n Is this because indexing stops while the DWPT segment is being flushed to disk or are you referring to a different sync?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12910276\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12910276&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12910276\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12910276_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12910276_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Sep\\/10 19:24\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-09-16T19:24:28+0000\'\u003e16\\/Sep\\/10 19:24\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eIs this because indexing stops while the DWPT segment is being flushed to disk or are you referring to a different sync?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI\'m talking about Lucene trunk today (ie before this patch).\u003c\\/p\u003e\\n\\n\u003cp\u003eYes, because indexing of all 20 threads is blocked while a single thread moves the RAM buffer to disk.  But, with this patch, each thread will privately move its own RAM buffer to disk, not blocking the rest.\u003c\\/p\u003e\\n\\n\u003cp\u003eWith 20 threads I\'m seeing ~4 seconds of concurrent indexing and then 6-8 seconds to flush (w\\/ 256 MB RAM buffer).\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12910276_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12910276_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Sep\\/10 19:24\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-09-16T19:24:28+0000\'\u003e16\\/Sep\\/10 19:24\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     Is this because indexing stops while the DWPT segment is being flushed to disk or are you referring to a different sync?  \\n\\n I\'m talking about Lucene trunk today (ie before this patch). \\n\\n Yes, because indexing of all 20 threads is blocked while a single thread moves the RAM buffer to disk.  But, with this patch, each thread will privately move its own RAM buffer to disk, not blocking the rest. \\n\\n With 20 threads I\'m seeing ~4 seconds of concurrent indexing and then 6-8 seconds to flush (w\\/ 256 MB RAM buffer).              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12910483\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12910483&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12910483\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12910483_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12910483_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Sep\\/10 06:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-09-17T06:57:50+0000\'\u003e17\\/Sep\\/10 06:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eIs this near-comittable?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI think we need to:\u003c\\/p\u003e\\n\u003cul\u003e\\n\\t\u003cli\u003emerge trunk and make tests pass\u003c\\/li\u003e\\n\\t\u003cli\u003efinish flushing by RAM\u003c\\/li\u003e\\n\\t\u003cli\u003emake deletes work again\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eThen it should be ready to commit.  Sorry, was so busy the last weeks that I couldn\'t make much progress.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12910483_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12910483_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Sep\\/10 06:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-09-17T06:57:50+0000\'\u003e17\\/Sep\\/10 06:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     Is this near-comittable?  \\n\\n I think we need to: \\n \\n\\t merge trunk and make tests pass \\n\\t finish flushing by RAM \\n\\t make deletes work again \\n \\n\\n\\n Then it should be ready to commit.  Sorry, was so busy the last weeks that I couldn\'t make much progress.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12910527\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12910527&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12910527\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12910527_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12910527_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Sep\\/10 10:28\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-09-17T10:28:37+0000\'\u003e17\\/Sep\\/10 10:28\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI just posted some details about the concurrency bottleneck of flush at \u003ca href=\\\"http:\\/\\/chbits.blogspot.com\\/2010\\/09\\/lucenes-indexing-is-fast.html\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttp:\\/\\/chbits.blogspot.com\\/2010\\/09\\/lucenes-indexing-is-fast.html\u003c\\/a\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eIt\'s pretty bad &#8211; w\\/ only 6 threads, I see flush taking 54% of the time, ie for 54% of the time all threads are blocked on indexing while the flush runs.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12910527_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12910527_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Sep\\/10 10:28\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-09-17T10:28:37+0000\'\u003e17\\/Sep\\/10 10:28\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I just posted some details about the concurrency bottleneck of flush at  http:\\/\\/chbits.blogspot.com\\/2010\\/09\\/lucenes-indexing-is-fast.html  \\n\\n It\'s pretty bad &#8211; w\\/ only 6 threads, I see flush taking 54% of the time, ie for 54% of the time all threads are blocked on indexing while the flush runs.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12910535\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12910535&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12910535\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"simonw\\\" id=\\\"commentauthor_12910535_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=simonw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"simonw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Simon Willnauer\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12910535_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Sep\\/10 11:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-09-17T11:02:04+0000\'\u003e17\\/Sep\\/10 11:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eBTW, randomly, \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2186\\\" title=\\\"First cut at column-stride fields (index values storage)\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2186\\\"\u003e\u003cdel\u003eLUCENE-2186\u003c\\/del\u003e\u003c\\/a\u003e has already roughly factored out the BytesRef hash from TermsHashPerField... so if we want also to reuse that here, we can share.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\u003cp\u003edo you guys still need the BytesHash being factored out since I currently work on splitting stand alone parts out of \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2186\\\" title=\\\"First cut at column-stride fields (index values storage)\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2186\\\"\u003e\u003cdel\u003eLUCENE-2186\u003c\\/del\u003e\u003c\\/a\u003e. If so that would be the next on the list... let me know\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eI just posted some details about the concurrency bottleneck of flush at \u003ca href=\\\"http:\\/\\/chbits.blogspot.com\\/2010\\/09\\/lucenes-indexing-is-fast.html\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttp:\\/\\/chbits.blogspot.com\\/2010\\/09\\/lucenes-indexing-is-fast.html\u003c\\/a\u003e\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003enice post mike \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"simonw\\\" id=\\\"commentauthor_12910535_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=simonw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"simonw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Simon Willnauer\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12910535_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Sep\\/10 11:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-09-17T11:02:04+0000\'\u003e17\\/Sep\\/10 11:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     BTW, randomly,   LUCENE-2186   has already roughly factored out the BytesRef hash from TermsHashPerField... so if we want also to reuse that here, we can share.  \\n do you guys still need the BytesHash being factored out since I currently work on splitting stand alone parts out of   LUCENE-2186  . If so that would be the next on the list... let me know \\n\\n  I just posted some details about the concurrency bottleneck of flush at  http:\\/\\/chbits.blogspot.com\\/2010\\/09\\/lucenes-indexing-is-fast.html   \\n\\n nice post mike   \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12911144\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12911144&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12911144\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12911144_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12911144_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Sep\\/10 01:07\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-09-19T01:07:07+0000\'\u003e19\\/Sep\\/10 01:07\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eSimon, I think the BytesHash being factored is useful, though not a must have for committing the flush by DWPT code.\u003c\\/p\u003e\\n\\n\u003cp\u003eMike, I need to finish the unit tests for \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2573\\\" title=\\\"Tiered flushing of DWPTs by RAM with low\\/high water marks\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2573\\\"\u003e\u003cdel\u003eLUCENE-2573\u003c\\/del\u003e\u003c\\/a\u003e.\u003c\\/p\u003e\\n\\n\u003cp\u003eMichael, what is the issue with deletes?  We don\'t need deletes to use sequence ids yet?  Maybe we should open a separate issue to make deletes work for the realtime\\/DWPT branch?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12911144_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12911144_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Sep\\/10 01:07\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-09-19T01:07:07+0000\'\u003e19\\/Sep\\/10 01:07\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Simon, I think the BytesHash being factored is useful, though not a must have for committing the flush by DWPT code. \\n\\n Mike, I need to finish the unit tests for   LUCENE-2573  . \\n\\n Michael, what is the issue with deletes?  We don\'t need deletes to use sequence ids yet?  Maybe we should open a separate issue to make deletes work for the realtime\\/DWPT branch?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12912312\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12912312&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12912312\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12912312_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12912312_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Sep\\/10 02:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-09-20T02:46:46+0000\'\u003e20\\/Sep\\/10 02:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Jason Rutherglen - 20\\/Sep\\/10 02:52\\\"\u003eedited\u003c\\/span\u003e \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eSimon, on second thought, lets go ahead and factor out BytesHash, do you want to submit a patch for the realtime branch and post it here or should I?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12912312_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12912312_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Sep\\/10 02:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-09-20T02:46:46+0000\'\u003e20\\/Sep\\/10 02:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Jason Rutherglen - 20\\/Sep\\/10 02:52\\\"\u003eedited\u003c\\/span\u003e                   Simon, on second thought, lets go ahead and factor out BytesHash, do you want to submit a patch for the realtime branch and post it here or should I?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12912313\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12912313&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12912313\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12912313_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12912313_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Sep\\/10 02:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-09-20T02:50:19+0000\'\u003e20\\/Sep\\/10 02:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI opened an issue for the deletes \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2655\\\" title=\\\"Get deletes working in the realtime branch\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2655\\\"\u003e\u003cdel\u003eLUCENE-2655\u003c\\/del\u003e\u003c\\/a\u003e\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12912313_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12912313_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Sep\\/10 02:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-09-20T02:50:19+0000\'\u003e20\\/Sep\\/10 02:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I opened an issue for the deletes   LUCENE-2655                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12969836\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12969836&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12969836\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12969836_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12969836_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Dec\\/10 18:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-09T18:12:11+0000\'\u003e09\\/Dec\\/10 18:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eNow that \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2680\\\" title=\\\"Improve how IndexWriter flushes deletes against existing segments\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2680\\\"\u003e\u003cdel\u003eLUCENE-2680\u003c\\/del\u003e\u003c\\/a\u003e is implemented we can get deletes working properly in the\u003cbr\\/\u003e\\nrealtime, which is really the DWPT branch at this point. Given the significant\u003cbr\\/\u003e\\nchanges made since it\'s creation, rather than continue with a realtime branch,\u003cbr\\/\u003e\\nI propose we patch into trunk the DWPT changes. \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12969836_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12969836_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Dec\\/10 18:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-09T18:12:11+0000\'\u003e09\\/Dec\\/10 18:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Now that   LUCENE-2680   is implemented we can get deletes working properly in the \\nrealtime, which is really the DWPT branch at this point. Given the significant \\nchanges made since it\'s creation, rather than continue with a realtime branch, \\nI propose we patch into trunk the DWPT changes.               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12969850\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12969850&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12969850\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12969850_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12969850_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Dec\\/10 18:30\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-09T18:30:58+0000\'\u003e09\\/Dec\\/10 18:30\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eIdeally we should merge trunk into realtime after \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2680\\\" title=\\\"Improve how IndexWriter flushes deletes against existing segments\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2680\\\"\u003e\u003cdel\u003eLUCENE-2680\u003c\\/del\u003e\u003c\\/a\u003e is committed, get everything working there, and then merge realtime back into trunk?\u003c\\/p\u003e\\n\\n\u003cp\u003eI agree that it totally makes sense to get DWPT into trunk as soon as possible (ie. not wait until all realtime stuff is done).\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12969850_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12969850_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Dec\\/10 18:30\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-09T18:30:58+0000\'\u003e09\\/Dec\\/10 18:30\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Ideally we should merge trunk into realtime after   LUCENE-2680   is committed, get everything working there, and then merge realtime back into trunk? \\n\\n I agree that it totally makes sense to get DWPT into trunk as soon as possible (ie. not wait until all realtime stuff is done).              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12969856\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12969856&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12969856\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12969856_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12969856_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Dec\\/10 18:37\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-09T18:37:39+0000\'\u003e09\\/Dec\\/10 18:37\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e&gt; and then merge realtime back into trunk\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'d prefer to simply create a patch of the DWPT changes, which granted\'ll be large, however we\'re through most of the hurdles and at this point, the patch\'ll be straightforward to implement and test using the existing unit tests?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12969856_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12969856_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Dec\\/10 18:37\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-09T18:37:39+0000\'\u003e09\\/Dec\\/10 18:37\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    &gt; and then merge realtime back into trunk \\n\\n I\'d prefer to simply create a patch of the DWPT changes, which granted\'ll be large, however we\'re through most of the hurdles and at this point, the patch\'ll be straightforward to implement and test using the existing unit tests?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12969865\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12969865&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12969865\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12969865_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12969865_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Dec\\/10 18:58\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-09T18:58:42+0000\'\u003e09\\/Dec\\/10 18:58\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eNot sure if that\'s much easier though, because what you said is true:  the realtime branch currently is basically the DWPT branch.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12969865_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12969865_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Dec\\/10 18:58\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-09T18:58:42+0000\'\u003e09\\/Dec\\/10 18:58\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Not sure if that\'s much easier though, because what you said is true:  the realtime branch currently is basically the DWPT branch.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12970262\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12970262&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12970262\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12970262_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12970262_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Dec\\/10 18:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-10T18:46:54+0000\'\u003e10\\/Dec\\/10 18:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eMichael,\u003c\\/p\u003e\\n\\n\u003cp\u003eI don\'t have commit access to the realtime branch. A patch is probably easier\u003cbr\\/\u003e\\nfor other people to work on and look at than the branch? Also, I have some time\u003cbr\\/\u003e\\nto work on integrating DWPT and the changes since the branch creation are\u003cbr\\/\u003e\\nfairly significant and probably require mostly manual merging. \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12970262_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12970262_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Dec\\/10 18:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-10T18:46:54+0000\'\u003e10\\/Dec\\/10 18:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Michael, \\n\\n I don\'t have commit access to the realtime branch. A patch is probably easier \\nfor other people to work on and look at than the branch? Also, I have some time \\nto work on integrating DWPT and the changes since the branch creation are \\nfairly significant and probably require mostly manual merging.               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12970287\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12970287&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12970287\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12970287_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12970287_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Dec\\/10 19:25\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-10T19:25:24+0000\'\u003e10\\/Dec\\/10 19:25\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI started merging yesterday the latest trunk into realtime.  The merge is rather hard, as you might imagine \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e  \u003cbr\\/\u003e\\nBut I\'m down from 600 compile errors to ~100.  I can try to finish it this weekend.\u003c\\/p\u003e\\n\\n\u003cp\u003eBut I don\'t want to block you, if you want to go the patch route and have time now don\'t wait for me.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12970287_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12970287_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Dec\\/10 19:25\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-10T19:25:24+0000\'\u003e10\\/Dec\\/10 19:25\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I started merging yesterday the latest trunk into realtime.  The merge is rather hard, as you might imagine     \\nBut I\'m down from 600 compile errors to ~100.  I can try to finish it this weekend. \\n\\n But I don\'t want to block you, if you want to go the patch route and have time now don\'t wait for me.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12970289\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12970289&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12970289\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12970289_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12970289_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Dec\\/10 19:31\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-10T19:31:14+0000\'\u003e10\\/Dec\\/10 19:31\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eI started merging yesterday the latest trunk into realtime.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eAs part of this I want to clean up the branch a bit and remove unnecessary changes (like refactorings) to make the merge back into trunk less difficult.  When I\'m done with the merge we should patch \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2680\\\" title=\\\"Improve how IndexWriter flushes deletes against existing segments\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2680\\\"\u003e\u003cdel\u003eLUCENE-2680\u003c\\/del\u003e\u003c\\/a\u003e into realtime.  (or commit to trunk and merge trunk into realtime again)\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12970289_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12970289_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Dec\\/10 19:31\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-10T19:31:14+0000\'\u003e10\\/Dec\\/10 19:31\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     I started merging yesterday the latest trunk into realtime.  \\n\\n As part of this I want to clean up the branch a bit and remove unnecessary changes (like refactorings) to make the merge back into trunk less difficult.  When I\'m done with the merge we should patch   LUCENE-2680   into realtime.  (or commit to trunk and merge trunk into realtime again)              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12970341\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12970341&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12970341\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12970341_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12970341_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Dec\\/10 23:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-10T23:49:52+0000\'\u003e10\\/Dec\\/10 23:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eThe merge is rather hard, as you might imagine\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI\'d hold off until \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2680\\\" title=\\\"Improve how IndexWriter flushes deletes against existing segments\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2680\\\"\u003e\u003cdel\u003eLUCENE-2680\u003c\\/del\u003e\u003c\\/a\u003e is committed to trunk, otherwise the merge work may be redundant.  \u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003ecommit to trunk and merge trunk into realtime again\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI think it\'s pretty much ready for trunk as the tests pass.  \u003c\\/p\u003e\\n\\n\u003cp\u003eMerging realtime\\/DWPT branch back to trunk should be easier if we try to wrap up DWPT in a short period of time, eg, plow ahead until it\'s merge-able.\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12970341_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12970341_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Dec\\/10 23:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-10T23:49:52+0000\'\u003e10\\/Dec\\/10 23:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     The merge is rather hard, as you might imagine  \\n\\n I\'d hold off until   LUCENE-2680   is committed to trunk, otherwise the merge work may be redundant.   \\n\\n  commit to trunk and merge trunk into realtime again  \\n\\n I think it\'s pretty much ready for trunk as the tests pass.   \\n\\n Merging realtime\\/DWPT branch back to trunk should be easier if we try to wrap up DWPT in a short period of time, eg, plow ahead until it\'s merge-able. \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12973734\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12973734&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12973734\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12973734_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12973734_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Dec\\/10 16:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-21T16:20:16+0000\'\u003e21\\/Dec\\/10 16:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAs per Michael B\'s email, I\'ll start on integrating deletes and flush-by-RAM aka \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2573\\\" title=\\\"Tiered flushing of DWPTs by RAM with low\\/high water marks\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2573\\\"\u003e\u003cdel\u003eLUCENE-2573\u003c\\/del\u003e\u003c\\/a\u003e, along the way the deadlock issue could be uncovered, which test is it occurring on?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12973734_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12973734_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Dec\\/10 16:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-21T16:20:16+0000\'\u003e21\\/Dec\\/10 16:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    As per Michael B\'s email, I\'ll start on integrating deletes and flush-by-RAM aka   LUCENE-2573  , along the way the deadlock issue could be uncovered, which test is it occurring on?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12974484\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12974484&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12974484\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12974484_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12974484_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'23\\/Dec\\/10 04:29\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-23T04:29:58+0000\'\u003e23\\/Dec\\/10 04:29\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAlso, it\'d be great if we could summarize the changes trunk -&gt; DWPT branch.  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12974484_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12974484_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'23\\/Dec\\/10 04:29\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-23T04:29:58+0000\'\u003e23\\/Dec\\/10 04:29\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Also, it\'d be great if we could summarize the changes trunk -&gt; DWPT branch.                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12974526\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12974526&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12974526\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12974526_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12974526_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'23\\/Dec\\/10 04:54\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-23T04:54:41+0000\'\u003e23\\/Dec\\/10 04:54\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHere\'s ant test-core output.  Looks like it\'s deadlocking in TestIndexWriter?  There are some IR.reopen failures, a null pointer, and a delete count I\'ll look at.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12974526_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12974526_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'23\\/Dec\\/10 04:54\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-23T04:54:41+0000\'\u003e23\\/Dec\\/10 04:54\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Here\'s ant test-core output.  Looks like it\'s deadlocking in TestIndexWriter?  There are some IR.reopen failures, a null pointer, and a delete count I\'ll look at.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12974529\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12974529&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12974529\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12974529_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12974529_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'23\\/Dec\\/10 05:33\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-23T05:33:29+0000\'\u003e23\\/Dec\\/10 05:33\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eSmall patch fixing the num deletes test null pointer. \u003c\\/p\u003e\\n\\n\u003cp\u003eThe TestIndexReaderReopen failure seems to have something to do with flushing deletes.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12974529_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12974529_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'23\\/Dec\\/10 05:33\'\u003e\u003ctime class=\'livestamp\' datetime=\'2010-12-23T05:33:29+0000\'\u003e23\\/Dec\\/10 05:33\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Small patch fixing the num deletes test null pointer.  \\n\\n The TestIndexReaderReopen failure seems to have something to do with flushing deletes.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12977443\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12977443&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12977443\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12977443_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12977443_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Jan\\/11 20:15\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-04T20:15:53+0000\'\u003e04\\/Jan\\/11 20:15\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eLooks like the problem with TestIndexReaderReopen is the test opens an IW, tried to queue deletes, however because there isn\'t an existing DWPT (at least when flush is called), the deletes haven\'t been recorded and so they\'re not applied to the index.  Perhaps we need to init DW with at least 1 DWPT?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12977443_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12977443_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Jan\\/11 20:15\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-04T20:15:53+0000\'\u003e04\\/Jan\\/11 20:15\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Looks like the problem with TestIndexReaderReopen is the test opens an IW, tried to queue deletes, however because there isn\'t an existing DWPT (at least when flush is called), the deletes haven\'t been recorded and so they\'re not applied to the index.  Perhaps we need to init DW with at least 1 DWPT?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12977465\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12977465&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12977465\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12977465_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12977465_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Jan\\/11 21:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-04T21:20:38+0000\'\u003e04\\/Jan\\/11 21:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAlso I think the deadlock is happening in DW update doc where we\'re calling delete term across all DWPTs. How will we guarantee point-in-timeness when RT is turned on? I guess with the sequence ids?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12977465_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12977465_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Jan\\/11 21:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-04T21:20:38+0000\'\u003e04\\/Jan\\/11 21:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Also I think the deadlock is happening in DW update doc where we\'re calling delete term across all DWPTs. How will we guarantee point-in-timeness when RT is turned on? I guess with the sequence ids?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12977481\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12977481&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12977481\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12977481_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12977481_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Jan\\/11 21:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-04T21:53:43+0000\'\u003e04\\/Jan\\/11 21:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI added an assertion showing the lack of DWPTs when delete is called.\u003c\\/p\u003e\\n\\n\u003cp\u003edeleteTermNoWait (which skips flush control) is called in update doc and now deadlock doesn\'t occur when executing TestIndexWriter.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12977481_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12977481_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Jan\\/11 21:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-04T21:53:43+0000\'\u003e04\\/Jan\\/11 21:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I added an assertion showing the lack of DWPTs when delete is called. \\n\\n deleteTermNoWait (which skips flush control) is called in update doc and now deadlock doesn\'t occur when executing TestIndexWriter.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12977560\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12977560&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12977560\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12977560_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12977560_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Jan\\/11 00:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-05T00:50:09+0000\'\u003e05\\/Jan\\/11 00:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eTaking a step back, I\'m not sure flush control should be global, as flushing is\u003cbr\\/\u003e\\nentirely per thread now? If we\'re adding a delete term for every DWPT, if one\u003cbr\\/\u003e\\nis flushing do we wait or do we simply queue it up? I don\'t think we can wait\u003cbr\\/\u003e\\nin the delete call for a DWPT to completely flush?\u003c\\/p\u003e\\n\\n\u003cp\u003eSo we\'ll likely need to delete in a PerThreadTask that\'s executed on each\u003cbr\\/\u003e\\nexisting DWPT. How we guarantee concurrency seems a little odd here as what if\u003cbr\\/\u003e\\na new DWPT is spun up while we\'re deleting in another thread? Perhaps we should\u003cbr\\/\u003e\\nsimply spin up on DW init, the max thread state number of DWPTs? This way we\u003cbr\\/\u003e\\nalways have &gt; 0 available, and we can perhaps lock on seq id when adding\u003cbr\\/\u003e\\ndeletes to all DWPTs (it\'s a fast call). We may want to simply skip any\u003cbr\\/\u003e\\nflushing DWPTs when adding deletes?\u003c\\/p\u003e\\n\\n\u003cp\u003eIn browsing the code, FlushControl isn\'t used in very many places. This\'ll get\u003cbr\\/\u003e\\na little bit more fleshed out when we integrate \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2573\\\" title=\\\"Tiered flushing of DWPTs by RAM with low\\/high water marks\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2573\\\"\u003e\u003cdel\u003eLUCENE-2573\u003c\\/del\u003e\u003c\\/a\u003e.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12977560_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12977560_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Jan\\/11 00:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-05T00:50:09+0000\'\u003e05\\/Jan\\/11 00:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Taking a step back, I\'m not sure flush control should be global, as flushing is \\nentirely per thread now? If we\'re adding a delete term for every DWPT, if one \\nis flushing do we wait or do we simply queue it up? I don\'t think we can wait \\nin the delete call for a DWPT to completely flush? \\n\\n So we\'ll likely need to delete in a PerThreadTask that\'s executed on each \\nexisting DWPT. How we guarantee concurrency seems a little odd here as what if \\na new DWPT is spun up while we\'re deleting in another thread? Perhaps we should \\nsimply spin up on DW init, the max thread state number of DWPTs? This way we \\nalways have &gt; 0 available, and we can perhaps lock on seq id when adding \\ndeletes to all DWPTs (it\'s a fast call). We may want to simply skip any \\nflushing DWPTs when adding deletes? \\n\\n In browsing the code, FlushControl isn\'t used in very many places. This\'ll get \\na little bit more fleshed out when we integrate   LUCENE-2573  .              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12977585\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12977585&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12977585\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12977585_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12977585_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Jan\\/11 01:52\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-05T01:52:56+0000\'\u003e05\\/Jan\\/11 01:52\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI think we can get DWPTs working sans \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2573\\\" title=\\\"Tiered flushing of DWPTs by RAM with low\\/high water marks\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2573\\\"\u003e\u003cdel\u003eLUCENE-2573\u003c\\/del\u003e\u003c\\/a\u003e for now.  We can do this by setting a hard max buffer size, deletes, etc per DWPT.  The values will be from IWC divided by the max thread states.  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12977585_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12977585_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Jan\\/11 01:52\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-05T01:52:56+0000\'\u003e05\\/Jan\\/11 01:52\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I think we can get DWPTs working sans   LUCENE-2573   for now.  We can do this by setting a hard max buffer size, deletes, etc per DWPT.  The values will be from IWC divided by the max thread states.                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12977833\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12977833&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12977833\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12977833_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12977833_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Jan\\/11 16:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-05T16:49:17+0000\'\u003e05\\/Jan\\/11 16:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003ePerhaps it\'s best to place the RAM tracking into FlushControl where the RAM\u003cbr\\/\u003e\\nconsumed by deleted query, terms, and added documents can be recorded, so that\u003cbr\\/\u003e\\nthe proper flush decision may be made in it, a central global object. To get this idea\u003cbr\\/\u003e\\nworking we\'d need to implement \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2573\\\" title=\\\"Tiered flushing of DWPTs by RAM with low\\/high water marks\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2573\\\"\u003e\u003cdel\u003eLUCENE-2573\u003c\\/del\u003e\u003c\\/a\u003e in FlushControl. I\'ll likely get\u003cbr\\/\u003e\\nstarted on this.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12977833_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12977833_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Jan\\/11 16:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-05T16:49:17+0000\'\u003e05\\/Jan\\/11 16:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Perhaps it\'s best to place the RAM tracking into FlushControl where the RAM \\nconsumed by deleted query, terms, and added documents can be recorded, so that \\nthe proper flush decision may be made in it, a central global object. To get this idea \\nworking we\'d need to implement   LUCENE-2573   in FlushControl. I\'ll likely get \\nstarted on this.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12977892\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12977892&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12977892\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12977892_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12977892_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Jan\\/11 18:32\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-05T18:32:07+0000\'\u003e05\\/Jan\\/11 18:32\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAnother model we could implement is a straight queuing. This\'d give us total\u003cbr\\/\u003e\\nordering on all IW calls. Documents, deletes, and flushes would be queued up\u003cbr\\/\u003e\\nand executed asynchronously. For example in today\'s DWPT code we will still\u003cbr\\/\u003e\\nblock document additions while flushing because we\'re tying a thread to a given\u003cbr\\/\u003e\\nDWPT. If a thread\'s DWPT is flushing, wouldn\'t we want to simply assign the doc\u003cbr\\/\u003e\\nadd to a different non-flushing DWPT to gain full efficiency? This seems more\u003cbr\\/\u003e\\neasily doable with a queuing model. If we want synchronous flushing then we\'d\u003cbr\\/\u003e\\nplace a flush event in the queue and wait for it to complete executing. How\u003cbr\\/\u003e\\ndoes this sound? \u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12977892_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12977892_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Jan\\/11 18:32\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-05T18:32:07+0000\'\u003e05\\/Jan\\/11 18:32\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Another model we could implement is a straight queuing. This\'d give us total \\nordering on all IW calls. Documents, deletes, and flushes would be queued up \\nand executed asynchronously. For example in today\'s DWPT code we will still \\nblock document additions while flushing because we\'re tying a thread to a given \\nDWPT. If a thread\'s DWPT is flushing, wouldn\'t we want to simply assign the doc \\nadd to a different non-flushing DWPT to gain full efficiency? This seems more \\neasily doable with a queuing model. If we want synchronous flushing then we\'d \\nplace a flush event in the queue and wait for it to complete executing. How \\ndoes this sound?  \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12978059\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12978059&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12978059\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12978059_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978059_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 00:31\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T00:31:15+0000\'\u003e06\\/Jan\\/11 00:31\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eTaking a step back, I\'m not sure flush control should be global, as flushing is\u003cbr\\/\u003e\\nentirely per thread now?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI think flush control must be global?  Ie when we\'ve used too much RAM we start flushing?\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eIf we\'re adding a delete term for every DWPT, if one\u003cbr\\/\u003e\\nis flushing do we wait or do we simply queue it up? I don\'t think we can wait\u003cbr\\/\u003e\\nin the delete call for a DWPT to completely flush?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI believe we can drop the delete in that case.  We only need to buffer into DWPTs that have at least 1 doc.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12978059_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978059_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 00:31\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T00:31:15+0000\'\u003e06\\/Jan\\/11 00:31\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n Taking a step back, I\'m not sure flush control should be global, as flushing is \\nentirely per thread now?  \\n\\n I think flush control must be global?  Ie when we\'ve used too much RAM we start flushing? \\n\\n \\n If we\'re adding a delete term for every DWPT, if one \\nis flushing do we wait or do we simply queue it up? I don\'t think we can wait \\nin the delete call for a DWPT to completely flush?  \\n\\n I believe we can drop the delete in that case.  We only need to buffer into DWPTs that have at least 1 doc.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12978060\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12978060&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12978060\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12978060_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978060_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 00:32\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T00:32:37+0000\'\u003e06\\/Jan\\/11 00:32\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e{queue}\u003cbr\\/\u003e\\nAnother model we could implement is a straight queuing. This\'d give us total\u003cbr\\/\u003e\\nordering on all IW calls. Documents, deletes, and flushes would be queued up\u003cbr\\/\u003e\\nand executed asynchronously. For example in today\'s DWPT code we will still\u003cbr\\/\u003e\\nblock document additions while flushing because we\'re tying a thread to a given\u003cbr\\/\u003e\\nDWPT. If a thread\'s DWPT is flushing, wouldn\'t we want to simply assign the doc\u003cbr\\/\u003e\\nadd to a different non-flushing DWPT to gain full efficiency? This seems more\u003cbr\\/\u003e\\neasily doable with a queuing model. If we want synchronous flushing then we\'d\u003cbr\\/\u003e\\nplace a flush event in the queue and wait for it to complete executing. How\u003cbr\\/\u003e\\ndoes this sound?{queue}\\n\u003cp\u003eI think we should have to add queueing to all incoming ops...\u003c\\/p\u003e\\n\\n\u003cp\u003eIf a given DWPT is flushing then we pick another?  Ie the binding logic would naturally avoid DWPTs that are not available &#8211; either because another thread has it, or it\'s flushing.  But it would prefer to use the same DWPT it used last time, if possible (affinity).\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12978060_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978060_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 00:32\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T00:32:37+0000\'\u003e06\\/Jan\\/11 00:32\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                   {queue} \\nAnother model we could implement is a straight queuing. This\'d give us total \\nordering on all IW calls. Documents, deletes, and flushes would be queued up \\nand executed asynchronously. For example in today\'s DWPT code we will still \\nblock document additions while flushing because we\'re tying a thread to a given \\nDWPT. If a thread\'s DWPT is flushing, wouldn\'t we want to simply assign the doc \\nadd to a different non-flushing DWPT to gain full efficiency? This seems more \\neasily doable with a queuing model. If we want synchronous flushing then we\'d \\nplace a flush event in the queue and wait for it to complete executing. How \\ndoes this sound?{queue}\\n I think we should have to add queueing to all incoming ops... \\n\\n If a given DWPT is flushing then we pick another?  Ie the binding logic would naturally avoid DWPTs that are not available &#8211; either because another thread has it, or it\'s flushing.  But it would prefer to use the same DWPT it used last time, if possible (affinity).              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12978065\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12978065&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12978065\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12978065_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978065_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 01:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T01:00:33+0000\'\u003e06\\/Jan\\/11 01:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eWe\'re going to great lengths it seems to emulate a producer consumer queue (eg,\u003cbr\\/\u003e\\nordering of calls with sequence ids, thread pooling) without actually\u003cbr\\/\u003e\\nimplementing one. A fixed size blocking queue would simply block threads as\u003cbr\\/\u003e\\nneeded and would probably look cleaner in code. We could still implement thread\u003cbr\\/\u003e\\naffinities though I simply can\'t see most applications requiring affinity, so\u003cbr\\/\u003e\\nperhaps we can avoid it for now and put it back in later? \u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eI think flush control must be global? Ie when we\'ve used too much RAM we\u003cbr\\/\u003e\\nstart flushing?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eRight, it should. I\'m just not sure we still need FC\'s global waiting during\u003cbr\\/\u003e\\nflush, that\'d seem to go away because the RAM usage tracking is in DW. If we\u003cbr\\/\u003e\\nrecord the new incremental RAM used (which I think we do) per add\\/update\\/delete\u003cbr\\/\u003e\\nthen we can enable a pluggable user defined flush policy. \u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003e If a given DWPT is flushing then we pick another? Ie the binding logic\u003cbr\\/\u003e\\nwould naturally avoid DWPTs that are not available - either because another\u003cbr\\/\u003e\\nthread has it, or it\'s flushing. But it would prefer to use the same DWPT it\u003cbr\\/\u003e\\nused last time, if possible (affinity). \u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eHowever once the affinity DWPT flush completed, we\'d need logic to revert back\u003cbr\\/\u003e\\nto the original?\u003c\\/p\u003e\\n\\n\u003cp\u003eI think the 5% model of \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2573\\\" title=\\\"Tiered flushing of DWPTs by RAM with low\\/high water marks\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2573\\\"\u003e\u003cdel\u003eLUCENE-2573\u003c\\/del\u003e\u003c\\/a\u003e may typically yield flushing that occurs in\u003cbr\\/\u003e\\nnear intervals of each other, ie, it\'s going to slow down the aggregate\u003cbr\\/\u003e\\nindexing if they\'re flushing on top of each other. Maybe we should start at 60%\u003cbr\\/\u003e\\nthen the multiple of 40% divided by maxthreadstate - 1? Ideally we\'d\u003cbr\\/\u003e\\nstatistically optimize the flush interval per machine, eg, SSDs and RAM disks\u003cbr\\/\u003e\\nwill likely require only a small flush percentage interval.\u003c\\/p\u003e\\n\\n\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12978065_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978065_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 01:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T01:00:33+0000\'\u003e06\\/Jan\\/11 01:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    We\'re going to great lengths it seems to emulate a producer consumer queue (eg, \\nordering of calls with sequence ids, thread pooling) without actually \\nimplementing one. A fixed size blocking queue would simply block threads as \\nneeded and would probably look cleaner in code. We could still implement thread \\naffinities though I simply can\'t see most applications requiring affinity, so \\nperhaps we can avoid it for now and put it back in later?  \\n\\n  I think flush control must be global? Ie when we\'ve used too much RAM we \\nstart flushing?  \\n\\n Right, it should. I\'m just not sure we still need FC\'s global waiting during \\nflush, that\'d seem to go away because the RAM usage tracking is in DW. If we \\nrecord the new incremental RAM used (which I think we do) per add\\/update\\/delete \\nthen we can enable a pluggable user defined flush policy.  \\n\\n   If a given DWPT is flushing then we pick another? Ie the binding logic \\nwould naturally avoid DWPTs that are not available - either because another \\nthread has it, or it\'s flushing. But it would prefer to use the same DWPT it \\nused last time, if possible (affinity).   \\n\\n However once the affinity DWPT flush completed, we\'d need logic to revert back \\nto the original? \\n\\n I think the 5% model of   LUCENE-2573   may typically yield flushing that occurs in \\nnear intervals of each other, ie, it\'s going to slow down the aggregate \\nindexing if they\'re flushing on top of each other. Maybe we should start at 60% \\nthen the multiple of 40% divided by maxthreadstate - 1? Ideally we\'d \\nstatistically optimize the flush interval per machine, eg, SSDs and RAM disks \\nwill likely require only a small flush percentage interval. \\n\\n\\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12978075\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12978075&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12978075\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12978075_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978075_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 01:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T01:49:39+0000\'\u003e06\\/Jan\\/11 01:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eI believe we can drop the delete in that case. We only need to buffer\u003cbr\\/\u003e\\ninto DWPTs that have at least 1 doc.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eRight if the DWPT\'s flushing we can skip it. In the queue model we\'d consume and locate\u003cbr\\/\u003e\\nthe existing DWPTs, adding the delete to each DWPT not flushing. However in the\u003cbr\\/\u003e\\nzero DWPT case we still need to record a delete somewhere, most likely we\'d\u003cbr\\/\u003e\\nneed to create a zero doc DWPT? Oh wait, we need to add the delete to the last\u003cbr\\/\u003e\\nsegment? Ah, I can fix that in the existing code (eg, fix the reopen test case\u003cbr\\/\u003e\\nfailures).\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12978075_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978075_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 01:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T01:49:39+0000\'\u003e06\\/Jan\\/11 01:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     I believe we can drop the delete in that case. We only need to buffer \\ninto DWPTs that have at least 1 doc.  \\n\\n Right if the DWPT\'s flushing we can skip it. In the queue model we\'d consume and locate \\nthe existing DWPTs, adding the delete to each DWPT not flushing. However in the \\nzero DWPT case we still need to record a delete somewhere, most likely we\'d \\nneed to create a zero doc DWPT? Oh wait, we need to add the delete to the last \\nsegment? Ah, I can fix that in the existing code (eg, fix the reopen test case \\nfailures).              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12978129\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12978129&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12978129\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12978129_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978129_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 05:04\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T05:04:12+0000\'\u003e06\\/Jan\\/11 05:04\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eSame as the last patch, however default deletes is added to DW to which deletes are added to when there are no available DWPTs.  On flush all threads, default deletes is applied to the last segment with no doc limit.  \u003c\\/p\u003e\\n\\n\u003cp\u003eTestIndexReaderReopen now passes.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12978129_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978129_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 05:04\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T05:04:12+0000\'\u003e06\\/Jan\\/11 05:04\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Same as the last patch, however default deletes is added to DW to which deletes are added to when there are no available DWPTs.  On flush all threads, default deletes is applied to the last segment with no doc limit.   \\n\\n TestIndexReaderReopen now passes.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12978140\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12978140&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12978140\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12978140_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978140_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 05:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T05:20:10+0000\'\u003e06\\/Jan\\/11 05:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHere\'s a new test.out, I\'ll look at TestCheckIndex which should probably work.  \u003c\\/p\u003e\\n\\n\u003cp\u003e\\\"IndexFileDeleter doesn\'t know about file\\\" seems odd.  We\'re OOMing in TestIndexWriter because we\'re not flushing by RAM (eg, it currently defaults to return false).\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12978140_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978140_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 05:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T05:20:10+0000\'\u003e06\\/Jan\\/11 05:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Here\'s a new test.out, I\'ll look at TestCheckIndex which should probably work.   \\n\\n \\\"IndexFileDeleter doesn\'t know about file\\\" seems odd.  We\'re OOMing in TestIndexWriter because we\'re not flushing by RAM (eg, it currently defaults to return false).              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12978401\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12978401&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12978401\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12978401_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978401_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 16:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T16:35:38+0000\'\u003e06\\/Jan\\/11 16:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eWe\'re going to great lengths it seems to emulate a producer consumer queue (eg,\u003cbr\\/\u003e\\nordering of calls with sequence ids, thread pooling) without actually\u003cbr\\/\u003e\\nimplementing one. A fixed size blocking queue would simply block threads as\u003cbr\\/\u003e\\nneeded and would probably look cleaner in code. We could still implement thread\u003cbr\\/\u003e\\naffinities though I simply can\'t see most applications requiring affinity, so\u003cbr\\/\u003e\\nperhaps we can avoid it for now and put it back in later?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI\'m not sure we should queue.  I wonder how much this\'d slow down the single threaded case?\u003c\\/p\u003e\\n\\n\u003cp\u003eAlso: I thought we don\'t have sequence IDs anymore?  (At least, for landing DWPT; after that (for \\\"true RT\\\") we need something like sequence IDs?).\u003c\\/p\u003e\\n\\n\u003cp\u003eI think thread\\/doc-class affinity is fairly important.  Docs compress better if they are indexed together with similar docs.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eI\'m just not sure we still need FC\'s global waiting during flush, that\'d seem to go away because the RAM usage tracking is in DW.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eWe shouldn\'t do global waiting anymore &#8211; this is what\'s great about DWPT.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eHowever once the affinity DWPT flush completed, we\'d need logic to revert back to the original?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI don\'t think so?  I mean a DWPT post-flush is a clean slate.  Some other thread\\/doc-class can stick to it.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eI think the 5% model of \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-2573\\\" title=\\\"Tiered flushing of DWPTs by RAM with low\\/high water marks\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-2573\\\"\u003e\u003cdel\u003eLUCENE-2573\u003c\\/del\u003e\u003c\\/a\u003e may typically yield flushing that occurs in\u003cbr\\/\u003e\\nnear intervals of each other, ie, it\'s going to slow down the aggregate\u003cbr\\/\u003e\\nindexing if they\'re flushing on top of each other. Maybe we should start at 60%\u003cbr\\/\u003e\\nthen the multiple of 40% divided by maxthreadstate - 1? Ideally we\'d\u003cbr\\/\u003e\\nstatistically optimize the flush interval per machine, eg, SSDs and RAM disks\u003cbr\\/\u003e\\nwill likely require only a small flush percentage interval.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYeah we\'ll have to run tests to try to gauge the best \\\"default\\\" policy.  And you\'re right that it\'ll depend on the relative strength of IO vs CPU on the machine.  Fast IO system means we can flush \\\"later\\\".\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12978401_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978401_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 16:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T16:35:38+0000\'\u003e06\\/Jan\\/11 16:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n We\'re going to great lengths it seems to emulate a producer consumer queue (eg, \\nordering of calls with sequence ids, thread pooling) without actually \\nimplementing one. A fixed size blocking queue would simply block threads as \\nneeded and would probably look cleaner in code. We could still implement thread \\naffinities though I simply can\'t see most applications requiring affinity, so \\nperhaps we can avoid it for now and put it back in later?  \\n\\n I\'m not sure we should queue.  I wonder how much this\'d slow down the single threaded case? \\n\\n Also: I thought we don\'t have sequence IDs anymore?  (At least, for landing DWPT; after that (for \\\"true RT\\\") we need something like sequence IDs?). \\n\\n I think thread\\/doc-class affinity is fairly important.  Docs compress better if they are indexed together with similar docs. \\n\\n  I\'m just not sure we still need FC\'s global waiting during flush, that\'d seem to go away because the RAM usage tracking is in DW.  \\n\\n We shouldn\'t do global waiting anymore &#8211; this is what\'s great about DWPT. \\n\\n  However once the affinity DWPT flush completed, we\'d need logic to revert back to the original?  \\n\\n I don\'t think so?  I mean a DWPT post-flush is a clean slate.  Some other thread\\/doc-class can stick to it. \\n\\n \\n I think the 5% model of   LUCENE-2573   may typically yield flushing that occurs in \\nnear intervals of each other, ie, it\'s going to slow down the aggregate \\nindexing if they\'re flushing on top of each other. Maybe we should start at 60% \\nthen the multiple of 40% divided by maxthreadstate - 1? Ideally we\'d \\nstatistically optimize the flush interval per machine, eg, SSDs and RAM disks \\nwill likely require only a small flush percentage interval.  \\n\\n Yeah we\'ll have to run tests to try to gauge the best \\\"default\\\" policy.  And you\'re right that it\'ll depend on the relative strength of IO vs CPU on the machine.  Fast IO system means we can flush \\\"later\\\".              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12978403\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12978403&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12978403\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12978403_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978403_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 16:37\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T16:37:26+0000\'\u003e06\\/Jan\\/11 16:37\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eRight if the DWPT\'s flushing we can skip it. In the queue model we\'d consume and locate\u003cbr\\/\u003e\\nthe existing DWPTs, adding the delete to each DWPT not flushing.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eWe have an issue open for the app to state that the delete will not apply to any docs indexed in the current session... once we do that, then, the deletes don\'t need to be buffered on any DWPTs; just on the \\\"latest\\\" already flushed segment in the index.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eHowever in the\u003cbr\\/\u003e\\nzero DWPT case we still need to record a delete somewhere, most likely we\'d\u003cbr\\/\u003e\\nneed to create a zero doc DWPT? Oh wait, we need to add the delete to the last\u003cbr\\/\u003e\\nsegment? Ah, I can fix that in the existing code (eg, fix the reopen test case\u003cbr\\/\u003e\\nfailures).\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYes, to the last flushed segment.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12978403_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978403_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 16:37\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T16:37:26+0000\'\u003e06\\/Jan\\/11 16:37\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n Right if the DWPT\'s flushing we can skip it. In the queue model we\'d consume and locate \\nthe existing DWPTs, adding the delete to each DWPT not flushing.  \\n\\n We have an issue open for the app to state that the delete will not apply to any docs indexed in the current session... once we do that, then, the deletes don\'t need to be buffered on any DWPTs; just on the \\\"latest\\\" already flushed segment in the index. \\n\\n \\n However in the \\nzero DWPT case we still need to record a delete somewhere, most likely we\'d \\nneed to create a zero doc DWPT? Oh wait, we need to add the delete to the last \\nsegment? Ah, I can fix that in the existing code (eg, fix the reopen test case \\nfailures).  \\n\\n Yes, to the last flushed segment.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12978409\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12978409&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12978409\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12978409_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978409_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 16:56\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T16:56:35+0000\'\u003e06\\/Jan\\/11 16:56\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI added a FlushPolicy class, deletes record the ram used to DWPT and DW.  Recording to DW is for global ram used.  The TIW OOM is still occurring however.  The delete calls to FlushControl are gone, I\'m not sure what\'s going to be left of it.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eI\'m not sure we should queue. I wonder how much this\'d slow down the single threaded case?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYes, that\'s a good point.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eWe shouldn\'t do global waiting anymore - this is what\'s great about DWPT.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eHowever we\'ll have global waiting for the flush all threads case.  I think that can move down to DW though.  Or should it simply be a sync in\\/on IW?\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eI thought we don\'t have sequence IDs anymore?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThe seqid lock was there, however it was removed in the last update.  I think we need to clearly document the various locks and sync points as right now it\'s not clear enough to prevent deadlock situations.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12978409_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978409_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 16:56\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T16:56:35+0000\'\u003e06\\/Jan\\/11 16:56\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I added a FlushPolicy class, deletes record the ram used to DWPT and DW.  Recording to DW is for global ram used.  The TIW OOM is still occurring however.  The delete calls to FlushControl are gone, I\'m not sure what\'s going to be left of it. \\n\\n  I\'m not sure we should queue. I wonder how much this\'d slow down the single threaded case?  \\n\\n Yes, that\'s a good point. \\n\\n  We shouldn\'t do global waiting anymore - this is what\'s great about DWPT.  \\n\\n However we\'ll have global waiting for the flush all threads case.  I think that can move down to DW though.  Or should it simply be a sync in\\/on IW? \\n\\n  I thought we don\'t have sequence IDs anymore?  \\n\\n The seqid lock was there, however it was removed in the last update.  I think we need to clearly document the various locks and sync points as right now it\'s not clear enough to prevent deadlock situations.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12978466\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12978466&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12978466\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12978466_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978466_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 19:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T19:16:28+0000\'\u003e06\\/Jan\\/11 19:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eI believe we can drop the delete in that case. We only need to buffer into DWPTs that have at least 1 doc.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYeah sounds right.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eIf a given DWPT is flushing then we pick another? Ie the binding logic would naturally avoid DWPTs that are not available - either because another thread has it, or it\'s flushing. But it would prefer to use the same DWPT it used last time, if possible (affinity).\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThis is actually what should be happening currently if the (default) ThreadAffinityThreadPool is used.  I\'ve to check the code again and maybe write a test specifically for that.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eAlso: I thought we don\'t have sequence IDs anymore? (At least, for landing DWPT; after that (for \\\"true RT\\\") we need something like sequence IDs?).\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eTrue, sequenceIDs are gone since the last merge.  And yes, I still think we\'ll need them for RT.  Even for the non-RT case sequenceIDs would have nice benefits.  If methods like addDocument(), deleteDocuments(), etc. return the sequenceID they\'d define a strict ordering on those operations and make it transparent for the application, which would be beneficial for document tracking and log replay.\u003c\\/p\u003e\\n\\n\u003cp\u003eBut anyway, let\'s add seqIDs back after the DWPT changes are done and in trunk.\u003c\\/p\u003e\\n\\n\\n\u003cblockquote\u003e\\n\u003cblockquote\u003e\u003cp\u003eWe shouldn\'t do global waiting anymore - this is what\'s great about DWPT.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eHowever we\'ll have global waiting for the flush all threads case. I think that can move down to DW though. Or should it simply be a sync in\\/on IW?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eTrue, the only global lock that locks all thread states happens when flushAllThreads is called.  This is called when IW explicitly triggers a flush, e.g. on close\\/commit.  \u003cbr\\/\u003e\\nHowever, maybe this is not the right approach?  I guess we don\'t really need the global lock.  A thread performing the \\\"global flush\\\" could still acquire each thread state before it starts flushing, but return a threadState to the pool once that particular threadState is done flushing?\u003c\\/p\u003e\\n\\n\u003cp\u003eA related question is: Do we want to piggyback on multiple threads when a global flush happens?  Eg. Thread 1 called commit, Thread 2 shortly afterwards addDocument().  When should addDocument() happen? \u003cbr\\/\u003e\\na) After all DWPTs finished flushing? \u003cbr\\/\u003e\\nb) After at least one DWPT finished flushing and is available again?\u003cbr\\/\u003e\\nc) Or should Thread 2 be used to help flushing DWPTs in parallel with Thread 1?  \u003c\\/p\u003e\\n\\n\u003cp\u003ea) is currently implemented, but I think not really what we want.\u003cbr\\/\u003e\\nb) is probably best for RT, because it means the lowest indexing latency for the new document to be added.\u003cbr\\/\u003e\\nc) probably means the best overall throughput (depending even on hardware like disk speed, etc)\u003c\\/p\u003e\\n\\n\u003cp\u003eFor whatever option we pick, we\'ll have to carefully think about error handling.  It\'s quite straightforward for a) (just commit all flushed segments to SegmentInfos when the global flush completed succesfully).  But for b) and c) it\'s unclear what should happen if a DWPT flush fails after some completed already successfully before.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12978466_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978466_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 19:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T19:16:28+0000\'\u003e06\\/Jan\\/11 19:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n I believe we can drop the delete in that case. We only need to buffer into DWPTs that have at least 1 doc.  \\n\\n Yeah sounds right. \\n\\n \\n If a given DWPT is flushing then we pick another? Ie the binding logic would naturally avoid DWPTs that are not available - either because another thread has it, or it\'s flushing. But it would prefer to use the same DWPT it used last time, if possible (affinity).  \\n\\n This is actually what should be happening currently if the (default) ThreadAffinityThreadPool is used.  I\'ve to check the code again and maybe write a test specifically for that. \\n\\n  Also: I thought we don\'t have sequence IDs anymore? (At least, for landing DWPT; after that (for \\\"true RT\\\") we need something like sequence IDs?).  \\n\\n True, sequenceIDs are gone since the last merge.  And yes, I still think we\'ll need them for RT.  Even for the non-RT case sequenceIDs would have nice benefits.  If methods like addDocument(), deleteDocuments(), etc. return the sequenceID they\'d define a strict ordering on those operations and make it transparent for the application, which would be beneficial for document tracking and log replay. \\n\\n But anyway, let\'s add seqIDs back after the DWPT changes are done and in trunk. \\n\\n\\n \\n  We shouldn\'t do global waiting anymore - this is what\'s great about DWPT.  \\n\\n However we\'ll have global waiting for the flush all threads case. I think that can move down to DW though. Or should it simply be a sync in\\/on IW?  \\n\\n True, the only global lock that locks all thread states happens when flushAllThreads is called.  This is called when IW explicitly triggers a flush, e.g. on close\\/commit.   \\nHowever, maybe this is not the right approach?  I guess we don\'t really need the global lock.  A thread performing the \\\"global flush\\\" could still acquire each thread state before it starts flushing, but return a threadState to the pool once that particular threadState is done flushing? \\n\\n A related question is: Do we want to piggyback on multiple threads when a global flush happens?  Eg. Thread 1 called commit, Thread 2 shortly afterwards addDocument().  When should addDocument() happen?  \\na) After all DWPTs finished flushing?  \\nb) After at least one DWPT finished flushing and is available again? \\nc) Or should Thread 2 be used to help flushing DWPTs in parallel with Thread 1?   \\n\\n a) is currently implemented, but I think not really what we want. \\nb) is probably best for RT, because it means the lowest indexing latency for the new document to be added. \\nc) probably means the best overall throughput (depending even on hardware like disk speed, etc) \\n\\n For whatever option we pick, we\'ll have to carefully think about error handling.  It\'s quite straightforward for a) (just commit all flushed segments to SegmentInfos when the global flush completed succesfully).  But for b) and c) it\'s unclear what should happen if a DWPT flush fails after some completed already successfully before.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12978504\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12978504&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12978504\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12978504_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978504_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 21:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T21:00:34+0000\'\u003e06\\/Jan\\/11 21:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eactually what should be happening currently if the (default)\u003cbr\\/\u003e\\nThreadAffinityThreadPool is used. I\'ve to check the code again and maybe write\u003cbr\\/\u003e\\na test specifically for that.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eLets try to test it, though I\'m not immediately sure how the test case\'d look. \u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003elet\'s add seqIDs back after the DWPT changes are done and in trunk.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eRight.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eTrue, the only global lock that locks all thread states happens when\u003cbr\\/\u003e\\nflushAllThreads is called. This is called when IW explicitly triggers a flush,\u003cbr\\/\u003e\\ne.g. on close\\/commit. However, maybe this is not the right approach?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI think this is fine for the DWPT branch as flush, commit, and close are\u003cbr\\/\u003e\\nexplicitly blocked commands issued by the user. If we implemented something\u003cbr\\/\u003e\\nmore complex now, it wouldn\'t carry over to RT because the DWPTs don\'t require\u003cbr\\/\u003e\\nflushing to search on them. Which leads to the main drawback probably being for\u003cbr\\/\u003e\\nNRT, eg, get reader. Hmm... In that case a stop the world flush does affect\u003cbr\\/\u003e\\noverall indexing performance. Perhaps we can add flush and not block all DWPTs\u003cbr\\/\u003e\\nin a separate issue after the DWPT branch is merged to trunk, if there\'s user\u003cbr\\/\u003e\\nneed?  Or perhaps it\'s easy to implement, I\'m still trying to get a feel for the\u003cbr\\/\u003e\\nlock progression in the branch. \u003c\\/p\u003e\\n\\n\u003cp\u003eIn the indexing many documents case, the DWPTs\'ll be flushed by the tiered RAM\u003cbr\\/\u003e\\nsystem. It\'s the bulk add case where we don\'t want to block all threads\\/DWPTs\u003cbr\\/\u003e\\nat once, eg, I think our main goal is to fix Mike\'s performance test, with NRT\u003cbr\\/\u003e\\nbeing secondary or even a distraction.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eBut for b) and c) it\'s unclear what should happen if a DWPT flush fails\u003cbr\\/\u003e\\nafter some completed already successfully before.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eRight, all that\'d be solved if we bulk moved IW to a Scala-like asynchronous\u003cbr\\/\u003e\\nqueuing model. However it\'s probably a bit too much to do right now. Perhaps in\u003cbr\\/\u003e\\nthe bulk add-many-docs case we\'ll need a callback for errors? No because the\u003cbr\\/\u003e\\nadd doc method call that triggers the flush will report any exception(s).\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12978504_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978504_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 21:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T21:00:34+0000\'\u003e06\\/Jan\\/11 21:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     actually what should be happening currently if the (default) \\nThreadAffinityThreadPool is used. I\'ve to check the code again and maybe write \\na test specifically for that.  \\n\\n Lets try to test it, though I\'m not immediately sure how the test case\'d look.  \\n\\n  let\'s add seqIDs back after the DWPT changes are done and in trunk.  \\n\\n Right. \\n\\n  True, the only global lock that locks all thread states happens when \\nflushAllThreads is called. This is called when IW explicitly triggers a flush, \\ne.g. on close\\/commit. However, maybe this is not the right approach?  \\n\\n I think this is fine for the DWPT branch as flush, commit, and close are \\nexplicitly blocked commands issued by the user. If we implemented something \\nmore complex now, it wouldn\'t carry over to RT because the DWPTs don\'t require \\nflushing to search on them. Which leads to the main drawback probably being for \\nNRT, eg, get reader. Hmm... In that case a stop the world flush does affect \\noverall indexing performance. Perhaps we can add flush and not block all DWPTs \\nin a separate issue after the DWPT branch is merged to trunk, if there\'s user \\nneed?  Or perhaps it\'s easy to implement, I\'m still trying to get a feel for the \\nlock progression in the branch.  \\n\\n In the indexing many documents case, the DWPTs\'ll be flushed by the tiered RAM \\nsystem. It\'s the bulk add case where we don\'t want to block all threads\\/DWPTs \\nat once, eg, I think our main goal is to fix Mike\'s performance test, with NRT \\nbeing secondary or even a distraction. \\n\\n  But for b) and c) it\'s unclear what should happen if a DWPT flush fails \\nafter some completed already successfully before.  \\n\\n Right, all that\'d be solved if we bulk moved IW to a Scala-like asynchronous \\nqueuing model. However it\'s probably a bit too much to do right now. Perhaps in \\nthe bulk add-many-docs case we\'ll need a callback for errors? No because the \\nadd doc method call that triggers the flush will report any exception(s).              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12978516\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12978516&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12978516\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12978516_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978516_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 21:25\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T21:25:05+0000\'\u003e06\\/Jan\\/11 21:25\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eWhen we\'re OOMing the ram used reported by DW is 0.  We\'re probably not adding to the RAM used value somewhere.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12978516_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978516_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 21:25\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T21:25:05+0000\'\u003e06\\/Jan\\/11 21:25\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    When we\'re OOMing the ram used reported by DW is 0.  We\'re probably not adding to the RAM used value somewhere.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12978563\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12978563&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12978563\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12978563_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978563_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 23:11\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T23:11:18+0000\'\u003e06\\/Jan\\/11 23:11\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eRAM accounting is slightly improved, we had two variables in DW keeping track of it.  The extraneous is removed, however we\'re still OOMing in: ant test-core -Dtestcase=TestIndexWriter -Dtestmethod=testIndexingThenDeleting\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12978563_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12978563_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jan\\/11 23:11\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-06T23:11:18+0000\'\u003e06\\/Jan\\/11 23:11\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    RAM accounting is slightly improved, we had two variables in DW keeping track of it.  The extraneous is removed, however we\'re still OOMing in: ant test-core -Dtestcase=TestIndexWriter -Dtestmethod=testIndexingThenDeleting              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12979129\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12979129&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12979129\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12979129_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979129_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Jan\\/11 14:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-08T14:00:14+0000\'\u003e08\\/Jan\\/11 14:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eI guess we don\'t really need the global lock. A thread performing the \\\"global flush\\\" could still acquire each thread state before it starts flushing, but return a threadState to the pool once that particular threadState is done flushing?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eGood question... we could (in theory) also flush them concurrently?  But, since we don\'t \\\"own\\\" the threads in IW, we can\'t easily do that, so I think no global lock, go through all DWPTs w\\/ current thread and flush, sequentially?  So all that\'s guaranteed after the global flush() returns is that all state present prior to when flush() is invoked, is moved to disk.  Ie if addDocs are still happening concurrently then the DWPTs will start filling up again even while the \\\"global flush\\\" runs.  That\'s fine.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\\n\u003cp\u003eA related question is: Do we want to piggyback on multiple threads when a global flush happens? Eg. Thread 1 called commit, Thread 2 shortly afterwards addDocument(). When should addDocument() happen? \u003cbr\\/\u003e\\na) After all DWPTs finished flushing? \u003cbr\\/\u003e\\nb) After at least one DWPT finished flushing and is available again?\u003cbr\\/\u003e\\nc) Or should Thread 2 be used to help flushing DWPTs in parallel with Thread 1?\u003c\\/p\u003e\\n\\n\u003cp\u003ea) is currently implemented, but I think not really what we want.\u003cbr\\/\u003e\\nb) is probably best for RT, because it means the lowest indexing latency for the new document to be added.\u003cbr\\/\u003e\\nc) probably means the best overall throughput (depending even on hardware like disk speed, etc)\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI think start simple &#8211; the addDocument always happens?  Ie it\'s never coordinated w\\/ the ongoing flush.  It picks a free DWPT like normal, and since flush is single threaded, there should always be a free DWPT?\u003c\\/p\u003e\\n\\n\u003cp\u003eLonger term c) would be great, or, if IW has an ES then it\'d send multiple flush jobs to the ES.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eFor whatever option we pick, we\'ll have to carefully think about error handling. It\'s quite straightforward for a) (just commit all flushed segments to SegmentInfos when the global flush completed succesfully). But for b) and c) it\'s unclear what should happen if a DWPT flush fails after some completed already successfully before.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI think we should continue what we do today?  Ie, if it\'s an \'aborting\' exception, then the entire segment held by that DWPT is discarded?  And we then throw this exc back to caller (and don\'t try to flush any other segments)?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12979129_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979129_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Jan\\/11 14:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-08T14:00:14+0000\'\u003e08\\/Jan\\/11 14:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     I guess we don\'t really need the global lock. A thread performing the \\\"global flush\\\" could still acquire each thread state before it starts flushing, but return a threadState to the pool once that particular threadState is done flushing?  \\n\\n Good question... we could (in theory) also flush them concurrently?  But, since we don\'t \\\"own\\\" the threads in IW, we can\'t easily do that, so I think no global lock, go through all DWPTs w\\/ current thread and flush, sequentially?  So all that\'s guaranteed after the global flush() returns is that all state present prior to when flush() is invoked, is moved to disk.  Ie if addDocs are still happening concurrently then the DWPTs will start filling up again even while the \\\"global flush\\\" runs.  That\'s fine. \\n\\n \\n\\n A related question is: Do we want to piggyback on multiple threads when a global flush happens? Eg. Thread 1 called commit, Thread 2 shortly afterwards addDocument(). When should addDocument() happen?  \\na) After all DWPTs finished flushing?  \\nb) After at least one DWPT finished flushing and is available again? \\nc) Or should Thread 2 be used to help flushing DWPTs in parallel with Thread 1? \\n\\n a) is currently implemented, but I think not really what we want. \\nb) is probably best for RT, because it means the lowest indexing latency for the new document to be added. \\nc) probably means the best overall throughput (depending even on hardware like disk speed, etc)  \\n\\n I think start simple &#8211; the addDocument always happens?  Ie it\'s never coordinated w\\/ the ongoing flush.  It picks a free DWPT like normal, and since flush is single threaded, there should always be a free DWPT? \\n\\n Longer term c) would be great, or, if IW has an ES then it\'d send multiple flush jobs to the ES. \\n\\n \\n For whatever option we pick, we\'ll have to carefully think about error handling. It\'s quite straightforward for a) (just commit all flushed segments to SegmentInfos when the global flush completed succesfully). But for b) and c) it\'s unclear what should happen if a DWPT flush fails after some completed already successfully before.  \\n\\n I think we should continue what we do today?  Ie, if it\'s an \'aborting\' exception, then the entire segment held by that DWPT is discarded?  And we then throw this exc back to caller (and don\'t try to flush any other segments)?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12979138\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12979138&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12979138\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12979138_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979138_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Jan\\/11 15:32\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-08T15:32:17+0000\'\u003e08\\/Jan\\/11 15:32\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eSo all that\'s guaranteed after the global flush() returns is that all\u003cbr\\/\u003e\\nstate present prior to when flush() is invoked, is moved to disk. Ie if addDocs\u003cbr\\/\u003e\\nare still happening concurrently then the DWPTs will start filling up again\u003cbr\\/\u003e\\neven while the \\\"global flush\\\" runs. That\'s fine.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eWhat if the user wants a guaranteed hard flush of all state up to the point of\u003cbr\\/\u003e\\nthe flush call (won\'t they want this sometimes with getReader)? If we\'re\u003cbr\\/\u003e\\nflushing sequentially (without pausing all threads) we\'re removing that? Maybe\u003cbr\\/\u003e\\nwe\'ll need to give the option of global lock\\/stop or sequential flush?\u003c\\/p\u003e\\n\\n\u003cp\u003eAlso I think we need to clear the thread bindings of a DWPT just prior to the\u003cbr\\/\u003e\\nflush of the DWPT? Otherwise (when multiple threads are mapped to a single\u003cbr\\/\u003e\\nDWPT) the other threads will wait on the \u003cspan class=\\\"error\\\"\u003e&#91;main&#93;\u003c\\/span\u003e DWPT flush when they should be\u003cbr\\/\u003e\\nspinning up a new DWPT? \u003c\\/p\u003e\\n\\n\u003cp\u003eThen, what happens to reusing the DWPT if we\'re flushing it, and we spin a new\u003cbr\\/\u003e\\nDWPT (effectively replacing the old DWPT), eg, we\'re going to lose the byte[]\u003cbr\\/\u003e\\nrecycling? Maybe we need to and share and sync the byte[] pooling between DWPTs\u003cbr\\/\u003e\\nor will that noticeably affect indexing performance? \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12979138_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979138_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Jan\\/11 15:32\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-08T15:32:17+0000\'\u003e08\\/Jan\\/11 15:32\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     So all that\'s guaranteed after the global flush() returns is that all \\nstate present prior to when flush() is invoked, is moved to disk. Ie if addDocs \\nare still happening concurrently then the DWPTs will start filling up again \\neven while the \\\"global flush\\\" runs. That\'s fine.  \\n\\n What if the user wants a guaranteed hard flush of all state up to the point of \\nthe flush call (won\'t they want this sometimes with getReader)? If we\'re \\nflushing sequentially (without pausing all threads) we\'re removing that? Maybe \\nwe\'ll need to give the option of global lock\\/stop or sequential flush? \\n\\n Also I think we need to clear the thread bindings of a DWPT just prior to the \\nflush of the DWPT? Otherwise (when multiple threads are mapped to a single \\nDWPT) the other threads will wait on the  &#91;main&#93;  DWPT flush when they should be \\nspinning up a new DWPT?  \\n\\n Then, what happens to reusing the DWPT if we\'re flushing it, and we spin a new \\nDWPT (effectively replacing the old DWPT), eg, we\'re going to lose the byte[] \\nrecycling? Maybe we need to and share and sync the byte[] pooling between DWPTs \\nor will that noticeably affect indexing performance?               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12979139\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12979139&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12979139\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12979139_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979139_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Jan\\/11 15:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-08T15:35:14+0000\'\u003e08\\/Jan\\/11 15:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAlso, don\'t we need the global lock for commit\\/close?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12979139_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979139_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Jan\\/11 15:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-08T15:35:14+0000\'\u003e08\\/Jan\\/11 15:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Also, don\'t we need the global lock for commit\\/close?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12979146\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12979146&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12979146\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12979146_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979146_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Jan\\/11 16:17\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-08T16:17:38+0000\'\u003e08\\/Jan\\/11 16:17\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eWhat if the user wants a guaranteed hard flush of all state up to the point of\u003cbr\\/\u003e\\nthe flush call (won\'t they want this sometimes with getReader)? If we\'re\u003cbr\\/\u003e\\nflushing sequentially (without pausing all threads) we\'re removing that? Maybe\u003cbr\\/\u003e\\nwe\'ll need to give the option of global lock\\/stop or sequential flush?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eWhat\'s a \\\"hard flush\\\"?\u003c\\/p\u003e\\n\\n\u003cp\u003eWith the proposed approach, all docs added (or in the process of being added) will make it into the flushed segments once the flush returns; newly added docs after the flush call started may or not make it.  But this is fine?  I mean, if the app has stronger requirements then it should externally sync?\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eAlso I think we need to clear the thread bindings of a DWPT just prior to the flush of the DWPT? \u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eRight.\u003c\\/p\u003e\\n\\n\u003cp\u003eAs soon as a DWPT is pulled from production for flushing, it loses all thread affinity and becomes unavailable until its flush finishes.  When a thread needs a DWPT, it tries to pick the one it last had (affinity) but if that one\'s busy, it picks a new one.  If none are available but we are below our max DWPT count, it spins up a new one?\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eThen, what happens to reusing the DWPT if we\'re flushing it, and we spin a new\u003cbr\\/\u003e\\nDWPT (effectively replacing the old DWPT), eg, we\'re going to lose the byte[]\u003cbr\\/\u003e\\nrecycling?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eWhy would we lose them?  Wouldn\'t that DWPT just go back into rotation once the flush is done?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12979146_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979146_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Jan\\/11 16:17\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-08T16:17:38+0000\'\u003e08\\/Jan\\/11 16:17\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n What if the user wants a guaranteed hard flush of all state up to the point of \\nthe flush call (won\'t they want this sometimes with getReader)? If we\'re \\nflushing sequentially (without pausing all threads) we\'re removing that? Maybe \\nwe\'ll need to give the option of global lock\\/stop or sequential flush?  \\n\\n What\'s a \\\"hard flush\\\"? \\n\\n With the proposed approach, all docs added (or in the process of being added) will make it into the flushed segments once the flush returns; newly added docs after the flush call started may or not make it.  But this is fine?  I mean, if the app has stronger requirements then it should externally sync? \\n\\n  Also I think we need to clear the thread bindings of a DWPT just prior to the flush of the DWPT?   \\n\\n Right. \\n\\n As soon as a DWPT is pulled from production for flushing, it loses all thread affinity and becomes unavailable until its flush finishes.  When a thread needs a DWPT, it tries to pick the one it last had (affinity) but if that one\'s busy, it picks a new one.  If none are available but we are below our max DWPT count, it spins up a new one? \\n\\n \\n Then, what happens to reusing the DWPT if we\'re flushing it, and we spin a new \\nDWPT (effectively replacing the old DWPT), eg, we\'re going to lose the byte[] \\nrecycling?  \\n\\n Why would we lose them?  Wouldn\'t that DWPT just go back into rotation once the flush is done?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12979149\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12979149&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12979149\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12979149_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979149_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Jan\\/11 16:36\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-08T16:36:46+0000\'\u003e08\\/Jan\\/11 16:36\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eAs soon as a DWPT is pulled from production for flushing, it loses all thread affinity and becomes unavailable until its flush finishes. When a thread needs a DWPT, it tries to pick the one it last had (affinity) but if that one\'s busy, it picks a new one. If none are available but we are below our max DWPT count, it spins up a new one?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eRight.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eWith the proposed approach, all docs added (or in the process of being added) will make it into the flushed segments once the flush returns; newly added docs after the flush call started may or not make it. But this is fine? I mean, if the app has stronger requirements then it should externally sync?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eOk.  The proposed change is simply the thread calling add doc will flush it\'s DWPT if needed, take it offline while doing so, and return it when completed.  I think the risk is a new DWPT likely will have been created during flush, which\'d make the returning DWPT inutile?\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eWhy would we lose them? Wouldn\'t that DWPT just go back into rotation once the flush is done?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYes, we just need to change the existing code a bit then.\u003c\\/p\u003e\\n\\n\u003cp\u003eHowever I think we may still need the global lock for close, eg, today we\'re preventing the user from adding docs during close, after this issue is merged that behavior would change?  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12979149_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979149_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Jan\\/11 16:36\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-08T16:36:46+0000\'\u003e08\\/Jan\\/11 16:36\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     As soon as a DWPT is pulled from production for flushing, it loses all thread affinity and becomes unavailable until its flush finishes. When a thread needs a DWPT, it tries to pick the one it last had (affinity) but if that one\'s busy, it picks a new one. If none are available but we are below our max DWPT count, it spins up a new one?  \\n\\n Right. \\n\\n  With the proposed approach, all docs added (or in the process of being added) will make it into the flushed segments once the flush returns; newly added docs after the flush call started may or not make it. But this is fine? I mean, if the app has stronger requirements then it should externally sync?  \\n\\n Ok.  The proposed change is simply the thread calling add doc will flush it\'s DWPT if needed, take it offline while doing so, and return it when completed.  I think the risk is a new DWPT likely will have been created during flush, which\'d make the returning DWPT inutile? \\n\\n  Why would we lose them? Wouldn\'t that DWPT just go back into rotation once the flush is done?  \\n\\n Yes, we just need to change the existing code a bit then. \\n\\n However I think we may still need the global lock for close, eg, today we\'re preventing the user from adding docs during close, after this issue is merged that behavior would change?                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12979162\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12979162&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12979162\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12979162_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979162_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Jan\\/11 17:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-08T17:35:18+0000\'\u003e08\\/Jan\\/11 17:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAnd there\'s the case of the thread calling flush doesn\'t yet have a DWPT, it\'s going to need to get one assigned to it, however the one assigned may not be the max ram consumer.  What\'ll we do then?  If the user explicitly called flush we can a) do nothing b) flush (the max ram consumer) thread\'s DWPT, however that gets hairy with wait notifies (almost like the global lock?).\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12979162_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979162_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Jan\\/11 17:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-08T17:35:18+0000\'\u003e08\\/Jan\\/11 17:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    And there\'s the case of the thread calling flush doesn\'t yet have a DWPT, it\'s going to need to get one assigned to it, however the one assigned may not be the max ram consumer.  What\'ll we do then?  If the user explicitly called flush we can a) do nothing b) flush (the max ram consumer) thread\'s DWPT, however that gets hairy with wait notifies (almost like the global lock?).              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12979189\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12979189&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12979189\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12979189_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979189_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Jan\\/11 19:45\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-08T19:45:02+0000\'\u003e08\\/Jan\\/11 19:45\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eThe proposed change is simply the thread calling add doc will flush it\'s DWPT if needed, take it offline while doing so, and return it when completed.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eWait &#8211; this is the \\\"addDocument\\\" case right?  (I thought we were still talking about the \\\"flush the world\\\" case...).\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eI think the risk is a new DWPT likely will have been created during flush, which\'d make the returning DWPT inutile?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eA new DWPT will have been created only if more than one thread is indexing docs right?  In which case this is fine?  Ie the old DWPT (just flushed) will just go back into rotation, and when another thread comes in it can take it?\u003c\\/p\u003e\\n\\n\u003cp\u003eBut, you\'re right: maybe we should sometimes \\\"prune\\\" DWPTs.  Or simply stop recycling any RAM, so that a just-flushed DWPT is an empty shell.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eHowever I think we may still need the global lock for close, eg, today we\'re preventing the user from adding docs during close, after this issue is merged that behavior would change?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eWell, the threads still adding docs will hit AlreadyClosedException?  (But, that\'s just \\\"best effort\\\").  The behavior of calling IW.close while other threads are still adding docs has never been defined (and, shouldn\'t be) except that we won\'t corrupt your index, and we\'ll get all docs indexed before .close was called, committed.  So I think even for this case we don\'t need a global lock.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12979189_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979189_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Jan\\/11 19:45\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-08T19:45:02+0000\'\u003e08\\/Jan\\/11 19:45\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     The proposed change is simply the thread calling add doc will flush it\'s DWPT if needed, take it offline while doing so, and return it when completed.  \\n\\n Wait &#8211; this is the \\\"addDocument\\\" case right?  (I thought we were still talking about the \\\"flush the world\\\" case...). \\n\\n  I think the risk is a new DWPT likely will have been created during flush, which\'d make the returning DWPT inutile?  \\n\\n A new DWPT will have been created only if more than one thread is indexing docs right?  In which case this is fine?  Ie the old DWPT (just flushed) will just go back into rotation, and when another thread comes in it can take it? \\n\\n But, you\'re right: maybe we should sometimes \\\"prune\\\" DWPTs.  Or simply stop recycling any RAM, so that a just-flushed DWPT is an empty shell. \\n\\n  However I think we may still need the global lock for close, eg, today we\'re preventing the user from adding docs during close, after this issue is merged that behavior would change?  \\n\\n Well, the threads still adding docs will hit AlreadyClosedException?  (But, that\'s just \\\"best effort\\\").  The behavior of calling IW.close while other threads are still adding docs has never been defined (and, shouldn\'t be) except that we won\'t corrupt your index, and we\'ll get all docs indexed before .close was called, committed.  So I think even for this case we don\'t need a global lock.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12979190\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12979190&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12979190\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12979190_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979190_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Jan\\/11 19:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-08T19:46:47+0000\'\u003e08\\/Jan\\/11 19:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eAnd there\'s the case of the thread calling flush doesn\'t yet have a DWPT, it\'s going to need to get one assigned to it, however the one assigned may not be the max ram consumer. What\'ll we do then? If the user explicitly called flush we can a) do nothing b) flush (the max ram consumer) thread\'s DWPT, however that gets hairy with wait notifies (almost like the global lock?).\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eWait &#8211; why would the thread calling flush need to have a DWPT assigned to it?  You\'re talking about the \\\"flush the world\\\" case?  (Ie the app calls IW.commit or IW.getReader).  In this case the thread just one by one pulls all DWPTs that have any indexed docs out of production, flushes them, clears them, and returns them to production?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12979190_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979190_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Jan\\/11 19:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-08T19:46:47+0000\'\u003e08\\/Jan\\/11 19:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n And there\'s the case of the thread calling flush doesn\'t yet have a DWPT, it\'s going to need to get one assigned to it, however the one assigned may not be the max ram consumer. What\'ll we do then? If the user explicitly called flush we can a) do nothing b) flush (the max ram consumer) thread\'s DWPT, however that gets hairy with wait notifies (almost like the global lock?).  \\n\\n Wait &#8211; why would the thread calling flush need to have a DWPT assigned to it?  You\'re talking about the \\\"flush the world\\\" case?  (Ie the app calls IW.commit or IW.getReader).  In this case the thread just one by one pulls all DWPTs that have any indexed docs out of production, flushes them, clears them, and returns them to production?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12979229\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12979229&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12979229\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12979229_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979229_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Jan\\/11 23:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-08T23:00:39+0000\'\u003e08\\/Jan\\/11 23:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003ethe \\\"flush the world\\\" case? (Ie the app calls IW.commit or\u003cbr\\/\u003e\\nIW.getReader). In this case the thread just one by one pulls all DWPTs that\u003cbr\\/\u003e\\nhave any indexed docs out of production, flushes them, clears them, and returns\u003cbr\\/\u003e\\nthem to production?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThe 2 cases are: A) Flush every DWPT sequentually (aka flush the world) and \u003cbr\\/\u003e\\nB) flush by RAM usage when adding docs or deleting. A is clear! I think with B\u003cbr\\/\u003e\\nwe\'re saying even if the calling thread is bound to DWPT #1, if DWPT #2 is\u003cbr\\/\u003e\\ngreater in size and the aggregate RAM usage exceeds the max, using the calling\u003cbr\\/\u003e\\nthread, we take DWPT #2 out of production, flush, and return it?\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eThe behavior of calling IW.close while other threads are still adding\u003cbr\\/\u003e\\ndocs has never been defined (and, shouldn\'t be) except that we won\'t corrupt\u003cbr\\/\u003e\\nyour index, and we\'ll get all docs indexed before .close was called, committed.\u003cbr\\/\u003e\\nSo I think even for this case we don\'t need a global lock.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eGreat, that simplifies and clarifies that we do not require a global lock.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eBut, you\'re right: maybe we should sometimes \\\"prune\\\" DWPTs. Or simply\u003cbr\\/\u003e\\nstop recycling any RAM, so that a just-flushed DWPT is an empty shell.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI\'m not sure how we\'d prune, typically object pools have a separate eviction\u003cbr\\/\u003e\\nthread, I think that\'s going overboard? Maybe we can simply throw out the DWPT\u003cbr\\/\u003e\\nand put recycling byte[]s and\\/or pooling DWPTs back in later if it\'s necessary?\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12979229_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979229_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Jan\\/11 23:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-08T23:00:39+0000\'\u003e08\\/Jan\\/11 23:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     the \\\"flush the world\\\" case? (Ie the app calls IW.commit or \\nIW.getReader). In this case the thread just one by one pulls all DWPTs that \\nhave any indexed docs out of production, flushes them, clears them, and returns \\nthem to production?  \\n\\n The 2 cases are: A) Flush every DWPT sequentually (aka flush the world) and  \\nB) flush by RAM usage when adding docs or deleting. A is clear! I think with B \\nwe\'re saying even if the calling thread is bound to DWPT #1, if DWPT #2 is \\ngreater in size and the aggregate RAM usage exceeds the max, using the calling \\nthread, we take DWPT #2 out of production, flush, and return it? \\n\\n  The behavior of calling IW.close while other threads are still adding \\ndocs has never been defined (and, shouldn\'t be) except that we won\'t corrupt \\nyour index, and we\'ll get all docs indexed before .close was called, committed. \\nSo I think even for this case we don\'t need a global lock.  \\n\\n Great, that simplifies and clarifies that we do not require a global lock. \\n\\n  But, you\'re right: maybe we should sometimes \\\"prune\\\" DWPTs. Or simply \\nstop recycling any RAM, so that a just-flushed DWPT is an empty shell.  \\n\\n I\'m not sure how we\'d prune, typically object pools have a separate eviction \\nthread, I think that\'s going overboard? Maybe we can simply throw out the DWPT \\nand put recycling byte[]s and\\/or pooling DWPTs back in later if it\'s necessary? \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12979243\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12979243&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12979243\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12979243_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979243_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Jan\\/11 00:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-09T00:53:45+0000\'\u003e09\\/Jan\\/11 00:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eTo further clarify, we also no longer have global aborts?  Each abort only applies to an individual DWPT?  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12979243_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979243_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Jan\\/11 00:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-09T00:53:45+0000\'\u003e09\\/Jan\\/11 00:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    To further clarify, we also no longer have global aborts?  Each abort only applies to an individual DWPT?                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12979247\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12979247&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12979247\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12979247_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979247_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Jan\\/11 01:22\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-09T01:22:58+0000\'\u003e09\\/Jan\\/11 01:22\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eI think the risk is a new DWPT likely will have been created during flush, which\'d make the returning DWPT inutile.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThe DWPT will not be removed from the pool, just marked as busy during flush, like as its state is busy (or currently called \\\"non-idle\\\" in the code) during addDocumentI().  So no new DWPT would be created during flush if the maxThreadState limit was already reached.\u003c\\/p\u003e\\n\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12979247_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979247_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Jan\\/11 01:22\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-09T01:22:58+0000\'\u003e09\\/Jan\\/11 01:22\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     I think the risk is a new DWPT likely will have been created during flush, which\'d make the returning DWPT inutile.  \\n\\n The DWPT will not be removed from the pool, just marked as busy during flush, like as its state is busy (or currently called \\\"non-idle\\\" in the code) during addDocumentI().  So no new DWPT would be created during flush if the maxThreadState limit was already reached. \\n\\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12979248\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12979248&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12979248\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12979248_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979248_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Jan\\/11 01:31\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-09T01:31:25+0000\'\u003e09\\/Jan\\/11 01:31\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eI think start simple - the addDocument always happens? Ie it\'s never coordinated w\\/ the ongoing flush. It picks a free DWPT like normal, and since flush is single threaded, there should always be a free DWPT?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYeah I agree.  The change I\'ll make then is to not have the global lock and return a DWPT immediately to the pool and set it to \'idle\' after its flush completed.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eI think we should continue what we do today? Ie, if it\'s an \'aborting\' exception, then the entire segment held by that DWPT is discarded? And we then throw this exc back to caller (and don\'t try to flush any other segments)?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eWhat I meant was the following situation: Suppose we have two DWPTs and IW.commit() is called.  The first DWPT finishes flushing successfully, is returned to the pool and idle again.  The second DWPT flush fails with an aborting exception.  Should the segment of the first DWPT make it into the index or not?  I think segment 1 shouldn\'t be committed, ie. a global flush should be all or nothing.  This means we would have to delay the commit of the segments until all DWPTs flushed successfully.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12979248_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979248_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Jan\\/11 01:31\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-09T01:31:25+0000\'\u003e09\\/Jan\\/11 01:31\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n I think start simple - the addDocument always happens? Ie it\'s never coordinated w\\/ the ongoing flush. It picks a free DWPT like normal, and since flush is single threaded, there should always be a free DWPT?  \\n\\n Yeah I agree.  The change I\'ll make then is to not have the global lock and return a DWPT immediately to the pool and set it to \'idle\' after its flush completed. \\n\\n \\n I think we should continue what we do today? Ie, if it\'s an \'aborting\' exception, then the entire segment held by that DWPT is discarded? And we then throw this exc back to caller (and don\'t try to flush any other segments)?  \\n\\n What I meant was the following situation: Suppose we have two DWPTs and IW.commit() is called.  The first DWPT finishes flushing successfully, is returned to the pool and idle again.  The second DWPT flush fails with an aborting exception.  Should the segment of the first DWPT make it into the index or not?  I think segment 1 shouldn\'t be committed, ie. a global flush should be all or nothing.  This means we would have to delay the commit of the segments until all DWPTs flushed successfully.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12979252\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12979252&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12979252\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12979252_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979252_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Jan\\/11 02:09\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-09T02:09:21+0000\'\u003e09\\/Jan\\/11 02:09\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eI think segment 1 shouldn\'t be committed, ie. a global flush should be all or nothing. This means we would have to delay the commit of the segments until all DWPTs flushed successfully.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eIf a DWPT aborts during flush, we simply throw an exception, however we still keep the successfully flushed segment(s).  If there\'s an abort on any DWPT during commit then we throw away any successfully flushed segments as well.  I think that makes sense, eg, all or nothing.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12979252_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979252_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Jan\\/11 02:09\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-09T02:09:21+0000\'\u003e09\\/Jan\\/11 02:09\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     I think segment 1 shouldn\'t be committed, ie. a global flush should be all or nothing. This means we would have to delay the commit of the segments until all DWPTs flushed successfully.  \\n\\n If a DWPT aborts during flush, we simply throw an exception, however we still keep the successfully flushed segment(s).  If there\'s an abort on any DWPT during commit then we throw away any successfully flushed segments as well.  I think that makes sense, eg, all or nothing.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12979308\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12979308&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12979308\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12979308_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979308_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Jan\\/11 12:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-09T12:00:57+0000\'\u003e09\\/Jan\\/11 12:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eI think with B\u003cbr\\/\u003e\\nwe\'re saying even if the calling thread is bound to DWPT #1, if DWPT #2 is\u003cbr\\/\u003e\\ngreater in size and the aggregate RAM usage exceeds the max, using the calling\u003cbr\\/\u003e\\nthread, we take DWPT #2 out of production, flush, and return it?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\u003cp\u003eRight &#8211; the thread affinity has nothing to do with which thread gets to flush which DWPT.  Once flush is triggered, the thread doing the flushing is free to flush any DWPT.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eMaybe we can simply throw out the DWPT\u003cbr\\/\u003e\\nand put recycling byte[]s and\\/or pooling DWPTs back in later if it\'s necessary?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eOK let\'s start there and put back re-use only if we see a real perf issue?\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eWhat I meant was the following situation: Suppose we have two DWPTs and IW.commit() is called. The first DWPT finishes flushing successfully, is returned to the pool and idle again. The second DWPT flush fails with an aborting exception. \u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eHmm, tricky.  I think I\'d lean towards keeping segment 1.  Discarding it would be inconsistent w\\/ aborts hit during the \\\"flushed by RAM\\\" case?  EG if seg 1 was flushed due to RAM usage, succeeds, and then later seg 2 is flushed due to RAM usage, but aborts.  In this case we would still keep seg 1?\u003c\\/p\u003e\\n\\n\u003cp\u003eI think aborting a flush should only lose the docs in that one DWPT (as it is today).\u003c\\/p\u003e\\n\\n\u003cp\u003eRemember, a call to commit may succeed in flushing seg 1 to disk, and updating the in-memory segment infos, but on hitting the aborting exc to seg 2, will throw that to the caller, not having committed \u003cb\u003eany\u003c\\/b\u003e change to the index.  Exceptions thrown during the prepareCommit (phase 1) part of commit mean nothing is changed in the index.\u003c\\/p\u003e\\n\\n\u003cp\u003eAlternatively... we could abort the entire IW session (as eg we handle OOME today) if ever an aborting exception was hit?  This might be cleaner?  But it\'s really a \\\"nuke the world\\\" option which scares me.  EG it could be a looong indexing session (app doesn\'t call commit() until the end) and we could be throwing away \u003cb\u003ealot\u003c\\/b\u003e of progress.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12979308_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979308_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Jan\\/11 12:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-09T12:00:57+0000\'\u003e09\\/Jan\\/11 12:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n I think with B \\nwe\'re saying even if the calling thread is bound to DWPT #1, if DWPT #2 is \\ngreater in size and the aggregate RAM usage exceeds the max, using the calling \\nthread, we take DWPT #2 out of production, flush, and return it?  \\n Right &#8211; the thread affinity has nothing to do with which thread gets to flush which DWPT.  Once flush is triggered, the thread doing the flushing is free to flush any DWPT. \\n\\n \\n Maybe we can simply throw out the DWPT \\nand put recycling byte[]s and\\/or pooling DWPTs back in later if it\'s necessary?  \\n\\n OK let\'s start there and put back re-use only if we see a real perf issue? \\n\\n  What I meant was the following situation: Suppose we have two DWPTs and IW.commit() is called. The first DWPT finishes flushing successfully, is returned to the pool and idle again. The second DWPT flush fails with an aborting exception.   \\n\\n Hmm, tricky.  I think I\'d lean towards keeping segment 1.  Discarding it would be inconsistent w\\/ aborts hit during the \\\"flushed by RAM\\\" case?  EG if seg 1 was flushed due to RAM usage, succeeds, and then later seg 2 is flushed due to RAM usage, but aborts.  In this case we would still keep seg 1? \\n\\n I think aborting a flush should only lose the docs in that one DWPT (as it is today). \\n\\n Remember, a call to commit may succeed in flushing seg 1 to disk, and updating the in-memory segment infos, but on hitting the aborting exc to seg 2, will throw that to the caller, not having committed  any  change to the index.  Exceptions thrown during the prepareCommit (phase 1) part of commit mean nothing is changed in the index. \\n\\n Alternatively... we could abort the entire IW session (as eg we handle OOME today) if ever an aborting exception was hit?  This might be cleaner?  But it\'s really a \\\"nuke the world\\\" option which scares me.  EG it could be a looong indexing session (app doesn\'t call commit() until the end) and we could be throwing away  alot  of progress.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12979382\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12979382&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12979382\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12979382_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979382_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Jan\\/11 18:01\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-09T18:01:07+0000\'\u003e09\\/Jan\\/11 18:01\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eOnce flush is triggered, the thread doing the flushing is free to flush any DWPT.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eOK.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eOK let\'s start there and put back re-use only if we see a real perf issue?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI think that\'s best.  Balancing RAM isn\'t implemented in the branch, we can\'t predict the future usage of DWPT(s) (which could languish consuming RAM with byte[]s well after they\'re flushed due to a sudden drop in the number of calling threads external to IW).\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eBut it\'s really a \\\"nuke the world\\\" option which scares me. EG it could be a looong indexing session (app doesn\'t call commit() until the end) and we could be throwing away alot of progress.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eRight.  Another option is to on commit try to flush all segments, meaning even if one DWPT\\/segment aborts, continue on with the other DWPTs (ie, a best effort).  Then perhaps throw an exception with a report of which segment flushes succeeded, or simply return a report object detailing what happened during commit (somewhat expert usage though).  Either way I think we need to give a few options to the user, then choose a default and see if it sticks.  The default should probably be \\\"best effort\\\".\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12979382_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979382_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Jan\\/11 18:01\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-09T18:01:07+0000\'\u003e09\\/Jan\\/11 18:01\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     Once flush is triggered, the thread doing the flushing is free to flush any DWPT.  \\n\\n OK. \\n\\n  OK let\'s start there and put back re-use only if we see a real perf issue?  \\n\\n I think that\'s best.  Balancing RAM isn\'t implemented in the branch, we can\'t predict the future usage of DWPT(s) (which could languish consuming RAM with byte[]s well after they\'re flushed due to a sudden drop in the number of calling threads external to IW). \\n\\n  But it\'s really a \\\"nuke the world\\\" option which scares me. EG it could be a looong indexing session (app doesn\'t call commit() until the end) and we could be throwing away alot of progress.  \\n\\n Right.  Another option is to on commit try to flush all segments, meaning even if one DWPT\\/segment aborts, continue on with the other DWPTs (ie, a best effort).  Then perhaps throw an exception with a report of which segment flushes succeeded, or simply return a report object detailing what happened during commit (somewhat expert usage though).  Either way I think we need to give a few options to the user, then choose a default and see if it sticks.  The default should probably be \\\"best effort\\\". \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12979558\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12979558&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12979558\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12979558_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979558_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Jan\\/11 12:06\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-10T12:06:07+0000\'\u003e10\\/Jan\\/11 12:06\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI think on commit if we hit an aborting exception flushing a given DWPT, we throw it then &amp; there.\u003c\\/p\u003e\\n\\n\u003cp\u003eAny segs already flushed remain flushed (but not committed).  Any segs not yet flushed remain not yet flushed...\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12979558_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979558_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Jan\\/11 12:06\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-10T12:06:07+0000\'\u003e10\\/Jan\\/11 12:06\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I think on commit if we hit an aborting exception flushing a given DWPT, we throw it then &amp; there. \\n\\n Any segs already flushed remain flushed (but not committed).  Any segs not yet flushed remain not yet flushed...              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12979625\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12979625&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12979625\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12979625_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979625_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Jan\\/11 16:26\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-10T16:26:12+0000\'\u003e10\\/Jan\\/11 16:26\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eAny segs already flushed remain flushed (but not committed). Any segs not yet flushed remain not yet flushed...\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eIf the segment are flushed, then they will be deleted?  Or they will be made available in a subsequent and completely successful commit?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12979625_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979625_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Jan\\/11 16:26\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-10T16:26:12+0000\'\u003e10\\/Jan\\/11 16:26\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     Any segs already flushed remain flushed (but not committed). Any segs not yet flushed remain not yet flushed...  \\n\\n If the segment are flushed, then they will be deleted?  Or they will be made available in a subsequent and completely successful commit?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12979649\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12979649&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12979649\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12979649_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979649_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Jan\\/11 17:10\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-10T17:10:15+0000\'\u003e10\\/Jan\\/11 17:10\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eLonger term c) would be great, or, if IW has an ES then it\'d send multiple flush jobs to the ES.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eLost in abbreviations \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e - Can you remind me what \'ES\' is?\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eBut, you\'re right: maybe we should sometimes \\\"prune\\\" DWPTs. Or simply stop recycling any RAM, so that a just-flushed DWPT is an empty shell.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI\'m not sure I understand what the problem here with recycling RAM is.  Could someone elaborate?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12979649_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979649_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Jan\\/11 17:10\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-10T17:10:15+0000\'\u003e10\\/Jan\\/11 17:10\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     Longer term c) would be great, or, if IW has an ES then it\'d send multiple flush jobs to the ES.  \\n\\n Lost in abbreviations   - Can you remind me what \'ES\' is? \\n\\n  But, you\'re right: maybe we should sometimes \\\"prune\\\" DWPTs. Or simply stop recycling any RAM, so that a just-flushed DWPT is an empty shell.  \\n\\n I\'m not sure I understand what the problem here with recycling RAM is.  Could someone elaborate?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12979654\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12979654&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12979654\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12979654_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979654_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Jan\\/11 17:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-10T17:16:16+0000\'\u003e10\\/Jan\\/11 17:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eI think aborting a flush should only lose the docs in that one DWPT (as it is today).\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYeah I\'m convinced now I don\'t want the \\\"nuke the world\\\" approach.  Btw, Mike, you\'re very good with giving things intuitive names \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n\\n\\n\u003cblockquote\u003e\u003cp\u003eI think on commit if we hit an aborting exception flushing a given DWPT, we throw it then &amp; there.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYes sounds good.\u003c\\/p\u003e\\n\\n\\n\u003cblockquote\u003e\\n\u003cblockquote\u003e\u003cp\u003eAny segs already flushed remain flushed (but not committed). Any segs not yet flushed remain not yet flushed...\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eIf the segment are flushed, then they will be deleted? Or they will be made available in a subsequent and completely successful commit?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThe aborting exception might be thrown due to a disk-full situation.  This can be fixed and commit() called again, which then would flush the remaining DWPTs and commit all flushed segments.\u003cbr\\/\u003e\\nOtherwise, those flushed segments will be orphaned and deleted sometime later by a different IW because they don\'t belong to any SegmentInfos.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12979654_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979654_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Jan\\/11 17:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-10T17:16:16+0000\'\u003e10\\/Jan\\/11 17:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     I think aborting a flush should only lose the docs in that one DWPT (as it is today).  \\n\\n Yeah I\'m convinced now I don\'t want the \\\"nuke the world\\\" approach.  Btw, Mike, you\'re very good with giving things intuitive names   \\n\\n\\n  I think on commit if we hit an aborting exception flushing a given DWPT, we throw it then &amp; there.  \\n\\n Yes sounds good. \\n\\n\\n \\n  Any segs already flushed remain flushed (but not committed). Any segs not yet flushed remain not yet flushed...  \\n\\n If the segment are flushed, then they will be deleted? Or they will be made available in a subsequent and completely successful commit?  \\n\\n The aborting exception might be thrown due to a disk-full situation.  This can be fixed and commit() called again, which then would flush the remaining DWPTs and commit all flushed segments. \\nOtherwise, those flushed segments will be orphaned and deleted sometime later by a different IW because they don\'t belong to any SegmentInfos.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12979655\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12979655&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12979655\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12979655_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979655_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Jan\\/11 17:17\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-10T17:17:21+0000\'\u003e10\\/Jan\\/11 17:17\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eLost in abbreviations  - Can you remind me what \'ES\' is?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI read it as ExecutorService, ie, a thread pool.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eI\'m not sure I understand what the problem here with recycling RAM is. Could someone elaborate?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eMainly that we could have DWPT(s) lying around unused, consuming \u003cspan class=\\\"error\\\"\u003e&#91;recycled&#93;\u003c\\/span\u003e RAM, eg, from a sudden drop in the number of incoming threads after a flush.  This is a drop the code, and put it back in if that was a bad idea solution.\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12979655_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979655_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Jan\\/11 17:17\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-10T17:17:21+0000\'\u003e10\\/Jan\\/11 17:17\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     Lost in abbreviations  - Can you remind me what \'ES\' is?  \\n\\n I read it as ExecutorService, ie, a thread pool. \\n\\n  I\'m not sure I understand what the problem here with recycling RAM is. Could someone elaborate?  \\n\\n Mainly that we could have DWPT(s) lying around unused, consuming  &#91;recycled&#93;  RAM, eg, from a sudden drop in the number of incoming threads after a flush.  This is a drop the code, and put it back in if that was a bad idea solution. \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12979671\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12979671&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12979671\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12979671_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979671_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Jan\\/11 18:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-10T18:16:29+0000\'\u003e10\\/Jan\\/11 18:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eMainly that we could have DWPT(s) lying around unused, consuming \u003cspan class=\\\"error\\\"\u003e&#91;recycled&#93;\u003c\\/span\u003e RAM, eg, from a sudden drop in the number of incoming threads after a flush. This is a drop the code, and put it back in if that was a bad idea solution.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eAh thanks, got it.  \u003c\\/p\u003e\\n\\n\\n\u003cblockquote\u003e\u003cp\u003eOr simply stop recycling any RAM, so that a just-flushed DWPT is an empty shell.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003e+1\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12979671_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979671_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Jan\\/11 18:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-10T18:16:29+0000\'\u003e10\\/Jan\\/11 18:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n Mainly that we could have DWPT(s) lying around unused, consuming  &#91;recycled&#93;  RAM, eg, from a sudden drop in the number of incoming threads after a flush. This is a drop the code, and put it back in if that was a bad idea solution.  \\n\\n Ah thanks, got it.   \\n\\n\\n  Or simply stop recycling any RAM, so that a just-flushed DWPT is an empty shell.  \\n\\n +1              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12979713\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12979713&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12979713\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12979713_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979713_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Jan\\/11 19:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-10T19:50:11+0000\'\u003e10\\/Jan\\/11 19:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cblockquote\u003e\u003cp\u003eLost in abbreviations - Can you remind me what \'ES\' is?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI read it as ExecutorService, ie, a thread pool.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYes, sorry that\'s what I meant.\u003c\\/p\u003e\\n\\n\u003cp\u003eIe someday IW can take an ES too and farm things out to it when it could make use of concurrency (like flush the world).  But that\'s for later &lt;\\/dream&gt;.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12979713_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12979713_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Jan\\/11 19:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-10T19:50:11+0000\'\u003e10\\/Jan\\/11 19:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n  Lost in abbreviations - Can you remind me what \'ES\' is?  \\n\\n I read it as ExecutorService, ie, a thread pool.  \\n\\n Yes, sorry that\'s what I meant. \\n\\n Ie someday IW can take an ES too and farm things out to it when it could make use of concurrency (like flush the world).  But that\'s for later &lt;\\/dream&gt;.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12981192\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12981192&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12981192\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12981192_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12981192_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Jan\\/11 09:33\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-13T09:33:36+0000\'\u003e13\\/Jan\\/11 09:33\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI made some progress with the concurrency model, especially removing the need for various locks to make everything easier.\u003c\\/p\u003e\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eDocumentsWriterPerThreadPool.ThreadState now extends ReentrantLock, which means that standard methods like lock() and unlock() can be used to reserve a DWPT for a task.\u003c\\/li\u003e\\n\\t\u003cli\u003eThe max. number of DWPTs allowed (config.maxThreadStates) is instantiated up-front.  Creating a DWPT is cheap, so this is not a performance concern; this makes it easier to push config changes to the DWPTs without synchronizing on the pool and without having to worry about newly created DWPTs getting the same config settings.\u003c\\/li\u003e\\n\\t\u003cli\u003eDocumentsWriterPerThreadPool.getActivePerThreadsIterator() gives the caller a static snapshot of the active DWPTs at the time the iterator was acquired, e.g. for flushAllThreads() or DW.abort().  Here synchronizing on the pool isn\'t necessary either.\u003c\\/li\u003e\\n\\t\u003cli\u003edeletes are now pushed to DW.pendingDeletes() if no active DWPTs are present.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eTODOs:\u003c\\/p\u003e\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003efix remaining testcases that still fail\u003c\\/li\u003e\\n\\t\u003cli\u003efix RAM tracking and flush-by-RAM\u003c\\/li\u003e\\n\\t\u003cli\u003ewrite new testcases to test thread pool, thread assignment, etc\u003c\\/li\u003e\\n\\t\u003cli\u003ereview if all cases that were discussed in the recent comments here work as expected (likely not \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e )\u003c\\/li\u003e\\n\\t\u003cli\u003eperformance testing and code cleanup\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12981192_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12981192_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Jan\\/11 09:33\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-13T09:33:36+0000\'\u003e13\\/Jan\\/11 09:33\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I made some progress with the concurrency model, especially removing the need for various locks to make everything easier. \\n\\n \\n\\t DocumentsWriterPerThreadPool.ThreadState now extends ReentrantLock, which means that standard methods like lock() and unlock() can be used to reserve a DWPT for a task. \\n\\t The max. number of DWPTs allowed (config.maxThreadStates) is instantiated up-front.  Creating a DWPT is cheap, so this is not a performance concern; this makes it easier to push config changes to the DWPTs without synchronizing on the pool and without having to worry about newly created DWPTs getting the same config settings. \\n\\t DocumentsWriterPerThreadPool.getActivePerThreadsIterator() gives the caller a static snapshot of the active DWPTs at the time the iterator was acquired, e.g. for flushAllThreads() or DW.abort().  Here synchronizing on the pool isn\'t necessary either. \\n\\t deletes are now pushed to DW.pendingDeletes() if no active DWPTs are present. \\n \\n\\n\\n TODOs: \\n \\n\\t fix remaining testcases that still fail \\n\\t fix RAM tracking and flush-by-RAM \\n\\t write new testcases to test thread pool, thread assignment, etc \\n\\t review if all cases that were discussed in the recent comments here work as expected (likely not   ) \\n\\t performance testing and code cleanup \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12981305\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12981305&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12981305\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12981305_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12981305_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Jan\\/11 16:06\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-13T16:06:23+0000\'\u003e13\\/Jan\\/11 16:06\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eDocumentsWriterPerThreadPool.ThreadState now extends ReentrantLock, which means that standard methods like lock() and unlock() can be used to reserve a DWPT for a task.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eReally?  That makes synchronized seem simpler?\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003ethe max. number of DWPTs allowed (config.maxThreadStates) is instantiated up-front. \u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eWhat about the memory used, eg, the non-use of byte[] recycling?  I guess it\'ll be cleared on flush.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003efix RAM tracking and flush-by-RAM\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI created a BytesUsed object that cascades the changes to parent BytesUsed objects, this allows each individual SD, DWPT, DW, etc to keep track of their bytes used, while also propagating the changes to the higher level objects, eg, SD -&gt; DWPT, DWPT -&gt; DW.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jasonrutherglen\\\" id=\\\"commentauthor_12981305_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jasonrutherglen\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jasonrutherglen\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Jason Rutherglen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12981305_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Jan\\/11 16:06\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-13T16:06:23+0000\'\u003e13\\/Jan\\/11 16:06\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     DocumentsWriterPerThreadPool.ThreadState now extends ReentrantLock, which means that standard methods like lock() and unlock() can be used to reserve a DWPT for a task.  \\n\\n Really?  That makes synchronized seem simpler? \\n\\n  the max. number of DWPTs allowed (config.maxThreadStates) is instantiated up-front.   \\n\\n What about the memory used, eg, the non-use of byte[] recycling?  I guess it\'ll be cleared on flush. \\n\\n  fix RAM tracking and flush-by-RAM  \\n\\n I created a BytesUsed object that cascades the changes to parent BytesUsed objects, this allows each individual SD, DWPT, DW, etc to keep track of their bytes used, while also propagating the changes to the higher level objects, eg, SD -&gt; DWPT, DWPT -&gt; DW.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12981380\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12981380&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12981380\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12981380_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12981380_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Jan\\/11 17:21\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-13T17:21:22+0000\'\u003e13\\/Jan\\/11 17:21\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eReally?  That makes synchronized seem simpler?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eWell look at ThreadAffinityDocumentsWriterThreadPool.  There I\'m able to use things like tryLock() and getQueueLength().\u003cbr\\/\u003e\\nAlso DocumentsWriterPerThreadPool has a getAndLock() method, that can be used by DW for addDocument(), whereas DW.flush(), which needs to iterate the DWPTs, can lock the individual DWPTs directly.  I think it\'s simpler, but I\'m open to other suggestions of course \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n\\n\\n\u003cblockquote\u003e\u003cp\u003eWhat about the memory used, eg, the non-use of byte[] recycling? I guess it\'ll be cleared on flush.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYeah, sure.  That is independent on whether they\'re all created upfront or not.  But yeah, after flush or abort we need to clear the DWPT\'s state to make sure they\'re not consuming unused RAM (as you described in your earlier comment).\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12981380_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12981380_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Jan\\/11 17:21\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-13T17:21:22+0000\'\u003e13\\/Jan\\/11 17:21\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     Really?  That makes synchronized seem simpler?  \\n\\n Well look at ThreadAffinityDocumentsWriterThreadPool.  There I\'m able to use things like tryLock() and getQueueLength(). \\nAlso DocumentsWriterPerThreadPool has a getAndLock() method, that can be used by DW for addDocument(), whereas DW.flush(), which needs to iterate the DWPTs, can lock the individual DWPTs directly.  I think it\'s simpler, but I\'m open to other suggestions of course   \\n\\n\\n  What about the memory used, eg, the non-use of byte[] recycling? I guess it\'ll be cleared on flush.  \\n\\n Yeah, sure.  That is independent on whether they\'re all created upfront or not.  But yeah, after flush or abort we need to clear the DWPT\'s state to make sure they\'re not consuming unused RAM (as you described in your earlier comment).              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12981388\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-2324?focusedCommentId=12981388&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12981388\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"earwin\\\" id=\\\"commentauthor_12981388_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=earwin\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"earwin\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Earwin Burrfoot\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12981388_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Jan\\/11 17:36\'\u003e\u003ctime class=\'livestamp\' datetime=\'2011-01-13T17:36:46+0000\'\u003e13\\/Jan\\/11 17:36\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eMaan, this comment list is infinite.\u003cbr\\/\u003e\\nHow do I currently get the ..er.. current version? Latest branch + latest Jason\'s patch?\u003c\\/p\u003e\\n\\n\u003cp\u003eRegardless of everything else, I\'d ask you not to extend random things \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e at least if you can\'t say is-a about them.\u003cbr\\/\u003e\\nDocumentsWriterPerThreadPool.ThreadState IS A ReentrantLock? No. So you\'re better off encapsulating it rather than extending.\u003cbr\\/\u003e\\nSame can be applied to SegmentInfos that extends Vector :\\/\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"earwin\\\" id=\\\"commentauthor_12981388_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=earwin\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"earwin\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Earwin Burrfoot\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12981388_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\</script>
 </body>
</html>