<!doctype html>
<html lang="en">
 <head> 
  <meta charset="utf-8"> 
  <meta http-equiv="X-UA-Compatible" content="IE=Edge"> 
  <meta name="application-name" content="JIRA" data-name="jira" data-version="7.6.3">
  <meta name="ajs-viewissue-use-history-api" content="false"> 
  <meta name="ajs-jira-base-url" content="https://issues.apache.org/jira"> 
  <meta name="ajs-serverRenderedViewIssue" content="true"> 
  <meta name="ajs-dev-mode" content="false"> 
  <meta name="ajs-context-path" content="/jira"> 
  <meta name="ajs-version-number" content="7.6.3"> 
  <meta name="ajs-build-number" content="76005"> 
  <meta name="ajs-is-beta" content="false"> 
  <meta name="ajs-is-rc" content="false"> 
  <meta name="ajs-is-snapshot" content="false"> 
  <meta name="ajs-is-milestone" content="false"> 
  <meta name="ajs-remote-user" content=""> 
  <meta name="ajs-remote-user-fullname" content=""> 
  <meta name="ajs-user-locale" content="en_UK"> 
  <meta name="ajs-user-locale-group-separator" content=","> 
  <meta name="ajs-app-title" content="ASF JIRA"> 
  <meta name="ajs-keyboard-shortcuts-enabled" content="true"> 
  <meta name="ajs-keyboard-accesskey-modifier" content="Ctrl+Alt"> 
  <meta name="ajs-enabled-dark-features" content="[&quot;com.atlassian.jira.agile.darkfeature.editable.detailsview&quot;,&quot;nps.survey.inline.dialog&quot;,&quot;com.atlassian.jira.agile.darkfeature.edit.closed.sprint.enabled&quot;,&quot;jira.plugin.devstatus.phasetwo&quot;,&quot;jira.frother.reporter.field&quot;,&quot;atlassian.rest.xsrf.legacy.enabled&quot;,&quot;jira.issue.status.lozenge&quot;,&quot;com.atlassian.jira.config.BIG_PIPE&quot;,&quot;com.atlassian.jira.projects.issuenavigator&quot;,&quot;com.atlassian.jira.config.PDL&quot;,&quot;jira.plugin.devstatus.phasetwo.enabled&quot;,&quot;atlassian.aui.raphael.disabled&quot;,&quot;app-switcher.new&quot;,&quot;frother.assignee.field&quot;,&quot;com.atlassian.jira.projects.ProjectCentricNavigation.Switch&quot;,&quot;sd.internal.base.off.thread.on.completion.events.enabled&quot;,&quot;jira.onboarding.cyoa&quot;,&quot;com.atlassian.jira.agile.darkfeature.kanplan.enabled&quot;,&quot;sd.slavalue.record.updated.date.enabled&quot;,&quot;com.atlassian.jira.config.ProjectConfig.MENU&quot;,&quot;com.atlassian.jira.projects.sidebar.DEFER_RESOURCES&quot;,&quot;com.atlassian.jira.agile.darkfeature.kanplan.epics.and.versions.enabled&quot;,&quot;com.atlassian.jira.agile.darkfeature.sprint.goal.enabled&quot;,&quot;jira.zdu.admin-updates-ui&quot;,&quot;jira.zdu.jmx-monitoring&quot;,&quot;sd.sla.improved.rendering.enabled&quot;,&quot;sd.canned.responses.enabled&quot;,&quot;sd.new.settings.sidebar.location.disabled&quot;,&quot;jira.zdu.cluster-upgrade-state&quot;,&quot;com.atlassian.jira.agile.darkfeature.splitissue&quot;,&quot;com.atlassian.jira.config.CoreFeatures.LICENSE_ROLES_ENABLED&quot;,&quot;com.atlassian.feedback.feedback-button-move-to-header-enable&quot;,&quot;jira.export.csv.enabled&quot;]"> 
  <meta name="ajs-in-admin-mode" content="false"> 
  <meta name="ajs-is-sysadmin" content="false"> 
  <meta name="ajs-is-admin" content="false"> 
  <meta name="ajs-outgoing-mail-enabled" content="true"> 
  <meta name="ajs-date-relativize" content="true"> 
  <meta name="ajs-date-time" content="HH:mm"> 
  <meta name="ajs-date-day" content="EEEE HH:mm"> 
  <meta name="ajs-date-dmy" content="dd/MMM/yy"> 
  <meta name="ajs-date-complete" content="dd/MMM/yy HH:mm"> 
  <script type="text/javascript">var AJS=AJS||{};AJS.debug=true;</script> 
  <meta id="atlassian-token" name="atlassian-token" content="A5KQ-2QAV-T4JA-FDED|ca370d5fa71034b54823c58fdbb193e29df9b361|lout"> 
  <link rel="shortcut icon" href="/jira/s/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/_/favicon.ico"> 
  <!--[if IE]><![endif]--> 
  <script type="text/javascript">
    (function() {
        var contextPath = '/jira';
        var eventBuffer = [];

        function printDeprecatedMsg() {
            if (console && console.warn) {
                console.warn('DEPRECATED JS - contextPath global variable has been deprecated since 7.4.0. Use `wrm/context-path` module instead.');
            }
        }

        function sendEvent(analytics, postfix) {
            analytics.send({
                name: 'js.globals.contextPath.' + postfix
            });
        }

        function sendDeprecatedEvent(postfix) {
            try {
                var analytics = require('jira/analytics');
                if (eventBuffer.length) {
                    eventBuffer.forEach(function(value) {
                        sendEvent(analytics, value);
                    });
                    eventBuffer = [];
                }

                if (postfix) {
                    sendEvent(analytics, postfix);
                }
            } catch(ex) {
                eventBuffer.push(postfix);
                setTimeout(sendDeprecatedEvent, 1000);
            }
        }

        Object.defineProperty(window, 'contextPath', {
            get: function() {
                printDeprecatedMsg();
                sendDeprecatedEvent('get');
                return contextPath;
            },
            set: function(value) {
                printDeprecatedMsg();
                sendDeprecatedEvent('set');
                contextPath = value;
            }
        });
    })();

</script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-plugin:context-path.context-path"]="\"/jira\"";
WRM._unparsedData["jira.webresources:feature-flags.feature-flag-data"]="{\"enabled-feature-keys\":[\"com.atlassian.jira.agile.darkfeature.editable.detailsview\",\"nps.survey.inline.dialog\",\"com.atlassian.jira.agile.darkfeature.edit.closed.sprint.enabled\",\"jira.plugin.devstatus.phasetwo\",\"jira.frother.reporter.field\",\"atlassian.rest.xsrf.legacy.enabled\",\"jira.issue.status.lozenge\",\"com.atlassian.jira.config.BIG_PIPE\",\"com.atlassian.jira.projects.issuenavigator\",\"com.atlassian.jira.config.PDL\",\"jira.plugin.devstatus.phasetwo.enabled\",\"atlassian.aui.raphael.disabled\",\"app-switcher.new\",\"frother.assignee.field\",\"com.atlassian.jira.projects.ProjectCentricNavigation.Switch\",\"sd.internal.base.off.thread.on.completion.events.enabled\",\"jira.onboarding.cyoa\",\"com.atlassian.jira.agile.darkfeature.kanplan.enabled\",\"sd.slavalue.record.updated.date.enabled\",\"com.atlassian.jira.config.ProjectConfig.MENU\",\"com.atlassian.jira.projects.sidebar.DEFER_RESOURCES\",\"com.atlassian.jira.agile.darkfeature.kanplan.epics.and.versions.enabled\",\"com.atlassian.jira.agile.darkfeature.sprint.goal.enabled\",\"jira.zdu.admin-updates-ui\",\"jira.zdu.jmx-monitoring\",\"sd.sla.improved.rendering.enabled\",\"sd.canned.responses.enabled\",\"sd.new.settings.sidebar.location.disabled\",\"jira.zdu.cluster-upgrade-state\",\"com.atlassian.jira.agile.darkfeature.splitissue\",\"com.atlassian.jira.config.CoreFeatures.LICENSE_ROLES_ENABLED\",\"com.atlassian.feedback.feedback-button-move-to-header-enable\",\"jira.export.csv.enabled\"],\"feature-flag-states\":{\"sd.customer.profile.multi.languages\":true,\"sd.customer.portal.transitions\":true,\"sd.customer.portal.transitions.config\":true,\"sd.custom.email.stripping.rules\":false,\"sd.sla.lucene.issue.id.callback.performance\":true,\"sd.new.settings.sidebar.location\":true,\"sd.workload.report.paginator\":true,\"sd.experimental.portal.search.algorithm.default.1\":false,\"sd.customer.portal.help.center.agent.announcement\":true,\"sd.sla.improved.rendering\":false,\"sd.experimental.portal.search.algorithm.default.2\":false,\"sd.customer.feedback.validate.reporter.on.token\":true,\"sd.custom.email.notifications.utf8.csat.star\":true,\"sd.who.create.customers.by.email.setting\":true,\"com.atlassian.jira.issuetable.move.links.hidden\":true,\"jira.renderer.consider.variable.format\":true,\"sd.stats.event.tracking\":true,\"sd.password.helper.dialog\":true,\"sd.canned.responses\":false,\"sd.portal.help.center.customer.signup.secondary.email\":true,\"sd.custom.email.notifications.manage.language\":true,\"sd.use.search.by.permissions\":true,\"sd.slavalue.record.updated.date\":false,\"sd.report.custom.date.range\":false,\"sd.kb.article.helpfulness.report\":false,\"com.atlassian.jira.agile.darkfeature.sprint.goal\":false,\"sd.custom.email.notifications.styling\":true,\"sd.workinghours.new.page.bulldog.1\":false,\"sd.customer.portal.two.step.login\":false,\"sd.automation.psmq.async.executor\":true,\"sd.customer.org.list.page.lazy.search\":true,\"sd.approval.requested.when.handler\":true,\"sd.request.type.field.rest.api.filtering.bugfix\":true,\"sd.automation.then.action.auto.answer.approval\":true,\"com.atlassian.jira.agile.darkfeature.kanplan.epics.and.versions\":false,\"sla.will.only.be.paused.if.they.are.already.started\":true,\"sd.kb.comment.share.stats.collection\":true,\"com.atlassian.jira.upgrade.startup.fix.index\":true,\"sd.customer.orgs.group.participants\":true,\"sd.portal.help.center.customer.signup\":true,\"sd.sla.agent.jql.security.restricted\":true,\"sd.test.feature.flag.x\":true,\"sd.test.feature.flag.y\":false,\"sd.cluster.safe.mail.channel.shutdown\":true,\"sd.email.channel.folders\":false,\"sd.email.analytics.open\":false,\"sd.kb.project.creation.create.link.space\":true,\"sd.workinghours.new.page\":false,\"sd.confluence.anonymous.permission.fix\":true,\"com.atlassian.jira.issuetable.draggable\":true,\"sd.customer.portal.project.agent.announcement\":true,\"sd.automation.audit.log\":true,\"jira.jql.suggestrecentfields\":false,\"sd.canned.responses.check.index.startup\":false,\"sd.new.project.templates\":true,\"sd.custom.email.notifications.custom.rules.simple.ui\":false,\"sd.custom.email.notifications.cut.over\":true,\"sd.dismiss.all.misconfiguration.warnings.setting\":true,\"com.atlassian.jira.agile.darkfeature.optimistic.transitions\":true,\"sd.sla.configurations.export\":true,\"sd.canned.responses.variable.substitution\":true,\"com.atlassian.jira.agile.darkfeature.kanplan\":false,\"sd.internal.base.off.thread.on.completion.events\":false,\"sd.customer.portal.prioties.per.project.fix\":true,\"jira.instrumentation.laas\":false,\"sd.kb.self.service.report\":false,\"sla.improved.request.handling\":true,\"sd.no.schedule.async.upgrade.tasks\":true,\"sd.kb.primary.nav\":true,\"com.atlassian.jira.agile.darkfeature.edit.closed.sprint\":false,\"sd.kb.issueview.panel.phase2\":true,\"sd.email.outsider.comments\":true,\"jira.create.linked.issue\":true,\"sd.kb.issueview.panel\":true,\"jira.sal.host.connect.accessor.existing.transaction.will.create.transactions\":true,\"sd.approvals.light.weight\":false,\"sd.automation.then.webhook\":true,\"sd.respect.inline.edit.issue.off\":true,\"jira.jql.smartautoselectfirst\":false,\"sd.global.portal.search.atlassian.only.tracking\":false,\"sd.automation.if.condition.comment.primary.action\":true,\"jira.priorities.per.project\":true,\"sd.inline.noformat.renderer\":true,\"sd.customer.request.type.create.edit.screens\":true}}";
WRM._unparsedData["jira.webresources:default-comment-security-level.DefaultCommentSecurityLevelHelpLink"]="{\"extraClasses\":\"default-comment-level-help\",\"title\":\"Commenting on an Issue\",\"url\":\"https://docs.atlassian.com/jira/jcore-docs-076/Editing+and+collaborating+on+issues#Editingandcollaboratingonissues-restrictacomment\",\"isLocal\":false}";
WRM._unparsedData["jira.webresources:dateFormatProvider.allFormats"]="{\"dateFormats\":{\"meridiem\":[\"AM\",\"PM\"],\"eras\":[\"BC\",\"AD\"],\"months\":[\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],\"monthsShort\":[\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"],\"weekdaysShort\":[\"Sun\",\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\",\"Sat\"],\"weekdays\":[\"Sunday\",\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\",\"Saturday\"]},\"lookAndFeelFormats\":{\"relativize\":\"true\",\"time\":\"HH:mm\",\"day\":\"EEEE HH:mm\",\"dmy\":\"dd/MMM/yy\",\"complete\":\"dd/MMM/yy HH:mm\"}}";
WRM._unparsedData["com.atlassian.jira.jira-issue-nav-components:issueviewer.features"]="{\"rteEnabled\":true}";
WRM._unparsedData["com.atlassian.jira.plugins.jira-dnd-attachment-plugin:dnd-issue-drop-zone.thumbnail-mime-types"]="\"image/png,image/vnd.wap.wbmp,image/x-png,image/jpeg,image/bmp,image/gif\"";
WRM._unparsedData["com.atlassian.jira.plugins.jira-dnd-attachment-plugin:dnd-issue-drop-zone.upload-limit"]="\"62914560\"";
WRM._unparsedData["com.atlassian.plugins.helptips.jira-help-tips:help-tip-manager.JiraHelpTipData"]="{\"anonymous\":true}";
WRM._unparsedData["com.atlassian.jira.jira-view-issue-plugin:controller-subtasks.controller.subtasks.parameters"]="{\"url\":\"/rest/api/2/issue/{issueId}/subtask/move\"}";
WRM._unparsedData["com.atlassian.analytics.analytics-client:policy-update-init.policy-update-data-provider"]="false";
WRM._unparsedData["com.atlassian.analytics.analytics-client:programmatic-analytics-init.programmatic-analytics-data-provider"]="false";
WRM._unparsedData["com.atlassian.servicedesk.servicedesk-canned-responses-plugin:canned-responses-data-provider.data"]="{\"substitutionVariables\":{\"issue.summary\":\"Issue summary\",\"issue.description\":\"Issue description\",\"issue.key\":\"Issue key\",\"issue.reporter.name\":\"Issue reporter\",\"issue.resolution\":\"Issue resolution\",\"request.url\":\"Request URL\",\"request.status\":\"Request status\"}}";
WRM._unparsedData["jira.webresources:avatar-picker.data"]="{}";
WRM._unparsedData["com.atlassian.feedback.jira-feedback-plugin:button-resources-init.data"]="{\"jira.feedback.plugin.issue.collector.core\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-UK&collectorId=abbf546d\",\"jira.feedback.plugin.issue.collector.default\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-UK&collectorId=abbf546d\",\"jira.feedback.plugin.issue.collector.service.desk\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?locale=en-UK&collectorId=a698db21\",\"jira.feedback.plugin.issue.collector.software\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-UK&collectorId=abbf546d\",\"isHeaderFeedbackButtonEnabled\":true}";
WRM._unparsedData["com.atlassian.jira.jira-header-plugin:dismissedFlags.flags"]="{\"dismissed\":[]}";
WRM._unparsedData["com.atlassian.jira.jira-header-plugin:newsletter-signup-tip-init.newsletterSignup"]="{\"signupDescription\":\"Get updates, inspiration and best practices from the team behind JIRA.\",\"formUrl\":\"https://www.atlassian.com/apis/exact-target/{0}/subscribe?mailingListId=1401671\",\"signupTitle\":\"Sign up!\",\"signupId\":\"newsletter-signup-tip\",\"showNewsletterTip\":false}";
WRM._unparsedData["com.atlassian.jira.project-templates-plugin:project-templates-plugin-resources.ptAnalyticsData"]="{\"instanceCreatedDate\":\"2011-01-31\"}";
WRM._unparsedData["com.atlassian.servicedesk.core-ui:util-help-links.help-links"]="{\"help\":{\"email.settings\":\"https://docs.atlassian.com/jira/jsd-docs-039/Receiving+requests+by+email\",\"managing.queues\":\"https://docs.atlassian.com/jira/jsd-docs-039/Setting+up+queues+for+your+team\",\"email.setup\":\"https://docs.atlassian.com/jira/jsd-docs-039/Receiving+requests+by+email\",\"request.settings.help.bubble\":\"https://docs.atlassian.com/jira/jsd-docs-039/Managing+access+to+your+service+desk\",\"email.settings.suitablerequest\":\"https://docs.atlassian.com/jira/jsd-docs-039/Receiving+requests+by+email#Receivingrequestsbyemail-suitablerequest\",\"sla.import.help\":\"https://docs.atlassian.com/jira/jsd-docs-039/Importing+SLAs\",\"documentation.home\":\"https://docs.atlassian.com/jira/jsd-docs-039/JIRA+Service+Desk+Documentation\",\"default\":\"https://docs.atlassian.com/jira/jsd-docs-039/\",\"create.space.help\":\"https://docs.atlassian.com/jira/jsd-docs-039/Serving+customers+with+a+knowledge+base#serving-customers-with-a-knowledge-base-createpermission\",\"email.settings.troubleshooting\":\"https://docs.atlassian.com/jira/jsd-docs-039/Troubleshooting+issues+with+the+email+channel\",\"admin.notifications.config\":\"https://docs.atlassian.com/jira/jsd-docs-039/Managing+service+desk+notifications\",\"troubleshoot.requesttype\":\"https://docs.atlassian.com/jira/jsd-docs-039/Troubleshooting+issues+with+request+types\",\"approvals.configuration\":\"https://docs.atlassian.com/jira/jsd-docs-039/Configuring+JIRA+Service+Desk+approvals\",\"setting.up.reports\":\"https://docs.atlassian.com/jira/jsd-docs-039/Setting+up+service+desk+reports\",\"public.signup\":\"https://docs.atlassian.com/jira/jsd-docs-039/Configuring+public+signup\",\"knowledge.base\":\"https://docs.atlassian.com/jira/jsd-docs-039/Serving+customers+with+a+knowledge+base\",\"resolve.permission.scheme.errors\":\"https://docs.atlassian.com/jira/jsd-docs-039/Resolving+permission+scheme+errors\",\"getting.started\":\"https://docs.atlassian.com/jira/jsd-docs-039/Getting+started+with+JIRA+Service+Desk\",\"getting.started.agent\":\"https://docs.atlassian.com/jira/jsd-docs-039/Getting+started+for+service+desk+agents\",\"invite.customers\":\"https://docs.atlassian.com/jira/jsd-docs-039/Managing+access+to+your+service+desk\"},\"kb\":{\"default\":\"https://confluence.atlassian.com/display/SDKB/\",\"troubleshooting.user.management.issues\":\"https://confluence.atlassian.com/display/SDKB/Troubleshooting+issues+with+service+desk+user+management\",\"legacytransition\":\"https://confluence.atlassian.com/display/SDKB/Replacing+legacy+automatic+transitions+with+automation+rules\",\"umtroubleshoot\":\"https://confluence.atlassian.com/display/SDKB/Troubleshooting+issues+with+service+desk+user+management\"}}";
WRM._unparsedData["com.atlassian.servicedesk.core-ui:util-base-url.base-url"]="\"https://issues.apache.org/jira\"";
WRM._unparsedData["com.atlassian.jira.plugins.jira-wiki-editor:wiki-editor-resources.help-data"]="{\"showHelp\":true,\"editorDocumentationUrl\":[\"https://docs.atlassian.com/jira/jcore-docs-076/Visual+editing\"],\"editorDocumentationTitle\":[\"Show me documentation for the visual editor\"]}";
WRM._unparsedData["com.atlassian.jira.plugins.jira-wiki-editor:wiki-editor-resources.thumbnails-allowed"]="false";
WRM._unparsedData["jira.webresources:user-message-flags.adminLockout"]="{}";
WRM._unparsedData["jira.request.correlation-id"]="\"49626a815083dd\"";
WRM._unparsedData["project-id"]="12310110";
WRM._unparsedData["project-key"]="\"LUCENE\"";
WRM._unparsedData["project-name"]="\"Lucene - Core\"";
WRM._unparsedData["project-type"]="\"software\"";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:generic-filters"]="[{\"id\":\"allissues\",\"jql\":\"project = \\\"{0}\\\" ORDER BY {1}\",\"defaultOrderby\":\"created DESC\",\"label\":\"All issues\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[]},{\"id\":\"allopenissues\",\"jql\":\"project = \\\"{0}\\\" AND resolution = Unresolved ORDER BY {1}\",\"defaultOrderby\":\"priority DESC, updated DESC\",\"label\":\"Open issues\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"resolution\"]},{\"id\":\"doneissues\",\"jql\":\"project = \\\"{0}\\\" AND statusCategory = Done ORDER BY {1}\",\"defaultOrderby\":\"updated DESC\",\"label\":\"Done issues\",\"requiresUser\":false,\"supportsInlineIssueCreate\":false,\"fields\":[\"status\"]},{\"id\":\"recentlyviewed\",\"jql\":\"project = \\\"{0}\\\" AND issuekey in issueHistory() ORDER BY {1}\",\"defaultOrderby\":\"lastViewed DESC\",\"label\":\"Viewed recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"issuekey\"]},{\"id\":\"addedrecently\",\"jql\":\"project = \\\"{0}\\\" AND created \u003e= -1w ORDER BY {1}\",\"defaultOrderby\":\"created DESC\",\"label\":\"Created recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"created\"]},{\"id\":\"resolvedrecently\",\"jql\":\"project = \\\"{0}\\\" AND resolutiondate \u003e= -1w ORDER BY {1}\",\"defaultOrderby\":\"updated DESC\",\"label\":\"Resolved recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":false,\"fields\":[\"resolutiondate\"]},{\"id\":\"updatedrecently\",\"jql\":\"project = \\\"{0}\\\" AND updated \u003e= -1w ORDER BY {1}\",\"defaultOrderby\":\"updated DESC\",\"label\":\"Updated recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"updated\"]}]";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:default-filter-priority"]="[\"allopenissues\",\"allissues\"]";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:can-manage-filters"]="false";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:project-filters"]="[]";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:can-create-issues"]="false";
WRM._unparsedData["projectId"]="12310110";
WRM._unparsedData["projectKey"]="\"LUCENE\"";
WRM._unparsedData["projectType"]="\"software\"";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:server-rendered"]="true";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <link type="text/css" rel="stylesheet" href="/jira/s/a8a4711bc3f2eb261d8c8fd9fbcbba8b-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/1fca1750044f2777c977e8d8cc023344/_/download/contextbatch/css/_super/batch.css" data-wrm-key="_super" data-wrm-batch-type="context" media="all"> 
  <link type="text/css" rel="stylesheet" href="/jira/s/1a6b21131945f6f49ff48336b49ca3fe-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/37a6e594cbbfd462a8a54d5aa11475c1/_/download/contextbatch/css/project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super/batch.css?agile_global_admin_condition=true&amp;hc-enabled=true&amp;is-server-instance=true&amp;jag=true&amp;jira.create.linked.issue=true&amp;nps-acknowledged=true&amp;richediton=true&amp;sd_operational=true" data-wrm-key="project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super" data-wrm-batch-type="context" media="all"> 
  <link type="text/css" rel="stylesheet" href="/jira/s/611672383f6cab00ab202241ba6f9d68-T/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/7.6.3/_/download/batch/com.atlassian.feedback.jira-feedback-plugin:button-resources-init/com.atlassian.feedback.jira-feedback-plugin:button-resources-init.css" data-wrm-key="com.atlassian.feedback.jira-feedback-plugin:button-resources-init" data-wrm-batch-type="resource" media="all"> 
  <script type="text/javascript" src="/jira/s/d8484c9183f546511a8e336a8779bcd9-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/1fca1750044f2777c977e8d8cc023344/_/download/contextbatch/js/_super/batch.js?locale=en-UK" data-wrm-key="_super" data-wrm-batch-type="context" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d3b35d835f8f46fc3b53bb4db7f85158-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/37a6e594cbbfd462a8a54d5aa11475c1/_/download/contextbatch/js/project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super/batch.js?agile_global_admin_condition=true&amp;hc-enabled=true&amp;is-server-instance=true&amp;jag=true&amp;jira.create.linked.issue=true&amp;locale=en-UK&amp;nps-acknowledged=true&amp;richediton=true&amp;sd_operational=true" data-wrm-key="project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super" data-wrm-batch-type="context" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/71d42e74136d842a3ef4d5d136484843-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/871d45c9f322a22cb3aa9b7948a69803/_/download/contextbatch/js/atl.global,-_super/batch.js?locale=en-UK" data-wrm-key="atl.global,-_super" data-wrm-batch-type="context" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:calendar-en/jira.webresources:calendar-en.js" data-wrm-key="jira.webresources:calendar-en" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:calendar-localisation-moment/jira.webresources:calendar-localisation-moment.js" data-wrm-key="jira.webresources:calendar-localisation-moment" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/7.6.3/_/download/batch/com.atlassian.feedback.jira-feedback-plugin:button-resources/com.atlassian.feedback.jira-feedback-plugin:button-resources.js" data-wrm-key="com.atlassian.feedback.jira-feedback-plugin:button-resources" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <link type="text/css" rel="stylesheet" href="/jira/s/95a4826c265852f4904f1e0e7300df68-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/e0de73613a1027de08f3da6a45e1d1a2/_/download/contextbatch/css/jira.global.look-and-feel,-_super/batch.css" data-wrm-key="jira.global.look-and-feel,-_super" data-wrm-batch-type="context" media="all"> 
  <script type="text/javascript" src="/jira/rest/api/1.0/shortcuts/76005/944bb39eced1b35cfc7194aa02eb5a5a/shortcuts.js?context=issuenavigation&amp;context=issueaction"></script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["com.atlassian.jira.jira-issue-nav-components:inline-edit-enabled"]="true";
WRM._unparsedData["should-display-chaperone"]="false";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <link type="text/css" rel="stylesheet" href="/jira/s/15712b600e9aecf72ffd9fd3704a0c78-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/6b22a15c7b83f87a47b1757076f43542/_/download/contextbatch/css/com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue/batch.css?jira.create.linked.issue=true&amp;richediton=true&amp;sd_operational=true" data-wrm-key="com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue" data-wrm-batch-type="context" media="all"> 
  <script type="text/javascript" src="/jira/s/5a8f0f8b8aa8f96a4f0f7e9e248d62f3-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/6b22a15c7b83f87a47b1757076f43542/_/download/contextbatch/js/com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue/batch.js?jira.create.linked.issue=true&amp;locale=en-UK&amp;richediton=true&amp;sd_operational=true" data-wrm-key="com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue" data-wrm-batch-type="context" data-initially-rendered></script> 
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
  <meta name="ajs-can-search-users" content="false"> 
  <meta name="ajs-can-edit-watchers" content="false"> 
  <meta name="ajs-default-avatar-url" content="https://issues.apache.org/jira/secure/useravatar?size=xsmall&amp;avatarId=10453"> 
  <meta name="ajs-issue-project-type" content="software"> 
  <meta name="ajs-issue-key" content="LUCENE-743"> 
  <meta name="ajs-server-view-issue-is-editable" content="false"> 
  <title>[LUCENE-743] IndexReader.reopen() - ASF JIRA</title> 
  <link rel="search" type="application/opensearchdescription+xml" href="/jira/osd.jsp" title="[LUCENE-743] IndexReader.reopen() - ASF JIRA"> 
 </head> 
 <body id="jira" class="aui-layout aui-theme-default " data-version="7.6.3"> 
  <div id="page"> 
   <header id="header" role="banner"> 
    <script>
require(["jquery", "jira/license-banner"], function ($, licenseBanner) {
    $(function () {
        licenseBanner.showLicenseBanner("");
        licenseBanner.showLicenseFlag("");
    });
});
</script> 
    <nav class="aui-header aui-dropdown2-trigger-group" role="navigation">
     <div class="aui-header-inner">
      <div class="aui-header-before">
       <a class=" aui-dropdown2-trigger app-switcher-trigger" aria-controls="app-switcher" aria-haspopup="true" role="button" tabindex="0" data-aui-trigger href="#app-switcher"><span class="aui-icon aui-icon-small aui-iconfont-appswitcher">Linked Applications</span></a>
       <div id="app-switcher" class="aui-dropdown2 aui-style-default" role="menu" aria-hidden="true" data-is-switcher="true" data-environment="{&quot;isUserAdmin&quot;:false,&quot;isAppSuggestionAvailable&quot;:false,&quot;isSiteAdminUser&quot;:false}">
        <div role="application">
         <div class="app-switcher-loading">
          Loadingâ€¦
         </div>
        </div>
       </div>
      </div>
      <div class="aui-header-primary">
       <h1 id="logo" class="aui-header-logo aui-header-logo-custom"><a href="https://issues.apache.org/jira/secure/MyJiraHome.jspa"><img src="/jira/s/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/_/jira-logo-scaled.png" alt="ASF JIRA"></a></h1>
       <ul class="aui-nav">
        <li><a href="/jira/secure/Dashboard.jspa" class=" aui-nav-link aui-dropdown2-trigger aui-dropdown2-ajax" id="home_link" aria-haspopup="true" aria-controls="home_link-content" title="View and manage your dashboards" accesskey="d">Dashboards</a>
         <div class="aui-dropdown2 aui-style-default" id="home_link-content" data-aui-dropdown2-ajax-key="home_link"></div></li>
        <li><a href="/jira/browse/LUCENE" class=" aui-nav-link aui-dropdown2-trigger aui-dropdown2-ajax" id="browse_link" aria-haspopup="true" aria-controls="browse_link-content" title="View recent projects and browse a list of projects" accesskey="p">Projects</a>
         <div class="aui-dropdown2 aui-style-default" id="browse_link-content" data-aui-dropdown2-ajax-key="browse_link"></div></li>
        <li><a href="/jira/issues/" class=" aui-nav-link aui-dropdown2-trigger aui-dropdown2-ajax" id="find_link" aria-haspopup="true" aria-controls="find_link-content" title="Search for issues and view recent issues" accesskey="i">Issues</a>
         <div class="aui-dropdown2 aui-style-default" id="find_link-content" data-aui-dropdown2-ajax-key="find_link"></div></li> 
       </ul>
      </div>
      <div class="aui-header-secondary">
       <ul class="aui-nav">
        <li id="quicksearch-menu"> 
         <form action="/jira/secure/QuickSearch.jspa" method="get" id="quicksearch" class="aui-quicksearch dont-default-focus ajs-dirty-warning-exempt"> 
          <input id="quickSearchInput" class="search" type="text" title="Search" placeholder="Search" name="searchString" accessKey="q"> 
          <input type="submit" class="hidden" value="Search"> 
         </form> </li> 
        <li><a class="jira-feedback-plugin" role="button" aria-haspopup="true" id="jira-header-feedback-link" href="#"><span class="aui-icon aui-icon-small jira-feedback-plugin-icon">Give feedback to Atlassian</span></a></li> 
        <li id="system-help-menu"> <a class="aui-nav-link aui-dropdown2-trigger" id="help_menu" aria-haspopup="true" aria-owns="system-help-menu-content" href="https://docs.atlassian.com/jira/jcore-docs-076/" target="$textUtils.htmlEncode($rootHelpMenuItem.params.target)" title="Help"><span class="aui-icon aui-icon-small aui-iconfont-help">Help</span></a> 
         <div id="system-help-menu-content" class="aui-dropdown2 aui-style-default"> 
          <div class="aui-dropdown2-section"> 
           <ul id="jira-help" class="aui-list-truncate"> 
            <li> <a id="view_core_help" class="aui-nav-link " title="Go to the online documentation for JIRA Core" href="https://docs.atlassian.com/jira/jcore-docs-076/" target="_blank">JIRA Core help</a> </li> 
            <li> <a id="keyshortscuthelp" class="aui-nav-link " title="Get more information about JIRA's Keyboard Shortcuts" href="/jira/secure/ViewKeyboardShortcuts!default.jspa" target="_blank">Keyboard Shortcuts</a> </li> 
            <li> <a id="view_about" class="aui-nav-link " title="Get more information about JIRA" href="/jira/secure/AboutPage.jspa">About JIRA</a> </li> 
            <li> <a id="view_credits" class="aui-nav-link " title="See who did what" href="/jira/secure/JiraCreditsPage!default.jspa" target="_blank">JIRA Credits</a> </li> 
           </ul> 
          </div> 
         </div> </li> 
        <li id="user-options"> <a class="aui-nav-link login-link" href="/jira/login.jsp?os_destination=%2Fbrowse%2FLUCENE-743">Log In</a> 
         <div id="user-options-content" class="aui-dropdown2 aui-style-default"> 
          <div class="aui-dropdown2-section"> 
          </div> 
         </div> </li> 
       </ul>
      </div>
     </div>
     <!-- .aui-header-inner-->
    </nav>
    <!-- .aui-header --> 
   </header> 
   <section id="content" role="main"> 
    <big-pipe data-id="sidebar-id" unresolved></big-pipe>
    <div class="aui-sidebar  sidebar-placeholder">
     <div class="aui-sidebar-wrapper">
      <div class="aui-sidebar-body"></div>
      <div class="aui-sidebar-footer">
       <a class="aui-button aui-button-subtle aui-sidebar-toggle aui-sidebar-footer-tipsy" data-tooltip="Expand sidebar ( [ )" href="#"><span class="aui-icon aui-icon-small"></span></a>
      </div>
     </div>
    </div>
    <script id="projects-sidebar-init">
    require(['jira/projects/sidebar/expansion-manager'], function(expansionManager) {
        var scriptTag = document.getElementById('projects-sidebar-init');
        var sidebar = AJS.sidebar('.aui-sidebar');
        expansionManager(sidebar);
        scriptTag.parentElement.removeChild(scriptTag);
    });
    </script>
    <div class="aui-page-panel">
     <div class="aui-page-panel-inner">
      <div class="issue-navigator">
       <div class="content">
        <div class="issue-view">
         <div class="navigation-tools">
          <div class="pager-container"></div>
         </div>
         <div class="issue-container">
          <div id="issue-content" class="issue-edit-form">
           <header id="stalker" class="issue-header js-stalker">
            <div class="issue-header-content">
             <header class="aui-page-header">
              <div class="aui-page-header-inner">
               <div class="aui-page-header-image">
                <span id="12310110" class="aui-avatar aui-avatar-large aui-avatar-project"><span class="aui-avatar-inner"><img id="project-avatar" alt="Uploaded image for project: 'Lucene - Core'" src="https://issues.apache.org/jira/secure/projectavatar?pid=12310110&amp;avatarId=10061"></span></span>
               </div>
               <!-- .aui-page-header-image -->
               <div class="aui-page-header-main">
                <ol class="aui-nav aui-nav-breadcrumbs">
                 <li><a id="project-name-val" href="/jira/browse/LUCENE">Lucene - Core</a></li>
                 <li><a class="issue-link" data-issue-key="LUCENE-743" href="/jira/browse/LUCENE-743" id="key-val" rel="12358344">LUCENE-743</a></li>
                </ol>
                <h1 id="summary-val">IndexReader.reopen()</h1>
               </div>
               <!-- .aui-page-header-main -->
               <div class="aui-page-header-actions">
                <div id="issue-header-pager"></div>
               </div>
               <!-- .aui-page-header-actions -->
              </div>
              <!-- .aui-page-header-inner -->
             </header>
             <!-- .aui-page-header -->
             <div class="command-bar">
              <div class="ops-cont">
               <div class="ops-menus aui-toolbar">
                <div class="toolbar-split toolbar-split-left">
                 <ul id="opsbar-ops-login-lnk_container" class="toolbar-group pluggable-ops">
                  <li class="toolbar-item"><a id="ops-login-lnk" title="Log In" class="toolbar-trigger" href="/jira/login.jsp?os_destination=%2Fbrowse%2FLUCENE-743"><span class="trigger-label">Log In</span></a></li>
                 </ul>
                 <ul id="opsbar-opsbar-operations" class="toolbar-group pluggable-ops"></ul>
                 <ul id="opsbar-opsbar-transitions" class="toolbar-group pluggable-ops"></ul>
                 <ul id="opsbar-opsbar-admin" class="toolbar-group pluggable-ops"></ul>
                </div>
                <div class="toolbar-split toolbar-split-right">
                 <ul id="opsbar-jira.issue.tools" class="toolbar-group pluggable-ops">
                  <li class="toolbar-item">
                   <div>
                    <a href="#" id="viewissue-export" aria-owns="viewissue-export_drop" aria-haspopup="true" title="Export this issue in another format" class="toolbar-trigger aui-button aui-style-default aui-dropdown2-trigger"><span class="icon icon-default aui-icon aui-icon-small aui-iconfont-export"></span> <span class="dropdown-text">Export</span></a>
                    <div id="viewissue-export_drop" class="aui-style-default aui-dropdown2">
                     <ul>
                      <li class="aui-list-item"><a href="/jira/si/jira.issueviews:issue-xml/LUCENE-743/LUCENE-743.xml" id="jira.issueviews:issue-xml"><span class="trigger-label">XML</span></a></li>
                      <li class="aui-list-item"><a href="/jira/si/jira.issueviews:issue-word/LUCENE-743/LUCENE-743.doc" id="jira.issueviews:issue-word"><span class="trigger-label">Word</span></a></li>
                      <li class="aui-list-item"><a href="/jira/si/jira.issueviews:issue-html/LUCENE-743/LUCENE-743.html" id="jira.issueviews:issue-html"><span class="trigger-label">Printable</span></a></li>
                      <li class="aui-list-item"><a href="/jira/si/com.atlassian.jira.plugins.jira-importers-plugin:issue-json/LUCENE-743/LUCENE-743.json" id="com.atlassian.jira.plugins.jira-importers-plugin:issue-json"><span class="trigger-label">JSON</span></a></li>
                     </ul>
                    </div>
                   </div></li>
                 </ul>
                </div>
               </div>
              </div>
             </div>
            </div>
           </header>
           <div class="issue-body-content">
            <div class="aui-group issue-body">
             <div class="aui-item issue-main-column">
              <div id="details-module" class="module toggle-wrap">
               <div id="details-module_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Details</h2>
               </div>
               <div class="mod-content"> 
                <ul id="issuedetails" class="property-list two-cols"> 
                 <li class="item"> 
                  <div class="wrap"> 
                   <strong class="name">Type:</strong> 
                   <span id="type-val" class="value"> <img alt="" height="16" src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21140&amp;avatarType=issuetype" title="Improvement - An improvement or enhancement to an existing feature or task." width="16"> Improvement </span> 
                  </div> </li> 
                 <li class="item item-right"> 
                  <div class="wrap"> 
                   <strong class="name">Status:</strong> 
                   <span id="status-val" class="value"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done jira-issue-status-lozenge-max-width-medium" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Closed</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.</span>">Closed</span> </span> 
                  </div> </li> 
                 <li class="item new"> 
                  <div class="wrap"> 
                   <strong class="name">Priority:</strong> 
                   <span id="priority-val" class="value"> <img alt="" height="16" src="/jira/images/icons/priorities/minor.svg" title="Minor - Minor loss of function, or other problem where easy workaround is present." width="16"> Minor </span> 
                  </div> </li> 
                 <li class="item item-right"> 
                  <div class="wrap"> 
                   <strong class="name">Resolution:</strong> 
                   <span id="resolution-val" class="value resolved"> Fixed </span> 
                  </div> </li> 
                 <li class="item"> 
                  <div class="wrap"> 
                   <strong class="name">Affects Version/s:</strong> 
                   <span id="versions-val" class="value"> None </span> 
                  </div> </li> 
                 <li class="item item-right"> 
                  <div class="wrap"> 
                   <strong class="name">Fix Version/s:</strong> 
                   <span id="fixfor-val" class="value"> <span class="shorten" id="fixVersions-field"> <a href="/jira/issues/?jql=project+%3D+LUCENE+AND+fixVersion+%3D+2.3" title="2.3 ">2.3</a> </span> </span> 
                  </div> </li> 
                 <li class="item"> 
                  <div class="wrap"> 
                   <strong class="name">Component/s:</strong> 
                   <span id="components-val" class="value"> <span class="shorten" id="components-field"> <a href="/jira/issues/?jql=project+%3D+LUCENE+AND+component+%3D+%22core%2Findex%22" title="core/index issues with indexing code">core/index</a> </span> </span> 
                  </div> </li> 
                 <li class="item full-width"> 
                  <div class="wrap" id="wrap-labels"> 
                   <strong class="name">Labels:</strong> 
                   <div class="labels-wrap value"> 
                    <span class="labels" id="labels-12358344-value">None</span> 
                   </div> 
                  </div> </li> 
                </ul> 
                <div id="customfieldmodule"> 
                 <div class="aui-tabs horizontal-tabs" id="customfield-tabs"> 
                  <div id="customfield-panel-1" class="tabs-pane active-pane"> 
                   <ul class="property-list"> 
                    <li id="rowForcustomfield_12310120" class="item"> 
                     <div class="wrap"> 
                      <strong title="Lucene Fields" class="name">Lucene Fields:</strong> 
                      <div id="customfield_12310120-val" class="value type-multicheckboxes" data-fieldtype="multicheckboxes" data-fieldtypecompletekey="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes"> 
                       <div class="shorten" id="customfield_12310120-field"> 
                        <span>Patch Available</span> 
                       </div> 
                      </div> 
                     </div> </li> 
                   </ul> 
                  </div> 
                 </div>
                </div> 
               </div>
              </div>
              <div id="descriptionmodule" class="module toggle-wrap">
               <div id="descriptionmodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Description</h2>
               </div>
               <div class="mod-content">
                <div id="description-val" class="field-ignore-highlight"> 
                 <div class="user-content-block"> 
                  <p>This is Robert Engels' implementation of IndexReader.reopen() functionality, as a set of 3 new classes (this was easier for him to implement, but should probably be folded into the core, if this looks good).</p> 
                 </div> 
                </div> 
               </div>
              </div>
              <div id="dnd-metadata" class="module toggle-wrap">
               <div id="dnd-metadata_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Attachments</h2>
               </div>
               <div class="mod-content">
                <div id="dnd-metadata-webpanel" data-can-attach="false" data-project-type="software" data-upload-limit="62914560" data-thumbnails-allowed="false"></div>
               </div>
              </div>
              <div id="attachmentmodule" class="module toggle-wrap">
               <div id="attachmentmodule_heading" class="mod-header">
                <ul class="ops">
                 <li class="drop">
                  <div class="aui-dd-parent">
                   <a href="#" class="icon drop-menu js-default-dropdown" title="Options"><span>Options</span></a>
                   <div class="aui-dropdown-content aui-list">
                    <ul id="attachment-sorting-options" class="aui-list-section aui-first">
                     <li class="aui-list-item"><a id="attachment-sort-key-name" href="/jira/browse/LUCENE-743?attachmentSortBy=fileName#attachmentmodule" class="aui-list-checked aui-checked aui-list-item-link" title="viewissue.subtasks.tab.show.all.name"><span>Sort By Name</span></a></li>
                     <li class="aui-list-item"><a id="attachment-sort-key-date" href="/jira/browse/LUCENE-743?attachmentSortBy=dateTime#attachmentmodule" class="aui-list-checked aui-list-item-link" title="Sort By Date"><span>Sort By Date</span></a></li>
                    </ul>
                    <ul id="attachment-sorting-order-options" class="aui-list-section aui-last">
                     <li class="aui-list-item"><a id="attachment-sort-direction-asc" href="/jira/browse/LUCENE-743?attachmentOrder=asc#attachmentmodule" class="aui-list-checked aui-checked aui-list-item-link" title="Ascending"><span>Ascending</span></a></li>
                     <li class="aui-list-item"><a id="attachment-sort-direction-desc" href="/jira/browse/LUCENE-743?attachmentOrder=desc#attachmentmodule" class="aui-list-checked aui-list-item-link" title="Descending"><span>Descending</span></a></li>
                    </ul>
                   </div>
                  </div></li>
                </ul>
                <h2 class="toggle-title">Attachments</h2>
               </div>
               <div class="mod-content">
                <ol id="file_attachments" class="item-attachments" data-sort-key="fileName" data-sort-order="asc">
                 <li class="attachment-content js-file-attachment" data-attachment-id="12346947" data-issue-id="12358344" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12346947/IndexReaderUtils.java" draggable="true" data-downloadurl="text/x-java:IndexReaderUtils.java:https://issues.apache.org/jira/secure/attachment/12346947/IndexReaderUtils.java"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-file-code" title="Java Source File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12346947/IndexReaderUtils.java" title="Latest  11/Dec/06 22:47 - Otis Gospodnetic" draggable="true" data-downloadurl="text/x-java:IndexReaderUtils.java:https://issues.apache.org/jira/secure/attachment/12346947/IndexReaderUtils.java">IndexReaderUtils.java</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2006-12-11T22:47:20.000Z">11/Dec/06 22:47</time>
                   </dd>
                   <dd class="attachment-size">
                    5 kB
                   </dd>
                   <dd class="attachment-author">
                    Otis Gospodnetic
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12363001" data-issue-id="12358344" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12363001/lucene-743.patch" draggable="true" data-downloadurl="text/x-patch:lucene-743.patch:https://issues.apache.org/jira/secure/attachment/12363001/lucene-743.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12363001/lucene-743.patch" title="Latest  01/Aug/07 21:41 - Michael Busch" draggable="true" data-downloadurl="text/x-patch:lucene-743.patch:https://issues.apache.org/jira/secure/attachment/12363001/lucene-743.patch">lucene-743.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-08-01T21:41:08.346Z">01/Aug/07 21:41</time>
                   </dd>
                   <dd class="attachment-size">
                    28 kB
                   </dd>
                   <dd class="attachment-author">
                    Michael Busch
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12362275" data-issue-id="12358344" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12362275/lucene-743.patch" draggable="true" data-downloadurl="text/x-patch:lucene-743.patch:https://issues.apache.org/jira/secure/attachment/12362275/lucene-743.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12362275/lucene-743.patch" title=" 21/Jul/07 01:46 - Hoss Man" draggable="true" data-downloadurl="text/x-patch:lucene-743.patch:https://issues.apache.org/jira/secure/attachment/12362275/lucene-743.patch">lucene-743.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-07-21T01:46:39.532Z">21/Jul/07 01:46</time>
                   </dd>
                   <dd class="attachment-size">
                    24 kB
                   </dd>
                   <dd class="attachment-author">
                    Hoss Man
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12362199" data-issue-id="12358344" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12362199/lucene-743.patch" draggable="true" data-downloadurl="text/x-patch:lucene-743.patch:https://issues.apache.org/jira/secure/attachment/12362199/lucene-743.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12362199/lucene-743.patch" title=" 20/Jul/07 07:13 - Michael Busch" draggable="true" data-downloadurl="text/x-patch:lucene-743.patch:https://issues.apache.org/jira/secure/attachment/12362199/lucene-743.patch">lucene-743.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-07-20T07:13:33.884Z">20/Jul/07 07:13</time>
                   </dd>
                   <dd class="attachment-size">
                    21 kB
                   </dd>
                   <dd class="attachment-author">
                    Michael Busch
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12369730" data-issue-id="12358344" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12369730/lucene-743-take10.patch" draggable="true" data-downloadurl="text/x-patch:lucene-743-take10.patch:https://issues.apache.org/jira/secure/attachment/12369730/lucene-743-take10.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12369730/lucene-743-take10.patch" title="Latest  17/Nov/07 20:44 - Michael Busch" draggable="true" data-downloadurl="text/x-patch:lucene-743-take10.patch:https://issues.apache.org/jira/secure/attachment/12369730/lucene-743-take10.patch">lucene-743-take10.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-11-17T20:44:04.688Z">17/Nov/07 20:44</time>
                   </dd>
                   <dd class="attachment-size">
                    80 kB
                   </dd>
                   <dd class="attachment-author">
                    Michael Busch
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12366883" data-issue-id="12358344" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12366883/lucene-743-take2.patch" draggable="true" data-downloadurl="text/x-patch:lucene-743-take2.patch:https://issues.apache.org/jira/secure/attachment/12366883/lucene-743-take2.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12366883/lucene-743-take2.patch" title="Latest  02/Oct/07 06:24 - Michael Busch" draggable="true" data-downloadurl="text/x-patch:lucene-743-take2.patch:https://issues.apache.org/jira/secure/attachment/12366883/lucene-743-take2.patch">lucene-743-take2.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-10-02T06:24:21.643Z">02/Oct/07 06:24</time>
                   </dd>
                   <dd class="attachment-size">
                    52 kB
                   </dd>
                   <dd class="attachment-author">
                    Michael Busch
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12368626" data-issue-id="12358344" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12368626/lucene-743-take3.patch" draggable="true" data-downloadurl="text/x-patch:lucene-743-take3.patch:https://issues.apache.org/jira/secure/attachment/12368626/lucene-743-take3.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12368626/lucene-743-take3.patch" title="Latest  29/Oct/07 20:53 - Michael Busch" draggable="true" data-downloadurl="text/x-patch:lucene-743-take3.patch:https://issues.apache.org/jira/secure/attachment/12368626/lucene-743-take3.patch">lucene-743-take3.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-10-29T20:53:24.213Z">29/Oct/07 20:53</time>
                   </dd>
                   <dd class="attachment-size">
                    54 kB
                   </dd>
                   <dd class="attachment-author">
                    Michael Busch
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12368741" data-issue-id="12358344" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12368741/lucene-743-take4.patch" draggable="true" data-downloadurl="text/plain:lucene-743-take4.patch:https://issues.apache.org/jira/secure/attachment/12368741/lucene-743-take4.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-file-txt" title="Text File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12368741/lucene-743-take4.patch" title="Latest  31/Oct/07 07:02 - Michael Busch" draggable="true" data-downloadurl="text/plain:lucene-743-take4.patch:https://issues.apache.org/jira/secure/attachment/12368741/lucene-743-take4.patch">lucene-743-take4.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-10-31T07:02:27.517Z">31/Oct/07 07:02</time>
                   </dd>
                   <dd class="attachment-size">
                    59 kB
                   </dd>
                   <dd class="attachment-author">
                    Michael Busch
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12368868" data-issue-id="12358344" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12368868/lucene-743-take5.patch" draggable="true" data-downloadurl="text/x-patch:lucene-743-take5.patch:https://issues.apache.org/jira/secure/attachment/12368868/lucene-743-take5.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12368868/lucene-743-take5.patch" title="Latest  02/Nov/07 09:53 - Michael Busch" draggable="true" data-downloadurl="text/x-patch:lucene-743-take5.patch:https://issues.apache.org/jira/secure/attachment/12368868/lucene-743-take5.patch">lucene-743-take5.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-11-02T09:53:06.896Z">02/Nov/07 09:53</time>
                   </dd>
                   <dd class="attachment-size">
                    62 kB
                   </dd>
                   <dd class="attachment-author">
                    Michael Busch
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12369287" data-issue-id="12358344" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12369287/lucene-743-take6.patch" draggable="true" data-downloadurl="text/x-patch:lucene-743-take6.patch:https://issues.apache.org/jira/secure/attachment/12369287/lucene-743-take6.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12369287/lucene-743-take6.patch" title="Latest  10/Nov/07 06:47 - Michael Busch" draggable="true" data-downloadurl="text/x-patch:lucene-743-take6.patch:https://issues.apache.org/jira/secure/attachment/12369287/lucene-743-take6.patch">lucene-743-take6.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-11-10T06:47:42.164Z">10/Nov/07 06:47</time>
                   </dd>
                   <dd class="attachment-size">
                    76 kB
                   </dd>
                   <dd class="attachment-author">
                    Michael Busch
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12369359" data-issue-id="12358344" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12369359/lucene-743-take7.patch" draggable="true" data-downloadurl="text/x-patch:lucene-743-take7.patch:https://issues.apache.org/jira/secure/attachment/12369359/lucene-743-take7.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12369359/lucene-743-take7.patch" title="Latest  12/Nov/07 10:28 - Michael Busch" draggable="true" data-downloadurl="text/x-patch:lucene-743-take7.patch:https://issues.apache.org/jira/secure/attachment/12369359/lucene-743-take7.patch">lucene-743-take7.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-11-12T10:28:08.606Z">12/Nov/07 10:28</time>
                   </dd>
                   <dd class="attachment-size">
                    76 kB
                   </dd>
                   <dd class="attachment-author">
                    Michael Busch
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12369408" data-issue-id="12358344" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12369408/lucene-743-take8.patch" draggable="true" data-downloadurl="text/x-patch:lucene-743-take8.patch:https://issues.apache.org/jira/secure/attachment/12369408/lucene-743-take8.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12369408/lucene-743-take8.patch" title="Latest  13/Nov/07 01:26 - Michael Busch" draggable="true" data-downloadurl="text/x-patch:lucene-743-take8.patch:https://issues.apache.org/jira/secure/attachment/12369408/lucene-743-take8.patch">lucene-743-take8.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-11-13T01:26:32.538Z">13/Nov/07 01:26</time>
                   </dd>
                   <dd class="attachment-size">
                    80 kB
                   </dd>
                   <dd class="attachment-author">
                    Michael Busch
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12369549" data-issue-id="12358344" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12369549/lucene-743-take9.patch" draggable="true" data-downloadurl="text/x-patch:lucene-743-take9.patch:https://issues.apache.org/jira/secure/attachment/12369549/lucene-743-take9.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12369549/lucene-743-take9.patch" title="Latest  14/Nov/07 20:59 - Michael Busch" draggable="true" data-downloadurl="text/x-patch:lucene-743-take9.patch:https://issues.apache.org/jira/secure/attachment/12369549/lucene-743-take9.patch">lucene-743-take9.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-11-14T20:59:59.511Z">14/Nov/07 20:59</time>
                   </dd>
                   <dd class="attachment-size">
                    79 kB
                   </dd>
                   <dd class="attachment-author">
                    Michael Busch
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12346948" data-issue-id="12358344" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12346948/MyMultiReader.java" draggable="true" data-downloadurl="text/x-java:MyMultiReader.java:https://issues.apache.org/jira/secure/attachment/12346948/MyMultiReader.java"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-file-code" title="Java Source File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12346948/MyMultiReader.java" title="Latest  11/Dec/06 22:47 - Otis Gospodnetic" draggable="true" data-downloadurl="text/x-java:MyMultiReader.java:https://issues.apache.org/jira/secure/attachment/12346948/MyMultiReader.java">MyMultiReader.java</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2006-12-11T22:47:20.000Z">11/Dec/06 22:47</time>
                   </dd>
                   <dd class="attachment-size">
                    0.6 kB
                   </dd>
                   <dd class="attachment-author">
                    Otis Gospodnetic
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12346949" data-issue-id="12358344" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12346949/MySegmentReader.java" draggable="true" data-downloadurl="text/x-java:MySegmentReader.java:https://issues.apache.org/jira/secure/attachment/12346949/MySegmentReader.java"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-file-code" title="Java Source File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12346949/MySegmentReader.java" title="Latest  11/Dec/06 22:47 - Otis Gospodnetic" draggable="true" data-downloadurl="text/x-java:MySegmentReader.java:https://issues.apache.org/jira/secure/attachment/12346949/MySegmentReader.java">MySegmentReader.java</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2006-12-11T22:47:20.000Z">11/Dec/06 22:47</time>
                   </dd>
                   <dd class="attachment-size">
                    0.7 kB
                   </dd>
                   <dd class="attachment-author">
                    Otis Gospodnetic
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12367221" data-issue-id="12358344" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12367221/varient-no-isCloneSupported.BROKEN.patch" draggable="true" data-downloadurl="text/x-patch:varient-no-isCloneSupported.BROKEN.patch:https://issues.apache.org/jira/secure/attachment/12367221/varient-no-isCloneSupported.BROKEN.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12367221/varient-no-isCloneSupported.BROKEN.patch" title="Latest  07/Oct/07 19:57 - Hoss Man" draggable="true" data-downloadurl="text/x-patch:varient-no-isCloneSupported.BROKEN.patch:https://issues.apache.org/jira/secure/attachment/12367221/varient-no-isCloneSupported.BROKEN.patch">varient-no-isCloneSupported.BROKEN.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-10-07T19:57:08.617Z">07/Oct/07 19:57</time>
                   </dd>
                   <dd class="attachment-size">
                    53 kB
                   </dd>
                   <dd class="attachment-author">
                    Hoss Man
                   </dd>
                  </dl></li>
                </ol>
               </div>
              </div>
              <div id="linkingmodule" class="module toggle-wrap">
               <div id="linkingmodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Issue Links</h2>
               </div>
               <div class="mod-content"> 
                <div class="links-container" data-default-link-icon="/jira/images/icons/generic_link_16.png"> 
                 <dl class="links-list "> 
                  <dt title="depends upon">
                   depends upon
                  </dt> 
                  <dd id="internal-12376572_10001"> 
                   <div class="link-content"> 
                    <p> <img src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21140&amp;avatarType=issuetype" width="16" height="16" title="Improvement - An improvement or enhancement to an existing feature or task." alt="Improvement - An improvement or enhancement to an existing feature or task."> <span title="LUCENE-986: Refactor segmentInfos from IndexReader into its subclasses"> <a href="/jira/browse/LUCENE-986" data-issue-key="LUCENE-986" class="issue-link link-title resolution">LUCENE-986</a> <span class="link-summary">Refactor segmentInfos from IndexReader into its subclasses</span> </span> </p> 
                    <ul class="link-snapshot"> 
                     <li class="priority"> <img src="/jira/images/icons/priorities/minor.svg" width="16" height="16" title="Minor - Minor loss of function, or other problem where easy workaround is present." alt="Minor - Minor loss of function, or other problem where easy workaround is present."> </li> 
                     <li class="status"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done aui-lozenge-subtle jira-issue-status-lozenge-max-width-short" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Closed</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.</span>">Closed</span> </li> 
                    </ul> 
                   </div> 
                  </dd> 
                 </dl> 
                 <dl class="links-list "> 
                  <dt title="is related to">
                   is related to
                  </dt> 
                  <dd id="internal-12364883_10030"> 
                   <div class="link-content"> 
                    <p> <img src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21140&amp;avatarType=issuetype" width="16" height="16" title="Improvement - An improvement or enhancement to an existing feature or task." alt="Improvement - An improvement or enhancement to an existing feature or task."> <span title="LUCENE-831: Complete overhaul of FieldCache API/Implementation"> <a href="/jira/browse/LUCENE-831" data-issue-key="LUCENE-831" class="issue-link link-title">LUCENE-831</a> <span class="link-summary">Complete overhaul of FieldCache API/Implementation</span> </span> </p> 
                    <ul class="link-snapshot"> 
                     <li class="priority"> <img src="/jira/images/icons/priorities/major.svg" width="16" height="16" title="Major - Major loss of function." alt="Major - Major loss of function."> </li> 
                     <li class="status"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-blue-gray jira-issue-status-lozenge-new aui-lozenge-subtle jira-issue-status-lozenge-max-width-short" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Open</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>The issue is open and ready for the assignee to start work on it.</span>">Open</span> </li> 
                    </ul> 
                   </div> 
                  </dd> 
                 </dl> 
                 <dl class="links-list "> 
                  <dt title="relates to">
                   relates to
                  </dt> 
                  <dd id="internal-12380626_10030"> 
                   <div class="link-content"> 
                    <p> <img src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21140&amp;avatarType=issuetype" width="16" height="16" title="Improvement - An improvement or enhancement to an existing feature or task." alt="Improvement - An improvement or enhancement to an existing feature or task."> <span title="LUCENE-1030: &quot;Read-only&quot; IndexReaders"> <a href="/jira/browse/LUCENE-1030" data-issue-key="LUCENE-1030" class="issue-link link-title resolution">LUCENE-1030</a> <span class="link-summary">"Read-only" IndexReaders</span> </span> </p> 
                    <ul class="link-snapshot"> 
                     <li class="priority"> <img src="/jira/images/icons/priorities/minor.svg" width="16" height="16" title="Minor - Minor loss of function, or other problem where easy workaround is present." alt="Minor - Minor loss of function, or other problem where easy workaround is present."> </li> 
                     <li class="status"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done aui-lozenge-subtle jira-issue-status-lozenge-max-width-short" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Resolved</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.</span>">Resolved</span> </li> 
                    </ul> 
                   </div> 
                  </dd> 
                 </dl> 
                </div> 
               </div>
              </div>
              <div id="activitymodule" class="module toggle-wrap">
               <div id="activitymodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Activity</h2>
               </div>
               <div class="mod-content"> 
                <big-pipe data-id="activity-panel-pipe-id" style="height: 70px"> 
                 <div></div> 
                </big-pipe> 
               </div>
              </div>
             </div>
             <div id="viewissuesidebar" class="aui-item issue-side-column">
              <div id="peoplemodule" class="module toggle-wrap">
               <div id="peoplemodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">People</h2>
               </div>
               <div class="mod-content"> 
                <ul class="item-details" id="peopledetails"> 
                 <li class="people-details"> 
                  <dl> 
                   <dt>
                    Assignee:
                   </dt> 
                   <dd> 
                    <span id="assignee-val" class="view-issue-field"> <span class="user-hover" id="issue_summary_assignee_michaelbusch" rel="michaelbusch" data-user="{&quot;avatarUrl&quot;:&quot;https://issues.apache.org/jira/secure/useravatar?size=xsmall&amp;avatarId=10452&quot;,&quot;displayName&quot;:&quot;Michael Busch&quot;,&quot;emailAddress&quot;:&quot;buschmic@gmail.com&quot;,&quot;username&quot;:&quot;michaelbusch&quot;}"> <span class="aui-avatar aui-avatar-small"><span class="aui-avatar-inner"><img src="https://issues.apache.org/jira/secure/useravatar?size=small&amp;avatarId=10452" alt="michaelbusch"></span></span> Michael Busch </span> </span> 
                   </dd> 
                  </dl> 
                  <dl> 
                   <dt>
                    Reporter:
                   </dt> 
                   <dd> 
                    <span id="reporter-val" class="view-issue-field"> <span class="user-hover" id="issue_summary_reporter_otis" rel="otis" data-user="{&quot;avatarUrl&quot;:&quot;https://issues.apache.org/jira/secure/useravatar?size=xsmall&amp;avatarId=10452&quot;,&quot;displayName&quot;:&quot;Otis Gospodnetic&quot;,&quot;emailAddress&quot;:&quot;otis@apache.org&quot;,&quot;username&quot;:&quot;otis&quot;}"> <span class="aui-avatar aui-avatar-small"><span class="aui-avatar-inner"><img src="https://issues.apache.org/jira/secure/useravatar?size=small&amp;avatarId=10452" alt="otis"></span></span> Otis Gospodnetic </span> </span> 
                   </dd> 
                  </dl> </li> 
                </ul> 
                <ul class="item-details"> 
                 <li> 
                  <dl> 
                   <dt>
                    Votes:
                   </dt> 
                   <dd> 
                    <span id="vote-data" class="aui-badge vote-state-off">3</span> 
                    <span id="vote-label" title="You have to be logged in to vote for an issue.">Vote for this issue</span> 
                   </dd> 
                  </dl> 
                  <dl> 
                   <dt>
                    Watchers:
                   </dt> 
                   <dd> 
                    <span id="watcher-data" class="aui-badge watch-state-off">1</span> 
                    <span id="watch-label" title="You have to be logged in to watch an issue.">Start watching this issue</span> 
                   </dd> 
                  </dl> </li> 
                </ul> 
               </div>
              </div>
              <div id="datesmodule" class="module toggle-wrap">
               <div id="datesmodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Dates</h2>
               </div>
               <div class="mod-content"> 
                <ul class="item-details"> 
                 <li> 
                  <dl class="dates"> 
                   <dt>
                    Created:
                   </dt> 
                   <dd class="date user-tz" title="11/Dec/06 22:46"> 
                    <span data-name="Created" id="created-val" data-fieldtype="datetime"> <time class="livestamp" datetime="2006-12-11T22:46:21+0000">11/Dec/06 22:46</time> </span> 
                   </dd> 
                  </dl> 
                  <dl class="dates"> 
                   <dt>
                    Updated:
                   </dt> 
                   <dd class="date user-tz" title="02/May/13 02:29"> 
                    <span data-name="Updated" id="updated-val" data-fieldtype="datetime"> <time class="livestamp" datetime="2013-05-02T02:29:08+0000">02/May/13 02:29</time> </span> 
                   </dd> 
                  </dl> 
                  <dl class="dates"> 
                   <dt>
                    Resolved:
                   </dt> 
                   <dd class="date user-tz" title="17/Nov/07 21:38"> 
                    <span data-name="Resolved" id="resolutiondate-val" data-fieldtype="datetime"> <time class="livestamp" datetime="2007-11-17T21:38:16+0000">17/Nov/07 21:38</time> </span> 
                   </dd> 
                  </dl> </li> 
                </ul> 
               </div>
              </div>
             </div>
            </div>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div>
     <!-- .aui-page-panel-inner -->
    </div>
    <!-- .aui-page-panel -->
    <div class="issue-navigator-init"></div> 
   </section> 
   <footer id="footer" role="contentinfo"> 
    <section class="footer-body"> 
     <ul class="atlassian-footer"> 
      <li> Atlassian JIRA <a class="seo-link" rel="nofollow" href="https://www.atlassian.com/software/jira">Project Management Software</a> <span id="footer-build-information">(v7.6.3#76005-<span title="8a4e38d34af948780dbf52044e7aafb13a7cae58" data-commit-id="8a4e38d34af948780dbf52044e7aafb13a7cae58}">sha1:8a4e38d</span>)</span> </li> 
      <li> <a id="about-link" rel="nofollow" href="/jira/secure/AboutPage.jspa/secure/AboutPage.jspa">About JIRA</a> </li> 
      <li> <a id="footer-report-problem-link" rel="nofollow" href="/jira/secure/CreateIssue!default.jspa">Report a problem</a> </li> 
     </ul> 
     <ul class="atlassian-footer"> 
      <li class="licensemessage"> Powered by a free Atlassian <a rel="nofollow" href="http://www.atlassian.com/software/jira">JIRA</a> open source license for n/a, Apache Software Foundation. Try JIRA - <a rel="nofollow" href="http://www.atlassian.com/software/jira">bug tracking software</a> for <i>your</i> team. </li> 
     </ul> 
     <div id="footer-logo">
      <a rel="nofollow" href="http://www.atlassian.com/">Atlassian</a>
     </div> 
    </section> 
    <fieldset class="hidden parameters"> 
     <input type="hidden" title="loggedInUser" value=""> 
     <input type="hidden" title="ajaxTimeout" value="The call to the JIRA server did not complete within the timeout period.  We are unsure of the result of this operation."> 
     <input type="hidden" title="JiraVersion" value="7.6.3"> 
     <input type="hidden" title="ajaxUnauthorised" value="You are not authorised to perform this operation. Please log in."> 
     <input type="hidden" title="baseURL" value="https://issues.apache.org/jira"> 
     <input type="hidden" title="ajaxCommsError" value="The JIRA server could not be contacted. This may be a temporary glitch or the server may be down. "> 
     <input type="hidden" title="ajaxServerError" value="The JIRA server was contacted but has returned an error response. We are unsure of the result of this operation."> 
     <input type="hidden" title="ajaxErrorCloseDialog" value="Close this dialog and press refresh in your browser"> 
     <input type="hidden" title="ajaxErrorDialogHeading" value="Communications Breakdown"> 
     <input type="hidden" title="dirtyMessage" value="You have entered new data on this page. If you navigate away from this page without first saving your data, the changes will be lost."> 
     <input type="hidden" title="dirtyDialogMessage" value="You have entered new data in this dialog. If you navigate away from this dialog without first saving your data, the changes will be lost. Click cancel to return to the dialog."> 
     <input type="hidden" title="keyType" value="Type"> 
     <input type="hidden" title="keyThen" value="then"> 
     <input type="hidden" title="dblClickToExpand" value="Double click to expand"> 
     <input type="hidden" title="actions" value="Actions"> 
     <input type="hidden" title="removeItem" value="Remove"> 
     <input type="hidden" title="workflow" value="Workflow"> 
     <input type="hidden" title="labelNew" value="New Label"> 
     <input type="hidden" title="issueActionsHint" value="Begin typing for available operations or press down to see all"> 
     <input type="hidden" title="closelink" value="Close"> 
     <input type="hidden" title="dotOperations" value="Operations"> 
     <input type="hidden" title="dotLoading" value="Loading..."> 
     <input type="hidden" title="frotherSuggestions" value="Suggestions"> 
     <input type="hidden" title="frotherNomatches" value="No Matches"> 
     <input type="hidden" title="multiselectVersionsError" value="{0} is not a valid version."> 
     <input type="hidden" title="multiselectComponentsError" value="{0} is not a valid component."> 
     <input type="hidden" title="multiselectGenericError" value="The value {0} is invalid."> 
    </fieldset> 
   </footer> 
  </div> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:bigpipe-js/jira.webresources:bigpipe-js.js" data-wrm-key="jira.webresources:bigpipe-js" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["activity-panel-pipe-id"]="\"\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n    \u003cdiv class=\\\"tabwrap tabs2\\\"\u003e\\n\\n        \u003cul id=\\\"issue-tabs\\\" class=\\\"tabs horizontal\\\"\u003e\\n                                \\n            \u003cli  data-id=\\\"all-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel\\\" data-label=\\\"All\\\" data-href=\\\"\\/jira\\/browse\\/LUCENE-743?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"all-tabpanel\\\" href=\\\"\\/jira\\/browse\\/LUCENE-743?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel\\\"\u003e\u003cstrong\u003eAll\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  class=\\\"active\\\" id=\\\"comment-tabpanel\\\"  data-id=\\\"comment-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel\\\" data-label=\\\"Comments\\\" data-href=\\\"\\/jira\\/browse\\/LUCENE-743?page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel\\\"\u003e\\n                            \u003cstrong tabindex=\\\"0\\\"\u003eComments\u003c\\/strong\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"worklog-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:worklog-tabpanel\\\" data-label=\\\"Work Log\\\" data-href=\\\"\\/jira\\/browse\\/LUCENE-743?page=com.atlassian.jira.plugin.system.issuetabpanels:worklog-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"worklog-tabpanel\\\" href=\\\"\\/jira\\/browse\\/LUCENE-743?page=com.atlassian.jira.plugin.system.issuetabpanels:worklog-tabpanel\\\"\u003e\u003cstrong\u003eWork Log\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"changehistory-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:changehistory-tabpanel\\\" data-label=\\\"History\\\" data-href=\\\"\\/jira\\/browse\\/LUCENE-743?page=com.atlassian.jira.plugin.system.issuetabpanels:changehistory-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"changehistory-tabpanel\\\" href=\\\"\\/jira\\/browse\\/LUCENE-743?page=com.atlassian.jira.plugin.system.issuetabpanels:changehistory-tabpanel\\\"\u003e\u003cstrong\u003eHistory\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"activity-stream-issue-tab\\\" data-key=\\\"com.atlassian.streams.streams-jira-plugin:activity-stream-issue-tab\\\" data-label=\\\"Activity\\\" data-href=\\\"\\/jira\\/browse\\/LUCENE-743?page=com.atlassian.streams.streams-jira-plugin:activity-stream-issue-tab\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"activity-stream-issue-tab\\\" href=\\\"\\/jira\\/browse\\/LUCENE-743?page=com.atlassian.streams.streams-jira-plugin:activity-stream-issue-tab\\\"\u003e\u003cstrong\u003eActivity\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"transitions-summary-tabpanel\\\" data-key=\\\"com.googlecode.jira-suite-utilities:transitions-summary-tabpanel\\\" data-label=\\\"Transitions\\\" data-href=\\\"\\/jira\\/browse\\/LUCENE-743?page=com.googlecode.jira-suite-utilities:transitions-summary-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"transitions-summary-tabpanel\\\" href=\\\"\\/jira\\/browse\\/LUCENE-743?page=com.googlecode.jira-suite-utilities:transitions-summary-tabpanel\\\"\u003e\u003cstrong\u003eTransitions\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                \u003c\\/ul\u003e\\n\\n                    \u003cdiv class=\\\"sortwrap\\\"\u003e\\n                                    \u003ca class=\\\"issue-activity-sort-link ajax-activity-content\\\" rel=\\\"nofollow\\\" data-tab-sort data-order=\\\"desc\\\" href=\\\"\\/jira\\/browse\\/LUCENE-743?actionOrder=desc\\\" title=\\\"Ascending order - Click to sort in descending order\\\"\u003e\\n                        \u003cspan class=\\\"aui-icon aui-icon-small aui-iconfont-up\\\"\u003eAscending order - Click to sort in descending order\u003c\\/span\u003e\\n                    \u003c\\/a\u003e\\n                            \u003c\\/div\u003e\\n            \u003c\\/div\u003e\\n    \u003cdiv class=\\\"issuePanelWrapper\\\"\u003e\\n        \u003cdiv class=\\\"issuePanelProgress\\\"\u003e\u003c\\/div\u003e\\n        \u003cdiv class=\\\"issuePanelContainer\\\" id=\\\"issue_actions_container\\\"\u003e\\n                                    \\n\\n\\n\u003cdiv id=\\\"comment-12457502\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12457502&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12457502\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"otis\\\" id=\\\"commentauthor_12457502_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=otis\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"otis\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Otis Gospodnetic\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12457502_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Dec\\/06 22:47\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-12-11T22:47:20+0000\'\u003e11\\/Dec\\/06 22:47\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eIn a direct email to me, Robert said: \\\"All of the files can be prepended with the ASL.\\\"\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"otis\\\" id=\\\"commentauthor_12457502_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=otis\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"otis\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Otis Gospodnetic\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12457502_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Dec\\/06 22:47\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-12-11T22:47:20+0000\'\u003e11\\/Dec\\/06 22:47\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    In a direct email to me, Robert said: \\\"All of the files can be prepended with the ASL.\\\"              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12457504\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12457504&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12457504\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rengels@tylertechinc.com\\\" id=\\\"commentauthor_12457504_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rengels%40tylertechinc.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rengels@tylertechinc.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e robert engels\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12457504_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Dec\\/06 22:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-12-11T22:57:08+0000\'\u003e11\\/Dec\\/06 22:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eA generic version probably needs to implement reference counting on the Segments or IndexReader in order to know when they can be safely closed.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rengels@tylertechinc.com\\\" id=\\\"commentauthor_12457504_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rengels%40tylertechinc.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rengels@tylertechinc.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e robert engels\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12457504_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Dec\\/06 22:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-12-11T22:57:08+0000\'\u003e11\\/Dec\\/06 22:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    A generic version probably needs to implement reference counting on the Segments or IndexReader in order to know when they can be safely closed.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12513772\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12513772&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12513772\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"hossman\\\" id=\\\"commentauthor_12513772_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=hossman\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"hossman\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Hoss Man\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12513772_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Jul\\/07 00:39\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-07-19T00:39:51+0000\'\u003e19\\/Jul\\/07 00:39\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003ei somehow missed seeing this issues before ... i don\'t really understand the details, but a few comments that come to mind...\u003c\\/p\u003e\\n\\n\u003cp\u003e1) this approach seems to assume that when reopening a MyMultiReader, the sub readers will all be MySegmentReaders .. assuming we generalize this to MultiReader\\/SegmentTeader, this wouldn\'t work in the case were people are using a MultiReader containing other MultiReaders ... not to mention the possibility of people who have written their own IndexReader implementations.\u003cbr\\/\u003e\\nin generally we should probably try to approach reopening a reader as a recursive operation if possible where each type of reader is responsible for checking to see if it\'s underlying data has changed, if not return itself, if so return a new reader in it\'s place  (much like rewrite works for Queries)\u003c\\/p\u003e\\n\\n\u003cp\u003e2) there is no more commit lock correct? ... is this approach something that can still be valid using the current backoff\\/retry mechanism involved with opening segments?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"hossman\\\" id=\\\"commentauthor_12513772_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=hossman\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"hossman\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Hoss Man\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12513772_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Jul\\/07 00:39\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-07-19T00:39:51+0000\'\u003e19\\/Jul\\/07 00:39\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    i somehow missed seeing this issues before ... i don\'t really understand the details, but a few comments that come to mind... \\n\\n 1) this approach seems to assume that when reopening a MyMultiReader, the sub readers will all be MySegmentReaders .. assuming we generalize this to MultiReader\\/SegmentTeader, this wouldn\'t work in the case were people are using a MultiReader containing other MultiReaders ... not to mention the possibility of people who have written their own IndexReader implementations. \\nin generally we should probably try to approach reopening a reader as a recursive operation if possible where each type of reader is responsible for checking to see if it\'s underlying data has changed, if not return itself, if so return a new reader in it\'s place  (much like rewrite works for Queries) \\n\\n 2) there is no more commit lock correct? ... is this approach something that can still be valid using the current backoff\\/retry mechanism involved with opening segments?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12514131\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12514131&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12514131\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12514131_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12514131_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Jul\\/07 07:10\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-07-20T07:10:38+0000\'\u003e20\\/Jul\\/07 07:10\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e&gt; i somehow missed seeing this issues before ... \u003c\\/p\u003e\\n\\n\u003cp\u003eactually, me too... first I came across this thread:\u003c\\/p\u003e\\n\\n\u003cp\u003e\u003ca href=\\\"http:\\/\\/www.gossamer-threads.com\\/lists\\/lucene\\/java-dev\\/31592?search_string=refresh;#31592\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttp:\\/\\/www.gossamer-threads.com\\/lists\\/lucene\\/java-dev\\/31592?search_string=refresh;#31592\u003c\\/a\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003ein which Doug suggested adding a static method IndexReader.open(IndexReader) \u003cbr\\/\u003e\\nwhich would either return the passed in IndexReader instance in case is is\u003cbr\\/\u003e\\nup to date or return a new, refreshed instance. \u003c\\/p\u003e\\n\\n\u003cp\u003eI started implementing this, using Dougs and Roberts ideas and then realized \u003cbr\\/\u003e\\nthat there was already this open issue. But the code here is quite outdated.\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; in generally we should probably try to approach reopening a reader as a \u003cbr\\/\u003e\\n&gt; recursive operation\u003c\\/p\u003e\\n\\n\u003cp\u003eYeah we could do that. However, this might not be so easy to implement.\u003cbr\\/\u003e\\nFor example, if a user creates a MultiReader instance and adds whatever\u003cbr\\/\u003e\\nsubreaders, we would have to recursively refresh the underlying readers.\u003cbr\\/\u003e\\nBut if the MultiReader was created automatically by IndexReader.open() just\u003cbr\\/\u003e\\ncalling refresh on the subreaders is not enough. New SegmentReaders have to\u003cbr\\/\u003e\\nbe opened for new segments.\u003c\\/p\u003e\\n\\n\u003cp\u003eAlso the recursive walk would have to take place within the FindSegmentsFile\u003cbr\\/\u003e\\nlogic.\u003c\\/p\u003e\\n\\n\u003cp\u003eI decided therefore to only allow IndexReaders to be refreshed if they were\u003cbr\\/\u003e\\ncreated by one of the IndexReader.open() methods. I\'m going to submit a first\u003cbr\\/\u003e\\nversion of my patch soon. Do you think this is too limiting? \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12514131_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12514131_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Jul\\/07 07:10\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-07-20T07:10:38+0000\'\u003e20\\/Jul\\/07 07:10\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    &gt; i somehow missed seeing this issues before ...  \\n\\n actually, me too... first I came across this thread: \\n\\n  http:\\/\\/www.gossamer-threads.com\\/lists\\/lucene\\/java-dev\\/31592?search_string=refresh;#31592  \\n\\n in which Doug suggested adding a static method IndexReader.open(IndexReader)  \\nwhich would either return the passed in IndexReader instance in case is is \\nup to date or return a new, refreshed instance.  \\n\\n I started implementing this, using Dougs and Roberts ideas and then realized  \\nthat there was already this open issue. But the code here is quite outdated. \\n\\n &gt; in generally we should probably try to approach reopening a reader as a  \\n&gt; recursive operation \\n\\n Yeah we could do that. However, this might not be so easy to implement. \\nFor example, if a user creates a MultiReader instance and adds whatever \\nsubreaders, we would have to recursively refresh the underlying readers. \\nBut if the MultiReader was created automatically by IndexReader.open() just \\ncalling refresh on the subreaders is not enough. New SegmentReaders have to \\nbe opened for new segments. \\n\\n Also the recursive walk would have to take place within the FindSegmentsFile \\nlogic. \\n\\n I decided therefore to only allow IndexReaders to be refreshed if they were \\ncreated by one of the IndexReader.open() methods. I\'m going to submit a first \\nversion of my patch soon. Do you think this is too limiting?               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12514132\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12514132&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12514132\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12514132_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12514132_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Jul\\/07 07:13\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-07-20T07:13:34+0000\'\u003e20\\/Jul\\/07 07:13\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eFirst version of my patch:\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eAdds the static method IndexReader.open(IndexReader)\u003cbr\\/\u003e\\n     that returns a new instance of IndexReader in case\u003cbr\\/\u003e\\n     the reader could be updated. If it was up to date\u003cbr\\/\u003e\\n     then the passed-in instance is returned. Only\u003cbr\\/\u003e\\n     IndexReader instances that were created by one of\u003cbr\\/\u003e\\n     the IndexReader.open() methods can be refreshed.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eSegmentsReader.reopen(SegmentInfos) looks in the\u003cbr\\/\u003e\\n     SegmentInfos for a segment with the same name. If\u003cbr\\/\u003e\\n     one could be found then either the deleted docs or\u003cbr\\/\u003e\\n     the norms were updated, otherwise the segment name\u003cbr\\/\u003e\\n     would have changed. reopen() clones the \u003cbr\\/\u003e\\n     SegmentReader and either loads the deleted docs,\u003cbr\\/\u003e\\n     the norms or both. Then the clone is returned and\u003cbr\\/\u003e\\n     the original SegmentReader is marked as closed.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eIf the index has only one segment, then\u003cbr\\/\u003e\\n     IndexReader.open(IndexReader) checks if the passed\u003cbr\\/\u003e\\n     in IndexReader can be refreshed. This is only \u003cbr\\/\u003e\\n     possible if it is no MultiReader and if the segment\u003cbr\\/\u003e\\n     name has not changed. Otherwise a new SegmentReader\u003cbr\\/\u003e\\n     instance is returned and the old reader is closed.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eIf the index has multiple segments, then\u003cbr\\/\u003e\\n     IndexReader.open(IndexReader) creates a new \u003cbr\\/\u003e\\n     MultiReader and tries to reuse the passed-in\u003cbr\\/\u003e\\n     reader (in case it\'s a SegmentReader) or its \u003cbr\\/\u003e\\n     subreaders (in case it\'s a MultiReader). For new\u003cbr\\/\u003e\\n     segments new SegmentReaders are created. Old \u003cbr\\/\u003e\\n     readers that couldn\'t be reused are closed.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eAdds the new testcase TestIndexReaderReopen. It\u003cbr\\/\u003e\\n     includes the method \u003cbr\\/\u003e\\n     assertIndexEquals(IndexReader, IndexReader) that\u003cbr\\/\u003e\\n     checks whether boths IndexReaders have the same\u003cbr\\/\u003e\\n     content. The testcase creates an index and \u003cbr\\/\u003e\\n     performes different modifications on that index.\u003cbr\\/\u003e\\n     One IndexReader is refreshed after each index\u003cbr\\/\u003e\\n     modification and compared to a fresh IndexReader\u003cbr\\/\u003e\\n     which is opened after each modification.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\\n\u003cp\u003eThis first version is for review and not ready to \u003cbr\\/\u003e\\ncommit. I want to add more extensive tests and \u003cbr\\/\u003e\\nprobably clean up the code.\u003c\\/p\u003e\\n\\n\u003cp\u003eAll tests pass.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12514132_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12514132_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Jul\\/07 07:13\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-07-20T07:13:34+0000\'\u003e20\\/Jul\\/07 07:13\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    First version of my patch: \\n\\n \\n\\t Adds the static method IndexReader.open(IndexReader) \\n     that returns a new instance of IndexReader in case \\n     the reader could be updated. If it was up to date \\n     then the passed-in instance is returned. Only \\n     IndexReader instances that were created by one of \\n     the IndexReader.open() methods can be refreshed. \\n \\n\\n\\n \\n\\t SegmentsReader.reopen(SegmentInfos) looks in the \\n     SegmentInfos for a segment with the same name. If \\n     one could be found then either the deleted docs or \\n     the norms were updated, otherwise the segment name \\n     would have changed. reopen() clones the  \\n     SegmentReader and either loads the deleted docs, \\n     the norms or both. Then the clone is returned and \\n     the original SegmentReader is marked as closed. \\n \\n\\n\\n \\n\\t If the index has only one segment, then \\n     IndexReader.open(IndexReader) checks if the passed \\n     in IndexReader can be refreshed. This is only  \\n     possible if it is no MultiReader and if the segment \\n     name has not changed. Otherwise a new SegmentReader \\n     instance is returned and the old reader is closed. \\n \\n\\n\\n \\n\\t If the index has multiple segments, then \\n     IndexReader.open(IndexReader) creates a new  \\n     MultiReader and tries to reuse the passed-in \\n     reader (in case it\'s a SegmentReader) or its  \\n     subreaders (in case it\'s a MultiReader). For new \\n     segments new SegmentReaders are created. Old  \\n     readers that couldn\'t be reused are closed. \\n \\n\\n\\n \\n\\t Adds the new testcase TestIndexReaderReopen. It \\n     includes the method  \\n     assertIndexEquals(IndexReader, IndexReader) that \\n     checks whether boths IndexReaders have the same \\n     content. The testcase creates an index and  \\n     performes different modifications on that index. \\n     One IndexReader is refreshed after each index \\n     modification and compared to a fresh IndexReader \\n     which is opened after each modification. \\n \\n\\n\\n\\n This first version is for review and not ready to  \\ncommit. I want to add more extensive tests and  \\nprobably clean up the code. \\n\\n All tests pass.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12514379\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12514379&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12514379\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"hossman\\\" id=\\\"commentauthor_12514379_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=hossman\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"hossman\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Hoss Man\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12514379_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Jul\\/07 00:26\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-07-21T00:26:00+0000\'\u003e21\\/Jul\\/07 00:26\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\\n\u003cp\u003e&gt; Yeah we could do that. However, this might not be so easy to implement.\u003cbr\\/\u003e\\n&gt; For example, if a user creates a MultiReader instance and adds whatever\u003cbr\\/\u003e\\n&gt; subreaders, we would have to recursively refresh the underlying readers.\u003cbr\\/\u003e\\n&gt; But if the MultiReader was created automatically by IndexReader.open() just\u003cbr\\/\u003e\\n&gt; calling refresh on the subreaders is not enough. New SegmentReaders have to\u003cbr\\/\u003e\\n&gt; be opened for new segments. \u003c\\/p\u003e\\n\\n\u003cp\u003e...this being the curse that is MultiReader &#8211; it can serve two very differenet purposes.  \u003c\\/p\u003e\\n\\n\u003cp\u003eYou seem to have already solved the multisegments in a single directory approach, the MultiReader over many subreader part actually seems much easier to me (just call your open method on all of the subreaders) the only tricky part is detecting which behavior should be used when. This could be driven by a simple boolean property of MultiReader indicating whether it owns it\'s directory and we need to look for new segments or not &#8211; in which case we just need to refresh the subreaders.  (My personal preference would be to change MultiReader so \\\"this.directory\\\" is null if it was open over several other subReaders, right now it\'s just assigned to the first one arbitrarily, but there may be other consequences of changing that)\u003c\\/p\u003e\\n\\n\u003cp\u003eIncidentally: I don\'t think it\'s crucial that this be done as a recursive method.  the same approach i describe could be added to  static utility like what you\'ve got, I just think that if it\'s possible to do it recursively we should so that  \u003cb\u003eif\u003c\\/b\u003e someone does write their own MultiReader or SegmentReader subclass they can still benefit from any core reopening logic as long as theey do their part to \\\"reopen\\\" their extensions.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"hossman\\\" id=\\\"commentauthor_12514379_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=hossman\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"hossman\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Hoss Man\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12514379_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Jul\\/07 00:26\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-07-21T00:26:00+0000\'\u003e21\\/Jul\\/07 00:26\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                   \\n &gt; Yeah we could do that. However, this might not be so easy to implement. \\n&gt; For example, if a user creates a MultiReader instance and adds whatever \\n&gt; subreaders, we would have to recursively refresh the underlying readers. \\n&gt; But if the MultiReader was created automatically by IndexReader.open() just \\n&gt; calling refresh on the subreaders is not enough. New SegmentReaders have to \\n&gt; be opened for new segments.  \\n\\n ...this being the curse that is MultiReader &#8211; it can serve two very differenet purposes.   \\n\\n You seem to have already solved the multisegments in a single directory approach, the MultiReader over many subreader part actually seems much easier to me (just call your open method on all of the subreaders) the only tricky part is detecting which behavior should be used when. This could be driven by a simple boolean property of MultiReader indicating whether it owns it\'s directory and we need to look for new segments or not &#8211; in which case we just need to refresh the subreaders.  (My personal preference would be to change MultiReader so \\\"this.directory\\\" is null if it was open over several other subReaders, right now it\'s just assigned to the first one arbitrarily, but there may be other consequences of changing that) \\n\\n Incidentally: I don\'t think it\'s crucial that this be done as a recursive method.  the same approach i describe could be added to  static utility like what you\'ve got, I just think that if it\'s possible to do it recursively we should so that   if  someone does write their own MultiReader or SegmentReader subclass they can still benefit from any core reopening logic as long as theey do their part to \\\"reopen\\\" their extensions.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12514381\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12514381&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12514381\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"hossman\\\" id=\\\"commentauthor_12514381_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=hossman\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"hossman\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Hoss Man\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12514381_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Jul\\/07 01:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-07-21T01:46:39+0000\'\u003e21\\/Jul\\/07 01:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003ean extremely hackish refactoring of the previous patch that demonstrates the method working recursively and dealing with MultiReaders constructed over multiple subReaders.\u003c\\/p\u003e\\n\\n\u003cp\u003ea few notes:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) no where near enough tests of the subReader situation\u003cbr\\/\u003e\\n2) the refactoring is very very ugly and brutish ... most of the code is still in IndexReader just because it needs so many things that are private &#8211; things that really seems like they should be pushed down into SegmentReader (or made protected)\u003cbr\\/\u003e\\n3) test triggered an apparent NPE in MultiReader.isOptimized() when there are subReaders, i hacked arround this in the test, see usages of assertIndexEqualsZZZ vs assertIndexEquals\u003cbr\\/\u003e\\n4) the FilterIndexReader situation is ... interesting.  in theory FilterIndexReader should really be abstract (since if you aren\'t subclassing it anyway, why do you want it?) \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"hossman\\\" id=\\\"commentauthor_12514381_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=hossman\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"hossman\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Hoss Man\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12514381_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/Jul\\/07 01:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-07-21T01:46:39+0000\'\u003e21\\/Jul\\/07 01:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    an extremely hackish refactoring of the previous patch that demonstrates the method working recursively and dealing with MultiReaders constructed over multiple subReaders. \\n\\n a few notes: \\n\\n 1) no where near enough tests of the subReader situation \\n2) the refactoring is very very ugly and brutish ... most of the code is still in IndexReader just because it needs so many things that are private &#8211; things that really seems like they should be pushed down into SegmentReader (or made protected) \\n3) test triggered an apparent NPE in MultiReader.isOptimized() when there are subReaders, i hacked arround this in the test, see usages of assertIndexEqualsZZZ vs assertIndexEquals \\n4) the FilterIndexReader situation is ... interesting.  in theory FilterIndexReader should really be abstract (since if you aren\'t subclassing it anyway, why do you want it?)               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12517085\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12517085&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12517085\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12517085_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12517085_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Aug\\/07 21:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-01T21:41:08+0000\'\u003e01\\/Aug\\/07 21:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eNow, after \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-781\\\" title=\\\"NPE in MultiReader.isCurrent() and getVersion()\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-781\\\"\u003e\u003cdel\u003eLUCENE-781\u003c\\/del\u003e\u003c\\/a\u003e, \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-970\\\" title=\\\"FilterIndexReader should overwrite isOptimized()\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-970\\\"\u003e\u003cdel\u003eLUCENE-970\u003c\\/del\u003e\u003c\\/a\u003e and \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-832\\\" title=\\\"NPE when calling isCurrent() on a ParallellReader\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-832\\\"\u003e\u003cdel\u003eLUCENE-832\u003c\\/del\u003e\u003c\\/a\u003e are committed, I updated the latest\u003cbr\\/\u003e\\npatch here, which was now easier because MultiReader is now separated into two classes.\u003c\\/p\u003e\\n\\n\u003cp\u003eNotes:\u003c\\/p\u003e\\n\u003cul\u003e\\n\\t\u003cli\u003eAs Hoss suggested I added the reopen() method to IndexReader non-static.\u003c\\/li\u003e\\n\\t\u003cli\u003eMultiReader and ParallelReader now overwrite reopen() to reopen the subreaders\u003cbr\\/\u003e\\n     recursively.\u003c\\/li\u003e\\n\\t\u003cli\u003eFilteredReader also overwrites reopen(). It checks if the underlying reader has\u003cbr\\/\u003e\\n     changed, and in that case returns a new instance of FilteredReader.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eI think the general contract of reopen() should be to always return a new IndexReader \u003cbr\\/\u003e\\ninstance if it was successfully refreshed and return the same instance otherwise, \u003cbr\\/\u003e\\nbecause IndexReaders are used as keys in caches.\u003cbr\\/\u003e\\nA remaining question here is if the old reader(s) should be closed then or not.\u003cbr\\/\u003e\\nThis patch closes the old readers for now, if we want to change that we probably have \u003cbr\\/\u003e\\nto add some reference counting mechanism, as Robert suggested already. Then I would\u003cbr\\/\u003e\\nalso have to change the SegmentReader.reopen() implementation to clone resources like\u003cbr\\/\u003e\\nthe dictionary, norms and delete bits. \u003cbr\\/\u003e\\nI think closing the old reader is fine. What do others think? Is keeping the old \u003cbr\\/\u003e\\nreader after a reopen() a useful usecase?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12517085_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12517085_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Aug\\/07 21:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-01T21:41:08+0000\'\u003e01\\/Aug\\/07 21:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Now, after   LUCENE-781  ,   LUCENE-970   and   LUCENE-832   are committed, I updated the latest \\npatch here, which was now easier because MultiReader is now separated into two classes. \\n\\n Notes: \\n \\n\\t As Hoss suggested I added the reopen() method to IndexReader non-static. \\n\\t MultiReader and ParallelReader now overwrite reopen() to reopen the subreaders \\n     recursively. \\n\\t FilteredReader also overwrites reopen(). It checks if the underlying reader has \\n     changed, and in that case returns a new instance of FilteredReader. \\n \\n\\n\\n I think the general contract of reopen() should be to always return a new IndexReader  \\ninstance if it was successfully refreshed and return the same instance otherwise,  \\nbecause IndexReaders are used as keys in caches. \\nA remaining question here is if the old reader(s) should be closed then or not. \\nThis patch closes the old readers for now, if we want to change that we probably have  \\nto add some reference counting mechanism, as Robert suggested already. Then I would \\nalso have to change the SegmentReader.reopen() implementation to clone resources like \\nthe dictionary, norms and delete bits.  \\nI think closing the old reader is fine. What do others think? Is keeping the old  \\nreader after a reopen() a useful usecase?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12517087\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12517087&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12517087\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12517087_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12517087_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Aug\\/07 21:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-01T21:46:21+0000\'\u003e01\\/Aug\\/07 21:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI ran some quick performance tests with this patch:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) The test opens an IndexReader, deletes one document by random docid, closes the Reader.\u003cbr\\/\u003e\\n   So this reader doesn\'t have to open the dictionary or the norms.\u003cbr\\/\u003e\\n2) Another reader is opened (or alternatively reopened) and one TermQuery is executed, so \u003cbr\\/\u003e\\n   this reader has to read the norms and the dictionary. \u003c\\/p\u003e\\n\\n\u003cp\u003eI run these two steps 5000 times in a loop.\u003c\\/p\u003e\\n\\n\u003cp\u003eFirst run: Index size: 4.5M, optimized \u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003e1) + TermQuery:    103 sec\u003c\\/li\u003e\\n\\t\u003cli\u003e1) + 2) (open):    806 sec, so open()   takes 703 sec\u003c\\/li\u003e\\n\\t\u003cli\u003e1) + 2) (reopen):  118 sec, so reopen() takes  15 sec ==&gt; Speedup: 46.9 X\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\\n\u003cp\u003eSecond run: Index size: 3.3M, 24 segments (14x 230.000, 10x 10.000)\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003e1) + TermQuery:    235 sec\u003c\\/li\u003e\\n\\t\u003cli\u003e1) + 2) (open):   1162 sec, so open()   takes 927 sec\u003c\\/li\u003e\\n\\t\u003cli\u003e1) + 2) (reopen):  321 sec, so reopen() takes  86 sec ==&gt; Speedup: 10.8X\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12517087_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12517087_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Aug\\/07 21:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-01T21:46:21+0000\'\u003e01\\/Aug\\/07 21:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I ran some quick performance tests with this patch: \\n\\n 1) The test opens an IndexReader, deletes one document by random docid, closes the Reader. \\n   So this reader doesn\'t have to open the dictionary or the norms. \\n2) Another reader is opened (or alternatively reopened) and one TermQuery is executed, so  \\n   this reader has to read the norms and the dictionary.  \\n\\n I run these two steps 5000 times in a loop. \\n\\n First run: Index size: 4.5M, optimized  \\n\\n \\n\\t 1) + TermQuery:    103 sec \\n\\t 1) + 2) (open):    806 sec, so open()   takes 703 sec \\n\\t 1) + 2) (reopen):  118 sec, so reopen() takes  15 sec ==&gt; Speedup: 46.9 X \\n \\n\\n\\n\\n Second run: Index size: 3.3M, 24 segments (14x 230.000, 10x 10.000) \\n\\n \\n\\t 1) + TermQuery:    235 sec \\n\\t 1) + 2) (open):   1162 sec, so open()   takes 927 sec \\n\\t 1) + 2) (reopen):  321 sec, so reopen() takes  86 sec ==&gt; Speedup: 10.8X \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12518030\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12518030&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12518030\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12518030_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12518030_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Aug\\/07 22:07\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-06T22:07:38+0000\'\u003e06\\/Aug\\/07 22:07\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e&gt; I think closing the old reader is fine. What do others think? Is keeping the old\u003cbr\\/\u003e\\n&gt; reader after a reopen() a useful usecase?\u003c\\/p\u003e\\n\\n\u003cp\u003eIn a multi-threaded environment, one wants to open a new reader, but needs to wait until all requests finish before closing the old reader.  Seems like reference counting is the only way to handle that case.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12518030_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12518030_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Aug\\/07 22:07\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-06T22:07:38+0000\'\u003e06\\/Aug\\/07 22:07\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    &gt; I think closing the old reader is fine. What do others think? Is keeping the old \\n&gt; reader after a reopen() a useful usecase? \\n\\n In a multi-threaded environment, one wants to open a new reader, but needs to wait until all requests finish before closing the old reader.  Seems like reference counting is the only way to handle that case.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12519377\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12519377&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12519377\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"hossman\\\" id=\\\"commentauthor_12519377_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=hossman\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"hossman\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Hoss Man\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12519377_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Aug\\/07 06:15\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-13T06:15:45+0000\'\u003e13\\/Aug\\/07 06:15\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\\n\u003cp\u003e(note: i haven\'t looked at the latest patch in detail, just commenting on the comments)\u003c\\/p\u003e\\n\\n\u003cp\u003eOne key problem i see with automatically closing things in reopen is MultiReader: it\'s perfectly legal to do something like this psuedocode...\u003c\\/p\u003e\\n\\n\u003cp\u003e   IndexReader a, b, c = ...\u003cbr\\/\u003e\\n   MultiReader ab = new MultiReader(\u003c\\/p\u003e\\n{a, b}\\n\u003cp\u003e)\u003cbr\\/\u003e\\n   MultiReader bc = new MultiReader(\u003c\\/p\u003e\\n{b, c}\\n\u003cp\u003e)\u003cbr\\/\u003e\\n   ...b changes on disk...\u003cbr\\/\u003e\\n   ab.reopen(); \\/\\/ this shouldn\'t affect bc;\u003c\\/p\u003e\\n\\n\u003cp\u003eone possibility would be for the semantics of reopen to close old readers only if it completely owns them; ie: MultiReader should never close anything in reopen, MultiSegmentReader should close all of the subreaders since it opened them in the first place ... things get into a grey area with SegementReader though.\u003c\\/p\u003e\\n\\n\u003cp\u003eIn general i think the safest thing to do is for reopen to never close.  Yonik\'s comment showcases one of the most compelling reasons why it can be important for clients to be able to keep using an old IndexReader instance, and it\'s easy enough for clients that want the old one closed to do something like...\u003c\\/p\u003e\\n\\n\u003cp\u003e   IndexReader r = ...\u003cbr\\/\u003e\\n   ...\u003cbr\\/\u003e\\n   IndexReader tmp = r.reopen();\u003cbr\\/\u003e\\n   if (tmp != r) r.close(); \u003cbr\\/\u003e\\n   r = tmp;\u003cbr\\/\u003e\\n   ...\u003c\\/p\u003e\\n\\n\\n\u003cp\u003e(one question that did jump out at me while greping the patch for the where old readers were being closed: why is the meat of reopen still in \\\"IndexReader\\\" with a \\\"if (reader instanceof SegmentReader)\\\" style logic in it?  can\'t the different reopen mechanisms be refactored down into SegmentReader and MultiSegmentReader respectively?  shouldn\'t the default impl of IndexReader throw an UnsuppportedOperationException?)\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"hossman\\\" id=\\\"commentauthor_12519377_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=hossman\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"hossman\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Hoss Man\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12519377_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Aug\\/07 06:15\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-13T06:15:45+0000\'\u003e13\\/Aug\\/07 06:15\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                   \\n (note: i haven\'t looked at the latest patch in detail, just commenting on the comments) \\n\\n One key problem i see with automatically closing things in reopen is MultiReader: it\'s perfectly legal to do something like this psuedocode... \\n\\n    IndexReader a, b, c = ... \\n   MultiReader ab = new MultiReader( \\n{a, b}\\n ) \\n   MultiReader bc = new MultiReader( \\n{b, c}\\n ) \\n   ...b changes on disk... \\n   ab.reopen(); \\/\\/ this shouldn\'t affect bc; \\n\\n one possibility would be for the semantics of reopen to close old readers only if it completely owns them; ie: MultiReader should never close anything in reopen, MultiSegmentReader should close all of the subreaders since it opened them in the first place ... things get into a grey area with SegementReader though. \\n\\n In general i think the safest thing to do is for reopen to never close.  Yonik\'s comment showcases one of the most compelling reasons why it can be important for clients to be able to keep using an old IndexReader instance, and it\'s easy enough for clients that want the old one closed to do something like... \\n\\n    IndexReader r = ... \\n   ... \\n   IndexReader tmp = r.reopen(); \\n   if (tmp != r) r.close();  \\n   r = tmp; \\n   ... \\n\\n\\n (one question that did jump out at me while greping the patch for the where old readers were being closed: why is the meat of reopen still in \\\"IndexReader\\\" with a \\\"if (reader instanceof SegmentReader)\\\" style logic in it?  can\'t the different reopen mechanisms be refactored down into SegmentReader and MultiSegmentReader respectively?  shouldn\'t the default impl of IndexReader throw an UnsuppportedOperationException?)              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12520476\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12520476&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12520476\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12520476_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12520476_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Aug\\/07 07:10\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-17T07:10:56+0000\'\u003e17\\/Aug\\/07 07:10\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e&gt;   IndexReader a, b, c = ...\u003cbr\\/\u003e\\n&gt;   MultiReader ab = new MultiReader(\u003c\\/p\u003e\\n{a, b}\\n\u003cp\u003e)\u003cbr\\/\u003e\\n&gt;   MultiReader bc = new MultiReader(\u003c\\/p\u003e\\n{b, c}\\n\u003cp\u003e)\u003cbr\\/\u003e\\n&gt;   ...b changes on disk...\u003cbr\\/\u003e\\n&gt;   ab.reopen(); \\/\\/ this shouldn\'t affect bc;\u003cbr\\/\u003e\\n&gt;\u003cbr\\/\u003e\\n&gt; one possibility would be for the semantics of reopen to close old readers only \u003cbr\\/\u003e\\n&gt; if it completely owns them; ie: MultiReader should never close anything in \u003cbr\\/\u003e\\n&gt; reopen, MultiSegmentReader should close all of the subreaders since it opened \u003cbr\\/\u003e\\n&gt; them in the first place\u003c\\/p\u003e\\n\\n\u003cp\u003eSo if \'b\' in your example is a MultiSegmentReader, then the reopen() call \u003cbr\\/\u003e\\ntriggered from MultiReader.reopen() would close old readers, because it owns them, \u003cbr\\/\u003e\\nthus \'bc\' wouldn\'t work anymore. So it depends on the caller of \u003cbr\\/\u003e\\nMultiSegmentReader.reopen() whether or not to close the subreaders. I think this \u003cbr\\/\u003e\\nis kind of messy. Well instead of reopen() we could add \u003cbr\\/\u003e\\nreopen(boolean closeOldReaders), but then...\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt;   IndexReader r = ...\u003cbr\\/\u003e\\n&gt;   ...\u003cbr\\/\u003e\\n&gt;   IndexReader tmp = r.reopen();\u003cbr\\/\u003e\\n&gt;   if (tmp != r) r.close(); \u003cbr\\/\u003e\\n&gt;   r = tmp;\u003cbr\\/\u003e\\n&gt;   ...\u003c\\/p\u003e\\n\\n\u003cp\u003e... is actually easy enough as you pointed out, so that the extra complexity is not \u003cbr\\/\u003e\\nreally worth it IMO.\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; In general i think the safest thing to do is for reopen to never close.  \u003c\\/p\u003e\\n\\n\u003cp\u003eSo yes, I agree.\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; why is the meat of reopen still in \\\"IndexReader\\\" with a \\\"if (reader instanceof \u003cbr\\/\u003e\\n&gt; SegmentReader)\\\" style logic in it?  can\'t the different reopen mechanisms be \u003cbr\\/\u003e\\n&gt; refactored down into SegmentReader and MultiSegmentReader respectively? \u003c\\/p\u003e\\n\\n\u003cp\u003eI\'m not sure if the code would become cleaner if we did that. Sometimes a \u003cbr\\/\u003e\\nSegmentReader would then have to return a MultiSegmentReader instance and vice\u003cbr\\/\u003e\\nversa. So we\'d probably have to duplicate some of the code in these two classes.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12520476_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12520476_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Aug\\/07 07:10\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-17T07:10:56+0000\'\u003e17\\/Aug\\/07 07:10\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    &gt;   IndexReader a, b, c = ... \\n&gt;   MultiReader ab = new MultiReader( \\n{a, b}\\n ) \\n&gt;   MultiReader bc = new MultiReader( \\n{b, c}\\n ) \\n&gt;   ...b changes on disk... \\n&gt;   ab.reopen(); \\/\\/ this shouldn\'t affect bc; \\n&gt; \\n&gt; one possibility would be for the semantics of reopen to close old readers only  \\n&gt; if it completely owns them; ie: MultiReader should never close anything in  \\n&gt; reopen, MultiSegmentReader should close all of the subreaders since it opened  \\n&gt; them in the first place \\n\\n So if \'b\' in your example is a MultiSegmentReader, then the reopen() call  \\ntriggered from MultiReader.reopen() would close old readers, because it owns them,  \\nthus \'bc\' wouldn\'t work anymore. So it depends on the caller of  \\nMultiSegmentReader.reopen() whether or not to close the subreaders. I think this  \\nis kind of messy. Well instead of reopen() we could add  \\nreopen(boolean closeOldReaders), but then... \\n\\n &gt;   IndexReader r = ... \\n&gt;   ... \\n&gt;   IndexReader tmp = r.reopen(); \\n&gt;   if (tmp != r) r.close();  \\n&gt;   r = tmp; \\n&gt;   ... \\n\\n ... is actually easy enough as you pointed out, so that the extra complexity is not  \\nreally worth it IMO. \\n\\n &gt; In general i think the safest thing to do is for reopen to never close.   \\n\\n So yes, I agree. \\n\\n &gt; why is the meat of reopen still in \\\"IndexReader\\\" with a \\\"if (reader instanceof  \\n&gt; SegmentReader)\\\" style logic in it?  can\'t the different reopen mechanisms be  \\n&gt; refactored down into SegmentReader and MultiSegmentReader respectively?  \\n\\n I\'m not sure if the code would become cleaner if we did that. Sometimes a  \\nSegmentReader would then have to return a MultiSegmentReader instance and vice \\nversa. So we\'d probably have to duplicate some of the code in these two classes.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12521243\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12521243&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12521243\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"hossman\\\" id=\\\"commentauthor_12521243_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=hossman\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"hossman\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Hoss Man\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12521243_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Aug\\/07 20:40\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-20T20:40:32+0000\'\u003e20\\/Aug\\/07 20:40\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\\n\\n\u003cp\u003e&gt; I\'m not sure if the code would become cleaner if we did that. Sometimes a SegmentReader would then have to \u003cbr\\/\u003e\\n&gt; return a MultiSegmentReader instance and vice versa. So we\'d probably have to duplicate some of the code in\u003cbr\\/\u003e\\n&gt; these two classes.\u003c\\/p\u003e\\n\\n\u003cp\u003ei don\'t hink there would be anything wrong with SegmentReader.reopen returning a MultiSegmentReader in some cases (or vice versa) but it definitely seems wrong to me for a parent class to be explicitly casing \\\"this\\\" to one of two know subclasses ... making reopen abstract in the base class (or throw UnsupportOp if for API back compatibility) seems like the only safe way to ensure any future IndexReader subclasses work properly.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"hossman\\\" id=\\\"commentauthor_12521243_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=hossman\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"hossman\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Hoss Man\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12521243_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Aug\\/07 20:40\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-20T20:40:32+0000\'\u003e20\\/Aug\\/07 20:40\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                   \\n\\n &gt; I\'m not sure if the code would become cleaner if we did that. Sometimes a SegmentReader would then have to  \\n&gt; return a MultiSegmentReader instance and vice versa. So we\'d probably have to duplicate some of the code in \\n&gt; these two classes. \\n\\n i don\'t hink there would be anything wrong with SegmentReader.reopen returning a MultiSegmentReader in some cases (or vice versa) but it definitely seems wrong to me for a parent class to be explicitly casing \\\"this\\\" to one of two know subclasses ... making reopen abstract in the base class (or throw UnsupportOp if for API back compatibility) seems like the only safe way to ensure any future IndexReader subclasses work properly.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12521962\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12521962&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12521962\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12521962_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12521962_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Aug\\/07 23:21\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-22T23:21:49+0000\'\u003e22\\/Aug\\/07 23:21\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eWe should first refactor segmentInfos into IndexReader\'s subclasses.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12521962_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12521962_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Aug\\/07 23:21\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-08-22T23:21:49+0000\'\u003e22\\/Aug\\/07 23:21\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    We should first refactor segmentInfos into IndexReader\'s subclasses.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12524694\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12524694&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12524694\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"testn\\\" id=\\\"commentauthor_12524694_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=testn\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"testn\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Testo Nakada\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12524694_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Sep\\/07 11:42\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-09-04T11:42:38+0000\'\u003e04\\/Sep\\/07 11:42\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003ePlease also consider making an option where the reopen can be automated (i.e. when the index is updated) instead of having to call it explicitly. Thread safety should be taken into account as well.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"testn\\\" id=\\\"commentauthor_12524694_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=testn\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"testn\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Testo Nakada\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12524694_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Sep\\/07 11:42\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-09-04T11:42:38+0000\'\u003e04\\/Sep\\/07 11:42\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Please also consider making an option where the reopen can be automated (i.e. when the index is updated) instead of having to call it explicitly. Thread safety should be taken into account as well.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12531698\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12531698&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12531698\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12531698_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12531698_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Oct\\/07 06:24\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-02T06:24:21+0000\'\u003e02\\/Oct\\/07 06:24\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI\'m attaching a new version of the patch that has a lot of changes compared to the last patch:\u003c\\/p\u003e\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eI factored most of the reopen logic into the subclasses of IndexReader. Now that we\'re having the DirectoryIndexReader layer this was possible in a more elegant way.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eIndexReader.reopen() now does not close the old readers by default. This was somewhat tricky, because now the IndexReaders must be cloneable. I changed IndexReader to implement the Cloneable interface and implemented clone() for all Lucene built-in IndexReaders. However, there are probably custom IndexReader implementations out there that do not implement clone() and reopen() should throw an exception when an attempt is made to reopen such a reader. But I don\'t want to throw an exception in IndexReader.clone() itself, because then it would not be possible anymore for subclasses to recursively call the native Object.clone() via super.clone(). To solve this conflict I added the method\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003e  \\/**\\n   * Returns \u003cspan class=\\\"code-keyword\\\"\u003etrue\u003c\\/span\u003e, \u003cspan class=\\\"code-keyword\\\"\u003eif\u003c\\/span\u003e \u003cspan class=\\\"code-keyword\\\"\u003ethis\u003c\\/span\u003e IndexReader instance supports the clone() operation.\\n   *\\/\\n  \u003cspan class=\\\"code-keyword\\\"\u003eprotected\u003c\\/span\u003e \u003cspan class=\\\"code-object\\\"\u003eboolean\u003c\\/span\u003e isCloneSupported();\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eto IndexReader which returns false by default. IndexReader.clone() checks if the actual implementation supports clone() (i. e. the above method returns true). If not, it throws an UnsupportedOperationException, if yes, it returns super.clone().\u003c\\/p\u003e\\n\\n\u003cp\u003eI was not sure about whether to throw an (unchecked) UnsupportedOperationException or a CloneNotSupportedException in this case. I decided to throw UnsupportedOperationException even though it\'s not really following the clone() guidelines, because it avoids the necessity to catch the CloneNotSupportedException every time clone() is called (in the reopen() methods of all IndexReader implementations).\u003c\\/p\u003e\\n\\n\u003cp\u003eAs an example for how the clone() method is used let me describe how MultiReader.reopen() works: it tries to reopen every of its subreaders. If at least one subreader could be reopened successfully, then a new MultiReader instance is created and the reopened subreaders are added to it. Every of the old MultiReader\'s subreaders, that was not reopened (because of no index changes) is now cloned() and added to the new MultiReader.\u003c\\/p\u003e\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eI also added the new method\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003e  \\/**\\n   * In addition to {@link #reopen()} \u003cspan class=\\\"code-keyword\\\"\u003ethis\u003c\\/span\u003e methods offers the ability to close\\n   * the old IndexReader instance. This speeds up the reopening process \u003cspan class=\\\"code-keyword\\\"\u003efor\u003c\\/span\u003e\\n   * certain IndexReader implementations and reduces memory consumption, because\\n   * resources of the old instance can be reused \u003cspan class=\\\"code-keyword\\\"\u003efor\u003c\\/span\u003e the reopened IndexReader\\n   * as it avoids the need of copying the resources.\\n   * &lt;p&gt;\\n   * The reopen performance especially benefits \u003cspan class=\\\"code-keyword\\\"\u003eif\u003c\\/span\u003e IndexReader instances returned \\n   * by one of the &lt;code&gt;open()&lt;\\/code&gt; methods are reopened with \\n   * &lt;code&gt;closeOldReader==\u003cspan class=\\\"code-keyword\\\"\u003etrue\u003c\\/span\u003e&lt;\\/code&gt;.\\n   * &lt;p&gt;\\n   * Certain IndexReader implementations ({@link MultiReader}, {@link ParallelReader})\\n   * require that the subreaders support the clone() operation (see {@link #isCloneSupported()}\\n   * in order to perform reopen with &lt;code&gt;closeOldReader==\u003cspan class=\\\"code-keyword\\\"\u003efalse\u003c\\/span\u003e&lt;\\/code&gt;.  \\n   *\\/\\n  \u003cspan class=\\\"code-keyword\\\"\u003epublic\u003c\\/span\u003e \u003cspan class=\\\"code-keyword\\\"\u003esynchronized\u003c\\/span\u003e IndexReader reopen(\u003cspan class=\\\"code-object\\\"\u003eboolean\u003c\\/span\u003e closeOldReader);\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eAs the javadoc says it has two benefits: 1) it speeds up reopening and reduces ressources, and 2) it allows to reopen readers, that use non-cloneable subreaders.\u003c\\/p\u003e\\n\\n\\n\u003cp\u003ePlease let me know what you think about these changes, especially about the clone() implementation.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12531698_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12531698_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Oct\\/07 06:24\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-02T06:24:21+0000\'\u003e02\\/Oct\\/07 06:24\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I\'m attaching a new version of the patch that has a lot of changes compared to the last patch: \\n\\n \\n\\t I factored most of the reopen logic into the subclasses of IndexReader. Now that we\'re having the DirectoryIndexReader layer this was possible in a more elegant way. \\n \\n\\n\\n \\n\\t IndexReader.reopen() now does not close the old readers by default. This was somewhat tricky, because now the IndexReaders must be cloneable. I changed IndexReader to implement the Cloneable interface and implemented clone() for all Lucene built-in IndexReaders. However, there are probably custom IndexReader implementations out there that do not implement clone() and reopen() should throw an exception when an attempt is made to reopen such a reader. But I don\'t want to throw an exception in IndexReader.clone() itself, because then it would not be possible anymore for subclasses to recursively call the native Object.clone() via super.clone(). To solve this conflict I added the method\\n  \\n   \\/**\\n   * Returns  true ,  if   this  IndexReader instance supports the clone() operation.\\n   *\\/\\n   protected   boolean  isCloneSupported();\\n \\n   \\n \\n\\n\\n to IndexReader which returns false by default. IndexReader.clone() checks if the actual implementation supports clone() (i. e. the above method returns true). If not, it throws an UnsupportedOperationException, if yes, it returns super.clone(). \\n\\n I was not sure about whether to throw an (unchecked) UnsupportedOperationException or a CloneNotSupportedException in this case. I decided to throw UnsupportedOperationException even though it\'s not really following the clone() guidelines, because it avoids the necessity to catch the CloneNotSupportedException every time clone() is called (in the reopen() methods of all IndexReader implementations). \\n\\n As an example for how the clone() method is used let me describe how MultiReader.reopen() works: it tries to reopen every of its subreaders. If at least one subreader could be reopened successfully, then a new MultiReader instance is created and the reopened subreaders are added to it. Every of the old MultiReader\'s subreaders, that was not reopened (because of no index changes) is now cloned() and added to the new MultiReader. \\n\\n \\n\\t I also added the new method\\n  \\n   \\/**\\n   * In addition to {@link #reopen()}  this  methods offers the ability to close\\n   * the old IndexReader instance. This speeds up the reopening process  for \\n   * certain IndexReader implementations and reduces memory consumption, because\\n   * resources of the old instance can be reused  for  the reopened IndexReader\\n   * as it avoids the need of copying the resources.\\n   * &lt;p&gt;\\n   * The reopen performance especially benefits  if  IndexReader instances returned \\n   * by one of the &lt;code&gt;open()&lt;\\/code&gt; methods are reopened with \\n   * &lt;code&gt;closeOldReader== true &lt;\\/code&gt;.\\n   * &lt;p&gt;\\n   * Certain IndexReader implementations ({@link MultiReader}, {@link ParallelReader})\\n   * require that the subreaders support the clone() operation (see {@link #isCloneSupported()}\\n   * in order to perform reopen with &lt;code&gt;closeOldReader== false &lt;\\/code&gt;.  \\n   *\\/\\n   public   synchronized  IndexReader reopen( boolean  closeOldReader);\\n \\n   \\n \\n\\n\\n As the javadoc says it has two benefits: 1) it speeds up reopening and reduces ressources, and 2) it allows to reopen readers, that use non-cloneable subreaders. \\n\\n\\n Please let me know what you think about these changes, especially about the clone() implementation.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12532585\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12532585&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12532585\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12532585_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12532585_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Oct\\/07 07:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-05T07:41:49+0000\'\u003e05\\/Oct\\/07 07:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI ran new performance tests with the latest patch similar to the tests I explained in an earlier comment on this issue.\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'m using again a 4.5M index. In each round I delete one document and (re)open the IndexReader thereafter. Here are the numbers for 5000 rounds:\u003c\\/p\u003e\\n\\n\u003cdiv class=\'table-wrap\'\u003e\\n\u003ctable class=\'confluenceTable\'\u003e\u003ctbody\u003e\\n\u003ctr\u003e\\n\u003cth class=\'confluenceTh\'\u003e&nbsp;\u003c\\/th\u003e\\n\u003cth class=\'confluenceTh\'\u003e Time \u003c\\/th\u003e\\n\u003cth class=\'confluenceTh\'\u003e Speedup \u003c\\/th\u003e\\n\u003c\\/tr\u003e\\n\u003ctr\u003e\\n\u003ctd class=\'confluenceTd\'\u003e open \u003c\\/td\u003e\\n\u003ctd class=\'confluenceTd\'\u003e  703s \u003c\\/td\u003e\\n\u003ctd class=\'confluenceTd\'\u003e&nbsp;\u003c\\/td\u003e\\n\u003c\\/tr\u003e\\n\u003ctr\u003e\\n\u003ctd class=\'confluenceTd\'\u003e reopen(closeOldReader==false) \u003c\\/td\u003e\\n\u003ctd class=\'confluenceTd\'\u003e 62s \u003c\\/td\u003e\\n\u003ctd class=\'confluenceTd\'\u003e 11x \u003c\\/td\u003e\\n\u003c\\/tr\u003e\\n\u003ctr\u003e\\n\u003ctd class=\'confluenceTd\'\u003e reopen(closeOldReader==true) \u003c\\/td\u003e\\n\u003ctd class=\'confluenceTd\'\u003e16s \u003c\\/td\u003e\\n\u003ctd class=\'confluenceTd\'\u003e 44x \u003c\\/td\u003e\\n\u003c\\/tr\u003e\\n\u003c\\/tbody\u003e\u003c\\/table\u003e\\n\u003c\\/div\u003e\\n\\n\\n\u003cp\u003eNow in each round I delete on document and also set the norm for one random document. Numbers for 1000 rounds:\u003c\\/p\u003e\\n\\n\u003cdiv class=\'table-wrap\'\u003e\\n\u003ctable class=\'confluenceTable\'\u003e\u003ctbody\u003e\\n\u003ctr\u003e\\n\u003cth class=\'confluenceTh\'\u003e&nbsp;\u003c\\/th\u003e\\n\u003cth class=\'confluenceTh\'\u003e Time \u003c\\/th\u003e\\n\u003cth class=\'confluenceTh\'\u003e Speedup \u003c\\/th\u003e\\n\u003c\\/tr\u003e\\n\u003ctr\u003e\\n\u003ctd class=\'confluenceTd\'\u003e open \u003c\\/td\u003e\\n\u003ctd class=\'confluenceTd\'\u003e  166s \u003c\\/td\u003e\\n\u003ctd class=\'confluenceTd\'\u003e&nbsp;\u003c\\/td\u003e\\n\u003c\\/tr\u003e\\n\u003ctr\u003e\\n\u003ctd class=\'confluenceTd\'\u003e reopen(closeOldReader==false) \u003c\\/td\u003e\\n\u003ctd class=\'confluenceTd\'\u003e 33s \u003c\\/td\u003e\\n\u003ctd class=\'confluenceTd\'\u003e 5.0x \u003c\\/td\u003e\\n\u003c\\/tr\u003e\\n\u003ctr\u003e\\n\u003ctd class=\'confluenceTd\'\u003e reopen(closeOldReader==true) \u003c\\/td\u003e\\n\u003ctd class=\'confluenceTd\'\u003e 29s \u003c\\/td\u003e\\n\u003ctd class=\'confluenceTd\'\u003e 5.7x \u003c\\/td\u003e\\n\u003c\\/tr\u003e\\n\u003c\\/tbody\u003e\u003c\\/table\u003e\\n\u003c\\/div\u003e\\n\\n\\n\u003cp\u003eI think these numbers look pretty good. We get a quite decent speedup even if the old readers are not closed.\u003c\\/p\u003e\\n\\n\u003cp\u003eI would like to commit this in a couple of days to get ready for Lucene 2.3. It would be nice if someone could review the latest patch! Hoss? Others?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12532585_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12532585_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Oct\\/07 07:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-05T07:41:49+0000\'\u003e05\\/Oct\\/07 07:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I ran new performance tests with the latest patch similar to the tests I explained in an earlier comment on this issue. \\n\\n I\'m using again a 4.5M index. In each round I delete one document and (re)open the IndexReader thereafter. Here are the numbers for 5000 rounds: \\n\\n \\n  \\n \\n &nbsp; \\n  Time  \\n  Speedup  \\n \\n \\n  open  \\n   703s  \\n &nbsp; \\n \\n \\n  reopen(closeOldReader==false)  \\n  62s  \\n  11x  \\n \\n \\n  reopen(closeOldReader==true)  \\n 16s  \\n  44x  \\n \\n  \\n \\n\\n\\n Now in each round I delete on document and also set the norm for one random document. Numbers for 1000 rounds: \\n\\n \\n  \\n \\n &nbsp; \\n  Time  \\n  Speedup  \\n \\n \\n  open  \\n   166s  \\n &nbsp; \\n \\n \\n  reopen(closeOldReader==false)  \\n  33s  \\n  5.0x  \\n \\n \\n  reopen(closeOldReader==true)  \\n  29s  \\n  5.7x  \\n \\n  \\n \\n\\n\\n I think these numbers look pretty good. We get a quite decent speedup even if the old readers are not closed. \\n\\n I would like to commit this in a couple of days to get ready for Lucene 2.3. It would be nice if someone could review the latest patch! Hoss? Others?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12532806\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12532806&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12532806\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12532806_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12532806_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Oct\\/07 00:58\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-06T00:58:19+0000\'\u003e06\\/Oct\\/07 00:58\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI think this looks pretty good Michael!\u003cbr\\/\u003e\\nToo bad so much needs to be cloned in the case that closeOldReader==false... maybe someday in the future we can have read-only readers.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12532806_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12532806_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Oct\\/07 00:58\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-06T00:58:19+0000\'\u003e06\\/Oct\\/07 00:58\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I think this looks pretty good Michael! \\nToo bad so much needs to be cloned in the case that closeOldReader==false... maybe someday in the future we can have read-only readers.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12532817\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12532817&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12532817\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12532817_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12532817_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Oct\\/07 03:43\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-06T03:43:56+0000\'\u003e06\\/Oct\\/07 03:43\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e&gt; Too bad so much needs to be cloned in the case that closeOldReader==false... maybe someday in the future we can have read-only readers.\u003c\\/p\u003e\\n\\n\u003cp\u003eYeah, the cloning part was kind of tedious. Read-only readers would indeed make our life much easier here. I\'m wondering how many people are using the IndexReader to alter the norms anyway?\u003c\\/p\u003e\\n\\n\u003cp\u003eWell, thanks for reviewing the patch, Yonik!\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12532817_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12532817_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Oct\\/07 03:43\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-06T03:43:56+0000\'\u003e06\\/Oct\\/07 03:43\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    &gt; Too bad so much needs to be cloned in the case that closeOldReader==false... maybe someday in the future we can have read-only readers. \\n\\n Yeah, the cloning part was kind of tedious. Read-only readers would indeed make our life much easier here. I\'m wondering how many people are using the IndexReader to alter the norms anyway? \\n\\n Well, thanks for reviewing the patch, Yonik!              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12532819\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12532819&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12532819\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rengels@ix.netcom.com\\\" id=\\\"commentauthor_12532819_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rengels%40ix.netcom.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rengels@ix.netcom.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e robert engels\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12532819_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Oct\\/07 04:24\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-06T04:24:47+0000\'\u003e06\\/Oct\\/07 04:24\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eNice to see all the good work on this. We are still on a 1.9 derivative.\u003c\\/p\u003e\\n\\n\u003cp\u003eHopefully we\'ll be able to move to stock 2.X release in the future.\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rengels@ix.netcom.com\\\" id=\\\"commentauthor_12532819_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rengels%40ix.netcom.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rengels@ix.netcom.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e robert engels\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12532819_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Oct\\/07 04:24\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-06T04:24:47+0000\'\u003e06\\/Oct\\/07 04:24\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Nice to see all the good work on this. We are still on a 1.9 derivative. \\n\\n Hopefully we\'ll be able to move to stock 2.X release in the future. \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12532829\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12532829&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12532829\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"hossman\\\" id=\\\"commentauthor_12532829_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=hossman\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"hossman\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Hoss Man\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12532829_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Oct\\/07 05:37\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-06T05:37:46+0000\'\u003e06\\/Oct\\/07 05:37\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI haven\'t looked at the patch yet (i really really plan to this weekend, baring catastrophe) but i\'m confused as to why you went the cloning route (along with the complexity of the api changes to indicate when it is\\/isn\'t supported) ... based on the comments, it seems to boil down to...\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; As an example for how the clone() method is used let me describe how MultiReader.reopen()\u003cbr\\/\u003e\\n&gt; works: it tries to reopen every of its subreaders. If at least one subreader could be reopened\u003cbr\\/\u003e\\n&gt; successfully, then a new MultiReader instance is created and the reopened subreaders are\u003cbr\\/\u003e\\n&gt; added to it. Every of the old MultiReader\'s subreaders, that was not reopened (because of no\u003cbr\\/\u003e\\n&gt; index changes) is now cloned() and added to the new MultiReader.\u003c\\/p\u003e\\n\\n\u003cp\u003ethat seems like circular logic: the clone method is used so that the sub readers can be cloned \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/help_16.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003ewhy use clones at all? why not just use the original reader (if the \\\"index\\\" that reader represents hasn\'t changed, why clone it?\u003c\\/p\u003e\\n\\n\u003cp\u003eAnd if (for reasons that aren\'t clear to me) it is important for MultiReader to use a clone of it\'s subreaders when their reopen method returns \\\"this\\\" then shouldn\'t clients do the same thing? ... why not make reopen always return this.clone() if the index hasn\'t changed (which now that i think about it, would also help by punting on the isCloneSupported issue &#8211; each class would already know if it was clonable.\u003c\\/p\u003e\\n\\n\u003cp\u003emaybe this will make more sense once i read the patch ... i just wanted to through it out there in case someone had a chance to reply before i get a chance.\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"hossman\\\" id=\\\"commentauthor_12532829_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=hossman\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"hossman\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Hoss Man\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12532829_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Oct\\/07 05:37\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-06T05:37:46+0000\'\u003e06\\/Oct\\/07 05:37\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I haven\'t looked at the patch yet (i really really plan to this weekend, baring catastrophe) but i\'m confused as to why you went the cloning route (along with the complexity of the api changes to indicate when it is\\/isn\'t supported) ... based on the comments, it seems to boil down to... \\n\\n &gt; As an example for how the clone() method is used let me describe how MultiReader.reopen() \\n&gt; works: it tries to reopen every of its subreaders. If at least one subreader could be reopened \\n&gt; successfully, then a new MultiReader instance is created and the reopened subreaders are \\n&gt; added to it. Every of the old MultiReader\'s subreaders, that was not reopened (because of no \\n&gt; index changes) is now cloned() and added to the new MultiReader. \\n\\n that seems like circular logic: the clone method is used so that the sub readers can be cloned   \\n\\n why use clones at all? why not just use the original reader (if the \\\"index\\\" that reader represents hasn\'t changed, why clone it? \\n\\n And if (for reasons that aren\'t clear to me) it is important for MultiReader to use a clone of it\'s subreaders when their reopen method returns \\\"this\\\" then shouldn\'t clients do the same thing? ... why not make reopen always return this.clone() if the index hasn\'t changed (which now that i think about it, would also help by punting on the isCloneSupported issue &#8211; each class would already know if it was clonable. \\n\\n maybe this will make more sense once i read the patch ... i just wanted to through it out there in case someone had a chance to reply before i get a chance. \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12532833\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12532833&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12532833\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12532833_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12532833_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Oct\\/07 06:56\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-06T06:56:42+0000\'\u003e06\\/Oct\\/07 06:56\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e&gt; why use clones at all? why not just use the original reader (if the \\\"index\\\" that reader represents hasn\'t changed, why clone it?\u003c\\/p\u003e\\n\\n\u003cp\u003eLet\'s say you have a MultiReader with two subreaders:\u003c\\/p\u003e\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003eIndexReader ir1 = IndexReader.open(index1);\\nIndexReader ir2 = IndexReader.open(index2);\\nIndexReader mr = \u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e MultiReader(\u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e IndexReader[] {ir1, ir2});\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\\n\u003cp\u003eNow index1 changes and you reopen the MultiReader and keep the old one open:\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003eIndexReader mr2 = mr.reopen();\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\\n\u003cp\u003eir1 would now be reopened and let\'s assume we wouldn\'t clone ir2. If you use mr2 now to e.g. delete a doc and that doc happens to be in index2, then mr1 would also see the changes because both MultiReaders share the same subreader ir2 and are thus not independent from each other.\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; why not make reopen always return this.clone()\u003c\\/p\u003e\\n\\n\u003cp\u003eclone() might be an expensive operation. We only need to clone if at least one of the subreaders has changed.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12532833_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12532833_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Oct\\/07 06:56\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-06T06:56:42+0000\'\u003e06\\/Oct\\/07 06:56\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    &gt; why use clones at all? why not just use the original reader (if the \\\"index\\\" that reader represents hasn\'t changed, why clone it? \\n\\n Let\'s say you have a MultiReader with two subreaders: \\n  \\n IndexReader ir1 = IndexReader.open(index1);\\nIndexReader ir2 = IndexReader.open(index2);\\nIndexReader mr =  new  MultiReader( new  IndexReader[] {ir1, ir2});\\n \\n  \\n\\n Now index1 changes and you reopen the MultiReader and keep the old one open: \\n\\n  \\n IndexReader mr2 = mr.reopen();\\n \\n  \\n\\n ir1 would now be reopened and let\'s assume we wouldn\'t clone ir2. If you use mr2 now to e.g. delete a doc and that doc happens to be in index2, then mr1 would also see the changes because both MultiReaders share the same subreader ir2 and are thus not independent from each other. \\n\\n &gt; why not make reopen always return this.clone() \\n\\n clone() might be an expensive operation. We only need to clone if at least one of the subreaders has changed.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12532867\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12532867&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12532867\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12532867_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12532867_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Oct\\/07 13:26\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-06T13:26:50+0000\'\u003e06\\/Oct\\/07 13:26\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e&gt; &gt; Too bad so much needs to be cloned in the case that\u003cbr\\/\u003e\\n&gt; &gt; closeOldReader==false... maybe someday in the future we can have\u003cbr\\/\u003e\\n&gt; &gt; read-only readers.\u003cbr\\/\u003e\\n&gt;\u003cbr\\/\u003e\\n&gt; Yeah, the cloning part was kind of tedious. Read-only readers would\u003cbr\\/\u003e\\n&gt; indeed make our life much easier here. I\'m wondering how many people\u003cbr\\/\u003e\\n&gt; are using the IndexReader to alter the norms anyway?\u003c\\/p\u003e\\n\\n\u003cp\u003eI think the closeOldReader=false case is actually quite important.\u003c\\/p\u003e\\n\\n\u003cp\u003eBecause in production, I think you\'d have to use that, so that your\u003cbr\\/\u003e\\nold reader stays alive and is used to service incoming queries, up\u003cbr\\/\u003e\\nuntil the point where the re-opened reader is \\\"fully warmed\\\".\u003c\\/p\u003e\\n\\n\u003cp\u003eSince fully warming could take a long time (minutes?) you need that\u003cbr\\/\u003e\\nold reader to stay open.\u003c\\/p\u003e\\n\\n\u003cp\u003eCan we take a copy-on-write approach?  EG, this is how OS\'s handle the\u003cbr\\/\u003e\\nvirtual memory pages when forking a process.  This would mean whenever\u003cbr\\/\u003e\\na clone has been made of a SegmentReader, they cross-reference one\u003cbr\\/\u003e\\nanother. Then whenever either needs to alter deleted docs, one of them\u003cbr\\/\u003e\\nmakes a copy then.  Likewise for the norms.\u003c\\/p\u003e\\n\\n\u003cp\u003eThis would mean that \\\"read-only\\\" uses of the cloned reader never\u003cbr\\/\u003e\\npay the cost of copying the deleted docs bit vector nor norms.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12532867_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12532867_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Oct\\/07 13:26\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-06T13:26:50+0000\'\u003e06\\/Oct\\/07 13:26\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    &gt; &gt; Too bad so much needs to be cloned in the case that \\n&gt; &gt; closeOldReader==false... maybe someday in the future we can have \\n&gt; &gt; read-only readers. \\n&gt; \\n&gt; Yeah, the cloning part was kind of tedious. Read-only readers would \\n&gt; indeed make our life much easier here. I\'m wondering how many people \\n&gt; are using the IndexReader to alter the norms anyway? \\n\\n I think the closeOldReader=false case is actually quite important. \\n\\n Because in production, I think you\'d have to use that, so that your \\nold reader stays alive and is used to service incoming queries, up \\nuntil the point where the re-opened reader is \\\"fully warmed\\\". \\n\\n Since fully warming could take a long time (minutes?) you need that \\nold reader to stay open. \\n\\n Can we take a copy-on-write approach?  EG, this is how OS\'s handle the \\nvirtual memory pages when forking a process.  This would mean whenever \\na clone has been made of a SegmentReader, they cross-reference one \\nanother. Then whenever either needs to alter deleted docs, one of them \\nmakes a copy then.  Likewise for the norms. \\n\\n This would mean that \\\"read-only\\\" uses of the cloned reader never \\npay the cost of copying the deleted docs bit vector nor norms.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12532875\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12532875&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12532875\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12532875_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12532875_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Oct\\/07 14:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-06T14:16:18+0000\'\u003e06\\/Oct\\/07 14:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\\n\u003cp\u003eActually if we went back to the sharing (not cloning) approach, could\u003cbr\\/\u003e\\nwe insert a check for any writing operation against the re-opened\u003cbr\\/\u003e\\nreader that throws an exception if the original reader is not yet\u003cbr\\/\u003e\\nclosed?\u003c\\/p\u003e\\n\\n\u003cp\u003eIn Michael\'s example above, on calling mr2.deleteDoc, you would hit an\u003cbr\\/\u003e\\nexception because mr2 would check and see that it\'s \\\"original\\\" reader\u003cbr\\/\u003e\\nmr is not yet closed.  But once you\'ve closed mr, then the call\u003cbr\\/\u003e\\nsucceeds.\u003c\\/p\u003e\\n\\n\u003cp\u003eI think this would let us have our cake and eat it too: re-opening\u003cbr\\/\u003e\\nwould be very low cost for unchanged readers (no clones created), and,\u003cbr\\/\u003e\\nyou can still do deletes, etc, after you have closed your prior\u003cbr\\/\u003e\\nreader.  You control when your prior reader gets closed, to allow for\u003cbr\\/\u003e\\nwarming time and for queries to finish on the old reader.\u003c\\/p\u003e\\n\\n\u003cp\u003eWould this work?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12532875_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12532875_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Oct\\/07 14:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-06T14:16:18+0000\'\u003e06\\/Oct\\/07 14:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                   \\n Actually if we went back to the sharing (not cloning) approach, could \\nwe insert a check for any writing operation against the re-opened \\nreader that throws an exception if the original reader is not yet \\nclosed? \\n\\n In Michael\'s example above, on calling mr2.deleteDoc, you would hit an \\nexception because mr2 would check and see that it\'s \\\"original\\\" reader \\nmr is not yet closed.  But once you\'ve closed mr, then the call \\nsucceeds. \\n\\n I think this would let us have our cake and eat it too: re-opening \\nwould be very low cost for unchanged readers (no clones created), and, \\nyou can still do deletes, etc, after you have closed your prior \\nreader.  You control when your prior reader gets closed, to allow for \\nwarming time and for queries to finish on the old reader. \\n\\n Would this work?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12532877\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12532877&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12532877\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12532877_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12532877_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Oct\\/07 14:29\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-06T14:29:08+0000\'\u003e06\\/Oct\\/07 14:29\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\\n\u003cp\u003eA couple other questions\\/points:\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eJust to verify: if you have a DirectoryIndexReader that is holding\u003cbr\\/\u003e\\n    the write lock (because it has made changes to deletes\\/norms) then\u003cbr\\/\u003e\\n    calling reopen on this reader should always return \'this\', right?\u003cbr\\/\u003e\\n    Because it has the write lock, it must be (better be!) current.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003e    This might be a good place to add an assert: if you are not\u003cbr\\/\u003e\\n    current, assert that you don\'t have the write lock, and if you\u003cbr\\/\u003e\\n    have the write lock, assert that you are current.\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eI think you should add \\\"ensureOpen()\\\" at the top of\u003cbr\\/\u003e\\n    MultiReader.reopen(...)?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eIf an Exception is hit during reopen, what is the resulting state\u003cbr\\/\u003e\\n    of your original reader?  I think, ideally, it is unaffected by\u003cbr\\/\u003e\\n    the attempt to re-open?  EG if you\'re on the hairy edge of file\u003cbr\\/\u003e\\n    descriptor limits, and the attempt to re-open failed because you\u003cbr\\/\u003e\\n    hit the limit, ideally your original reader is unaffected (even if\u003cbr\\/\u003e\\n    you specified closeOldReader=true).\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12532877_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12532877_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Oct\\/07 14:29\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-06T14:29:08+0000\'\u003e06\\/Oct\\/07 14:29\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                   \\n A couple other questions\\/points: \\n\\n \\n\\t Just to verify: if you have a DirectoryIndexReader that is holding \\n    the write lock (because it has made changes to deletes\\/norms) then \\n    calling reopen on this reader should always return \'this\', right? \\n    Because it has the write lock, it must be (better be!) current. \\n \\n\\n\\n     This might be a good place to add an assert: if you are not \\n    current, assert that you don\'t have the write lock, and if you \\n    have the write lock, assert that you are current. \\n\\n \\n\\t I think you should add \\\"ensureOpen()\\\" at the top of \\n    MultiReader.reopen(...)? \\n \\n\\n\\n \\n\\t If an Exception is hit during reopen, what is the resulting state \\n    of your original reader?  I think, ideally, it is unaffected by \\n    the attempt to re-open?  EG if you\'re on the hairy edge of file \\n    descriptor limits, and the attempt to re-open failed because you \\n    hit the limit, ideally your original reader is unaffected (even if \\n    you specified closeOldReader=true). \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12532990\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12532990&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12532990\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"hossman\\\" id=\\\"commentauthor_12532990_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=hossman\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"hossman\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Hoss Man\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12532990_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/Oct\\/07 18:22\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-07T18:22:45+0000\'\u003e07\\/Oct\\/07 18:22\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eOkay, read the patch.  I\'m on board with the need for Clonable now ... it\'s all about isolation.  if \\\"r.reopen(false) == r\\\" then the client is responsible for recognizing that it\'s got the same instance and can make the judgement call about reusing the instance or cloning depending on it\'s needs ... internally in things like MultiReader we have to assume we need a clone for isolation.\u003c\\/p\u003e\\n\\n\u003cp\u003eQuestions and comments...\u003c\\/p\u003e\\n\\n\u003cp\u003e1. CompoundFileReader, FieldsReader, IndexReader, and BitVector all have clone methods where they silently catch and ignore CloneNotSupportedExceptions from super.clone()... if we don\'t expect the exception to ever happen, we should just let the exception propogate up the stack (there is no down side to declaring that clone() throws CloneNotSupportedException).  If we think the exception might happen, but it\'s not a big deal if it does and we can ignore it, then we should put a comment in the catch block to that effect.  i\'m not clear which are the cases here.\u003c\\/p\u003e\\n\\n\u003cp\u003e2. i don\'t remember if the old patches had this issue as well, but having \\\"return new FilterIndexReader(reopened);\\\" in FilterIndexReader doesn\'t really help anyone using FilterIndexReader &#8211; they\'re going to want an instance of their own subclass.  to meet the contract of FilterIndexReader, we should implement all \\\"abstract\\\" methods and delegate to the inner reader - so in theory do don\'t need a new instance of FIlterIndexReader, we could just return in.reopen(closeold) ... my gut says it would be better to leave the method out entirely so that the default impl which throws UnSupOpEx is used &#8212; that way subclasses who want to use reopen \u003cb\u003emust\u003c\\/b\u003e define their own (instead of getting confused when their filtering logic stops working after they reopen for the first time)\u003c\\/p\u003e\\n\\n\u003cp\u003e3. instead of having an isClonable() method, why don\'t we just remove the \\\"implements Clonable\\\" declaration from IndexReader and put it on the concrete subclasses &#8211; then use \\\"instanceof Cloneable\\\" to determine if something is clonable?  ... for that matter, the only place isCloneSupported is really used is in IndexReader.clone where an exception is thrown if Clone is not  supported ... subclasses which know they are Clonable don\'t need this from the base class, subclasses which don\'t implement Clonable but are used in combination with core classes whose reopen method requires it could be skiped by the caller (since they don\'t implement Clonable) .. \u003c\\/p\u003e\\n\\n\u003cp\u003e4. javadocs frequently refer to \\\"reopened successfully\\\" and \\\"refreshed successfully\\\" when what it really means is \\\"reopen() returned a newer\\/fresher reader\\\" ... this may confuse people who are use to thinking of \\\"successfully\\\" a \\\"without error\\\"\u003c\\/p\u003e\\n\\n\u003cp\u003e5. random thought: are their any synchronization issues we\'re missing here?  I\'m wondering about the case where once thread calls reopen while another thread is updating norms or deleting docs.  is there any chance for inconsistent state?\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"hossman\\\" id=\\\"commentauthor_12532990_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=hossman\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"hossman\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Hoss Man\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12532990_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/Oct\\/07 18:22\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-07T18:22:45+0000\'\u003e07\\/Oct\\/07 18:22\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Okay, read the patch.  I\'m on board with the need for Clonable now ... it\'s all about isolation.  if \\\"r.reopen(false) == r\\\" then the client is responsible for recognizing that it\'s got the same instance and can make the judgement call about reusing the instance or cloning depending on it\'s needs ... internally in things like MultiReader we have to assume we need a clone for isolation. \\n\\n Questions and comments... \\n\\n 1. CompoundFileReader, FieldsReader, IndexReader, and BitVector all have clone methods where they silently catch and ignore CloneNotSupportedExceptions from super.clone()... if we don\'t expect the exception to ever happen, we should just let the exception propogate up the stack (there is no down side to declaring that clone() throws CloneNotSupportedException).  If we think the exception might happen, but it\'s not a big deal if it does and we can ignore it, then we should put a comment in the catch block to that effect.  i\'m not clear which are the cases here. \\n\\n 2. i don\'t remember if the old patches had this issue as well, but having \\\"return new FilterIndexReader(reopened);\\\" in FilterIndexReader doesn\'t really help anyone using FilterIndexReader &#8211; they\'re going to want an instance of their own subclass.  to meet the contract of FilterIndexReader, we should implement all \\\"abstract\\\" methods and delegate to the inner reader - so in theory do don\'t need a new instance of FIlterIndexReader, we could just return in.reopen(closeold) ... my gut says it would be better to leave the method out entirely so that the default impl which throws UnSupOpEx is used &#8212; that way subclasses who want to use reopen  must  define their own (instead of getting confused when their filtering logic stops working after they reopen for the first time) \\n\\n 3. instead of having an isClonable() method, why don\'t we just remove the \\\"implements Clonable\\\" declaration from IndexReader and put it on the concrete subclasses &#8211; then use \\\"instanceof Cloneable\\\" to determine if something is clonable?  ... for that matter, the only place isCloneSupported is really used is in IndexReader.clone where an exception is thrown if Clone is not  supported ... subclasses which know they are Clonable don\'t need this from the base class, subclasses which don\'t implement Clonable but are used in combination with core classes whose reopen method requires it could be skiped by the caller (since they don\'t implement Clonable) ..  \\n\\n 4. javadocs frequently refer to \\\"reopened successfully\\\" and \\\"refreshed successfully\\\" when what it really means is \\\"reopen() returned a newer\\/fresher reader\\\" ... this may confuse people who are use to thinking of \\\"successfully\\\" a \\\"without error\\\" \\n\\n 5. random thought: are their any synchronization issues we\'re missing here?  I\'m wondering about the case where once thread calls reopen while another thread is updating norms or deleting docs.  is there any chance for inconsistent state? \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12532997\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12532997&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12532997\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"hossman\\\" id=\\\"commentauthor_12532997_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=hossman\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"hossman\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Hoss Man\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12532997_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/Oct\\/07 19:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-07T19:57:08+0000\'\u003e07\\/Oct\\/07 19:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003ea rough variation on Michael\'s latest patch that makes the changes along two of the lines i was suggesting before reagrding FilterIndexReader and ising \\\"instanceof Cloneable\\\" instead of \\\"isCloneSupported()\\\" two important things to note:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) i didn\'t change any of the documentation, i was trying to change as little aspossibel so the two patches could be compared side-by-side\u003c\\/p\u003e\\n\\n\u003cp\u003e2) this patch is currently broken.  TestIndexReaderReopen gets an exception i can\'t understand ... but i have to stop now, and i wanted to post what i had in case people had comments.\u003c\\/p\u003e\\n\\n\u003cp\u003e...now that i\'ve done this exercise, i\'m not convinced that it\'s a better way to go, but it does seem like isCloneSupported isn\'t neccessary, that\'s the whole point of the Cloneable interface.\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"hossman\\\" id=\\\"commentauthor_12532997_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=hossman\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"hossman\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Hoss Man\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12532997_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/Oct\\/07 19:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-07T19:57:08+0000\'\u003e07\\/Oct\\/07 19:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    a rough variation on Michael\'s latest patch that makes the changes along two of the lines i was suggesting before reagrding FilterIndexReader and ising \\\"instanceof Cloneable\\\" instead of \\\"isCloneSupported()\\\" two important things to note: \\n\\n 1) i didn\'t change any of the documentation, i was trying to change as little aspossibel so the two patches could be compared side-by-side \\n\\n 2) this patch is currently broken.  TestIndexReaderReopen gets an exception i can\'t understand ... but i have to stop now, and i wanted to post what i had in case people had comments. \\n\\n ...now that i\'ve done this exercise, i\'m not convinced that it\'s a better way to go, but it does seem like isCloneSupported isn\'t neccessary, that\'s the whole point of the Cloneable interface. \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12533000\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12533000&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12533000\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12533000_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12533000_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/Oct\\/07 20:09\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-07T20:09:29+0000\'\u003e07\\/Oct\\/07 20:09\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e&gt; I\'m wondering about the case where once thread calls reopen while another thread is updating norms or deleting docs.\u003c\\/p\u003e\\n\\n\u003cp\u003eHmmm  there is cause for concern (and I should have had my mt-safe hat on \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003cbr\\/\u003e\\nReopen is synchronized on the reader, and so are norms access and docs, but from a quick look:\u003c\\/p\u003e\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003ereopen() may be synchronized, but clone() called on sub-readers isn\'t in a synchronized context that the sub-reader cares about.  For example, MultiReader.reopen has the lock on the multireader, but calles subreader.clone() which iterates over the norms in a non thread-safe way.\u003c\\/li\u003e\\n\\t\u003cli\u003eIndexInput objects that are in use should never be cloned... (like what is done in FieldsReader.clone())\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12533000_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12533000_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/Oct\\/07 20:09\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-07T20:09:29+0000\'\u003e07\\/Oct\\/07 20:09\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    &gt; I\'m wondering about the case where once thread calls reopen while another thread is updating norms or deleting docs. \\n\\n Hmmm  there is cause for concern (and I should have had my mt-safe hat on   \\nReopen is synchronized on the reader, and so are norms access and docs, but from a quick look: \\n \\n\\t reopen() may be synchronized, but clone() called on sub-readers isn\'t in a synchronized context that the sub-reader cares about.  For example, MultiReader.reopen has the lock on the multireader, but calles subreader.clone() which iterates over the norms in a non thread-safe way. \\n\\t IndexInput objects that are in use should never be cloned... (like what is done in FieldsReader.clone()) \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12533172\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12533172&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12533172\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12533172_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12533172_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Oct\\/07 17:56\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-08T17:56:11+0000\'\u003e08\\/Oct\\/07 17:56\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks all for the reviews and comments!\u003c\\/p\u003e\\n\\n\u003cp\u003eThere seem to be some issues\\/open questions concerning the cloning. \u003cbr\\/\u003e\\nBefore I comment on them I think it would make sense to decide whether\u003cbr\\/\u003e\\nwe want to stick with the cloning approach or not. Mike suggests this \u003cbr\\/\u003e\\napproach:\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; Actually if we went back to the sharing (not cloning) approach, could\u003cbr\\/\u003e\\n&gt; we insert a check for any writing operation against the re-opened\u003cbr\\/\u003e\\n&gt; reader that throws an exception if the original reader is not yet\u003cbr\\/\u003e\\n&gt; closed?\u003c\\/p\u003e\\n\\n\u003cp\u003eInteresting, yes that should work in case we have two readers (the \u003cbr\\/\u003e\\noriginal one and the re-opened one). But what happens if the user calls \u003cbr\\/\u003e\\nreopen twice to get two re-opened instances back? Then there would be \u003cbr\\/\u003e\\nthree instances, and without cloning the two re-opened ones would also \u003cbr\\/\u003e\\nshare the same resources. Is this a desirable use case or would it be \u003cbr\\/\u003e\\nokay to restrict reopen() so that it can only create one new instance?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12533172_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12533172_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Oct\\/07 17:56\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-08T17:56:11+0000\'\u003e08\\/Oct\\/07 17:56\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks all for the reviews and comments! \\n\\n There seem to be some issues\\/open questions concerning the cloning.  \\nBefore I comment on them I think it would make sense to decide whether \\nwe want to stick with the cloning approach or not. Mike suggests this  \\napproach: \\n\\n &gt; Actually if we went back to the sharing (not cloning) approach, could \\n&gt; we insert a check for any writing operation against the re-opened \\n&gt; reader that throws an exception if the original reader is not yet \\n&gt; closed? \\n\\n Interesting, yes that should work in case we have two readers (the  \\noriginal one and the re-opened one). But what happens if the user calls  \\nreopen twice to get two re-opened instances back? Then there would be  \\nthree instances, and without cloning the two re-opened ones would also  \\nshare the same resources. Is this a desirable use case or would it be  \\nokay to restrict reopen() so that it can only create one new instance?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12533186\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12533186&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12533186\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12533186_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12533186_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Oct\\/07 18:45\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-08T18:45:12+0000\'\u003e08\\/Oct\\/07 18:45\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e&gt; &gt; Actually if we went back to the sharing (not cloning) approach,\u003cbr\\/\u003e\\n&gt; &gt; could we insert a check for any writing operation against the\u003cbr\\/\u003e\\n&gt; &gt; re-opened reader that throws an exception if the original reader\u003cbr\\/\u003e\\n&gt; &gt; is not yet closed?\u003cbr\\/\u003e\\n&gt;\u003cbr\\/\u003e\\n&gt; Interesting, yes that should work in case we have two readers (the\u003cbr\\/\u003e\\n&gt; original one and the re-opened one). But what happens if the user\u003cbr\\/\u003e\\n&gt; calls reopen twice to get two re-opened instances back? Then there\u003cbr\\/\u003e\\n&gt; would be three instances, and without cloning the two re-opened ones\u003cbr\\/\u003e\\n&gt; would also share the same resources. Is this a desirable use case or\u003cbr\\/\u003e\\n&gt; would it be okay to restrict reopen() so that it can only create one\u003cbr\\/\u003e\\n&gt; new instance?\u003c\\/p\u003e\\n\\n\u003cp\u003eHmmm good point.\u003c\\/p\u003e\\n\\n\u003cp\u003eActually, we could allow more then one re-open call if we take the\u003cbr\\/\u003e\\nfollowing approach: every time a cloned Reader \\\"borrows\\\" a reference\u003cbr\\/\u003e\\nto a sub-reader, it increments a counter (call it the \\\"referrer\u003cbr\\/\u003e\\ncount\\\").  When the Reader is closed, it decrements the count (by 1)\u003cbr\\/\u003e\\nfor each of the sub-readers.\u003c\\/p\u003e\\n\\n\u003cp\u003eThen, any reader should refuse to do a writing operation if its\u003cbr\\/\u003e\\n\\\"referrer\\\" count is greater than 1, because it\'s being shared across\u003cbr\\/\u003e\\nmore than one referrer.\u003c\\/p\u003e\\n\\n\u003cp\u003eThis way if you have a reader X and you did reopen to get Y and did\u003cbr\\/\u003e\\nreopen again to get Z then the shared sub-readers between X, Y and Z\u003cbr\\/\u003e\\nwould not allow any write operations until 2 of the three had been\u003cbr\\/\u003e\\nclosed.  I think that would work?\u003c\\/p\u003e\\n\\n\u003cp\u003eBTW this would also allow for very efficient \\\"snapshots\\\" during\u003cbr\\/\u003e\\nsearching: keeping multiple readers \\\"alive\\\", each searching a\u003cbr\\/\u003e\\ndifferent point-in-time commit of the index, because they would all\u003cbr\\/\u003e\\nshare the underlying segment readers that they have in common.  Vs\u003cbr\\/\u003e\\ncloning which would have to make many copies of each segment reader.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12533186_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12533186_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Oct\\/07 18:45\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-08T18:45:12+0000\'\u003e08\\/Oct\\/07 18:45\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    &gt; &gt; Actually if we went back to the sharing (not cloning) approach, \\n&gt; &gt; could we insert a check for any writing operation against the \\n&gt; &gt; re-opened reader that throws an exception if the original reader \\n&gt; &gt; is not yet closed? \\n&gt; \\n&gt; Interesting, yes that should work in case we have two readers (the \\n&gt; original one and the re-opened one). But what happens if the user \\n&gt; calls reopen twice to get two re-opened instances back? Then there \\n&gt; would be three instances, and without cloning the two re-opened ones \\n&gt; would also share the same resources. Is this a desirable use case or \\n&gt; would it be okay to restrict reopen() so that it can only create one \\n&gt; new instance? \\n\\n Hmmm good point. \\n\\n Actually, we could allow more then one re-open call if we take the \\nfollowing approach: every time a cloned Reader \\\"borrows\\\" a reference \\nto a sub-reader, it increments a counter (call it the \\\"referrer \\ncount\\\").  When the Reader is closed, it decrements the count (by 1) \\nfor each of the sub-readers. \\n\\n Then, any reader should refuse to do a writing operation if its \\n\\\"referrer\\\" count is greater than 1, because it\'s being shared across \\nmore than one referrer. \\n\\n This way if you have a reader X and you did reopen to get Y and did \\nreopen again to get Z then the shared sub-readers between X, Y and Z \\nwould not allow any write operations until 2 of the three had been \\nclosed.  I think that would work? \\n\\n BTW this would also allow for very efficient \\\"snapshots\\\" during \\nsearching: keeping multiple readers \\\"alive\\\", each searching a \\ndifferent point-in-time commit of the index, because they would all \\nshare the underlying segment readers that they have in common.  Vs \\ncloning which would have to make many copies of each segment reader.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12533205\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12533205&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12533205\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12533205_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12533205_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Oct\\/07 21:42\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-08T21:42:29+0000\'\u003e08\\/Oct\\/07 21:42\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e&gt; This way if you have a reader X and you did reopen to get Y and did\u003cbr\\/\u003e\\n&gt; reopen again to get Z then the shared sub-readers between X, Y and Z\u003cbr\\/\u003e\\n&gt; would not allow any write operations until 2 of the three had been\u003cbr\\/\u003e\\n&gt; closed.  I think that would work?\u003c\\/p\u003e\\n\\n\u003cp\u003eYes I think it would work. However, this approach has two downside IMO:\u003c\\/p\u003e\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003ereopen() becomes more complicated and restricted for the user. With\u003cbr\\/\u003e\\nthe cloning approach the user doesn\'t have to care about when index \u003cbr\\/\u003e\\nmodifications are not allowed. IndexReader instances returned by open()\u003cbr\\/\u003e\\nor reopen() can be used exactly the same without any restrictions.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eWe have to be very careful about cross-referencing multiple readers.\u003cbr\\/\u003e\\nIf for some reason any references between two or more readers are not\u003cbr\\/\u003e\\ncleared after one was closed, then that reader might not become GC\'d.\u003cbr\\/\u003e\\nI\'m not saying it\'s not possible or even very hard, we just have to \u003cbr\\/\u003e\\nmake sure those things can\'t ever happen.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eOf course the cloning approach has disadvantages too. For custom \u003cbr\\/\u003e\\nreaders clone() has to be implemented in order to make reopen() work\u003cbr\\/\u003e\\ncorrectly. Also reopen() is more expensive in case of \u003cbr\\/\u003e\\ncloseOldReader=false. Well we could certainly consider the lazy clone\u003cbr\\/\u003e\\napproach that you suggested, Mike, but we have to be careful about the\u003cbr\\/\u003e\\ncross-referencing issue again.\u003c\\/p\u003e\\n\\n\u003cp\u003eSo I\'m really not sure which way the better one is. I think I\'m slightly\u003cbr\\/\u003e\\nin favor for the cloning approach, so that reopen() returns instances \u003cbr\\/\u003e\\nthat are completely independant from each other, which seems cleaner IMO.\u003cbr\\/\u003e\\nWhat do others think?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12533205_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12533205_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Oct\\/07 21:42\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-08T21:42:29+0000\'\u003e08\\/Oct\\/07 21:42\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    &gt; This way if you have a reader X and you did reopen to get Y and did \\n&gt; reopen again to get Z then the shared sub-readers between X, Y and Z \\n&gt; would not allow any write operations until 2 of the three had been \\n&gt; closed.  I think that would work? \\n\\n Yes I think it would work. However, this approach has two downside IMO: \\n \\n\\t reopen() becomes more complicated and restricted for the user. With \\nthe cloning approach the user doesn\'t have to care about when index  \\nmodifications are not allowed. IndexReader instances returned by open() \\nor reopen() can be used exactly the same without any restrictions. \\n \\n\\n\\n \\n\\t We have to be very careful about cross-referencing multiple readers. \\nIf for some reason any references between two or more readers are not \\ncleared after one was closed, then that reader might not become GC\'d. \\nI\'m not saying it\'s not possible or even very hard, we just have to  \\nmake sure those things can\'t ever happen. \\n \\n\\n\\n Of course the cloning approach has disadvantages too. For custom  \\nreaders clone() has to be implemented in order to make reopen() work \\ncorrectly. Also reopen() is more expensive in case of  \\ncloseOldReader=false. Well we could certainly consider the lazy clone \\napproach that you suggested, Mike, but we have to be careful about the \\ncross-referencing issue again. \\n\\n So I\'m really not sure which way the better one is. I think I\'m slightly \\nin favor for the cloning approach, so that reopen() returns instances  \\nthat are completely independant from each other, which seems cleaner IMO. \\nWhat do others think?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12533213\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12533213&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12533213\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12533213_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12533213_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Oct\\/07 22:15\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-08T22:15:09+0000\'\u003e08\\/Oct\\/07 22:15\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\\n\u003cp\u003e&gt; We have to be very careful about cross-referencing multiple readers.\u003cbr\\/\u003e\\n&gt; If for some reason any references between two or more readers are\u003cbr\\/\u003e\\n&gt; not cleared after one was closed, then that reader might not become\u003cbr\\/\u003e\\n&gt; GC\'d.  I\'m not saying it\'s not possible or even very hard, we just\u003cbr\\/\u003e\\n&gt; have to make sure those things can\'t ever happen.\u003c\\/p\u003e\\n\\n\u003cp\u003eOne correction: there should be no cross-referencing, right?  The only\u003cbr\\/\u003e\\nthing that\'s happening is incrementing &amp; decrementing the \\\"referrer\u003cbr\\/\u003e\\ncount\\\" for a reader?  (But, you\'re right: the \\\"copy on write\\\" approach\u003cbr\\/\u003e\\nto cloning would have cross-referencing).\u003c\\/p\u003e\\n\\n\u003cp\u003eI think the downside of this proposed \\\"shared readers\\\" (non-cloning)\u003cbr\\/\u003e\\napproach is that you can\'t delete\\/setNorm on the clone until you close\u003cbr\\/\u003e\\nthe original.  But I think that\'s fairly minor?  Also if you really\u003cbr\\/\u003e\\nneed a full deep copy of your reader you could just open a new one\u003cbr\\/\u003e\\n(ie, not use \\\"reopen\\\")?\u003c\\/p\u003e\\n\\n\u003cp\u003eI think the big upside of \\\"shared readers\\\" is reopening becomes quite\u003cbr\\/\u003e\\na bit more resource efficient: the cost of re-opening a reader would\u003cbr\\/\u003e\\nbe in proportion to what has actually changed in the index.  EG, if\u003cbr\\/\u003e\\nyour index has added a few tiny segments since you last opened then\u003cbr\\/\u003e\\nthe reopen would be extremely fas but with cloning you are forced\u003cbr\\/\u003e\\nto make a full deep copy of all other \u003cspan class=\\\"error\\\"\u003e&#91;unchanged&#93;\u003c\\/span\u003e segments.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12533213_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12533213_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Oct\\/07 22:15\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-08T22:15:09+0000\'\u003e08\\/Oct\\/07 22:15\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                   \\n &gt; We have to be very careful about cross-referencing multiple readers. \\n&gt; If for some reason any references between two or more readers are \\n&gt; not cleared after one was closed, then that reader might not become \\n&gt; GC\'d.  I\'m not saying it\'s not possible or even very hard, we just \\n&gt; have to make sure those things can\'t ever happen. \\n\\n One correction: there should be no cross-referencing, right?  The only \\nthing that\'s happening is incrementing &amp; decrementing the \\\"referrer \\ncount\\\" for a reader?  (But, you\'re right: the \\\"copy on write\\\" approach \\nto cloning would have cross-referencing). \\n\\n I think the downside of this proposed \\\"shared readers\\\" (non-cloning) \\napproach is that you can\'t delete\\/setNorm on the clone until you close \\nthe original.  But I think that\'s fairly minor?  Also if you really \\nneed a full deep copy of your reader you could just open a new one \\n(ie, not use \\\"reopen\\\")? \\n\\n I think the big upside of \\\"shared readers\\\" is reopening becomes quite \\na bit more resource efficient: the cost of re-opening a reader would \\nbe in proportion to what has actually changed in the index.  EG, if \\nyour index has added a few tiny segments since you last opened then \\nthe reopen would be extremely fas but with cloning you are forced \\nto make a full deep copy of all other  &#91;unchanged&#93;  segments.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12534123\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12534123&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12534123\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"hossman\\\" id=\\\"commentauthor_12534123_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=hossman\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"hossman\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Hoss Man\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12534123_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Oct\\/07 18:43\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-11T18:43:26+0000\'\u003e11\\/Oct\\/07 18:43\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\\n\u003cp\u003ein deciding \\\"to clone or not clone\\\" for the purposes of implementing reopen, it may make sense to step back and ask a two broader questions...\u003c\\/p\u003e\\n\\n\u003cp\u003e1) what was the motivation for approaching reopen using clones in the first place\u003cbr\\/\u003e\\n2) what does it inherently mean to clone an indexreader.\u003c\\/p\u003e\\n\\n\u003cp\u003ethe answer to the first question, as i understand it, relates to the issue of indexreaders not being \\\"read only\\\" object ... operations can be taken which modify the readers state, and those operations can be flushed to disk when the reader is closed.  so readerB = readerA.reopen(closeOld=false) and then readerA.delete(...) is called, there is ambiguity as to what should happen in readerB.  so the clone route seems pretty straight forward if and only if we have an unambiguous concept of cloning a reader (because then the clone approach to reopen becomes unambiguous as well).  alternately, since reopen is a new method, we can resolve the ambiguity anyway we want, as long as it\'s documented ... in theory we should pick a solution that seems to serve the most benefit ... perhaps that solution is to document reopen with \\\"if reopen(closeOld=false) returns a new reader it will share state with the current reader, attempting to do the following operations on this new reader will result in undefined behavior\\\"\u003c\\/p\u003e\\n\\n\u003cp\u003ethe answer the the second is only important if we want to go the cloning route ... but it is pretty important in a larger sense then just reopening ... f we start to say that any of the IndexReader classes are Clonable we have to be very clear about what that means in \u003cb\u003eall\u003c\\/b\u003e cases where someone might clone it in addition to reopen ... in particular, i worry about what it means to clone a reader which has already had \\\"write\\\" operations performed on it (something the clone based version of reopen will never do because a write operation indicates the reader must be current), but some client code might as soon as we add the Clonable interface to a class.\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"hossman\\\" id=\\\"commentauthor_12534123_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=hossman\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"hossman\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Hoss Man\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12534123_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Oct\\/07 18:43\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-11T18:43:26+0000\'\u003e11\\/Oct\\/07 18:43\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                   \\n in deciding \\\"to clone or not clone\\\" for the purposes of implementing reopen, it may make sense to step back and ask a two broader questions... \\n\\n 1) what was the motivation for approaching reopen using clones in the first place \\n2) what does it inherently mean to clone an indexreader. \\n\\n the answer to the first question, as i understand it, relates to the issue of indexreaders not being \\\"read only\\\" object ... operations can be taken which modify the readers state, and those operations can be flushed to disk when the reader is closed.  so readerB = readerA.reopen(closeOld=false) and then readerA.delete(...) is called, there is ambiguity as to what should happen in readerB.  so the clone route seems pretty straight forward if and only if we have an unambiguous concept of cloning a reader (because then the clone approach to reopen becomes unambiguous as well).  alternately, since reopen is a new method, we can resolve the ambiguity anyway we want, as long as it\'s documented ... in theory we should pick a solution that seems to serve the most benefit ... perhaps that solution is to document reopen with \\\"if reopen(closeOld=false) returns a new reader it will share state with the current reader, attempting to do the following operations on this new reader will result in undefined behavior\\\" \\n\\n the answer the the second is only important if we want to go the cloning route ... but it is pretty important in a larger sense then just reopening ... f we start to say that any of the IndexReader classes are Clonable we have to be very clear about what that means in  all  cases where someone might clone it in addition to reopen ... in particular, i worry about what it means to clone a reader which has already had \\\"write\\\" operations performed on it (something the clone based version of reopen will never do because a write operation indicates the reader must be current), but some client code might as soon as we add the Clonable interface to a class. \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12535335\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12535335&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12535335\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12535335_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12535335_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Oct\\/07 20:34\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-16T20:34:24+0000\'\u003e16\\/Oct\\/07 20:34\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e&gt; in deciding \\\"to clone or not clone\\\" for the purposes of implementing \u003cbr\\/\u003e\\n&gt; reopen, it may make sense to step back and ask a two broader questions...\u003c\\/p\u003e\\n\\n\u003cp\u003eI agree!\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; 1) what was the motivation for approaching reopen using clones in the \u003cbr\\/\u003e\\n&gt; first place\u003c\\/p\u003e\\n\\n\u003cp\u003eGood summarization! You are right, I started the clone approach because\u003cbr\\/\u003e\\nIndexReaders are not \\\"read only\\\" objects.\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; \\\"if reopen(closeOld=false) returns a new reader it will share state with \u003cbr\\/\u003e\\n&gt; the current reader, attempting to do the following operations on this \u003cbr\\/\u003e\\n&gt; new reader will result in undefined behavior\\\"\u003c\\/p\u003e\\n\\n\u003cp\u003eThis would mean, that we simply warn the user that performing write \u003cbr\\/\u003e\\noperations with the re-opened indexreader will result in undefined behavior,\u003cbr\\/\u003e\\nwhereas with Mike\'s approach we would prevent such an undefined behavior by \u003cbr\\/\u003e\\nusing reference counting.\u003c\\/p\u003e\\n\\n\u003cp\u003eHmm, so what are our long-term plans for indexreaders? If our goal is to \u003cbr\\/\u003e\\nmake them read-only (we can delete via IndexWriter already), then I think \u003cbr\\/\u003e\\nadding those warning comments to reopen(), as you suggest Hoss, would be \u003cbr\\/\u003e\\nsufficient. \u003c\\/p\u003e\\n\\n\u003cp\u003eIf everybody likes this approach I\'ll go ahead and submit a new patch.\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12535335_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12535335_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Oct\\/07 20:34\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-16T20:34:24+0000\'\u003e16\\/Oct\\/07 20:34\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    &gt; in deciding \\\"to clone or not clone\\\" for the purposes of implementing  \\n&gt; reopen, it may make sense to step back and ask a two broader questions... \\n\\n I agree! \\n\\n &gt; 1) what was the motivation for approaching reopen using clones in the  \\n&gt; first place \\n\\n Good summarization! You are right, I started the clone approach because \\nIndexReaders are not \\\"read only\\\" objects. \\n\\n &gt; \\\"if reopen(closeOld=false) returns a new reader it will share state with  \\n&gt; the current reader, attempting to do the following operations on this  \\n&gt; new reader will result in undefined behavior\\\" \\n\\n This would mean, that we simply warn the user that performing write  \\noperations with the re-opened indexreader will result in undefined behavior, \\nwhereas with Mike\'s approach we would prevent such an undefined behavior by  \\nusing reference counting. \\n\\n Hmm, so what are our long-term plans for indexreaders? If our goal is to  \\nmake them read-only (we can delete via IndexWriter already), then I think  \\nadding those warning comments to reopen(), as you suggest Hoss, would be  \\nsufficient.  \\n\\n If everybody likes this approach I\'ll go ahead and submit a new patch. \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12535342\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12535342&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12535342\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"cutting\\\" id=\\\"commentauthor_12535342_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=cutting\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"cutting\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Doug Cutting\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12535342_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Oct\\/07 20:51\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-16T20:51:22+0000\'\u003e16\\/Oct\\/07 20:51\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eHmm, so what are our long-term plans for indexreaders? If our goal is to\u003cbr\\/\u003e\\nmake them read-only (we can delete via IndexWriter already), then I think\u003cbr\\/\u003e\\nadding those warning comments to reopen(), as you suggest Hoss, would be\u003cbr\\/\u003e\\nsufficient.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI think that\'s a fine direction.  Note however that IndexWriter implements delete by calling IndexReader.delete().  That method could be made package-private, so that users cannot call it, but then this makes it impossible for someone to subclass IndexReader from a different package.  So perhaps delete() needs to move to a subclass of IndexReader?  That gets messy...\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"cutting\\\" id=\\\"commentauthor_12535342_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=cutting\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"cutting\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Doug Cutting\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12535342_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Oct\\/07 20:51\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-16T20:51:22+0000\'\u003e16\\/Oct\\/07 20:51\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n Hmm, so what are our long-term plans for indexreaders? If our goal is to \\nmake them read-only (we can delete via IndexWriter already), then I think \\nadding those warning comments to reopen(), as you suggest Hoss, would be \\nsufficient.  \\n\\n I think that\'s a fine direction.  Note however that IndexWriter implements delete by calling IndexReader.delete().  That method could be made package-private, so that users cannot call it, but then this makes it impossible for someone to subclass IndexReader from a different package.  So perhaps delete() needs to move to a subclass of IndexReader?  That gets messy...              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12535350\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12535350&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12535350\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12535350_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12535350_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Oct\\/07 21:24\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-16T21:24:13+0000\'\u003e16\\/Oct\\/07 21:24\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eI think that\'s a fine direction. Note however that IndexWriter implements delete by calling IndexReader.delete(). That method could be made package-private, so that users cannot call it, but then this makes it impossible for someone to subclass IndexReader from a different package. So perhaps delete() needs to move to a subclass of IndexReader? That gets messy...\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eActually all of the lock\\/commit logic moved from IndexReader to DirectoryIndexReader already, and the delete logic is in SegmentReader, which subclasses DirectoryIndexReader. So we could remove the deleteDocument() API from IndexReader but leave it in DirectoryIndexReader. Then it would still be possible to extend IndexReader from a different package just as today, and IndexWriter could use DirectoryIndexReader for performing deletes. These changes should be trivial.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12535350_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12535350_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Oct\\/07 21:24\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-16T21:24:13+0000\'\u003e16\\/Oct\\/07 21:24\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n I think that\'s a fine direction. Note however that IndexWriter implements delete by calling IndexReader.delete(). That method could be made package-private, so that users cannot call it, but then this makes it impossible for someone to subclass IndexReader from a different package. So perhaps delete() needs to move to a subclass of IndexReader? That gets messy...  \\n\\n Actually all of the lock\\/commit logic moved from IndexReader to DirectoryIndexReader already, and the delete logic is in SegmentReader, which subclasses DirectoryIndexReader. So we could remove the deleteDocument() API from IndexReader but leave it in DirectoryIndexReader. Then it would still be possible to extend IndexReader from a different package just as today, and IndexWriter could use DirectoryIndexReader for performing deletes. These changes should be trivial.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12535352\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12535352&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12535352\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"cutting\\\" id=\\\"commentauthor_12535352_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=cutting\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"cutting\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Doug Cutting\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12535352_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Oct\\/07 21:33\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-16T21:33:04+0000\'\u003e16\\/Oct\\/07 21:33\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eGot it.  IndexWriter only works with SegmentReaders anyway, not with an arbitrary IndexReader implementation: IndexReader is extensible, but IndexWriter is not.  I\'d (momentarily) forgotten that.  Nevermind.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"cutting\\\" id=\\\"commentauthor_12535352_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=cutting\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"cutting\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Doug Cutting\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12535352_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Oct\\/07 21:33\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-16T21:33:04+0000\'\u003e16\\/Oct\\/07 21:33\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Got it.  IndexWriter only works with SegmentReaders anyway, not with an arbitrary IndexReader implementation: IndexReader is extensible, but IndexWriter is not.  I\'d (momentarily) forgotten that.  Nevermind.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12535354\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12535354&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12535354\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12535354_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12535354_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Oct\\/07 21:40\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-16T21:40:11+0000\'\u003e16\\/Oct\\/07 21:40\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHaving a read-only IndexReader would (should?) mean being able to remove \\\"synchronized\\\" from some things like isDeleted()... a nice performance win for multi-processor systems for things that didn\'t have access to the deleted-docs bitvec.\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; If our goal is to make them read-only (we can delete via IndexWriter already)\u003c\\/p\u003e\\n\\n\u003cp\u003eBut you can only delete-by-term.\u003cbr\\/\u003e\\nIt\'s more powerful to be able to delete by docid, however I manage to come up with it.\u003cbr\\/\u003e\\nSo I think deleteDocument(int id) should either be moved to a subclass.  same with setNorms?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12535354_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12535354_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Oct\\/07 21:40\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-16T21:40:11+0000\'\u003e16\\/Oct\\/07 21:40\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Having a read-only IndexReader would (should?) mean being able to remove \\\"synchronized\\\" from some things like isDeleted()... a nice performance win for multi-processor systems for things that didn\'t have access to the deleted-docs bitvec. \\n\\n &gt; If our goal is to make them read-only (we can delete via IndexWriter already) \\n\\n But you can only delete-by-term. \\nIt\'s more powerful to be able to delete by docid, however I manage to come up with it. \\nSo I think deleteDocument(int id) should either be moved to a subclass.  same with setNorms?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12535362\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12535362&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12535362\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12535362_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12535362_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Oct\\/07 22:29\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-16T22:29:00+0000\'\u003e16\\/Oct\\/07 22:29\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eSo I think deleteDocument(int id) should either be moved to a subclass. same with setNorms?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eOr we could take the approach you suggested in \u003ca href=\\\"http:\\/\\/www.gossamer-threads.com\\/lists\\/lucene\\/java-dev\\/52017\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttp:\\/\\/www.gossamer-threads.com\\/lists\\/lucene\\/java-dev\\/52017\u003c\\/a\u003e.\u003c\\/p\u003e\\n\\n\u003cp\u003eThat would mean to add a callback after flush to get a current IndexReader to get the docids and to use the IndexWriter then to perform deleteDocument(docId) or setNorm(). These methods could also take an IndexReader as argument, e. g. deleteDocument(IndexReader reader, int docId), which would throw an IOException if the passed in reader is stale (i. e. docids have changed since the reader was opened). Just as IndexReader does it today. Does this make sense or am I missing something?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12535362_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12535362_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Oct\\/07 22:29\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-16T22:29:00+0000\'\u003e16\\/Oct\\/07 22:29\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n So I think deleteDocument(int id) should either be moved to a subclass. same with setNorms?  \\n\\n Or we could take the approach you suggested in  http:\\/\\/www.gossamer-threads.com\\/lists\\/lucene\\/java-dev\\/52017 . \\n\\n That would mean to add a callback after flush to get a current IndexReader to get the docids and to use the IndexWriter then to perform deleteDocument(docId) or setNorm(). These methods could also take an IndexReader as argument, e. g. deleteDocument(IndexReader reader, int docId), which would throw an IOException if the passed in reader is stale (i. e. docids have changed since the reader was opened). Just as IndexReader does it today. Does this make sense or am I missing something?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12535669\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12535669&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12535669\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12535669_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12535669_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Oct\\/07 18:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-17T18:35:47+0000\'\u003e17\\/Oct\\/07 18:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI just opened \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-1030\\\" title=\\\"&quot;Read-only&quot; IndexReaders\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-1030\\\"\u003e\u003cdel\u003eLUCENE-1030\u003c\\/del\u003e\u003c\\/a\u003e and would like to move discussions related to \\\"read-only\\\" IndexReaders to that issue.\u003c\\/p\u003e\\n\\n\u003cp\u003eAs for reopen() I\'d like to go with Hoss\' suggestion for now and add warning comments to reopen() saying that using an re-opened IndexReader with closeOldReader==false for write operations will result in an undefined behavior. Any objections?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12535669_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12535669_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Oct\\/07 18:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-17T18:35:47+0000\'\u003e17\\/Oct\\/07 18:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I just opened   LUCENE-1030   and would like to move discussions related to \\\"read-only\\\" IndexReaders to that issue. \\n\\n As for reopen() I\'d like to go with Hoss\' suggestion for now and add warning comments to reopen() saying that using an re-opened IndexReader with closeOldReader==false for write operations will result in an undefined behavior. Any objections?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12535743\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12535743&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12535743\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12535743_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12535743_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Oct\\/07 21:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-17T21:02:00+0000\'\u003e17\\/Oct\\/07 21:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eAs for reopen() I\'d like to go with Hoss\' suggestion for now and add warning comments to reopen() saying that using an re-opened IndexReader with closeOldReader==false for write operations will result in an undefined behavior.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eHow about just defining the behavior such that any pending changes are flushed.  That would make it more useful because you could then reopen readers you used for deletes.  An alternative would be a method to explicitly flush changes on a reader, giving one the ability to then reopen it, but  I like the former better since it avoids adding another API call.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12535743_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12535743_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Oct\\/07 21:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-17T21:02:00+0000\'\u003e17\\/Oct\\/07 21:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n As for reopen() I\'d like to go with Hoss\' suggestion for now and add warning comments to reopen() saying that using an re-opened IndexReader with closeOldReader==false for write operations will result in an undefined behavior.  \\n\\n How about just defining the behavior such that any pending changes are flushed.  That would make it more useful because you could then reopen readers you used for deletes.  An alternative would be a method to explicitly flush changes on a reader, giving one the ability to then reopen it, but  I like the former better since it avoids adding another API call.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12535753\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12535753&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12535753\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12535753_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12535753_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Oct\\/07 21:23\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-17T21:23:30+0000\'\u003e17\\/Oct\\/07 21:23\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eHow about just defining the behavior such that any pending changes are flushed. That would make it more useful because you could then reopen readers you used for deletes.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eHmm, I\'m not sure I understand. A reader which is being used for deletes or setting norms is always current (it owns the write lock), so there should never be the need to re-open such a reader.\u003c\\/p\u003e\\n\\n\u003cp\u003eHowever, if you re-open an existing reader which was not used for deletes before and use the new instance (b) to perform deletes, it will result in a undefined behavior for the old reader (a):\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003eIndexReader a = .....\\n....\\nIndexReader b = a.reopen();\\nb.deleteDocument(...);\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12535753_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12535753_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Oct\\/07 21:23\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-17T21:23:30+0000\'\u003e17\\/Oct\\/07 21:23\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n How about just defining the behavior such that any pending changes are flushed. That would make it more useful because you could then reopen readers you used for deletes.  \\n\\n Hmm, I\'m not sure I understand. A reader which is being used for deletes or setting norms is always current (it owns the write lock), so there should never be the need to re-open such a reader. \\n\\n However, if you re-open an existing reader which was not used for deletes before and use the new instance (b) to perform deletes, it will result in a undefined behavior for the old reader (a): \\n\\n  \\n IndexReader a = .....\\n....\\nIndexReader b = a.reopen();\\nb.deleteDocument(...);\\n \\n               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12535970\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12535970&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12535970\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12535970_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12535970_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Oct\\/07 16:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-18T16:55:12+0000\'\u003e18\\/Oct\\/07 16:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eA reader which is being used for deletes or setting norms is always current (it owns the write lock), so there should never be the need to re-open such a reader.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI was thinking about the \\\"add some docs\\\" then \\\"delete some docs\\\" scenario:\u003cbr\\/\u003e\\nOne currently needs to close() the deleting reader to open an IndexWriter.  If IndexReader.commit() was public, then one could simply flush changes, and then call reopen() after the IndexWriter was done adding new documents.  But perhaps longer term, all deletions should be done via the IndexWriter anyway.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eif you re-open an existing reader which was not used for deletes before and use the new instance (b) to perform deletes\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eAh, thanks for that clarification.  I guess that should remain undefined.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12535970_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12535970_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Oct\\/07 16:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-18T16:55:12+0000\'\u003e18\\/Oct\\/07 16:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n A reader which is being used for deletes or setting norms is always current (it owns the write lock), so there should never be the need to re-open such a reader.  \\n\\n I was thinking about the \\\"add some docs\\\" then \\\"delete some docs\\\" scenario: \\nOne currently needs to close() the deleting reader to open an IndexWriter.  If IndexReader.commit() was public, then one could simply flush changes, and then call reopen() after the IndexWriter was done adding new documents.  But perhaps longer term, all deletions should be done via the IndexWriter anyway. \\n\\n \\n if you re-open an existing reader which was not used for deletes before and use the new instance (b) to perform deletes  \\n\\n Ah, thanks for that clarification.  I guess that should remain undefined.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12536028\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12536028&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12536028\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12536028_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536028_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Oct\\/07 19:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-18T19:49:19+0000\'\u003e18\\/Oct\\/07 19:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHmm one other thing: how should IndexReader.close() work? If we re-open a reader (a is the old reader, b is the new one), and then someone calls a.close(), then a should not close any resources that it shares with b. \u003c\\/p\u003e\\n\\n\u003cp\u003eOne way to make this work would be reference counting. Since we want to avoid that, we could simply restrict reopen() from being called twice for the same reader. Then there would never be more than 2 readers sharing the same ressources. The old reader a would remember that reopen() was called already and would not close the shared ressources on close(). However, the new reader b would close all ressources, meaning that reader a would not work anymore after b.close() was called. \u003cbr\\/\u003e\\nThoughts?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12536028_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536028_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Oct\\/07 19:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-18T19:49:19+0000\'\u003e18\\/Oct\\/07 19:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Hmm one other thing: how should IndexReader.close() work? If we re-open a reader (a is the old reader, b is the new one), and then someone calls a.close(), then a should not close any resources that it shares with b.  \\n\\n One way to make this work would be reference counting. Since we want to avoid that, we could simply restrict reopen() from being called twice for the same reader. Then there would never be more than 2 readers sharing the same ressources. The old reader a would remember that reopen() was called already and would not close the shared ressources on close(). However, the new reader b would close all ressources, meaning that reader a would not work anymore after b.close() was called.  \\nThoughts?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12536033\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12536033&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12536033\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12536033_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536033_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Oct\\/07 20:03\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-18T20:03:05+0000\'\u003e18\\/Oct\\/07 20:03\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI think reference counting would solve this issue quite nicely.  How come we want to avoid reference counting?  It seems like the right solution here.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe implementation seems simple.  When a reader is opened, it starts with RC 1.  When it is closed, it decrefs the RC and marks itself closed (to make sure double-close does not re-decref the RC).  When a MultiReader needs to use the reader, it calls incref.  And when that MultiReader is done with it, it calls decref.  Whenever the RC hits 0 it\'s safe to free all resources.\u003c\\/p\u003e\\n\\n\u003cp\u003eWouldn\'t that work?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12536033_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536033_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Oct\\/07 20:03\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-18T20:03:05+0000\'\u003e18\\/Oct\\/07 20:03\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I think reference counting would solve this issue quite nicely.  How come we want to avoid reference counting?  It seems like the right solution here. \\n\\n The implementation seems simple.  When a reader is opened, it starts with RC 1.  When it is closed, it decrefs the RC and marks itself closed (to make sure double-close does not re-decref the RC).  When a MultiReader needs to use the reader, it calls incref.  And when that MultiReader is done with it, it calls decref.  Whenever the RC hits 0 it\'s safe to free all resources. \\n\\n Wouldn\'t that work?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12536041\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12536041&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12536041\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12536041_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536041_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Oct\\/07 20:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-18T20:35:03+0000\'\u003e18\\/Oct\\/07 20:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e&gt; When it is closed, it decrefs the RC and marks itself closed (to make sure double-close does not re-decref the RC)\u003c\\/p\u003e\\n\\n\u003cp\u003eBut if a reader is shared, how do you tell two real closes from an erronous double-close?  \u003cbr\\/\u003e\\nPerhaps have a top level close() that is only invoked once via isClosed, and a projected doClose() that a multi-reader would use that actually does the decref?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12536041_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536041_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Oct\\/07 20:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-18T20:35:03+0000\'\u003e18\\/Oct\\/07 20:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    &gt; When it is closed, it decrefs the RC and marks itself closed (to make sure double-close does not re-decref the RC) \\n\\n But if a reader is shared, how do you tell two real closes from an erronous double-close?   \\nPerhaps have a top level close() that is only invoked once via isClosed, and a projected doClose() that a multi-reader would use that actually does the decref?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12536044\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12536044&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12536044\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12536044_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536044_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Oct\\/07 20:43\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-18T20:43:57+0000\'\u003e18\\/Oct\\/07 20:43\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eThe implementation seems simple. When a reader is opened, it starts with RC 1. When it is closed, it decrefs the RC and marks itself closed (to make sure double-close does not re-decref the RC). When a MultiReader needs to use the reader, it calls incref. And when that MultiReader is done with it, it calls decref. Whenever the RC hits 0 it\'s safe to free all resources.\u003c\\/p\u003e\\n\\n\u003cp\u003eWouldn\'t that work?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYou\'re right, for a MultiReader and ParallelReader this would work and wouldn\'t be hard to implement. \u003c\\/p\u003e\\n\\n\u003cp\u003eIt is quite different when it comes to SegmentReaders. SegmentReader.reopen() checks SegmentInfos if there is a segment with the same name but newer normGen or delGen. If there is one then a new SegmentReader instance is created that reuses resources like e. g. TermInfosReader and loads the new generation of the del or norm file.\u003c\\/p\u003e\\n\\n\u003cp\u003eNow you can end up having a bunch of SegmentReaders that share the same resources but don\'t know about each other. The reference counting would have to happen somewhere else, e. g. in the TermInfosReader. Of course this is doable, but it\'s a special case and more complicated compared to the \\\"restrict reopen() to only be called once\\\"-approach.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12536044_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536044_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Oct\\/07 20:43\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-18T20:43:57+0000\'\u003e18\\/Oct\\/07 20:43\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n The implementation seems simple. When a reader is opened, it starts with RC 1. When it is closed, it decrefs the RC and marks itself closed (to make sure double-close does not re-decref the RC). When a MultiReader needs to use the reader, it calls incref. And when that MultiReader is done with it, it calls decref. Whenever the RC hits 0 it\'s safe to free all resources. \\n\\n Wouldn\'t that work?  \\n\\n You\'re right, for a MultiReader and ParallelReader this would work and wouldn\'t be hard to implement.  \\n\\n It is quite different when it comes to SegmentReaders. SegmentReader.reopen() checks SegmentInfos if there is a segment with the same name but newer normGen or delGen. If there is one then a new SegmentReader instance is created that reuses resources like e. g. TermInfosReader and loads the new generation of the del or norm file. \\n\\n Now you can end up having a bunch of SegmentReaders that share the same resources but don\'t know about each other. The reference counting would have to happen somewhere else, e. g. in the TermInfosReader. Of course this is doable, but it\'s a special case and more complicated compared to the \\\"restrict reopen() to only be called once\\\"-approach.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12536063\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12536063&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12536063\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12536063_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536063_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Oct\\/07 21:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-18T21:53:38+0000\'\u003e18\\/Oct\\/07 21:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e&gt; But if a reader is shared, how do you tell two real closes from an erronous double-close?\u003cbr\\/\u003e\\n&gt; Perhaps have a top level close() that is only invoked once via isClosed, and a projected doClose() that a multi-reader would use that actually does the decref?\u003c\\/p\u003e\\n\\n\u003cp\u003eYes I think that\'s the right approach.\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; It is quite different when it comes to SegmentReaders. SegmentReader.reopen() checks SegmentInfos if there is a segment with the same name but newer normGen or delGen. If there is one then a new SegmentReader instance is created that reuses resources like e. g. TermInfosReader and loads the new generation of the del or norm file.\u003cbr\\/\u003e\\n&gt;\u003cbr\\/\u003e\\n&gt; Now you can end up having a bunch of SegmentReaders that share the same resources but don\'t know about each other. The reference counting would have to happen somewhere else, e. g. in the TermInfosReader. Of course this is doable, but it\'s a special case and more complicated compared to the \\\"restrict reopen() to only be called once\\\"-approach.\u003c\\/p\u003e\\n\\n\u003cp\u003eFor SegmentReader, I think on reopen(), everything would be shared\u003cbr\\/\u003e\\nexcept norms and\\/or deletedDocs right?  In which case couldn\'t all\u003cbr\\/\u003e\\ncascaded reopens hold onto the original SegmentReader &amp; call doClose()\u003cbr\\/\u003e\\non it when they are closed?  (Ie it is the \\\"owner\\\" of all the shared\u003cbr\\/\u003e\\nparts of a SegmentReader).  Then, deletedDocs needs no protection (it\u003cbr\\/\u003e\\nhas no close()), and for Norms we could push the reference counting\u003cbr\\/\u003e\\ndown into it as well?\u003c\\/p\u003e\\n\\n\u003cp\u003eWe wouldn\'t need to push reference counting into all the readers that\u003cbr\\/\u003e\\na SegmentReader holds because those are always shared when a\u003cbr\\/\u003e\\nSegmentReader is reopened?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12536063_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536063_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Oct\\/07 21:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-18T21:53:38+0000\'\u003e18\\/Oct\\/07 21:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    &gt; But if a reader is shared, how do you tell two real closes from an erronous double-close? \\n&gt; Perhaps have a top level close() that is only invoked once via isClosed, and a projected doClose() that a multi-reader would use that actually does the decref? \\n\\n Yes I think that\'s the right approach. \\n\\n &gt; It is quite different when it comes to SegmentReaders. SegmentReader.reopen() checks SegmentInfos if there is a segment with the same name but newer normGen or delGen. If there is one then a new SegmentReader instance is created that reuses resources like e. g. TermInfosReader and loads the new generation of the del or norm file. \\n&gt; \\n&gt; Now you can end up having a bunch of SegmentReaders that share the same resources but don\'t know about each other. The reference counting would have to happen somewhere else, e. g. in the TermInfosReader. Of course this is doable, but it\'s a special case and more complicated compared to the \\\"restrict reopen() to only be called once\\\"-approach. \\n\\n For SegmentReader, I think on reopen(), everything would be shared \\nexcept norms and\\/or deletedDocs right?  In which case couldn\'t all \\ncascaded reopens hold onto the original SegmentReader &amp; call doClose() \\non it when they are closed?  (Ie it is the \\\"owner\\\" of all the shared \\nparts of a SegmentReader).  Then, deletedDocs needs no protection (it \\nhas no close()), and for Norms we could push the reference counting \\ndown into it as well? \\n\\n We wouldn\'t need to push reference counting into all the readers that \\na SegmentReader holds because those are always shared when a \\nSegmentReader is reopened?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12536353\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12536353&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12536353\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12536353_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536353_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Oct\\/07 21:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-19T21:49:45+0000\'\u003e19\\/Oct\\/07 21:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Michael Busch - 20\\/Oct\\/07 10:11\\\"\u003eedited\u003c\\/span\u003e \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHi Mike,\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'m not sure if I fully understand your comment. Consider the following (quite constructed) example:\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003eIndexReader reader1 = IndexReader.open(index1);  \u003cspan class=\\\"code-comment\\\"\u003e\\/\\/ optimized index, reader1 is a SegmentReader\\n\u003c\\/span\u003eIndexReader multiReader1 = \u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e MultiReader(\u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e IndexReader[] {reader1, IndexReader.open(index2)});\\n... \u003cspan class=\\\"code-comment\\\"\u003e\\/\\/ modify index2\\n\u003c\\/span\u003eIndexReader multiReader2 = multiReader1.reopen();  \\n\u003cspan class=\\\"code-comment\\\"\u003e\\/\\/ only index2 changed, so multiReader2 uses reader1 and has to increment the refcount of reader1\\n\u003c\\/span\u003e... \u003cspan class=\\\"code-comment\\\"\u003e\\/\\/ modify index1\\n\u003c\\/span\u003eIndexReader reader2 = reader1.reopen();\\n\u003cspan class=\\\"code-comment\\\"\u003e\\/\\/ reader2 is a \u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e instance of SegmentReader that shares resources with reader1\\n\u003c\\/span\u003e... \u003cspan class=\\\"code-comment\\\"\u003e\\/\\/ modify index1\\n\u003c\\/span\u003eIndexReader reader3 = reader2.reopen();\\n\u003cspan class=\\\"code-comment\\\"\u003e\\/\\/ reader3 is a \u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e instance of SegmentReader that shares resources with reader1 and reader2\u003c\\/span\u003e\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\\n\u003cp\u003eNow the user closes the readers in this order:\u003c\\/p\u003e\\n\u003col\u003e\\n\\t\u003cli\u003emultiReader1.close();\u003c\\/li\u003e\\n\\t\u003cli\u003emultiReader2.close();\u003c\\/li\u003e\\n\\t\u003cli\u003ereader2.close();\u003c\\/li\u003e\\n\\t\u003cli\u003ereader3.close();\u003c\\/li\u003e\\n\u003c\\/ol\u003e\\n\\n\\n\u003cp\u003ereader1 should be marked as closed after 2., right? Because multiReader1.close() and multiReader2.close() have to decrement reader1\'s refcount. But the underlying files have to remain open until after 4., because reader2 and reader3 use reader1\'s resources.\u003c\\/p\u003e\\n\\n\u003cp\u003eSo don\'t we need 2 refcount values in reader1? One that tells us when the reader itself can be marked as closed, and one that tells when the resources can be closed? Then multiReader1 and multiReader2 would decrement the first refCount, whereas reader2 and reader3 both have to \\\"know\\\" reader1, so that they can decrement the second refcount.\u003c\\/p\u003e\\n\\n\u003cp\u003eI hope I\'m just completely confused now and someone tells me that the whole thing is much simpler \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12536353_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536353_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Oct\\/07 21:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-19T21:49:45+0000\'\u003e19\\/Oct\\/07 21:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Michael Busch - 20\\/Oct\\/07 10:11\\\"\u003eedited\u003c\\/span\u003e                   Hi Mike, \\n\\n I\'m not sure if I fully understand your comment. Consider the following (quite constructed) example: \\n\\n  \\n IndexReader reader1 = IndexReader.open(index1);   \\/\\/ optimized index, reader1 is a SegmentReader\\n IndexReader multiReader1 =  new  MultiReader( new  IndexReader[] {reader1, IndexReader.open(index2)});\\n...  \\/\\/ modify index2\\n IndexReader multiReader2 = multiReader1.reopen();  \\n \\/\\/ only index2 changed, so multiReader2 uses reader1 and has to increment the refcount of reader1\\n ...  \\/\\/ modify index1\\n IndexReader reader2 = reader1.reopen();\\n \\/\\/ reader2 is a  new  instance of SegmentReader that shares resources with reader1\\n ...  \\/\\/ modify index1\\n IndexReader reader3 = reader2.reopen();\\n \\/\\/ reader3 is a  new  instance of SegmentReader that shares resources with reader1 and reader2 \\n \\n  \\n\\n Now the user closes the readers in this order: \\n \\n\\t multiReader1.close(); \\n\\t multiReader2.close(); \\n\\t reader2.close(); \\n\\t reader3.close(); \\n \\n\\n\\n reader1 should be marked as closed after 2., right? Because multiReader1.close() and multiReader2.close() have to decrement reader1\'s refcount. But the underlying files have to remain open until after 4., because reader2 and reader3 use reader1\'s resources. \\n\\n So don\'t we need 2 refcount values in reader1? One that tells us when the reader itself can be marked as closed, and one that tells when the resources can be closed? Then multiReader1 and multiReader2 would decrement the first refCount, whereas reader2 and reader3 both have to \\\"know\\\" reader1, so that they can decrement the second refcount. \\n\\n I hope I\'m just completely confused now and someone tells me that the whole thing is much simpler   \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12536409\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12536409&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12536409\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12536409_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536409_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Oct\\/07 09:09\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-20T09:09:31+0000\'\u003e20\\/Oct\\/07 09:09\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eIt\'s not nearly this complex (we don\'t need two ref counts). If we\u003cbr\\/\u003e\\nfollow the simple rule that \\\"every time reader X wants to use reader\u003cbr\\/\u003e\\nY, it increfs it\\\" and \\\"whenver reader X is done using reader Y, it\u003cbr\\/\u003e\\ndecrefs it\\\",  all should work correctly.\u003c\\/p\u003e\\n\\n\u003cp\u003eAlso we should think of \\\"close()\\\" as the way that the external user\u003cbr\\/\u003e\\ndoes the decref of their reader.  We just special-case this call, by\u003cbr\\/\u003e\\nsetting isOpen=false, to make sure we don\'t double decref on a double\u003cbr\\/\u003e\\nclose call.\u003c\\/p\u003e\\n\\n\u003cp\u003eLet\'s walk through your example...\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'m assuming in your example you meant for reader2 and reader3 to also\u003cbr\\/\u003e\\nbe SegmentReaders?  Ie, the changes that are happening to the\u003cbr\\/\u003e\\nsingle-segment index1 are just changes to norms and\\/or deletes.  If\u003cbr\\/\u003e\\nnot, the example is less interesting because reader1 will be closed\u003cbr\\/\u003e\\nsooner \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eAlso in your example let\'s insert missing \\\"reader1.close()\\\" as the\u003cbr\\/\u003e\\nvery first close?  (Else it will never be closed because it\'s RC never\u003cbr\\/\u003e\\nhits 0).\u003c\\/p\u003e\\n\\n\u003cp\u003eWhen reader1 is created it has RC 1.\u003c\\/p\u003e\\n\\n\u003cp\u003eWhen multiReader1 is created, reader1 now has RC 2.\u003c\\/p\u003e\\n\\n\u003cp\u003eWhen multiReader2 is created, reader1 now has RC 3.\u003c\\/p\u003e\\n\\n\u003cp\u003eWhen reader2 is created (by reader1.reopen()), it incref\'s reader1\u003cbr\\/\u003e\\nbecause it\'s sharing the sub-readers in reader1.  So reader1 now has\u003cbr\\/\u003e\\nRC 4.\u003c\\/p\u003e\\n\\n\u003cp\u003eWhen reader3 was created (by reader2.reopen()), it incref\'s reader2\u003cbr\\/\u003e\\nbecause it\'s sharing the sub-readers reader2 contains.  So reader1 is\u003cbr\\/\u003e\\nstill at RC 4 and reader2 is now at RC 2.\u003c\\/p\u003e\\n\\n\u003cp\u003eNow, we close.\u003c\\/p\u003e\\n\\n\u003cp\u003eAfter reader1.close() is called, reader1 sets isOpen=false (to prevent\u003cbr\\/\u003e\\ndouble close by the user) and RC drops to 3.\u003c\\/p\u003e\\n\\n\u003cp\u003eWith multiReader1.close(), multiReader1 is not at RC 0, and so it\u003cbr\\/\u003e\\ndecrefs all readers it was using, and so reader1 RC is now 2.\u003c\\/p\u003e\\n\\n\u003cp\u003eWith multiReader2.close(), likewise it is now at RC 0 and so it\u003cbr\\/\u003e\\ndecrefs all readers it was using, and so reader1 RC is now 1.\u003c\\/p\u003e\\n\\n\u003cp\u003eWith reader2.close(), it decrefs its own RC, however that brings its\u003cbr\\/\u003e\\nRC to 1 (reader3 is still referring to it) and so it does not decref\u003cbr\\/\u003e\\nthe reader1 that it\'s referring to.\u003c\\/p\u003e\\n\\n\u003cp\u003eFinally, with reader3.close(), it is now at RC 0 and so it decrefs the\u003cbr\\/\u003e\\nreader2 it refers to.  This brings reader2\'s RC to 0, and so reader2\u003cbr\\/\u003e\\ndecrefs the reader1 that it\'s referring to.  Which brings reader1\'s RC\u003cbr\\/\u003e\\nto 0, and so reader1 finally closes all its internal sub-readers.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12536409_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536409_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Oct\\/07 09:09\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-20T09:09:31+0000\'\u003e20\\/Oct\\/07 09:09\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    It\'s not nearly this complex (we don\'t need two ref counts). If we \\nfollow the simple rule that \\\"every time reader X wants to use reader \\nY, it increfs it\\\" and \\\"whenver reader X is done using reader Y, it \\ndecrefs it\\\",  all should work correctly. \\n\\n Also we should think of \\\"close()\\\" as the way that the external user \\ndoes the decref of their reader.  We just special-case this call, by \\nsetting isOpen=false, to make sure we don\'t double decref on a double \\nclose call. \\n\\n Let\'s walk through your example... \\n\\n I\'m assuming in your example you meant for reader2 and reader3 to also \\nbe SegmentReaders?  Ie, the changes that are happening to the \\nsingle-segment index1 are just changes to norms and\\/or deletes.  If \\nnot, the example is less interesting because reader1 will be closed \\nsooner   \\n\\n Also in your example let\'s insert missing \\\"reader1.close()\\\" as the \\nvery first close?  (Else it will never be closed because it\'s RC never \\nhits 0). \\n\\n When reader1 is created it has RC 1. \\n\\n When multiReader1 is created, reader1 now has RC 2. \\n\\n When multiReader2 is created, reader1 now has RC 3. \\n\\n When reader2 is created (by reader1.reopen()), it incref\'s reader1 \\nbecause it\'s sharing the sub-readers in reader1.  So reader1 now has \\nRC 4. \\n\\n When reader3 was created (by reader2.reopen()), it incref\'s reader2 \\nbecause it\'s sharing the sub-readers reader2 contains.  So reader1 is \\nstill at RC 4 and reader2 is now at RC 2. \\n\\n Now, we close. \\n\\n After reader1.close() is called, reader1 sets isOpen=false (to prevent \\ndouble close by the user) and RC drops to 3. \\n\\n With multiReader1.close(), multiReader1 is not at RC 0, and so it \\ndecrefs all readers it was using, and so reader1 RC is now 2. \\n\\n With multiReader2.close(), likewise it is now at RC 0 and so it \\ndecrefs all readers it was using, and so reader1 RC is now 1. \\n\\n With reader2.close(), it decrefs its own RC, however that brings its \\nRC to 1 (reader3 is still referring to it) and so it does not decref \\nthe reader1 that it\'s referring to. \\n\\n Finally, with reader3.close(), it is now at RC 0 and so it decrefs the \\nreader2 it refers to.  This brings reader2\'s RC to 0, and so reader2 \\ndecrefs the reader1 that it\'s referring to.  Which brings reader1\'s RC \\nto 0, and so reader1 finally closes all its internal sub-readers.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12536413\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12536413&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12536413\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12536413_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536413_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Oct\\/07 09:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-20T09:46:35+0000\'\u003e20\\/Oct\\/07 09:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eI\'m assuming in your example you meant for reader2 and reader3 to also\u003cbr\\/\u003e\\nbe SegmentReaders?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\u003cp\u003eYes that\'s what I meant. Sorry, I didn\'t make that clear.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eAlso in your example let\'s insert missing \\\"reader1.close()\\\" as the\u003cbr\\/\u003e\\nvery first close? (Else it will never be closed because it\'s RC never\u003cbr\\/\u003e\\nhits 0).\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\u003cp\u003eDoesn\'t what you describe change the semantics of MultiReader.close()?\u003c\\/p\u003e\\n\\n\u003cp\u003eIf you do:\u003c\\/p\u003e\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003eIndexReader reader1 = IndexReader.open(index1);  \\nIndexReader multiReader1 = \u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e MultiReader(\u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e IndexReader[] {reader1, IndexReader.open(index2)});\\nmultiReader1.close();\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\\n\u003cp\u003ethen today multiReader1.close() also closes reader1. That\'s why I consciously omitted reader1.close().\u003c\\/p\u003e\\n\\n\u003cp\u003eConsequently, if you do\u003c\\/p\u003e\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003eIndexReader reader1 = IndexReader.open(index1);  \\nIndexReader multiReader1 = \u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e MultiReader(\u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e IndexReader[] {reader1, IndexReader.open(index2)});\\nIndexReader multiReader2 = \u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e MultiReader(\u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e IndexReader[] {reader1, IndexReader.open(index3)});\\nmultiReader1.close();\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\u003cp\u003ethen multiReader2 is not usable anymore, because multiReader1.close() closes reader1. But that can be explicitly avoided by the user because it\'s known that multiReader1 and multiReader2 share the same reader.\u003c\\/p\u003e\\n\\n\u003cp\u003eNow, with the reopen() code:\u003c\\/p\u003e\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003eIndexReader reader1 = IndexReader.open(index1);  \u003cspan class=\\\"code-comment\\\"\u003e\\/\\/ optimized index, reader1 is a SegmentReader\\n\u003c\\/span\u003eIndexReader multiReader1 = \u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e MultiReader(\u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e IndexReader[] {reader1, IndexReader.open(index2)});\\n... \u003cspan class=\\\"code-comment\\\"\u003e\\/\\/ modify index2\\n\u003c\\/span\u003eIndexReader multiReader2 = multiReader1.reopen();  \\n\u003cspan class=\\\"code-comment\\\"\u003e\\/\\/ only index2 changed, so multiReader2 uses reader1 and has to increment the refcount of reader1\u003c\\/span\u003e\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\u003cp\u003eThe user gets a new reader instance from multiReader.reopen(), but can\'t tell which of the subreaders has been reopened and which are shared. That\'s why multiReader1.close() should not close reader1 in this case and we need refcounting in order to make this work.\u003c\\/p\u003e\\n\\n\u003cp\u003eSo do you suggest that a MultiReader should increment the refcounts when it is opened as well (in the constructor)? I believe we can implement it like this, but as I said it changes the semantics of MultiReader.close() (and ParallelReader.close() is, I believe, the same). A user would then have to close subreaders manually.\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12536413_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536413_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Oct\\/07 09:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-20T09:46:35+0000\'\u003e20\\/Oct\\/07 09:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n I\'m assuming in your example you meant for reader2 and reader3 to also \\nbe SegmentReaders?  \\n Yes that\'s what I meant. Sorry, I didn\'t make that clear. \\n\\n \\n Also in your example let\'s insert missing \\\"reader1.close()\\\" as the \\nvery first close? (Else it will never be closed because it\'s RC never \\nhits 0).  \\n Doesn\'t what you describe change the semantics of MultiReader.close()? \\n\\n If you do: \\n  \\n IndexReader reader1 = IndexReader.open(index1);  \\nIndexReader multiReader1 =  new  MultiReader( new  IndexReader[] {reader1, IndexReader.open(index2)});\\nmultiReader1.close();\\n \\n  \\n\\n then today multiReader1.close() also closes reader1. That\'s why I consciously omitted reader1.close(). \\n\\n Consequently, if you do \\n  \\n IndexReader reader1 = IndexReader.open(index1);  \\nIndexReader multiReader1 =  new  MultiReader( new  IndexReader[] {reader1, IndexReader.open(index2)});\\nIndexReader multiReader2 =  new  MultiReader( new  IndexReader[] {reader1, IndexReader.open(index3)});\\nmultiReader1.close();\\n \\n  \\n then multiReader2 is not usable anymore, because multiReader1.close() closes reader1. But that can be explicitly avoided by the user because it\'s known that multiReader1 and multiReader2 share the same reader. \\n\\n Now, with the reopen() code: \\n  \\n IndexReader reader1 = IndexReader.open(index1);   \\/\\/ optimized index, reader1 is a SegmentReader\\n IndexReader multiReader1 =  new  MultiReader( new  IndexReader[] {reader1, IndexReader.open(index2)});\\n...  \\/\\/ modify index2\\n IndexReader multiReader2 = multiReader1.reopen();  \\n \\/\\/ only index2 changed, so multiReader2 uses reader1 and has to increment the refcount of reader1 \\n \\n  \\n The user gets a new reader instance from multiReader.reopen(), but can\'t tell which of the subreaders has been reopened and which are shared. That\'s why multiReader1.close() should not close reader1 in this case and we need refcounting in order to make this work. \\n\\n So do you suggest that a MultiReader should increment the refcounts when it is opened as well (in the constructor)? I believe we can implement it like this, but as I said it changes the semantics of MultiReader.close() (and ParallelReader.close() is, I believe, the same). A user would then have to close subreaders manually. \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12536418\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12536418&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12536418\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12536418_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536418_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Oct\\/07 10:45\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-20T10:45:29+0000\'\u003e20\\/Oct\\/07 10:45\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eIf you do:\u003c\\/p\u003e\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003eIndexReader reader1 = IndexReader.open(index1);  \\nIndexReader multiReader1 = \u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e MultiReader(\u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e IndexReader[] {reader1, IndexReader.open(index2)});\\nmultiReader1.close();\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\\n\u003cp\u003ethen today multiReader1.close() also closes reader1. That\'s why I consciously omitted reader1.close().\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eAhh, I missed that MultiReader is allowed to close all readers that\u003cbr\\/\u003e\\nwere passed into it, when it is closed.  OK, let\'s leave\u003cbr\\/\u003e\\nreader1.close() out of the example.\u003c\\/p\u003e\\n\\n\u003cp\u003eIt\'s somewhat \\\"aggressive\\\" of MultiReader\\/ParallelReader to do that?\u003cbr\\/\u003e\\nIf you go and use those same sub-readers in other MultiReaders then\u003cbr\\/\u003e\\nthey closing of the first MultiReader will then break the other ones?\u003c\\/p\u003e\\n\\n\u003cp\u003eI think we are forced to keep this semantics, for backwards\u003cbr\\/\u003e\\ncompatibility.  But I don\'t really think MultiReader\\/ParallelReader\u003cbr\\/\u003e\\nshould actually be this aggressive.  Maybe in the future we can add\u003cbr\\/\u003e\\nctors for MultiReader\\/ParallelReader that accept a \\\"doClose\\\" boolean\u003cbr\\/\u003e\\nto turn this off.\u003c\\/p\u003e\\n\\n\u003cp\u003eAnyway, it\'s simple to preserve this semantics with reference\u003cbr\\/\u003e\\ncounting.  It just means that IndexReader \\/ MultiReader do not incref\u003cbr\\/\u003e\\nthe readers they receive, and, when they are done with those readers,\u003cbr\\/\u003e\\nthey must call their close(), not decref.  Ie they \\\"borrow the\u003cbr\\/\u003e\\nreference\\\" that was passed in, rather than incref\'ing their own\u003cbr\\/\u003e\\nreference, to the child readers.\u003c\\/p\u003e\\n\\n\u003cp\u003eWith that change, plus the change below, your example works fine.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eConsequently, if you do\u003c\\/p\u003e\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003eIndexReader reader1 = IndexReader.open(index1);  \\nIndexReader multiReader1 = \u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e MultiReader(\u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e IndexReader[] {reader1, IndexReader.open(index2)});\\nIndexReader multiReader2 = \u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e MultiReader(\u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e IndexReader[] {reader1, IndexReader.open(index3)});\\nmultiReader1.close();\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\u003cp\u003ethen multiReader2 is not usable anymore, because multiReader1.close() closes reader1. But that can be explicitly avoided by the user because it\'s known that multiReader1 and multiReader2 share the same reader.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThis is why I don\'t like the semantics we have today &#8211; I don\'t think\u003cbr\\/\u003e\\nit\'s right that the multiReader1.close() breaks multiReader2.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eNow, with the reopen() code:\u003c\\/p\u003e\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003eIndexReader reader1 = IndexReader.open(index1);  \u003cspan class=\\\"code-comment\\\"\u003e\\/\\/ optimized index, reader1 is a SegmentReader\\n\u003c\\/span\u003eIndexReader multiReader1 = \u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e MultiReader(\u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e IndexReader[] {reader1, IndexReader.open(index2)});\\n... \u003cspan class=\\\"code-comment\\\"\u003e\\/\\/ modify index2\\n\u003c\\/span\u003eIndexReader multiReader2 = multiReader1.reopen();  \\n\u003cspan class=\\\"code-comment\\\"\u003e\\/\\/ only index2 changed, so multiReader2 uses reader1 and has to increment the refcount of reader1\u003c\\/span\u003e\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\u003cp\u003eThe user gets a new reader instance from multiReader.reopen(), but can\'t tell which of the subreaders has been reopened and which are shared. That\'s why multiReader1.close() should not close reader1 in this case and we need refcounting in order to make this work.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eBoth of these cases are easy to fix with reference counting: we just\u003cbr\\/\u003e\\nhave to change ensureOpen() to assert that RC &gt; 0 instead of\u003cbr\\/\u003e\\nclosed==false.  Ie, a reader may still be used as long as its RC is\u003cbr\\/\u003e\\nstill non-zero.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12536418_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536418_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Oct\\/07 10:45\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-20T10:45:29+0000\'\u003e20\\/Oct\\/07 10:45\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n If you do: \\n  \\n IndexReader reader1 = IndexReader.open(index1);  \\nIndexReader multiReader1 =  new  MultiReader( new  IndexReader[] {reader1, IndexReader.open(index2)});\\nmultiReader1.close();\\n \\n  \\n\\n then today multiReader1.close() also closes reader1. That\'s why I consciously omitted reader1.close().  \\n\\n Ahh, I missed that MultiReader is allowed to close all readers that \\nwere passed into it, when it is closed.  OK, let\'s leave \\nreader1.close() out of the example. \\n\\n It\'s somewhat \\\"aggressive\\\" of MultiReader\\/ParallelReader to do that? \\nIf you go and use those same sub-readers in other MultiReaders then \\nthey closing of the first MultiReader will then break the other ones? \\n\\n I think we are forced to keep this semantics, for backwards \\ncompatibility.  But I don\'t really think MultiReader\\/ParallelReader \\nshould actually be this aggressive.  Maybe in the future we can add \\nctors for MultiReader\\/ParallelReader that accept a \\\"doClose\\\" boolean \\nto turn this off. \\n\\n Anyway, it\'s simple to preserve this semantics with reference \\ncounting.  It just means that IndexReader \\/ MultiReader do not incref \\nthe readers they receive, and, when they are done with those readers, \\nthey must call their close(), not decref.  Ie they \\\"borrow the \\nreference\\\" that was passed in, rather than incref\'ing their own \\nreference, to the child readers. \\n\\n With that change, plus the change below, your example works fine. \\n\\n \\n Consequently, if you do \\n  \\n IndexReader reader1 = IndexReader.open(index1);  \\nIndexReader multiReader1 =  new  MultiReader( new  IndexReader[] {reader1, IndexReader.open(index2)});\\nIndexReader multiReader2 =  new  MultiReader( new  IndexReader[] {reader1, IndexReader.open(index3)});\\nmultiReader1.close();\\n \\n  \\n then multiReader2 is not usable anymore, because multiReader1.close() closes reader1. But that can be explicitly avoided by the user because it\'s known that multiReader1 and multiReader2 share the same reader.  \\n\\n This is why I don\'t like the semantics we have today &#8211; I don\'t think \\nit\'s right that the multiReader1.close() breaks multiReader2. \\n\\n \\n Now, with the reopen() code: \\n  \\n IndexReader reader1 = IndexReader.open(index1);   \\/\\/ optimized index, reader1 is a SegmentReader\\n IndexReader multiReader1 =  new  MultiReader( new  IndexReader[] {reader1, IndexReader.open(index2)});\\n...  \\/\\/ modify index2\\n IndexReader multiReader2 = multiReader1.reopen();  \\n \\/\\/ only index2 changed, so multiReader2 uses reader1 and has to increment the refcount of reader1 \\n \\n  \\n The user gets a new reader instance from multiReader.reopen(), but can\'t tell which of the subreaders has been reopened and which are shared. That\'s why multiReader1.close() should not close reader1 in this case and we need refcounting in order to make this work.  \\n\\n Both of these cases are easy to fix with reference counting: we just \\nhave to change ensureOpen() to assert that RC &gt; 0 instead of \\nclosed==false.  Ie, a reader may still be used as long as its RC is \\nstill non-zero.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12536419\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12536419&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12536419\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12536419_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536419_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Oct\\/07 11:05\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-20T11:05:46+0000\'\u003e20\\/Oct\\/07 11:05\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eI think we are forced to keep this semantics, for backwards\u003cbr\\/\u003e\\ncompatibility.  But I don\'t really think MultiReader\\/ParallelReader\u003cbr\\/\u003e\\nshould actually be this aggressive.  Maybe in the future we can add\u003cbr\\/\u003e\\nctors for MultiReader\\/ParallelReader that accept a \\\"doClose\\\" boolean\u003cbr\\/\u003e\\nto turn this off.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eActually I retract this: it\'s no longer necessary as long as we change\u003cbr\\/\u003e\\nensureOpen to assert that RC &gt; 0 instead of closed==false.\u003c\\/p\u003e\\n\\n\u003cp\u003eI think this is actually a nice unexpected side-effect of using\u003cbr\\/\u003e\\nreference counting: it resolves this overly aggressive behavior of\u003cbr\\/\u003e\\nMultiReader\\/ParallelReader.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12536419_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536419_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Oct\\/07 11:05\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-20T11:05:46+0000\'\u003e20\\/Oct\\/07 11:05\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n I think we are forced to keep this semantics, for backwards \\ncompatibility.  But I don\'t really think MultiReader\\/ParallelReader \\nshould actually be this aggressive.  Maybe in the future we can add \\nctors for MultiReader\\/ParallelReader that accept a \\\"doClose\\\" boolean \\nto turn this off.  \\n\\n Actually I retract this: it\'s no longer necessary as long as we change \\nensureOpen to assert that RC &gt; 0 instead of closed==false. \\n\\n I think this is actually a nice unexpected side-effect of using \\nreference counting: it resolves this overly aggressive behavior of \\nMultiReader\\/ParallelReader.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12536805\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12536805&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12536805\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12536805_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536805_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Oct\\/07 19:36\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-22T19:36:00+0000\'\u003e22\\/Oct\\/07 19:36\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eWith that change, plus the change below, your example works fine.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eTwo things:\u003c\\/p\u003e\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eMultiReader\\/ParallelReader must not incref the subreaders on open()\u003cbr\\/\u003e\\nas you said. But on reopen() it must incref the subreaders that \u003cbr\\/\u003e\\nhaven\'t changed and thus are shared with the old MultiReader\\/\u003cbr\\/\u003e\\nParallelReader. This further means, that the re-opened MultiReader\\/\u003cbr\\/\u003e\\nParallelReader must remember which of the subreaders to decref on\u003cbr\\/\u003e\\nclose(), right?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eIf we change ensureOpen() like you suggest, then the user might\u003cbr\\/\u003e\\nstill be able to use reader1 (in my example), even after \u003cbr\\/\u003e\\nreader1.close() was explicitly called. Probably not a big deal?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12536805_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536805_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Oct\\/07 19:36\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-22T19:36:00+0000\'\u003e22\\/Oct\\/07 19:36\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n With that change, plus the change below, your example works fine.  \\n\\n Two things: \\n \\n\\t MultiReader\\/ParallelReader must not incref the subreaders on open() \\nas you said. But on reopen() it must incref the subreaders that  \\nhaven\'t changed and thus are shared with the old MultiReader\\/ \\nParallelReader. This further means, that the re-opened MultiReader\\/ \\nParallelReader must remember which of the subreaders to decref on \\nclose(), right? \\n \\n\\n\\n \\n\\t If we change ensureOpen() like you suggest, then the user might \\nstill be able to use reader1 (in my example), even after  \\nreader1.close() was explicitly called. Probably not a big deal? \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12536827\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12536827&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12536827\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12536827_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536827_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Oct\\/07 20:36\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-22T20:36:03+0000\'\u003e22\\/Oct\\/07 20:36\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cul\u003e\\n\\t\u003cli\u003eMultiReader\\/ParallelReader must not incref the subreaders on open()\u003cbr\\/\u003e\\n      as you said. But on reopen() it must incref the subreaders that\u003cbr\\/\u003e\\n      haven\'t changed and thus are shared with the old MultiReader\\/\u003cbr\\/\u003e\\n      ParallelReader. This further means, that the re-opened MultiReader\\/\u003cbr\\/\u003e\\n      ParallelReader must remember which of the subreaders to decref on\u003cbr\\/\u003e\\n      close(), right?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eHmm, right.  MultiReader\\/ParallelReader must keep track of whether it\u003cbr\\/\u003e\\nshould call decref() or close() on each of its child readers, when it\u003cbr\\/\u003e\\nitself is closed.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cul\u003e\\n\\t\u003cli\u003eIf we change ensureOpen() like you suggest, then the user might\u003cbr\\/\u003e\\n      still be able to use reader1 (in my example), even after\u003cbr\\/\u003e\\n      reader1.close() was explicitly called. Probably not a big deal?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI think this is OK?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12536827_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536827_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Oct\\/07 20:36\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-22T20:36:03+0000\'\u003e22\\/Oct\\/07 20:36\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n \\n\\t MultiReader\\/ParallelReader must not incref the subreaders on open() \\n      as you said. But on reopen() it must incref the subreaders that \\n      haven\'t changed and thus are shared with the old MultiReader\\/ \\n      ParallelReader. This further means, that the re-opened MultiReader\\/ \\n      ParallelReader must remember which of the subreaders to decref on \\n      close(), right? \\n \\n \\n\\n Hmm, right.  MultiReader\\/ParallelReader must keep track of whether it \\nshould call decref() or close() on each of its child readers, when it \\nitself is closed. \\n\\n \\n \\n\\t If we change ensureOpen() like you suggest, then the user might \\n      still be able to use reader1 (in my example), even after \\n      reader1.close() was explicitly called. Probably not a big deal? \\n \\n \\n\\n I think this is OK?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12536845\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12536845&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12536845\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12536845_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536845_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Oct\\/07 21:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-22T21:35:46+0000\'\u003e22\\/Oct\\/07 21:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eI think this is OK?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThis was essentially the reason why I suggested to use two refcount values:\u003cbr\\/\u003e\\none to control when to close a reader, and one to control when to close\u003cbr\\/\u003e\\nit\'s (shared) resources in case of SegmentReader. That approach would not\u003cbr\\/\u003e\\nalter the behaviour of IndexReader.close(). \u003cbr\\/\u003e\\nBut I agree that your approach is simpler and I also think it is okay to \u003cbr\\/\u003e\\nchange ensureOpen() and accept the slight API change.\u003c\\/p\u003e\\n\\n\u003cp\u003eSo I\'ll go ahead and implement the refcount approach unless anybody objects.\u003c\\/p\u003e\\n\\n\u003cp\u003eOh and Mike, thanks for bearing with me \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12536845_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536845_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Oct\\/07 21:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-22T21:35:46+0000\'\u003e22\\/Oct\\/07 21:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n I think this is OK?  \\n\\n This was essentially the reason why I suggested to use two refcount values: \\none to control when to close a reader, and one to control when to close \\nit\'s (shared) resources in case of SegmentReader. That approach would not \\nalter the behaviour of IndexReader.close().  \\nBut I agree that your approach is simpler and I also think it is okay to  \\nchange ensureOpen() and accept the slight API change. \\n\\n So I\'ll go ahead and implement the refcount approach unless anybody objects. \\n\\n Oh and Mike, thanks for bearing with me                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12536848\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12536848&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12536848\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12536848_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536848_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Oct\\/07 21:54\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-22T21:54:41+0000\'\u003e22\\/Oct\\/07 21:54\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eWhat about a new constructor for MultiReader\\/ParallelReader that implements more sensible semantics (increment refcount on readers passed to it, and decrement on close())?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12536848_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536848_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Oct\\/07 21:54\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-22T21:54:41+0000\'\u003e22\\/Oct\\/07 21:54\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    What about a new constructor for MultiReader\\/ParallelReader that implements more sensible semantics (increment refcount on readers passed to it, and decrement on close())?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12536862\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12536862&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12536862\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12536862_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536862_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Oct\\/07 23:06\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-22T23:06:51+0000\'\u003e22\\/Oct\\/07 23:06\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eWhat about a new constructor for MultiReader\\/ParallelReader that implements more sensible semantics (increment refcount on readers passed to it, and decrement on close())?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYeah, when reference counting is implemented then such a constructor should be easy to add.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12536862_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536862_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Oct\\/07 23:06\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-22T23:06:51+0000\'\u003e22\\/Oct\\/07 23:06\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n What about a new constructor for MultiReader\\/ParallelReader that implements more sensible semantics (increment refcount on readers passed to it, and decrement on close())?  \\n\\n Yeah, when reference counting is implemented then such a constructor should be easy to add.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12536866\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12536866&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12536866\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12536866_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536866_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Oct\\/07 23:31\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-22T23:31:02+0000\'\u003e22\\/Oct\\/07 23:31\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eOh and Mike, thanks for bearing with me \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThank you for bearing with me!\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eWhat about a new constructor for MultiReader\\/ParallelReader that implements more sensible semantics (increment refcount on readers passed to it, and decrement on close())?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003e+1\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12536866_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12536866_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'22\\/Oct\\/07 23:31\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-22T23:31:02+0000\'\u003e22\\/Oct\\/07 23:31\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n Oh and Mike, thanks for bearing with me    \\n\\n Thank you for bearing with me! \\n\\n \\n What about a new constructor for MultiReader\\/ParallelReader that implements more sensible semantics (increment refcount on readers passed to it, and decrement on close())?  \\n\\n +1              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12538590\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12538590&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12538590\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12538590_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12538590_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Oct\\/07 20:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-29T20:53:24+0000\'\u003e29\\/Oct\\/07 20:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eOk here is the next one \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e...\u003c\\/p\u003e\\n\\n\u003cp\u003eThis patch implements the refCounting as discussed with Mike and Yonik\u003cbr\\/\u003e\\nabove.\u003c\\/p\u003e\\n\\n\u003cp\u003eOther changes\\/improvements\\/comments:\u003c\\/p\u003e\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eensureOpen() is now also called in MultiReader.reopen() and\u003cbr\\/\u003e\\nParallelReader.reopen(). (thanks, Mike)\u003c\\/li\u003e\\n\\t\u003cli\u003ein case an exception occurs during reopen() it is taken care of\u003cbr\\/\u003e\\nclosing or decreasing the refCount of already created readers.\u003cbr\\/\u003e\\nAlso old readers should not be affected in case an exception occurs.\u003c\\/li\u003e\\n\\t\u003cli\u003eI improved how norms are re-opened in a MultiSegmentReader (MSR).\u003cbr\\/\u003e\\nIt now checks which parts of the normsCache haven\'t changed and \u003cbr\\/\u003e\\ncopies those to the new normsCache. Because I\'m imagining Yonik with \u003cbr\\/\u003e\\nhis thread-safety hat on now \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/wink.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e, another comment about this: In case \u003cbr\\/\u003e\\na MSR is refreshed, then the synchronized MSR.reopen() method has the \u003cbr\\/\u003e\\nlock on the old MSR. This method creates the new MSR and the values\u003cbr\\/\u003e\\nfrom the old cache are copied to the new cache in the constructor, so\u003cbr\\/\u003e\\nwhile the lock on the old MSR is still being held.\u003c\\/li\u003e\\n\\t\u003cli\u003eadded new constructors to MultiReader and ParallelReader that\u003cbr\\/\u003e\\nincrease the refCount on the subReaders and thus prevent closing the\u003cbr\\/\u003e\\nsubReaders on close(). (thanks, Yonik)\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eI also made the changes suggested by Hoss (thanks!):\u003c\\/p\u003e\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003echanged the \\\"successfully reopened\\\" comments int the javadocs\u003c\\/li\u003e\\n\\t\u003cli\u003eadded comments to the javadocs saying that write operations on the\u003cbr\\/\u003e\\nre-opened reader will result in undefined behavior unless the old \u003cbr\\/\u003e\\nreader is closed\u003c\\/li\u003e\\n\\t\u003cli\u003eFilterIndexReader.reopen() not implemented, i. e. will throw an\u003cbr\\/\u003e\\nUnsupportedOperationException.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eAll unit tests pass.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12538590_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12538590_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Oct\\/07 20:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-29T20:53:24+0000\'\u003e29\\/Oct\\/07 20:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Ok here is the next one  ... \\n\\n This patch implements the refCounting as discussed with Mike and Yonik \\nabove. \\n\\n Other changes\\/improvements\\/comments: \\n \\n\\t ensureOpen() is now also called in MultiReader.reopen() and \\nParallelReader.reopen(). (thanks, Mike) \\n\\t in case an exception occurs during reopen() it is taken care of \\nclosing or decreasing the refCount of already created readers. \\nAlso old readers should not be affected in case an exception occurs. \\n\\t I improved how norms are re-opened in a MultiSegmentReader (MSR). \\nIt now checks which parts of the normsCache haven\'t changed and  \\ncopies those to the new normsCache. Because I\'m imagining Yonik with  \\nhis thread-safety hat on now  , another comment about this: In case  \\na MSR is refreshed, then the synchronized MSR.reopen() method has the  \\nlock on the old MSR. This method creates the new MSR and the values \\nfrom the old cache are copied to the new cache in the constructor, so \\nwhile the lock on the old MSR is still being held. \\n\\t added new constructors to MultiReader and ParallelReader that \\nincrease the refCount on the subReaders and thus prevent closing the \\nsubReaders on close(). (thanks, Yonik) \\n \\n\\n\\n I also made the changes suggested by Hoss (thanks!): \\n \\n\\t changed the \\\"successfully reopened\\\" comments int the javadocs \\n\\t added comments to the javadocs saying that write operations on the \\nre-opened reader will result in undefined behavior unless the old  \\nreader is closed \\n\\t FilterIndexReader.reopen() not implemented, i. e. will throw an \\nUnsupportedOperationException. \\n \\n\\n\\n All unit tests pass.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12538705\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12538705&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12538705\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12538705_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12538705_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Oct\\/07 08:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-30T08:55:11+0000\'\u003e30\\/Oct\\/07 08:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003ePatch looks great!  I\'m still working through it but found a few small\u003cbr\\/\u003e\\nissues...\u003c\\/p\u003e\\n\\n\u003cp\u003eIt might be good to put a \\\"assert refCount &gt; 0\\\" at various places like\u003cbr\\/\u003e\\ndecRef(), incRef(), ensureOpen()?  That would require changing the\u003cbr\\/\u003e\\nconstructors to init refCount=1 rather than incRef() it to 1.\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'m seeing a failure in contrib\\/memory testcase:\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003e    [junit] *********** FILE=.\\/NOTICE.txt\\n    [junit] Fatal error at query=Apache, file=.\\/NOTICE.txt, anal=org.apache.lucene.analysis.SimpleAnalyzer@341960\\n    [junit] ------------- ---------------- ---------------\\n    [junit] Testcase: testMany(org.apache.lucene.index.memory.MemoryIndexTest):\\tCaused an ERROR\\n    [junit] \u003cspan class=\\\"code-keyword\\\"\u003ethis\u003c\\/span\u003e IndexReader is closed\\n    [junit] org.apache.lucene.store.AlreadyClosedException: \u003cspan class=\\\"code-keyword\\\"\u003ethis\u003c\\/span\u003e IndexReader is closed\\n    [junit] \\tat org.apache.lucene.index.IndexReader.ensureOpen(IndexReader.java:158)\\n    [junit] \\tat org.apache.lucene.index.IndexReader.termDocs(IndexReader.java:632)\\n    [junit] \\tat org.apache.lucene.search.TermQuery$TermWeight.scorer(TermQuery.java:64)\\n    [junit] \\tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:143)\\n    [junit] \\tat org.apache.lucene.search.Searcher.search(Searcher.java:118)\\n    [junit] \\tat org.apache.lucene.search.Searcher.search(Searcher.java:97)\\n    [junit] \\tat org.apache.lucene.index.memory.MemoryIndexTest.query(MemoryIndexTest.java:412)\\n    [junit] \\tat org.apache.lucene.index.memory.MemoryIndexTest.run(MemoryIndexTest.java:313)\\n    [junit] \\tat org.apache.lucene.index.memory.MemoryIndexTest.testMany(MemoryIndexTest.java:234)\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\\n\u003cp\u003eI think it\'s because MemoryIndexReader (private class in\u003cbr\\/\u003e\\nMemoryIndex.java) calls super(null) =\u003cbr\\/\u003e\\nIndexReader.IndexReader(Directory) in its constructor, which does not\u003cbr\\/\u003e\\ninitialize the refCount to 1?  If I insert incRef() into\u003cbr\\/\u003e\\nIndexReader.IndexReader(Directory) constructor, the test passes, but\u003cbr\\/\u003e\\nwho else is using that constructor (ie will this double-incref in\u003cbr\\/\u003e\\nthose cases?).\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12538705_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12538705_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Oct\\/07 08:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-30T08:55:11+0000\'\u003e30\\/Oct\\/07 08:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Patch looks great!  I\'m still working through it but found a few small \\nissues... \\n\\n It might be good to put a \\\"assert refCount &gt; 0\\\" at various places like \\ndecRef(), incRef(), ensureOpen()?  That would require changing the \\nconstructors to init refCount=1 rather than incRef() it to 1. \\n\\n I\'m seeing a failure in contrib\\/memory testcase: \\n\\n  \\n     [junit] *********** FILE=.\\/NOTICE.txt\\n    [junit] Fatal error at query=Apache, file=.\\/NOTICE.txt, anal=org.apache.lucene.analysis.SimpleAnalyzer@341960\\n    [junit] ------------- ---------------- ---------------\\n    [junit] Testcase: testMany(org.apache.lucene.index.memory.MemoryIndexTest):\\tCaused an ERROR\\n    [junit]  this  IndexReader is closed\\n    [junit] org.apache.lucene.store.AlreadyClosedException:  this  IndexReader is closed\\n    [junit] \\tat org.apache.lucene.index.IndexReader.ensureOpen(IndexReader.java:158)\\n    [junit] \\tat org.apache.lucene.index.IndexReader.termDocs(IndexReader.java:632)\\n    [junit] \\tat org.apache.lucene.search.TermQuery$TermWeight.scorer(TermQuery.java:64)\\n    [junit] \\tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:143)\\n    [junit] \\tat org.apache.lucene.search.Searcher.search(Searcher.java:118)\\n    [junit] \\tat org.apache.lucene.search.Searcher.search(Searcher.java:97)\\n    [junit] \\tat org.apache.lucene.index.memory.MemoryIndexTest.query(MemoryIndexTest.java:412)\\n    [junit] \\tat org.apache.lucene.index.memory.MemoryIndexTest.run(MemoryIndexTest.java:313)\\n    [junit] \\tat org.apache.lucene.index.memory.MemoryIndexTest.testMany(MemoryIndexTest.java:234)\\n \\n  \\n\\n I think it\'s because MemoryIndexReader (private class in \\nMemoryIndex.java) calls super(null) = \\nIndexReader.IndexReader(Directory) in its constructor, which does not \\ninitialize the refCount to 1?  If I insert incRef() into \\nIndexReader.IndexReader(Directory) constructor, the test passes, but \\nwho else is using that constructor (ie will this double-incref in \\nthose cases?).              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12538743\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12538743&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12538743\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12538743_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12538743_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Oct\\/07 11:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-30T11:41:25+0000\'\u003e30\\/Oct\\/07 11:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eOK I think this patch is very close!  I finished reviewing it &#8211;\u003cbr\\/\u003e\\nhere\'s some more feedback:\u003c\\/p\u003e\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eIn multiple places you catch an IOException and undo the attempted\u003cbr\\/\u003e\\n    re-open, but shouldn\'t this be a try\\/finally instead so you also\u003cbr\\/\u003e\\n    clean up on hitting any unchecked exceptions?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eI think you need an explicit refCount for the Norm class in\u003cbr\\/\u003e\\n    SegmentReader.\u003cbr\\/\u003e\\n    .\u003cbr\\/\u003e\\n    Say I\'ve done a chain of 10 re-opens for SegmentReader and each\u003cbr\\/\u003e\\n    time only the segment\'s norms has changed.  I\'ve closed all but\u003cbr\\/\u003e\\n    the last SegmentReader.  At this point all 10 SegmentReaders are\u003cbr\\/\u003e\\n    still alive (RC &gt; 0) and holding open all file handles for their\u003cbr\\/\u003e\\n    copies of the norms.  So this will leak file handles\\/RAM with each\u003cbr\\/\u003e\\n    reopen?\u003cbr\\/\u003e\\n   .\u003cbr\\/\u003e\\n    To fix this, I think you just need to add refCount into Norm class\u003cbr\\/\u003e\\n    &amp; set refCount to 1 in the constructor.  Then, each each\u003cbr\\/\u003e\\n    SegmentReader calls Norm.decRef(), not Norm.close(), when it\'s\u003cbr\\/\u003e\\n    done.  When refCount hits 0 then the Norm closes itself.  Finally,\u003cbr\\/\u003e\\n    during re-open you should share a Norm instance (rather than open\u003cbr\\/\u003e\\n    a new one) if it had not changed from the previous SegmentReader.\u003cbr\\/\u003e\\n  .\u003cbr\\/\u003e\\n    For singleNormStream, I think each reopened SegmentReader should\u003cbr\\/\u003e\\n    always re-open this descriptor and then we can forcefully close\u003cbr\\/\u003e\\n    this stream when the SegmentReader is closed (what you are doing\u003cbr\\/\u003e\\n    now).  Ie the SegmentReader fully owns singleNormStream.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eIf you have a long series of reopens, then, all SegmentReaders in\u003cbr\\/\u003e\\n    the chain will remain alive.  So this is a \u003cspan class=\\\"error\\\"\u003e&#91;small&#93;\u003c\\/span\u003e memory leak\u003cbr\\/\u003e\\n    with time.  I think if you changed referencedSegmentReader to\u003cbr\\/\u003e\\n    always be the \u003cb\u003estarting\u003c\\/b\u003e SegmentReader then this chain is broken\u003cbr\\/\u003e\\n    and after 10 reopens only the original SegmentReader and the most\u003cbr\\/\u003e\\n    recent one will remain alive (assuming I closed all SegmentReaders\u003cbr\\/\u003e\\n    but the most recent one).\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12538743_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12538743_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Oct\\/07 11:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-30T11:41:25+0000\'\u003e30\\/Oct\\/07 11:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    OK I think this patch is very close!  I finished reviewing it &#8211; \\nhere\'s some more feedback: \\n\\n \\n\\t In multiple places you catch an IOException and undo the attempted \\n    re-open, but shouldn\'t this be a try\\/finally instead so you also \\n    clean up on hitting any unchecked exceptions? \\n \\n\\n\\n \\n\\t I think you need an explicit refCount for the Norm class in \\n    SegmentReader. \\n    . \\n    Say I\'ve done a chain of 10 re-opens for SegmentReader and each \\n    time only the segment\'s norms has changed.  I\'ve closed all but \\n    the last SegmentReader.  At this point all 10 SegmentReaders are \\n    still alive (RC &gt; 0) and holding open all file handles for their \\n    copies of the norms.  So this will leak file handles\\/RAM with each \\n    reopen? \\n   . \\n    To fix this, I think you just need to add refCount into Norm class \\n    &amp; set refCount to 1 in the constructor.  Then, each each \\n    SegmentReader calls Norm.decRef(), not Norm.close(), when it\'s \\n    done.  When refCount hits 0 then the Norm closes itself.  Finally, \\n    during re-open you should share a Norm instance (rather than open \\n    a new one) if it had not changed from the previous SegmentReader. \\n  . \\n    For singleNormStream, I think each reopened SegmentReader should \\n    always re-open this descriptor and then we can forcefully close \\n    this stream when the SegmentReader is closed (what you are doing \\n    now).  Ie the SegmentReader fully owns singleNormStream. \\n \\n\\n\\n \\n\\t If you have a long series of reopens, then, all SegmentReaders in \\n    the chain will remain alive.  So this is a  &#91;small&#93;  memory leak \\n    with time.  I think if you changed referencedSegmentReader to \\n    always be the  starting  SegmentReader then this chain is broken \\n    and after 10 reopens only the original SegmentReader and the most \\n    recent one will remain alive (assuming I closed all SegmentReaders \\n    but the most recent one). \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12539016\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12539016&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12539016\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"buschmic\\\" id=\\\"commentauthor_12539016_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=buschmic\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"buschmic\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539016_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'31\\/Oct\\/07 07:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-31T07:02:46+0000\'\u003e31\\/Oct\\/07 07:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003ePatch looks great!  I\'m still working through it but found a few small\u003cbr\\/\u003e\\nissues...\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\u003cp\u003eThanks Mike! Very good review and feedback!\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eIt might be good to put a \\\"assert refCount &gt; 0\\\" at various places like...\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\u003cp\u003eAgreed. I added those asserts to incRef() and decRef(). I didn\'t add it\u003cbr\\/\u003e\\nto ensureOpen(), because it throws an AlreadyClosedException anyway, and\u003cbr\\/\u003e\\nsome testcases check if this exception is thrown.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eI\'m seeing a failure in contrib\\/memory testcase:\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\u003cp\u003eOups, I fixed this already. I changed the (deprecated) ctr \u003cbr\\/\u003e\\nIndexReader.IndexReader(Directory) to call this() which sets the refCount \u003cbr\\/\u003e\\nto 1. The test passes then. I made this fix yesterday, I think I just \u003cbr\\/\u003e\\nforgot to update the patch file before I submitted it, sorry about this.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eIn multiple places you catch an IOException and undo the attempted\u003cbr\\/\u003e\\n    re-open, but shouldn\'t this be a try\\/finally instead so you also\u003cbr\\/\u003e\\n    clean up on hitting any unchecked exceptions?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\u003c\\/blockquote\u003e\\n\u003cp\u003eYes of course! Changed it.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eI think you need an explicit refCount for the Norm class in\u003cbr\\/\u003e\\n    SegmentReader.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\u003c\\/blockquote\u003e\\n\u003cp\u003eOK I see. I made this change as well. I also made the change that\u003cbr\\/\u003e\\nthere is no chain, but one starting SegmentReader which all re-opened \u003cbr\\/\u003e\\nones reference (see below). Now this starting SegmentReader won\'t close \u003cbr\\/\u003e\\nits norms until all other readers that reference it are closed (RC=0),\u003cbr\\/\u003e\\nbecause only then doClose() is called, which calls closeNorms().\u003cbr\\/\u003e\\nDo you see an easy way how to improve this?\u003cbr\\/\u003e\\nHmm, probably I have to definalize IndexReader.incRef() and decRef()\u003cbr\\/\u003e\\nand overwrite them in SegmentReader. Then SegmentReader.incRef() would\u003cbr\\/\u003e\\nalso incRef the norms, SegmentReader.decref() would decref the norms,\u003cbr\\/\u003e\\nand somehow a clone that shares references the reader but not the norms\u003cbr\\/\u003e\\n(because they changed) would only incref the reader itself, but not\u003cbr\\/\u003e\\nthe norms... Or do you see an easier way?\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eIf you have a long series of reopens, then, all SegmentReaders in\u003cbr\\/\u003e\\n    the chain will remain alive.  So this is a \u003cspan class=\\\"error\\\"\u003e&#91;small&#93;\u003c\\/span\u003e memory leak\u003cbr\\/\u003e\\n    with time.  I think if you changed referencedSegmentReader to\u003cbr\\/\u003e\\n    always be the \u003cb\u003estarting\u003c\\/b\u003e SegmentReader then this chain is broken\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\u003c\\/blockquote\u003e\\n\u003cp\u003eGood point. Ok I changed this and also the test cases that check the refCount\u003cbr\\/\u003e\\nvalues.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"buschmic\\\" id=\\\"commentauthor_12539016_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=buschmic\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"buschmic\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539016_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'31\\/Oct\\/07 07:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-31T07:02:46+0000\'\u003e31\\/Oct\\/07 07:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n Patch looks great!  I\'m still working through it but found a few small \\nissues...  \\n Thanks Mike! Very good review and feedback! \\n\\n \\n It might be good to put a \\\"assert refCount &gt; 0\\\" at various places like...  \\n Agreed. I added those asserts to incRef() and decRef(). I didn\'t add it \\nto ensureOpen(), because it throws an AlreadyClosedException anyway, and \\nsome testcases check if this exception is thrown. \\n\\n \\n I\'m seeing a failure in contrib\\/memory testcase:  \\n Oups, I fixed this already. I changed the (deprecated) ctr  \\nIndexReader.IndexReader(Directory) to call this() which sets the refCount  \\nto 1. The test passes then. I made this fix yesterday, I think I just  \\nforgot to update the patch file before I submitted it, sorry about this. \\n\\n \\n \\n\\t In multiple places you catch an IOException and undo the attempted \\n    re-open, but shouldn\'t this be a try\\/finally instead so you also \\n    clean up on hitting any unchecked exceptions? \\n \\n \\n Yes of course! Changed it. \\n\\n \\n \\n\\t I think you need an explicit refCount for the Norm class in \\n    SegmentReader. \\n \\n \\n OK I see. I made this change as well. I also made the change that \\nthere is no chain, but one starting SegmentReader which all re-opened  \\nones reference (see below). Now this starting SegmentReader won\'t close  \\nits norms until all other readers that reference it are closed (RC=0), \\nbecause only then doClose() is called, which calls closeNorms(). \\nDo you see an easy way how to improve this? \\nHmm, probably I have to definalize IndexReader.incRef() and decRef() \\nand overwrite them in SegmentReader. Then SegmentReader.incRef() would \\nalso incRef the norms, SegmentReader.decref() would decref the norms, \\nand somehow a clone that shares references the reader but not the norms \\n(because they changed) would only incref the reader itself, but not \\nthe norms... Or do you see an easier way? \\n\\n \\n \\n\\t If you have a long series of reopens, then, all SegmentReaders in \\n    the chain will remain alive.  So this is a  &#91;small&#93;  memory leak \\n    with time.  I think if you changed referencedSegmentReader to \\n    always be the  starting  SegmentReader then this chain is broken \\n \\n \\n Good point. Ok I changed this and also the test cases that check the refCount \\nvalues.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12539139\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12539139&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12539139\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12539139_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539139_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'31\\/Oct\\/07 18:04\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-31T18:04:28+0000\'\u003e31\\/Oct\\/07 18:04\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eLooks great!  All tests pass for me.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eOK I see. I made this change as well. I also made the change that\u003cbr\\/\u003e\\nthere is no chain, but one starting SegmentReader which all re-opened\u003cbr\\/\u003e\\nones reference (see below). Now this starting SegmentReader won\'t close\u003cbr\\/\u003e\\nits norms until all other readers that reference it are closed (RC=0),\u003cbr\\/\u003e\\nbecause only then doClose() is called, which calls closeNorms().\u003cbr\\/\u003e\\nDo you see an easy way how to improve this?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eHow about if SegmentReader.close() always calls Norm.decRef(),\u003cbr\\/\u003e\\nimmediately, for each Norm is has open?  EG you could implement\u003cbr\\/\u003e\\ndoCloseUnsharedResources in SegmentReader and do it there).  This way,\u003cbr\\/\u003e\\nif the SegmentReader has been closed but it shares resources (and not\u003cbr\\/\u003e\\nthe Norms) with reopened SegmentReaders then its Norms would all\u003cbr\\/\u003e\\ndecRef to 0 &amp; be closed.\u003c\\/p\u003e\\n\\n\u003cp\u003eAlso make sure that if a SegmentReader is decRef\'d to 0 and close was\u003cbr\\/\u003e\\nnever called, that also in this case you remember to call Norm.decRef\u003cbr\\/\u003e\\nfor all open norms.\u003c\\/p\u003e\\n\\n\u003cp\u003eOne more comment: I think you can partially share Norm instances?  Eg\u003cbr\\/\u003e\\nif I have 2 fields that have norms, but only one of them changed since\u003cbr\\/\u003e\\nI opened this SegmentReader, then the reopened SegmentReader could\u003cbr\\/\u003e\\nshare the Norm instance of the field that didn\'t change with the old\u003cbr\\/\u003e\\nSegmentReader?  But right now you\'re re-loading all the Norms.\u003c\\/p\u003e\\n\\n\u003cp\u003eOtherwise no more comments!\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12539139_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539139_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'31\\/Oct\\/07 18:04\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-31T18:04:28+0000\'\u003e31\\/Oct\\/07 18:04\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Looks great!  All tests pass for me. \\n\\n \\n OK I see. I made this change as well. I also made the change that \\nthere is no chain, but one starting SegmentReader which all re-opened \\nones reference (see below). Now this starting SegmentReader won\'t close \\nits norms until all other readers that reference it are closed (RC=0), \\nbecause only then doClose() is called, which calls closeNorms(). \\nDo you see an easy way how to improve this?  \\n\\n How about if SegmentReader.close() always calls Norm.decRef(), \\nimmediately, for each Norm is has open?  EG you could implement \\ndoCloseUnsharedResources in SegmentReader and do it there).  This way, \\nif the SegmentReader has been closed but it shares resources (and not \\nthe Norms) with reopened SegmentReaders then its Norms would all \\ndecRef to 0 &amp; be closed. \\n\\n Also make sure that if a SegmentReader is decRef\'d to 0 and close was \\nnever called, that also in this case you remember to call Norm.decRef \\nfor all open norms. \\n\\n One more comment: I think you can partially share Norm instances?  Eg \\nif I have 2 fields that have norms, but only one of them changed since \\nI opened this SegmentReader, then the reopened SegmentReader could \\nshare the Norm instance of the field that didn\'t change with the old \\nSegmentReader?  But right now you\'re re-loading all the Norms. \\n\\n Otherwise no more comments!              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12539208\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12539208&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12539208\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"buschmic\\\" id=\\\"commentauthor_12539208_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=buschmic\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"buschmic\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539208_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'31\\/Oct\\/07 22:56\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-31T22:56:20+0000\'\u003e31\\/Oct\\/07 22:56\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eHow about if SegmentReader.close() always calls Norm.decRef(),\u003cbr\\/\u003e\\nimmediately, for each Norm is has open?  EG you could implement\u003cbr\\/\u003e\\ndoCloseUnsharedResources in SegmentReader and do it there).  This way,\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eHmm I was thinking about this before (that\'s actually why I put that\u003cbr\\/\u003e\\nmethod in there). But I don\'t think this is gonna work. For example,\u003cbr\\/\u003e\\nlet\'s say we use a MultiReader that has two SegmentReader SR1 and SR2.\u003cbr\\/\u003e\\nNow only SR2 changed, we reopen the MR which increases the refCount on\u003cbr\\/\u003e\\nSR1, because it shares that SR. Now we close the old MultiReader, which\u003cbr\\/\u003e\\ncalls close() on SR1. If now SegmentReader.close() calls Norm.decRef(), \u003cbr\\/\u003e\\nthen it will close the norms even though they are still used by the new\u003cbr\\/\u003e\\nMultiReader.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"buschmic\\\" id=\\\"commentauthor_12539208_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=buschmic\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"buschmic\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539208_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'31\\/Oct\\/07 22:56\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-31T22:56:20+0000\'\u003e31\\/Oct\\/07 22:56\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n How about if SegmentReader.close() always calls Norm.decRef(), \\nimmediately, for each Norm is has open?  EG you could implement \\ndoCloseUnsharedResources in SegmentReader and do it there).  This way,  \\n\\n Hmm I was thinking about this before (that\'s actually why I put that \\nmethod in there). But I don\'t think this is gonna work. For example, \\nlet\'s say we use a MultiReader that has two SegmentReader SR1 and SR2. \\nNow only SR2 changed, we reopen the MR which increases the refCount on \\nSR1, because it shares that SR. Now we close the old MultiReader, which \\ncalls close() on SR1. If now SegmentReader.close() calls Norm.decRef(),  \\nthen it will close the norms even though they are still used by the new \\nMultiReader.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12539209\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12539209&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12539209\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"buschmic\\\" id=\\\"commentauthor_12539209_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=buschmic\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"buschmic\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539209_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'31\\/Oct\\/07 22:56\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-31T22:56:54+0000\'\u003e31\\/Oct\\/07 22:56\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eOne more comment: I think you can partially share Norm instances? Eg\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\u003cp\u003eGood idea! Will make the change.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"buschmic\\\" id=\\\"commentauthor_12539209_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=buschmic\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"buschmic\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539209_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'31\\/Oct\\/07 22:56\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-10-31T22:56:54+0000\'\u003e31\\/Oct\\/07 22:56\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n One more comment: I think you can partially share Norm instances? Eg  \\n Good idea! Will make the change.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12539359\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12539359&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12539359\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12539359_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539359_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Nov\\/07 13:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-01T13:12:16+0000\'\u003e01\\/Nov\\/07 13:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eHmm I was thinking about this before (that\'s actually why I put that\u003cbr\\/\u003e\\nmethod in there). But I don\'t think this is gonna work. For example,\u003cbr\\/\u003e\\nlet\'s say we use a MultiReader that has two SegmentReader SR1 and SR2.\u003cbr\\/\u003e\\nNow only SR2 changed, we reopen the MR which increases the refCount on\u003cbr\\/\u003e\\nSR1, because it shares that SR. Now we close the old MultiReader, which\u003cbr\\/\u003e\\ncalls close() on SR1. If now SegmentReader.close() calls Norm.decRef(), \u003cbr\\/\u003e\\nthen it will close the norms even though they are still used by the new\u003cbr\\/\u003e\\nMultiReader.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eUgh, you\'re right.  The challenge is sometimes a reference to SR means\u003cbr\\/\u003e\\n\\\"I will use norms\\\" (this is when MultiReader incRefs) but other times\u003cbr\\/\u003e\\nit means \\\"I will not use norms\\\" (this is when SR incRefs due to\u003cbr\\/\u003e\\nreopen).\u003c\\/p\u003e\\n\\n\u003cp\u003eOK, I like your original proposal: SR overrides incRef() and incrs its\u003cbr\\/\u003e\\nRC as well as the RC for each Norm it\'s using.  Then, in SR\'s\u003cbr\\/\u003e\\nreopenSegment, you carefully incRef the \\\"original\\\" SR without\u003cbr\\/\u003e\\nincRef\'ing its Norms (except for those Norms you will keep).\u003c\\/p\u003e\\n\\n\u003cp\u003eLikewise, SR overrides decRef() to decr its RC and RC for each Norm.\u003cbr\\/\u003e\\nBut, when a reopened SR1.doClose() is called, you must carefully\u003cbr\\/\u003e\\ndecRef the RD of the original SR but not decRef each of its Norms\u003cbr\\/\u003e\\n(except for those you had actually shared).\u003c\\/p\u003e\\n\\n\u003cp\u003eThis way when MR calls SR.incRef\\/decRef then all Norms and the SR\'s RC\u003cbr\\/\u003e\\nare incr\'d\\/decr\'d.  But when SR1 shares resources with an original SR\u003cbr\\/\u003e\\nit only incr\'s\\/decr\'s the refCount of the SR.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12539359_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539359_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Nov\\/07 13:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-01T13:12:16+0000\'\u003e01\\/Nov\\/07 13:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n Hmm I was thinking about this before (that\'s actually why I put that \\nmethod in there). But I don\'t think this is gonna work. For example, \\nlet\'s say we use a MultiReader that has two SegmentReader SR1 and SR2. \\nNow only SR2 changed, we reopen the MR which increases the refCount on \\nSR1, because it shares that SR. Now we close the old MultiReader, which \\ncalls close() on SR1. If now SegmentReader.close() calls Norm.decRef(),  \\nthen it will close the norms even though they are still used by the new \\nMultiReader.  \\n\\n Ugh, you\'re right.  The challenge is sometimes a reference to SR means \\n\\\"I will use norms\\\" (this is when MultiReader incRefs) but other times \\nit means \\\"I will not use norms\\\" (this is when SR incRefs due to \\nreopen). \\n\\n OK, I like your original proposal: SR overrides incRef() and incrs its \\nRC as well as the RC for each Norm it\'s using.  Then, in SR\'s \\nreopenSegment, you carefully incRef the \\\"original\\\" SR without \\nincRef\'ing its Norms (except for those Norms you will keep). \\n\\n Likewise, SR overrides decRef() to decr its RC and RC for each Norm. \\nBut, when a reopened SR1.doClose() is called, you must carefully \\ndecRef the RD of the original SR but not decRef each of its Norms \\n(except for those you had actually shared). \\n\\n This way when MR calls SR.incRef\\/decRef then all Norms and the SR\'s RC \\nare incr\'d\\/decr\'d.  But when SR1 shares resources with an original SR \\nit only incr\'s\\/decr\'s the refCount of the SR.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12539554\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12539554&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12539554\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12539554_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539554_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Nov\\/07 09:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-02T09:53:07+0000\'\u003e02\\/Nov\\/07 09:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eOK, I think it\'s finally working now! \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eSegmentReader now overwrites incRef() and increments the readers RC,\u003cbr\\/\u003e\\nas well as the RCs of all norms. I further added the private method\u003cbr\\/\u003e\\nincRefReaderNotNorms() to SegmentReader, which is called in \u003cbr\\/\u003e\\nreopenSegment(), because it takes care of incrementing the RCs of\u003cbr\\/\u003e\\nall shared norms.\u003c\\/p\u003e\\n\\n\u003cp\u003eI also added the method doCloseUnsharedResources() to IndexReader,\u003cbr\\/\u003e\\nwhich is a NOOP by default. It is called when a reader is closed,\u003cbr\\/\u003e\\neven if its RC &gt; 0. SegmentReader overwrites this method and \u003cbr\\/\u003e\\ncloses (=decRef) the norms in it. The SegmentReader then remembers\u003cbr\\/\u003e\\nthat it closed the norms already and won\'t close them again in\u003cbr\\/\u003e\\ndoClose(), which is called when its RC finally drops to 0.\u003c\\/p\u003e\\n\\n\u003cp\u003eI also made the change you suggested, Mike, to only reload the \u003cbr\\/\u003e\\nfield norms that actually changed. SegmentReader.openNorms() now\u003cbr\\/\u003e\\nchecks if there is already a norm for a field in the HashTable,\u003cbr\\/\u003e\\nand only loads it if it\'s not there. reopenSegment() puts all\u003cbr\\/\u003e\\nnorms in the new SegmentReader that haven\'t changed.\u003c\\/p\u003e\\n\\n\u003cp\u003eI added some new tests to verify the norms ref counting. All unit\u003cbr\\/\u003e\\ntests pass now. So I think this is ready to commit, but I\'d feel \u003cbr\\/\u003e\\nmore comfortable if you could review it again before I commit it.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12539554_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539554_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Nov\\/07 09:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-02T09:53:07+0000\'\u003e02\\/Nov\\/07 09:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    OK, I think it\'s finally working now!   \\n\\n SegmentReader now overwrites incRef() and increments the readers RC, \\nas well as the RCs of all norms. I further added the private method \\nincRefReaderNotNorms() to SegmentReader, which is called in  \\nreopenSegment(), because it takes care of incrementing the RCs of \\nall shared norms. \\n\\n I also added the method doCloseUnsharedResources() to IndexReader, \\nwhich is a NOOP by default. It is called when a reader is closed, \\neven if its RC &gt; 0. SegmentReader overwrites this method and  \\ncloses (=decRef) the norms in it. The SegmentReader then remembers \\nthat it closed the norms already and won\'t close them again in \\ndoClose(), which is called when its RC finally drops to 0. \\n\\n I also made the change you suggested, Mike, to only reload the  \\nfield norms that actually changed. SegmentReader.openNorms() now \\nchecks if there is already a norm for a field in the HashTable, \\nand only loads it if it\'s not there. reopenSegment() puts all \\nnorms in the new SegmentReader that haven\'t changed. \\n\\n I added some new tests to verify the norms ref counting. All unit \\ntests pass now. So I think this is ready to commit, but I\'d feel  \\nmore comfortable if you could review it again before I commit it.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12539588\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12539588&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12539588\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12539588_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539588_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Nov\\/07 14:09\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-02T14:09:40+0000\'\u003e02\\/Nov\\/07 14:09\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI just did a quick partial review of SegmentReader for thread safety only and ran across some potential issues\u003c\\/p\u003e\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eIt looks like fieldsReader is shared between clones(), and that isn\'t thread-safe (synchronization is done at the SegmentReader level, and now there is more than one)\u003c\\/li\u003e\\n\\t\u003cli\u003emaybe the same issue with deletedDocs?  mutual exclusion is no longer enforced.\u003c\\/li\u003e\\n\\t\u003cli\u003eit looks like the norms Hashtable could be shared... looping over the individual norms and calling incRef doesn\'t seem safe for a number of reasons (for example, you might miss some just being added)\u003c\\/li\u003e\\n\\t\u003cli\u003ereading new norms isn\'t safe...\u003cbr\\/\u003e\\n  synchronized norms(String field, byte[] bytes, int offset) uses the \\\"norm\' IndexInput that is shared.  synchronization on a single reader no longer guarantees mutual exclusion.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eThere\'s probably other stuff, but I stopped looking.  Since we are sharing things now, every method that was synchronized is now potentially unsafe.  Synchronizing on the object being shared is probably a much better strategy now.\u003c\\/p\u003e\\n\\n\u003cp\u003eThis is complex enough that in addition to review, I think we need a good multi-threaded test - 100 or 1000 threads over a ram directory, all changing, querying, retrieving docs, reopening, closing, etc.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12539588_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539588_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Nov\\/07 14:09\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-02T14:09:40+0000\'\u003e02\\/Nov\\/07 14:09\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I just did a quick partial review of SegmentReader for thread safety only and ran across some potential issues \\n\\n \\n\\t It looks like fieldsReader is shared between clones(), and that isn\'t thread-safe (synchronization is done at the SegmentReader level, and now there is more than one) \\n\\t maybe the same issue with deletedDocs?  mutual exclusion is no longer enforced. \\n\\t it looks like the norms Hashtable could be shared... looping over the individual norms and calling incRef doesn\'t seem safe for a number of reasons (for example, you might miss some just being added) \\n\\t reading new norms isn\'t safe... \\n  synchronized norms(String field, byte[] bytes, int offset) uses the \\\"norm\' IndexInput that is shared.  synchronization on a single reader no longer guarantees mutual exclusion. \\n \\n\\n\\n There\'s probably other stuff, but I stopped looking.  Since we are sharing things now, every method that was synchronized is now potentially unsafe.  Synchronizing on the object being shared is probably a much better strategy now. \\n\\n This is complex enough that in addition to review, I think we need a good multi-threaded test - 100 or 1000 threads over a ram directory, all changing, querying, retrieving docs, reopening, closing, etc.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12539596\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12539596&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12539596\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12539596_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539596_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Nov\\/07 14:37\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-02T14:37:34+0000\'\u003e02\\/Nov\\/07 14:37\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eIt also looks like Norm.incRef is used in an unsafe manner (unsynchronized, or synchronized on the reader), and also Norm.decRef() is called inside a synchronized(norms) block, but an individual Norm may be shared across multiple Hashtables, right?\u003c\\/p\u003e\\n\\n\u003cp\u003eI don\'t think that norms even needs to be a synchronized Hashtable... it could be changed to a HashMap since it\'s contents never change, right?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12539596_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539596_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Nov\\/07 14:37\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-02T14:37:34+0000\'\u003e02\\/Nov\\/07 14:37\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    It also looks like Norm.incRef is used in an unsafe manner (unsynchronized, or synchronized on the reader), and also Norm.decRef() is called inside a synchronized(norms) block, but an individual Norm may be shared across multiple Hashtables, right? \\n\\n I don\'t think that norms even needs to be a synchronized Hashtable... it could be changed to a HashMap since it\'s contents never change, right?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12539598\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12539598&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12539598\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12539598_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539598_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Nov\\/07 14:43\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-02T14:43:14+0000\'\u003e02\\/Nov\\/07 14:43\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\\n\u003cp\u003eOK, reviewed the latest patch:\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eIn this code:\\n  \u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003e\u003cspan class=\\\"code-comment\\\"\u003e\\/\\/ singleNormFile means multiple norms share \u003cspan class=\\\"code-keyword\\\"\u003ethis\u003c\\/span\u003e file\\n\u003c\\/span\u003e\u003cspan class=\\\"code-keyword\\\"\u003eif\u003c\\/span\u003e (fileName.endsWith(\u003cspan class=\\\"code-quote\\\"\u003e\\\".\\\"\u003c\\/span\u003e + IndexFileNames.NORMS_EXTENSION)) {\\n  clone.singleNormStream = d.openInput(fileName, readBufferSize);            \\n}\\n  \u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\u003cp\u003e  I think the comment should be removed (it doens\'t apply) and also\u003cbr\\/\u003e\\n  won\'t this incorrectly open the singleNormStream more than once if\u003cbr\\/\u003e\\n  more than one field does not have separate norms?  I think you should\u003cbr\\/\u003e\\n  init that to null and then only reopen it, once, if it\'s still null?\u003c\\/p\u003e\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eIn MultiSegmentReader, the logic that copies over unchanged norms\u003cbr\\/\u003e\\n  from the old norms cache can be simplified.  I think you can just\u003cbr\\/\u003e\\n  look up the old Norm instance &amp; the new Norm instance and if they\u003cbr\\/\u003e\\n  are == then you can copy bytes over?  This would also let you remove\u003cbr\\/\u003e\\n  \\\"sharedNorms\\\" entirely which is good because it\'s not a just a\u003cbr\\/\u003e\\n  boolean thing anymore since some Norm instances are shared and some\u003cbr\\/\u003e\\n  aren\'t.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eI think you also need to override decRef (and add\u003cbr\\/\u003e\\n  decRefReaderNotNorms) to SegmentReader?  Because now there is a\u003cbr\\/\u003e\\n  mismatch: incRef incr\'s the Norm RC\'s, but, decRef does not.  So I\u003cbr\\/\u003e\\n  think norms are not getting closed?  I think we should modify the\u003cbr\\/\u003e\\n  \\\"assertReaderClosed()\\\" in the unit test to verify (when appropriate)\u003cbr\\/\u003e\\n  that also the RC of all Norm instances is also 0 (ie\u003cbr\\/\u003e\\n  assertTrue(SR.normsClosed())).  Then, make sure SR calls\u003cbr\\/\u003e\\n  referencedSegmentReader.decRefReaderNotNorms instead of decRef.  I\u003cbr\\/\u003e\\n  think you then don\'t need to track \\\"closedNorms\\\" boolean, at all.\u003cbr\\/\u003e\\n  You simply always decRef the norms whenever SR.decRef is called.\u003cbr\\/\u003e\\n  The doCloseUnsharedResources is still needed to close the\u003cbr\\/\u003e\\n  singleNormStream.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12539598_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539598_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Nov\\/07 14:43\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-02T14:43:14+0000\'\u003e02\\/Nov\\/07 14:43\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                   \\n OK, reviewed the latest patch: \\n\\n \\n\\t In this code:\\n    \\n  \\/\\/ singleNormFile means multiple norms share  this  file\\n  if  (fileName.endsWith( \\\".\\\"  + IndexFileNames.NORMS_EXTENSION)) {\\n  clone.singleNormStream = d.openInput(fileName, readBufferSize);            \\n}\\n   \\n  \\n   I think the comment should be removed (it doens\'t apply) and also \\n  won\'t this incorrectly open the singleNormStream more than once if \\n  more than one field does not have separate norms?  I think you should \\n  init that to null and then only reopen it, once, if it\'s still null?  \\n \\n\\n\\n \\n\\t In MultiSegmentReader, the logic that copies over unchanged norms \\n  from the old norms cache can be simplified.  I think you can just \\n  look up the old Norm instance &amp; the new Norm instance and if they \\n  are == then you can copy bytes over?  This would also let you remove \\n  \\\"sharedNorms\\\" entirely which is good because it\'s not a just a \\n  boolean thing anymore since some Norm instances are shared and some \\n  aren\'t. \\n \\n\\n\\n \\n\\t I think you also need to override decRef (and add \\n  decRefReaderNotNorms) to SegmentReader?  Because now there is a \\n  mismatch: incRef incr\'s the Norm RC\'s, but, decRef does not.  So I \\n  think norms are not getting closed?  I think we should modify the \\n  \\\"assertReaderClosed()\\\" in the unit test to verify (when appropriate) \\n  that also the RC of all Norm instances is also 0 (ie \\n  assertTrue(SR.normsClosed())).  Then, make sure SR calls \\n  referencedSegmentReader.decRefReaderNotNorms instead of decRef.  I \\n  think you then don\'t need to track \\\"closedNorms\\\" boolean, at all. \\n  You simply always decRef the norms whenever SR.decRef is called. \\n  The doCloseUnsharedResources is still needed to close the \\n  singleNormStream. \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12539600\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12539600&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12539600\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12539600_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539600_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Nov\\/07 14:47\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-02T14:47:05+0000\'\u003e02\\/Nov\\/07 14:47\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eThis is complex enough that in addition to review, I think we need a\u003cbr\\/\u003e\\ngood multi-threaded test - 100 or 1000 threads over a ram directory,\u003cbr\\/\u003e\\nall changing, querying, retrieving docs, reopening, closing, etc.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003e+1\u003c\\/p\u003e\\n\\n\u003cp\u003eWe should fix all the synchronization issues you\'ve found, create this\u003cbr\\/\u003e\\nunit test, and then iterate from there.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12539600_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539600_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Nov\\/07 14:47\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-02T14:47:05+0000\'\u003e02\\/Nov\\/07 14:47\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n This is complex enough that in addition to review, I think we need a \\ngood multi-threaded test - 100 or 1000 threads over a ram directory, \\nall changing, querying, retrieving docs, reopening, closing, etc.  \\n\\n +1 \\n\\n We should fix all the synchronization issues you\'ve found, create this \\nunit test, and then iterate from there.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12539606\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12539606&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12539606\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12539606_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539606_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Nov\\/07 14:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-02T14:57:34+0000\'\u003e02\\/Nov\\/07 14:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eWe should fix all the synchronization issues you\'ve found, create this\u003cbr\\/\u003e\\nunit test, and then iterate from there.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eOr reverse it... write the test first so we have confidence that it can at least uncover some of these issues.\u003cbr\\/\u003e\\nThe test should do as little synchronization as possible of it\'s own so it doesn\'t mask a lack of synchronization in the core.\u003cbr\\/\u003e\\nIt should be possible to uncover the unsynchronized concurrent use of IndexInput at least, and hopefully some of the refcounting issues too.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12539606_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539606_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Nov\\/07 14:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-02T14:57:34+0000\'\u003e02\\/Nov\\/07 14:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     We should fix all the synchronization issues you\'ve found, create this \\nunit test, and then iterate from there.  \\n\\n Or reverse it... write the test first so we have confidence that it can at least uncover some of these issues. \\nThe test should do as little synchronization as possible of it\'s own so it doesn\'t mask a lack of synchronization in the core. \\nIt should be possible to uncover the unsynchronized concurrent use of IndexInput at least, and hopefully some of the refcounting issues too.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12539610\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12539610&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12539610\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12539610_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539610_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Nov\\/07 15:08\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-02T15:08:29+0000\'\u003e02\\/Nov\\/07 15:08\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eOr reverse it... write the test first so we have confidence that it can at least uncover some of these issues.\u003cbr\\/\u003e\\nThe test should do as little synchronization as possible of it\'s own so it doesn\'t mask a lack of synchronization in the core.\u003cbr\\/\u003e\\nIt should be possible to uncover the unsynchronized concurrent use of IndexInput at least, and hopefully some of the refcounting issues too.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eExcellent, I agree!\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12539610_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539610_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Nov\\/07 15:08\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-02T15:08:29+0000\'\u003e02\\/Nov\\/07 15:08\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n Or reverse it... write the test first so we have confidence that it can at least uncover some of these issues. \\nThe test should do as little synchronization as possible of it\'s own so it doesn\'t mask a lack of synchronization in the core. \\nIt should be possible to uncover the unsynchronized concurrent use of IndexInput at least, and hopefully some of the refcounting issues too.  \\n\\n Excellent, I agree!              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12539634\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12539634&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12539634\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12539634_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539634_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Nov\\/07 16:32\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-02T16:32:18+0000\'\u003e02\\/Nov\\/07 16:32\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eI just did a quick partial review of SegmentReader for thread safety only and ran across some potential issues\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eOK, let\'s scratch my \\\"ready to commit\\\" comment \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/wink.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eA question about thread-safety here. I agree that we must\u003cbr\\/\u003e\\nfix all possible problems concerning two or more \u003cbr\\/\u003e\\nIndexReaders in \u003cb\u003eread-mode\u003c\\/b\u003e, like the FieldsReader issue.\u003c\\/p\u003e\\n\\n\u003cp\u003eOn the other hand: We\'re saying that performing write\u003cbr\\/\u003e\\noperations on a re-opened reader results in undefined\u003cbr\\/\u003e\\nbehavior. Some of the issues you mentioned, Yonik, should \u003cbr\\/\u003e\\nonly apply in case one of the shared readers is used to\u003cbr\\/\u003e\\nperform index modifications, right? Then the question is: \u003cbr\\/\u003e\\nhow much sense does it make to make reopen() thread-safe \u003cbr\\/\u003e\\nin the write case then?\u003c\\/p\u003e\\n\\n\u003cp\u003eSo I think the multi-threaded testcase should not\u003cbr\\/\u003e\\nperform index modifications using readers involved in a\u003cbr\\/\u003e\\nreopen()?\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12539634_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539634_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Nov\\/07 16:32\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-02T16:32:18+0000\'\u003e02\\/Nov\\/07 16:32\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n I just did a quick partial review of SegmentReader for thread safety only and ran across some potential issues  \\n\\n OK, let\'s scratch my \\\"ready to commit\\\" comment   \\n\\n A question about thread-safety here. I agree that we must \\nfix all possible problems concerning two or more  \\nIndexReaders in  read-mode , like the FieldsReader issue. \\n\\n On the other hand: We\'re saying that performing write \\noperations on a re-opened reader results in undefined \\nbehavior. Some of the issues you mentioned, Yonik, should  \\nonly apply in case one of the shared readers is used to \\nperform index modifications, right? Then the question is:  \\nhow much sense does it make to make reopen() thread-safe  \\nin the write case then? \\n\\n So I think the multi-threaded testcase should not \\nperform index modifications using readers involved in a \\nreopen()? \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12539637\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12539637&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12539637\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12539637_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539637_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Nov\\/07 16:58\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-02T16:58:53+0000\'\u003e02\\/Nov\\/07 16:58\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eSorry, I hadn\'t kept up with this issue wrt what was going to be legal (and we should definitely only test what will be legal in the MT test).   So that removes the deletedDocs issue I guess.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12539637_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12539637_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Nov\\/07 16:58\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-02T16:58:53+0000\'\u003e02\\/Nov\\/07 16:58\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Sorry, I hadn\'t kept up with this issue wrt what was going to be legal (and we should definitely only test what will be legal in the MT test).   So that removes the deletedDocs issue I guess.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12540145\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12540145&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12540145\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"tpeuss\\\" id=\\\"commentauthor_12540145_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=tpeuss\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"tpeuss\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Thomas Peuss\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12540145_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Nov\\/07 07:34\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-05T07:34:11+0000\'\u003e05\\/Nov\\/07 07:34\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eTo find concurrency issues with an unit test is hard to do, because your potential problems lie in the time domain and not in the code domain. \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/wink.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eFrom my experience following things can have impact on the results of such a test:\u003c\\/p\u003e\\n\u003cul\u003e\\n\\t\u003cli\u003eRunning on SP or SMP machines. SMP machines (the more cores the better) reveal concurrency issues much earlier.\u003c\\/li\u003e\\n\\t\u003cli\u003eThe Java implementation you are using. IBM\'s and Sun\'s thread implementations behave slightly different for example.\u003c\\/li\u003e\\n\\t\u003cli\u003eThe OS you are running. This may seem odd in the first run but remember that modern Java implementations rely heavily on the threading implementations of the OS.\u003c\\/li\u003e\\n\\t\u003cli\u003eThe processor platform you are running. NUMA vs. UMA (which is AMD vs. intel). The timing of threads can differ because of this.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eAnd be prepared that one time your tests runs through without a problem and on the next run it breaks...\u003c\\/p\u003e\\n\\n\u003cp\u003eJust my \\u20AC 0.02\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"tpeuss\\\" id=\\\"commentauthor_12540145_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=tpeuss\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"tpeuss\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Thomas Peuss\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12540145_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Nov\\/07 07:34\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-05T07:34:11+0000\'\u003e05\\/Nov\\/07 07:34\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    To find concurrency issues with an unit test is hard to do, because your potential problems lie in the time domain and not in the code domain.   \\n\\n From my experience following things can have impact on the results of such a test: \\n \\n\\t Running on SP or SMP machines. SMP machines (the more cores the better) reveal concurrency issues much earlier. \\n\\t The Java implementation you are using. IBM\'s and Sun\'s thread implementations behave slightly different for example. \\n\\t The OS you are running. This may seem odd in the first run but remember that modern Java implementations rely heavily on the threading implementations of the OS. \\n\\t The processor platform you are running. NUMA vs. UMA (which is AMD vs. intel). The timing of threads can differ because of this. \\n \\n\\n\\n And be prepared that one time your tests runs through without a problem and on the next run it breaks... \\n\\n Just my \\u20AC 0.02              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12541517\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12541517&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12541517\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12541517_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12541517_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Nov\\/07 06:47\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-10T06:47:42+0000\'\u003e10\\/Nov\\/07 06:47\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eChanges in this patch:\u003c\\/p\u003e\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eFixed ParallelReader and MultiReader so that they don\'t incRef the subreaders anymore in case reopen() is a NOOP (i. e. reopen() doesn\'t return a new instance)\u003c\\/li\u003e\\n\\t\u003cli\u003eIn the new ctr in MultiSegmentReader it was possible to hit a NullPointerException during filling the norms cache, because I didn\'t check for null after retrieving the old reader from the HashMap. I fixed this.\u003c\\/li\u003e\\n\\t\u003cli\u003eSegmentReader now also overwrites decRef() and implements decRefReaderNotNorms().\u003c\\/li\u003e\\n\\t\u003cli\u003eAs Mike suggested I removed \\\"boolean sharedNorms\\\" from SegmentReader. Now in MultiSegmentReader I compare the norm instances from the old and the new subReaders and copy the bytes to the new cache in case they are ==.\u003c\\/li\u003e\\n\\t\u003cli\u003eIn SegmentReader I changed norms to be a HashMap instead of HashTable.\u003c\\/li\u003e\\n\\t\u003cli\u003eNorm.decRef() and Norm.incRef() are synchronized now.\u003c\\/li\u003e\\n\\t\u003cli\u003eSegmentReader#norms(String field, byte[] bytes, int offset) now synchronizes on the norm object that is to be read.\u003c\\/li\u003e\\n\\t\u003cli\u003eSegmentReader#reopen() now opens a new FieldsReader because it is not thread-safe.\u003c\\/li\u003e\\n\\t\u003cli\u003eSegmentReader.Norm has a new boolean variable \\\"useSingleNormStream\\\". SegmentReader#norms(String field, byte[] bytes, int offset) checks if it is true. If yes, then the readers\' singleNormStream is used, otherwise norm.in. This is necessary so that a reopened SegmentReader always uses its own singleNormStream and to avoid synchronization on the singleNormStream.\u003c\\/li\u003e\\n\\t\u003cli\u003eI added a bunch of code to TestIndexReaderReopen to test the thread-safety of reopen(). It starts 150 threads: some modify the index (some delete docs, some add docs and some set norms), some reopen readers and check if the re-opened ones deliver the same results as fresh ones.\u003c\\/li\u003e\\n\\t\u003cli\u003eassertReaderClosed now checks if the norms are closed and also checks recursively if all subReaders are closed.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eStill outstanding:\u003c\\/p\u003e\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eOn the IBM JVM all tests pass. On Sun, the thread-safety test \u003cb\u003esometimes\u003c\\/b\u003e fails. When it fails, then in assertReaderClosed, because the refCounts of either the norms or some subReaders aren\'t 0 at the end of the test. At this point I\'m not sure why and I\'m still debugging. I just wanted to submit the patch to give others the chance to review the patch or possibly (hopefully) find the problem before me.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12541517_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12541517_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Nov\\/07 06:47\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-10T06:47:42+0000\'\u003e10\\/Nov\\/07 06:47\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Changes in this patch: \\n\\n \\n\\t Fixed ParallelReader and MultiReader so that they don\'t incRef the subreaders anymore in case reopen() is a NOOP (i. e. reopen() doesn\'t return a new instance) \\n\\t In the new ctr in MultiSegmentReader it was possible to hit a NullPointerException during filling the norms cache, because I didn\'t check for null after retrieving the old reader from the HashMap. I fixed this. \\n\\t SegmentReader now also overwrites decRef() and implements decRefReaderNotNorms(). \\n\\t As Mike suggested I removed \\\"boolean sharedNorms\\\" from SegmentReader. Now in MultiSegmentReader I compare the norm instances from the old and the new subReaders and copy the bytes to the new cache in case they are ==. \\n\\t In SegmentReader I changed norms to be a HashMap instead of HashTable. \\n\\t Norm.decRef() and Norm.incRef() are synchronized now. \\n\\t SegmentReader#norms(String field, byte[] bytes, int offset) now synchronizes on the norm object that is to be read. \\n\\t SegmentReader#reopen() now opens a new FieldsReader because it is not thread-safe. \\n\\t SegmentReader.Norm has a new boolean variable \\\"useSingleNormStream\\\". SegmentReader#norms(String field, byte[] bytes, int offset) checks if it is true. If yes, then the readers\' singleNormStream is used, otherwise norm.in. This is necessary so that a reopened SegmentReader always uses its own singleNormStream and to avoid synchronization on the singleNormStream. \\n\\t I added a bunch of code to TestIndexReaderReopen to test the thread-safety of reopen(). It starts 150 threads: some modify the index (some delete docs, some add docs and some set norms), some reopen readers and check if the re-opened ones deliver the same results as fresh ones. \\n\\t assertReaderClosed now checks if the norms are closed and also checks recursively if all subReaders are closed. \\n \\n\\n\\n Still outstanding: \\n \\n\\t On the IBM JVM all tests pass. On Sun, the thread-safety test  sometimes  fails. When it fails, then in assertReaderClosed, because the refCounts of either the norms or some subReaders aren\'t 0 at the end of the test. At this point I\'m not sure why and I\'m still debugging. I just wanted to submit the patch to give others the chance to review the patch or possibly (hopefully) find the problem before me. \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12541732\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12541732&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12541732\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12541732_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12541732_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Nov\\/07 10:28\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-12T10:28:08+0000\'\u003e12\\/Nov\\/07 10:28\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eChanges:\u003c\\/p\u003e\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eUpdated patch to current trunk (I just realized that the\u003cbr\\/\u003e\\n  latest didn\'t apply cleanly anymore)\u003c\\/li\u003e\\n\\t\u003cli\u003eMultiSegmentReader now decRefs the subReaders correctly\u003cbr\\/\u003e\\n  in case an exception is thrown during reopen()\u003c\\/li\u003e\\n\\t\u003cli\u003eSmall changes in TestIndexReaderReopen.java\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eThe thread-safety test still sometimes fails. The weird\u003cbr\\/\u003e\\nthing is that the test verifies that the re-opened \u003cbr\\/\u003e\\nreaders always return correct results. The only problem\u003cbr\\/\u003e\\nis that the refCount value is not always 0 at the end\u003cbr\\/\u003e\\nof the test. I\'m starting to think that the testcase\u003cbr\\/\u003e\\nitself has a problem? Maybe someone else can take a look\u003c\\/p\u003e\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eit\'s probably something really obvious but I\'m already\u003cbr\\/\u003e\\nstarting to feel dizzy while pondering about \u003cbr\\/\u003e\\nthread-safety.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12541732_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12541732_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Nov\\/07 10:28\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-12T10:28:08+0000\'\u003e12\\/Nov\\/07 10:28\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Changes: \\n\\n \\n\\t Updated patch to current trunk (I just realized that the \\n  latest didn\'t apply cleanly anymore) \\n\\t MultiSegmentReader now decRefs the subReaders correctly \\n  in case an exception is thrown during reopen() \\n\\t Small changes in TestIndexReaderReopen.java \\n \\n\\n\\n The thread-safety test still sometimes fails. The weird \\nthing is that the test verifies that the re-opened  \\nreaders always return correct results. The only problem \\nis that the refCount value is not always 0 at the end \\nof the test. I\'m starting to think that the testcase \\nitself has a problem? Maybe someone else can take a look \\n \\n\\t it\'s probably something really obvious but I\'m already \\nstarting to feel dizzy while pondering about  \\nthread-safety. \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12541955\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12541955&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12541955\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12541955_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12541955_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Nov\\/07 21:34\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-12T21:34:33+0000\'\u003e12\\/Nov\\/07 21:34\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI think the cause of the intermittant failure in the test is a missing\u003cbr\\/\u003e\\ntry\\/finally in doReopen to properly close\\/decRef everything on\u003cbr\\/\u003e\\nexception.\u003c\\/p\u003e\\n\\n\u003cp\u003eBecause of lockless commits, a commit could be in-process while you\u003cbr\\/\u003e\\nare re-opening, in which case you could hit an IOexception and you\u003cbr\\/\u003e\\nmust therefore decRef those norms you had incRef\'d (and, close eg the\u003cbr\\/\u003e\\nnewly opened FieldsReader).\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12541955_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12541955_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Nov\\/07 21:34\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-12T21:34:33+0000\'\u003e12\\/Nov\\/07 21:34\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I think the cause of the intermittant failure in the test is a missing \\ntry\\/finally in doReopen to properly close\\/decRef everything on \\nexception. \\n\\n Because of lockless commits, a commit could be in-process while you \\nare re-opening, in which case you could hit an IOexception and you \\nmust therefore decRef those norms you had incRef\'d (and, close eg the \\nnewly opened FieldsReader).              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12541998\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12541998&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12541998\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12541998_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12541998_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Nov\\/07 00:14\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-13T00:14:45+0000\'\u003e13\\/Nov\\/07 00:14\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e&gt; I think the cause of the intermittant failure in the test is a missing\u003cbr\\/\u003e\\n&gt; try\\/finally in doReopen to properly close\\/decRef everything on\u003cbr\\/\u003e\\n&gt; exception.\u003c\\/p\u003e\\n\\n\u003cp\u003eAwesome! Thanks so much for pointing me there, Mike! I was getting a \u003cbr\\/\u003e\\nlittle suicidal here already ... \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/wink.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eI should have read the comment in SegmentReader#initialize more \u003cbr\\/\u003e\\ncarefully:\u003c\\/p\u003e\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003e    } \u003cspan class=\\\"code-keyword\\\"\u003efinally\u003c\\/span\u003e {\\n\\n      \u003cspan class=\\\"code-comment\\\"\u003e\\/\\/ With lock-less commits, it\'s entirely possible (and\\n\u003c\\/span\u003e      \u003cspan class=\\\"code-comment\\\"\u003e\\/\\/ fine) to hit a FileNotFound exception above.  In\\n\u003c\\/span\u003e      \u003cspan class=\\\"code-comment\\\"\u003e\\/\\/ \u003cspan class=\\\"code-keyword\\\"\u003ethis\u003c\\/span\u003e \u003cspan class=\\\"code-keyword\\\"\u003ecase\u003c\\/span\u003e, we want to explicitly close any subset\\n\u003c\\/span\u003e      \u003cspan class=\\\"code-comment\\\"\u003e\\/\\/ of things that were opened so that we don\'t have to\\n\u003c\\/span\u003e      \u003cspan class=\\\"code-comment\\\"\u003e\\/\\/ wait \u003cspan class=\\\"code-keyword\\\"\u003efor\u003c\\/span\u003e a GC to \u003cspan class=\\\"code-keyword\\\"\u003edo\u003c\\/span\u003e so.\\n\u003c\\/span\u003e      \u003cspan class=\\\"code-keyword\\\"\u003eif\u003c\\/span\u003e (!success) {\\n        doClose();\\n      }\\n    }\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\\n\u003cp\u003eWhile debugging, it\'s easy to miss such an exception, because \u003cbr\\/\u003e\\nSegmentInfos.FindSegmentsFile#run() ignores it. But it\'s good that it\u003cbr\\/\u003e\\nlogs such an exception, I just have to remember to print out the \u003cbr\\/\u003e\\ninfoStream next time.\u003c\\/p\u003e\\n\\n\u003cp\u003eSo it seems that this was indeed the cause for the failing test case.\u003cbr\\/\u003e\\nI made the change and so far the tests didn\'t fail anymore (ran it \u003cbr\\/\u003e\\nabout 10 times so far). I\'ll run it another few times on a different \u003cbr\\/\u003e\\nJVM and submit an updated patch in a short while if it doesn\'t fail \u003cbr\\/\u003e\\nagain.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12541998_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12541998_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Nov\\/07 00:14\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-13T00:14:45+0000\'\u003e13\\/Nov\\/07 00:14\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    &gt; I think the cause of the intermittant failure in the test is a missing \\n&gt; try\\/finally in doReopen to properly close\\/decRef everything on \\n&gt; exception. \\n\\n Awesome! Thanks so much for pointing me there, Mike! I was getting a  \\nlittle suicidal here already ...   \\n\\n I should have read the comment in SegmentReader#initialize more  \\ncarefully: \\n  \\n     }  finally  {\\n\\n       \\/\\/ With lock-less commits, it\'s entirely possible (and\\n        \\/\\/ fine) to hit a FileNotFound exception above.  In\\n        \\/\\/  this   case , we want to explicitly close any subset\\n        \\/\\/ of things that were opened so that we don\'t have to\\n        \\/\\/ wait  for  a GC to  do  so.\\n        if  (!success) {\\n        doClose();\\n      }\\n    }\\n \\n  \\n\\n While debugging, it\'s easy to miss such an exception, because  \\nSegmentInfos.FindSegmentsFile#run() ignores it. But it\'s good that it \\nlogs such an exception, I just have to remember to print out the  \\ninfoStream next time. \\n\\n So it seems that this was indeed the cause for the failing test case. \\nI made the change and so far the tests didn\'t fail anymore (ran it  \\nabout 10 times so far). I\'ll run it another few times on a different  \\nJVM and submit an updated patch in a short while if it doesn\'t fail  \\nagain.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12542019\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12542019&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12542019\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12542019_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542019_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Nov\\/07 01:26\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-13T01:26:32+0000\'\u003e13\\/Nov\\/07 01:26\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eOK, all tests pass now, including the thread-safety test.\u003cbr\\/\u003e\\nI ran it several times on different JVMs.\u003c\\/p\u003e\\n\\n\u003cp\u003eChanges:\u003c\\/p\u003e\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eAs Mike suggested I added a try ... finally block to\u003cbr\\/\u003e\\nSegmentReader#reopenSegment() which cleans up after an\u003cbr\\/\u003e\\nexception was hit.\u003c\\/li\u003e\\n\\t\u003cli\u003eAdded some additional comments.\u003c\\/li\u003e\\n\\t\u003cli\u003eMinor improvements to TestIndexReaderReopen\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12542019_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542019_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Nov\\/07 01:26\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-13T01:26:32+0000\'\u003e13\\/Nov\\/07 01:26\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    OK, all tests pass now, including the thread-safety test. \\nI ran it several times on different JVMs. \\n\\n Changes: \\n \\n\\t As Mike suggested I added a try ... finally block to \\nSegmentReader#reopenSegment() which cleans up after an \\nexception was hit. \\n\\t Added some additional comments. \\n\\t Minor improvements to TestIndexReaderReopen \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12542201\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12542201&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12542201\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12542201_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542201_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Nov\\/07 19:18\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-13T19:18:11+0000\'\u003e13\\/Nov\\/07 19:18\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eAwesome! Thanks so much for pointing me there, Mike! I was getting a\u003cbr\\/\u003e\\nlittle suicidal here already ... \u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eNo problem, I lost some hairs tracking that one down too!!\u003c\\/p\u003e\\n\\n\u003cp\u003eOK, latest patch looks good!  I love the new threaded unit test.\u003c\\/p\u003e\\n\\n\u003cp\u003eOnly two smallish comments:\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eYou should also close fieldsReader when referencedSegmentReader !=\u003cbr\\/\u003e\\n    null, right?  (in SegmentReader.doClose)\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eIn the new try\\/finally in reopenSegment: if you first setup\u003cbr\\/\u003e\\n    referencedSegmentReader, then can\'t that finally clause just be\u003cbr\\/\u003e\\n    clone.decRef() instead of duplicating code for decRef\'ing norms,\u003cbr\\/\u003e\\n    closeNorms(), etc.?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12542201_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542201_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Nov\\/07 19:18\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-13T19:18:11+0000\'\u003e13\\/Nov\\/07 19:18\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n Awesome! Thanks so much for pointing me there, Mike! I was getting a \\nlittle suicidal here already ...   \\n\\n No problem, I lost some hairs tracking that one down too!! \\n\\n OK, latest patch looks good!  I love the new threaded unit test. \\n\\n Only two smallish comments: \\n\\n \\n\\t You should also close fieldsReader when referencedSegmentReader != \\n    null, right?  (in SegmentReader.doClose) \\n \\n\\n\\n \\n\\t In the new try\\/finally in reopenSegment: if you first setup \\n    referencedSegmentReader, then can\'t that finally clause just be \\n    clone.decRef() instead of duplicating code for decRef\'ing norms, \\n    closeNorms(), etc.? \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12542212\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12542212&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12542212\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12542212_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542212_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Nov\\/07 19:54\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-13T19:54:01+0000\'\u003e13\\/Nov\\/07 19:54\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eSo how about a public IndexReader.flush() method so that one could also reopen readers that  were used for changes?\u003c\\/p\u003e\\n\\n\u003cp\u003eUsecase:\u003c\\/p\u003e\\n\\n\u003cp\u003ereader.deleteDocument()\u003cbr\\/\u003e\\nreader.flush()\u003cbr\\/\u003e\\nwriter = new IndexWriter()\u003cbr\\/\u003e\\nwriter.addDocument()\u003cbr\\/\u003e\\nwriter.close()\u003cbr\\/\u003e\\nreader.reopen()\u003cbr\\/\u003e\\nreader.deleteDocument()\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12542212_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542212_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Nov\\/07 19:54\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-13T19:54:01+0000\'\u003e13\\/Nov\\/07 19:54\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    So how about a public IndexReader.flush() method so that one could also reopen readers that  were used for changes? \\n\\n Usecase: \\n\\n reader.deleteDocument() \\nreader.flush() \\nwriter = new IndexWriter() \\nwriter.addDocument() \\nwriter.close() \\nreader.reopen() \\nreader.deleteDocument()              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12542332\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12542332&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12542332\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12542332_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542332_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Nov\\/07 06:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-14T06:02:14+0000\'\u003e14\\/Nov\\/07 06:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cul\u003e\\n\\t\u003cli\u003eYou should also close fieldsReader when referencedSegmentReader !=\u003cbr\\/\u003e\\n    null, right?  (in SegmentReader.doClose)\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYes, will do!\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cul\u003e\\n\\t\u003cli\u003eIn the new try\\/finally in reopenSegment: if you first setup\u003cbr\\/\u003e\\n    referencedSegmentReader, then can\'t that finally clause just be\u003cbr\\/\u003e\\n    clone.decRef() instead of duplicating code for decRef\'ing norms,\u003cbr\\/\u003e\\n    closeNorms(), etc.?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eHmm, what if then in clone.close() an exception is thrown from\u003cbr\\/\u003e\\nFieldsReader.close() or singleNormStream.close(). In that case it \u003cbr\\/\u003e\\nwould not decRef the referenced reader. \u003c\\/p\u003e\\n\\n\u003cp\u003eHmm but actually we could change the order in close() so that \u003cbr\\/\u003e\\nreferencedSegmentReader.decRefReaderNotNorms() is done first even\u003cbr\\/\u003e\\nif the following close() operations don\'t succeed?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12542332_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542332_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Nov\\/07 06:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-14T06:02:14+0000\'\u003e14\\/Nov\\/07 06:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n \\n\\t You should also close fieldsReader when referencedSegmentReader != \\n    null, right?  (in SegmentReader.doClose) \\n \\n \\n\\n Yes, will do! \\n\\n \\n \\n\\t In the new try\\/finally in reopenSegment: if you first setup \\n    referencedSegmentReader, then can\'t that finally clause just be \\n    clone.decRef() instead of duplicating code for decRef\'ing norms, \\n    closeNorms(), etc.? \\n \\n \\n\\n Hmm, what if then in clone.close() an exception is thrown from \\nFieldsReader.close() or singleNormStream.close(). In that case it  \\nwould not decRef the referenced reader.  \\n\\n Hmm but actually we could change the order in close() so that  \\nreferencedSegmentReader.decRefReaderNotNorms() is done first even \\nif the following close() operations don\'t succeed?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12542333\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12542333&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12542333\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12542333_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542333_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Nov\\/07 06:05\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-14T06:05:00+0000\'\u003e14\\/Nov\\/07 06:05\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eSo how about a public IndexReader.flush() method \u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eSince our goal is it to make IndexReader read-only in the future\u003cbr\\/\u003e\\n(\u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-1030\\\" title=\\\"&quot;Read-only&quot; IndexReaders\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-1030\\\"\u003e\u003cdel\u003eLUCENE-1030\u003c\\/del\u003e\u003c\\/a\u003e), do you really think we need to add this?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12542333_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542333_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Nov\\/07 06:05\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-14T06:05:00+0000\'\u003e14\\/Nov\\/07 06:05\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n So how about a public IndexReader.flush() method   \\n\\n Since our goal is it to make IndexReader read-only in the future \\n(  LUCENE-1030  ), do you really think we need to add this?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12542390\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12542390&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12542390\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12542390_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542390_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Nov\\/07 10:10\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-14T10:10:11+0000\'\u003e14\\/Nov\\/07 10:10\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eHmm but actually we could change the order in close() so that\u003cbr\\/\u003e\\nreferencedSegmentReader.decRefReaderNotNorms() is done first even\u003cbr\\/\u003e\\nif the following close() operations don\'t succeed?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003e+1\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12542390_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542390_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Nov\\/07 10:10\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-14T10:10:11+0000\'\u003e14\\/Nov\\/07 10:10\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n Hmm but actually we could change the order in close() so that \\nreferencedSegmentReader.decRefReaderNotNorms() is done first even \\nif the following close() operations don\'t succeed?  \\n\\n +1              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12542411\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12542411&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12542411\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12542411_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542411_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Nov\\/07 10:59\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-14T10:59:55+0000\'\u003e14\\/Nov\\/07 10:59\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eSo how about a public IndexReader.flush() method\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\u003cp\u003eI think also if we do decide to do this we should open a new issue for it?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12542411_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542411_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Nov\\/07 10:59\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-14T10:59:55+0000\'\u003e14\\/Nov\\/07 10:59\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n So how about a public IndexReader.flush() method  \\n I think also if we do decide to do this we should open a new issue for it?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12542462\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12542462&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12542462\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12542462_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542462_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Nov\\/07 13:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-14T13:50:36+0000\'\u003e14\\/Nov\\/07 13:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e&gt; Since our goal is it to make IndexReader read-only in the future\u003cbr\\/\u003e\\n&gt; (\u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-1030\\\" title=\\\"&quot;Read-only&quot; IndexReaders\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-1030\\\"\u003e\u003cdel\u003eLUCENE-1030\u003c\\/del\u003e\u003c\\/a\u003e), do you really think we need to add this?\u003c\\/p\u003e\\n\\n\u003cp\u003eflush() would make reopen() useful in more cases, and \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-1030\\\" title=\\\"&quot;Read-only&quot; IndexReaders\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-1030\\\"\u003e\u003cdel\u003eLUCENE-1030\u003c\\/del\u003e\u003c\\/a\u003e is further off (not Lucene 2.3, right?)\u003cbr\\/\u003e\\nAnyway, flush() would be considered a write operation like setNorm() &amp; deleteDocument() and could be deprecated along with them in the future if that\'s how we decide to go.\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; I think also if we do decide to do this we should open a new issue for it?\u003c\\/p\u003e\\n\\n\u003cp\u003eYes, that\'s fine.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"yseeley@gmail.com\\\" id=\\\"commentauthor_12542462_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=yseeley%40gmail.com\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"yseeley@gmail.com\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Yonik Seeley\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542462_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Nov\\/07 13:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-14T13:50:36+0000\'\u003e14\\/Nov\\/07 13:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    &gt; Since our goal is it to make IndexReader read-only in the future \\n&gt; (  LUCENE-1030  ), do you really think we need to add this? \\n\\n flush() would make reopen() useful in more cases, and   LUCENE-1030   is further off (not Lucene 2.3, right?) \\nAnyway, flush() would be considered a write operation like setNorm() &amp; deleteDocument() and could be deprecated along with them in the future if that\'s how we decide to go. \\n\\n &gt; I think also if we do decide to do this we should open a new issue for it? \\n\\n Yes, that\'s fine.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12542492\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12542492&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12542492\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12542492_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542492_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Nov\\/07 15:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-14T15:57:30+0000\'\u003e14\\/Nov\\/07 15:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eI think also if we do decide to do this we should open a new issue for it?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003e+1\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'ll open a new issue.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12542492_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542492_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Nov\\/07 15:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-14T15:57:30+0000\'\u003e14\\/Nov\\/07 15:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n I think also if we do decide to do this we should open a new issue for it?  \\n\\n +1 \\n\\n I\'ll open a new issue.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12542593\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12542593&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12542593\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12542593_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542593_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Nov\\/07 20:59\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-14T20:59:59+0000\'\u003e14\\/Nov\\/07 20:59\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eChanges:\u003c\\/p\u003e\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eClose FieldsReader in SegmentReader#doClose() even if\u003cbr\\/\u003e\\nreferencedReader!=null\u003c\\/li\u003e\\n\\t\u003cli\u003eCall clone.decRef() in the finally clause of\u003cbr\\/\u003e\\nSegmentReader#reopenSegment()\u003c\\/li\u003e\\n\\t\u003cli\u003edecRef referencedReader before closing other resources\u003cbr\\/\u003e\\nin SegmentReader#doClose()\u003c\\/li\u003e\\n\\t\u003cli\u003eRemoved IndexReader#doCloseUnsharedResources().\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12542593_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542593_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Nov\\/07 20:59\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-14T20:59:59+0000\'\u003e14\\/Nov\\/07 20:59\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Changes: \\n\\n \\n\\t Close FieldsReader in SegmentReader#doClose() even if \\nreferencedReader!=null \\n\\t Call clone.decRef() in the finally clause of \\nSegmentReader#reopenSegment() \\n\\t decRef referencedReader before closing other resources \\nin SegmentReader#doClose() \\n\\t Removed IndexReader#doCloseUnsharedResources(). \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12542786\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12542786&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12542786\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12542786_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542786_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Nov\\/07 14:22\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-15T14:22:53+0000\'\u003e15\\/Nov\\/07 14:22\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003ePatch looks good.  Only thing I found was this leftover\u003cbr\\/\u003e\\nSystem.out.println, in SegmentReader.java:\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003e  \u003cspan class=\\\"code-object\\\"\u003eSystem\u003c\\/span\u003e.out.println(\u003cspan class=\\\"code-quote\\\"\u003e\\\"refCount \\\"\u003c\\/span\u003e + getRefCount());\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_12542786_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542786_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Nov\\/07 14:22\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-15T14:22:53+0000\'\u003e15\\/Nov\\/07 14:22\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Patch looks good.  Only thing I found was this leftover \\nSystem.out.println, in SegmentReader.java: \\n\\n  \\n    System .out.println( \\\"refCount \\\"  + getRefCount());\\n \\n               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12542790\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12542790&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12542790\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12542790_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542790_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Nov\\/07 15:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-15T15:02:15+0000\'\u003e15\\/Nov\\/07 15:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks for the review, Mike! I\'ll remove the println.\u003c\\/p\u003e\\n\\n\u003cp\u003eOk, I think this patch has been reviewed a bunch of times and\u003cbr\\/\u003e\\nshould be ready to commit now. I\'ll wait another day and commit\u003cbr\\/\u003e\\nit then if nobody objects.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12542790_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12542790_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Nov\\/07 15:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-15T15:02:15+0000\'\u003e15\\/Nov\\/07 15:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks for the review, Mike! I\'ll remove the println. \\n\\n Ok, I think this patch has been reviewed a bunch of times and \\nshould be ready to commit now. I\'ll wait another day and commit \\nit then if nobody objects.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12543311\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12543311&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12543311\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12543311_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543311_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Nov\\/07 20:44\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-17T20:44:04+0000\'\u003e17\\/Nov\\/07 20:44\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eChanges:\u003c\\/p\u003e\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eUpdated to current trunk.\u003c\\/li\u003e\\n\\t\u003cli\u003eRemoved println in SegmentReader.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eI\'m going to commit this soon!\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12543311_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543311_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Nov\\/07 20:44\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-17T20:44:04+0000\'\u003e17\\/Nov\\/07 20:44\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Changes: \\n\\n \\n\\t Updated to current trunk. \\n\\t Removed println in SegmentReader. \\n \\n\\n\\n I\'m going to commit this soon!              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12543315\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-743?focusedCommentId=12543315&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12543315\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12543315_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543315_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Nov\\/07 21:38\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-17T21:38:16+0000\'\u003e17\\/Nov\\/07 21:38\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eCommitted! Phew!!! \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"michaelbusch\\\" id=\\\"commentauthor_12543315_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=michaelbusch\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"michaelbusch\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael Busch\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12543315_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Nov\\/07 21:38\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-11-17T21:38:16+0000\'\u003e17\\/Nov\\/07 21:38\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Committed! Phew!!!               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\"";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["scope-filter-data"]="{\"createScopeActions\":[],\"scopes\":[]}";
WRM._unparsedData["sidebar-collapsed-by-default"]="true";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:can-manage"]="false";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:with-icons"]="false";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:shortcuts"]="[]";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:project-id"]="12310110";
WRM._unparsedData["sidebar-id"]="\"\u003cdiv class=\\\"aui-sidebar  projects-sidebar sidebar-pending\\\" \u003e\u003cdiv class=\\\"aui-sidebar-wrapper\\\"\u003e\u003cdiv class=\\\"aui-sidebar-body\\\"\u003e\u003cheader class=\\\"aui-page-header\\\"\u003e\u003cdiv class=\\\"aui-page-header-inner\\\"\u003e\u003cdiv class=\\\"aui-page-header-image\\\"\u003e\u003ca href=\\\"\\/jira\\/projects\\/LUCENE\\/summary\\\" title=\\\"Lucene - Core\\\" class=\\\"jira-project-avatar\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-large aui-avatar-project\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"\\/jira\\/secure\\/projectavatar?pid=12310110&amp;avatarId=10061\\\" alt=\\\"Lucene - Core\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e\u003cimg src=\\\"data:image\\/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI\\/Pg0KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDE4LjEuMSwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPg0KPHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCINCgkgdmlld0JveD0iMCAwIDMwMCAzMDAiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDMwMCAzMDA7IiB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxnIGlkPSJMYXllcl8yIj4NCgk8cGF0aCBzdHlsZT0iZmlsbDojRjc5MjMyOyIgZD0iTTE1MCwwQzY2LjY2NywwLDAsNjYuNjY3LDAsMTUwczY2LjY2NywxNTAsMTUwLDE1MHMxNTAtNjYuNjY3LDE1MC0xNTBTMjMzLjMzMywwLDE1MCwweg0KCQkgTTEzNi42NjcsMTc4LjMzM0wxMjUsMTkwbC00MS42NjctNDBMOTUsMTM4LjMzM2wzMC0zMEwxMzYuNjY3LDEyMGwtMzAsMzBMMTM2LjY2NywxNzguMzMzeiBNMjA1LDE2MS42NjdsLTMwLDMwTDE2My4zMzMsMTgwDQoJCWwzMC0zMGwtMzAtMzBMMTc1LDEwOC4zMzNMMjE2LjY2NywxNTBMMjA1LDE2MS42Njd6Ii8+DQo8L2c+DQo8Zz4NCgk8cG9seWdvbiBzdHlsZT0iZmlsbDojRkZGRkZGOyIgcG9pbnRzPSIxNzUsMTkxLjY2NyAyMDUsMTYxLjY2NyAyMTYuNjY3LDE1MCAxNzUsMTA4LjMzMyAxNjMuMzMzLDEyMCAxOTMuMzMzLDE1MCAxNjMuMzMzLDE4MCAJIi8+DQoJPHBvbHlnb24gc3R5bGU9ImZpbGw6I0ZGRkZGRjsiIHBvaW50cz0iMTI1LDEwOC4zMzMgOTUsMTM4LjMzMyA4My4zMzMsMTUwIDEyNSwxOTAgMTM2LjY2NywxNzguMzMzIDEwNi42NjcsMTUwIDEzNi42NjcsMTIwIAkiLz4NCjwvZz4NCjwvc3ZnPg0K\\\" alt=\\\"Icon indicating the project type\\\" class=\\\"jira-project-avatar-icon\\\" \\/\u003e\u003c\\/a\u003e\u003c\\/div\u003e\u003c!-- .aui-page-header-image --\u003e\u003cdiv class=\\\"aui-page-header-main\\\"\u003e\u003ch1\u003e\u003cdiv class=\\\"aui-group aui-group-split\\\"\u003e\u003cdiv class=\\\"aui-item project-title\\\"\u003e\u003ca href=\\\"\\/jira\\/projects\\/LUCENE\\/summary\\\" title=\\\"Lucene - Core\\\"\u003eLucene - Core\u003c\\/a\u003e\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/h1\u003e\u003c\\/div\u003e\u003c!-- .aui-page-header-main --\u003e\u003c\\/div\u003e\u003c!-- .aui-page-header-inner --\u003e\u003c\\/header\u003e\u003c!-- .aui-page-header --\u003e\u003cnav class=\\\"aui-navgroup aui-navgroup-vertical\\\"\u003e\u003cdiv class=\\\"aui-navgroup-inner sidebar-content-container\\\"\u003e\u003cdiv class=\\\"aui-sidebar-group aui-sidebar-group-tier-one\\\" data-id=\\\"sidebar-navigation-panel\\\"\u003e\u003cul class=\\\"aui-nav\\\"\u003e\u003cli class=\\\"aui-nav-selected\\\" \u003e\u003ca class=\\\"aui-nav-item \\\" href=\\\"\\/jira\\/projects\\/LUCENE\\/issues\\\" data-link-id=\\\"com.atlassian.jira.jira-projects-issue-navigator:sidebar-issue-navigator\\\" \u003e\u003cspan class=\\\"aui-icon aui-icon-large icon-sidebar-issues\\\"\u003e\u003c\\/span\u003e\u003cspan class=\\\"aui-nav-item-label\\\" title=\\\"Issues\\\"\u003eIssues\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/li\u003e\u003cli  \u003e\u003ca class=\\\"aui-nav-item \\\" href=\\\"\\/jira\\/projects\\/LUCENE?selectedItem=com.atlassian.jira.jira-projects-plugin:report-page\\\" data-link-id=\\\"com.atlassian.jira.jira-projects-plugin:report-page\\\" \u003e\u003cspan class=\\\"aui-icon aui-icon-large agile-icon-report\\\"\u003e\u003c\\/span\u003e\u003cspan class=\\\"aui-nav-item-label\\\" title=\\\"Reports\\\"\u003eReports\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/li\u003e\u003cli  \u003e\u003ca class=\\\"aui-nav-item \\\" href=\\\"\\/jira\\/projects\\/LUCENE?selectedItem=com.atlassian.jira.jira-projects-plugin:components-page\\\" data-link-id=\\\"com.atlassian.jira.jira-projects-plugin:components-page\\\" \u003e\u003cspan class=\\\"aui-icon aui-icon-large icon-sidebar-components\\\"\u003e\u003c\\/span\u003e\u003cspan class=\\\"aui-nav-item-label\\\" title=\\\"Components\\\"\u003eComponents\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/li\u003e\u003c\\/ul\u003e\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/nav\u003e\u003c\\/div\u003e\u003cdiv class=\\\"aui-sidebar-footer\\\"\u003e\u003ca class=\\\"aui-button aui-button-subtle aui-sidebar-toggle aui-sidebar-footer-tipsy\\\" data-tooltip=\\\"Expand sidebar ( [ )\\\" href=\\\"#\\\"\u003e\u003cspan class=\\\"aui-icon aui-icon-small\\\"\u003e\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/div\u003e\"";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:bigpipe-init/jira.webresources:bigpipe-init.js" data-wrm-key="jira.webresources:bigpipe-init" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <form id="jira_request_timing_info" class="dont-default-focus"> 
   <fieldset class="parameters hidden"> 
    <input type="hidden" title="jira.request.start.millis" value="1516202011170"> 
    <input type="hidden" title="jira.request.server.time" value="763"> 
    <input type="hidden" title="jira.request.id" value="913x7656299x3"> 
    <input type="hidden" title="jira.session.expiry.time" value="-"> 
    <input type="hidden" title="jira.session.expiry.in.mins" value="-"> 
    <input id="jiraConcurrentRequests" type="hidden" name="jira.request.concurrent.requests" value="4"> 
    <input type="hidden" title="db.reads.time.in.ms" value="45"> 
    <input type="hidden" title="db.conns.time.in.ms" value="55"> 
   </fieldset> 
  </form> 
  <!--
	                 REQUEST ID : 913x7656299x3
	          REQUEST TIMESTAMP : [17/Jan/2018:15:13:31 +0000]
	               REQUEST TIME : 0.7630
	                 ASESSIONID : -
	        CONCURRENT REQUESTS : 4

	                      db.reads : OpSnapshot{name='db.reads', invocationCount=28, elapsedTotal=45905847, elapsedMin=562687, elapsedMax=14614179, resultSetSize=0, cpuTotal=0, cpuMin=0, cpuMax=0}
	                      db.conns : OpSnapshot{name='db.conns', invocationCount=32, elapsedTotal=55799886, elapsedMin=595696, elapsedMax=14696587, resultSetSize=0, cpuTotal=0, cpuMin=0, cpuMax=0}
-->   
 </body>
</html>